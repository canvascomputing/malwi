version: 1
includes: [base]

# Auto-policy for pip install
# Customise: ~/.config/malwi/policies/pip-install.yaml
#
# pip uses subprocess/exec/compile internally — cannot deny those.
# Inherits from base: files, envvars, symbols, network deny/warn.

# Trace networking calls — required for http: URL rules to fire.
python:
  allow:
    - socket.create_connection
    - socket.socket.connect
    - ssl.SSLSocket.connect
    - urllib.request.urlopen
    - "http.client.HTTPConnection.request"
    - "http.client.HTTPSConnection.request"

commands:
  allow:
    - git
  deny:
    # HTTP clients — pip should use its own HTTP client, not shell out to curl
    - curl
    - wget
    # Remote access — no legitimate reason for pip install to open SSH sessions
    - ssh
    # Raw networking — can open arbitrary TCP/UDP connections, reverse shells
    - nc
    - ncat
    # Privilege escalation — pip install should not need root
    - "*sudo*"
    # Shell interpreters — prevent proxy execution attacks (setup.py -> sh -> payload)
    - sh
    - bash
    # Interpreters — prevent proxy execution via other runtimes
    - perl
    - ruby

# PyPI registry only — other domains blocked by default (base denies metadata + .onion)
network:
  allow:
    - "pypi.org/**"
    - "*.pypi.org/**"
    - "files.pythonhosted.org/**"
    - "*.pythonhosted.org/**"
