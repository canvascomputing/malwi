version: 1
includes: [base]

# Auto-policy for bash/sh install scripts (curl ... | bash)
# Customise: ~/.config/malwi/policies/bash-install.yaml
#
# Threat model: malicious install scripts that exfiltrate credentials,
# install persistence, or escalate privileges.
# See SCRIPT_INSTALL.md for the full threat analysis.
#
# Key difference from the default policy: curl/wget are ALLOWED because
# install scripts legitimately download files. Protection is provided by
# file/envvar/network restrictions and blocking dangerous tools.
#
# Inherits from base: envvars, symbols, network deny/warn.
# Extra file protections (shell profiles, persistence dirs, browser data).

# Allow download tools and common install utilities.
# Deny interpreters, persistence, privilege escalation, obfuscation,
# raw networking, clipboard access, DNS exfiltration, and remote access tools.
commands:
  allow:
    # Download tools (install scripts need these)
    - curl
    - wget
    # Package managers
    - apt
    - apt-get
    - yum
    - dnf
    - brew
    - pacman
    - apk
    - zypper
    - dpkg
    - rpm
    - snap
    - flatpak
    - pip
    - pip3
    - npm
    - gem
    # Build tools
    - make
    - cmake
    - gcc
    - g++
    - cc
    - cargo
    - rustup
    - go
    # File and text utilities
    - tar
    - unzip
    - gzip
    - gunzip
    - bzip2
    - xz
    - cp
    - mv
    - rm
    - mkdir
    - install
    - cat
    - tee
    - sed
    - awk
    - grep
    - cut
    - sort
    - head
    - tail
    - wc
    - tr
    - find
    - dirname
    - basename
    - mktemp
    - realpath
    - readlink
    # Checksum and verification
    - sha256sum
    - sha1sum
    - md5sum
    - shasum
    - gpg
    - gpgv
    # System info
    - uname
    - arch
    - id
    - whoami
    - hostname
    - getconf
    - sw_vers
    - lsb_release
    - dpkg-architecture
    # Process control (harmless)
    - "true"
    - "false"
    - test
    - "["
    - sleep
    - env
    - printenv
    - which
    - command
    - type
    # Version managers and tools
    - git
    - nvm
    - rbenv
    - pyenv
    - asdf
    - volta
    - "python -m venv *"
    - "python3 -m venv *"
    # Shell utilities
    - chmod
    - chown
    - chgrp
    - touch
    - date
    - echo
    - printf
    - tput
    - stty
  deny:
    # Interpreters — prevent proxy attacks (S4.2)
    - "python*"
    - perl
    - ruby
    - node
    # Raw networking — prevent unmonitored connections (S5.3)
    - nc
    - ncat
    - netcat
    - socat
    - telnet
    # DNS exfiltration tools (S5.2)
    - dig
    - nslookup
    - host
    # Persistence mechanisms (S3.2, S8.1)
    - crontab
    - at
    - launchctl
    - systemctl
    # Clipboard exfiltration (S5.3)
    - pbcopy
    - pbpaste
    - xclip
    - xsel
    # Remote access
    - ssh
    - scp
    - sftp
    # macOS keychain access (S2.3)
    - security
    # File access bypass via if=/of= args
    - dd
    # Data exfiltration / staging
    - ditto          # bulk file copy (macOS)
    - zip            # bulk archival
    - rsync          # bidirectional file sync, can exfil over SSH
    # Encrypted channels — can establish C2 bypassing network hooks
    - openssl        # openssl s_client -connect evil.com:443
  warn:
    # eval is common but dangerous
    - eval
    # Symlink creation can bypass file path patterns
    - ln
    # Obfuscation tools (S4.1)
    - base64
    - xxd
    - rev
    # Anti-tracing — warn (not deny) because install scripts sometimes kill
    # their own background processes (e.g. waiting spinners, temp servers)
    - kill
    - pkill
    - killall
  review:
    # Privilege escalation (S6.1) — review instead of block because
    # legitimate installers (e.g. Homebrew) need sudo for system-level setup.
    - sudo
    - su
    - doas

# Extra file protections beyond base (shell profiles, persistence, browser, proc).
# Base already provides: credentials (~/.ssh, ~/.aws, *.pem, etc.),
# Linux keyrings, autostart dirs, ld.so.preload.
files:
  deny:
    # Shell profiles (S3.1) — attackers modify for persistence
    - "~/.bashrc"
    - "~/.bash_profile"
    - "~/.zshrc"
    - "~/.zprofile"
    - "~/.profile"
    - "~/.login"
    # Persistence directories (S3.2)
    - "~/Library/LaunchAgents/*"
    - "~/Library/LaunchDaemons/*"
    - "/etc/cron*"
    - "/etc/systemd/**"
    # Git hooks (S3.3) — hidden persistence via hook scripts
    - ".git/hooks/*"
    - "*/.git/hooks/*"
    # System files
    - "/etc/passwd"
    - "/etc/shadow"
    # Browser data (S2.1) — credential databases
    - "*/Google/Chrome/**"
    - "*/Firefox/**"
    - "*/Safari/**"
    # Shared memory (S5.3) — fileless staging
    - "/dev/shm/*"
    # Linux persistence (L8)
    - "/etc/udev/rules.d/**"       # udev rules (persistence via device events)
    - "/etc/init.d/**"             # SysV init scripts
    - "/var/spool/cron/**"         # cron spool directory
    - "/etc/ld.so.conf"            # library search paths (hijack)
    - "/etc/ld.so.conf.d/**"       # library search path fragments
    # Process information (credential dumping)
    - "/proc/*/environ"            # other processes' env vars (secrets)
    - "/proc/*/maps"               # process memory maps (aids dumping)
    - "/proc/*/mem"                # raw process memory (credential extraction)

# Restrict to HTTP/HTTPS protocols only (no raw TCP/UDP/WebSocket).
# Base provides cloud metadata deny + anonymity domain warnings.
network:
  protocols: [https, http]
