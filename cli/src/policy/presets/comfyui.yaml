version: 1
includes: [base]

# Auto-policy for ComfyUI (AI image generation)
# Customise: ~/.config/malwi/policies/comfyui.yaml
#
# Threat model: malicious custom node running arbitrary Python via importlib.
# exec/compile/eval cannot be denied — Python's import system uses them.
# Inherits from base: files, envvars, symbols, network deny/warn.

python:
  deny:
    # Shell command execution
    - os.system
    - os.popen
    # Credential theft
    - getpass.getpass
    - keyring.get_password
    - keyring.set_password
    # Native code escape hatch — blocks loading libc/C libraries
    # to prevent raw socket exfiltration that bypasses network rules
    - ctypes.CDLL
    - ctypes.cdll.LoadLibrary
    - ctypes.WinDLL
    # Exfiltration via allowed HTTP hosts — argument-constrained denies
    - "requests.post": ["*api.github.com*"]
    - "requests.put": ["*api.github.com*"]
    - "requests.post": ["*upload.pypi.org*"]
    - "httpx.post": ["*api.github.com*"]
    - "aiohttp.ClientSession._request": ["*api.github.com*"]
  warn:
    # Subprocess use — not blocked (ComfyUI uses it for GPU detection),
    # but worth noticing if a custom node spawns processes
    - subprocess.run
    - subprocess.call
    - subprocess.check_output
    - subprocess.check_call
    - subprocess.Popen.__init__

# Read-only git + package management. Block write operations and dangerous tools.
commands:
  allow:
    # Custom node repos — read-only operations
    - "git clone *"
    - "git pull *"
    - "git fetch *"
    - "git checkout *"
    - "git submodule *"
    - "git status"
    - "git rev-parse *"
    - "git log *"
    - "git diff *"
    # Custom node dependencies
    - "pip install *"
    - "pip3 install *"
    - "python -m pip *"
    - "python3 -m pip *"
  deny:
    # Git write operations — exfiltration channel
    - "git push *"
    - "git remote add *"
    - "git remote set-url *"
    # Data exfiltration tools
    - curl
    - wget
    # Remote access
    - ssh
    - nc
    - ncat
    # Privilege escalation
    - "*sudo*"
    # Shell spawning — prevent arbitrary command execution
    - sh
    - bash
    - perl
    - ruby

# Restrict outbound HTTP to known model hosting and package registries.
# Base provides cloud metadata deny + anonymity domain warnings.
network:
  allow:
    # Model downloads
    - "huggingface.co/**"
    - "*.huggingface.co/**"
    - "civitai.com/**"
    - "*.civitai.com/**"
    # Custom nodes and raw content (NOT *.github.com — blocks api.github.com)
    - "github.com/**"
    - "*.githubusercontent.com/**"
    # pip packages — download only (not upload.pypi.org)
    - "pypi.org/simple/**"
    - "*.pypi.org/simple/**"
    - "files.pythonhosted.org/**"
    - "*.pythonhosted.org/**"
    # ComfyUI web UI (any port — kept broad for compatibility)
    - "127.0.0.1:*/**"
    - "localhost:*/**"
  protocols: [https, http, wss, ws]
