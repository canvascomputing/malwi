statistics:
  total_files: 1
  skipped_files: 0.0
  processed_objects: 1
  malicious_objects: 0
details:
- path: .repo_cache/malicious_repos/pypi_malregistry/urlib3/1.21.1/urlib3-1.21.1/urlib3-1.21.1/test/contrib/test_socks.py
  contents:
  - name: TestSOCKS4Proxy.test_socks4_with_username
    score: 0.0
    code: |-
      def test_socks4_with_username(self):
              def request_handler(listener):
                  sock = listener.accept()[0]

                  handler = handle_socks4_negotiation(sock, username=b'user')
                  addr, port = next(handler)

                  self.assertEqual(addr, '16.17.18.19')
                  self.assertTrue(port, 80)
                  handler.send(True)

                  while True:
                      buf = sock.recv(65535)
                      if buf.endswith(b'\r\n\r\n'):
                          break

                  sock.sendall(b'HTTP/1.1 200 OK\r\n'
                               b'Server: SocksTestServer\r\n'
                               b'Content-Length: 0\r\n'
                               b'\r\n')
                  sock.close()

              self._start_server(request_handler)
              proxy_url = "socks4://%s:%s" % (self.host, self.port)
              pm = socks.SOCKSProxyManager(proxy_url, username='user')
              self.addCleanup(pm.clear)
              response = pm.request('GET', 'http://16.17.18.19')

              self.assertEqual(response.status, 200)
              self.assertEqual(response.data, b'')
              self.assertEqual(response.headers['Server'], 'SocksTestServer')
    tokens: 'make_cell self resume load_closure self build_tuple load_const OBJECT make_function closure store_fast request_handler load_deref self load_attr _start_server load_fast request_handler call pop_top load_const STRING_FILE_PATH load_deref self load_attr host format_value INTEGER load_const : load_deref self load_attr port format_value INTEGER build_string store_fast proxy_url load_global socks load_attr STRING_LEN_S_ENT_HIGH load_fast proxy_url load_const user kw_names username call store_fast pm load_deref self load_attr addCleanup load_fast pm load_attr clear call pop_top load_fast pm load_attr request load_const GET load_const STRING_URL call store_fast response load_deref self load_attr assertEqual load_fast response load_attr status load_const INTEGER call pop_top load_deref self load_attr assertEqual load_fast response load_attr data load_const call pop_top load_deref self load_attr assertEqual load_fast response load_attr headers load_const Server binary_subscr load_const SocksTestServer call pop_top return_const None'
    hash: 992ca2fa774b0069f38a03016303e8e201bdc0ec3c0d644ee07597d18240a8b8
sources:
  .repo_cache/malicious_repos/pypi_malregistry/urlib3/1.21.1/urlib3-1.21.1/urlib3-1.21.1/test/contrib/test_socks.py: aW1wb3J0IHRocmVhZGluZwppbXBvcnQgc29ja2V0Cgpmcm9tIHVybGxpYjMuY29udHJpYiBpbXBvcnQgc29ja3MKZnJvbSB1cmxsaWIzLmV4Y2VwdGlvbnMgaW1wb3J0IENvbm5lY3RUaW1lb3V0RXJyb3IsIE5ld0Nvbm5lY3Rpb25FcnJvcgoKZnJvbSBkdW1teXNlcnZlci5zZXJ2ZXIgaW1wb3J0IERFRkFVTFRfQ0VSVFMKZnJvbSBkdW1teXNlcnZlci50ZXN0Y2FzZSBpbXBvcnQgSVBWNFNvY2tldER1bW15U2VydmVyVGVzdENhc2UKCmZyb20gbm9zZS5wbHVnaW5zLnNraXAgaW1wb3J0IFNraXBUZXN0Cgp0cnk6CiAgICBpbXBvcnQgc3NsCiAgICBmcm9tIHVybGxpYjMudXRpbCBpbXBvcnQgc3NsXyBhcyBiZXR0ZXJfc3NsCiAgICBIQVNfU1NMID0gVHJ1ZQpleGNlcHQgSW1wb3J0RXJyb3I6CiAgICBzc2wgPSBOb25lCiAgICBiZXR0ZXJfc3NsID0gTm9uZQogICAgSEFTX1NTTCA9IEZhbHNlCgoKU09DS1NfTkVHT1RJQVRJT05fTk9ORSA9IGInXHgwMCcKU09DS1NfTkVHT1RJQVRJT05fUEFTU1dPUkQgPSBiJ1x4MDInCgpTT0NLU19WRVJTSU9OX1NPQ0tTNCA9IGInXHgwNCcKU09DS1NfVkVSU0lPTl9TT0NLUzUgPSBiJ1x4MDUnCgoKZGVmIF9nZXRfZnJlZV9wb3J0KGhvc3QpOgogICAgIiIiCiAgICBHZXRzIGEgZnJlZSBwb3J0IGJ5IG9wZW5pbmcgYSBzb2NrZXQsIGJpbmRpbmcgaXQsIGNoZWNraW5nIHRoZSBhc3NpZ25lZAogICAgcG9ydCwgYW5kIHRoZW4gY2xvc2luZyBpdC4KICAgICIiIgogICAgcyA9IHNvY2tldC5zb2NrZXQoKQogICAgcy5iaW5kKChob3N0LCAwKSkKICAgIHBvcnQgPSBzLmdldHNvY2tuYW1lKClbMV0KICAgIHMuY2xvc2UoKQogICAgcmV0dXJuIHBvcnQKCgpkZWYgX3JlYWRfZXhhY3RseShzb2NrLCBhbXQpOgogICAgIiIiCiAgICBSZWFkICpleGFjdGx5KiBgYGFtdGBgIGJ5dGVzIGZyb20gdGhlIHNvY2tldCBgYHNvY2tgYC4KICAgICIiIgogICAgZGF0YSA9IGInJwoKICAgIHdoaWxlIGFtdCA+IDA6CiAgICAgICAgY2h1bmsgPSBzb2NrLnJlY3YoYW10KQogICAgICAgIGRhdGEgKz0gY2h1bmsKICAgICAgICBhbXQgLT0gbGVuKGNodW5rKQoKICAgIHJldHVybiBkYXRhCgoKZGVmIF9yZWFkX3VudGlsKHNvY2ssIGNoYXIpOgogICAgIiIiCiAgICBSZWFkIGZyb20gdGhlIHNvY2tldCB1bnRpbCB0aGUgY2hhcmFjdGVyIGlzIHJlY2VpdmVkLgogICAgIiIiCiAgICBjaHVua3MgPSBbXQogICAgd2hpbGUgVHJ1ZToKICAgICAgICBjaHVuayA9IHNvY2sucmVjdigxKQogICAgICAgIGNodW5rcy5hcHBlbmQoY2h1bmspCiAgICAgICAgaWYgY2h1bmsgPT0gY2hhcjoKICAgICAgICAgICAgYnJlYWsKCiAgICByZXR1cm4gYicnLmpvaW4oY2h1bmtzKQoKCmRlZiBfYWRkcmVzc19mcm9tX3NvY2tldChzb2NrKToKICAgICIiIgogICAgUmV0dXJucyB0aGUgYWRkcmVzcyBmcm9tIHRoZSBTT0NLUyBzb2NrZXQKICAgICIiIgogICAgYWRkcl90eXBlID0gc29jay5yZWN2KDEpCgogICAgaWYgYWRkcl90eXBlID09IGInXHgwMSc6CiAgICAgICAgaXB2NF9hZGRyID0gX3JlYWRfZXhhY3RseShzb2NrLCA0KQogICAgICAgIHJldHVybiBzb2NrZXQuaW5ldF9udG9hKGlwdjRfYWRkcikKICAgIGVsaWYgYWRkcl90eXBlID09IGInXHgwNCc6CiAgICAgICAgaXB2Nl9hZGRyID0gX3JlYWRfZXhhY3RseShzb2NrLCAxNikKICAgICAgICByZXR1cm4gc29ja2V0LmluZXRfbnRvcChzb2NrZXQuQUZfSU5FVDYsIGlwdjZfYWRkcikKICAgIGVsaWYgYWRkcl90eXBlID09IGInXHgwMyc6CiAgICAgICAgYWRkcl9sZW4gPSBvcmQoc29jay5yZWN2KDEpKQogICAgICAgIHJldHVybiBfcmVhZF9leGFjdGx5KHNvY2ssIGFkZHJfbGVuKQogICAgZWxzZToKICAgICAgICByYWlzZSBSdW50aW1lRXJyb3IoIlVuZXhwZWN0ZWQgYWRkciB0eXBlOiAlciIgJSBhZGRyX3R5cGUpCgoKZGVmIGhhbmRsZV9zb2NrczVfbmVnb3RpYXRpb24oc29jaywgbmVnb3RpYXRlLCB1c2VybmFtZT1Ob25lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXNzd29yZD1Ob25lKToKICAgICIiIgogICAgSGFuZGxlIHRoZSBTT0NLUzUgaGFuZHNoYWtlLgoKICAgIFJldHVybnMgYSBnZW5lcmF0b3Igb2JqZWN0IHRoYXQgYWxsb3dzIHVzIHRvIGJyZWFrIHRoZSBoYW5kc2hha2UgaW50bwogICAgc3RlcHMgc28gdGhhdCB0aGUgdGVzdCBjb2RlIGNhbiBpbnRlcnZlbmUgYXQgY2VydGFpbiB1c2VmdWwgcG9pbnRzLgogICAgIiIiCiAgICByZWNlaXZlZF92ZXJzaW9uID0gc29jay5yZWN2KDEpCiAgICBhc3NlcnQgcmVjZWl2ZWRfdmVyc2lvbiA9PSBTT0NLU19WRVJTSU9OX1NPQ0tTNQogICAgbm1ldGhvZHMgPSBvcmQoc29jay5yZWN2KDEpKQogICAgbWV0aG9kcyA9IF9yZWFkX2V4YWN0bHkoc29jaywgbm1ldGhvZHMpCgogICAgaWYgbmVnb3RpYXRlOgogICAgICAgIGFzc2VydCBTT0NLU19ORUdPVElBVElPTl9QQVNTV09SRCBpbiBtZXRob2RzCiAgICAgICAgc2VuZF9kYXRhID0gU09DS1NfVkVSU0lPTl9TT0NLUzUgKyBTT0NLU19ORUdPVElBVElPTl9QQVNTV09SRAogICAgICAgIHNvY2suc2VuZGFsbChzZW5kX2RhdGEpCgogICAgICAgICMgVGhpcyBpcyB0aGUgcGFzc3dvcmQgbmVnb3RpYXRpb24uCiAgICAgICAgbmVnb3RpYXRpb25fdmVyc2lvbiA9IHNvY2sucmVjdigxKQogICAgICAgIGFzc2VydCBuZWdvdGlhdGlvbl92ZXJzaW9uID09IGInXHgwMScKICAgICAgICB1bGVuID0gb3JkKHNvY2sucmVjdigxKSkKICAgICAgICBwcm92aWRlZF91c2VybmFtZSA9IF9yZWFkX2V4YWN0bHkoc29jaywgdWxlbikKICAgICAgICBwbGVuID0gb3JkKHNvY2sucmVjdigxKSkKICAgICAgICBwcm92aWRlZF9wYXNzd29yZCA9IF9yZWFkX2V4YWN0bHkoc29jaywgcGxlbikKCiAgICAgICAgaWYgdXNlcm5hbWUgPT0gcHJvdmlkZWRfdXNlcm5hbWUgYW5kIHBhc3N3b3JkID09IHByb3ZpZGVkX3Bhc3N3b3JkOgogICAgICAgICAgICBzb2NrLnNlbmRhbGwoYidceDAxXHgwMCcpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgc29jay5zZW5kYWxsKGInXHgwMVx4MDEnKQogICAgICAgICAgICBzb2NrLmNsb3NlKCkKICAgICAgICAgICAgeWllbGQgRmFsc2UKICAgICAgICAgICAgcmV0dXJuCiAgICBlbHNlOgogICAgICAgIGFzc2VydCBTT0NLU19ORUdPVElBVElPTl9OT05FIGluIG1ldGhvZHMKICAgICAgICBzZW5kX2RhdGEgPSBTT0NLU19WRVJTSU9OX1NPQ0tTNSArIFNPQ0tTX05FR09USUFUSU9OX05PTkUKICAgICAgICBzb2NrLnNlbmRhbGwoc2VuZF9kYXRhKQoKICAgICMgQ2xpZW50IHNlbmRzIHdoZXJlIHRoZXkgd2FudCB0byBnby4KICAgIHJlY2VpdmVkX3ZlcnNpb24gPSBzb2NrLnJlY3YoMSkKICAgIGNvbW1hbmQgPSBzb2NrLnJlY3YoMSkKICAgIHJlc2VydmVkID0gc29jay5yZWN2KDEpCiAgICBhZGRyID0gX2FkZHJlc3NfZnJvbV9zb2NrZXQoc29jaykKICAgIHBvcnQgPSBfcmVhZF9leGFjdGx5KHNvY2ssIDIpCiAgICBwb3J0ID0gKG9yZChwb3J0WzA6MV0pIDw8IDgpICsgKG9yZChwb3J0WzE6Ml0pKQoKICAgICMgQ2hlY2sgc29tZSBiYXNpYyBzdHVmZi4KICAgIGFzc2VydCByZWNlaXZlZF92ZXJzaW9uID09IFNPQ0tTX1ZFUlNJT05fU09DS1M1CiAgICBhc3NlcnQgY29tbWFuZCA9PSBiJ1x4MDEnICAjIE9ubHkgc3VwcG9ydCBjb25uZWN0LCBub3QgYmluZC4KICAgIGFzc2VydCByZXNlcnZlZCA9PSBiJ1x4MDAnCgogICAgIyBZaWVsZCB0aGUgYWRkcmVzcyBwb3J0IHR1cGxlLgogICAgc3VjY2VlZCA9IHlpZWxkIGFkZHIsIHBvcnQKCiAgICBpZiBzdWNjZWVkOgogICAgICAgICMgSGFyZC1jb2RlZCByZXNwb25zZSBmb3Igbm93LgogICAgICAgIHJlc3BvbnNlID0gKAogICAgICAgICAgICBTT0NLU19WRVJTSU9OX1NPQ0tTNSArIGInXHgwMFx4MDBceDAxXHg3Zlx4MDBceDAwXHgwMVx4ZWFceDYwJwogICAgICAgICkKICAgIGVsc2U6CiAgICAgICAgIyBIYXJkLWNvZGVkIHJlc3BvbnNlIGZvciBub3cuCiAgICAgICAgcmVzcG9uc2UgPSBTT0NLU19WRVJTSU9OX1NPQ0tTNSArIGInXHgwMVwwMCcKCiAgICBzb2NrLnNlbmRhbGwocmVzcG9uc2UpCiAgICB5aWVsZCBUcnVlICAjIEF2b2lkIFN0b3BJdGVyYXRpb24gZXhjZXB0aW9ucyBnZXR0aW5nIGZpcmVkLgoKCmRlZiBoYW5kbGVfc29ja3M0X25lZ290aWF0aW9uKHNvY2ssIHVzZXJuYW1lPU5vbmUpOgogICAgIiIiCiAgICBIYW5kbGUgdGhlIFNPQ0tTNCBoYW5kc2hha2UuCgogICAgUmV0dXJucyBhIGdlbmVyYXRvciBvYmplY3QgdGhhdCBhbGxvd3MgdXMgdG8gYnJlYWsgdGhlIGhhbmRzaGFrZSBpbnRvCiAgICBzdGVwcyBzbyB0aGF0IHRoZSB0ZXN0IGNvZGUgY2FuIGludGVydmVuZSBhdCBjZXJ0YWluIHVzZWZ1bCBwb2ludHMuCiAgICAiIiIKICAgIHJlY2VpdmVkX3ZlcnNpb24gPSBzb2NrLnJlY3YoMSkKICAgIGNvbW1hbmQgPSBzb2NrLnJlY3YoMSkKICAgIHBvcnQgPSBfcmVhZF9leGFjdGx5KHNvY2ssIDIpCiAgICBwb3J0ID0gKG9yZChwb3J0WzA6MV0pIDw8IDgpICsgKG9yZChwb3J0WzE6Ml0pKQogICAgYWRkciA9IF9yZWFkX2V4YWN0bHkoc29jaywgNCkKICAgIHByb3ZpZGVkX3VzZXJuYW1lID0gX3JlYWRfdW50aWwoc29jaywgYidceDAwJylbOi0xXSAgIyBTdHJpcCB0cmFpbGluZyBudWxsLgoKICAgIGlmIGFkZHIgPT0gYidceDAwXHgwMFx4MDBceDAxJzoKICAgICAgICAjIE1hZ2ljIHN0cmluZzogbWVhbnMgRE5TIG5hbWUuCiAgICAgICAgYWRkciA9IF9yZWFkX3VudGlsKHNvY2ssIGInXHgwMCcpWzotMV0gICMgU3RyaXAgdHJhaWxpbmcgbnVsbC4KICAgIGVsc2U6CiAgICAgICAgYWRkciA9IHNvY2tldC5pbmV0X250b2EoYWRkcikKCiAgICAjIENoZWNrIHNvbWUgYmFzaWMgc3R1ZmYuCiAgICBhc3NlcnQgcmVjZWl2ZWRfdmVyc2lvbiA9PSBTT0NLU19WRVJTSU9OX1NPQ0tTNAogICAgYXNzZXJ0IGNvbW1hbmQgPT0gYidceDAxJyAgIyBPbmx5IHN1cHBvcnQgY29ubmVjdCwgbm90IGJpbmQuCgogICAgaWYgdXNlcm5hbWUgaXMgbm90IE5vbmUgYW5kIHVzZXJuYW1lICE9IHByb3ZpZGVkX3VzZXJuYW1lOgogICAgICAgIHNvY2suc2VuZGFsbChiJ1x4MDBceDVkXHgwMFx4MDBceDAwXHgwMFx4MDBceDAwJykKICAgICAgICBzb2NrLmNsb3NlKCkKICAgICAgICB5aWVsZCBGYWxzZQogICAgICAgIHJldHVybgoKICAgICMgWWllbGQgdGhlIGFkZHJlc3MgcG9ydCB0dXBsZS4KICAgIHN1Y2NlZWQgPSB5aWVsZCBhZGRyLCBwb3J0CgogICAgaWYgc3VjY2VlZDoKICAgICAgICByZXNwb25zZSA9IGInXHgwMFx4NWFceGVhXHg2MFx4N2ZceDAwXHgwMFx4MDEnCiAgICBlbHNlOgogICAgICAgIHJlc3BvbnNlID0gYidceDAwXHg1Ylx4MDBceDAwXHgwMFx4MDBceDAwXHgwMCcKCiAgICBzb2NrLnNlbmRhbGwocmVzcG9uc2UpCiAgICB5aWVsZCBUcnVlICAjIEF2b2lkIFN0b3BJdGVyYXRpb24gZXhjZXB0aW9ucyBnZXR0aW5nIGZpcmVkLgoKCmNsYXNzIFRlc3RTb2NrczVQcm94eShJUFY0U29ja2V0RHVtbXlTZXJ2ZXJUZXN0Q2FzZSk6CiAgICAiIiIKICAgIFRlc3QgdGhlIFNPQ0tTIHByb3h5IGluIFNPQ0tTNSBtb2RlLgogICAgIiIiCiAgICBkZWYgdGVzdF9iYXNpY19yZXF1ZXN0KHNlbGYpOgogICAgICAgIGRlZiByZXF1ZXN0X2hhbmRsZXIobGlzdGVuZXIpOgogICAgICAgICAgICBzb2NrID0gbGlzdGVuZXIuYWNjZXB0KClbMF0KCiAgICAgICAgICAgIGhhbmRsZXIgPSBoYW5kbGVfc29ja3M1X25lZ290aWF0aW9uKHNvY2ssIG5lZ290aWF0ZT1GYWxzZSkKICAgICAgICAgICAgYWRkciwgcG9ydCA9IG5leHQoaGFuZGxlcikKCiAgICAgICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoYWRkciwgJzE2LjE3LjE4LjE5JykKICAgICAgICAgICAgc2VsZi5hc3NlcnRUcnVlKHBvcnQsIDgwKQogICAgICAgICAgICBoYW5kbGVyLnNlbmQoVHJ1ZSkKCiAgICAgICAgICAgIHdoaWxlIFRydWU6CiAgICAgICAgICAgICAgICBidWYgPSBzb2NrLnJlY3YoNjU1MzUpCiAgICAgICAgICAgICAgICBpZiBidWYuZW5kc3dpdGgoYidcclxuXHJcbicpOgogICAgICAgICAgICAgICAgICAgIGJyZWFrCgogICAgICAgICAgICBzb2NrLnNlbmRhbGwoYidIVFRQLzEuMSAyMDAgT0tcclxuJwogICAgICAgICAgICAgICAgICAgICAgICAgYidTZXJ2ZXI6IFNvY2tzVGVzdFNlcnZlclxyXG4nCiAgICAgICAgICAgICAgICAgICAgICAgICBiJ0NvbnRlbnQtTGVuZ3RoOiAwXHJcbicKICAgICAgICAgICAgICAgICAgICAgICAgIGInXHJcbicpCiAgICAgICAgICAgIHNvY2suY2xvc2UoKQoKICAgICAgICBzZWxmLl9zdGFydF9zZXJ2ZXIocmVxdWVzdF9oYW5kbGVyKQogICAgICAgIHByb3h5X3VybCA9ICJzb2NrczU6Ly8lczolcyIgJSAoc2VsZi5ob3N0LCBzZWxmLnBvcnQpCiAgICAgICAgcG0gPSBzb2Nrcy5TT0NLU1Byb3h5TWFuYWdlcihwcm94eV91cmwpCiAgICAgICAgc2VsZi5hZGRDbGVhbnVwKHBtLmNsZWFyKQogICAgICAgIHJlc3BvbnNlID0gcG0ucmVxdWVzdCgnR0VUJywgJ2h0dHA6Ly8xNi4xNy4xOC4xOScpCgogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwocmVzcG9uc2Uuc3RhdHVzLCAyMDApCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChyZXNwb25zZS5kYXRhLCBiJycpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChyZXNwb25zZS5oZWFkZXJzWydTZXJ2ZXInXSwgJ1NvY2tzVGVzdFNlcnZlcicpCgogICAgZGVmIHRlc3RfbG9jYWxfZG5zKHNlbGYpOgogICAgICAgIGRlZiByZXF1ZXN0X2hhbmRsZXIobGlzdGVuZXIpOgogICAgICAgICAgICBzb2NrID0gbGlzdGVuZXIuYWNjZXB0KClbMF0KCiAgICAgICAgICAgIGhhbmRsZXIgPSBoYW5kbGVfc29ja3M1X25lZ290aWF0aW9uKHNvY2ssIG5lZ290aWF0ZT1GYWxzZSkKICAgICAgICAgICAgYWRkciwgcG9ydCA9IG5leHQoaGFuZGxlcikKCiAgICAgICAgICAgIHNlbGYuYXNzZXJ0SW4oYWRkciwgWycxMjcuMC4wLjEnLCAnOjoxJ10pCiAgICAgICAgICAgIHNlbGYuYXNzZXJ0VHJ1ZShwb3J0LCA4MCkKICAgICAgICAgICAgaGFuZGxlci5zZW5kKFRydWUpCgogICAgICAgICAgICB3aGlsZSBUcnVlOgogICAgICAgICAgICAgICAgYnVmID0gc29jay5yZWN2KDY1NTM1KQogICAgICAgICAgICAgICAgaWYgYnVmLmVuZHN3aXRoKGInXHJcblxyXG4nKToKICAgICAgICAgICAgICAgICAgICBicmVhawoKICAgICAgICAgICAgc29jay5zZW5kYWxsKGInSFRUUC8xLjEgMjAwIE9LXHJcbicKICAgICAgICAgICAgICAgICAgICAgICAgIGInU2VydmVyOiBTb2Nrc1Rlc3RTZXJ2ZXJcclxuJwogICAgICAgICAgICAgICAgICAgICAgICAgYidDb250ZW50LUxlbmd0aDogMFxyXG4nCiAgICAgICAgICAgICAgICAgICAgICAgICBiJ1xyXG4nKQogICAgICAgICAgICBzb2NrLmNsb3NlKCkKCiAgICAgICAgc2VsZi5fc3RhcnRfc2VydmVyKHJlcXVlc3RfaGFuZGxlcikKICAgICAgICBwcm94eV91cmwgPSAic29ja3M1Oi8vJXM6JXMiICUgKHNlbGYuaG9zdCwgc2VsZi5wb3J0KQogICAgICAgIHBtID0gc29ja3MuU09DS1NQcm94eU1hbmFnZXIocHJveHlfdXJsKQogICAgICAgIHJlc3BvbnNlID0gcG0ucmVxdWVzdCgnR0VUJywgJ2h0dHA6Ly9sb2NhbGhvc3QnKQoKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKHJlc3BvbnNlLnN0YXR1cywgMjAwKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwocmVzcG9uc2UuZGF0YSwgYicnKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwocmVzcG9uc2UuaGVhZGVyc1snU2VydmVyJ10sICdTb2Nrc1Rlc3RTZXJ2ZXInKQoKICAgIGRlZiB0ZXN0X2NvcnJlY3RfaGVhZGVyX2xpbmUoc2VsZik6CiAgICAgICAgZGVmIHJlcXVlc3RfaGFuZGxlcihsaXN0ZW5lcik6CiAgICAgICAgICAgIHNvY2sgPSBsaXN0ZW5lci5hY2NlcHQoKVswXQoKICAgICAgICAgICAgaGFuZGxlciA9IGhhbmRsZV9zb2NrczVfbmVnb3RpYXRpb24oc29jaywgbmVnb3RpYXRlPUZhbHNlKQogICAgICAgICAgICBhZGRyLCBwb3J0ID0gbmV4dChoYW5kbGVyKQoKICAgICAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChhZGRyLCBiJ2V4YW1wbGUuY29tJykKICAgICAgICAgICAgc2VsZi5hc3NlcnRUcnVlKHBvcnQsIDgwKQogICAgICAgICAgICBoYW5kbGVyLnNlbmQoVHJ1ZSkKCiAgICAgICAgICAgIGJ1ZiA9IGInJwogICAgICAgICAgICB3aGlsZSBUcnVlOgogICAgICAgICAgICAgICAgYnVmICs9IHNvY2sucmVjdig2NTUzNSkKICAgICAgICAgICAgICAgIGlmIGJ1Zi5lbmRzd2l0aChiJ1xyXG5cclxuJyk6CiAgICAgICAgICAgICAgICAgICAgYnJlYWsKCiAgICAgICAgICAgIHNlbGYuYXNzZXJ0VHJ1ZShidWYuc3RhcnRzd2l0aChiJ0dFVCAvIEhUVFAvMS4xJykpCiAgICAgICAgICAgIHNlbGYuYXNzZXJ0VHJ1ZShiJ0hvc3Q6IGV4YW1wbGUuY29tJyBpbiBidWYpCgogICAgICAgICAgICBzb2NrLnNlbmRhbGwoYidIVFRQLzEuMSAyMDAgT0tcclxuJwogICAgICAgICAgICAgICAgICAgICAgICAgYidTZXJ2ZXI6IFNvY2tzVGVzdFNlcnZlclxyXG4nCiAgICAgICAgICAgICAgICAgICAgICAgICBiJ0NvbnRlbnQtTGVuZ3RoOiAwXHJcbicKICAgICAgICAgICAgICAgICAgICAgICAgIGInXHJcbicpCiAgICAgICAgICAgIHNvY2suY2xvc2UoKQoKICAgICAgICBzZWxmLl9zdGFydF9zZXJ2ZXIocmVxdWVzdF9oYW5kbGVyKQogICAgICAgIHByb3h5X3VybCA9ICJzb2NrczVoOi8vJXM6JXMiICUgKHNlbGYuaG9zdCwgc2VsZi5wb3J0KQogICAgICAgIHBtID0gc29ja3MuU09DS1NQcm94eU1hbmFnZXIocHJveHlfdXJsKQogICAgICAgIHNlbGYuYWRkQ2xlYW51cChwbS5jbGVhcikKICAgICAgICByZXNwb25zZSA9IHBtLnJlcXVlc3QoJ0dFVCcsICdodHRwOi8vZXhhbXBsZS5jb20nKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwocmVzcG9uc2Uuc3RhdHVzLCAyMDApCgogICAgZGVmIHRlc3RfY29ubmVjdGlvbl90aW1lb3V0cyhzZWxmKToKICAgICAgICBldmVudCA9IHRocmVhZGluZy5FdmVudCgpCgogICAgICAgIGRlZiByZXF1ZXN0X2hhbmRsZXIobGlzdGVuZXIpOgogICAgICAgICAgICBldmVudC53YWl0KCkKCiAgICAgICAgc2VsZi5fc3RhcnRfc2VydmVyKHJlcXVlc3RfaGFuZGxlcikKICAgICAgICBwcm94eV91cmwgPSAic29ja3M1aDovLyVzOiVzIiAlIChzZWxmLmhvc3QsIHNlbGYucG9ydCkKICAgICAgICBwbSA9IHNvY2tzLlNPQ0tTUHJveHlNYW5hZ2VyKHByb3h5X3VybCkKICAgICAgICBzZWxmLmFkZENsZWFudXAocG0uY2xlYXIpCgogICAgICAgIHNlbGYuYXNzZXJ0UmFpc2VzKAogICAgICAgICAgICBDb25uZWN0VGltZW91dEVycm9yLCBwbS5yZXF1ZXN0LCAnR0VUJywgJ2h0dHA6Ly9leGFtcGxlLmNvbScsCiAgICAgICAgICAgIHRpbWVvdXQ9MC4wMDEsIHJldHJpZXM9RmFsc2UKICAgICAgICApCiAgICAgICAgZXZlbnQuc2V0KCkKCiAgICBkZWYgdGVzdF9jb25uZWN0aW9uX2ZhaWx1cmUoc2VsZik6CiAgICAgICAgZXZlbnQgPSB0aHJlYWRpbmcuRXZlbnQoKQoKICAgICAgICBkZWYgcmVxdWVzdF9oYW5kbGVyKGxpc3RlbmVyKToKICAgICAgICAgICAgbGlzdGVuZXIuY2xvc2UoKQogICAgICAgICAgICBldmVudC5zZXQoKQoKICAgICAgICBzZWxmLl9zdGFydF9zZXJ2ZXIocmVxdWVzdF9oYW5kbGVyKQogICAgICAgIHByb3h5X3VybCA9ICJzb2NrczVoOi8vJXM6JXMiICUgKHNlbGYuaG9zdCwgc2VsZi5wb3J0KQogICAgICAgIHBtID0gc29ja3MuU09DS1NQcm94eU1hbmFnZXIocHJveHlfdXJsKQogICAgICAgIHNlbGYuYWRkQ2xlYW51cChwbS5jbGVhcikKCiAgICAgICAgZXZlbnQud2FpdCgpCiAgICAgICAgc2VsZi5hc3NlcnRSYWlzZXMoCiAgICAgICAgICAgIE5ld0Nvbm5lY3Rpb25FcnJvciwgcG0ucmVxdWVzdCwgJ0dFVCcsICdodHRwOi8vZXhhbXBsZS5jb20nLAogICAgICAgICAgICByZXRyaWVzPUZhbHNlCiAgICAgICAgKQoKICAgIGRlZiB0ZXN0X3Byb3h5X3JlamVjdGlvbihzZWxmKToKICAgICAgICBldnQgPSB0aHJlYWRpbmcuRXZlbnQoKQoKICAgICAgICBkZWYgcmVxdWVzdF9oYW5kbGVyKGxpc3RlbmVyKToKICAgICAgICAgICAgc29jayA9IGxpc3RlbmVyLmFjY2VwdCgpWzBdCgogICAgICAgICAgICBoYW5kbGVyID0gaGFuZGxlX3NvY2tzNV9uZWdvdGlhdGlvbihzb2NrLCBuZWdvdGlhdGU9RmFsc2UpCiAgICAgICAgICAgIGFkZHIsIHBvcnQgPSBuZXh0KGhhbmRsZXIpCiAgICAgICAgICAgIGhhbmRsZXIuc2VuZChGYWxzZSkKCiAgICAgICAgICAgIGV2dC53YWl0KCkKICAgICAgICAgICAgc29jay5jbG9zZSgpCgogICAgICAgIHNlbGYuX3N0YXJ0X3NlcnZlcihyZXF1ZXN0X2hhbmRsZXIpCiAgICAgICAgcHJveHlfdXJsID0gInNvY2tzNWg6Ly8lczolcyIgJSAoc2VsZi5ob3N0LCBzZWxmLnBvcnQpCiAgICAgICAgcG0gPSBzb2Nrcy5TT0NLU1Byb3h5TWFuYWdlcihwcm94eV91cmwpCiAgICAgICAgc2VsZi5hZGRDbGVhbnVwKHBtLmNsZWFyKQoKICAgICAgICBzZWxmLmFzc2VydFJhaXNlcygKICAgICAgICAgICAgTmV3Q29ubmVjdGlvbkVycm9yLCBwbS5yZXF1ZXN0LCAnR0VUJywgJ2h0dHA6Ly9leGFtcGxlLmNvbScsCiAgICAgICAgICAgIHJldHJpZXM9RmFsc2UKICAgICAgICApCiAgICAgICAgZXZ0LnNldCgpCgogICAgZGVmIHRlc3Rfc29ja3Nfd2l0aF9wYXNzd29yZChzZWxmKToKICAgICAgICBkZWYgcmVxdWVzdF9oYW5kbGVyKGxpc3RlbmVyKToKICAgICAgICAgICAgc29jayA9IGxpc3RlbmVyLmFjY2VwdCgpWzBdCgogICAgICAgICAgICBoYW5kbGVyID0gaGFuZGxlX3NvY2tzNV9uZWdvdGlhdGlvbigKICAgICAgICAgICAgICAgIHNvY2ssIG5lZ290aWF0ZT1UcnVlLCB1c2VybmFtZT1iJ3VzZXInLCBwYXNzd29yZD1iJ3Bhc3MnCiAgICAgICAgICAgICkKICAgICAgICAgICAgYWRkciwgcG9ydCA9IG5leHQoaGFuZGxlcikKCiAgICAgICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoYWRkciwgJzE2LjE3LjE4LjE5JykKICAgICAgICAgICAgc2VsZi5hc3NlcnRUcnVlKHBvcnQsIDgwKQogICAgICAgICAgICBoYW5kbGVyLnNlbmQoVHJ1ZSkKCiAgICAgICAgICAgIHdoaWxlIFRydWU6CiAgICAgICAgICAgICAgICBidWYgPSBzb2NrLnJlY3YoNjU1MzUpCiAgICAgICAgICAgICAgICBpZiBidWYuZW5kc3dpdGgoYidcclxuXHJcbicpOgogICAgICAgICAgICAgICAgICAgIGJyZWFrCgogICAgICAgICAgICBzb2NrLnNlbmRhbGwoYidIVFRQLzEuMSAyMDAgT0tcclxuJwogICAgICAgICAgICAgICAgICAgICAgICAgYidTZXJ2ZXI6IFNvY2tzVGVzdFNlcnZlclxyXG4nCiAgICAgICAgICAgICAgICAgICAgICAgICBiJ0NvbnRlbnQtTGVuZ3RoOiAwXHJcbicKICAgICAgICAgICAgICAgICAgICAgICAgIGInXHJcbicpCiAgICAgICAgICAgIHNvY2suY2xvc2UoKQoKICAgICAgICBzZWxmLl9zdGFydF9zZXJ2ZXIocmVxdWVzdF9oYW5kbGVyKQogICAgICAgIHByb3h5X3VybCA9ICJzb2NrczU6Ly8lczolcyIgJSAoc2VsZi5ob3N0LCBzZWxmLnBvcnQpCiAgICAgICAgcG0gPSBzb2Nrcy5TT0NLU1Byb3h5TWFuYWdlcihwcm94eV91cmwsIHVzZXJuYW1lPSd1c2VyJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhc3N3b3JkPSdwYXNzJykKICAgICAgICBzZWxmLmFkZENsZWFudXAocG0uY2xlYXIpCgogICAgICAgIHJlc3BvbnNlID0gcG0ucmVxdWVzdCgnR0VUJywgJ2h0dHA6Ly8xNi4xNy4xOC4xOScpCgogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwocmVzcG9uc2Uuc3RhdHVzLCAyMDApCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChyZXNwb25zZS5kYXRhLCBiJycpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChyZXNwb25zZS5oZWFkZXJzWydTZXJ2ZXInXSwgJ1NvY2tzVGVzdFNlcnZlcicpCgogICAgZGVmIHRlc3Rfc29ja3Nfd2l0aF9pbnZhbGlkX3Bhc3N3b3JkKHNlbGYpOgogICAgICAgIGRlZiByZXF1ZXN0X2hhbmRsZXIobGlzdGVuZXIpOgogICAgICAgICAgICBzb2NrID0gbGlzdGVuZXIuYWNjZXB0KClbMF0KCiAgICAgICAgICAgIGhhbmRsZXIgPSBoYW5kbGVfc29ja3M1X25lZ290aWF0aW9uKAogICAgICAgICAgICAgICAgc29jaywgbmVnb3RpYXRlPVRydWUsIHVzZXJuYW1lPWIndXNlcicsIHBhc3N3b3JkPWIncGFzcycKICAgICAgICAgICAgKQogICAgICAgICAgICBuZXh0KGhhbmRsZXIpCgogICAgICAgIHNlbGYuX3N0YXJ0X3NlcnZlcihyZXF1ZXN0X2hhbmRsZXIpCiAgICAgICAgcHJveHlfdXJsID0gInNvY2tzNWg6Ly8lczolcyIgJSAoc2VsZi5ob3N0LCBzZWxmLnBvcnQpCiAgICAgICAgcG0gPSBzb2Nrcy5TT0NLU1Byb3h5TWFuYWdlcihwcm94eV91cmwsIHVzZXJuYW1lPSd1c2VyJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhc3N3b3JkPSdiYWRwYXNzJykKICAgICAgICBzZWxmLmFkZENsZWFudXAocG0uY2xlYXIpCgogICAgICAgIHRyeToKICAgICAgICAgICAgcG0ucmVxdWVzdCgnR0VUJywgJ2h0dHA6Ly9leGFtcGxlLmNvbScsIHJldHJpZXM9RmFsc2UpCiAgICAgICAgZXhjZXB0IE5ld0Nvbm5lY3Rpb25FcnJvciBhcyBlOgogICAgICAgICAgICBzZWxmLmFzc2VydFRydWUoIlNPQ0tTNSBhdXRoZW50aWNhdGlvbiBmYWlsZWQiIGluIHN0cihlKSkKICAgICAgICBlbHNlOgogICAgICAgICAgICBzZWxmLmZhaWwoIkRpZCBub3QgcmFpc2UiKQoKICAgIGRlZiB0ZXN0X3NvdXJjZV9hZGRyZXNzX3dvcmtzKHNlbGYpOgogICAgICAgIGV4cGVjdGVkX3BvcnQgPSBfZ2V0X2ZyZWVfcG9ydChzZWxmLmhvc3QpCgogICAgICAgIGRlZiByZXF1ZXN0X2hhbmRsZXIobGlzdGVuZXIpOgogICAgICAgICAgICBzb2NrID0gbGlzdGVuZXIuYWNjZXB0KClbMF0KICAgICAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChzb2NrLmdldHBlZXJuYW1lKClbMF0sICcxMjcuMC4wLjEnKQogICAgICAgICAgICBzZWxmLmFzc2VydEVxdWFsKHNvY2suZ2V0cGVlcm5hbWUoKVsxXSwgZXhwZWN0ZWRfcG9ydCkKCiAgICAgICAgICAgIGhhbmRsZXIgPSBoYW5kbGVfc29ja3M1X25lZ290aWF0aW9uKHNvY2ssIG5lZ290aWF0ZT1GYWxzZSkKICAgICAgICAgICAgYWRkciwgcG9ydCA9IG5leHQoaGFuZGxlcikKCiAgICAgICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoYWRkciwgJzE2LjE3LjE4LjE5JykKICAgICAgICAgICAgc2VsZi5hc3NlcnRUcnVlKHBvcnQsIDgwKQogICAgICAgICAgICBoYW5kbGVyLnNlbmQoVHJ1ZSkKCiAgICAgICAgICAgIHdoaWxlIFRydWU6CiAgICAgICAgICAgICAgICBidWYgPSBzb2NrLnJlY3YoNjU1MzUpCiAgICAgICAgICAgICAgICBpZiBidWYuZW5kc3dpdGgoYidcclxuXHJcbicpOgogICAgICAgICAgICAgICAgICAgIGJyZWFrCgogICAgICAgICAgICBzb2NrLnNlbmRhbGwoYidIVFRQLzEuMSAyMDAgT0tcclxuJwogICAgICAgICAgICAgICAgICAgICAgICAgYidTZXJ2ZXI6IFNvY2tzVGVzdFNlcnZlclxyXG4nCiAgICAgICAgICAgICAgICAgICAgICAgICBiJ0NvbnRlbnQtTGVuZ3RoOiAwXHJcbicKICAgICAgICAgICAgICAgICAgICAgICAgIGInXHJcbicpCiAgICAgICAgICAgIHNvY2suY2xvc2UoKQoKICAgICAgICBzZWxmLl9zdGFydF9zZXJ2ZXIocmVxdWVzdF9oYW5kbGVyKQogICAgICAgIHByb3h5X3VybCA9ICJzb2NrczU6Ly8lczolcyIgJSAoc2VsZi5ob3N0LCBzZWxmLnBvcnQpCiAgICAgICAgcG0gPSBzb2Nrcy5TT0NLU1Byb3h5TWFuYWdlcigKICAgICAgICAgICAgcHJveHlfdXJsLCBzb3VyY2VfYWRkcmVzcz0oJzEyNy4wLjAuMScsIGV4cGVjdGVkX3BvcnQpCiAgICAgICAgKQogICAgICAgIHNlbGYuYWRkQ2xlYW51cChwbS5jbGVhcikKICAgICAgICByZXNwb25zZSA9IHBtLnJlcXVlc3QoJ0dFVCcsICdodHRwOi8vMTYuMTcuMTguMTknKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwocmVzcG9uc2Uuc3RhdHVzLCAyMDApCgoKY2xhc3MgVGVzdFNPQ0tTNFByb3h5KElQVjRTb2NrZXREdW1teVNlcnZlclRlc3RDYXNlKToKICAgICIiIgogICAgVGVzdCB0aGUgU09DS1MgcHJveHkgaW4gU09DS1M0IG1vZGUuCgogICAgSGFzIHJlbGF0aXZlbHkgZmV3ZXIgdGVzdHMgdGhhbiB0aGUgU09DS1M1IGNhc2UsIG1vc3RseSBiZWNhdXNlIG9uY2UgdGhlCiAgICBuZWdvdGlhdGlvbiBpcyBkb25lIHRoZSB0d28gY2FzZXMgYmVoYXZlIGlkZW50aWNhbGx5LgogICAgIiIiCiAgICBkZWYgdGVzdF9iYXNpY19yZXF1ZXN0KHNlbGYpOgogICAgICAgIGRlZiByZXF1ZXN0X2hhbmRsZXIobGlzdGVuZXIpOgogICAgICAgICAgICBzb2NrID0gbGlzdGVuZXIuYWNjZXB0KClbMF0KCiAgICAgICAgICAgIGhhbmRsZXIgPSBoYW5kbGVfc29ja3M0X25lZ290aWF0aW9uKHNvY2spCiAgICAgICAgICAgIGFkZHIsIHBvcnQgPSBuZXh0KGhhbmRsZXIpCgogICAgICAgICAgICBzZWxmLmFzc2VydEVxdWFsKGFkZHIsICcxNi4xNy4xOC4xOScpCiAgICAgICAgICAgIHNlbGYuYXNzZXJ0VHJ1ZShwb3J0LCA4MCkKICAgICAgICAgICAgaGFuZGxlci5zZW5kKFRydWUpCgogICAgICAgICAgICB3aGlsZSBUcnVlOgogICAgICAgICAgICAgICAgYnVmID0gc29jay5yZWN2KDY1NTM1KQogICAgICAgICAgICAgICAgaWYgYnVmLmVuZHN3aXRoKGInXHJcblxyXG4nKToKICAgICAgICAgICAgICAgICAgICBicmVhawoKICAgICAgICAgICAgc29jay5zZW5kYWxsKGInSFRUUC8xLjEgMjAwIE9LXHJcbicKICAgICAgICAgICAgICAgICAgICAgICAgIGInU2VydmVyOiBTb2Nrc1Rlc3RTZXJ2ZXJcclxuJwogICAgICAgICAgICAgICAgICAgICAgICAgYidDb250ZW50LUxlbmd0aDogMFxyXG4nCiAgICAgICAgICAgICAgICAgICAgICAgICBiJ1xyXG4nKQogICAgICAgICAgICBzb2NrLmNsb3NlKCkKCiAgICAgICAgc2VsZi5fc3RhcnRfc2VydmVyKHJlcXVlc3RfaGFuZGxlcikKICAgICAgICBwcm94eV91cmwgPSAic29ja3M0Oi8vJXM6JXMiICUgKHNlbGYuaG9zdCwgc2VsZi5wb3J0KQogICAgICAgIHBtID0gc29ja3MuU09DS1NQcm94eU1hbmFnZXIocHJveHlfdXJsKQogICAgICAgIHNlbGYuYWRkQ2xlYW51cChwbS5jbGVhcikKICAgICAgICByZXNwb25zZSA9IHBtLnJlcXVlc3QoJ0dFVCcsICdodHRwOi8vMTYuMTcuMTguMTknKQoKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKHJlc3BvbnNlLnN0YXR1cywgMjAwKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwocmVzcG9uc2UuaGVhZGVyc1snU2VydmVyJ10sICdTb2Nrc1Rlc3RTZXJ2ZXInKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwocmVzcG9uc2UuZGF0YSwgYicnKQoKICAgIGRlZiB0ZXN0X2xvY2FsX2RucyhzZWxmKToKICAgICAgICBkZWYgcmVxdWVzdF9oYW5kbGVyKGxpc3RlbmVyKToKICAgICAgICAgICAgc29jayA9IGxpc3RlbmVyLmFjY2VwdCgpWzBdCgogICAgICAgICAgICBoYW5kbGVyID0gaGFuZGxlX3NvY2tzNF9uZWdvdGlhdGlvbihzb2NrKQogICAgICAgICAgICBhZGRyLCBwb3J0ID0gbmV4dChoYW5kbGVyKQoKICAgICAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChhZGRyLCAnMTI3LjAuMC4xJykKICAgICAgICAgICAgc2VsZi5hc3NlcnRUcnVlKHBvcnQsIDgwKQogICAgICAgICAgICBoYW5kbGVyLnNlbmQoVHJ1ZSkKCiAgICAgICAgICAgIHdoaWxlIFRydWU6CiAgICAgICAgICAgICAgICBidWYgPSBzb2NrLnJlY3YoNjU1MzUpCiAgICAgICAgICAgICAgICBpZiBidWYuZW5kc3dpdGgoYidcclxuXHJcbicpOgogICAgICAgICAgICAgICAgICAgIGJyZWFrCgogICAgICAgICAgICBzb2NrLnNlbmRhbGwoYidIVFRQLzEuMSAyMDAgT0tcclxuJwogICAgICAgICAgICAgICAgICAgICAgICAgYidTZXJ2ZXI6IFNvY2tzVGVzdFNlcnZlclxyXG4nCiAgICAgICAgICAgICAgICAgICAgICAgICBiJ0NvbnRlbnQtTGVuZ3RoOiAwXHJcbicKICAgICAgICAgICAgICAgICAgICAgICAgIGInXHJcbicpCiAgICAgICAgICAgIHNvY2suY2xvc2UoKQoKICAgICAgICBzZWxmLl9zdGFydF9zZXJ2ZXIocmVxdWVzdF9oYW5kbGVyKQogICAgICAgIHByb3h5X3VybCA9ICJzb2NrczQ6Ly8lczolcyIgJSAoc2VsZi5ob3N0LCBzZWxmLnBvcnQpCiAgICAgICAgcG0gPSBzb2Nrcy5TT0NLU1Byb3h5TWFuYWdlcihwcm94eV91cmwpCiAgICAgICAgcmVzcG9uc2UgPSBwbS5yZXF1ZXN0KCdHRVQnLCAnaHR0cDovL2xvY2FsaG9zdCcpCgogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwocmVzcG9uc2Uuc3RhdHVzLCAyMDApCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChyZXNwb25zZS5oZWFkZXJzWydTZXJ2ZXInXSwgJ1NvY2tzVGVzdFNlcnZlcicpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChyZXNwb25zZS5kYXRhLCBiJycpCgogICAgZGVmIHRlc3RfY29ycmVjdF9oZWFkZXJfbGluZShzZWxmKToKICAgICAgICBkZWYgcmVxdWVzdF9oYW5kbGVyKGxpc3RlbmVyKToKICAgICAgICAgICAgc29jayA9IGxpc3RlbmVyLmFjY2VwdCgpWzBdCgogICAgICAgICAgICBoYW5kbGVyID0gaGFuZGxlX3NvY2tzNF9uZWdvdGlhdGlvbihzb2NrKQogICAgICAgICAgICBhZGRyLCBwb3J0ID0gbmV4dChoYW5kbGVyKQoKICAgICAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChhZGRyLCBiJ2V4YW1wbGUuY29tJykKICAgICAgICAgICAgc2VsZi5hc3NlcnRUcnVlKHBvcnQsIDgwKQogICAgICAgICAgICBoYW5kbGVyLnNlbmQoVHJ1ZSkKCiAgICAgICAgICAgIGJ1ZiA9IGInJwogICAgICAgICAgICB3aGlsZSBUcnVlOgogICAgICAgICAgICAgICAgYnVmICs9IHNvY2sucmVjdig2NTUzNSkKICAgICAgICAgICAgICAgIGlmIGJ1Zi5lbmRzd2l0aChiJ1xyXG5cclxuJyk6CiAgICAgICAgICAgICAgICAgICAgYnJlYWsKCiAgICAgICAgICAgIHNlbGYuYXNzZXJ0VHJ1ZShidWYuc3RhcnRzd2l0aChiJ0dFVCAvIEhUVFAvMS4xJykpCiAgICAgICAgICAgIHNlbGYuYXNzZXJ0VHJ1ZShiJ0hvc3Q6IGV4YW1wbGUuY29tJyBpbiBidWYpCgogICAgICAgICAgICBzb2NrLnNlbmRhbGwoYidIVFRQLzEuMSAyMDAgT0tcclxuJwogICAgICAgICAgICAgICAgICAgICAgICAgYidTZXJ2ZXI6IFNvY2tzVGVzdFNlcnZlclxyXG4nCiAgICAgICAgICAgICAgICAgICAgICAgICBiJ0NvbnRlbnQtTGVuZ3RoOiAwXHJcbicKICAgICAgICAgICAgICAgICAgICAgICAgIGInXHJcbicpCiAgICAgICAgICAgIHNvY2suY2xvc2UoKQoKICAgICAgICBzZWxmLl9zdGFydF9zZXJ2ZXIocmVxdWVzdF9oYW5kbGVyKQogICAgICAgIHByb3h5X3VybCA9ICJzb2NrczRhOi8vJXM6JXMiICUgKHNlbGYuaG9zdCwgc2VsZi5wb3J0KQogICAgICAgIHBtID0gc29ja3MuU09DS1NQcm94eU1hbmFnZXIocHJveHlfdXJsKQogICAgICAgIHNlbGYuYWRkQ2xlYW51cChwbS5jbGVhcikKICAgICAgICByZXNwb25zZSA9IHBtLnJlcXVlc3QoJ0dFVCcsICdodHRwOi8vZXhhbXBsZS5jb20nKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwocmVzcG9uc2Uuc3RhdHVzLCAyMDApCgogICAgZGVmIHRlc3RfcHJveHlfcmVqZWN0aW9uKHNlbGYpOgogICAgICAgIGV2dCA9IHRocmVhZGluZy5FdmVudCgpCgogICAgICAgIGRlZiByZXF1ZXN0X2hhbmRsZXIobGlzdGVuZXIpOgogICAgICAgICAgICBzb2NrID0gbGlzdGVuZXIuYWNjZXB0KClbMF0KCiAgICAgICAgICAgIGhhbmRsZXIgPSBoYW5kbGVfc29ja3M0X25lZ290aWF0aW9uKHNvY2spCiAgICAgICAgICAgIGFkZHIsIHBvcnQgPSBuZXh0KGhhbmRsZXIpCiAgICAgICAgICAgIGhhbmRsZXIuc2VuZChGYWxzZSkKCiAgICAgICAgICAgIGV2dC53YWl0KCkKICAgICAgICAgICAgc29jay5jbG9zZSgpCgogICAgICAgIHNlbGYuX3N0YXJ0X3NlcnZlcihyZXF1ZXN0X2hhbmRsZXIpCiAgICAgICAgcHJveHlfdXJsID0gInNvY2tzNGE6Ly8lczolcyIgJSAoc2VsZi5ob3N0LCBzZWxmLnBvcnQpCiAgICAgICAgcG0gPSBzb2Nrcy5TT0NLU1Byb3h5TWFuYWdlcihwcm94eV91cmwpCiAgICAgICAgc2VsZi5hZGRDbGVhbnVwKHBtLmNsZWFyKQoKICAgICAgICBzZWxmLmFzc2VydFJhaXNlcygKICAgICAgICAgICAgTmV3Q29ubmVjdGlvbkVycm9yLCBwbS5yZXF1ZXN0LCAnR0VUJywgJ2h0dHA6Ly9leGFtcGxlLmNvbScsCiAgICAgICAgICAgIHJldHJpZXM9RmFsc2UKICAgICAgICApCiAgICAgICAgZXZ0LnNldCgpCgogICAgZGVmIHRlc3Rfc29ja3M0X3dpdGhfdXNlcm5hbWUoc2VsZik6CiAgICAgICAgZGVmIHJlcXVlc3RfaGFuZGxlcihsaXN0ZW5lcik6CiAgICAgICAgICAgIHNvY2sgPSBsaXN0ZW5lci5hY2NlcHQoKVswXQoKICAgICAgICAgICAgaGFuZGxlciA9IGhhbmRsZV9zb2NrczRfbmVnb3RpYXRpb24oc29jaywgdXNlcm5hbWU9Yid1c2VyJykKICAgICAgICAgICAgYWRkciwgcG9ydCA9IG5leHQoaGFuZGxlcikKCiAgICAgICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoYWRkciwgJzE2LjE3LjE4LjE5JykKICAgICAgICAgICAgc2VsZi5hc3NlcnRUcnVlKHBvcnQsIDgwKQogICAgICAgICAgICBoYW5kbGVyLnNlbmQoVHJ1ZSkKCiAgICAgICAgICAgIHdoaWxlIFRydWU6CiAgICAgICAgICAgICAgICBidWYgPSBzb2NrLnJlY3YoNjU1MzUpCiAgICAgICAgICAgICAgICBpZiBidWYuZW5kc3dpdGgoYidcclxuXHJcbicpOgogICAgICAgICAgICAgICAgICAgIGJyZWFrCgogICAgICAgICAgICBzb2NrLnNlbmRhbGwoYidIVFRQLzEuMSAyMDAgT0tcclxuJwogICAgICAgICAgICAgICAgICAgICAgICAgYidTZXJ2ZXI6IFNvY2tzVGVzdFNlcnZlclxyXG4nCiAgICAgICAgICAgICAgICAgICAgICAgICBiJ0NvbnRlbnQtTGVuZ3RoOiAwXHJcbicKICAgICAgICAgICAgICAgICAgICAgICAgIGInXHJcbicpCiAgICAgICAgICAgIHNvY2suY2xvc2UoKQoKICAgICAgICBzZWxmLl9zdGFydF9zZXJ2ZXIocmVxdWVzdF9oYW5kbGVyKQogICAgICAgIHByb3h5X3VybCA9ICJzb2NrczQ6Ly8lczolcyIgJSAoc2VsZi5ob3N0LCBzZWxmLnBvcnQpCiAgICAgICAgcG0gPSBzb2Nrcy5TT0NLU1Byb3h5TWFuYWdlcihwcm94eV91cmwsIHVzZXJuYW1lPSd1c2VyJykKICAgICAgICBzZWxmLmFkZENsZWFudXAocG0uY2xlYXIpCiAgICAgICAgcmVzcG9uc2UgPSBwbS5yZXF1ZXN0KCdHRVQnLCAnaHR0cDovLzE2LjE3LjE4LjE5JykKCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChyZXNwb25zZS5zdGF0dXMsIDIwMCkKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKHJlc3BvbnNlLmRhdGEsIGInJykKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKHJlc3BvbnNlLmhlYWRlcnNbJ1NlcnZlciddLCAnU29ja3NUZXN0U2VydmVyJykKCiAgICBkZWYgdGVzdF9zb2Nrc193aXRoX2ludmFsaWRfdXNlcm5hbWUoc2VsZik6CiAgICAgICAgZGVmIHJlcXVlc3RfaGFuZGxlcihsaXN0ZW5lcik6CiAgICAgICAgICAgIHNvY2sgPSBsaXN0ZW5lci5hY2NlcHQoKVswXQoKICAgICAgICAgICAgaGFuZGxlciA9IGhhbmRsZV9zb2NrczRfbmVnb3RpYXRpb24oc29jaywgdXNlcm5hbWU9Yid1c2VyJykKICAgICAgICAgICAgbmV4dChoYW5kbGVyKQoKICAgICAgICBzZWxmLl9zdGFydF9zZXJ2ZXIocmVxdWVzdF9oYW5kbGVyKQogICAgICAgIHByb3h5X3VybCA9ICJzb2NrczRhOi8vJXM6JXMiICUgKHNlbGYuaG9zdCwgc2VsZi5wb3J0KQogICAgICAgIHBtID0gc29ja3MuU09DS1NQcm94eU1hbmFnZXIocHJveHlfdXJsLCB1c2VybmFtZT0nYmFkdXNlcicpCiAgICAgICAgc2VsZi5hZGRDbGVhbnVwKHBtLmNsZWFyKQoKICAgICAgICB0cnk6CiAgICAgICAgICAgIHBtLnJlcXVlc3QoJ0dFVCcsICdodHRwOi8vZXhhbXBsZS5jb20nLCByZXRyaWVzPUZhbHNlKQogICAgICAgIGV4Y2VwdCBOZXdDb25uZWN0aW9uRXJyb3IgYXMgZToKICAgICAgICAgICAgc2VsZi5hc3NlcnRUcnVlKCJkaWZmZXJlbnQgdXNlci1pZHMiIGluIHN0cihlKSkKICAgICAgICBlbHNlOgogICAgICAgICAgICBzZWxmLmZhaWwoIkRpZCBub3QgcmFpc2UiKQoKCmNsYXNzIFRlc3RTT0NLU1dpdGhUTFMoSVBWNFNvY2tldER1bW15U2VydmVyVGVzdENhc2UpOgogICAgIiIiCiAgICBUZXN0IHRoYXQgVExTIGJlaGF2ZXMgcHJvcGVybHkgZm9yIFNPQ0tTIHByb3hpZXMuCiAgICAiIiIKICAgIGRlZiB0ZXN0X2Jhc2ljX3JlcXVlc3Qoc2VsZik6CiAgICAgICAgaWYgbm90IEhBU19TU0w6CiAgICAgICAgICAgIHJhaXNlIFNraXBUZXN0KCJObyBUTFMgYXZhaWxhYmxlIikKCiAgICAgICAgZGVmIHJlcXVlc3RfaGFuZGxlcihsaXN0ZW5lcik6CiAgICAgICAgICAgIHNvY2sgPSBsaXN0ZW5lci5hY2NlcHQoKVswXQoKICAgICAgICAgICAgaGFuZGxlciA9IGhhbmRsZV9zb2NrczVfbmVnb3RpYXRpb24oc29jaywgbmVnb3RpYXRlPUZhbHNlKQogICAgICAgICAgICBhZGRyLCBwb3J0ID0gbmV4dChoYW5kbGVyKQoKICAgICAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChhZGRyLCBiJ2xvY2FsaG9zdCcpCiAgICAgICAgICAgIHNlbGYuYXNzZXJ0VHJ1ZShwb3J0LCA0NDMpCiAgICAgICAgICAgIGhhbmRsZXIuc2VuZChUcnVlKQoKICAgICAgICAgICAgIyBXcmFwIGluIFRMUwogICAgICAgICAgICBjb250ZXh0ID0gYmV0dGVyX3NzbC5TU0xDb250ZXh0KHNzbC5QUk9UT0NPTF9TU0x2MjMpCiAgICAgICAgICAgIGNvbnRleHQubG9hZF9jZXJ0X2NoYWluKAogICAgICAgICAgICAgICAgREVGQVVMVF9DRVJUU1snY2VydGZpbGUnXSwgREVGQVVMVF9DRVJUU1sna2V5ZmlsZSddCiAgICAgICAgICAgICkKICAgICAgICAgICAgdGxzID0gY29udGV4dC53cmFwX3NvY2tldChzb2NrLCBzZXJ2ZXJfc2lkZT1UcnVlKQogICAgICAgICAgICBidWYgPSBiJycKCiAgICAgICAgICAgIHdoaWxlIFRydWU6CiAgICAgICAgICAgICAgICBidWYgKz0gdGxzLnJlY3YoNjU1MzUpCiAgICAgICAgICAgICAgICBpZiBidWYuZW5kc3dpdGgoYidcclxuXHJcbicpOgogICAgICAgICAgICAgICAgICAgIGJyZWFrCgogICAgICAgICAgICBzZWxmLmFzc2VydFRydWUoYnVmLnN0YXJ0c3dpdGgoYidHRVQgLyBIVFRQLzEuMVxyXG4nKSkKCiAgICAgICAgICAgIHRscy5zZW5kYWxsKGInSFRUUC8xLjEgMjAwIE9LXHJcbicKICAgICAgICAgICAgICAgICAgICAgICAgYidTZXJ2ZXI6IFNvY2tzVGVzdFNlcnZlclxyXG4nCiAgICAgICAgICAgICAgICAgICAgICAgIGInQ29udGVudC1MZW5ndGg6IDBcclxuJwogICAgICAgICAgICAgICAgICAgICAgICBiJ1xyXG4nKQogICAgICAgICAgICB0bHMuY2xvc2UoKQoKICAgICAgICBzZWxmLl9zdGFydF9zZXJ2ZXIocmVxdWVzdF9oYW5kbGVyKQogICAgICAgIHByb3h5X3VybCA9ICJzb2NrczVoOi8vJXM6JXMiICUgKHNlbGYuaG9zdCwgc2VsZi5wb3J0KQogICAgICAgIHBtID0gc29ja3MuU09DS1NQcm94eU1hbmFnZXIocHJveHlfdXJsKQogICAgICAgIHNlbGYuYWRkQ2xlYW51cChwbS5jbGVhcikKICAgICAgICByZXNwb25zZSA9IHBtLnJlcXVlc3QoJ0dFVCcsICdodHRwczovL2xvY2FsaG9zdCcpCgogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwocmVzcG9uc2Uuc3RhdHVzLCAyMDApCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChyZXNwb25zZS5kYXRhLCBiJycpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChyZXNwb25zZS5oZWFkZXJzWydTZXJ2ZXInXSwgJ1NvY2tzVGVzdFNlcnZlcicpCg==
