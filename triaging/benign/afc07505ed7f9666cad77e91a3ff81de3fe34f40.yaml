statistics:
  total_files: 1
  skipped_files: 0.0
  processed_objects: 1
  malicious_objects: 0
details:
- path: .repo_cache/malicious_repos/pypi_malregistry/urlib3/1.21.1/urlib3-1.21.1/urlib3-1.21.1/test/test_selectors.py
  contents:
  - name: BaseSelectorTestCase.test_select_multiple_event_types
    score: 0.0
    code: |-
      def test_select_multiple_event_types(self):
              s = self.make_selector()

              rd, wr = self.make_socketpair()
              key = s.register(rd, selectors.EVENT_READ | selectors.EVENT_WRITE)

              self.assertEqual([(key, selectors.EVENT_WRITE)], s.select(0.001))

              wr.send(b'x')
              time.sleep(0.01)  # Wait for the write to flush.

              self.assertEqual([(key, selectors.EVENT_READ | selectors.EVENT_WRITE)], s.select(0.001))
    tokens: resume load_fast self load_attr make_selector call store_fast s load_fast self load_attr make_socketpair call unpack_sequence store_fast rd store_fast wr load_fast s load_attr register load_fast rd load_global selectors load_attr EVENT_READ load_global selectors load_attr EVENT_WRITE binary_op | call store_fast key load_fast self load_attr assertEqual load_fast key load_global selectors load_attr EVENT_WRITE build_tuple build_list load_fast s load_attr select load_const FLOAT call call pop_top load_fast wr load_attr send load_const call pop_top load_global time load_attr sleep load_const FLOAT call pop_top load_fast self load_attr assertEqual load_fast key load_global selectors load_attr EVENT_READ load_global selectors load_attr EVENT_WRITE binary_op | build_tuple build_list load_fast s load_attr select load_const FLOAT call call pop_top return_const None
    hash: aecec47f1da6ba812469367287da29c61a8eb6c8c0dd92d2350b32eaf36c740f
sources:
  .repo_cache/malicious_repos/pypi_malregistry/urlib3/1.21.1/urlib3-1.21.1/urlib3-1.21.1/test/test_selectors.py: ZnJvbSBfX2Z1dHVyZV9fIGltcG9ydCB3aXRoX3N0YXRlbWVudAppbXBvcnQgZXJybm8KaW1wb3J0IG9zCmltcG9ydCBwc3V0aWwKaW1wb3J0IHNlbGVjdAppbXBvcnQgc2lnbmFsCmltcG9ydCBzeXMKaW1wb3J0IHRpbWUKaW1wb3J0IHRocmVhZGluZwoKdHJ5OiAgIyBQeXRob24gMi42IHVuaXR0ZXN0IG1vZHVsZSBkb2Vzbid0IGhhdmUgc2tpcCBkZWNvcmF0b3JzLgogICAgZnJvbSB1bml0dGVzdCBpbXBvcnQgc2tpcElmLCBza2lwVW5sZXNzCiAgICBpbXBvcnQgdW5pdHRlc3QKZXhjZXB0IEltcG9ydEVycm9yOgogICAgZnJvbSB1bml0dGVzdDIgaW1wb3J0IHNraXBJZiwgc2tpcFVubGVzcwogICAgaW1wb3J0IHVuaXR0ZXN0MiBhcyB1bml0dGVzdAoKdHJ5OiAgIyBQeXRob24gMi54IGRvZXNuJ3QgZGVmaW5lIHRpbWUucGVyZl9jb3VudGVyLgogICAgZnJvbSB0aW1lIGltcG9ydCBwZXJmX2NvdW50ZXIgYXMgZ2V0X3RpbWUKZXhjZXB0IEltcG9ydEVycm9yOgogICAgZnJvbSB0aW1lIGltcG9ydCB0aW1lIGFzIGdldF90aW1lCgp0cnk6ICAjIFB5dGhvbiAyLjYgZG9lc24ndCBoYXZlIHRoZSByZXNvdXJjZSBtb2R1bGUuCiAgICBpbXBvcnQgcmVzb3VyY2UKZXhjZXB0IEltcG9ydEVycm9yOgogICAgcmVzb3VyY2UgPSBOb25lCgp0cnk6ICAjIFdpbmRvd3MgZG9lc24ndCBzdXBwb3J0IHNvY2tldHBhaXIgb24gUHl0aG9uIDMuNTwKICAgIGZyb20gc29ja2V0IGltcG9ydCBzb2NrZXRwYWlyCmV4Y2VwdCBJbXBvcnRFcnJvcjoKICAgIGZyb20gLnNvY2tldHBhaXJfaGVscGVyIGltcG9ydCBzb2NrZXRwYWlyCgpmcm9tIHVybGxpYjMudXRpbCBpbXBvcnQgKAogICAgc2VsZWN0b3JzLAogICAgd2FpdAopCgpIQVNfQUxBUk0gPSBoYXNhdHRyKHNpZ25hbCwgImFsYXJtIikKCkxPTkdfU0VMRUNUID0gMC4yClNIT1JUX1NFTEVDVCA9IDAuMDEKCiMgVG9sZXJhbmNlIHZhbHVlcyBmb3IgdGltZXIvc3BlZWQgZmx1Y3R1YXRpb25zLgpUT0xFUkFOQ0UgPSAwLjc1CgojIERldGVjdCB3aGV0aGVyIHdlJ3JlIHJ1bm5pbmcgb24gVHJhdmlzIG9yIEFwcFZleW9yLiAgVGhpcwojIGlzIHVzZWQgdG8gc2tpcCBzb21lIHZlcmlmaWNhdGlvbiBwb2ludHMgaW5zaWRlIG9mIHRlc3RzIHRvCiMgbm90IHJhbmRvbWx5IGZhaWwgb3VyIENJIGR1ZSB0byB3aWxkIHRpbWVyL3NwZWVkIGRpZmZlcmVuY2VzLgpUUkFWSVNfQ0kgPSAiVFJBVklTIiBpbiBvcy5lbnZpcm9uCkFQUFZFWU9SID0gIkFQUFZFWU9SIiBpbiBvcy5lbnZpcm9uCgoKc2tpcFVubGVzc0hhc1NlbGVjdG9yID0gc2tpcFVubGVzcyhzZWxlY3RvcnMuSEFTX1NFTEVDVCwgIlBsYXRmb3JtIGRvZXNuJ3QgaGF2ZSBhIHNlbGVjdG9yIikKc2tpcFVubGVzc0hhc0VOT1NZUyA9IHNraXBVbmxlc3MoaGFzYXR0cihlcnJubywgJ0VOT1NZUycpLCAiUGxhdGZvcm0gZG9lc24ndCBoYXZlIGVycm5vLkVOT1NZUyIpCnNraXBVbmxlc3NIYXNBbGFybSA9IHNraXBVbmxlc3MoaGFzYXR0cihzaWduYWwsICdhbGFybScpLCAiUGxhdGZvcm0gZG9lc24ndCBoYXZlIHNpZ25hbC5hbGFybSgpIikKCgpkZWYgcGF0Y2hfc2VsZWN0X21vZHVsZSh0ZXN0Y2FzZSwgKmtlZXAsICoqcmVwbGFjZSk6CiAgICAiIiIgSGVscGVyIGZ1bmN0aW9uIHRoYXQgcmVtb3ZlcyBhbGwgc2VsZWN0b3JzIGZyb20gdGhlIHNlbGVjdCBtb2R1bGUKICAgIGV4Y2VwdCB0aG9zZSBsaXN0ZWQgaW4gKmtlZXAgYW5kICoqcmVwbGFjZS4gVGhvc2UgaW4ga2VlcCB3aWxsIGJlIGtlcHQKICAgIGlmIHRoZXkgZXhpc3QgaW4gdGhlIHNlbGVjdCBtb2R1bGUgYW5kIHRob3NlIGluIHJlcGxhY2Ugd2lsbCBiZSBwYXRjaGVkCiAgICB3aXRoIHRoZSB2YWx1ZSB0aGF0IGlzIGdpdmVuIHJlZ2FyZGxlc3MgaWYgdGhleSBleGlzdCBvciBub3QuIENsZWFudXAKICAgIHdpbGwgcmVzdG9yZSBwcmV2aW91cyBzdGF0ZS4gVGhpcyBoZWxwZXIgYWxzbyByZXNldHMgdGhlIHNlbGVjdG9ycyBtb2R1bGUKICAgIHNvIHRoYXQgYSBjYWxsIHRvIERlZmF1bHRTZWxlY3RvcigpIHdpbGwgZG8gZmVhdHVyZSBkZXRlY3Rpb24gYWdhaW4uICIiIgogICAgc2VsZWN0b3JzLl9ERUZBVUxUX1NFTEVDVE9SID0gTm9uZQogICAgZm9yIHMgaW4gWydzZWxlY3QnLCAncG9sbCcsICdlcG9sbCcsICdrcXVldWUnXToKICAgICAgICBpZiBzIGluIHJlcGxhY2U6CiAgICAgICAgICAgIGlmIGhhc2F0dHIoc2VsZWN0LCBzKToKICAgICAgICAgICAgICAgIG9sZF9zZWxlY3RvciA9IGdldGF0dHIoc2VsZWN0LCBzKQogICAgICAgICAgICAgICAgdGVzdGNhc2UuYWRkQ2xlYW51cChzZXRhdHRyLCBzZWxlY3QsIHMsIG9sZF9zZWxlY3RvcikKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHRlc3RjYXNlLmFkZENsZWFudXAoZGVsYXR0ciwgc2VsZWN0LCBzKQogICAgICAgICAgICBzZXRhdHRyKHNlbGVjdCwgcywgcmVwbGFjZVtzXSkKICAgICAgICBlbGlmIHMgbm90IGluIGtlZXAgYW5kIGhhc2F0dHIoc2VsZWN0LCBzKToKICAgICAgICAgICAgb2xkX3NlbGVjdG9yID0gZ2V0YXR0cihzZWxlY3QsIHMpCiAgICAgICAgICAgIHRlc3RjYXNlLmFkZENsZWFudXAoc2V0YXR0ciwgc2VsZWN0LCBzLCBvbGRfc2VsZWN0b3IpCiAgICAgICAgICAgIGRlbGF0dHIoc2VsZWN0LCBzKQoKCmNsYXNzIEFsYXJtVGhyZWFkKHRocmVhZGluZy5UaHJlYWQpOgogICAgZGVmIF9faW5pdF9fKHNlbGYsIHRpbWVvdXQpOgogICAgICAgIHN1cGVyKEFsYXJtVGhyZWFkLCBzZWxmKS5fX2luaXRfXyhncm91cD1Ob25lKQogICAgICAgIHNlbGYuc2V0RGFlbW9uKFRydWUpCiAgICAgICAgc2VsZi50aW1lb3V0ID0gdGltZW91dAogICAgICAgIHNlbGYuY2FuY2VsZWQgPSBGYWxzZQoKICAgIGRlZiBjYW5jZWwoc2VsZik6CiAgICAgICAgc2VsZi5jYW5jZWxlZCA9IFRydWUKCiAgICBkZWYgcnVuKHNlbGYpOgogICAgICAgIHRpbWUuc2xlZXAoc2VsZi50aW1lb3V0KQogICAgICAgIGlmIG5vdCBzZWxmLmNhbmNlbGVkOgogICAgICAgICAgICBvcy5raWxsKG9zLmdldHBpZCgpLCBzaWduYWwuU0lHQUxSTSkKCgpjbGFzcyBBbGFybU1peGluKG9iamVjdCk6CiAgICBhbGFybV90aHJlYWQgPSBOb25lCgogICAgZGVmIF9iZWdpbl9hbGFybV90aHJlYWQoc2VsZiwgdGltZW91dCk6CiAgICAgICAgc2VsZi5hZGRDbGVhbnVwKHNlbGYuX2NhbmNlbF9hbGFybV90aHJlYWQpCiAgICAgICAgc2VsZi5hbGFybV90aHJlYWQgPSBBbGFybVRocmVhZCh0aW1lb3V0KQogICAgICAgIHNlbGYuYWxhcm1fdGhyZWFkLnN0YXJ0KCkKCiAgICBkZWYgX2NhbmNlbF9hbGFybV90aHJlYWQoc2VsZik6CiAgICAgICAgaWYgc2VsZi5hbGFybV90aHJlYWQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHNlbGYuYWxhcm1fdGhyZWFkLmNhbmNlbCgpCiAgICAgICAgICAgIHNlbGYuYWxhcm1fdGhyZWFkLmpvaW4oMC4wKQogICAgICAgIHNlbGYuYWxhcm1fdGhyZWFkID0gTm9uZQoKICAgIGRlZiBzZXRfYWxhcm0oc2VsZiwgZHVyYXRpb24sIGhhbmRsZXIpOgogICAgICAgIHNpZ2Fscm1faGFuZGxlciA9IHNpZ25hbC5zaWduYWwoc2lnbmFsLlNJR0FMUk0sIGhhbmRsZXIpCiAgICAgICAgc2VsZi5hZGRDbGVhbnVwKHNpZ25hbC5zaWduYWwsIHNpZ25hbC5TSUdBTFJNLCBzaWdhbHJtX2hhbmRsZXIpCiAgICAgICAgc2VsZi5fYmVnaW5fYWxhcm1fdGhyZWFkKGR1cmF0aW9uKQoKCmNsYXNzIFRpbWVyQ29udGV4dChvYmplY3QpOgogICAgZGVmIF9faW5pdF9fKHNlbGYsIHRlc3RjYXNlLCBsb3dlcj1Ob25lLCB1cHBlcj1Ob25lKToKICAgICAgICBzZWxmLnRlc3RjYXNlID0gdGVzdGNhc2UKICAgICAgICBzZWxmLmxvd2VyID0gbG93ZXIKICAgICAgICBzZWxmLnVwcGVyID0gdXBwZXIKICAgICAgICBzZWxmLnN0YXJ0X3RpbWUgPSBOb25lCiAgICAgICAgc2VsZi5lbmRfdGltZSA9IE5vbmUKCiAgICBkZWYgX19lbnRlcl9fKHNlbGYpOgogICAgICAgIHNlbGYuc3RhcnRfdGltZSA9IGdldF90aW1lKCkKCiAgICBkZWYgX19leGl0X18oc2VsZiwgKmFyZ3MsICoqa3dhcmdzKToKICAgICAgICBzZWxmLmVuZF90aW1lID0gZ2V0X3RpbWUoKQogICAgICAgIHRvdGFsX3RpbWUgPSBzZWxmLmVuZF90aW1lIC0gc2VsZi5zdGFydF90aW1lCgogICAgICAgICMgU2tpcCB0aW1pbmcgb24gQ0kgZHVlIHRvIGZsYWtpbmVzcy4KICAgICAgICBpZiBUUkFWSVNfQ0kgb3IgQVBQVkVZT1I6CiAgICAgICAgICAgIHJldHVybgoKICAgICAgICBpZiBzZWxmLmxvd2VyIGlzIG5vdCBOb25lOgogICAgICAgICAgICBzZWxmLnRlc3RjYXNlLmFzc2VydEdyZWF0ZXJFcXVhbCh0b3RhbF90aW1lLCBzZWxmLmxvd2VyICogKDEuMCAtIFRPTEVSQU5DRSkpCiAgICAgICAgaWYgc2VsZi51cHBlciBpcyBub3QgTm9uZToKICAgICAgICAgICAgc2VsZi50ZXN0Y2FzZS5hc3NlcnRMZXNzRXF1YWwodG90YWxfdGltZSwgc2VsZi51cHBlciAqICgxLjAgKyBUT0xFUkFOQ0UpKQoKCmNsYXNzIFRpbWVyTWl4aW4ob2JqZWN0KToKICAgIGRlZiBhc3NlcnRUYWtlc1RpbWUoc2VsZiwgbG93ZXI9Tm9uZSwgdXBwZXI9Tm9uZSk6CiAgICAgICAgcmV0dXJuIFRpbWVyQ29udGV4dChzZWxmLCBsb3dlcj1sb3dlciwgdXBwZXI9dXBwZXIpCgoKQHNraXBVbmxlc3NIYXNTZWxlY3RvcgpjbGFzcyBCYXNlU2VsZWN0b3JUZXN0Q2FzZSh1bml0dGVzdC5UZXN0Q2FzZSwgQWxhcm1NaXhpbiwgVGltZXJNaXhpbik6CiAgICAiIiIgSW1wbGVtZW50cyB0aGUgdGVzdHMgdGhhdCBlYWNoIHR5cGUgb2Ygc2VsZWN0b3IgbXVzdCBwYXNzLiAiIiIKCiAgICBkZWYgbWFrZV9zb2NrZXRwYWlyKHNlbGYpOgogICAgICAgIHJkLCB3ciA9IHNvY2tldHBhaXIoKQoKICAgICAgICAjIE1ha2Ugbm9uLWJsb2NraW5nIHNvIHdlIGdldCBlcnJvcnMgaWYgdGhlCiAgICAgICAgIyBzb2NrZXRzIGFyZSBpbnRlcmFjdGVkIHdpdGggYnV0IG5vdCByZWFkeS4KICAgICAgICByZC5zZXR0aW1lb3V0KDAuMCkKICAgICAgICB3ci5zZXR0aW1lb3V0KDAuMCkKCiAgICAgICAgc2VsZi5hZGRDbGVhbnVwKHJkLmNsb3NlKQogICAgICAgIHNlbGYuYWRkQ2xlYW51cCh3ci5jbG9zZSkKICAgICAgICByZXR1cm4gcmQsIHdyCgogICAgZGVmIG1ha2Vfc2VsZWN0b3Ioc2VsZik6CiAgICAgICAgcyA9IHNlbGVjdG9ycy5EZWZhdWx0U2VsZWN0b3IoKQogICAgICAgIHNlbGYuYWRkQ2xlYW51cChzLmNsb3NlKQogICAgICAgIHJldHVybiBzCgogICAgZGVmIHN0YW5kYXJkX3NldHVwKHNlbGYpOgogICAgICAgIHMgPSBzZWxmLm1ha2Vfc2VsZWN0b3IoKQogICAgICAgIHJkLCB3ciA9IHNlbGYubWFrZV9zb2NrZXRwYWlyKCkKICAgICAgICBzLnJlZ2lzdGVyKHJkLCBzZWxlY3RvcnMuRVZFTlRfUkVBRCkKICAgICAgICBzLnJlZ2lzdGVyKHdyLCBzZWxlY3RvcnMuRVZFTlRfV1JJVEUpCiAgICAgICAgcmV0dXJuIHMsIHJkLCB3cgoKICAgIGRlZiB0ZXN0X2dldF9rZXkoc2VsZik6CiAgICAgICAgcyA9IHNlbGYubWFrZV9zZWxlY3RvcigpCiAgICAgICAgcmQsIHdyID0gc2VsZi5tYWtlX3NvY2tldHBhaXIoKQoKICAgICAgICBrZXkgPSBzLnJlZ2lzdGVyKHJkLCBzZWxlY3RvcnMuRVZFTlRfUkVBRCwgImRhdGEiKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoa2V5LCBzLmdldF9rZXkocmQpKQoKICAgICAgICAjIFVua25vd24gZmlsZW9iagogICAgICAgIHNlbGYuYXNzZXJ0UmFpc2VzKEtleUVycm9yLCBzLmdldF9rZXksIDk5OTk5OSkKCiAgICBkZWYgdGVzdF9nZXRfbWFwKHNlbGYpOgogICAgICAgIHMgPSBzZWxmLm1ha2Vfc2VsZWN0b3IoKQogICAgICAgIHJkLCB3ciA9IHNlbGYubWFrZV9zb2NrZXRwYWlyKCkKCiAgICAgICAga2V5cyA9IHMuZ2V0X21hcCgpCiAgICAgICAgc2VsZi5hc3NlcnRGYWxzZShrZXlzKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwobGVuKGtleXMpLCAwKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwobGlzdChrZXlzKSwgW10pCiAgICAgICAga2V5ID0gcy5yZWdpc3RlcihyZCwgc2VsZWN0b3JzLkVWRU5UX1JFQUQsICJkYXRhIikKICAgICAgICBzZWxmLmFzc2VydEluKHJkLCBrZXlzKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoa2V5LCBrZXlzW3JkXSkKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKGxlbihrZXlzKSwgMSkKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKGxpc3Qoa2V5cyksIFtyZC5maWxlbm8oKV0pCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChsaXN0KGtleXMudmFsdWVzKCkpLCBba2V5XSkKCiAgICAgICAgIyBVbmtub3duIGZpbGVvYmoKICAgICAgICBzZWxmLmFzc2VydFJhaXNlcyhLZXlFcnJvciwga2V5cy5fX2dldGl0ZW1fXywgOTk5OTk5KQoKICAgICAgICAjIFJlYWQtb25seSBtYXBwaW5nCiAgICAgICAgd2l0aCBzZWxmLmFzc2VydFJhaXNlcyhUeXBlRXJyb3IpOgogICAgICAgICAgICBkZWwga2V5c1tyZF0KCiAgICAgICAgIyBEb2Vzbid0IGRlZmluZSBfX3NldGl0ZW1fXwogICAgICAgIHdpdGggc2VsZi5hc3NlcnRSYWlzZXMoVHlwZUVycm9yKToKICAgICAgICAgICAga2V5c1tyZF0gPSBrZXkKCiAgICBkZWYgdGVzdF9yZWdpc3RlcihzZWxmKToKICAgICAgICBzID0gc2VsZi5tYWtlX3NlbGVjdG9yKCkKICAgICAgICByZCwgd3IgPSBzZWxmLm1ha2Vfc29ja2V0cGFpcigpCgogICAgICAgICMgRW5zdXJlIHRoYXQgdGhlIGZpbGUgaXMgbm90IHlldCBhZGRlZC4KICAgICAgICBzZWxmLmFzc2VydEVxdWFsKDAsIGxlbihzLmdldF9tYXAoKSkpCiAgICAgICAgc2VsZi5hc3NlcnRSYWlzZXMoS2V5RXJyb3IsIGxhbWJkYTogcy5nZXRfbWFwKClbcmQuZmlsZW5vKCldKQogICAgICAgIHNlbGYuYXNzZXJ0UmFpc2VzKEtleUVycm9yLCBzLmdldF9rZXksIHJkKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoTm9uZSwgcy5fa2V5X2Zyb21fZmQocmQuZmlsZW5vKCkpKQoKICAgICAgICBkYXRhID0gb2JqZWN0KCkKICAgICAgICBrZXkgPSBzLnJlZ2lzdGVyKHJkLCBzZWxlY3RvcnMuRVZFTlRfUkVBRCwgZGF0YSkKICAgICAgICBzZWxmLmFzc2VydElzSW5zdGFuY2Uoa2V5LCBzZWxlY3RvcnMuU2VsZWN0b3JLZXkpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChrZXkuZmlsZW9iaiwgcmQpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChrZXkuZmQsIHJkLmZpbGVubygpKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoa2V5LmV2ZW50cywgc2VsZWN0b3JzLkVWRU5UX1JFQUQpCiAgICAgICAgc2VsZi5hc3NlcnRJcyhrZXkuZGF0YSwgZGF0YSkKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKDEsIGxlbihzLmdldF9tYXAoKSkpCiAgICAgICAgZm9yIGZkIGluIHMuZ2V0X21hcCgpOgogICAgICAgICAgICBzZWxmLmFzc2VydEVxdWFsKGZkLCByZC5maWxlbm8oKSkKCiAgICBkZWYgdGVzdF9yZWdpc3Rlcl9iYWRfZXZlbnQoc2VsZik6CiAgICAgICAgcyA9IHNlbGYubWFrZV9zZWxlY3RvcigpCiAgICAgICAgcmQsIHdyID0gc2VsZi5tYWtlX3NvY2tldHBhaXIoKQoKICAgICAgICBzZWxmLmFzc2VydFJhaXNlcyhWYWx1ZUVycm9yLCBzLnJlZ2lzdGVyLCByZCwgOTk5OTkpCgogICAgZGVmIHRlc3RfcmVnaXN0ZXJfbmVnYXRpdmVfZmQoc2VsZik6CiAgICAgICAgcyA9IHNlbGYubWFrZV9zZWxlY3RvcigpCiAgICAgICAgc2VsZi5hc3NlcnRSYWlzZXMoVmFsdWVFcnJvciwgcy5yZWdpc3RlciwgLTEsIHNlbGVjdG9ycy5FVkVOVF9SRUFEKQoKICAgIGRlZiB0ZXN0X3JlZ2lzdGVyX2ludmFsaWRfZmlsZW9iaihzZWxmKToKICAgICAgICBzID0gc2VsZi5tYWtlX3NlbGVjdG9yKCkKICAgICAgICBzZWxmLmFzc2VydFJhaXNlcyhWYWx1ZUVycm9yLCBzLnJlZ2lzdGVyLCAic3RyaW5nIiwgc2VsZWN0b3JzLkVWRU5UX1JFQUQpCgogICAgZGVmIHRlc3RfcmVyZWdpc3Rlcl9mZF9zYW1lX2ZpbGVvYmooc2VsZik6CiAgICAgICAgcywgcmQsIHdyID0gc2VsZi5zdGFuZGFyZF9zZXR1cCgpCiAgICAgICAgc2VsZi5hc3NlcnRSYWlzZXMoS2V5RXJyb3IsIHMucmVnaXN0ZXIsIHJkLCBzZWxlY3RvcnMuRVZFTlRfUkVBRCkKCiAgICBkZWYgdGVzdF9yZXJlZ2lzdGVyX2ZkX2RpZmZlcmVudF9maWxlb2JqKHNlbGYpOgogICAgICAgIHMsIHJkLCB3ciA9IHNlbGYuc3RhbmRhcmRfc2V0dXAoKQogICAgICAgIHNlbGYuYXNzZXJ0UmFpc2VzKEtleUVycm9yLCBzLnJlZ2lzdGVyLCByZC5maWxlbm8oKSwgc2VsZWN0b3JzLkVWRU5UX1JFQUQpCgogICAgZGVmIHRlc3RfY29udGV4dF9tYW5hZ2VyKHNlbGYpOgogICAgICAgIHMgPSBzZWxmLm1ha2Vfc2VsZWN0b3IoKQogICAgICAgIHJkLCB3ciA9IHNlbGYubWFrZV9zb2NrZXRwYWlyKCkKCiAgICAgICAgd2l0aCBzIGFzIHNlbDoKICAgICAgICAgICAgcmRfa2V5ID0gc2VsLnJlZ2lzdGVyKHJkLCBzZWxlY3RvcnMuRVZFTlRfUkVBRCkKICAgICAgICAgICAgd3Jfa2V5ID0gc2VsLnJlZ2lzdGVyKHdyLCBzZWxlY3RvcnMuRVZFTlRfV1JJVEUpCiAgICAgICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwocmRfa2V5LCBzZWwuZ2V0X2tleShyZCkpCiAgICAgICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwod3Jfa2V5LCBzZWwuZ2V0X2tleSh3cikpCgogICAgICAgIHNlbGYuYXNzZXJ0UmFpc2VzKFJ1bnRpbWVFcnJvciwgcy5nZXRfa2V5LCByZCkKICAgICAgICBzZWxmLmFzc2VydFJhaXNlcyhSdW50aW1lRXJyb3IsIHMuZ2V0X2tleSwgd3IpCgogICAgZGVmIHRlc3RfdW5yZWdpc3RlcihzZWxmKToKICAgICAgICBzLCByZCwgd3IgPSBzZWxmLnN0YW5kYXJkX3NldHVwKCkKICAgICAgICBzLnVucmVnaXN0ZXIocmQpCgogICAgICAgIHNlbGYuYXNzZXJ0UmFpc2VzKEtleUVycm9yLCBzLnVucmVnaXN0ZXIsIDk5OTk5KQoKICAgIGRlZiB0ZXN0X3JldW5yZWdpc3RlcihzZWxmKToKICAgICAgICBzLCByZCwgd3IgPSBzZWxmLnN0YW5kYXJkX3NldHVwKCkKICAgICAgICBzLnVucmVnaXN0ZXIocmQpCgogICAgICAgIHNlbGYuYXNzZXJ0UmFpc2VzKEtleUVycm9yLCBzLnVucmVnaXN0ZXIsIHJkKQoKICAgIGRlZiB0ZXN0X3VucmVnaXN0ZXJfYWZ0ZXJfZmRfY2xvc2Uoc2VsZik6CiAgICAgICAgcyA9IHNlbGYubWFrZV9zZWxlY3RvcigpCiAgICAgICAgcmQsIHdyID0gc2VsZi5tYWtlX3NvY2tldHBhaXIoKQogICAgICAgIHJkZmQgPSByZC5maWxlbm8oKQogICAgICAgIHdyZmQgPSB3ci5maWxlbm8oKQogICAgICAgIHMucmVnaXN0ZXIocmRmZCwgc2VsZWN0b3JzLkVWRU5UX1JFQUQpCiAgICAgICAgcy5yZWdpc3Rlcih3cmZkLCBzZWxlY3RvcnMuRVZFTlRfV1JJVEUpCgogICAgICAgIHJkLmNsb3NlKCkKICAgICAgICB3ci5jbG9zZSgpCgogICAgICAgIHMudW5yZWdpc3RlcihyZGZkKQogICAgICAgIHMudW5yZWdpc3Rlcih3cmZkKQoKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKDAsIGxlbihzLmdldF9tYXAoKSkpCgogICAgZGVmIHRlc3RfdW5yZWdpc3Rlcl9hZnRlcl9maWxlb2JqX2Nsb3NlKHNlbGYpOgogICAgICAgIHMgPSBzZWxmLm1ha2Vfc2VsZWN0b3IoKQogICAgICAgIHJkLCB3ciA9IHNlbGYubWFrZV9zb2NrZXRwYWlyKCkKICAgICAgICBzLnJlZ2lzdGVyKHJkLCBzZWxlY3RvcnMuRVZFTlRfUkVBRCkKICAgICAgICBzLnJlZ2lzdGVyKHdyLCBzZWxlY3RvcnMuRVZFTlRfV1JJVEUpCgogICAgICAgIHJkLmNsb3NlKCkKICAgICAgICB3ci5jbG9zZSgpCgogICAgICAgIHMudW5yZWdpc3RlcihyZCkKICAgICAgICBzLnVucmVnaXN0ZXIod3IpCgogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoMCwgbGVuKHMuZ2V0X21hcCgpKSkKCiAgICBAc2tpcFVubGVzcyhvcy5uYW1lID09ICJwb3NpeCIsICJQbGF0Zm9ybSBkb2Vzbid0IHN1cHBvcnQgb3MuZHVwMiIpCiAgICBkZWYgdGVzdF91bnJlZ2lzdGVyX2FmdGVyX3JldXNlX2ZkKHNlbGYpOgogICAgICAgIHMsIHJkLCB3ciA9IHNlbGYuc3RhbmRhcmRfc2V0dXAoKQogICAgICAgIHJkZmQgPSByZC5maWxlbm8oKQogICAgICAgIHdyZmQgPSB3ci5maWxlbm8oKQoKICAgICAgICByZDIsIHdyMiA9IHNlbGYubWFrZV9zb2NrZXRwYWlyKCkKICAgICAgICByZC5jbG9zZSgpCiAgICAgICAgd3IuY2xvc2UoKQogICAgICAgIG9zLmR1cDIocmQyLmZpbGVubygpLCByZGZkKQogICAgICAgIG9zLmR1cDIod3IyLmZpbGVubygpLCB3cmZkKQoKICAgICAgICBzLnVucmVnaXN0ZXIocmRmZCkKICAgICAgICBzLnVucmVnaXN0ZXIod3JmZCkKCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbCgwLCBsZW4ocy5nZXRfbWFwKCkpKQoKICAgIGRlZiB0ZXN0X21vZGlmeShzZWxmKToKICAgICAgICBzID0gc2VsZi5tYWtlX3NlbGVjdG9yKCkKICAgICAgICByZCwgd3IgPSBzZWxmLm1ha2Vfc29ja2V0cGFpcigpCgogICAgICAgIGtleSA9IHMucmVnaXN0ZXIocmQsIHNlbGVjdG9ycy5FVkVOVF9SRUFEKQoKICAgICAgICAjIE1vZGlmeSBldmVudHMKICAgICAgICBrZXkyID0gcy5tb2RpZnkocmQsIHNlbGVjdG9ycy5FVkVOVF9XUklURSkKICAgICAgICBzZWxmLmFzc2VydE5vdEVxdWFsKGtleS5ldmVudHMsIGtleTIuZXZlbnRzKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoa2V5Miwgcy5nZXRfa2V5KHJkKSkKCiAgICAgICAgcy51bnJlZ2lzdGVyKHJkKQoKICAgICAgICAjIE1vZGlmeSBkYXRhCiAgICAgICAgZDEgPSBvYmplY3QoKQogICAgICAgIGQyID0gb2JqZWN0KCkKCiAgICAgICAga2V5ID0gcy5yZWdpc3RlcihyZCwgc2VsZWN0b3JzLkVWRU5UX1JFQUQsIGQxKQogICAgICAgIGtleTIgPSBzLm1vZGlmeShyZCwgc2VsZWN0b3JzLkVWRU5UX1JFQUQsIGQyKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoa2V5LmV2ZW50cywga2V5Mi5ldmVudHMpCiAgICAgICAgc2VsZi5hc3NlcnRJc05vdChrZXkuZGF0YSwga2V5Mi5kYXRhKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoa2V5Miwgcy5nZXRfa2V5KHJkKSkKICAgICAgICBzZWxmLmFzc2VydElzKGtleTIuZGF0YSwgZDIpCgogICAgICAgICMgTW9kaWZ5IGludmFsaWQgZmlsZW9iagogICAgICAgIHNlbGYuYXNzZXJ0UmFpc2VzKEtleUVycm9yLCBzLm1vZGlmeSwgOTk5OTk5LCBzZWxlY3RvcnMuRVZFTlRfUkVBRCkKCiAgICBkZWYgdGVzdF9lbXB0eV9zZWxlY3Qoc2VsZik6CiAgICAgICAgcyA9IHNlbGYubWFrZV9zZWxlY3RvcigpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChbXSwgcy5zZWxlY3QodGltZW91dD1TSE9SVF9TRUxFQ1QpKQoKICAgIGRlZiB0ZXN0X3NlbGVjdF9tdWx0aXBsZV9ldmVudF90eXBlcyhzZWxmKToKICAgICAgICBzID0gc2VsZi5tYWtlX3NlbGVjdG9yKCkKCiAgICAgICAgcmQsIHdyID0gc2VsZi5tYWtlX3NvY2tldHBhaXIoKQogICAgICAgIGtleSA9IHMucmVnaXN0ZXIocmQsIHNlbGVjdG9ycy5FVkVOVF9SRUFEIHwgc2VsZWN0b3JzLkVWRU5UX1dSSVRFKQoKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKFsoa2V5LCBzZWxlY3RvcnMuRVZFTlRfV1JJVEUpXSwgcy5zZWxlY3QoMC4wMDEpKQoKICAgICAgICB3ci5zZW5kKGIneCcpCiAgICAgICAgdGltZS5zbGVlcCgwLjAxKSAgIyBXYWl0IGZvciB0aGUgd3JpdGUgdG8gZmx1c2guCgogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoWyhrZXksIHNlbGVjdG9ycy5FVkVOVF9SRUFEIHwgc2VsZWN0b3JzLkVWRU5UX1dSSVRFKV0sIHMuc2VsZWN0KDAuMDAxKSkKCiAgICBkZWYgdGVzdF9zZWxlY3RfbXVsdGlwbGVfc2VsZWN0b3JzKHNlbGYpOgogICAgICAgIHMxID0gc2VsZi5tYWtlX3NlbGVjdG9yKCkKICAgICAgICBzMiA9IHNlbGYubWFrZV9zZWxlY3RvcigpCiAgICAgICAgcmQsIHdyID0gc2VsZi5tYWtlX3NvY2tldHBhaXIoKQogICAgICAgIGtleTEgPSBzMS5yZWdpc3RlcihyZCwgc2VsZWN0b3JzLkVWRU5UX1JFQUQpCiAgICAgICAga2V5MiA9IHMyLnJlZ2lzdGVyKHJkLCBzZWxlY3RvcnMuRVZFTlRfUkVBRCkKCiAgICAgICAgd3Iuc2VuZChiJ3gnKQogICAgICAgIHRpbWUuc2xlZXAoMC4wMSkgICMgV2FpdCBmb3IgdGhlIHdyaXRlIHRvIGZsdXNoLgoKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKFsoa2V5MSwgc2VsZWN0b3JzLkVWRU5UX1JFQUQpXSwgczEuc2VsZWN0KHRpbWVvdXQ9MC4wMDEpKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoWyhrZXkyLCBzZWxlY3RvcnMuRVZFTlRfUkVBRCldLCBzMi5zZWxlY3QodGltZW91dD0wLjAwMSkpCgogICAgZGVmIHRlc3Rfc2VsZWN0X25vX2V2ZW50X3R5cGVzKHNlbGYpOgogICAgICAgIHMgPSBzZWxmLm1ha2Vfc2VsZWN0b3IoKQogICAgICAgIHJkLCB3ciA9IHNlbGYubWFrZV9zb2NrZXRwYWlyKCkKICAgICAgICBzZWxmLmFzc2VydFJhaXNlcyhWYWx1ZUVycm9yLCBzLnJlZ2lzdGVyLCByZCwgMCkKCiAgICBkZWYgdGVzdF9zZWxlY3RfbWFueV9ldmVudHMoc2VsZik6CiAgICAgICAgcyA9IHNlbGYubWFrZV9zZWxlY3RvcigpCiAgICAgICAgcmVhZGVycyA9IFtdCiAgICAgICAgd3JpdGVycyA9IFtdCiAgICAgICAgZm9yIF8gaW4gcmFuZ2UoMzIpOgogICAgICAgICAgICByZCwgd3IgPSBzZWxmLm1ha2Vfc29ja2V0cGFpcigpCiAgICAgICAgICAgIHJlYWRlcnMuYXBwZW5kKHJkKQogICAgICAgICAgICB3cml0ZXJzLmFwcGVuZCh3cikKICAgICAgICAgICAgcy5yZWdpc3RlcihyZCwgc2VsZWN0b3JzLkVWRU5UX1JFQUQpCgogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoMCwgbGVuKHMuc2VsZWN0KDAuMDAxKSkpCgogICAgICAgICMgV3JpdGUgYSBieXRlIHRvIGVhY2ggZW5kLgogICAgICAgIGZvciB3ciBpbiB3cml0ZXJzOgogICAgICAgICAgICB3ci5zZW5kKGIneCcpCgogICAgICAgICMgR2l2ZSB0aW1lIHRvIGZsdXNoIHRoZSB3cml0ZXMuCiAgICAgICAgdGltZS5zbGVlcCgwLjAxKQoKICAgICAgICByZWFkeSA9IHMuc2VsZWN0KDAuMDAxKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoMzIsIGxlbihyZWFkeSkpCiAgICAgICAgZm9yIGtleSwgZXZlbnRzIGluIHJlYWR5OgogICAgICAgICAgICBzZWxmLmFzc2VydEVxdWFsKHNlbGVjdG9ycy5FVkVOVF9SRUFELCBldmVudHMpCiAgICAgICAgICAgIHNlbGYuYXNzZXJ0SW4oa2V5LmZpbGVvYmosIHJlYWRlcnMpCgogICAgICAgICMgTm93IHJlYWQgdGhlIGJ5dGUgZnJvbSBlYWNoIGVuZHBvaW50LgogICAgICAgIGZvciByZCBpbiByZWFkZXJzOgogICAgICAgICAgICBkYXRhID0gcmQucmVjdigxKQogICAgICAgICAgICBzZWxmLmFzc2VydEVxdWFsKGIneCcsIGRhdGEpCgogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoMCwgbGVuKHMuc2VsZWN0KDAuMDAxKSkpCgogICAgZGVmIHRlc3Rfc2VsZWN0X3RpbWVvdXRfbm9uZShzZWxmKToKICAgICAgICBzID0gc2VsZi5tYWtlX3NlbGVjdG9yKCkKICAgICAgICByZCwgd3IgPSBzZWxmLm1ha2Vfc29ja2V0cGFpcigpCiAgICAgICAgcy5yZWdpc3Rlcih3ciwgc2VsZWN0b3JzLkVWRU5UX1dSSVRFKQoKICAgICAgICB3aXRoIHNlbGYuYXNzZXJ0VGFrZXNUaW1lKHVwcGVyPVNIT1JUX1NFTEVDVCk6CiAgICAgICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoMSwgbGVuKHMuc2VsZWN0KHRpbWVvdXQ9Tm9uZSkpKQoKICAgIGRlZiB0ZXN0X3NlbGVjdF90aW1lb3V0X3JlYWR5KHNlbGYpOgogICAgICAgIHMsIHJkLCB3ciA9IHNlbGYuc3RhbmRhcmRfc2V0dXAoKQoKICAgICAgICB3aXRoIHNlbGYuYXNzZXJ0VGFrZXNUaW1lKHVwcGVyPVNIT1JUX1NFTEVDVCk6CiAgICAgICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoMSwgbGVuKHMuc2VsZWN0KHRpbWVvdXQ9MCkpKQogICAgICAgICAgICBzZWxmLmFzc2VydEVxdWFsKDEsIGxlbihzLnNlbGVjdCh0aW1lb3V0PS0xKSkpCiAgICAgICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoMSwgbGVuKHMuc2VsZWN0KHRpbWVvdXQ9MC4wMDEpKSkKCiAgICBkZWYgdGVzdF9zZWxlY3RfdGltZW91dF9ub3RfcmVhZHkoc2VsZik6CiAgICAgICAgcyA9IHNlbGYubWFrZV9zZWxlY3RvcigpCiAgICAgICAgcmQsIHdyID0gc2VsZi5tYWtlX3NvY2tldHBhaXIoKQogICAgICAgIHMucmVnaXN0ZXIocmQsIHNlbGVjdG9ycy5FVkVOVF9SRUFEKQoKICAgICAgICB3aXRoIHNlbGYuYXNzZXJ0VGFrZXNUaW1lKHVwcGVyPVNIT1JUX1NFTEVDVCk6CiAgICAgICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoMCwgbGVuKHMuc2VsZWN0KHRpbWVvdXQ9MCkpKQoKICAgICAgICB3aXRoIHNlbGYuYXNzZXJ0VGFrZXNUaW1lKGxvd2VyPVNIT1JUX1NFTEVDVCwgdXBwZXI9U0hPUlRfU0VMRUNUKToKICAgICAgICAgICAgc2VsZi5hc3NlcnRFcXVhbCgwLCBsZW4ocy5zZWxlY3QodGltZW91dD1TSE9SVF9TRUxFQ1QpKSkKCiAgICBAc2tpcFVubGVzc0hhc0FsYXJtCiAgICBkZWYgdGVzdF9zZWxlY3RfdGltaW5nKHNlbGYpOgogICAgICAgIHMgPSBzZWxmLm1ha2Vfc2VsZWN0b3IoKQogICAgICAgIHJkLCB3ciA9IHNlbGYubWFrZV9zb2NrZXRwYWlyKCkKICAgICAgICBrZXkgPSBzLnJlZ2lzdGVyKHJkLCBzZWxlY3RvcnMuRVZFTlRfUkVBRCkKCiAgICAgICAgc2VsZi5zZXRfYWxhcm0oU0hPUlRfU0VMRUNULCBsYW1iZGEgKmFyZ3M6IHdyLnNlbmQoYid4JykpCgogICAgICAgIHdpdGggc2VsZi5hc3NlcnRUYWtlc1RpbWUodXBwZXI9U0hPUlRfU0VMRUNUKToKICAgICAgICAgICAgcmVhZHkgPSBzLnNlbGVjdChMT05HX1NFTEVDVCkKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKFsoa2V5LCBzZWxlY3RvcnMuRVZFTlRfUkVBRCldLCByZWFkeSkKCiAgICBAc2tpcFVubGVzc0hhc0FsYXJtCiAgICBkZWYgdGVzdF9zZWxlY3RfaW50ZXJydXB0X25vX2V2ZW50KHNlbGYpOgogICAgICAgIHMgPSBzZWxmLm1ha2Vfc2VsZWN0b3IoKQogICAgICAgIHJkLCB3ciA9IHNlbGYubWFrZV9zb2NrZXRwYWlyKCkKICAgICAgICBzLnJlZ2lzdGVyKHJkLCBzZWxlY3RvcnMuRVZFTlRfUkVBRCkKCiAgICAgICAgc2VsZi5zZXRfYWxhcm0oU0hPUlRfU0VMRUNULCBsYW1iZGEgKmFyZ3M6IE5vbmUpCgogICAgICAgIHdpdGggc2VsZi5hc3NlcnRUYWtlc1RpbWUobG93ZXI9TE9OR19TRUxFQ1QsIHVwcGVyPUxPTkdfU0VMRUNUKToKICAgICAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChbXSwgcy5zZWxlY3QoTE9OR19TRUxFQ1QpKQoKICAgIEBza2lwVW5sZXNzSGFzQWxhcm0KICAgIGRlZiB0ZXN0X3NlbGVjdF9pbnRlcnJ1cHRfd2l0aF9ldmVudChzZWxmKToKICAgICAgICBzID0gc2VsZi5tYWtlX3NlbGVjdG9yKCkKICAgICAgICByZCwgd3IgPSBzZWxmLm1ha2Vfc29ja2V0cGFpcigpCiAgICAgICAgcy5yZWdpc3RlcihyZCwgc2VsZWN0b3JzLkVWRU5UX1JFQUQpCiAgICAgICAga2V5ID0gcy5nZXRfa2V5KHJkKQoKICAgICAgICBzZWxmLnNldF9hbGFybShTSE9SVF9TRUxFQ1QsIGxhbWJkYSAqYXJnczogd3Iuc2VuZChiJ3gnKSkKCiAgICAgICAgd2l0aCBzZWxmLmFzc2VydFRha2VzVGltZShsb3dlcj1TSE9SVF9TRUxFQ1QsIHVwcGVyPVNIT1JUX1NFTEVDVCk6CiAgICAgICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoWyhrZXksIHNlbGVjdG9ycy5FVkVOVF9SRUFEKV0sIHMuc2VsZWN0KExPTkdfU0VMRUNUKSkKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKHJkLnJlY3YoMSksIGIneCcpCgogICAgQHNraXBVbmxlc3NIYXNBbGFybQogICAgZGVmIHRlc3Rfc2VsZWN0X211bHRpcGxlX2ludGVycnVwdHNfd2l0aF9ldmVudChzZWxmKToKICAgICAgICBzID0gc2VsZi5tYWtlX3NlbGVjdG9yKCkKICAgICAgICByZCwgd3IgPSBzZWxmLm1ha2Vfc29ja2V0cGFpcigpCiAgICAgICAgcy5yZWdpc3RlcihyZCwgc2VsZWN0b3JzLkVWRU5UX1JFQUQpCiAgICAgICAga2V5ID0gcy5nZXRfa2V5KHJkKQoKICAgICAgICBkZWYgc2Vjb25kX2FsYXJtKCphcmdzKToKICAgICAgICAgICAgd3Iuc2VuZChiJ3gnKQoKICAgICAgICBkZWYgZmlyc3RfYWxhcm0oKmFyZ3MpOgogICAgICAgICAgICBzZWxmLl9iZWdpbl9hbGFybV90aHJlYWQoU0hPUlRfU0VMRUNUKQogICAgICAgICAgICBzaWduYWwuc2lnbmFsKHNpZ25hbC5TSUdBTFJNLCBzZWNvbmRfYWxhcm0pCgogICAgICAgIHNlbGYuc2V0X2FsYXJtKFNIT1JUX1NFTEVDVCwgZmlyc3RfYWxhcm0pCgogICAgICAgIHdpdGggc2VsZi5hc3NlcnRUYWtlc1RpbWUobG93ZXI9U0hPUlRfU0VMRUNUICogMiwgdXBwZXI9U0hPUlRfU0VMRUNUICogMik6CiAgICAgICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoWyhrZXksIHNlbGVjdG9ycy5FVkVOVF9SRUFEKV0sIHMuc2VsZWN0KExPTkdfU0VMRUNUKSkKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKHJkLnJlY3YoMSksIGIneCcpCgogICAgQHNraXBVbmxlc3NIYXNBbGFybQogICAgZGVmIHRlc3Rfc2VsZWN0b3JfZXJyb3Ioc2VsZik6CiAgICAgICAgcyA9IHNlbGYubWFrZV9zZWxlY3RvcigpCiAgICAgICAgcmQsIHdyID0gc2VsZi5tYWtlX3NvY2tldHBhaXIoKQogICAgICAgIHMucmVnaXN0ZXIocmQsIHNlbGVjdG9ycy5FVkVOVF9SRUFEKQoKICAgICAgICBkZWYgYWxhcm1fZXhjZXB0aW9uKCphcmdzKToKICAgICAgICAgICAgZXJyID0gT1NFcnJvcigpCiAgICAgICAgICAgIGVyci5lcnJubyA9IGVycm5vLkVBQ0NFUwogICAgICAgICAgICByYWlzZSBlcnIKCiAgICAgICAgc2VsZi5zZXRfYWxhcm0oU0hPUlRfU0VMRUNULCBhbGFybV9leGNlcHRpb24pCgogICAgICAgIHRyeToKICAgICAgICAgICAgcy5zZWxlY3QoTE9OR19TRUxFQ1QpCiAgICAgICAgZXhjZXB0IHNlbGVjdG9ycy5TZWxlY3RvckVycm9yIGFzIGU6CiAgICAgICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoZS5lcnJubywgZXJybm8uRUFDQ0VTKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgc2VsZi5mYWlsKCJSYWlzZWQgaW5jb3JyZWN0IGV4Y2VwdGlvbjogIiArIHN0cihlKSkKICAgICAgICBlbHNlOgogICAgICAgICAgICBzZWxmLmZhaWwoInNlbGVjdCgpIGRpZG4ndCByYWlzZSBTZWxlY3RvckVycm9yIikKCiAgICAjIFRlc3QgZW5zdXJlcyB0aGF0IF9zeXNjYWxsX3dyYXBwZXIgcHJvcGVybHkgcmFpc2VzIHRoZQogICAgIyBleGNlcHRpb24gdGhhdCBpcyByYWlzZWQgZnJvbSBhbiBpbnRlcnJ1cHQgaGFuZGxlci4KICAgIEBza2lwVW5sZXNzSGFzQWxhcm0KICAgIGRlZiB0ZXN0X3NlbGVjdF9pbnRlcnJ1cHRfZXhjZXB0aW9uKHNlbGYpOgogICAgICAgIHMgPSBzZWxmLm1ha2Vfc2VsZWN0b3IoKQogICAgICAgIHJkLCB3ciA9IHNlbGYubWFrZV9zb2NrZXRwYWlyKCkKICAgICAgICBzLnJlZ2lzdGVyKHJkLCBzZWxlY3RvcnMuRVZFTlRfUkVBRCkKCiAgICAgICAgY2xhc3MgQWxhcm1JbnRlcnJ1cHQoRXhjZXB0aW9uKToKICAgICAgICAgICAgcGFzcwoKICAgICAgICBkZWYgYWxhcm1fZXhjZXB0aW9uKCphcmdzKToKICAgICAgICAgICAgcmFpc2UgQWxhcm1JbnRlcnJ1cHQoKQoKICAgICAgICBzZWxmLnNldF9hbGFybShTSE9SVF9TRUxFQ1QsIGFsYXJtX2V4Y2VwdGlvbikKCiAgICAgICAgd2l0aCBzZWxmLmFzc2VydFRha2VzVGltZShsb3dlcj1TSE9SVF9TRUxFQ1QsIHVwcGVyPVNIT1JUX1NFTEVDVCk6CiAgICAgICAgICAgIHNlbGYuYXNzZXJ0UmFpc2VzKEFsYXJtSW50ZXJydXB0LCBzLnNlbGVjdCwgTE9OR19TRUxFQ1QpCgogICAgZGVmIHRlc3RfZmlsZW5vKHNlbGYpOgogICAgICAgIHMgPSBzZWxmLm1ha2Vfc2VsZWN0b3IoKQogICAgICAgIGlmIGhhc2F0dHIocywgImZpbGVubyIpOgogICAgICAgICAgICBmZCA9IHMuZmlsZW5vKCkKICAgICAgICAgICAgc2VsZi5hc3NlcnRUcnVlKGlzaW5zdGFuY2UoZmQsIGludCkpCiAgICAgICAgICAgIHNlbGYuYXNzZXJ0R3JlYXRlckVxdWFsKGZkLCAwKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHNlbGYuc2tpcFRlc3QoIlNlbGVjdG9yIGRvZXNuJ3QgaW1wbGVtZW50IGZpbGVubygpIikKCiAgICAjIEFjY29yZGluZyB0byB0aGUgcHN1dGlsIGRvY3MsIG9wZW5fZmlsZXMoKSBoYXMgc3RyYW5nZSBiZWhhdmlvcgogICAgIyBvbiBXaW5kb3dzIGluY2x1ZGluZyBnaXZpbmcgYmFjayBpbmNvcnJlY3QgcmVzdWx0cyBzbyB0bwogICAgIyBzdG9wIHJhbmRvbSBmYWlsdXJlcyBmcm9tIG9jY3VycmluZyB3ZSdyZSBza2lwcGluZyBvbiBXaW5kb3dzLgogICAgQHNraXBJZihzeXMucGxhdGZvcm0gPT0gIndpbjMyIiwgInBzdXRpbC5Qcm9jZXNzLm9wZW5fZmlsZXMoKSBpcyB1bnN0YWJsZSBvbiBXaW5kb3dzLiIpCiAgICBkZWYgdGVzdF9sZWFraW5nX2ZkcyhzZWxmKToKICAgICAgICBwcm9jID0gcHN1dGlsLlByb2Nlc3MoKQogICAgICAgIGJlZm9yZV9mZHMgPSBsZW4ocHJvYy5vcGVuX2ZpbGVzKCkpCiAgICAgICAgcyA9IHNlbGYubWFrZV9zZWxlY3RvcigpCiAgICAgICAgcy5jbG9zZSgpCiAgICAgICAgYWZ0ZXJfZmRzID0gbGVuKHByb2Mub3Blbl9maWxlcygpKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoYmVmb3JlX2ZkcywgYWZ0ZXJfZmRzKQoKICAgIGRlZiB0ZXN0X3NlbGVjdG9yX2Vycm9yX2V4Y2VwdGlvbihzZWxmKToKICAgICAgICBlcnIgPSBzZWxlY3RvcnMuU2VsZWN0b3JFcnJvcigxKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoZXJyLl9fcmVwcl9fKCksICI8U2VsZWN0b3JFcnJvciBlcnJubz0xPiIpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChlcnIuX19zdHJfXygpLCAiPFNlbGVjdG9yRXJyb3IgZXJybm89MT4iKQoKCmNsYXNzIEJhc2VXYWl0Rm9yVGVzdENhc2UodW5pdHRlc3QuVGVzdENhc2UsIFRpbWVyTWl4aW4sIEFsYXJtTWl4aW4pOgogICAgZGVmIG1ha2Vfc29ja2V0cGFpcihzZWxmKToKICAgICAgICByZCwgd3IgPSBzb2NrZXRwYWlyKCkKCiAgICAgICAgIyBNYWtlIG5vbi1ibG9ja2luZyBzbyB3ZSBnZXQgZXJyb3JzIGlmIHRoZQogICAgICAgICMgc29ja2V0cyBhcmUgaW50ZXJhY3RlZCB3aXRoIGJ1dCBub3QgcmVhZHkuCiAgICAgICAgcmQuc2V0dGltZW91dCgwLjApCiAgICAgICAgd3Iuc2V0dGltZW91dCgwLjApCgogICAgICAgIHNlbGYuYWRkQ2xlYW51cChyZC5jbG9zZSkKICAgICAgICBzZWxmLmFkZENsZWFudXAod3IuY2xvc2UpCiAgICAgICAgcmV0dXJuIHJkLCB3cgoKICAgIGRlZiB0ZXN0X3dhaXRfZm9yX3JlYWRfc2luZ2xlX3NvY2tldChzZWxmKToKICAgICAgICByZCwgd3IgPSBzZWxmLm1ha2Vfc29ja2V0cGFpcigpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChbXSwgd2FpdC53YWl0X2Zvcl9yZWFkKHJkLCB0aW1lb3V0PVNIT1JUX1NFTEVDVCkpCgogICAgZGVmIHRlc3Rfd2FpdF9mb3JfcmVhZF9tdWx0aXBsZV9zb2NrZXQoc2VsZik6CiAgICAgICAgcmQsIHJkMiA9IHNlbGYubWFrZV9zb2NrZXRwYWlyKCkKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKFtdLCB3YWl0LndhaXRfZm9yX3JlYWQoW3JkLCByZDJdLCB0aW1lb3V0PVNIT1JUX1NFTEVDVCkpCgogICAgZGVmIHRlc3Rfd2FpdF9mb3JfcmVhZF9lbXB0eShzZWxmKToKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKFtdLCB3YWl0LndhaXRfZm9yX3JlYWQoW10sIHRpbWVvdXQ9U0hPUlRfU0VMRUNUKSkKCiAgICBkZWYgdGVzdF93YWl0X2Zvcl93cml0ZV9zaW5nbGVfc29ja2V0KHNlbGYpOgogICAgICAgIHdyLCB3cjIgPSBzZWxmLm1ha2Vfc29ja2V0cGFpcigpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChbd3JdLCB3YWl0LndhaXRfZm9yX3dyaXRlKHdyLCB0aW1lb3V0PVNIT1JUX1NFTEVDVCkpCgogICAgZGVmIHRlc3Rfd2FpdF9mb3Jfd3JpdGVfbXVsdGlwbGVfc29ja2V0KHNlbGYpOgogICAgICAgIHdyLCB3cjIgPSBzZWxmLm1ha2Vfc29ja2V0cGFpcigpCiAgICAgICAgcmVzdWx0ID0gd2FpdC53YWl0X2Zvcl93cml0ZShbd3IsIHdyMl0sIHRpbWVvdXQ9U0hPUlRfU0VMRUNUKQogICAgICAgICMgYXNzZXJ0SXRlbXNFcXVhbCByZW5hbWVkIGluIFB5dGhvbiAzLngKICAgICAgICBpZiBoYXNhdHRyKHNlbGYsICJhc3NlcnRJdGVtc0VxdWFsIik6CiAgICAgICAgICAgIHNlbGYuYXNzZXJ0SXRlbXNFcXVhbChbd3IsIHdyMl0sIHJlc3VsdCkKICAgICAgICBlbHNlOgogICAgICAgICAgICBzZWxmLmFzc2VydENvdW50RXF1YWwoW3dyLCB3cjJdLCByZXN1bHQpCgogICAgZGVmIHRlc3Rfd2FpdF9mb3Jfd3JpdGVfZW1wdHkoc2VsZik6CiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChbXSwgd2FpdC53YWl0X2Zvcl93cml0ZShbXSwgdGltZW91dD1TSE9SVF9TRUxFQ1QpKQoKICAgIGRlZiB0ZXN0X3dhaXRfZm9yX25vbl9saXN0X2l0ZXJhYmxlKHNlbGYpOgogICAgICAgIHJkLCB3ciA9IHNlbGYubWFrZV9zb2NrZXRwYWlyKCkKICAgICAgICBpdGVyYWJsZSA9IHsncmQnOiByZH0udmFsdWVzKCkKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKFtdLCB3YWl0LndhaXRfZm9yX3JlYWQoaXRlcmFibGUsIHRpbWVvdXQ9U0hPUlRfU0VMRUNUKSkKCiAgICBkZWYgdGVzdF93YWl0X3RpbWVvdXQoc2VsZik6CiAgICAgICAgcmQsIHdyID0gc2VsZi5tYWtlX3NvY2tldHBhaXIoKQogICAgICAgIHdpdGggc2VsZi5hc3NlcnRUYWtlc1RpbWUobG93ZXI9U0hPUlRfU0VMRUNULCB1cHBlcj1TSE9SVF9TRUxFQ1QpOgogICAgICAgICAgICB3YWl0LndhaXRfZm9yX3JlYWQoW3JkXSwgdGltZW91dD1TSE9SVF9TRUxFQ1QpCgogICAgZGVmIHRlc3Rfd2FpdF9pb19jbG9zZV9pc19jYWxsZWQoc2VsZik6CiAgICAgICAgc2VsZWN0b3IgPSBzZWxlY3RvcnMuRGVmYXVsdFNlbGVjdG9yKCkKICAgICAgICBzZWxmLmFkZENsZWFudXAoc2VsZWN0b3IuY2xvc2UpCgogICAgICAgIGRlZiBmYWtlX2NvbnN0cnVjdG9yKCk6CiAgICAgICAgICAgIHJldHVybiBzZWxlY3RvcgoKICAgICAgICBvbGRfc2VsZWN0b3IgPSB3YWl0LkRlZmF1bHRTZWxlY3RvcgogICAgICAgIHdhaXQuRGVmYXVsdFNlbGVjdG9yID0gZmFrZV9jb25zdHJ1Y3RvcgogICAgICAgIHNlbGYuYWRkQ2xlYW51cChzZXRhdHRyLCB3YWl0LCAiRGVmYXVsdFNlbGVjdG9yIiwgb2xkX3NlbGVjdG9yKQoKICAgICAgICByZCwgd3IgPSBzZWxmLm1ha2Vfc29ja2V0cGFpcigpCiAgICAgICAgd2FpdC53YWl0X2Zvcl93cml0ZShbcmQsIHdyXSwgMC4wMDEpCiAgICAgICAgc2VsZi5hc3NlcnRJcyhzZWxlY3Rvci5fbWFwLCBOb25lKQoKICAgIEBza2lwVW5sZXNzSGFzQWxhcm0KICAgIGRlZiB0ZXN0X2ludGVycnVwdF93YWl0X2Zvcl9yZWFkX25vX2V2ZW50KHNlbGYpOgogICAgICAgIHJkLCB3ciA9IHNlbGYubWFrZV9zb2NrZXRwYWlyKCkKCiAgICAgICAgc2VsZi5zZXRfYWxhcm0oU0hPUlRfU0VMRUNULCBsYW1iZGEgKmFyZ3M6IE5vbmUpCiAgICAgICAgd2l0aCBzZWxmLmFzc2VydFRha2VzVGltZShsb3dlcj1MT05HX1NFTEVDVCwgdXBwZXI9TE9OR19TRUxFQ1QpOgogICAgICAgICAgICBzZWxmLmFzc2VydEVxdWFsKFtdLCB3YWl0LndhaXRfZm9yX3JlYWQocmQsIHRpbWVvdXQ9TE9OR19TRUxFQ1QpKQoKICAgIEBza2lwVW5sZXNzSGFzQWxhcm0KICAgIGRlZiB0ZXN0X2ludGVycnVwdF93YWl0X2Zvcl9yZWFkX3dpdGhfZXZlbnQoc2VsZik6CiAgICAgICAgcmQsIHdyID0gc2VsZi5tYWtlX3NvY2tldHBhaXIoKQoKICAgICAgICBzZWxmLnNldF9hbGFybShTSE9SVF9TRUxFQ1QsIGxhbWJkYSAqYXJnczogd3Iuc2VuZChiJ3gnKSkKICAgICAgICB3aXRoIHNlbGYuYXNzZXJ0VGFrZXNUaW1lKGxvd2VyPVNIT1JUX1NFTEVDVCwgdXBwZXI9U0hPUlRfU0VMRUNUKToKICAgICAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChbcmRdLCB3YWl0LndhaXRfZm9yX3JlYWQocmQsIHRpbWVvdXQ9TE9OR19TRUxFQ1QpKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwocmQucmVjdigxKSwgYid4JykKCgpjbGFzcyBTY2FsYWJsZVNlbGVjdG9yTWl4aW4ob2JqZWN0KToKICAgICIiIiBNaXhpbiB0byB0ZXN0IHNlbGVjdG9ycyB0aGF0IGFsbG93IG1vcmUgZmRzIHRoYW4gRkRfU0VUU0laRSAiIiIKICAgIEBza2lwVW5sZXNzKHJlc291cmNlLCAiQ291bGQgbm90IGltcG9ydCB0aGUgcmVzb3VyY2UgbW9kdWxlIikKICAgIGRlZiB0ZXN0X2Fib3ZlX2ZkX3NldHNpemUoc2VsZik6CiAgICAgICAgIyBBIHNjYWxhYmxlIGltcGxlbWVudGF0aW9uIHNob3VsZCBoYXZlIG5vIHByb2JsZW0gd2l0aCBtb3JlIHRoYW4KICAgICAgICAjIEZEX1NFVFNJWkUgZmlsZSBkZXNjcmlwdG9ycy4gU2luY2Ugd2UgZG9uJ3Qga25vdyB0aGUgdmFsdWUsIHdlIGp1c3QKICAgICAgICAjIHRyeSB0byBzZXQgdGhlIHNvZnQgUkxJTUlUX05PRklMRSB0byB0aGUgaGFyZCBSTElNSVRfTk9GSUxFIGNlaWxpbmcuCiAgICAgICAgc29mdCwgaGFyZCA9IHJlc291cmNlLmdldHJsaW1pdChyZXNvdXJjZS5STElNSVRfTk9GSUxFKQogICAgICAgIGlmIGhhcmQgPT0gcmVzb3VyY2UuUkxJTV9JTkZJTklUWToKICAgICAgICAgICAgc2VsZi5za2lwVGVzdCgiUkxJTUlUX05PRklMRSBpcyBpbmZpbml0ZSIpCgogICAgICAgIHRyeTogICMgSWYgd2UncmUgb24gYSAqQlNEIHN5c3RlbSwgdGhlIGxpbWl0IHRhZyBpcyBkaWZmZXJlbnQuCiAgICAgICAgICAgIF8sIGJzZF9oYXJkID0gcmVzb3VyY2UuZ2V0cmxpbWl0KHJlc291cmNlLlJMSU1JVF9PRklMRSkKICAgICAgICAgICAgaWYgYnNkX2hhcmQgPT0gcmVzb3VyY2UuUkxJTV9JTkZJTklUWToKICAgICAgICAgICAgICAgIHNlbGYuc2tpcFRlc3QoIlJMSU1JVF9PRklMRSBpcyBpbmZpbml0ZSIpCiAgICAgICAgICAgIGlmIGJzZF9oYXJkIDwgaGFyZDoKICAgICAgICAgICAgICAgIGhhcmQgPSBic2RfaGFyZAoKICAgICAgICAjIE5PVEU6IEF0dHJpYnV0ZUVycm9yIHJlc291cmNlLlJMSU1JVF9PRklMRSBpcyBub3QgZGVmaW5lZCBvbiBNYWMgT1MuCiAgICAgICAgZXhjZXB0IChPU0Vycm9yLCByZXNvdXJjZS5lcnJvciwgQXR0cmlidXRlRXJyb3IpOgogICAgICAgICAgICBwYXNzCgogICAgICAgIHRyeToKICAgICAgICAgICAgcmVzb3VyY2Uuc2V0cmxpbWl0KHJlc291cmNlLlJMSU1JVF9OT0ZJTEUsIChoYXJkLCBoYXJkKSkKICAgICAgICAgICAgc2VsZi5hZGRDbGVhbnVwKHJlc291cmNlLnNldHJsaW1pdCwgcmVzb3VyY2UuUkxJTUlUX05PRklMRSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIChzb2Z0LCBoYXJkKSkKICAgICAgICAgICAgbGltaXRfbm9maWxlID0gbWluKGhhcmQsIDIgKiogMTYpCiAgICAgICAgZXhjZXB0IChPU0Vycm9yLCBWYWx1ZUVycm9yKToKICAgICAgICAgICAgbGltaXRfbm9maWxlID0gc29mdAoKICAgICAgICAjIEd1YXJkIGFnYWluc3QgYWxyZWFkeSBhbGxvY2F0ZWQgRkRzCiAgICAgICAgbGltaXRfbm9maWxlIC09IDI1NgogICAgICAgIGxpbWl0X25vZmlsZSA9IG1heCgwLCBsaW1pdF9ub2ZpbGUpCgogICAgICAgIHMgPSBzZWxmLm1ha2Vfc2VsZWN0b3IoKQoKICAgICAgICBmb3IgaSBpbiByYW5nZShsaW1pdF9ub2ZpbGUgLy8gMik6CiAgICAgICAgICAgIHJkLCB3ciA9IHNlbGYubWFrZV9zb2NrZXRwYWlyKCkKICAgICAgICAgICAgcy5yZWdpc3RlcihyZCwgc2VsZWN0b3JzLkVWRU5UX1JFQUQpCiAgICAgICAgICAgIHMucmVnaXN0ZXIod3IsIHNlbGVjdG9ycy5FVkVOVF9XUklURSkKCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChsaW1pdF9ub2ZpbGUgLy8gMiwgbGVuKHMuc2VsZWN0KCkpKQoKCkBza2lwVW5sZXNzSGFzU2VsZWN0b3IKY2xhc3MgVGVzdFVuaXF1ZVNlbGVjdFNjZW5hcmlvcyhCYXNlU2VsZWN0b3JUZXN0Q2FzZSk6CiAgICBkZWYgdGVzdF9zZWxlY3RfbW9kdWxlX3BhdGNoZWRfYWZ0ZXJfaW1wb3J0KHNlbGYpOgogICAgICAgICMgVGhpcyB0ZXN0IGlzIHRvIG1ha2Ugc3VyZSB0aGF0IGFmdGVyIGltcG9ydCB0aW1lCiAgICAgICAgIyBjYWxsaW5nIERlZmF1bHRTZWxlY3RvcigpIHdpbGwgc3RpbGwgZ2l2ZSBhIGdvb2QKICAgICAgICAjIHJldHVybiB2YWx1ZS4gVGhpcyBpc3N1ZSBpcyBjYXVzZWQgYnkgZ2V2ZW50LCBldmVudGxldC4KCiAgICAgICAgIyBOb3cgcmVtb3ZlIGFsbCBzZWxlY3RvcnMgZXhjZXB0IGBzZWxlY3Quc2VsZWN0YC4KICAgICAgICBwYXRjaF9zZWxlY3RfbW9kdWxlKHNlbGYsICdzZWxlY3QnKQoKICAgICAgICAjIE1ha2Ugc3VyZSB0aGF0IHRoZSBzZWxlY3RvciByZXR1cm5lZCBvbmx5IHVzZXMgdGhlIHNlbGVjdG9yIGF2YWlsYWJsZS4KICAgICAgICBzZWxlY3RvciA9IHNlbGYubWFrZV9zZWxlY3RvcigpCiAgICAgICAgc2VsZi5hc3NlcnRJc0luc3RhbmNlKHNlbGVjdG9yLCBzZWxlY3RvcnMuU2VsZWN0U2VsZWN0b3IpCgogICAgQHNraXBVbmxlc3NIYXNFTk9TWVMKICAgIGRlZiB0ZXN0X3NlbGVjdF9tb2R1bGVfZGVmaW5lc19kb2VzX25vdF9pbXBsZW1lbnRfcG9sbChzZWxmKToKICAgICAgICAjIFRoaXMgdGVzdCBpcyB0byBtYWtlIHN1cmUgdGhhdCBpZiBhIHBsYXRmb3JtIGRlZmluZXMKICAgICAgICAjIGEgc2VsZWN0b3IgYXMgYmVpbmcgYXZhaWxhYmxlIGJ1dCBkb2VzIG5vdCBhY3R1YWxseQogICAgICAgICMgaW1wbGVtZW50IGl0IChrZW5uZXRocmVpdHovcmVxdWVzdHMjMzkwNikgdGhlbgogICAgICAgICMgRGVmYXVsdFNlbGVjdG9yKCkgZG9lcyBub3QgZmFpbC4KCiAgICAgICAgIyBSZXNldCB0aGUgX0RFRkFVTFRfU0VMRUNUT1IgdmFsdWUgYXMgaWYgdXNpbmcgZm9yIHRoZSBmaXJzdCB0aW1lLgogICAgICAgIHNlbGVjdG9ycy5fREVGQVVMVF9TRUxFQ1RPUiA9IE5vbmUKCiAgICAgICAgIyBOb3cgd2UncmUgZ29pbmcgdG8gcGF0Y2ggaW4gYSBiYWQgYHBvbGxgLgogICAgICAgIGNsYXNzIEJhZFBvbGwob2JqZWN0KToKICAgICAgICAgICAgZGVmIHBvbGwoc2VsZiwgdGltZW91dCk6CiAgICAgICAgICAgICAgICByYWlzZSBPU0Vycm9yKGVycm5vLkVOT1NZUykKCiAgICAgICAgIyBSZW1vdmUgYWxsIHNlbGVjdG9ycyBleGNlcHQgYHNlbGVjdC5zZWxlY3RgIGFuZCByZXBsYWNlIGBzZWxlY3QucG9sbGAuCiAgICAgICAgcGF0Y2hfc2VsZWN0X21vZHVsZShzZWxmLCAnc2VsZWN0JywgcG9sbD1CYWRQb2xsKQoKICAgICAgICBzZWxlY3RvciA9IHNlbGYubWFrZV9zZWxlY3RvcigpCiAgICAgICAgc2VsZi5hc3NlcnRJc0luc3RhbmNlKHNlbGVjdG9yLCBzZWxlY3RvcnMuU2VsZWN0U2VsZWN0b3IpCgogICAgQHNraXBVbmxlc3NIYXNFTk9TWVMKICAgIGRlZiB0ZXN0X3NlbGVjdF9tb2R1bGVfZGVmaW5lc19kb2VzX25vdF9pbXBsZW1lbnRfZXBvbGwoc2VsZik6CiAgICAgICAgIyBTYW1lIGFzIGFib3ZlIHRlc3QgZXhjZXB0IHdpdGggYHNlbGVjdC5lcG9sbGAuCgogICAgICAgICMgUmVzZXQgdGhlIF9ERUZBVUxUX1NFTEVDVE9SIHZhbHVlIGFzIGlmIHVzaW5nIGZvciB0aGUgZmlyc3QgdGltZS4KICAgICAgICBzZWxlY3RvcnMuX0RFRkFVTFRfU0VMRUNUT1IgPSBOb25lCgogICAgICAgICMgTm93IHdlJ3JlIGdvaW5nIHRvIHBhdGNoIGluIGEgYmFkIGBlcG9sbGAuCiAgICAgICAgZGVmIGJhZF9lcG9sbCgqYXJncywgKiprd2FyZ3MpOgogICAgICAgICAgICByYWlzZSBPU0Vycm9yKGVycm5vLkVOT1NZUykKCiAgICAgICAgIyBSZW1vdmUgYWxsIHNlbGVjdG9ycyBleGNlcHQgYHNlbGVjdC5zZWxlY3RgIGFuZCByZXBsYWNlIGBzZWxlY3QuZXBvbGxgLgogICAgICAgIHBhdGNoX3NlbGVjdF9tb2R1bGUoc2VsZiwgJ3NlbGVjdCcsIGVwb2xsPWJhZF9lcG9sbCkKCiAgICAgICAgc2VsZWN0b3IgPSBzZWxmLm1ha2Vfc2VsZWN0b3IoKQogICAgICAgIHNlbGYuYXNzZXJ0SXNJbnN0YW5jZShzZWxlY3Rvciwgc2VsZWN0b3JzLlNlbGVjdFNlbGVjdG9yKQoKCkBza2lwVW5sZXNzKGhhc2F0dHIoc2VsZWN0b3JzLCAiU2VsZWN0U2VsZWN0b3IiKSwgIlBsYXRmb3JtIGRvZXNuJ3QgaGF2ZSBhIFNlbGVjdFNlbGVjdG9yIikKY2xhc3MgU2VsZWN0U2VsZWN0b3JUZXN0Q2FzZShCYXNlU2VsZWN0b3JUZXN0Q2FzZSk6CiAgICBkZWYgc2V0VXAoc2VsZik6CiAgICAgICAgcGF0Y2hfc2VsZWN0X21vZHVsZShzZWxmLCAnc2VsZWN0JykKCgpAc2tpcFVubGVzcyhoYXNhdHRyKHNlbGVjdG9ycywgIlBvbGxTZWxlY3RvciIpLCAiUGxhdGZvcm0gZG9lc24ndCBoYXZlIGEgUG9sbFNlbGVjdG9yIikKY2xhc3MgUG9sbFNlbGVjdG9yVGVzdENhc2UoQmFzZVNlbGVjdG9yVGVzdENhc2UsIFNjYWxhYmxlU2VsZWN0b3JNaXhpbik6CiAgICBkZWYgc2V0VXAoc2VsZik6CiAgICAgICAgcGF0Y2hfc2VsZWN0X21vZHVsZShzZWxmLCAncG9sbCcpCgoKQHNraXBVbmxlc3MoaGFzYXR0cihzZWxlY3RvcnMsICJFcG9sbFNlbGVjdG9yIiksICJQbGF0Zm9ybSBkb2Vzbid0IGhhdmUgYW4gRXBvbGxTZWxlY3RvciIpCmNsYXNzIEVwb2xsU2VsZWN0b3JUZXN0Q2FzZShCYXNlU2VsZWN0b3JUZXN0Q2FzZSwgU2NhbGFibGVTZWxlY3Rvck1peGluKToKICAgIGRlZiBzZXRVcChzZWxmKToKICAgICAgICBwYXRjaF9zZWxlY3RfbW9kdWxlKHNlbGYsICdlcG9sbCcpCgoKQHNraXBVbmxlc3MoaGFzYXR0cihzZWxlY3RvcnMsICJLcXVldWVTZWxlY3RvciIpLCAiUGxhdGZvcm0gZG9lc24ndCBoYXZlIGEgS3F1ZXVlU2VsZWN0b3IiKQpjbGFzcyBLcXVldWVTZWxlY3RvclRlc3RDYXNlKEJhc2VTZWxlY3RvclRlc3RDYXNlLCBTY2FsYWJsZVNlbGVjdG9yTWl4aW4pOgogICAgZGVmIHNldFVwKHNlbGYpOgogICAgICAgIHBhdGNoX3NlbGVjdF9tb2R1bGUoc2VsZiwgJ2txdWV1ZScpCgoKQHNraXBVbmxlc3MoaGFzYXR0cihzZWxlY3RvcnMsICJTZWxlY3RTZWxlY3RvciIpLCAiUGxhdGZvcm0gZG9lc24ndCBoYXZlIGEgU2VsZWN0U2VsZWN0b3IiKQpjbGFzcyBTZWxlY3RXYWl0Rm9yVGVzdENhc2UoQmFzZVdhaXRGb3JUZXN0Q2FzZSk6CiAgICBkZWYgc2V0VXAoc2VsZik6CiAgICAgICAgcGF0Y2hfc2VsZWN0X21vZHVsZShzZWxmLCAnc2VsZWN0JykKCgpAc2tpcFVubGVzcyhoYXNhdHRyKHNlbGVjdG9ycywgIlBvbGxTZWxlY3RvciIpLCAiUGxhdGZvcm0gZG9lc24ndCBoYXZlIGEgUG9sbFNlbGVjdG9yIikKY2xhc3MgUG9sbFdhaXRGb3JUZXN0Q2FzZShCYXNlV2FpdEZvclRlc3RDYXNlKToKICAgIGRlZiBzZXRVcChzZWxmKToKICAgICAgICBwYXRjaF9zZWxlY3RfbW9kdWxlKHNlbGYsICdwb2xsJykKCgpAc2tpcFVubGVzcyhoYXNhdHRyKHNlbGVjdG9ycywgIkVwb2xsU2VsZWN0b3IiKSwgIlBsYXRmb3JtIGRvZXNuJ3QgaGF2ZSBhbiBFcG9sbFNlbGVjdG9yIikKY2xhc3MgRXBvbGxXYWl0Rm9yVGVzdENhc2UoQmFzZVdhaXRGb3JUZXN0Q2FzZSk6CiAgICBkZWYgc2V0VXAoc2VsZik6CiAgICAgICAgcGF0Y2hfc2VsZWN0X21vZHVsZShzZWxmLCAnZXBvbGwnKQoKCkBza2lwVW5sZXNzKGhhc2F0dHIoc2VsZWN0b3JzLCAiS3F1ZXVlU2VsZWN0b3IiKSwgIlBsYXRmb3JtIGRvZXNuJ3QgaGF2ZSBhIEtxdWV1ZVNlbGVjdG9yIikKY2xhc3MgS3F1ZXVlV2FpdEZvclRlc3RDYXNlKEJhc2VXYWl0Rm9yVGVzdENhc2UpOgogICAgZGVmIHNldFVwKHNlbGYpOgogICAgICAgIHBhdGNoX3NlbGVjdF9tb2R1bGUoc2VsZiwgJ2txdWV1ZScpCg==
