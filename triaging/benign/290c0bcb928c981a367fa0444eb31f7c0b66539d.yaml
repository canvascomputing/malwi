statistics:
  total_files: 1
  skipped_files: 0.0
  processed_objects: 1
  malicious_objects: 0
details:
- path: .repo_cache/malicious_repos/pypi_malregistry/discord-py-v13/1.3/discord_py_v13-1.3-py3-none-any/discord-py-v13/state.py
  contents:
  - name: ConnectionState._get_guild
    score: 0.0
    code: |-
      def _get_guild(self, guild_id):
              return self._guilds.get(guild_id)
    tokens: resume load_fast self load_attr _guilds load_attr get load_fast guild_id call return_value
    hash: e0ba6d6ee2a6518dd5cbca335336df3e38897a5502313cf82ba6825bcf20c8a1
sources:
  .repo_cache/malicious_repos/pypi_malregistry/discord-py-v13/1.3/discord_py_v13-1.3-py3-none-any/discord-py-v13/state.py: IyAtKi0gY29kaW5nOiB1dGYtOCAtKi0KCiIiIgpUaGUgTUlUIExpY2Vuc2UgKE1JVCkKCkNvcHlyaWdodCAoYykgMjAxNS1wcmVzZW50IFJhcHB0egoKUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEKY29weSBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZSAiU29mdHdhcmUiKSwKdG8gZGVhbCBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbgp0aGUgcmlnaHRzIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwKYW5kL29yIHNlbGwgY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlClNvZnR3YXJlIGlzIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6CgpUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbgphbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KClRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTCk9SIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLApGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEUKQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUgpMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORwpGUk9NLCBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSCkRFQUxJTkdTIElOIFRIRSBTT0ZUV0FSRS4KIiIiCgppbXBvcnQgYXN5bmNpbwpmcm9tIGNvbGxlY3Rpb25zIGltcG9ydCBkZXF1ZSwgT3JkZXJlZERpY3QKaW1wb3J0IGNvcHkKaW1wb3J0IGRhdGV0aW1lCmltcG9ydCBpdGVydG9vbHMKaW1wb3J0IGxvZ2dpbmcKaW1wb3J0IHdlYWtyZWYKaW1wb3J0IHdhcm5pbmdzCmltcG9ydCBpbnNwZWN0CmltcG9ydCBnYwoKaW1wb3J0IG9zCgpmcm9tIC5ndWlsZCBpbXBvcnQgR3VpbGQKZnJvbSAuYWN0aXZpdHkgaW1wb3J0IEJhc2VBY3Rpdml0eQpmcm9tIC51c2VyIGltcG9ydCBVc2VyLCBDbGllbnRVc2VyCmZyb20gLmVtb2ppIGltcG9ydCBFbW9qaQpmcm9tIC5tZW50aW9ucyBpbXBvcnQgQWxsb3dlZE1lbnRpb25zCmZyb20gLnBhcnRpYWxfZW1vamkgaW1wb3J0IFBhcnRpYWxFbW9qaQpmcm9tIC5tZXNzYWdlIGltcG9ydCBNZXNzYWdlCmZyb20gLnJlbGF0aW9uc2hpcCBpbXBvcnQgUmVsYXRpb25zaGlwCmZyb20gLmNoYW5uZWwgaW1wb3J0ICoKZnJvbSAucmF3X21vZGVscyBpbXBvcnQgKgpmcm9tIC5tZW1iZXIgaW1wb3J0IE1lbWJlcgpmcm9tIC5yb2xlIGltcG9ydCBSb2xlCmZyb20gLmVudW1zIGltcG9ydCBDaGFubmVsVHlwZSwgdHJ5X2VudW0sIFN0YXR1cwpmcm9tIC4gaW1wb3J0IHV0aWxzCmZyb20gLmZsYWdzIGltcG9ydCBJbnRlbnRzLCBNZW1iZXJDYWNoZUZsYWdzCmZyb20gLm9iamVjdCBpbXBvcnQgT2JqZWN0CmZyb20gLmludml0ZSBpbXBvcnQgSW52aXRlCgpjbGFzcyBDaHVua1JlcXVlc3Q6CiAgICBkZWYgX19pbml0X18oc2VsZiwgZ3VpbGRfaWQsIGxvb3AsIHJlc29sdmVyLCAqLCBjYWNoZT1UcnVlKToKICAgICAgICBzZWxmLmd1aWxkX2lkID0gZ3VpbGRfaWQKICAgICAgICBzZWxmLnJlc29sdmVyID0gcmVzb2x2ZXIKICAgICAgICBzZWxmLmxvb3AgPSBsb29wCiAgICAgICAgc2VsZi5jYWNoZSA9IGNhY2hlCiAgICAgICAgc2VsZi5ub25jZSA9IG9zLnVyYW5kb20oMTYpLmhleCgpCiAgICAgICAgc2VsZi5idWZmZXIgPSBbXSAjIExpc3RbTWVtYmVyXQogICAgICAgIHNlbGYud2FpdGVycyA9IFtdCgogICAgZGVmIGFkZF9tZW1iZXJzKHNlbGYsIG1lbWJlcnMpOgogICAgICAgIHNlbGYuYnVmZmVyLmV4dGVuZChtZW1iZXJzKQogICAgICAgIGlmIHNlbGYuY2FjaGU6CiAgICAgICAgICAgIGd1aWxkID0gc2VsZi5yZXNvbHZlcihzZWxmLmd1aWxkX2lkKQogICAgICAgICAgICBpZiBndWlsZCBpcyBOb25lOgogICAgICAgICAgICAgICAgcmV0dXJuCgogICAgICAgICAgICBmb3IgbWVtYmVyIGluIG1lbWJlcnM6CiAgICAgICAgICAgICAgICBleGlzdGluZyA9IGd1aWxkLmdldF9tZW1iZXIobWVtYmVyLmlkKQogICAgICAgICAgICAgICAgaWYgZXhpc3RpbmcgaXMgTm9uZSBvciBleGlzdGluZy5qb2luZWRfYXQgaXMgTm9uZToKICAgICAgICAgICAgICAgICAgICBndWlsZC5fYWRkX21lbWJlcihtZW1iZXIpCgogICAgYXN5bmMgZGVmIHdhaXQoc2VsZik6CiAgICAgICAgZnV0dXJlID0gc2VsZi5sb29wLmNyZWF0ZV9mdXR1cmUoKQogICAgICAgIHNlbGYud2FpdGVycy5hcHBlbmQoZnV0dXJlKQogICAgICAgIHRyeToKICAgICAgICAgICAgcmV0dXJuIGF3YWl0IGZ1dHVyZQogICAgICAgIGZpbmFsbHk6CiAgICAgICAgICAgIHNlbGYud2FpdGVycy5yZW1vdmUoZnV0dXJlKQoKICAgIGRlZiBnZXRfZnV0dXJlKHNlbGYpOgogICAgICAgIGZ1dHVyZSA9IHNlbGYubG9vcC5jcmVhdGVfZnV0dXJlKCkKICAgICAgICBzZWxmLndhaXRlcnMuYXBwZW5kKGZ1dHVyZSkKICAgICAgICByZXR1cm4gZnV0dXJlCgogICAgZGVmIGRvbmUoc2VsZik6CiAgICAgICAgZm9yIGZ1dHVyZSBpbiBzZWxmLndhaXRlcnM6CiAgICAgICAgICAgIGlmIG5vdCBmdXR1cmUuZG9uZSgpOgogICAgICAgICAgICAgICAgZnV0dXJlLnNldF9yZXN1bHQoc2VsZi5idWZmZXIpCgpsb2cgPSBsb2dnaW5nLmdldExvZ2dlcihfX25hbWVfXykKCmFzeW5jIGRlZiBsb2dnaW5nX2Nvcm91dGluZShjb3JvdXRpbmUsICosIGluZm8pOgogICAgdHJ5OgogICAgICAgIGF3YWl0IGNvcm91dGluZQogICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICBsb2cuZXhjZXB0aW9uKCdFeGNlcHRpb24gb2NjdXJyZWQgZHVyaW5nICVzJywgaW5mbykKCmNsYXNzIENvbm5lY3Rpb25TdGF0ZToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCAqLCBkaXNwYXRjaCwgaGFuZGxlcnMsIGhvb2tzLCBzeW5jZXIsIGh0dHAsIGxvb3AsICoqb3B0aW9ucyk6CiAgICAgICAgc2VsZi5sb29wID0gbG9vcAogICAgICAgIHNlbGYuaHR0cCA9IGh0dHAKICAgICAgICBzZWxmLm1heF9tZXNzYWdlcyA9IG9wdGlvbnMuZ2V0KCdtYXhfbWVzc2FnZXMnLCAxMDAwKQogICAgICAgIGlmIHNlbGYubWF4X21lc3NhZ2VzIGlzIG5vdCBOb25lIGFuZCBzZWxmLm1heF9tZXNzYWdlcyA8PSAwOgogICAgICAgICAgICBzZWxmLm1heF9tZXNzYWdlcyA9IDEwMDAKCiAgICAgICAgc2VsZi5kaXNwYXRjaCA9IGRpc3BhdGNoCiAgICAgICAgc2VsZi5zeW5jZXIgPSBzeW5jZXIKICAgICAgICBzZWxmLmlzX2JvdCA9IE5vbmUKICAgICAgICBzZWxmLmhhbmRsZXJzID0gaGFuZGxlcnMKICAgICAgICBzZWxmLmhvb2tzID0gaG9va3MKICAgICAgICBzZWxmLnNoYXJkX2NvdW50ID0gTm9uZQogICAgICAgIHNlbGYuX3JlYWR5X3Rhc2sgPSBOb25lCiAgICAgICAgc2VsZi5oZWFydGJlYXRfdGltZW91dCA9IG9wdGlvbnMuZ2V0KCdoZWFydGJlYXRfdGltZW91dCcsIDYwLjApCiAgICAgICAgc2VsZi5ndWlsZF9yZWFkeV90aW1lb3V0ID0gb3B0aW9ucy5nZXQoJ2d1aWxkX3JlYWR5X3RpbWVvdXQnLCAyLjApCiAgICAgICAgaWYgc2VsZi5ndWlsZF9yZWFkeV90aW1lb3V0IDwgMDoKICAgICAgICAgICAgcmFpc2UgVmFsdWVFcnJvcignZ3VpbGRfcmVhZHlfdGltZW91dCBjYW5ub3QgYmUgbmVnYXRpdmUnKQoKICAgICAgICBzZWxmLmd1aWxkX3N1YnNjcmlwdGlvbnMgPSBvcHRpb25zLmdldCgnZ3VpbGRfc3Vic2NyaXB0aW9ucycsIFRydWUpCiAgICAgICAgYWxsb3dlZF9tZW50aW9ucyA9IG9wdGlvbnMuZ2V0KCdhbGxvd2VkX21lbnRpb25zJykKCiAgICAgICAgaWYgYWxsb3dlZF9tZW50aW9ucyBpcyBub3QgTm9uZSBhbmQgbm90IGlzaW5zdGFuY2UoYWxsb3dlZF9tZW50aW9ucywgQWxsb3dlZE1lbnRpb25zKToKICAgICAgICAgICAgcmFpc2UgVHlwZUVycm9yKCdhbGxvd2VkX21lbnRpb25zIHBhcmFtZXRlciBtdXN0IGJlIEFsbG93ZWRNZW50aW9ucycpCgogICAgICAgIHNlbGYuYWxsb3dlZF9tZW50aW9ucyA9IGFsbG93ZWRfbWVudGlvbnMKICAgICAgICBzZWxmLl9jaHVua19yZXF1ZXN0cyA9IHt9ICMgRGljdFtVbmlvbltpbnQsIHN0cl0sIENodW5rUmVxdWVzdF0KCiAgICAgICAgYWN0aXZpdHkgPSBvcHRpb25zLmdldCgnYWN0aXZpdHknLCBOb25lKQogICAgICAgIGlmIGFjdGl2aXR5OgogICAgICAgICAgICBpZiBub3QgaXNpbnN0YW5jZShhY3Rpdml0eSwgQmFzZUFjdGl2aXR5KToKICAgICAgICAgICAgICAgIHJhaXNlIFR5cGVFcnJvcignYWN0aXZpdHkgcGFyYW1ldGVyIG11c3QgZGVyaXZlIGZyb20gQmFzZUFjdGl2aXR5LicpCgogICAgICAgICAgICBhY3Rpdml0eSA9IGFjdGl2aXR5LnRvX2RpY3QoKQoKICAgICAgICBzdGF0dXMgPSBvcHRpb25zLmdldCgnc3RhdHVzJywgTm9uZSkKICAgICAgICBpZiBzdGF0dXM6CiAgICAgICAgICAgIGlmIHN0YXR1cyBpcyBTdGF0dXMub2ZmbGluZToKICAgICAgICAgICAgICAgIHN0YXR1cyA9ICdpbnZpc2libGUnCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBzdGF0dXMgPSBzdHIoc3RhdHVzKQoKICAgICAgICBpbnRlbnRzID0gb3B0aW9ucy5nZXQoJ2ludGVudHMnLCBOb25lKQogICAgICAgIGlmIGludGVudHMgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIGlmIG5vdCBpc2luc3RhbmNlKGludGVudHMsIEludGVudHMpOgogICAgICAgICAgICAgICAgcmFpc2UgVHlwZUVycm9yKCdpbnRlbnRzIHBhcmFtZXRlciBtdXN0IGJlIEludGVudCBub3QgJXInICUgdHlwZShpbnRlbnRzKSkKICAgICAgICBlbHNlOgogICAgICAgICAgICBpbnRlbnRzID0gSW50ZW50cy5kZWZhdWx0KCkKCiAgICAgICAgaWYgbm90IGludGVudHMuZ3VpbGRzOgogICAgICAgICAgICBsb2cud2FybmluZygnR3VpbGRzIGludGVudCBzZWVtcyB0byBiZSBkaXNhYmxlZC4gVGhpcyBtYXkgY2F1c2Ugc3RhdGUgcmVsYXRlZCBpc3N1ZXMuJykKCiAgICAgICAgdHJ5OgogICAgICAgICAgICBjaHVua19ndWlsZHMgPSBvcHRpb25zWydmZXRjaF9vZmZsaW5lX21lbWJlcnMnXQogICAgICAgIGV4Y2VwdCBLZXlFcnJvcjoKICAgICAgICAgICAgY2h1bmtfZ3VpbGRzID0gb3B0aW9ucy5nZXQoJ2NodW5rX2d1aWxkc19hdF9zdGFydHVwJywgaW50ZW50cy5tZW1iZXJzKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIG1zZyA9ICdmZXRjaF9vZmZsaW5lX21lbWJlcnMgaXMgZGVwcmVjYXRlZCwgdXNlIGNodW5rX2d1aWxkc19hdF9zdGFydHVwIGluc3RlYWQnCiAgICAgICAgICAgIHdhcm5pbmdzLndhcm4obXNnLCBEZXByZWNhdGlvbldhcm5pbmcsIHN0YWNrbGV2ZWw9NCkKCiAgICAgICAgc2VsZi5fY2h1bmtfZ3VpbGRzID0gY2h1bmtfZ3VpbGRzCgogICAgICAgICMgRW5zdXJlIHRoZXNlIHR3byBhcmUgc2V0IHByb3Blcmx5CiAgICAgICAgaWYgbm90IGludGVudHMubWVtYmVycyBhbmQgc2VsZi5fY2h1bmtfZ3VpbGRzOgogICAgICAgICAgICByYWlzZSBWYWx1ZUVycm9yKCdJbnRlbnRzLm1lbWJlcnMgbXVzdCBiZSBlbmFibGVkIHRvIGNodW5rIGd1aWxkcyBhdCBzdGFydHVwLicpCgogICAgICAgIGNhY2hlX2ZsYWdzID0gb3B0aW9ucy5nZXQoJ21lbWJlcl9jYWNoZV9mbGFncycsIE5vbmUpCiAgICAgICAgaWYgY2FjaGVfZmxhZ3MgaXMgTm9uZToKICAgICAgICAgICAgY2FjaGVfZmxhZ3MgPSBNZW1iZXJDYWNoZUZsYWdzLmZyb21faW50ZW50cyhpbnRlbnRzKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGlmIG5vdCBpc2luc3RhbmNlKGNhY2hlX2ZsYWdzLCBNZW1iZXJDYWNoZUZsYWdzKToKICAgICAgICAgICAgICAgIHJhaXNlIFR5cGVFcnJvcignbWVtYmVyX2NhY2hlX2ZsYWdzIHBhcmFtZXRlciBtdXN0IGJlIE1lbWJlckNhY2hlRmxhZ3Mgbm90ICVyJyAlIHR5cGUoY2FjaGVfZmxhZ3MpKQoKICAgICAgICAgICAgY2FjaGVfZmxhZ3MuX3ZlcmlmeV9pbnRlbnRzKGludGVudHMpCgogICAgICAgIHNlbGYubWVtYmVyX2NhY2hlX2ZsYWdzID0gY2FjaGVfZmxhZ3MKICAgICAgICBzZWxmLl9hY3Rpdml0eSA9IGFjdGl2aXR5CiAgICAgICAgc2VsZi5fc3RhdHVzID0gc3RhdHVzCiAgICAgICAgc2VsZi5faW50ZW50cyA9IGludGVudHMKCiAgICAgICAgaWYgbm90IGludGVudHMubWVtYmVycyBvciBjYWNoZV9mbGFncy5fZW1wdHk6CiAgICAgICAgICAgIHNlbGYuc3RvcmVfdXNlciA9IHNlbGYuc3RvcmVfdXNlcl9ub19pbnRlbnRzCgogICAgICAgIHNlbGYucGFyc2VycyA9IHBhcnNlcnMgPSB7fQogICAgICAgIGZvciBhdHRyLCBmdW5jIGluIGluc3BlY3QuZ2V0bWVtYmVycyhzZWxmKToKICAgICAgICAgICAgaWYgYXR0ci5zdGFydHN3aXRoKCdwYXJzZV8nKToKICAgICAgICAgICAgICAgIHBhcnNlcnNbYXR0cls2Ol0udXBwZXIoKV0gPSBmdW5jCgogICAgICAgIHNlbGYuY2xlYXIoKQoKICAgIGRlZiBjbGVhcihzZWxmKToKICAgICAgICBzZWxmLnVzZXIgPSBOb25lCiAgICAgICAgc2VsZi5fdXNlcnMgPSB3ZWFrcmVmLldlYWtWYWx1ZURpY3Rpb25hcnkoKQogICAgICAgIHNlbGYuX2Vtb2ppcyA9IHt9CiAgICAgICAgc2VsZi5fY2FsbHMgPSB7fQogICAgICAgIHNlbGYuX2d1aWxkcyA9IHt9CiAgICAgICAgc2VsZi5fdm9pY2VfY2xpZW50cyA9IHt9CgogICAgICAgICMgTFJVIG9mIG1heCBzaXplIDEyOAogICAgICAgIHNlbGYuX3ByaXZhdGVfY2hhbm5lbHMgPSBPcmRlcmVkRGljdCgpCiAgICAgICAgIyBleHRyYSBkaWN0IHRvIGxvb2sgdXAgcHJpdmF0ZSBjaGFubmVscyBieSB1c2VyIGlkCiAgICAgICAgc2VsZi5fcHJpdmF0ZV9jaGFubmVsc19ieV91c2VyID0ge30KICAgICAgICBzZWxmLl9tZXNzYWdlcyA9IHNlbGYubWF4X21lc3NhZ2VzIGFuZCBkZXF1ZShtYXhsZW49c2VsZi5tYXhfbWVzc2FnZXMpCgogICAgICAgICMgSW4gY2FzZXMgb2YgbGFyZ2UgZGVhbGxvY2F0aW9ucyB0aGUgR0Mgc2hvdWxkIGJlIGNhbGxlZCBleHBsaWNpdGx5CiAgICAgICAgIyBUbyBmcmVlIHRoZSBtZW1vcnkgbW9yZSBpbW1lZGlhdGVseSwgZXNwZWNpYWxseSB0cnVlIHdoZW4gaXQgY29tZXMKICAgICAgICAjIHRvIHJlY29ubmVjdCBsb29wcyB3aGljaCBjYXVzZSBtYXNzIGFsbG9jYXRpb25zIGFuZCBkZWFsbG9jYXRpb25zLgogICAgICAgIGdjLmNvbGxlY3QoKQoKICAgIGRlZiBwcm9jZXNzX2NodW5rX3JlcXVlc3RzKHNlbGYsIGd1aWxkX2lkLCBub25jZSwgbWVtYmVycywgY29tcGxldGUpOgogICAgICAgIHJlbW92ZWQgPSBbXQogICAgICAgIGZvciBrZXksIHJlcXVlc3QgaW4gc2VsZi5fY2h1bmtfcmVxdWVzdHMuaXRlbXMoKToKICAgICAgICAgICAgaWYgcmVxdWVzdC5ndWlsZF9pZCA9PSBndWlsZF9pZCBhbmQgcmVxdWVzdC5ub25jZSA9PSBub25jZToKICAgICAgICAgICAgICAgIHJlcXVlc3QuYWRkX21lbWJlcnMobWVtYmVycykKICAgICAgICAgICAgICAgIGlmIGNvbXBsZXRlOgogICAgICAgICAgICAgICAgICAgIHJlcXVlc3QuZG9uZSgpCiAgICAgICAgICAgICAgICAgICAgcmVtb3ZlZC5hcHBlbmQoa2V5KQoKICAgICAgICBmb3Iga2V5IGluIHJlbW92ZWQ6CiAgICAgICAgICAgIGRlbCBzZWxmLl9jaHVua19yZXF1ZXN0c1trZXldCgogICAgZGVmIGNhbGxfaGFuZGxlcnMoc2VsZiwga2V5LCAqYXJncywgKiprd2FyZ3MpOgogICAgICAgIHRyeToKICAgICAgICAgICAgZnVuYyA9IHNlbGYuaGFuZGxlcnNba2V5XQogICAgICAgIGV4Y2VwdCBLZXlFcnJvcjoKICAgICAgICAgICAgcGFzcwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGZ1bmMoKmFyZ3MsICoqa3dhcmdzKQoKICAgIGFzeW5jIGRlZiBjYWxsX2hvb2tzKHNlbGYsIGtleSwgKmFyZ3MsICoqa3dhcmdzKToKICAgICAgICB0cnk6CiAgICAgICAgICAgIGNvcm8gPSBzZWxmLmhvb2tzW2tleV0KICAgICAgICBleGNlcHQgS2V5RXJyb3I6CiAgICAgICAgICAgIHBhc3MKICAgICAgICBlbHNlOgogICAgICAgICAgICBhd2FpdCBjb3JvKCphcmdzLCAqKmt3YXJncykKCiAgICBAcHJvcGVydHkKICAgIGRlZiBzZWxmX2lkKHNlbGYpOgogICAgICAgIHUgPSBzZWxmLnVzZXIKICAgICAgICByZXR1cm4gdS5pZCBpZiB1IGVsc2UgTm9uZQoKICAgIEBwcm9wZXJ0eQogICAgZGVmIGludGVudHMoc2VsZik6CiAgICAgICAgcmV0ID0gSW50ZW50cy5ub25lKCkKICAgICAgICByZXQudmFsdWUgPSBzZWxmLl9pbnRlbnRzLnZhbHVlCiAgICAgICAgcmV0dXJuIHJldAoKICAgIEBwcm9wZXJ0eQogICAgZGVmIHZvaWNlX2NsaWVudHMoc2VsZik6CiAgICAgICAgcmV0dXJuIGxpc3Qoc2VsZi5fdm9pY2VfY2xpZW50cy52YWx1ZXMoKSkKCiAgICBkZWYgX2dldF92b2ljZV9jbGllbnQoc2VsZiwgZ3VpbGRfaWQpOgogICAgICAgIHJldHVybiBzZWxmLl92b2ljZV9jbGllbnRzLmdldChndWlsZF9pZCkKCiAgICBkZWYgX2FkZF92b2ljZV9jbGllbnQoc2VsZiwgZ3VpbGRfaWQsIHZvaWNlKToKICAgICAgICBzZWxmLl92b2ljZV9jbGllbnRzW2d1aWxkX2lkXSA9IHZvaWNlCgogICAgZGVmIF9yZW1vdmVfdm9pY2VfY2xpZW50KHNlbGYsIGd1aWxkX2lkKToKICAgICAgICBzZWxmLl92b2ljZV9jbGllbnRzLnBvcChndWlsZF9pZCwgTm9uZSkKCiAgICBkZWYgX3VwZGF0ZV9yZWZlcmVuY2VzKHNlbGYsIHdzKToKICAgICAgICBmb3IgdmMgaW4gc2VsZi52b2ljZV9jbGllbnRzOgogICAgICAgICAgICB2Yy5tYWluX3dzID0gd3MKCiAgICBkZWYgc3RvcmVfdXNlcihzZWxmLCBkYXRhKToKICAgICAgICAjIHRoaXMgd2F5IGlzIDMwMCUgZmFzdGVyIHRoYW4gYGRpY3Quc2V0ZGVmYXVsdGAuCiAgICAgICAgdXNlcl9pZCA9IGludChkYXRhWydpZCddKQogICAgICAgIHRyeToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX3VzZXJzW3VzZXJfaWRdCiAgICAgICAgZXhjZXB0IEtleUVycm9yOgogICAgICAgICAgICB1c2VyID0gVXNlcihzdGF0ZT1zZWxmLCBkYXRhPWRhdGEpCiAgICAgICAgICAgIGlmIHVzZXIuZGlzY3JpbWluYXRvciAhPSAnMDAwMCc6CiAgICAgICAgICAgICAgICBzZWxmLl91c2Vyc1t1c2VyX2lkXSA9IHVzZXIKICAgICAgICAgICAgcmV0dXJuIHVzZXIKCiAgICBkZWYgc3RvcmVfdXNlcl9ub19pbnRlbnRzKHNlbGYsIGRhdGEpOgogICAgICAgIHJldHVybiBVc2VyKHN0YXRlPXNlbGYsIGRhdGE9ZGF0YSkKCiAgICBkZWYgZ2V0X3VzZXIoc2VsZiwgaWQpOgogICAgICAgIHJldHVybiBzZWxmLl91c2Vycy5nZXQoaWQpCgogICAgZGVmIHN0b3JlX2Vtb2ppKHNlbGYsIGd1aWxkLCBkYXRhKToKICAgICAgICBlbW9qaV9pZCA9IGludChkYXRhWydpZCddKQogICAgICAgIHNlbGYuX2Vtb2ppc1tlbW9qaV9pZF0gPSBlbW9qaSA9IEVtb2ppKGd1aWxkPWd1aWxkLCBzdGF0ZT1zZWxmLCBkYXRhPWRhdGEpCiAgICAgICAgcmV0dXJuIGVtb2ppCgogICAgQHByb3BlcnR5CiAgICBkZWYgZ3VpbGRzKHNlbGYpOgogICAgICAgIHJldHVybiBsaXN0KHNlbGYuX2d1aWxkcy52YWx1ZXMoKSkKCiAgICBkZWYgX2dldF9ndWlsZChzZWxmLCBndWlsZF9pZCk6CiAgICAgICAgcmV0dXJuIHNlbGYuX2d1aWxkcy5nZXQoZ3VpbGRfaWQpCgogICAgZGVmIF9hZGRfZ3VpbGQoc2VsZiwgZ3VpbGQpOgogICAgICAgIHNlbGYuX2d1aWxkc1tndWlsZC5pZF0gPSBndWlsZAoKICAgIGRlZiBfcmVtb3ZlX2d1aWxkKHNlbGYsIGd1aWxkKToKICAgICAgICBzZWxmLl9ndWlsZHMucG9wKGd1aWxkLmlkLCBOb25lKQoKICAgICAgICBmb3IgZW1vamkgaW4gZ3VpbGQuZW1vamlzOgogICAgICAgICAgICBzZWxmLl9lbW9qaXMucG9wKGVtb2ppLmlkLCBOb25lKQoKICAgICAgICBkZWwgZ3VpbGQKCiAgICAgICAgIyBNdWNoIGxpa2UgY2xlYXIoKSwgaWYgd2UgaGF2ZSBhIG1hc3NpdmUgZGVhbGxvY2F0aW9uCiAgICAgICAgIyB0aGVuIGl0J3MgYmV0dGVyIHRvIGV4cGxpY2l0bHkgY2FsbCB0aGUgR0MKICAgICAgICBnYy5jb2xsZWN0KCkKCiAgICBAcHJvcGVydHkKICAgIGRlZiBlbW9qaXMoc2VsZik6CiAgICAgICAgcmV0dXJuIGxpc3Qoc2VsZi5fZW1vamlzLnZhbHVlcygpKQoKICAgIGRlZiBnZXRfZW1vamkoc2VsZiwgZW1vamlfaWQpOgogICAgICAgIHJldHVybiBzZWxmLl9lbW9qaXMuZ2V0KGVtb2ppX2lkKQoKICAgIEBwcm9wZXJ0eQogICAgZGVmIHByaXZhdGVfY2hhbm5lbHMoc2VsZik6CiAgICAgICAgcmV0dXJuIGxpc3Qoc2VsZi5fcHJpdmF0ZV9jaGFubmVscy52YWx1ZXMoKSkKCiAgICBkZWYgX2dldF9wcml2YXRlX2NoYW5uZWwoc2VsZiwgY2hhbm5lbF9pZCk6CiAgICAgICAgdHJ5OgogICAgICAgICAgICB2YWx1ZSA9IHNlbGYuX3ByaXZhdGVfY2hhbm5lbHNbY2hhbm5lbF9pZF0KICAgICAgICBleGNlcHQgS2V5RXJyb3I6CiAgICAgICAgICAgIHJldHVybiBOb25lCiAgICAgICAgZWxzZToKICAgICAgICAgICAgc2VsZi5fcHJpdmF0ZV9jaGFubmVscy5tb3ZlX3RvX2VuZChjaGFubmVsX2lkKQogICAgICAgICAgICByZXR1cm4gdmFsdWUKCiAgICBkZWYgX2dldF9wcml2YXRlX2NoYW5uZWxfYnlfdXNlcihzZWxmLCB1c2VyX2lkKToKICAgICAgICByZXR1cm4gc2VsZi5fcHJpdmF0ZV9jaGFubmVsc19ieV91c2VyLmdldCh1c2VyX2lkKQoKICAgIGRlZiBfYWRkX3ByaXZhdGVfY2hhbm5lbChzZWxmLCBjaGFubmVsKToKICAgICAgICBjaGFubmVsX2lkID0gY2hhbm5lbC5pZAogICAgICAgIHNlbGYuX3ByaXZhdGVfY2hhbm5lbHNbY2hhbm5lbF9pZF0gPSBjaGFubmVsCgogICAgICAgIGlmIHNlbGYuaXNfYm90IGFuZCBsZW4oc2VsZi5fcHJpdmF0ZV9jaGFubmVscykgPiAxMjg6CiAgICAgICAgICAgIF8sIHRvX3JlbW92ZSA9IHNlbGYuX3ByaXZhdGVfY2hhbm5lbHMucG9waXRlbShsYXN0PUZhbHNlKQogICAgICAgICAgICBpZiBpc2luc3RhbmNlKHRvX3JlbW92ZSwgRE1DaGFubmVsKToKICAgICAgICAgICAgICAgIHNlbGYuX3ByaXZhdGVfY2hhbm5lbHNfYnlfdXNlci5wb3AodG9fcmVtb3ZlLnJlY2lwaWVudC5pZCwgTm9uZSkKCiAgICAgICAgaWYgaXNpbnN0YW5jZShjaGFubmVsLCBETUNoYW5uZWwpOgogICAgICAgICAgICBzZWxmLl9wcml2YXRlX2NoYW5uZWxzX2J5X3VzZXJbY2hhbm5lbC5yZWNpcGllbnQuaWRdID0gY2hhbm5lbAoKICAgIGRlZiBhZGRfZG1fY2hhbm5lbChzZWxmLCBkYXRhKToKICAgICAgICBjaGFubmVsID0gRE1DaGFubmVsKG1lPXNlbGYudXNlciwgc3RhdGU9c2VsZiwgZGF0YT1kYXRhKQogICAgICAgIHNlbGYuX2FkZF9wcml2YXRlX2NoYW5uZWwoY2hhbm5lbCkKICAgICAgICByZXR1cm4gY2hhbm5lbAoKICAgIGRlZiBfcmVtb3ZlX3ByaXZhdGVfY2hhbm5lbChzZWxmLCBjaGFubmVsKToKICAgICAgICBzZWxmLl9wcml2YXRlX2NoYW5uZWxzLnBvcChjaGFubmVsLmlkLCBOb25lKQogICAgICAgIGlmIGlzaW5zdGFuY2UoY2hhbm5lbCwgRE1DaGFubmVsKToKICAgICAgICAgICAgc2VsZi5fcHJpdmF0ZV9jaGFubmVsc19ieV91c2VyLnBvcChjaGFubmVsLnJlY2lwaWVudC5pZCwgTm9uZSkKCiAgICBkZWYgX2dldF9tZXNzYWdlKHNlbGYsIG1zZ19pZCk6CiAgICAgICAgcmV0dXJuIHV0aWxzLmZpbmQobGFtYmRhIG06IG0uaWQgPT0gbXNnX2lkLCByZXZlcnNlZChzZWxmLl9tZXNzYWdlcykpIGlmIHNlbGYuX21lc3NhZ2VzIGVsc2UgTm9uZQoKICAgIGRlZiBfYWRkX2d1aWxkX2Zyb21fZGF0YShzZWxmLCBndWlsZCk6CiAgICAgICAgZ3VpbGQgPSBHdWlsZChkYXRhPWd1aWxkLCBzdGF0ZT1zZWxmKQogICAgICAgIHNlbGYuX2FkZF9ndWlsZChndWlsZCkKICAgICAgICByZXR1cm4gZ3VpbGQKCiAgICBkZWYgX2d1aWxkX25lZWRzX2NodW5raW5nKHNlbGYsIGd1aWxkKToKICAgICAgICAjIElmIHByZXNlbmNlcyBhcmUgZW5hYmxlZCB0aGVuIHdlIGdldCBiYWNrIHRoZSBvbGQgZ3VpbGQubGFyZ2UgYmVoYXZpb3VyCiAgICAgICAgcmV0dXJuIHNlbGYuX2NodW5rX2d1aWxkcyBhbmQgbm90IGd1aWxkLmNodW5rZWQgYW5kIG5vdCAoc2VsZi5faW50ZW50cy5wcmVzZW5jZXMgYW5kIG5vdCBndWlsZC5sYXJnZSkKCiAgICBkZWYgX2dldF9ndWlsZF9jaGFubmVsKHNlbGYsIGRhdGEpOgogICAgICAgIGNoYW5uZWxfaWQgPSBpbnQoZGF0YVsnY2hhbm5lbF9pZCddKQogICAgICAgIHRyeToKICAgICAgICAgICAgZ3VpbGQgPSBzZWxmLl9nZXRfZ3VpbGQoaW50KGRhdGFbJ2d1aWxkX2lkJ10pKQogICAgICAgIGV4Y2VwdCBLZXlFcnJvcjoKICAgICAgICAgICAgY2hhbm5lbCA9IHNlbGYuZ2V0X2NoYW5uZWwoY2hhbm5lbF9pZCkKICAgICAgICAgICAgZ3VpbGQgPSBOb25lCiAgICAgICAgZWxzZToKICAgICAgICAgICAgY2hhbm5lbCA9IGd1aWxkIGFuZCBndWlsZC5nZXRfY2hhbm5lbChjaGFubmVsX2lkKQoKICAgICAgICByZXR1cm4gY2hhbm5lbCBvciBPYmplY3QoaWQ9Y2hhbm5lbF9pZCksIGd1aWxkCgogICAgYXN5bmMgZGVmIGNodW5rZXIoc2VsZiwgZ3VpbGRfaWQsIHF1ZXJ5PScnLCBsaW1pdD0wLCBwcmVzZW5jZXM9RmFsc2UsICosIG5vbmNlPU5vbmUpOgogICAgICAgIHdzID0gc2VsZi5fZ2V0X3dlYnNvY2tldChndWlsZF9pZCkgIyBUaGlzIGlzIGlnbm9yZWQgdXBzdHJlYW0KICAgICAgICBhd2FpdCB3cy5yZXF1ZXN0X2NodW5rcyhndWlsZF9pZCwgcXVlcnk9cXVlcnksIGxpbWl0PWxpbWl0LCBwcmVzZW5jZXM9cHJlc2VuY2VzLCBub25jZT1ub25jZSkKCiAgICBhc3luYyBkZWYgcXVlcnlfbWVtYmVycyhzZWxmLCBndWlsZCwgcXVlcnksIGxpbWl0LCB1c2VyX2lkcywgY2FjaGUsIHByZXNlbmNlcyk6CiAgICAgICAgZ3VpbGRfaWQgPSBndWlsZC5pZAogICAgICAgIHdzID0gc2VsZi5fZ2V0X3dlYnNvY2tldChndWlsZF9pZCkKICAgICAgICBpZiB3cyBpcyBOb25lOgogICAgICAgICAgICByYWlzZSBSdW50aW1lRXJyb3IoJ1NvbWVob3cgZG8gbm90IGhhdmUgYSB3ZWJzb2NrZXQgZm9yIHRoaXMgZ3VpbGRfaWQnKQoKICAgICAgICByZXF1ZXN0ID0gQ2h1bmtSZXF1ZXN0KGd1aWxkLmlkLCBzZWxmLmxvb3AsIHNlbGYuX2dldF9ndWlsZCwgY2FjaGU9Y2FjaGUpCiAgICAgICAgc2VsZi5fY2h1bmtfcmVxdWVzdHNbcmVxdWVzdC5ub25jZV0gPSByZXF1ZXN0CgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBzdGFydCB0aGUgcXVlcnkgb3BlcmF0aW9uCiAgICAgICAgICAgIGF3YWl0IHdzLnJlcXVlc3RfY2h1bmtzKGd1aWxkX2lkLCBxdWVyeT1xdWVyeSwgbGltaXQ9bGltaXQsIHVzZXJfaWRzPXVzZXJfaWRzLCBwcmVzZW5jZXM9cHJlc2VuY2VzLCBub25jZT1yZXF1ZXN0Lm5vbmNlKQogICAgICAgICAgICByZXR1cm4gYXdhaXQgYXN5bmNpby53YWl0X2ZvcihyZXF1ZXN0LndhaXQoKSwgdGltZW91dD0zMC4wKQogICAgICAgIGV4Y2VwdCBhc3luY2lvLlRpbWVvdXRFcnJvcjoKICAgICAgICAgICAgbG9nLndhcm5pbmcoJ1RpbWVkIG91dCB3YWl0aW5nIGZvciBjaHVua3Mgd2l0aCBxdWVyeSAlciBhbmQgbGltaXQgJWQgZm9yIGd1aWxkX2lkICVkJywgcXVlcnksIGxpbWl0LCBndWlsZF9pZCkKICAgICAgICAgICAgcmFpc2UKCiAgICBhc3luYyBkZWYgX2RlbGF5X3JlYWR5KHNlbGYpOgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBvbmx5IHJlYWwgYm90cyB3YWl0IGZvciBHVUlMRF9DUkVBVEUgc3RyZWFtaW5nCiAgICAgICAgICAgIGlmIHNlbGYuaXNfYm90OgogICAgICAgICAgICAgICAgc3RhdGVzID0gW10KICAgICAgICAgICAgICAgIHdoaWxlIFRydWU6CiAgICAgICAgICAgICAgICAgICAgIyB0aGlzIHNuaXBwZXQgb2YgY29kZSBpcyBiYXNpY2FsbHkgd2FpdGluZyBOIHNlY29uZHMKICAgICAgICAgICAgICAgICAgICAjIHVudGlsIHRoZSBsYXN0IEdVSUxEX0NSRUFURSB3YXMgc2VudAogICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgZ3VpbGQgPSBhd2FpdCBhc3luY2lvLndhaXRfZm9yKHNlbGYuX3JlYWR5X3N0YXRlLmdldCgpLCB0aW1lb3V0PXNlbGYuZ3VpbGRfcmVhZHlfdGltZW91dCkKICAgICAgICAgICAgICAgICAgICBleGNlcHQgYXN5bmNpby5UaW1lb3V0RXJyb3I6CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgaWYgc2VsZi5fZ3VpbGRfbmVlZHNfY2h1bmtpbmcoZ3VpbGQpOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZnV0dXJlID0gYXdhaXQgc2VsZi5jaHVua19ndWlsZChndWlsZCwgd2FpdD1GYWxzZSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlcy5hcHBlbmQoKGd1aWxkLCBmdXR1cmUpKQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgZ3VpbGQudW5hdmFpbGFibGUgaXMgRmFsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5kaXNwYXRjaCgnZ3VpbGRfYXZhaWxhYmxlJywgZ3VpbGQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZGlzcGF0Y2goJ2d1aWxkX2pvaW4nLCBndWlsZCkKCiAgICAgICAgICAgICAgICBmb3IgZ3VpbGQsIGZ1dHVyZSBpbiBzdGF0ZXM6CiAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICBhd2FpdCBhc3luY2lvLndhaXRfZm9yKGZ1dHVyZSwgdGltZW91dD01LjApCiAgICAgICAgICAgICAgICAgICAgZXhjZXB0IGFzeW5jaW8uVGltZW91dEVycm9yOgogICAgICAgICAgICAgICAgICAgICAgICBsb2cud2FybmluZygnU2hhcmQgSUQgJXMgdGltZWQgb3V0IHdhaXRpbmcgZm9yIGNodW5rcyBmb3IgZ3VpbGRfaWQgJXMuJywgZ3VpbGQuc2hhcmRfaWQsIGd1aWxkLmlkKQoKICAgICAgICAgICAgICAgICAgICBpZiBndWlsZC51bmF2YWlsYWJsZSBpcyBGYWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5kaXNwYXRjaCgnZ3VpbGRfYXZhaWxhYmxlJywgZ3VpbGQpCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5kaXNwYXRjaCgnZ3VpbGRfam9pbicsIGd1aWxkKQoKICAgICAgICAgICAgIyByZW1vdmUgdGhlIHN0YXRlCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGRlbCBzZWxmLl9yZWFkeV9zdGF0ZQogICAgICAgICAgICBleGNlcHQgQXR0cmlidXRlRXJyb3I6CiAgICAgICAgICAgICAgICBwYXNzICMgYWxyZWFkeSBiZWVuIGRlbGV0ZWQgc29tZWhvdwoKICAgICAgICAgICAgIyBjYWxsIEdVSUxEX1NZTkMgYWZ0ZXIgd2UncmUgZG9uZSBjaHVua2luZwogICAgICAgICAgICBpZiBub3Qgc2VsZi5pc19ib3Q6CiAgICAgICAgICAgICAgICBsb2cuaW5mbygnUmVxdWVzdGluZyBHVUlMRF9TWU5DIGZvciAlcyBndWlsZHMnLCBsZW4oc2VsZi5ndWlsZHMpKQogICAgICAgICAgICAgICAgYXdhaXQgc2VsZi5zeW5jZXIoW3MuaWQgZm9yIHMgaW4gc2VsZi5ndWlsZHNdKQogICAgICAgIGV4Y2VwdCBhc3luY2lvLkNhbmNlbGxlZEVycm9yOgogICAgICAgICAgICBwYXNzCiAgICAgICAgZWxzZToKICAgICAgICAgICAgIyBkaXNwYXRjaCB0aGUgZXZlbnQKICAgICAgICAgICAgc2VsZi5jYWxsX2hhbmRsZXJzKCdyZWFkeScpCiAgICAgICAgICAgIHNlbGYuZGlzcGF0Y2goJ3JlYWR5JykKICAgICAgICBmaW5hbGx5OgogICAgICAgICAgICBzZWxmLl9yZWFkeV90YXNrID0gTm9uZQoKICAgIGRlZiBwYXJzZV9yZWFkeShzZWxmLCBkYXRhKToKICAgICAgICBpZiBzZWxmLl9yZWFkeV90YXNrIGlzIG5vdCBOb25lOgogICAgICAgICAgICBzZWxmLl9yZWFkeV90YXNrLmNhbmNlbCgpCgogICAgICAgIHNlbGYuX3JlYWR5X3N0YXRlID0gYXN5bmNpby5RdWV1ZSgpCiAgICAgICAgc2VsZi5jbGVhcigpCiAgICAgICAgc2VsZi51c2VyID0gdXNlciA9IENsaWVudFVzZXIoc3RhdGU9c2VsZiwgZGF0YT1kYXRhWyd1c2VyJ10pCiAgICAgICAgc2VsZi5fdXNlcnNbdXNlci5pZF0gPSB1c2VyCgogICAgICAgIGZvciBndWlsZF9kYXRhIGluIGRhdGFbJ2d1aWxkcyddOgogICAgICAgICAgICBzZWxmLl9hZGRfZ3VpbGRfZnJvbV9kYXRhKGd1aWxkX2RhdGEpCgogICAgICAgIGZvciByZWxhdGlvbnNoaXAgaW4gZGF0YS5nZXQoJ3JlbGF0aW9uc2hpcHMnLCBbXSk6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHJfaWQgPSBpbnQocmVsYXRpb25zaGlwWydpZCddKQogICAgICAgICAgICBleGNlcHQgS2V5RXJyb3I6CiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgdXNlci5fcmVsYXRpb25zaGlwc1tyX2lkXSA9IFJlbGF0aW9uc2hpcChzdGF0ZT1zZWxmLCBkYXRhPXJlbGF0aW9uc2hpcCkKCiAgICAgICAgZm9yIHBtIGluIGRhdGEuZ2V0KCdwcml2YXRlX2NoYW5uZWxzJywgW10pOgogICAgICAgICAgICBmYWN0b3J5LCBfID0gX2NoYW5uZWxfZmFjdG9yeShwbVsndHlwZSddKQogICAgICAgICAgICBzZWxmLl9hZGRfcHJpdmF0ZV9jaGFubmVsKGZhY3RvcnkobWU9dXNlciwgZGF0YT1wbSwgc3RhdGU9c2VsZikpCgogICAgICAgIHNlbGYuZGlzcGF0Y2goJ2Nvbm5lY3QnKQogICAgICAgIHNlbGYuX3JlYWR5X3Rhc2sgPSBhc3luY2lvLmVuc3VyZV9mdXR1cmUoc2VsZi5fZGVsYXlfcmVhZHkoKSwgbG9vcD1zZWxmLmxvb3ApCgogICAgZGVmIHBhcnNlX3Jlc3VtZWQoc2VsZiwgZGF0YSk6CiAgICAgICAgc2VsZi5kaXNwYXRjaCgncmVzdW1lZCcpCgogICAgZGVmIHBhcnNlX21lc3NhZ2VfY3JlYXRlKHNlbGYsIGRhdGEpOgogICAgICAgIGNoYW5uZWwsIF8gPSBzZWxmLl9nZXRfZ3VpbGRfY2hhbm5lbChkYXRhKQogICAgICAgIG1lc3NhZ2UgPSBNZXNzYWdlKGNoYW5uZWw9Y2hhbm5lbCwgZGF0YT1kYXRhLCBzdGF0ZT1zZWxmKQogICAgICAgIHNlbGYuZGlzcGF0Y2goJ21lc3NhZ2UnLCBtZXNzYWdlKQogICAgICAgIGlmIHNlbGYuX21lc3NhZ2VzIGlzIG5vdCBOb25lOgogICAgICAgICAgICBzZWxmLl9tZXNzYWdlcy5hcHBlbmQobWVzc2FnZSkKICAgICAgICBpZiBjaGFubmVsIGFuZCBjaGFubmVsLl9fY2xhc3NfXyBpcyBUZXh0Q2hhbm5lbDoKICAgICAgICAgICAgY2hhbm5lbC5sYXN0X21lc3NhZ2VfaWQgPSBtZXNzYWdlLmlkCgogICAgZGVmIHBhcnNlX21lc3NhZ2VfZGVsZXRlKHNlbGYsIGRhdGEpOgogICAgICAgIHJhdyA9IFJhd01lc3NhZ2VEZWxldGVFdmVudChkYXRhKQogICAgICAgIGZvdW5kID0gc2VsZi5fZ2V0X21lc3NhZ2UocmF3Lm1lc3NhZ2VfaWQpCiAgICAgICAgcmF3LmNhY2hlZF9tZXNzYWdlID0gZm91bmQKICAgICAgICBzZWxmLmRpc3BhdGNoKCdyYXdfbWVzc2FnZV9kZWxldGUnLCByYXcpCiAgICAgICAgaWYgc2VsZi5fbWVzc2FnZXMgaXMgbm90IE5vbmUgYW5kIGZvdW5kIGlzIG5vdCBOb25lOgogICAgICAgICAgICBzZWxmLmRpc3BhdGNoKCdtZXNzYWdlX2RlbGV0ZScsIGZvdW5kKQogICAgICAgICAgICBzZWxmLl9tZXNzYWdlcy5yZW1vdmUoZm91bmQpCgogICAgZGVmIHBhcnNlX21lc3NhZ2VfZGVsZXRlX2J1bGsoc2VsZiwgZGF0YSk6CiAgICAgICAgcmF3ID0gUmF3QnVsa01lc3NhZ2VEZWxldGVFdmVudChkYXRhKQogICAgICAgIGlmIHNlbGYuX21lc3NhZ2VzOgogICAgICAgICAgICBmb3VuZF9tZXNzYWdlcyA9IFttZXNzYWdlIGZvciBtZXNzYWdlIGluIHNlbGYuX21lc3NhZ2VzIGlmIG1lc3NhZ2UuaWQgaW4gcmF3Lm1lc3NhZ2VfaWRzXQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGZvdW5kX21lc3NhZ2VzID0gW10KICAgICAgICByYXcuY2FjaGVkX21lc3NhZ2VzID0gZm91bmRfbWVzc2FnZXMKICAgICAgICBzZWxmLmRpc3BhdGNoKCdyYXdfYnVsa19tZXNzYWdlX2RlbGV0ZScsIHJhdykKICAgICAgICBpZiBmb3VuZF9tZXNzYWdlczoKICAgICAgICAgICAgc2VsZi5kaXNwYXRjaCgnYnVsa19tZXNzYWdlX2RlbGV0ZScsIGZvdW5kX21lc3NhZ2VzKQogICAgICAgICAgICBmb3IgbXNnIGluIGZvdW5kX21lc3NhZ2VzOgogICAgICAgICAgICAgICAgc2VsZi5fbWVzc2FnZXMucmVtb3ZlKG1zZykKCiAgICBkZWYgcGFyc2VfbWVzc2FnZV91cGRhdGUoc2VsZiwgZGF0YSk6CiAgICAgICAgcmF3ID0gUmF3TWVzc2FnZVVwZGF0ZUV2ZW50KGRhdGEpCiAgICAgICAgbWVzc2FnZSA9IHNlbGYuX2dldF9tZXNzYWdlKHJhdy5tZXNzYWdlX2lkKQogICAgICAgIGlmIG1lc3NhZ2UgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIG9sZGVyX21lc3NhZ2UgPSBjb3B5LmNvcHkobWVzc2FnZSkKICAgICAgICAgICAgcmF3LmNhY2hlZF9tZXNzYWdlID0gb2xkZXJfbWVzc2FnZQogICAgICAgICAgICBzZWxmLmRpc3BhdGNoKCdyYXdfbWVzc2FnZV9lZGl0JywgcmF3KQogICAgICAgICAgICBtZXNzYWdlLl91cGRhdGUoZGF0YSkKICAgICAgICAgICAgIyBDb2VyY2UgdGhlIGBhZnRlcmAgcGFyYW1ldGVyIHRvIHRha2UgdGhlIG5ldyB1cGRhdGVkIE1lbWJlcgogICAgICAgICAgICAjIHJlZjogIzU5OTkKICAgICAgICAgICAgb2xkZXJfbWVzc2FnZS5hdXRob3IgPSBtZXNzYWdlLmF1dGhvcgogICAgICAgICAgICBzZWxmLmRpc3BhdGNoKCdtZXNzYWdlX2VkaXQnLCBvbGRlcl9tZXNzYWdlLCBtZXNzYWdlKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHNlbGYuZGlzcGF0Y2goJ3Jhd19tZXNzYWdlX2VkaXQnLCByYXcpCgogICAgZGVmIHBhcnNlX21lc3NhZ2VfcmVhY3Rpb25fYWRkKHNlbGYsIGRhdGEpOgogICAgICAgIGVtb2ppID0gZGF0YVsnZW1vamknXQogICAgICAgIGVtb2ppX2lkID0gdXRpbHMuX2dldF9hc19zbm93Zmxha2UoZW1vamksICdpZCcpCiAgICAgICAgZW1vamkgPSBQYXJ0aWFsRW1vamkud2l0aF9zdGF0ZShzZWxmLCBpZD1lbW9qaV9pZCwgYW5pbWF0ZWQ9ZW1vamkuZ2V0KCdhbmltYXRlZCcsIEZhbHNlKSwgbmFtZT1lbW9qaVsnbmFtZSddKQogICAgICAgIHJhdyA9IFJhd1JlYWN0aW9uQWN0aW9uRXZlbnQoZGF0YSwgZW1vamksICdSRUFDVElPTl9BREQnKQoKICAgICAgICBtZW1iZXJfZGF0YSA9IGRhdGEuZ2V0KCdtZW1iZXInKQogICAgICAgIGlmIG1lbWJlcl9kYXRhOgogICAgICAgICAgICBndWlsZCA9IHNlbGYuX2dldF9ndWlsZChyYXcuZ3VpbGRfaWQpCiAgICAgICAgICAgIHJhdy5tZW1iZXIgPSBNZW1iZXIoZGF0YT1tZW1iZXJfZGF0YSwgZ3VpbGQ9Z3VpbGQsIHN0YXRlPXNlbGYpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmF3Lm1lbWJlciA9IE5vbmUKICAgICAgICBzZWxmLmRpc3BhdGNoKCdyYXdfcmVhY3Rpb25fYWRkJywgcmF3KQoKICAgICAgICAjIHJpY2ggaW50ZXJmYWNlIGhlcmUKICAgICAgICBtZXNzYWdlID0gc2VsZi5fZ2V0X21lc3NhZ2UocmF3Lm1lc3NhZ2VfaWQpCiAgICAgICAgaWYgbWVzc2FnZSBpcyBub3QgTm9uZToKICAgICAgICAgICAgZW1vamkgPSBzZWxmLl91cGdyYWRlX3BhcnRpYWxfZW1vamkoZW1vamkpCiAgICAgICAgICAgIHJlYWN0aW9uID0gbWVzc2FnZS5fYWRkX3JlYWN0aW9uKGRhdGEsIGVtb2ppLCByYXcudXNlcl9pZCkKICAgICAgICAgICAgdXNlciA9IHJhdy5tZW1iZXIgb3Igc2VsZi5fZ2V0X3JlYWN0aW9uX3VzZXIobWVzc2FnZS5jaGFubmVsLCByYXcudXNlcl9pZCkKCiAgICAgICAgICAgIGlmIHVzZXI6CiAgICAgICAgICAgICAgICBzZWxmLmRpc3BhdGNoKCdyZWFjdGlvbl9hZGQnLCByZWFjdGlvbiwgdXNlcikKCiAgICBkZWYgcGFyc2VfbWVzc2FnZV9yZWFjdGlvbl9yZW1vdmVfYWxsKHNlbGYsIGRhdGEpOgogICAgICAgIHJhdyA9IFJhd1JlYWN0aW9uQ2xlYXJFdmVudChkYXRhKQogICAgICAgIHNlbGYuZGlzcGF0Y2goJ3Jhd19yZWFjdGlvbl9jbGVhcicsIHJhdykKCiAgICAgICAgbWVzc2FnZSA9IHNlbGYuX2dldF9tZXNzYWdlKHJhdy5tZXNzYWdlX2lkKQogICAgICAgIGlmIG1lc3NhZ2UgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIG9sZF9yZWFjdGlvbnMgPSBtZXNzYWdlLnJlYWN0aW9ucy5jb3B5KCkKICAgICAgICAgICAgbWVzc2FnZS5yZWFjdGlvbnMuY2xlYXIoKQogICAgICAgICAgICBzZWxmLmRpc3BhdGNoKCdyZWFjdGlvbl9jbGVhcicsIG1lc3NhZ2UsIG9sZF9yZWFjdGlvbnMpCgogICAgZGVmIHBhcnNlX21lc3NhZ2VfcmVhY3Rpb25fcmVtb3ZlKHNlbGYsIGRhdGEpOgogICAgICAgIGVtb2ppID0gZGF0YVsnZW1vamknXQogICAgICAgIGVtb2ppX2lkID0gdXRpbHMuX2dldF9hc19zbm93Zmxha2UoZW1vamksICdpZCcpCiAgICAgICAgZW1vamkgPSBQYXJ0aWFsRW1vamkud2l0aF9zdGF0ZShzZWxmLCBpZD1lbW9qaV9pZCwgbmFtZT1lbW9qaVsnbmFtZSddKQogICAgICAgIHJhdyA9IFJhd1JlYWN0aW9uQWN0aW9uRXZlbnQoZGF0YSwgZW1vamksICdSRUFDVElPTl9SRU1PVkUnKQogICAgICAgIHNlbGYuZGlzcGF0Y2goJ3Jhd19yZWFjdGlvbl9yZW1vdmUnLCByYXcpCgogICAgICAgIG1lc3NhZ2UgPSBzZWxmLl9nZXRfbWVzc2FnZShyYXcubWVzc2FnZV9pZCkKICAgICAgICBpZiBtZXNzYWdlIGlzIG5vdCBOb25lOgogICAgICAgICAgICBlbW9qaSA9IHNlbGYuX3VwZ3JhZGVfcGFydGlhbF9lbW9qaShlbW9qaSkKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgcmVhY3Rpb24gPSBtZXNzYWdlLl9yZW1vdmVfcmVhY3Rpb24oZGF0YSwgZW1vamksIHJhdy51c2VyX2lkKQogICAgICAgICAgICBleGNlcHQgKEF0dHJpYnV0ZUVycm9yLCBWYWx1ZUVycm9yKTogIyBldmVudHVhbCBjb25zaXN0ZW5jeSBsb2wKICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHVzZXIgPSBzZWxmLl9nZXRfcmVhY3Rpb25fdXNlcihtZXNzYWdlLmNoYW5uZWwsIHJhdy51c2VyX2lkKQogICAgICAgICAgICAgICAgaWYgdXNlcjoKICAgICAgICAgICAgICAgICAgICBzZWxmLmRpc3BhdGNoKCdyZWFjdGlvbl9yZW1vdmUnLCByZWFjdGlvbiwgdXNlcikKCiAgICBkZWYgcGFyc2VfbWVzc2FnZV9yZWFjdGlvbl9yZW1vdmVfZW1vamkoc2VsZiwgZGF0YSk6CiAgICAgICAgZW1vamkgPSBkYXRhWydlbW9qaSddCiAgICAgICAgZW1vamlfaWQgPSB1dGlscy5fZ2V0X2FzX3Nub3dmbGFrZShlbW9qaSwgJ2lkJykKICAgICAgICBlbW9qaSA9IFBhcnRpYWxFbW9qaS53aXRoX3N0YXRlKHNlbGYsIGlkPWVtb2ppX2lkLCBuYW1lPWVtb2ppWyduYW1lJ10pCiAgICAgICAgcmF3ID0gUmF3UmVhY3Rpb25DbGVhckVtb2ppRXZlbnQoZGF0YSwgZW1vamkpCiAgICAgICAgc2VsZi5kaXNwYXRjaCgncmF3X3JlYWN0aW9uX2NsZWFyX2Vtb2ppJywgcmF3KQoKICAgICAgICBtZXNzYWdlID0gc2VsZi5fZ2V0X21lc3NhZ2UocmF3Lm1lc3NhZ2VfaWQpCiAgICAgICAgaWYgbWVzc2FnZSBpcyBub3QgTm9uZToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgcmVhY3Rpb24gPSBtZXNzYWdlLl9jbGVhcl9lbW9qaShlbW9qaSkKICAgICAgICAgICAgZXhjZXB0IChBdHRyaWJ1dGVFcnJvciwgVmFsdWVFcnJvcik6ICMgZXZlbnR1YWwgY29uc2lzdGVuY3kgbG9sCiAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBpZiByZWFjdGlvbjoKICAgICAgICAgICAgICAgICAgICBzZWxmLmRpc3BhdGNoKCdyZWFjdGlvbl9jbGVhcl9lbW9qaScsIHJlYWN0aW9uKQoKICAgIGRlZiBwYXJzZV9wcmVzZW5jZV91cGRhdGUoc2VsZiwgZGF0YSk6CiAgICAgICAgZ3VpbGRfaWQgPSB1dGlscy5fZ2V0X2FzX3Nub3dmbGFrZShkYXRhLCAnZ3VpbGRfaWQnKQogICAgICAgIGd1aWxkID0gc2VsZi5fZ2V0X2d1aWxkKGd1aWxkX2lkKQogICAgICAgIGlmIGd1aWxkIGlzIE5vbmU6CiAgICAgICAgICAgIGxvZy5kZWJ1ZygnUFJFU0VOQ0VfVVBEQVRFIHJlZmVyZW5jaW5nIGFuIHVua25vd24gZ3VpbGQgSUQ6ICVzLiBEaXNjYXJkaW5nLicsIGd1aWxkX2lkKQogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgdXNlciA9IGRhdGFbJ3VzZXInXQogICAgICAgIG1lbWJlcl9pZCA9IGludCh1c2VyWydpZCddKQogICAgICAgIG1lbWJlciA9IGd1aWxkLmdldF9tZW1iZXIobWVtYmVyX2lkKQogICAgICAgIGZsYWdzID0gc2VsZi5tZW1iZXJfY2FjaGVfZmxhZ3MKICAgICAgICBpZiBtZW1iZXIgaXMgTm9uZToKICAgICAgICAgICAgaWYgJ3VzZXJuYW1lJyBub3QgaW4gdXNlcjoKICAgICAgICAgICAgICAgICMgc29tZXRpbWVzIHdlIHJlY2VpdmUgJ2luY29tcGxldGUnIG1lbWJlciBkYXRhIHBvc3QtcmVtb3ZhbC4KICAgICAgICAgICAgICAgICMgc2tpcCB0aGVzZSB1c2VsZXNzIGNhc2VzLgogICAgICAgICAgICAgICAgcmV0dXJuCgogICAgICAgICAgICBtZW1iZXIsIG9sZF9tZW1iZXIgPSBNZW1iZXIuX2Zyb21fcHJlc2VuY2VfdXBkYXRlKGd1aWxkPWd1aWxkLCBkYXRhPWRhdGEsIHN0YXRlPXNlbGYpCiAgICAgICAgICAgIGlmIGZsYWdzLm9ubGluZSBvciAoZmxhZ3MuX29ubGluZV9vbmx5IGFuZCBtZW1iZXIucmF3X3N0YXR1cyAhPSAnb2ZmbGluZScpOgogICAgICAgICAgICAgICAgZ3VpbGQuX2FkZF9tZW1iZXIobWVtYmVyKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIG9sZF9tZW1iZXIgPSBNZW1iZXIuX2NvcHkobWVtYmVyKQogICAgICAgICAgICB1c2VyX3VwZGF0ZSA9IG1lbWJlci5fcHJlc2VuY2VfdXBkYXRlKGRhdGE9ZGF0YSwgdXNlcj11c2VyKQogICAgICAgICAgICBpZiB1c2VyX3VwZGF0ZToKICAgICAgICAgICAgICAgIHNlbGYuZGlzcGF0Y2goJ3VzZXJfdXBkYXRlJywgdXNlcl91cGRhdGVbMF0sIHVzZXJfdXBkYXRlWzFdKQoKICAgICAgICAgICAgaWYgbWVtYmVyLmlkICE9IHNlbGYuc2VsZl9pZCBhbmQgZmxhZ3MuX29ubGluZV9vbmx5IGFuZCBtZW1iZXIucmF3X3N0YXR1cyA9PSAnb2ZmbGluZSc6CiAgICAgICAgICAgICAgICBndWlsZC5fcmVtb3ZlX21lbWJlcihtZW1iZXIpCgogICAgICAgIHNlbGYuZGlzcGF0Y2goJ21lbWJlcl91cGRhdGUnLCBvbGRfbWVtYmVyLCBtZW1iZXIpCgogICAgZGVmIHBhcnNlX3VzZXJfdXBkYXRlKHNlbGYsIGRhdGEpOgogICAgICAgIHNlbGYudXNlci5fdXBkYXRlKGRhdGEpCgogICAgZGVmIHBhcnNlX2ludml0ZV9jcmVhdGUoc2VsZiwgZGF0YSk6CiAgICAgICAgaW52aXRlID0gSW52aXRlLmZyb21fZ2F0ZXdheShzdGF0ZT1zZWxmLCBkYXRhPWRhdGEpCiAgICAgICAgc2VsZi5kaXNwYXRjaCgnaW52aXRlX2NyZWF0ZScsIGludml0ZSkKCiAgICBkZWYgcGFyc2VfaW52aXRlX2RlbGV0ZShzZWxmLCBkYXRhKToKICAgICAgICBpbnZpdGUgPSBJbnZpdGUuZnJvbV9nYXRld2F5KHN0YXRlPXNlbGYsIGRhdGE9ZGF0YSkKICAgICAgICBzZWxmLmRpc3BhdGNoKCdpbnZpdGVfZGVsZXRlJywgaW52aXRlKQoKICAgIGRlZiBwYXJzZV9jaGFubmVsX2RlbGV0ZShzZWxmLCBkYXRhKToKICAgICAgICBndWlsZCA9IHNlbGYuX2dldF9ndWlsZCh1dGlscy5fZ2V0X2FzX3Nub3dmbGFrZShkYXRhLCAnZ3VpbGRfaWQnKSkKICAgICAgICBjaGFubmVsX2lkID0gaW50KGRhdGFbJ2lkJ10pCiAgICAgICAgaWYgZ3VpbGQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIGNoYW5uZWwgPSBndWlsZC5nZXRfY2hhbm5lbChjaGFubmVsX2lkKQogICAgICAgICAgICBpZiBjaGFubmVsIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgZ3VpbGQuX3JlbW92ZV9jaGFubmVsKGNoYW5uZWwpCiAgICAgICAgICAgICAgICBzZWxmLmRpc3BhdGNoKCdndWlsZF9jaGFubmVsX2RlbGV0ZScsIGNoYW5uZWwpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgIyB0aGUgcmVhc29uIHdlJ3JlIGRvaW5nIHRoaXMgaXMgc28gaXQncyBhbHNvIHJlbW92ZWQgZnJvbSB0aGUKICAgICAgICAgICAgIyBwcml2YXRlIGNoYW5uZWwgYnkgdXNlciBjYWNoZSBhcyB3ZWxsCiAgICAgICAgICAgIGNoYW5uZWwgPSBzZWxmLl9nZXRfcHJpdmF0ZV9jaGFubmVsKGNoYW5uZWxfaWQpCiAgICAgICAgICAgIGlmIGNoYW5uZWwgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICBzZWxmLl9yZW1vdmVfcHJpdmF0ZV9jaGFubmVsKGNoYW5uZWwpCiAgICAgICAgICAgICAgICBzZWxmLmRpc3BhdGNoKCdwcml2YXRlX2NoYW5uZWxfZGVsZXRlJywgY2hhbm5lbCkKCiAgICBkZWYgcGFyc2VfY2hhbm5lbF91cGRhdGUoc2VsZiwgZGF0YSk6CiAgICAgICAgY2hhbm5lbF90eXBlID0gdHJ5X2VudW0oQ2hhbm5lbFR5cGUsIGRhdGEuZ2V0KCd0eXBlJykpCiAgICAgICAgY2hhbm5lbF9pZCA9IGludChkYXRhWydpZCddKQogICAgICAgIGlmIGNoYW5uZWxfdHlwZSBpcyBDaGFubmVsVHlwZS5ncm91cDoKICAgICAgICAgICAgY2hhbm5lbCA9IHNlbGYuX2dldF9wcml2YXRlX2NoYW5uZWwoY2hhbm5lbF9pZCkKICAgICAgICAgICAgb2xkX2NoYW5uZWwgPSBjb3B5LmNvcHkoY2hhbm5lbCkKICAgICAgICAgICAgY2hhbm5lbC5fdXBkYXRlX2dyb3VwKGRhdGEpCiAgICAgICAgICAgIHNlbGYuZGlzcGF0Y2goJ3ByaXZhdGVfY2hhbm5lbF91cGRhdGUnLCBvbGRfY2hhbm5lbCwgY2hhbm5lbCkKICAgICAgICAgICAgcmV0dXJuCgogICAgICAgIGd1aWxkX2lkID0gdXRpbHMuX2dldF9hc19zbm93Zmxha2UoZGF0YSwgJ2d1aWxkX2lkJykKICAgICAgICBndWlsZCA9IHNlbGYuX2dldF9ndWlsZChndWlsZF9pZCkKICAgICAgICBpZiBndWlsZCBpcyBub3QgTm9uZToKICAgICAgICAgICAgY2hhbm5lbCA9IGd1aWxkLmdldF9jaGFubmVsKGNoYW5uZWxfaWQpCiAgICAgICAgICAgIGlmIGNoYW5uZWwgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICBvbGRfY2hhbm5lbCA9IGNvcHkuY29weShjaGFubmVsKQogICAgICAgICAgICAgICAgY2hhbm5lbC5fdXBkYXRlKGd1aWxkLCBkYXRhKQogICAgICAgICAgICAgICAgc2VsZi5kaXNwYXRjaCgnZ3VpbGRfY2hhbm5lbF91cGRhdGUnLCBvbGRfY2hhbm5lbCwgY2hhbm5lbCkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGxvZy5kZWJ1ZygnQ0hBTk5FTF9VUERBVEUgcmVmZXJlbmNpbmcgYW4gdW5rbm93biBjaGFubmVsIElEOiAlcy4gRGlzY2FyZGluZy4nLCBjaGFubmVsX2lkKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGxvZy5kZWJ1ZygnQ0hBTk5FTF9VUERBVEUgcmVmZXJlbmNpbmcgYW4gdW5rbm93biBndWlsZCBJRDogJXMuIERpc2NhcmRpbmcuJywgZ3VpbGRfaWQpCgogICAgZGVmIHBhcnNlX2NoYW5uZWxfY3JlYXRlKHNlbGYsIGRhdGEpOgogICAgICAgIGZhY3RvcnksIGNoX3R5cGUgPSBfY2hhbm5lbF9mYWN0b3J5KGRhdGFbJ3R5cGUnXSkKICAgICAgICBpZiBmYWN0b3J5IGlzIE5vbmU6CiAgICAgICAgICAgIGxvZy5kZWJ1ZygnQ0hBTk5FTF9DUkVBVEUgcmVmZXJlbmNpbmcgYW4gdW5rbm93biBjaGFubmVsIHR5cGUgJXMuIERpc2NhcmRpbmcuJywgZGF0YVsndHlwZSddKQogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgaWYgY2hfdHlwZSBpbiAoQ2hhbm5lbFR5cGUuZ3JvdXAsIENoYW5uZWxUeXBlLnByaXZhdGUpOgogICAgICAgICAgICBjaGFubmVsX2lkID0gaW50KGRhdGFbJ2lkJ10pCiAgICAgICAgICAgIGlmIHNlbGYuX2dldF9wcml2YXRlX2NoYW5uZWwoY2hhbm5lbF9pZCkgaXMgTm9uZToKICAgICAgICAgICAgICAgIGNoYW5uZWwgPSBmYWN0b3J5KG1lPXNlbGYudXNlciwgZGF0YT1kYXRhLCBzdGF0ZT1zZWxmKQogICAgICAgICAgICAgICAgc2VsZi5fYWRkX3ByaXZhdGVfY2hhbm5lbChjaGFubmVsKQogICAgICAgICAgICAgICAgc2VsZi5kaXNwYXRjaCgncHJpdmF0ZV9jaGFubmVsX2NyZWF0ZScsIGNoYW5uZWwpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgZ3VpbGRfaWQgPSB1dGlscy5fZ2V0X2FzX3Nub3dmbGFrZShkYXRhLCAnZ3VpbGRfaWQnKQogICAgICAgICAgICBndWlsZCA9IHNlbGYuX2dldF9ndWlsZChndWlsZF9pZCkKICAgICAgICAgICAgaWYgZ3VpbGQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICBjaGFubmVsID0gZmFjdG9yeShndWlsZD1ndWlsZCwgc3RhdGU9c2VsZiwgZGF0YT1kYXRhKQogICAgICAgICAgICAgICAgZ3VpbGQuX2FkZF9jaGFubmVsKGNoYW5uZWwpCiAgICAgICAgICAgICAgICBzZWxmLmRpc3BhdGNoKCdndWlsZF9jaGFubmVsX2NyZWF0ZScsIGNoYW5uZWwpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBsb2cuZGVidWcoJ0NIQU5ORUxfQ1JFQVRFIHJlZmVyZW5jaW5nIGFuIHVua25vd24gZ3VpbGQgSUQ6ICVzLiBEaXNjYXJkaW5nLicsIGd1aWxkX2lkKQogICAgICAgICAgICAgICAgcmV0dXJuCgogICAgZGVmIHBhcnNlX2NoYW5uZWxfcGluc191cGRhdGUoc2VsZiwgZGF0YSk6CiAgICAgICAgY2hhbm5lbF9pZCA9IGludChkYXRhWydjaGFubmVsX2lkJ10pCiAgICAgICAgY2hhbm5lbCA9IHNlbGYuZ2V0X2NoYW5uZWwoY2hhbm5lbF9pZCkKICAgICAgICBpZiBjaGFubmVsIGlzIE5vbmU6CiAgICAgICAgICAgIGxvZy5kZWJ1ZygnQ0hBTk5FTF9QSU5TX1VQREFURSByZWZlcmVuY2luZyBhbiB1bmtub3duIGNoYW5uZWwgSUQ6ICVzLiBEaXNjYXJkaW5nLicsIGNoYW5uZWxfaWQpCiAgICAgICAgICAgIHJldHVybgoKICAgICAgICBsYXN0X3BpbiA9IHV0aWxzLnBhcnNlX3RpbWUoZGF0YVsnbGFzdF9waW5fdGltZXN0YW1wJ10pIGlmIGRhdGFbJ2xhc3RfcGluX3RpbWVzdGFtcCddIGVsc2UgTm9uZQoKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgSSBoYXZlIG5vdCBpbXBvcnRlZCBkaXNjb3JkLmFiYyBpbiB0aGlzIGZpbGUKICAgICAgICAgICAgIyB0aGUgaXNpbnN0YW5jZSBjaGVjayBpcyBhbHNvIDJ4IHNsb3dlciB0aGFuIGp1c3QgY2hlY2tpbmcgdGhpcyBhdHRyaWJ1dGUKICAgICAgICAgICAgIyBzbyB3ZSdyZSBqdXN0IGdvbm5hIGNoZWNrIGl0IHNpbmNlIGl0J3MgZWFzaWVyIGFuZCBmYXN0ZXIgYW5kIGxhemllcgogICAgICAgICAgICBjaGFubmVsLmd1aWxkCiAgICAgICAgZXhjZXB0IEF0dHJpYnV0ZUVycm9yOgogICAgICAgICAgICBzZWxmLmRpc3BhdGNoKCdwcml2YXRlX2NoYW5uZWxfcGluc191cGRhdGUnLCBjaGFubmVsLCBsYXN0X3BpbikKICAgICAgICBlbHNlOgogICAgICAgICAgICBzZWxmLmRpc3BhdGNoKCdndWlsZF9jaGFubmVsX3BpbnNfdXBkYXRlJywgY2hhbm5lbCwgbGFzdF9waW4pCgogICAgZGVmIHBhcnNlX2NoYW5uZWxfcmVjaXBpZW50X2FkZChzZWxmLCBkYXRhKToKICAgICAgICBjaGFubmVsID0gc2VsZi5fZ2V0X3ByaXZhdGVfY2hhbm5lbChpbnQoZGF0YVsnY2hhbm5lbF9pZCddKSkKICAgICAgICB1c2VyID0gc2VsZi5zdG9yZV91c2VyKGRhdGFbJ3VzZXInXSkKICAgICAgICBjaGFubmVsLnJlY2lwaWVudHMuYXBwZW5kKHVzZXIpCiAgICAgICAgc2VsZi5kaXNwYXRjaCgnZ3JvdXBfam9pbicsIGNoYW5uZWwsIHVzZXIpCgogICAgZGVmIHBhcnNlX2NoYW5uZWxfcmVjaXBpZW50X3JlbW92ZShzZWxmLCBkYXRhKToKICAgICAgICBjaGFubmVsID0gc2VsZi5fZ2V0X3ByaXZhdGVfY2hhbm5lbChpbnQoZGF0YVsnY2hhbm5lbF9pZCddKSkKICAgICAgICB1c2VyID0gc2VsZi5zdG9yZV91c2VyKGRhdGFbJ3VzZXInXSkKICAgICAgICB0cnk6CiAgICAgICAgICAgIGNoYW5uZWwucmVjaXBpZW50cy5yZW1vdmUodXNlcikKICAgICAgICBleGNlcHQgVmFsdWVFcnJvcjoKICAgICAgICAgICAgcGFzcwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHNlbGYuZGlzcGF0Y2goJ2dyb3VwX3JlbW92ZScsIGNoYW5uZWwsIHVzZXIpCgogICAgZGVmIHBhcnNlX2d1aWxkX21lbWJlcl9hZGQoc2VsZiwgZGF0YSk6CiAgICAgICAgZ3VpbGQgPSBzZWxmLl9nZXRfZ3VpbGQoaW50KGRhdGFbJ2d1aWxkX2lkJ10pKQogICAgICAgIGlmIGd1aWxkIGlzIE5vbmU6CiAgICAgICAgICAgIGxvZy5kZWJ1ZygnR1VJTERfTUVNQkVSX0FERCByZWZlcmVuY2luZyBhbiB1bmtub3duIGd1aWxkIElEOiAlcy4gRGlzY2FyZGluZy4nLCBkYXRhWydndWlsZF9pZCddKQogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgbWVtYmVyID0gTWVtYmVyKGd1aWxkPWd1aWxkLCBkYXRhPWRhdGEsIHN0YXRlPXNlbGYpCiAgICAgICAgaWYgc2VsZi5tZW1iZXJfY2FjaGVfZmxhZ3Muam9pbmVkOgogICAgICAgICAgICBndWlsZC5fYWRkX21lbWJlcihtZW1iZXIpCgogICAgICAgIHRyeToKICAgICAgICAgICAgZ3VpbGQuX21lbWJlcl9jb3VudCArPSAxCiAgICAgICAgZXhjZXB0IEF0dHJpYnV0ZUVycm9yOgogICAgICAgICAgICBwYXNzCgogICAgICAgIHNlbGYuZGlzcGF0Y2goJ21lbWJlcl9qb2luJywgbWVtYmVyKQoKICAgIGRlZiBwYXJzZV9ndWlsZF9tZW1iZXJfcmVtb3ZlKHNlbGYsIGRhdGEpOgogICAgICAgIGd1aWxkID0gc2VsZi5fZ2V0X2d1aWxkKGludChkYXRhWydndWlsZF9pZCddKSkKICAgICAgICBpZiBndWlsZCBpcyBub3QgTm9uZToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgZ3VpbGQuX21lbWJlcl9jb3VudCAtPSAxCiAgICAgICAgICAgIGV4Y2VwdCBBdHRyaWJ1dGVFcnJvcjoKICAgICAgICAgICAgICAgIHBhc3MKCiAgICAgICAgICAgIHVzZXJfaWQgPSBpbnQoZGF0YVsndXNlciddWydpZCddKQogICAgICAgICAgICBtZW1iZXIgPSBndWlsZC5nZXRfbWVtYmVyKHVzZXJfaWQpCiAgICAgICAgICAgIGlmIG1lbWJlciBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgIGd1aWxkLl9yZW1vdmVfbWVtYmVyKG1lbWJlcikKICAgICAgICAgICAgICAgIHNlbGYuZGlzcGF0Y2goJ21lbWJlcl9yZW1vdmUnLCBtZW1iZXIpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgbG9nLmRlYnVnKCdHVUlMRF9NRU1CRVJfUkVNT1ZFIHJlZmVyZW5jaW5nIGFuIHVua25vd24gZ3VpbGQgSUQ6ICVzLiBEaXNjYXJkaW5nLicsIGRhdGFbJ2d1aWxkX2lkJ10pCgogICAgZGVmIHBhcnNlX2d1aWxkX21lbWJlcl91cGRhdGUoc2VsZiwgZGF0YSk6CiAgICAgICAgZ3VpbGQgPSBzZWxmLl9nZXRfZ3VpbGQoaW50KGRhdGFbJ2d1aWxkX2lkJ10pKQogICAgICAgIHVzZXIgPSBkYXRhWyd1c2VyJ10KICAgICAgICB1c2VyX2lkID0gaW50KHVzZXJbJ2lkJ10pCiAgICAgICAgaWYgZ3VpbGQgaXMgTm9uZToKICAgICAgICAgICAgbG9nLmRlYnVnKCdHVUlMRF9NRU1CRVJfVVBEQVRFIHJlZmVyZW5jaW5nIGFuIHVua25vd24gZ3VpbGQgSUQ6ICVzLiBEaXNjYXJkaW5nLicsIGRhdGFbJ2d1aWxkX2lkJ10pCiAgICAgICAgICAgIHJldHVybgoKICAgICAgICBtZW1iZXIgPSBndWlsZC5nZXRfbWVtYmVyKHVzZXJfaWQpCiAgICAgICAgaWYgbWVtYmVyIGlzIG5vdCBOb25lOgogICAgICAgICAgICBvbGRfbWVtYmVyID0gTWVtYmVyLl9jb3B5KG1lbWJlcikKICAgICAgICAgICAgbWVtYmVyLl91cGRhdGUoZGF0YSkKICAgICAgICAgICAgdXNlcl91cGRhdGUgPSBtZW1iZXIuX3VwZGF0ZV9pbm5lcl91c2VyKHVzZXIpCiAgICAgICAgICAgIGlmIHVzZXJfdXBkYXRlOgogICAgICAgICAgICAgICAgc2VsZi5kaXNwYXRjaCgndXNlcl91cGRhdGUnLCB1c2VyX3VwZGF0ZVswXSwgdXNlcl91cGRhdGVbMV0pCgogICAgICAgICAgICBzZWxmLmRpc3BhdGNoKCdtZW1iZXJfdXBkYXRlJywgb2xkX21lbWJlciwgbWVtYmVyKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGlmIHNlbGYubWVtYmVyX2NhY2hlX2ZsYWdzLmpvaW5lZDoKICAgICAgICAgICAgICAgIG1lbWJlciA9IE1lbWJlcihkYXRhPWRhdGEsIGd1aWxkPWd1aWxkLCBzdGF0ZT1zZWxmKQoKICAgICAgICAgICAgICAgICMgRm9yY2UgYW4gdXBkYXRlIG9uIHRoZSBpbm5lciB1c2VyIGlmIG5lY2Vzc2FyeQogICAgICAgICAgICAgICAgdXNlcl91cGRhdGUgPSBtZW1iZXIuX3VwZGF0ZV9pbm5lcl91c2VyKHVzZXIpCiAgICAgICAgICAgICAgICBpZiB1c2VyX3VwZGF0ZToKICAgICAgICAgICAgICAgICAgICBzZWxmLmRpc3BhdGNoKCd1c2VyX3VwZGF0ZScsIHVzZXJfdXBkYXRlWzBdLCB1c2VyX3VwZGF0ZVsxXSkKCiAgICAgICAgICAgICAgICBndWlsZC5fYWRkX21lbWJlcihtZW1iZXIpCiAgICAgICAgICAgIGxvZy5kZWJ1ZygnR1VJTERfTUVNQkVSX1VQREFURSByZWZlcmVuY2luZyBhbiB1bmtub3duIG1lbWJlciBJRDogJXMuIERpc2NhcmRpbmcuJywgdXNlcl9pZCkKCiAgICBkZWYgcGFyc2VfZ3VpbGRfZW1vamlzX3VwZGF0ZShzZWxmLCBkYXRhKToKICAgICAgICBndWlsZCA9IHNlbGYuX2dldF9ndWlsZChpbnQoZGF0YVsnZ3VpbGRfaWQnXSkpCiAgICAgICAgaWYgZ3VpbGQgaXMgTm9uZToKICAgICAgICAgICAgbG9nLmRlYnVnKCdHVUlMRF9FTU9KSVNfVVBEQVRFIHJlZmVyZW5jaW5nIGFuIHVua25vd24gZ3VpbGQgSUQ6ICVzLiBEaXNjYXJkaW5nLicsIGRhdGFbJ2d1aWxkX2lkJ10pCiAgICAgICAgICAgIHJldHVybgoKICAgICAgICBiZWZvcmVfZW1vamlzID0gZ3VpbGQuZW1vamlzCiAgICAgICAgZm9yIGVtb2ppIGluIGJlZm9yZV9lbW9qaXM6CiAgICAgICAgICAgIHNlbGYuX2Vtb2ppcy5wb3AoZW1vamkuaWQsIE5vbmUpCiAgICAgICAgZ3VpbGQuZW1vamlzID0gdHVwbGUobWFwKGxhbWJkYSBkOiBzZWxmLnN0b3JlX2Vtb2ppKGd1aWxkLCBkKSwgZGF0YVsnZW1vamlzJ10pKQogICAgICAgIHNlbGYuZGlzcGF0Y2goJ2d1aWxkX2Vtb2ppc191cGRhdGUnLCBndWlsZCwgYmVmb3JlX2Vtb2ppcywgZ3VpbGQuZW1vamlzKQoKICAgIGRlZiBfZ2V0X2NyZWF0ZV9ndWlsZChzZWxmLCBkYXRhKToKICAgICAgICBpZiBkYXRhLmdldCgndW5hdmFpbGFibGUnKSBpcyBGYWxzZToKICAgICAgICAgICAgIyBHVUlMRF9DUkVBVEUgd2l0aCB1bmF2YWlsYWJsZSBpbiB0aGUgcmVzcG9uc2UKICAgICAgICAgICAgIyB1c3VhbGx5IG1lYW5zIHRoYXQgdGhlIGd1aWxkIGhhcyBiZWNvbWUgYXZhaWxhYmxlCiAgICAgICAgICAgICMgYW5kIGlzIHRoZXJlZm9yZSBpbiB0aGUgY2FjaGUKICAgICAgICAgICAgZ3VpbGQgPSBzZWxmLl9nZXRfZ3VpbGQoaW50KGRhdGFbJ2lkJ10pKQogICAgICAgICAgICBpZiBndWlsZCBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgIGd1aWxkLnVuYXZhaWxhYmxlID0gRmFsc2UKICAgICAgICAgICAgICAgIGd1aWxkLl9mcm9tX2RhdGEoZGF0YSkKICAgICAgICAgICAgICAgIHJldHVybiBndWlsZAoKICAgICAgICByZXR1cm4gc2VsZi5fYWRkX2d1aWxkX2Zyb21fZGF0YShkYXRhKQoKICAgIGRlZiBpc19ndWlsZF9ldmljdGVkKHNlbGYsIGd1aWxkKSAtPiBib29sOgogICAgICAgIHJldHVybiBndWlsZC5pZCBub3QgaW4gc2VsZi5fZ3VpbGRzCgogICAgYXN5bmMgZGVmIGNodW5rX2d1aWxkKHNlbGYsIGd1aWxkLCAqLCB3YWl0PVRydWUsIGNhY2hlPU5vbmUpOgogICAgICAgIGNhY2hlID0gY2FjaGUgb3Igc2VsZi5tZW1iZXJfY2FjaGVfZmxhZ3Muam9pbmVkCiAgICAgICAgcmVxdWVzdCA9IHNlbGYuX2NodW5rX3JlcXVlc3RzLmdldChndWlsZC5pZCkKICAgICAgICBpZiByZXF1ZXN0IGlzIE5vbmU6CiAgICAgICAgICAgIHNlbGYuX2NodW5rX3JlcXVlc3RzW2d1aWxkLmlkXSA9IHJlcXVlc3QgPSBDaHVua1JlcXVlc3QoZ3VpbGQuaWQsIHNlbGYubG9vcCwgc2VsZi5fZ2V0X2d1aWxkLCBjYWNoZT1jYWNoZSkKICAgICAgICAgICAgYXdhaXQgc2VsZi5jaHVua2VyKGd1aWxkLmlkLCBub25jZT1yZXF1ZXN0Lm5vbmNlKQoKICAgICAgICBpZiB3YWl0OgogICAgICAgICAgICByZXR1cm4gYXdhaXQgcmVxdWVzdC53YWl0KCkKICAgICAgICByZXR1cm4gcmVxdWVzdC5nZXRfZnV0dXJlKCkKCiAgICBhc3luYyBkZWYgX2NodW5rX2FuZF9kaXNwYXRjaChzZWxmLCBndWlsZCwgdW5hdmFpbGFibGUpOgogICAgICAgIHRyeToKICAgICAgICAgICAgYXdhaXQgYXN5bmNpby53YWl0X2ZvcihzZWxmLmNodW5rX2d1aWxkKGd1aWxkKSwgdGltZW91dD02MC4wKQogICAgICAgIGV4Y2VwdCBhc3luY2lvLlRpbWVvdXRFcnJvcjoKICAgICAgICAgICAgbG9nLmluZm8oJ1NvbWVob3cgdGltZWQgb3V0IHdhaXRpbmcgZm9yIGNodW5rcy4nKQoKICAgICAgICBpZiB1bmF2YWlsYWJsZSBpcyBGYWxzZToKICAgICAgICAgICAgc2VsZi5kaXNwYXRjaCgnZ3VpbGRfYXZhaWxhYmxlJywgZ3VpbGQpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgc2VsZi5kaXNwYXRjaCgnZ3VpbGRfam9pbicsIGd1aWxkKQoKICAgIGRlZiBwYXJzZV9ndWlsZF9jcmVhdGUoc2VsZiwgZGF0YSk6CiAgICAgICAgdW5hdmFpbGFibGUgPSBkYXRhLmdldCgndW5hdmFpbGFibGUnKQogICAgICAgIGlmIHVuYXZhaWxhYmxlIGlzIFRydWU6CiAgICAgICAgICAgICMgam9pbmVkIGEgZ3VpbGQgd2l0aCB1bmF2YWlsYWJsZSA9PSBUcnVlIHNvLi4KICAgICAgICAgICAgcmV0dXJuCgogICAgICAgIGd1aWxkID0gc2VsZi5fZ2V0X2NyZWF0ZV9ndWlsZChkYXRhKQoKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgTm90aWZ5IHRoZSBvbl9yZWFkeSBzdGF0ZSwgaWYgYW55LCB0aGF0IHRoaXMgZ3VpbGQgaXMgY29tcGxldGUuCiAgICAgICAgICAgIHNlbGYuX3JlYWR5X3N0YXRlLnB1dF9ub3dhaXQoZ3VpbGQpCiAgICAgICAgZXhjZXB0IEF0dHJpYnV0ZUVycm9yOgogICAgICAgICAgICBwYXNzCiAgICAgICAgZWxzZToKICAgICAgICAgICAgIyBJZiB3ZSdyZSB3YWl0aW5nIGZvciB0aGUgZXZlbnQsIHB1dCB0aGUgcmVzdCBvbiBob2xkCiAgICAgICAgICAgIHJldHVybgoKICAgICAgICAjIGNoZWNrIGlmIGl0IHJlcXVpcmVzIGNodW5raW5nCiAgICAgICAgaWYgc2VsZi5fZ3VpbGRfbmVlZHNfY2h1bmtpbmcoZ3VpbGQpOgogICAgICAgICAgICBhc3luY2lvLmVuc3VyZV9mdXR1cmUoc2VsZi5fY2h1bmtfYW5kX2Rpc3BhdGNoKGd1aWxkLCB1bmF2YWlsYWJsZSksIGxvb3A9c2VsZi5sb29wKQogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgIyBEaXNwYXRjaCBhdmFpbGFibGUgaWYgbmV3bHkgYXZhaWxhYmxlCiAgICAgICAgaWYgdW5hdmFpbGFibGUgaXMgRmFsc2U6CiAgICAgICAgICAgIHNlbGYuZGlzcGF0Y2goJ2d1aWxkX2F2YWlsYWJsZScsIGd1aWxkKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHNlbGYuZGlzcGF0Y2goJ2d1aWxkX2pvaW4nLCBndWlsZCkKCiAgICBkZWYgcGFyc2VfZ3VpbGRfc3luYyhzZWxmLCBkYXRhKToKICAgICAgICBndWlsZCA9IHNlbGYuX2dldF9ndWlsZChpbnQoZGF0YVsnaWQnXSkpCiAgICAgICAgZ3VpbGQuX3N5bmMoZGF0YSkKCiAgICBkZWYgcGFyc2VfZ3VpbGRfdXBkYXRlKHNlbGYsIGRhdGEpOgogICAgICAgIGd1aWxkID0gc2VsZi5fZ2V0X2d1aWxkKGludChkYXRhWydpZCddKSkKICAgICAgICBpZiBndWlsZCBpcyBub3QgTm9uZToKICAgICAgICAgICAgb2xkX2d1aWxkID0gY29weS5jb3B5KGd1aWxkKQogICAgICAgICAgICBndWlsZC5fZnJvbV9kYXRhKGRhdGEpCiAgICAgICAgICAgIHNlbGYuZGlzcGF0Y2goJ2d1aWxkX3VwZGF0ZScsIG9sZF9ndWlsZCwgZ3VpbGQpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgbG9nLmRlYnVnKCdHVUlMRF9VUERBVEUgcmVmZXJlbmNpbmcgYW4gdW5rbm93biBndWlsZCBJRDogJXMuIERpc2NhcmRpbmcuJywgZGF0YVsnaWQnXSkKCiAgICBkZWYgcGFyc2VfZ3VpbGRfZGVsZXRlKHNlbGYsIGRhdGEpOgogICAgICAgIGd1aWxkID0gc2VsZi5fZ2V0X2d1aWxkKGludChkYXRhWydpZCddKSkKICAgICAgICBpZiBndWlsZCBpcyBOb25lOgogICAgICAgICAgICBsb2cuZGVidWcoJ0dVSUxEX0RFTEVURSByZWZlcmVuY2luZyBhbiB1bmtub3duIGd1aWxkIElEOiAlcy4gRGlzY2FyZGluZy4nLCBkYXRhWydpZCddKQogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgaWYgZGF0YS5nZXQoJ3VuYXZhaWxhYmxlJywgRmFsc2UpOgogICAgICAgICAgICAjIEdVSUxEX0RFTEVURSB3aXRoIHVuYXZhaWxhYmxlIGJlaW5nIFRydWUgbWVhbnMgdGhhdCB0aGUKICAgICAgICAgICAgIyBndWlsZCB0aGF0IHdhcyBhdmFpbGFibGUgaXMgbm93IGN1cnJlbnRseSB1bmF2YWlsYWJsZQogICAgICAgICAgICBndWlsZC51bmF2YWlsYWJsZSA9IFRydWUKICAgICAgICAgICAgc2VsZi5kaXNwYXRjaCgnZ3VpbGRfdW5hdmFpbGFibGUnLCBndWlsZCkKICAgICAgICAgICAgcmV0dXJuCgogICAgICAgICMgZG8gYSBjbGVhbnVwIG9mIHRoZSBtZXNzYWdlcyBjYWNoZQogICAgICAgIGlmIHNlbGYuX21lc3NhZ2VzIGlzIG5vdCBOb25lOgogICAgICAgICAgICBzZWxmLl9tZXNzYWdlcyA9IGRlcXVlKChtc2cgZm9yIG1zZyBpbiBzZWxmLl9tZXNzYWdlcyBpZiBtc2cuZ3VpbGQgIT0gZ3VpbGQpLCBtYXhsZW49c2VsZi5tYXhfbWVzc2FnZXMpCgogICAgICAgIHNlbGYuX3JlbW92ZV9ndWlsZChndWlsZCkKICAgICAgICBzZWxmLmRpc3BhdGNoKCdndWlsZF9yZW1vdmUnLCBndWlsZCkKCiAgICBkZWYgcGFyc2VfZ3VpbGRfYmFuX2FkZChzZWxmLCBkYXRhKToKICAgICAgICAjIHdlIG1ha2UgdGhlIGFzc3VtcHRpb24gdGhhdCBHVUlMRF9CQU5fQUREIGlzIGRvbmUKICAgICAgICAjIGJlZm9yZSBHVUlMRF9NRU1CRVJfUkVNT1ZFIGlzIGNhbGxlZAogICAgICAgICMgaGVuY2Ugd2UgZG9uJ3QgcmVtb3ZlIGl0IGZyb20gY2FjaGUgb3IgZG8gYW55dGhpbmcKICAgICAgICAjIHN0cmFuZ2Ugd2l0aCBpdCwgdGhlIG1haW4gcHVycG9zZSBvZiB0aGlzIGV2ZW50CiAgICAgICAgIyBpcyBtYWlubHkgdG8gZGlzcGF0Y2ggdG8gYW5vdGhlciBldmVudCB3b3J0aCBsaXN0ZW5pbmcgdG8gZm9yIGxvZ2dpbmcKICAgICAgICBndWlsZCA9IHNlbGYuX2dldF9ndWlsZChpbnQoZGF0YVsnZ3VpbGRfaWQnXSkpCiAgICAgICAgaWYgZ3VpbGQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHVzZXIgPSBVc2VyKGRhdGE9ZGF0YVsndXNlciddLCBzdGF0ZT1zZWxmKQogICAgICAgICAgICBleGNlcHQgS2V5RXJyb3I6CiAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBtZW1iZXIgPSBndWlsZC5nZXRfbWVtYmVyKHVzZXIuaWQpIG9yIHVzZXIKICAgICAgICAgICAgICAgIHNlbGYuZGlzcGF0Y2goJ21lbWJlcl9iYW4nLCBndWlsZCwgbWVtYmVyKQoKICAgIGRlZiBwYXJzZV9ndWlsZF9iYW5fcmVtb3ZlKHNlbGYsIGRhdGEpOgogICAgICAgIGd1aWxkID0gc2VsZi5fZ2V0X2d1aWxkKGludChkYXRhWydndWlsZF9pZCddKSkKICAgICAgICBpZiBndWlsZCBpcyBub3QgTm9uZSBhbmQgJ3VzZXInIGluIGRhdGE6CiAgICAgICAgICAgIHVzZXIgPSBzZWxmLnN0b3JlX3VzZXIoZGF0YVsndXNlciddKQogICAgICAgICAgICBzZWxmLmRpc3BhdGNoKCdtZW1iZXJfdW5iYW4nLCBndWlsZCwgdXNlcikKCiAgICBkZWYgcGFyc2VfZ3VpbGRfcm9sZV9jcmVhdGUoc2VsZiwgZGF0YSk6CiAgICAgICAgZ3VpbGQgPSBzZWxmLl9nZXRfZ3VpbGQoaW50KGRhdGFbJ2d1aWxkX2lkJ10pKQogICAgICAgIGlmIGd1aWxkIGlzIE5vbmU6CiAgICAgICAgICAgIGxvZy5kZWJ1ZygnR1VJTERfUk9MRV9DUkVBVEUgcmVmZXJlbmNpbmcgYW4gdW5rbm93biBndWlsZCBJRDogJXMuIERpc2NhcmRpbmcuJywgZGF0YVsnZ3VpbGRfaWQnXSkKICAgICAgICAgICAgcmV0dXJuCgogICAgICAgIHJvbGVfZGF0YSA9IGRhdGFbJ3JvbGUnXQogICAgICAgIHJvbGUgPSBSb2xlKGd1aWxkPWd1aWxkLCBkYXRhPXJvbGVfZGF0YSwgc3RhdGU9c2VsZikKICAgICAgICBndWlsZC5fYWRkX3JvbGUocm9sZSkKICAgICAgICBzZWxmLmRpc3BhdGNoKCdndWlsZF9yb2xlX2NyZWF0ZScsIHJvbGUpCgogICAgZGVmIHBhcnNlX2d1aWxkX3JvbGVfZGVsZXRlKHNlbGYsIGRhdGEpOgogICAgICAgIGd1aWxkID0gc2VsZi5fZ2V0X2d1aWxkKGludChkYXRhWydndWlsZF9pZCddKSkKICAgICAgICBpZiBndWlsZCBpcyBub3QgTm9uZToKICAgICAgICAgICAgcm9sZV9pZCA9IGludChkYXRhWydyb2xlX2lkJ10pCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHJvbGUgPSBndWlsZC5fcmVtb3ZlX3JvbGUocm9sZV9pZCkKICAgICAgICAgICAgZXhjZXB0IEtleUVycm9yOgogICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBzZWxmLmRpc3BhdGNoKCdndWlsZF9yb2xlX2RlbGV0ZScsIHJvbGUpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgbG9nLmRlYnVnKCdHVUlMRF9ST0xFX0RFTEVURSByZWZlcmVuY2luZyBhbiB1bmtub3duIGd1aWxkIElEOiAlcy4gRGlzY2FyZGluZy4nLCBkYXRhWydndWlsZF9pZCddKQoKICAgIGRlZiBwYXJzZV9ndWlsZF9yb2xlX3VwZGF0ZShzZWxmLCBkYXRhKToKICAgICAgICBndWlsZCA9IHNlbGYuX2dldF9ndWlsZChpbnQoZGF0YVsnZ3VpbGRfaWQnXSkpCiAgICAgICAgaWYgZ3VpbGQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJvbGVfZGF0YSA9IGRhdGFbJ3JvbGUnXQogICAgICAgICAgICByb2xlX2lkID0gaW50KHJvbGVfZGF0YVsnaWQnXSkKICAgICAgICAgICAgcm9sZSA9IGd1aWxkLmdldF9yb2xlKHJvbGVfaWQpCiAgICAgICAgICAgIGlmIHJvbGUgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICBvbGRfcm9sZSA9IGNvcHkuY29weShyb2xlKQogICAgICAgICAgICAgICAgcm9sZS5fdXBkYXRlKHJvbGVfZGF0YSkKICAgICAgICAgICAgICAgIHNlbGYuZGlzcGF0Y2goJ2d1aWxkX3JvbGVfdXBkYXRlJywgb2xkX3JvbGUsIHJvbGUpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgbG9nLmRlYnVnKCdHVUlMRF9ST0xFX1VQREFURSByZWZlcmVuY2luZyBhbiB1bmtub3duIGd1aWxkIElEOiAlcy4gRGlzY2FyZGluZy4nLCBkYXRhWydndWlsZF9pZCddKQoKICAgIGRlZiBwYXJzZV9ndWlsZF9tZW1iZXJzX2NodW5rKHNlbGYsIGRhdGEpOgogICAgICAgIGd1aWxkX2lkID0gaW50KGRhdGFbJ2d1aWxkX2lkJ10pCiAgICAgICAgZ3VpbGQgPSBzZWxmLl9nZXRfZ3VpbGQoZ3VpbGRfaWQpCiAgICAgICAgcHJlc2VuY2VzID0gZGF0YS5nZXQoJ3ByZXNlbmNlcycsIFtdKQoKICAgICAgICBtZW1iZXJzID0gW01lbWJlcihndWlsZD1ndWlsZCwgZGF0YT1tZW1iZXIsIHN0YXRlPXNlbGYpIGZvciBtZW1iZXIgaW4gZGF0YS5nZXQoJ21lbWJlcnMnLCBbXSldCiAgICAgICAgbG9nLmRlYnVnKCdQcm9jZXNzZWQgYSBjaHVuayBmb3IgJXMgbWVtYmVycyBpbiBndWlsZCBJRCAlcy4nLCBsZW4obWVtYmVycyksIGd1aWxkX2lkKQoKICAgICAgICBpZiBwcmVzZW5jZXM6CiAgICAgICAgICAgIG1lbWJlcl9kaWN0ID0ge3N0cihtZW1iZXIuaWQpOiBtZW1iZXIgZm9yIG1lbWJlciBpbiBtZW1iZXJzfQogICAgICAgICAgICBmb3IgcHJlc2VuY2UgaW4gcHJlc2VuY2VzOgogICAgICAgICAgICAgICAgdXNlciA9IHByZXNlbmNlWyd1c2VyJ10KICAgICAgICAgICAgICAgIG1lbWJlcl9pZCA9IHVzZXJbJ2lkJ10KICAgICAgICAgICAgICAgIG1lbWJlciA9IG1lbWJlcl9kaWN0LmdldChtZW1iZXJfaWQpCiAgICAgICAgICAgICAgICBtZW1iZXIuX3ByZXNlbmNlX3VwZGF0ZShwcmVzZW5jZSwgdXNlcikKCiAgICAgICAgY29tcGxldGUgPSBkYXRhLmdldCgnY2h1bmtfaW5kZXgnLCAwKSArIDEgPT0gZGF0YS5nZXQoJ2NodW5rX2NvdW50JykKICAgICAgICBzZWxmLnByb2Nlc3NfY2h1bmtfcmVxdWVzdHMoZ3VpbGRfaWQsIGRhdGEuZ2V0KCdub25jZScpLCBtZW1iZXJzLCBjb21wbGV0ZSkKCiAgICBkZWYgcGFyc2VfZ3VpbGRfaW50ZWdyYXRpb25zX3VwZGF0ZShzZWxmLCBkYXRhKToKICAgICAgICBndWlsZCA9IHNlbGYuX2dldF9ndWlsZChpbnQoZGF0YVsnZ3VpbGRfaWQnXSkpCiAgICAgICAgaWYgZ3VpbGQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHNlbGYuZGlzcGF0Y2goJ2d1aWxkX2ludGVncmF0aW9uc191cGRhdGUnLCBndWlsZCkKICAgICAgICBlbHNlOgogICAgICAgICAgICBsb2cuZGVidWcoJ0dVSUxEX0lOVEVHUkFUSU9OU19VUERBVEUgcmVmZXJlbmNpbmcgYW4gdW5rbm93biBndWlsZCBJRDogJXMuIERpc2NhcmRpbmcuJywgZGF0YVsnZ3VpbGRfaWQnXSkKCiAgICBkZWYgcGFyc2Vfd2ViaG9va3NfdXBkYXRlKHNlbGYsIGRhdGEpOgogICAgICAgIGNoYW5uZWwgPSBzZWxmLmdldF9jaGFubmVsKGludChkYXRhWydjaGFubmVsX2lkJ10pKQogICAgICAgIGlmIGNoYW5uZWwgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHNlbGYuZGlzcGF0Y2goJ3dlYmhvb2tzX3VwZGF0ZScsIGNoYW5uZWwpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgbG9nLmRlYnVnKCdXRUJIT09LU19VUERBVEUgcmVmZXJlbmNpbmcgYW4gdW5rbm93biBjaGFubmVsIElEOiAlcy4gRGlzY2FyZGluZy4nLCBkYXRhWydjaGFubmVsX2lkJ10pCgogICAgZGVmIHBhcnNlX3ZvaWNlX3N0YXRlX3VwZGF0ZShzZWxmLCBkYXRhKToKICAgICAgICBndWlsZCA9IHNlbGYuX2dldF9ndWlsZCh1dGlscy5fZ2V0X2FzX3Nub3dmbGFrZShkYXRhLCAnZ3VpbGRfaWQnKSkKICAgICAgICBjaGFubmVsX2lkID0gdXRpbHMuX2dldF9hc19zbm93Zmxha2UoZGF0YSwgJ2NoYW5uZWxfaWQnKQogICAgICAgIGZsYWdzID0gc2VsZi5tZW1iZXJfY2FjaGVfZmxhZ3MKICAgICAgICBzZWxmX2lkID0gc2VsZi51c2VyLmlkCiAgICAgICAgaWYgZ3VpbGQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIGlmIGludChkYXRhWyd1c2VyX2lkJ10pID09IHNlbGZfaWQ6CiAgICAgICAgICAgICAgICB2b2ljZSA9IHNlbGYuX2dldF92b2ljZV9jbGllbnQoZ3VpbGQuaWQpCiAgICAgICAgICAgICAgICBpZiB2b2ljZSBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgICAgICBjb3JvID0gdm9pY2Uub25fdm9pY2Vfc3RhdGVfdXBkYXRlKGRhdGEpCiAgICAgICAgICAgICAgICAgICAgYXN5bmNpby5lbnN1cmVfZnV0dXJlKGxvZ2dpbmdfY29yb3V0aW5lKGNvcm8sIGluZm89J1ZvaWNlIFByb3RvY29sIHZvaWNlIHN0YXRlIHVwZGF0ZSBoYW5kbGVyJykpCgogICAgICAgICAgICBtZW1iZXIsIGJlZm9yZSwgYWZ0ZXIgPSBndWlsZC5fdXBkYXRlX3ZvaWNlX3N0YXRlKGRhdGEsIGNoYW5uZWxfaWQpCiAgICAgICAgICAgIGlmIG1lbWJlciBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgIGlmIGZsYWdzLnZvaWNlOgogICAgICAgICAgICAgICAgICAgIGlmIGNoYW5uZWxfaWQgaXMgTm9uZSBhbmQgZmxhZ3MuX3ZvaWNlX29ubHkgYW5kIG1lbWJlci5pZCAhPSBzZWxmX2lkOgogICAgICAgICAgICAgICAgICAgICAgICAjIE9ubHkgcmVtb3ZlIGZyb20gY2FjaGUgaWZmIHdlIG9ubHkgaGF2ZSB0aGUgdm9pY2UgZmxhZyBlbmFibGVkCiAgICAgICAgICAgICAgICAgICAgICAgIGd1aWxkLl9yZW1vdmVfbWVtYmVyKG1lbWJlcikKICAgICAgICAgICAgICAgICAgICBlbGlmIGNoYW5uZWxfaWQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICAgICAgICAgIGd1aWxkLl9hZGRfbWVtYmVyKG1lbWJlcikKCiAgICAgICAgICAgICAgICBzZWxmLmRpc3BhdGNoKCd2b2ljZV9zdGF0ZV91cGRhdGUnLCBtZW1iZXIsIGJlZm9yZSwgYWZ0ZXIpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBsb2cuZGVidWcoJ1ZPSUNFX1NUQVRFX1VQREFURSByZWZlcmVuY2luZyBhbiB1bmtub3duIG1lbWJlciBJRDogJXMuIERpc2NhcmRpbmcuJywgZGF0YVsndXNlcl9pZCddKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgICMgaW4gaGVyZSB3ZSdyZSBlaXRoZXIgYXQgcHJpdmF0ZSBvciBncm91cCBjYWxscwogICAgICAgICAgICBjYWxsID0gc2VsZi5fY2FsbHMuZ2V0KGNoYW5uZWxfaWQpCiAgICAgICAgICAgIGlmIGNhbGwgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICBjYWxsLl91cGRhdGVfdm9pY2Vfc3RhdGUoZGF0YSkKCiAgICBkZWYgcGFyc2Vfdm9pY2Vfc2VydmVyX3VwZGF0ZShzZWxmLCBkYXRhKToKICAgICAgICB0cnk6CiAgICAgICAgICAgIGtleV9pZCA9IGludChkYXRhWydndWlsZF9pZCddKQogICAgICAgIGV4Y2VwdCBLZXlFcnJvcjoKICAgICAgICAgICAga2V5X2lkID0gaW50KGRhdGFbJ2NoYW5uZWxfaWQnXSkKCiAgICAgICAgdmMgPSBzZWxmLl9nZXRfdm9pY2VfY2xpZW50KGtleV9pZCkKICAgICAgICBpZiB2YyBpcyBub3QgTm9uZToKICAgICAgICAgICAgY29ybyA9IHZjLm9uX3ZvaWNlX3NlcnZlcl91cGRhdGUoZGF0YSkKICAgICAgICAgICAgYXN5bmNpby5lbnN1cmVfZnV0dXJlKGxvZ2dpbmdfY29yb3V0aW5lKGNvcm8sIGluZm89J1ZvaWNlIFByb3RvY29sIHZvaWNlIHNlcnZlciB1cGRhdGUgaGFuZGxlcicpKQoKICAgIGRlZiBwYXJzZV90eXBpbmdfc3RhcnQoc2VsZiwgZGF0YSk6CiAgICAgICAgY2hhbm5lbCwgZ3VpbGQgPSBzZWxmLl9nZXRfZ3VpbGRfY2hhbm5lbChkYXRhKQogICAgICAgIGlmIGNoYW5uZWwgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIG1lbWJlciA9IE5vbmUKICAgICAgICAgICAgdXNlcl9pZCA9IHV0aWxzLl9nZXRfYXNfc25vd2ZsYWtlKGRhdGEsICd1c2VyX2lkJykKICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShjaGFubmVsLCBETUNoYW5uZWwpOgogICAgICAgICAgICAgICAgbWVtYmVyID0gY2hhbm5lbC5yZWNpcGllbnQKICAgICAgICAgICAgZWxpZiBpc2luc3RhbmNlKGNoYW5uZWwsIFRleHRDaGFubmVsKSBhbmQgZ3VpbGQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICBtZW1iZXIgPSBndWlsZC5nZXRfbWVtYmVyKHVzZXJfaWQpCiAgICAgICAgICAgICAgICBpZiBtZW1iZXIgaXMgTm9uZToKICAgICAgICAgICAgICAgICAgICBtZW1iZXJfZGF0YSA9IGRhdGEuZ2V0KCdtZW1iZXInKQogICAgICAgICAgICAgICAgICAgIGlmIG1lbWJlcl9kYXRhOgogICAgICAgICAgICAgICAgICAgICAgICBtZW1iZXIgPSBNZW1iZXIoZGF0YT1tZW1iZXJfZGF0YSwgc3RhdGU9c2VsZiwgZ3VpbGQ9Z3VpbGQpCgogICAgICAgICAgICBlbGlmIGlzaW5zdGFuY2UoY2hhbm5lbCwgR3JvdXBDaGFubmVsKToKICAgICAgICAgICAgICAgIG1lbWJlciA9IHV0aWxzLmZpbmQobGFtYmRhIHg6IHguaWQgPT0gdXNlcl9pZCwgY2hhbm5lbC5yZWNpcGllbnRzKQoKICAgICAgICAgICAgaWYgbWVtYmVyIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgdGltZXN0YW1wID0gZGF0ZXRpbWUuZGF0ZXRpbWUudXRjZnJvbXRpbWVzdGFtcChkYXRhLmdldCgndGltZXN0YW1wJykpCiAgICAgICAgICAgICAgICBzZWxmLmRpc3BhdGNoKCd0eXBpbmcnLCBjaGFubmVsLCBtZW1iZXIsIHRpbWVzdGFtcCkKCiAgICBkZWYgcGFyc2VfcmVsYXRpb25zaGlwX2FkZChzZWxmLCBkYXRhKToKICAgICAgICBrZXkgPSBpbnQoZGF0YVsnaWQnXSkKICAgICAgICBvbGQgPSBzZWxmLnVzZXIuZ2V0X3JlbGF0aW9uc2hpcChrZXkpCiAgICAgICAgbmV3ID0gUmVsYXRpb25zaGlwKHN0YXRlPXNlbGYsIGRhdGE9ZGF0YSkKICAgICAgICBzZWxmLnVzZXIuX3JlbGF0aW9uc2hpcHNba2V5XSA9IG5ldwogICAgICAgIGlmIG9sZCBpcyBub3QgTm9uZToKICAgICAgICAgICAgc2VsZi5kaXNwYXRjaCgncmVsYXRpb25zaGlwX3VwZGF0ZScsIG9sZCwgbmV3KQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHNlbGYuZGlzcGF0Y2goJ3JlbGF0aW9uc2hpcF9hZGQnLCBuZXcpCgogICAgZGVmIHBhcnNlX3JlbGF0aW9uc2hpcF9yZW1vdmUoc2VsZiwgZGF0YSk6CiAgICAgICAga2V5ID0gaW50KGRhdGFbJ2lkJ10pCiAgICAgICAgdHJ5OgogICAgICAgICAgICBvbGQgPSBzZWxmLnVzZXIuX3JlbGF0aW9uc2hpcHMucG9wKGtleSkKICAgICAgICBleGNlcHQgS2V5RXJyb3I6CiAgICAgICAgICAgIHBhc3MKICAgICAgICBlbHNlOgogICAgICAgICAgICBzZWxmLmRpc3BhdGNoKCdyZWxhdGlvbnNoaXBfcmVtb3ZlJywgb2xkKQoKICAgIGRlZiBfZ2V0X3JlYWN0aW9uX3VzZXIoc2VsZiwgY2hhbm5lbCwgdXNlcl9pZCk6CiAgICAgICAgaWYgaXNpbnN0YW5jZShjaGFubmVsLCBUZXh0Q2hhbm5lbCk6CiAgICAgICAgICAgIHJldHVybiBjaGFubmVsLmd1aWxkLmdldF9tZW1iZXIodXNlcl9pZCkKICAgICAgICByZXR1cm4gc2VsZi5nZXRfdXNlcih1c2VyX2lkKQoKICAgIGRlZiBnZXRfcmVhY3Rpb25fZW1vamkoc2VsZiwgZGF0YSk6CiAgICAgICAgZW1vamlfaWQgPSB1dGlscy5fZ2V0X2FzX3Nub3dmbGFrZShkYXRhLCAnaWQnKQoKICAgICAgICBpZiBub3QgZW1vamlfaWQ6CiAgICAgICAgICAgIHJldHVybiBkYXRhWyduYW1lJ10KCiAgICAgICAgdHJ5OgogICAgICAgICAgICByZXR1cm4gc2VsZi5fZW1vamlzW2Vtb2ppX2lkXQogICAgICAgIGV4Y2VwdCBLZXlFcnJvcjoKICAgICAgICAgICAgcmV0dXJuIFBhcnRpYWxFbW9qaS53aXRoX3N0YXRlKHNlbGYsIGFuaW1hdGVkPWRhdGEuZ2V0KCdhbmltYXRlZCcsIEZhbHNlKSwgaWQ9ZW1vamlfaWQsIG5hbWU9ZGF0YVsnbmFtZSddKQoKICAgIGRlZiBfdXBncmFkZV9wYXJ0aWFsX2Vtb2ppKHNlbGYsIGVtb2ppKToKICAgICAgICBlbW9qaV9pZCA9IGVtb2ppLmlkCiAgICAgICAgaWYgbm90IGVtb2ppX2lkOgogICAgICAgICAgICByZXR1cm4gZW1vamkubmFtZQogICAgICAgIHRyeToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX2Vtb2ppc1tlbW9qaV9pZF0KICAgICAgICBleGNlcHQgS2V5RXJyb3I6CiAgICAgICAgICAgIHJldHVybiBlbW9qaQoKICAgIGRlZiBnZXRfY2hhbm5lbChzZWxmLCBpZCk6CiAgICAgICAgaWYgaWQgaXMgTm9uZToKICAgICAgICAgICAgcmV0dXJuIE5vbmUKCiAgICAgICAgcG0gPSBzZWxmLl9nZXRfcHJpdmF0ZV9jaGFubmVsKGlkKQogICAgICAgIGlmIHBtIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXR1cm4gcG0KCiAgICAgICAgZm9yIGd1aWxkIGluIHNlbGYuZ3VpbGRzOgogICAgICAgICAgICBjaGFubmVsID0gZ3VpbGQuZ2V0X2NoYW5uZWwoaWQpCiAgICAgICAgICAgIGlmIGNoYW5uZWwgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICByZXR1cm4gY2hhbm5lbAoKICAgIGRlZiBjcmVhdGVfbWVzc2FnZShzZWxmLCAqLCBjaGFubmVsLCBkYXRhKToKICAgICAgICByZXR1cm4gTWVzc2FnZShzdGF0ZT1zZWxmLCBjaGFubmVsPWNoYW5uZWwsIGRhdGE9ZGF0YSkKCmNsYXNzIEF1dG9TaGFyZGVkQ29ubmVjdGlvblN0YXRlKENvbm5lY3Rpb25TdGF0ZSk6CiAgICBkZWYgX19pbml0X18oc2VsZiwgKmFyZ3MsICoqa3dhcmdzKToKICAgICAgICBzdXBlcigpLl9faW5pdF9fKCphcmdzLCAqKmt3YXJncykKICAgICAgICBzZWxmLl9yZWFkeV90YXNrID0gTm9uZQogICAgICAgIHNlbGYuc2hhcmRfaWRzID0gKCkKICAgICAgICBzZWxmLnNoYXJkc19sYXVuY2hlZCA9IGFzeW5jaW8uRXZlbnQoKQoKICAgIGRlZiBfdXBkYXRlX21lc3NhZ2VfcmVmZXJlbmNlcyhzZWxmKToKICAgICAgICBmb3IgbXNnIGluIHNlbGYuX21lc3NhZ2VzOgogICAgICAgICAgICBpZiBub3QgbXNnLmd1aWxkOgogICAgICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgICAgIG5ld19ndWlsZCA9IHNlbGYuX2dldF9ndWlsZChtc2cuZ3VpbGQuaWQpCiAgICAgICAgICAgIGlmIG5ld19ndWlsZCBpcyBub3QgTm9uZSBhbmQgbmV3X2d1aWxkIGlzIG5vdCBtc2cuZ3VpbGQ6CiAgICAgICAgICAgICAgICBjaGFubmVsX2lkID0gbXNnLmNoYW5uZWwuaWQKICAgICAgICAgICAgICAgIGNoYW5uZWwgPSBuZXdfZ3VpbGQuZ2V0X2NoYW5uZWwoY2hhbm5lbF9pZCkgb3IgT2JqZWN0KGlkPWNoYW5uZWxfaWQpCiAgICAgICAgICAgICAgICBtc2cuX3JlYmluZF9jaGFubmVsX3JlZmVyZW5jZShjaGFubmVsKQoKICAgIGFzeW5jIGRlZiBjaHVua2VyKHNlbGYsIGd1aWxkX2lkLCBxdWVyeT0nJywgbGltaXQ9MCwgcHJlc2VuY2VzPUZhbHNlLCAqLCBzaGFyZF9pZD1Ob25lLCBub25jZT1Ob25lKToKICAgICAgICB3cyA9IHNlbGYuX2dldF93ZWJzb2NrZXQoZ3VpbGRfaWQsIHNoYXJkX2lkPXNoYXJkX2lkKQogICAgICAgIGF3YWl0IHdzLnJlcXVlc3RfY2h1bmtzKGd1aWxkX2lkLCBxdWVyeT1xdWVyeSwgbGltaXQ9bGltaXQsIHByZXNlbmNlcz1wcmVzZW5jZXMsIG5vbmNlPW5vbmNlKQoKICAgIGFzeW5jIGRlZiBfZGVsYXlfcmVhZHkoc2VsZik6CiAgICAgICAgYXdhaXQgc2VsZi5zaGFyZHNfbGF1bmNoZWQud2FpdCgpCiAgICAgICAgcHJvY2Vzc2VkID0gW10KICAgICAgICBtYXhfY29uY3VycmVuY3kgPSBsZW4oc2VsZi5zaGFyZF9pZHMpICogMgogICAgICAgIGN1cnJlbnRfYnVja2V0ID0gW10KICAgICAgICB3aGlsZSBUcnVlOgogICAgICAgICAgICAjIHRoaXMgc25pcHBldCBvZiBjb2RlIGlzIGJhc2ljYWxseSB3YWl0aW5nIE4gc2Vjb25kcwogICAgICAgICAgICAjIHVudGlsIHRoZSBsYXN0IEdVSUxEX0NSRUFURSB3YXMgc2VudAogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBndWlsZCA9IGF3YWl0IGFzeW5jaW8ud2FpdF9mb3Ioc2VsZi5fcmVhZHlfc3RhdGUuZ2V0KCksIHRpbWVvdXQ9c2VsZi5ndWlsZF9yZWFkeV90aW1lb3V0KQogICAgICAgICAgICBleGNlcHQgYXN5bmNpby5UaW1lb3V0RXJyb3I6CiAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgaWYgc2VsZi5fZ3VpbGRfbmVlZHNfY2h1bmtpbmcoZ3VpbGQpOgogICAgICAgICAgICAgICAgICAgIGxvZy5kZWJ1ZygnR3VpbGQgSUQgJWQgcmVxdWlyZXMgY2h1bmtpbmcsIHdpbGwgYmUgZG9uZSBpbiB0aGUgYmFja2dyb3VuZC4nLCBndWlsZC5pZCkKICAgICAgICAgICAgICAgICAgICBpZiBsZW4oY3VycmVudF9idWNrZXQpID49IG1heF9jb25jdXJyZW5jeToKICAgICAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXdhaXQgdXRpbHMuc2FuZV93YWl0X2ZvcihjdXJyZW50X2J1Y2tldCwgdGltZW91dD1tYXhfY29uY3VycmVuY3kgKiA3MC4wKQogICAgICAgICAgICAgICAgICAgICAgICBleGNlcHQgYXN5bmNpby5UaW1lb3V0RXJyb3I6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbXQgPSAnU2hhcmQgSUQgJXMgZmFpbGVkIHRvIHdhaXQgZm9yIGNodW5rcyBmcm9tIGEgc3ViLWJ1Y2tldCB3aXRoIGxlbmd0aCAlZCcKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZy53YXJuaW5nKGZtdCwgZ3VpbGQuc2hhcmRfaWQsIGxlbihjdXJyZW50X2J1Y2tldCkpCiAgICAgICAgICAgICAgICAgICAgICAgIGZpbmFsbHk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50X2J1Y2tldCA9IFtdCgogICAgICAgICAgICAgICAgICAgICMgQ2h1bmsgdGhlIGd1aWxkIGluIHRoZSBiYWNrZ3JvdW5kIHdoaWxlIHdlIHdhaXQgZm9yIEdVSUxEX0NSRUFURSBzdHJlYW1pbmcKICAgICAgICAgICAgICAgICAgICBmdXR1cmUgPSBhc3luY2lvLmVuc3VyZV9mdXR1cmUoc2VsZi5jaHVua19ndWlsZChndWlsZCkpCiAgICAgICAgICAgICAgICAgICAgY3VycmVudF9idWNrZXQuYXBwZW5kKGZ1dHVyZSkKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgZnV0dXJlID0gc2VsZi5sb29wLmNyZWF0ZV9mdXR1cmUoKQogICAgICAgICAgICAgICAgICAgIGZ1dHVyZS5zZXRfcmVzdWx0KFtdKQoKICAgICAgICAgICAgICAgIHByb2Nlc3NlZC5hcHBlbmQoKGd1aWxkLCBmdXR1cmUpKQoKICAgICAgICBndWlsZHMgPSBzb3J0ZWQocHJvY2Vzc2VkLCBrZXk9bGFtYmRhIGc6IGdbMF0uc2hhcmRfaWQpCiAgICAgICAgZm9yIHNoYXJkX2lkLCBpbmZvIGluIGl0ZXJ0b29scy5ncm91cGJ5KGd1aWxkcywga2V5PWxhbWJkYSBnOiBnWzBdLnNoYXJkX2lkKToKICAgICAgICAgICAgY2hpbGRyZW4sIGZ1dHVyZXMgPSB6aXAoKmluZm8pCiAgICAgICAgICAgICMgMTEwIHJlcXMvbWludXRlIHcvIDEgcmVxL2d1aWxkIHBsdXMgc29tZSBidWZmZXIKICAgICAgICAgICAgdGltZW91dCA9IDYxICogKGxlbihjaGlsZHJlbikgLyAxMTApCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGF3YWl0IHV0aWxzLnNhbmVfd2FpdF9mb3IoZnV0dXJlcywgdGltZW91dD10aW1lb3V0KQogICAgICAgICAgICBleGNlcHQgYXN5bmNpby5UaW1lb3V0RXJyb3I6CiAgICAgICAgICAgICAgICBsb2cud2FybmluZygnU2hhcmQgSUQgJXMgZmFpbGVkIHRvIHdhaXQgZm9yIGNodW5rcyAodGltZW91dD0lLjJmKSBmb3IgJWQgZ3VpbGRzJywgc2hhcmRfaWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGltZW91dCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZW4oZ3VpbGRzKSkKICAgICAgICAgICAgZm9yIGd1aWxkIGluIGNoaWxkcmVuOgogICAgICAgICAgICAgICAgaWYgZ3VpbGQudW5hdmFpbGFibGUgaXMgRmFsc2U6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5kaXNwYXRjaCgnZ3VpbGRfYXZhaWxhYmxlJywgZ3VpbGQpCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIHNlbGYuZGlzcGF0Y2goJ2d1aWxkX2pvaW4nLCBndWlsZCkKCiAgICAgICAgICAgIHNlbGYuZGlzcGF0Y2goJ3NoYXJkX3JlYWR5Jywgc2hhcmRfaWQpCgogICAgICAgICMgcmVtb3ZlIHRoZSBzdGF0ZQogICAgICAgIHRyeToKICAgICAgICAgICAgZGVsIHNlbGYuX3JlYWR5X3N0YXRlCiAgICAgICAgZXhjZXB0IEF0dHJpYnV0ZUVycm9yOgogICAgICAgICAgICBwYXNzICMgYWxyZWFkeSBiZWVuIGRlbGV0ZWQgc29tZWhvdwoKICAgICAgICAjIHJlZ3VsYXIgdXNlcnMgY2Fubm90IHNoYXJkIHNvIHdlIHdvbid0IHdvcnJ5IGFib3V0IGl0IGhlcmUuCgogICAgICAgICMgY2xlYXIgdGhlIGN1cnJlbnQgdGFzawogICAgICAgIHNlbGYuX3JlYWR5X3Rhc2sgPSBOb25lCgogICAgICAgICMgZGlzcGF0Y2ggdGhlIGV2ZW50CiAgICAgICAgc2VsZi5jYWxsX2hhbmRsZXJzKCdyZWFkeScpCiAgICAgICAgc2VsZi5kaXNwYXRjaCgncmVhZHknKQoKICAgIGRlZiBwYXJzZV9yZWFkeShzZWxmLCBkYXRhKToKICAgICAgICBpZiBub3QgaGFzYXR0cihzZWxmLCAnX3JlYWR5X3N0YXRlJyk6CiAgICAgICAgICAgIHNlbGYuX3JlYWR5X3N0YXRlID0gYXN5bmNpby5RdWV1ZSgpCgogICAgICAgIHNlbGYudXNlciA9IHVzZXIgPSBDbGllbnRVc2VyKHN0YXRlPXNlbGYsIGRhdGE9ZGF0YVsndXNlciddKQogICAgICAgIHNlbGYuX3VzZXJzW3VzZXIuaWRdID0gdXNlcgoKICAgICAgICBmb3IgZ3VpbGRfZGF0YSBpbiBkYXRhWydndWlsZHMnXToKICAgICAgICAgICAgc2VsZi5fYWRkX2d1aWxkX2Zyb21fZGF0YShndWlsZF9kYXRhKQoKICAgICAgICBpZiBzZWxmLl9tZXNzYWdlczoKICAgICAgICAgICAgc2VsZi5fdXBkYXRlX21lc3NhZ2VfcmVmZXJlbmNlcygpCgogICAgICAgIGZvciBwbSBpbiBkYXRhLmdldCgncHJpdmF0ZV9jaGFubmVscycsIFtdKToKICAgICAgICAgICAgZmFjdG9yeSwgXyA9IF9jaGFubmVsX2ZhY3RvcnkocG1bJ3R5cGUnXSkKICAgICAgICAgICAgc2VsZi5fYWRkX3ByaXZhdGVfY2hhbm5lbChmYWN0b3J5KG1lPXVzZXIsIGRhdGE9cG0sIHN0YXRlPXNlbGYpKQoKICAgICAgICBzZWxmLmRpc3BhdGNoKCdjb25uZWN0JykKICAgICAgICBzZWxmLmRpc3BhdGNoKCdzaGFyZF9jb25uZWN0JywgZGF0YVsnX19zaGFyZF9pZF9fJ10pCgogICAgICAgICMgTXVjaCBsaWtlIGNsZWFyKCksIGlmIHdlIGhhdmUgYSBtYXNzaXZlIGRlYWxsb2NhdGlvbgogICAgICAgICMgdGhlbiBpdCdzIGJldHRlciB0byBleHBsaWNpdGx5IGNhbGwgdGhlIEdDCiAgICAgICAgIyBOb3RlIHRoYXQgaW4gdGhlIG9yaWdpbmFsIHJlYWR5IHBhcnNpbmcgY29kZSB0aGlzIHdhcyBkb25lCiAgICAgICAgIyBpbXBsaWNpdGx5IHZpYSBjbGVhcigpIGJ1dCBpbiB0aGUgYXV0byBzaGFyZGVkIGNsaWVudCBjbGVhcmluZwogICAgICAgICMgdGhlIGNhY2hlIHdvdWxkIGhhdmUgdGhlIGNvbnNlcXVlbmNlIG9mIGNsZWFyaW5nIGRhdGEgb24gb3RoZXIKICAgICAgICAjIHNoYXJkcyBhcyB3ZWxsLgogICAgICAgIGdjLmNvbGxlY3QoKQoKICAgICAgICBpZiBzZWxmLl9yZWFkeV90YXNrIGlzIE5vbmU6CiAgICAgICAgICAgIHNlbGYuX3JlYWR5X3Rhc2sgPSBhc3luY2lvLmVuc3VyZV9mdXR1cmUoc2VsZi5fZGVsYXlfcmVhZHkoKSwgbG9vcD1zZWxmLmxvb3ApCgogICAgZGVmIHBhcnNlX3Jlc3VtZWQoc2VsZiwgZGF0YSk6CiAgICAgICAgc2VsZi5kaXNwYXRjaCgncmVzdW1lZCcpCiAgICAgICAgc2VsZi5kaXNwYXRjaCgnc2hhcmRfcmVzdW1lZCcsIGRhdGFbJ19fc2hhcmRfaWRfXyddKQo=
