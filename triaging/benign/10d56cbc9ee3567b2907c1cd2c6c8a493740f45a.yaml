statistics:
  total_files: 1
  skipped_files: 0.0
  processed_objects: 1
  malicious_objects: 0
details:
- path: .repo_cache/malicious_repos/pypi_malregistry/urlib3/1.21.1/urlib3-1.21.1/urlib3-1.21.1/test/with_dummyserver/test_connectionpool.py
  contents:
  - name: TestFileBodiesOnRetryOrRedirect.test_redirect_put_file
    score: 0.0
    code: |-
      def test_redirect_put_file(self):
              """PUT with file object should work with a redirection response"""
              retry = Retry(total=3, status_forcelist=[418])
              # httplib reads in 8k chunks; use a larger content length
              content_length = 65535
              data = b'A' * content_length
              uploaded_file = io.BytesIO(data)
              headers = {'test-name': 'test_redirect_put_file',
                         'Content-Length': str(content_length)}
              url = '/redirect?target=/echo&status=307'
              resp = self.pool.urlopen('PUT', url,
                                       headers=headers,
                                       retries=retry,
                                       body=uploaded_file,
                                       assert_same_host=False, redirect=True)
              self.assertEqual(resp.status, 200)
              self.assertEqual(resp.data, data)
    tokens: resume load_global Retry load_const INTEGER load_const INTEGER build_list kw_names status_forcelist total call store_fast retry load_const INTEGER store_fast content_length load_const load_fast content_length binary_op * store_fast data load_global io load_attr BytesIO load_fast data call store_fast uploaded_file load_const STRING_LEN_S_ENT_HIGH load_global str load_fast content_length call load_const build_const_key_map store_fast headers load_const STRING_FILE_PATH store_fast url load_fast self load_attr pool load_attr NETWORK_HTTP_REQUEST load_const PUT load_fast url load_fast headers load_fast retry load_fast uploaded_file load_const INTEGER load_const INTEGER kw_names assert_same_host body headers redirect retries call store_fast resp load_fast self load_attr assertEqual load_fast resp load_attr status load_const INTEGER call pop_top load_fast self load_attr assertEqual load_fast resp load_attr data load_fast data call pop_top return_const None
    hash: 7873ea9c4e8ca0fda101a3c5210473c8990ad45b2e53e1fe8503a08ceb4d1569
sources:
  ? .repo_cache/malicious_repos/pypi_malregistry/urlib3/1.21.1/urlib3-1.21.1/urlib3-1.21.1/test/with_dummyserver/test_connectionpool.py
  : aW1wb3J0IGlvCmltcG9ydCBsb2dnaW5nCmltcG9ydCBzb2NrZXQKaW1wb3J0IHN5cwppbXBvcnQgdW5pdHRlc3QKaW1wb3J0IHRpbWUKaW1wb3J0IHdhcm5pbmdzCgppbXBvcnQgbW9jawoKZnJvbSAuLiBpbXBvcnQgKAogICAgVEFSUElUX0hPU1QsIFZBTElEX1NPVVJDRV9BRERSRVNTRVMsIElOVkFMSURfU09VUkNFX0FERFJFU1NFUywKKQpmcm9tIC4ucG9ydF9oZWxwZXJzIGltcG9ydCBmaW5kX3VudXNlZF9wb3J0CmZyb20gdXJsbGliMyBpbXBvcnQgKAogICAgZW5jb2RlX211bHRpcGFydF9mb3JtZGF0YSwKICAgIEhUVFBDb25uZWN0aW9uUG9vbCwKKQpmcm9tIHVybGxpYjMuZXhjZXB0aW9ucyBpbXBvcnQgKAogICAgQ29ubmVjdFRpbWVvdXRFcnJvciwKICAgIEVtcHR5UG9vbEVycm9yLAogICAgRGVjb2RlRXJyb3IsCiAgICBNYXhSZXRyeUVycm9yLAogICAgUmVhZFRpbWVvdXRFcnJvciwKICAgIE5ld0Nvbm5lY3Rpb25FcnJvciwKICAgIFVucmV3aW5kYWJsZUJvZHlFcnJvciwKKQpmcm9tIHVybGxpYjMucGFja2FnZXMuc2l4IGltcG9ydCBiLCB1CmZyb20gdXJsbGliMy5wYWNrYWdlcy5zaXgubW92ZXMudXJsbGliLnBhcnNlIGltcG9ydCB1cmxlbmNvZGUKZnJvbSB1cmxsaWIzLnV0aWwucmV0cnkgaW1wb3J0IFJldHJ5LCBSZXF1ZXN0SGlzdG9yeQpmcm9tIHVybGxpYjMudXRpbC50aW1lb3V0IGltcG9ydCBUaW1lb3V0Cgpmcm9tIGR1bW15c2VydmVyLnRlc3RjYXNlIGltcG9ydCBIVFRQRHVtbXlTZXJ2ZXJUZXN0Q2FzZSwgU29ja2V0RHVtbXlTZXJ2ZXJUZXN0Q2FzZQpmcm9tIGR1bW15c2VydmVyLnNlcnZlciBpbXBvcnQgTm9JUHY2V2FybmluZywgSEFTX0lQVjZfQU5EX0ROUwoKZnJvbSB0aHJlYWRpbmcgaW1wb3J0IEV2ZW50Cgpsb2cgPSBsb2dnaW5nLmdldExvZ2dlcigndXJsbGliMy5jb25uZWN0aW9ucG9vbCcpCmxvZy5zZXRMZXZlbChsb2dnaW5nLk5PVFNFVCkKbG9nLmFkZEhhbmRsZXIobG9nZ2luZy5TdHJlYW1IYW5kbGVyKHN5cy5zdGRvdXQpKQoKClNIT1JUX1RJTUVPVVQgPSAwLjAwMQpMT05HX1RJTUVPVVQgPSAwLjAzCgoKZGVmIHdhaXRfZm9yX3NvY2tldChyZWFkeV9ldmVudCk6CiAgICByZWFkeV9ldmVudC53YWl0KCkKICAgIHJlYWR5X2V2ZW50LmNsZWFyKCkKCgpjbGFzcyBUZXN0Q29ubmVjdGlvblBvb2xUaW1lb3V0cyhTb2NrZXREdW1teVNlcnZlclRlc3RDYXNlKToKCiAgICBkZWYgdGVzdF90aW1lb3V0X2Zsb2F0KHNlbGYpOgogICAgICAgIGJsb2NrX2V2ZW50ID0gRXZlbnQoKQogICAgICAgIHJlYWR5X2V2ZW50ID0gc2VsZi5zdGFydF9iYXNpY19oYW5kbGVyKGJsb2NrX3NlbmQ9YmxvY2tfZXZlbnQsIG51bT0yKQoKICAgICAgICAjIFBvb2wtZ2xvYmFsIHRpbWVvdXQKICAgICAgICBwb29sID0gSFRUUENvbm5lY3Rpb25Qb29sKHNlbGYuaG9zdCwgc2VsZi5wb3J0LCB0aW1lb3V0PVNIT1JUX1RJTUVPVVQsIHJldHJpZXM9RmFsc2UpCiAgICAgICAgc2VsZi5hZGRDbGVhbnVwKHBvb2wuY2xvc2UpCiAgICAgICAgd2FpdF9mb3Jfc29ja2V0KHJlYWR5X2V2ZW50KQogICAgICAgIHNlbGYuYXNzZXJ0UmFpc2VzKFJlYWRUaW1lb3V0RXJyb3IsIHBvb2wucmVxdWVzdCwgJ0dFVCcsICcvJykKICAgICAgICBibG9ja19ldmVudC5zZXQoKSAgIyBSZWxlYXNlIGJsb2NrCgogICAgICAgICMgU2hvdWxkbid0IHJhaXNlIHRoaXMgdGltZQogICAgICAgIHdhaXRfZm9yX3NvY2tldChyZWFkeV9ldmVudCkKICAgICAgICBibG9ja19ldmVudC5zZXQoKSAgIyBQcmUtcmVsZWFzZSBibG9jawogICAgICAgIHBvb2wucmVxdWVzdCgnR0VUJywgJy8nKQoKICAgIGRlZiB0ZXN0X2Nvbm5fY2xvc2VkKHNlbGYpOgogICAgICAgIGJsb2NrX2V2ZW50ID0gRXZlbnQoKQogICAgICAgIHNlbGYuc3RhcnRfYmFzaWNfaGFuZGxlcihibG9ja19zZW5kPWJsb2NrX2V2ZW50LCBudW09MSkKCiAgICAgICAgcG9vbCA9IEhUVFBDb25uZWN0aW9uUG9vbChzZWxmLmhvc3QsIHNlbGYucG9ydCwgdGltZW91dD1TSE9SVF9USU1FT1VULCByZXRyaWVzPUZhbHNlKQogICAgICAgIHNlbGYuYWRkQ2xlYW51cChwb29sLmNsb3NlKQogICAgICAgIGNvbm4gPSBwb29sLl9nZXRfY29ubigpCiAgICAgICAgcG9vbC5fcHV0X2Nvbm4oY29ubikKICAgICAgICB0cnk6CiAgICAgICAgICAgIHBvb2wudXJsb3BlbignR0VUJywgJy8nKQogICAgICAgICAgICBzZWxmLmZhaWwoIlRoZSByZXF1ZXN0IHNob3VsZCBmYWlsIHdpdGggYSB0aW1lb3V0IGVycm9yLiIpCiAgICAgICAgZXhjZXB0IFJlYWRUaW1lb3V0RXJyb3I6CiAgICAgICAgICAgIGlmIGNvbm4uc29jazoKICAgICAgICAgICAgICAgIHNlbGYuYXNzZXJ0UmFpc2VzKHNvY2tldC5lcnJvciwgY29ubi5zb2NrLnJlY3YsIDEwMjQpCiAgICAgICAgZmluYWxseToKICAgICAgICAgICAgcG9vbC5fcHV0X2Nvbm4oY29ubikKCiAgICAgICAgYmxvY2tfZXZlbnQuc2V0KCkKCiAgICBkZWYgdGVzdF90aW1lb3V0KHNlbGYpOgogICAgICAgICMgUmVxdWVzdHMgc2hvdWxkIHRpbWUgb3V0IHdoZW4gZXhwZWN0ZWQKICAgICAgICBibG9ja19ldmVudCA9IEV2ZW50KCkKICAgICAgICByZWFkeV9ldmVudCA9IHNlbGYuc3RhcnRfYmFzaWNfaGFuZGxlcihibG9ja19zZW5kPWJsb2NrX2V2ZW50LCBudW09NikKCiAgICAgICAgIyBQb29sLWdsb2JhbCB0aW1lb3V0CiAgICAgICAgdGltZW91dCA9IFRpbWVvdXQocmVhZD1TSE9SVF9USU1FT1VUKQogICAgICAgIHBvb2wgPSBIVFRQQ29ubmVjdGlvblBvb2woc2VsZi5ob3N0LCBzZWxmLnBvcnQsIHRpbWVvdXQ9dGltZW91dCwgcmV0cmllcz1GYWxzZSkKICAgICAgICBzZWxmLmFkZENsZWFudXAocG9vbC5jbG9zZSkKCiAgICAgICAgd2FpdF9mb3Jfc29ja2V0KHJlYWR5X2V2ZW50KQogICAgICAgIGNvbm4gPSBwb29sLl9nZXRfY29ubigpCiAgICAgICAgc2VsZi5hc3NlcnRSYWlzZXMoUmVhZFRpbWVvdXRFcnJvciwgcG9vbC5fbWFrZV9yZXF1ZXN0LCBjb25uLCAnR0VUJywgJy8nKQogICAgICAgIHBvb2wuX3B1dF9jb25uKGNvbm4pCiAgICAgICAgYmxvY2tfZXZlbnQuc2V0KCkgICMgUmVsZWFzZSByZXF1ZXN0CgogICAgICAgIHdhaXRfZm9yX3NvY2tldChyZWFkeV9ldmVudCkKICAgICAgICBibG9ja19ldmVudC5jbGVhcigpCiAgICAgICAgc2VsZi5hc3NlcnRSYWlzZXMoUmVhZFRpbWVvdXRFcnJvciwgcG9vbC5yZXF1ZXN0LCAnR0VUJywgJy8nKQogICAgICAgIGJsb2NrX2V2ZW50LnNldCgpICAjIFJlbGVhc2UgcmVxdWVzdAoKICAgICAgICAjIFJlcXVlc3Qtc3BlY2lmaWMgdGltZW91dHMgc2hvdWxkIHJhaXNlIGVycm9ycwogICAgICAgIHBvb2wgPSBIVFRQQ29ubmVjdGlvblBvb2woc2VsZi5ob3N0LCBzZWxmLnBvcnQsIHRpbWVvdXQ9TE9OR19USU1FT1VULCByZXRyaWVzPUZhbHNlKQogICAgICAgIHNlbGYuYWRkQ2xlYW51cChwb29sLmNsb3NlKQoKICAgICAgICBjb25uID0gcG9vbC5fZ2V0X2Nvbm4oKQogICAgICAgIHdhaXRfZm9yX3NvY2tldChyZWFkeV9ldmVudCkKICAgICAgICBub3cgPSB0aW1lLnRpbWUoKQogICAgICAgIHNlbGYuYXNzZXJ0UmFpc2VzKFJlYWRUaW1lb3V0RXJyb3IsIHBvb2wuX21ha2VfcmVxdWVzdCwgY29ubiwgJ0dFVCcsICcvJywgdGltZW91dD10aW1lb3V0KQogICAgICAgIGRlbHRhID0gdGltZS50aW1lKCkgLSBub3cKICAgICAgICBibG9ja19ldmVudC5zZXQoKSAgIyBSZWxlYXNlIHJlcXVlc3QKCiAgICAgICAgbWVzc2FnZSA9ICJ0aW1lb3V0IHdhcyBwb29sLWxldmVsIExPTkdfVElNRU9VVCByYXRoZXIgdGhhbiByZXF1ZXN0LWxldmVsIFNIT1JUX1RJTUVPVVQiCiAgICAgICAgc2VsZi5hc3NlcnRUcnVlKGRlbHRhIDwgTE9OR19USU1FT1VULCBtZXNzYWdlKQogICAgICAgIHBvb2wuX3B1dF9jb25uKGNvbm4pCgogICAgICAgIHdhaXRfZm9yX3NvY2tldChyZWFkeV9ldmVudCkKICAgICAgICBub3cgPSB0aW1lLnRpbWUoKQogICAgICAgIHNlbGYuYXNzZXJ0UmFpc2VzKFJlYWRUaW1lb3V0RXJyb3IsIHBvb2wucmVxdWVzdCwgJ0dFVCcsICcvJywgdGltZW91dD10aW1lb3V0KQogICAgICAgIGRlbHRhID0gdGltZS50aW1lKCkgLSBub3cKCiAgICAgICAgbWVzc2FnZSA9ICJ0aW1lb3V0IHdhcyBwb29sLWxldmVsIExPTkdfVElNRU9VVCByYXRoZXIgdGhhbiByZXF1ZXN0LWxldmVsIFNIT1JUX1RJTUVPVVQiCiAgICAgICAgc2VsZi5hc3NlcnRUcnVlKGRlbHRhIDwgTE9OR19USU1FT1VULCBtZXNzYWdlKQogICAgICAgIGJsb2NrX2V2ZW50LnNldCgpICAjIFJlbGVhc2UgcmVxdWVzdAoKICAgICAgICAjIFRpbWVvdXQgaW50L2Zsb2F0IHBhc3NlZCBkaXJlY3RseSB0byByZXF1ZXN0IGFuZCBfbWFrZV9yZXF1ZXN0IHNob3VsZAogICAgICAgICMgcmFpc2UgYSByZXF1ZXN0IHRpbWVvdXQKICAgICAgICB3YWl0X2Zvcl9zb2NrZXQocmVhZHlfZXZlbnQpCiAgICAgICAgc2VsZi5hc3NlcnRSYWlzZXMoUmVhZFRpbWVvdXRFcnJvciwgcG9vbC5yZXF1ZXN0LCAnR0VUJywgJy8nLCB0aW1lb3V0PVNIT1JUX1RJTUVPVVQpCiAgICAgICAgYmxvY2tfZXZlbnQuc2V0KCkgICMgUmVsZWFzZSByZXF1ZXN0CgogICAgICAgIHdhaXRfZm9yX3NvY2tldChyZWFkeV9ldmVudCkKICAgICAgICBjb25uID0gcG9vbC5fbmV3X2Nvbm4oKQogICAgICAgICMgRklYTUU6IFRoaXMgYXNzZXJ0IGZsYWtlcyBzb21ldGltZXMuIE5vdCBzdXJlIHdoeS4KICAgICAgICBzZWxmLmFzc2VydFJhaXNlcyhSZWFkVGltZW91dEVycm9yLAogICAgICAgICAgICAgICAgICAgICAgICAgIHBvb2wuX21ha2VfcmVxdWVzdCwKICAgICAgICAgICAgICAgICAgICAgICAgICBjb25uLCAnR0VUJywgJy8nLAogICAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVvdXQ9U0hPUlRfVElNRU9VVCkKICAgICAgICBibG9ja19ldmVudC5zZXQoKSAgIyBSZWxlYXNlIHJlcXVlc3QKCiAgICBkZWYgdGVzdF9jb25uZWN0X3RpbWVvdXQoc2VsZik6CiAgICAgICAgdXJsID0gJy8nCiAgICAgICAgaG9zdCwgcG9ydCA9IFRBUlBJVF9IT1NULCA4MAogICAgICAgIHRpbWVvdXQgPSBUaW1lb3V0KGNvbm5lY3Q9U0hPUlRfVElNRU9VVCkKCiAgICAgICAgIyBQb29sLWdsb2JhbCB0aW1lb3V0CiAgICAgICAgcG9vbCA9IEhUVFBDb25uZWN0aW9uUG9vbChob3N0LCBwb3J0LCB0aW1lb3V0PXRpbWVvdXQpCiAgICAgICAgc2VsZi5hZGRDbGVhbnVwKHBvb2wuY2xvc2UpCiAgICAgICAgY29ubiA9IHBvb2wuX2dldF9jb25uKCkKICAgICAgICBzZWxmLmFzc2VydFJhaXNlcyhDb25uZWN0VGltZW91dEVycm9yLCBwb29sLl9tYWtlX3JlcXVlc3QsIGNvbm4sICdHRVQnLCB1cmwpCgogICAgICAgICMgUmV0cmllcwogICAgICAgIHJldHJpZXMgPSBSZXRyeShjb25uZWN0PTApCiAgICAgICAgc2VsZi5hc3NlcnRSYWlzZXMoTWF4UmV0cnlFcnJvciwgcG9vbC5yZXF1ZXN0LCAnR0VUJywgdXJsLCByZXRyaWVzPXJldHJpZXMpCgogICAgICAgICMgUmVxdWVzdC1zcGVjaWZpYyBjb25uZWN0aW9uIHRpbWVvdXRzCiAgICAgICAgYmlnX3RpbWVvdXQgPSBUaW1lb3V0KHJlYWQ9TE9OR19USU1FT1VULCBjb25uZWN0PUxPTkdfVElNRU9VVCkKICAgICAgICBwb29sID0gSFRUUENvbm5lY3Rpb25Qb29sKGhvc3QsIHBvcnQsIHRpbWVvdXQ9YmlnX3RpbWVvdXQsIHJldHJpZXM9RmFsc2UpCiAgICAgICAgc2VsZi5hZGRDbGVhbnVwKHBvb2wuY2xvc2UpCiAgICAgICAgY29ubiA9IHBvb2wuX2dldF9jb25uKCkKICAgICAgICBzZWxmLmFzc2VydFJhaXNlcyhDb25uZWN0VGltZW91dEVycm9yLAogICAgICAgICAgICAgICAgICAgICAgICAgIHBvb2wuX21ha2VfcmVxdWVzdCwKICAgICAgICAgICAgICAgICAgICAgICAgICBjb25uLCAnR0VUJywgdXJsLAogICAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVvdXQ9dGltZW91dCkKCiAgICAgICAgcG9vbC5fcHV0X2Nvbm4oY29ubikKICAgICAgICBzZWxmLmFzc2VydFJhaXNlcyhDb25uZWN0VGltZW91dEVycm9yLCBwb29sLnJlcXVlc3QsICdHRVQnLCB1cmwsIHRpbWVvdXQ9dGltZW91dCkKCiAgICBkZWYgdGVzdF90b3RhbF9hcHBsaWVzX2Nvbm5lY3Qoc2VsZik6CiAgICAgICAgaG9zdCwgcG9ydCA9IFRBUlBJVF9IT1NULCA4MAoKICAgICAgICB0aW1lb3V0ID0gVGltZW91dCh0b3RhbD1Ob25lLCBjb25uZWN0PVNIT1JUX1RJTUVPVVQpCiAgICAgICAgcG9vbCA9IEhUVFBDb25uZWN0aW9uUG9vbChob3N0LCBwb3J0LCB0aW1lb3V0PXRpbWVvdXQpCiAgICAgICAgc2VsZi5hZGRDbGVhbnVwKHBvb2wuY2xvc2UpCiAgICAgICAgY29ubiA9IHBvb2wuX2dldF9jb25uKCkKICAgICAgICBzZWxmLmFzc2VydFJhaXNlcyhDb25uZWN0VGltZW91dEVycm9yLCBwb29sLl9tYWtlX3JlcXVlc3QsIGNvbm4sICdHRVQnLCAnLycpCgogICAgICAgIHRpbWVvdXQgPSBUaW1lb3V0KGNvbm5lY3Q9MywgcmVhZD01LCB0b3RhbD1TSE9SVF9USU1FT1VUKQogICAgICAgIHBvb2wgPSBIVFRQQ29ubmVjdGlvblBvb2woaG9zdCwgcG9ydCwgdGltZW91dD10aW1lb3V0KQogICAgICAgIHNlbGYuYWRkQ2xlYW51cChwb29sLmNsb3NlKQogICAgICAgIGNvbm4gPSBwb29sLl9nZXRfY29ubigpCiAgICAgICAgc2VsZi5hc3NlcnRSYWlzZXMoQ29ubmVjdFRpbWVvdXRFcnJvciwgcG9vbC5fbWFrZV9yZXF1ZXN0LCBjb25uLCAnR0VUJywgJy8nKQoKICAgIGRlZiB0ZXN0X3RvdGFsX3RpbWVvdXQoc2VsZik6CiAgICAgICAgYmxvY2tfZXZlbnQgPSBFdmVudCgpCiAgICAgICAgcmVhZHlfZXZlbnQgPSBzZWxmLnN0YXJ0X2Jhc2ljX2hhbmRsZXIoYmxvY2tfc2VuZD1ibG9ja19ldmVudCwgbnVtPTIpCgogICAgICAgIHdhaXRfZm9yX3NvY2tldChyZWFkeV9ldmVudCkKICAgICAgICAjIFRoaXMgd2lsbCBnZXQgdGhlIHNvY2tldCB0byByYWlzZSBhbiBFQUdBSU4gb24gdGhlIHJlYWQKICAgICAgICB0aW1lb3V0ID0gVGltZW91dChjb25uZWN0PTMsIHJlYWQ9U0hPUlRfVElNRU9VVCkKICAgICAgICBwb29sID0gSFRUUENvbm5lY3Rpb25Qb29sKHNlbGYuaG9zdCwgc2VsZi5wb3J0LCB0aW1lb3V0PXRpbWVvdXQsIHJldHJpZXM9RmFsc2UpCiAgICAgICAgc2VsZi5hZGRDbGVhbnVwKHBvb2wuY2xvc2UpCiAgICAgICAgc2VsZi5hc3NlcnRSYWlzZXMoUmVhZFRpbWVvdXRFcnJvciwgcG9vbC5yZXF1ZXN0LCAnR0VUJywgJy8nKQoKICAgICAgICBibG9ja19ldmVudC5zZXQoKQogICAgICAgIHdhaXRfZm9yX3NvY2tldChyZWFkeV9ldmVudCkKICAgICAgICBibG9ja19ldmVudC5jbGVhcigpCgogICAgICAgICMgVGhlIGNvbm5lY3Qgc2hvdWxkIHN1Y2NlZWQgYW5kIHRoaXMgc2hvdWxkIGhpdCB0aGUgcmVhZCB0aW1lb3V0CiAgICAgICAgdGltZW91dCA9IFRpbWVvdXQoY29ubmVjdD0zLCByZWFkPTUsIHRvdGFsPVNIT1JUX1RJTUVPVVQpCiAgICAgICAgcG9vbCA9IEhUVFBDb25uZWN0aW9uUG9vbChzZWxmLmhvc3QsIHNlbGYucG9ydCwgdGltZW91dD10aW1lb3V0LCByZXRyaWVzPUZhbHNlKQogICAgICAgIHNlbGYuYWRkQ2xlYW51cChwb29sLmNsb3NlKQogICAgICAgIHNlbGYuYXNzZXJ0UmFpc2VzKFJlYWRUaW1lb3V0RXJyb3IsIHBvb2wucmVxdWVzdCwgJ0dFVCcsICcvJykKCiAgICBkZWYgdGVzdF9jcmVhdGVfY29ubmVjdGlvbl90aW1lb3V0KHNlbGYpOgogICAgICAgIHRpbWVvdXQgPSBUaW1lb3V0KGNvbm5lY3Q9U0hPUlRfVElNRU9VVCwgdG90YWw9TE9OR19USU1FT1VUKQogICAgICAgIHBvb2wgPSBIVFRQQ29ubmVjdGlvblBvb2woVEFSUElUX0hPU1QsIHNlbGYucG9ydCwgdGltZW91dD10aW1lb3V0LCByZXRyaWVzPUZhbHNlKQogICAgICAgIHNlbGYuYWRkQ2xlYW51cChwb29sLmNsb3NlKQogICAgICAgIGNvbm4gPSBwb29sLl9uZXdfY29ubigpCiAgICAgICAgc2VsZi5hc3NlcnRSYWlzZXMoQ29ubmVjdFRpbWVvdXRFcnJvciwgY29ubi5jb25uZWN0KQoKCmNsYXNzIFRlc3RDb25uZWN0aW9uUG9vbChIVFRQRHVtbXlTZXJ2ZXJUZXN0Q2FzZSk6CgogICAgZGVmIHNldFVwKHNlbGYpOgogICAgICAgIHNlbGYucG9vbCA9IEhUVFBDb25uZWN0aW9uUG9vbChzZWxmLmhvc3QsIHNlbGYucG9ydCkKICAgICAgICBzZWxmLmFkZENsZWFudXAoc2VsZi5wb29sLmNsb3NlKQoKICAgIGRlZiB0ZXN0X2dldChzZWxmKToKICAgICAgICByID0gc2VsZi5wb29sLnJlcXVlc3QoJ0dFVCcsICcvc3BlY2lmaWNfbWV0aG9kJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmllbGRzPXsnbWV0aG9kJzogJ0dFVCd9KQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoci5zdGF0dXMsIDIwMCwgci5kYXRhKQoKICAgIGRlZiB0ZXN0X3Bvc3RfdXJsKHNlbGYpOgogICAgICAgIHIgPSBzZWxmLnBvb2wucmVxdWVzdCgnUE9TVCcsICcvc3BlY2lmaWNfbWV0aG9kJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmllbGRzPXsnbWV0aG9kJzogJ1BPU1QnfSkKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKHIuc3RhdHVzLCAyMDAsIHIuZGF0YSkKCiAgICBkZWYgdGVzdF91cmxvcGVuX3B1dChzZWxmKToKICAgICAgICByID0gc2VsZi5wb29sLnVybG9wZW4oJ1BVVCcsICcvc3BlY2lmaWNfbWV0aG9kP21ldGhvZD1QVVQnKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoci5zdGF0dXMsIDIwMCwgci5kYXRhKQoKICAgIGRlZiB0ZXN0X3dyb25nX3NwZWNpZmljX21ldGhvZChzZWxmKToKICAgICAgICAjIFRvIG1ha2Ugc3VyZSB0aGUgZHVtbXkgc2VydmVyIGlzIGFjdHVhbGx5IHJldHVybmluZyBmYWlsZWQgcmVzcG9uc2VzCiAgICAgICAgciA9IHNlbGYucG9vbC5yZXF1ZXN0KCdHRVQnLCAnL3NwZWNpZmljX21ldGhvZCcsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpZWxkcz17J21ldGhvZCc6ICdQT1NUJ30pCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChyLnN0YXR1cywgNDAwLCByLmRhdGEpCgogICAgICAgIHIgPSBzZWxmLnBvb2wucmVxdWVzdCgnUE9TVCcsICcvc3BlY2lmaWNfbWV0aG9kJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmllbGRzPXsnbWV0aG9kJzogJ0dFVCd9KQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoci5zdGF0dXMsIDQwMCwgci5kYXRhKQoKICAgIGRlZiB0ZXN0X3VwbG9hZChzZWxmKToKICAgICAgICBkYXRhID0gIkknbSBpbiB1ciBtdWx0aXBhcnQgZm9ybS1kYXRhLCBoYXppbmcgYSBjaGVlemJ1cmdyIgogICAgICAgIGZpZWxkcyA9IHsKICAgICAgICAgICAgJ3VwbG9hZF9wYXJhbSc6ICdmaWxlZmllbGQnLAogICAgICAgICAgICAndXBsb2FkX2ZpbGVuYW1lJzogJ2xvbGNhdC50eHQnLAogICAgICAgICAgICAndXBsb2FkX3NpemUnOiBsZW4oZGF0YSksCiAgICAgICAgICAgICdmaWxlZmllbGQnOiAoJ2xvbGNhdC50eHQnLCBkYXRhKSwKICAgICAgICB9CgogICAgICAgIHIgPSBzZWxmLnBvb2wucmVxdWVzdCgnUE9TVCcsICcvdXBsb2FkJywgZmllbGRzPWZpZWxkcykKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKHIuc3RhdHVzLCAyMDAsIHIuZGF0YSkKCiAgICBkZWYgdGVzdF9vbmVfbmFtZV9tdWx0aXBsZV92YWx1ZXMoc2VsZik6CiAgICAgICAgZmllbGRzID0gWwogICAgICAgICAgICAoJ2ZvbycsICdhJyksCiAgICAgICAgICAgICgnZm9vJywgJ2InKSwKICAgICAgICBdCgogICAgICAgICMgdXJsZW5jb2RlCiAgICAgICAgciA9IHNlbGYucG9vbC5yZXF1ZXN0KCdHRVQnLCAnL2VjaG8nLCBmaWVsZHM9ZmllbGRzKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoci5kYXRhLCBiJ2Zvbz1hJmZvbz1iJykKCiAgICAgICAgIyBtdWx0aXBhcnQKICAgICAgICByID0gc2VsZi5wb29sLnJlcXVlc3QoJ1BPU1QnLCAnL2VjaG8nLCBmaWVsZHM9ZmllbGRzKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoci5kYXRhLmNvdW50KGInbmFtZT0iZm9vIicpLCAyKQoKICAgIGRlZiB0ZXN0X3JlcXVlc3RfbWV0aG9kX2JvZHkoc2VsZik6CiAgICAgICAgYm9keSA9IGInaGknCiAgICAgICAgciA9IHNlbGYucG9vbC5yZXF1ZXN0KCdQT1NUJywgJy9lY2hvJywgYm9keT1ib2R5KQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoci5kYXRhLCBib2R5KQoKICAgICAgICBmaWVsZHMgPSBbKCdoaScsICdoZWxsbycpXQogICAgICAgIHNlbGYuYXNzZXJ0UmFpc2VzKFR5cGVFcnJvciwgc2VsZi5wb29sLnJlcXVlc3QsICdQT1NUJywgJy9lY2hvJywgYm9keT1ib2R5LCBmaWVsZHM9ZmllbGRzKQoKICAgIGRlZiB0ZXN0X3VuaWNvZGVfdXBsb2FkKHNlbGYpOgogICAgICAgIGZpZWxkbmFtZSA9IHUoJ215ZmlsZScpCiAgICAgICAgZmlsZW5hbWUgPSB1KCdceGUyXHg5OVx4YTUudHh0JykKICAgICAgICBkYXRhID0gdSgnXHhlMlx4OTlceGE1JykuZW5jb2RlKCd1dGY4JykKICAgICAgICBzaXplID0gbGVuKGRhdGEpCgogICAgICAgIGZpZWxkcyA9IHsKICAgICAgICAgICAgdSgndXBsb2FkX3BhcmFtJyk6IGZpZWxkbmFtZSwKICAgICAgICAgICAgdSgndXBsb2FkX2ZpbGVuYW1lJyk6IGZpbGVuYW1lLAogICAgICAgICAgICB1KCd1cGxvYWRfc2l6ZScpOiBzaXplLAogICAgICAgICAgICBmaWVsZG5hbWU6IChmaWxlbmFtZSwgZGF0YSksCiAgICAgICAgfQoKICAgICAgICByID0gc2VsZi5wb29sLnJlcXVlc3QoJ1BPU1QnLCAnL3VwbG9hZCcsIGZpZWxkcz1maWVsZHMpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChyLnN0YXR1cywgMjAwLCByLmRhdGEpCgogICAgZGVmIHRlc3RfbmFnbGUoc2VsZik6CiAgICAgICAgIiIiIFRlc3QgdGhhdCBjb25uZWN0aW9ucyBoYXZlIFRDUF9OT0RFTEFZIHR1cm5lZCBvbiAiIiIKICAgICAgICAjIFRoaXMgdGVzdCBuZWVkcyB0byBiZSBoZXJlIGluIG9yZGVyIHRvIGJlIHJ1bi4gc29ja2V0LmNyZWF0ZV9jb25uZWN0aW9uIGFjdHVhbGx5IHRyaWVzCiAgICAgICAgIyB0byBjb25uZWN0IHRvIHRoZSBob3N0IHByb3ZpZGVkIHNvIHdlIG5lZWQgYSBkdW1teXNlcnZlciB0byBiZSBydW5uaW5nLgogICAgICAgIHBvb2wgPSBIVFRQQ29ubmVjdGlvblBvb2woc2VsZi5ob3N0LCBzZWxmLnBvcnQpCiAgICAgICAgY29ubiA9IHBvb2wuX2dldF9jb25uKCkKICAgICAgICBwb29sLl9tYWtlX3JlcXVlc3QoY29ubiwgJ0dFVCcsICcvJykKICAgICAgICB0Y3Bfbm9kZWxheV9zZXR0aW5nID0gY29ubi5zb2NrLmdldHNvY2tvcHQoc29ja2V0LklQUFJPVE9fVENQLCBzb2NrZXQuVENQX05PREVMQVkpCiAgICAgICAgc2VsZi5hc3NlcnRUcnVlKHRjcF9ub2RlbGF5X3NldHRpbmcpCgogICAgZGVmIHRlc3Rfc29ja2V0X29wdGlvbnMoc2VsZik6CiAgICAgICAgIiIiVGVzdCB0aGF0IGNvbm5lY3Rpb25zIGFjY2VwdCBzb2NrZXQgb3B0aW9ucy4iIiIKICAgICAgICAjIFRoaXMgdGVzdCBuZWVkcyB0byBiZSBoZXJlIGluIG9yZGVyIHRvIGJlIHJ1bi4gc29ja2V0LmNyZWF0ZV9jb25uZWN0aW9uIGFjdHVhbGx5IHRyaWVzIHRvCiAgICAgICAgIyBjb25uZWN0IHRvIHRoZSBob3N0IHByb3ZpZGVkIHNvIHdlIG5lZWQgYSBkdW1teXNlcnZlciB0byBiZSBydW5uaW5nLgogICAgICAgIHBvb2wgPSBIVFRQQ29ubmVjdGlvblBvb2woc2VsZi5ob3N0LCBzZWxmLnBvcnQsIHNvY2tldF9vcHRpb25zPVsKICAgICAgICAgICAgKHNvY2tldC5TT0xfU09DS0VULCBzb2NrZXQuU09fS0VFUEFMSVZFLCAxKQogICAgICAgIF0pCiAgICAgICAgcyA9IHBvb2wuX25ld19jb25uKCkuX25ld19jb25uKCkgICMgR2V0IHRoZSBzb2NrZXQKICAgICAgICB1c2luZ19rZWVwYWxpdmUgPSBzLmdldHNvY2tvcHQoc29ja2V0LlNPTF9TT0NLRVQsIHNvY2tldC5TT19LRUVQQUxJVkUpID4gMAogICAgICAgIHNlbGYuYXNzZXJ0VHJ1ZSh1c2luZ19rZWVwYWxpdmUpCiAgICAgICAgcy5jbG9zZSgpCgogICAgZGVmIHRlc3RfZGlzYWJsZV9kZWZhdWx0X3NvY2tldF9vcHRpb25zKHNlbGYpOgogICAgICAgICIiIlRlc3QgdGhhdCBwYXNzaW5nIE5vbmUgZGlzYWJsZXMgYWxsIHNvY2tldCBvcHRpb25zLiIiIgogICAgICAgICMgVGhpcyB0ZXN0IG5lZWRzIHRvIGJlIGhlcmUgaW4gb3JkZXIgdG8gYmUgcnVuLiBzb2NrZXQuY3JlYXRlX2Nvbm5lY3Rpb24gYWN0dWFsbHkgdHJpZXMKICAgICAgICAjIHRvIGNvbm5lY3QgdG8gdGhlIGhvc3QgcHJvdmlkZWQgc28gd2UgbmVlZCBhIGR1bW15c2VydmVyIHRvIGJlIHJ1bm5pbmcuCiAgICAgICAgcG9vbCA9IEhUVFBDb25uZWN0aW9uUG9vbChzZWxmLmhvc3QsIHNlbGYucG9ydCwgc29ja2V0X29wdGlvbnM9Tm9uZSkKICAgICAgICBzID0gcG9vbC5fbmV3X2Nvbm4oKS5fbmV3X2Nvbm4oKQogICAgICAgIHVzaW5nX25hZ2xlID0gcy5nZXRzb2Nrb3B0KHNvY2tldC5JUFBST1RPX1RDUCwgc29ja2V0LlRDUF9OT0RFTEFZKSA9PSAwCiAgICAgICAgc2VsZi5hc3NlcnRUcnVlKHVzaW5nX25hZ2xlKQogICAgICAgIHMuY2xvc2UoKQoKICAgIGRlZiB0ZXN0X2RlZmF1bHRzX2FyZV9hcHBsaWVkKHNlbGYpOgogICAgICAgICIiIlRlc3QgdGhhdCBtb2RpZnlpbmcgdGhlIGRlZmF1bHQgc29ja2V0IG9wdGlvbnMgd29ya3MuIiIiCiAgICAgICAgIyBUaGlzIHRlc3QgbmVlZHMgdG8gYmUgaGVyZSBpbiBvcmRlciB0byBiZSBydW4uIHNvY2tldC5jcmVhdGVfY29ubmVjdGlvbiBhY3R1YWxseSB0cmllcwogICAgICAgICMgdG8gY29ubmVjdCB0byB0aGUgaG9zdCBwcm92aWRlZCBzbyB3ZSBuZWVkIGEgZHVtbXlzZXJ2ZXIgdG8gYmUgcnVubmluZy4KICAgICAgICBwb29sID0gSFRUUENvbm5lY3Rpb25Qb29sKHNlbGYuaG9zdCwgc2VsZi5wb3J0KQogICAgICAgICMgR2V0IHRoZSBIVFRQQ29ubmVjdGlvbiBpbnN0YW5jZQogICAgICAgIGNvbm4gPSBwb29sLl9uZXdfY29ubigpCiAgICAgICAgIyBVcGRhdGUgdGhlIGRlZmF1bHQgc29ja2V0IG9wdGlvbnMKICAgICAgICBjb25uLmRlZmF1bHRfc29ja2V0X29wdGlvbnMgKz0gWyhzb2NrZXQuU09MX1NPQ0tFVCwgc29ja2V0LlNPX0tFRVBBTElWRSwgMSldCiAgICAgICAgcyA9IGNvbm4uX25ld19jb25uKCkKICAgICAgICBuYWdsZV9kaXNhYmxlZCA9IHMuZ2V0c29ja29wdChzb2NrZXQuSVBQUk9UT19UQ1AsIHNvY2tldC5UQ1BfTk9ERUxBWSkgPiAwCiAgICAgICAgdXNpbmdfa2VlcGFsaXZlID0gcy5nZXRzb2Nrb3B0KHNvY2tldC5TT0xfU09DS0VULCBzb2NrZXQuU09fS0VFUEFMSVZFKSA+IDAKICAgICAgICBzZWxmLmFzc2VydFRydWUobmFnbGVfZGlzYWJsZWQpCiAgICAgICAgc2VsZi5hc3NlcnRUcnVlKHVzaW5nX2tlZXBhbGl2ZSkKCiAgICBkZWYgdGVzdF9jb25uZWN0aW9uX2Vycm9yX3JldHJpZXMoc2VsZik6CiAgICAgICAgIiIiIEVDT05OUkVGVVNFRCBlcnJvciBzaG91bGQgcmFpc2UgYSBjb25uZWN0aW9uIGVycm9yLCB3aXRoIHJldHJpZXMgIiIiCiAgICAgICAgcG9ydCA9IGZpbmRfdW51c2VkX3BvcnQoKQogICAgICAgIHBvb2wgPSBIVFRQQ29ubmVjdGlvblBvb2woc2VsZi5ob3N0LCBwb3J0KQogICAgICAgIHRyeToKICAgICAgICAgICAgcG9vbC5yZXF1ZXN0KCdHRVQnLCAnLycsIHJldHJpZXM9UmV0cnkoY29ubmVjdD0zKSkKICAgICAgICAgICAgc2VsZi5mYWlsKCJTaG91bGQgaGF2ZSBmYWlsZWQgd2l0aCBhIGNvbm5lY3Rpb24gZXJyb3IuIikKICAgICAgICBleGNlcHQgTWF4UmV0cnlFcnJvciBhcyBlOgogICAgICAgICAgICBzZWxmLmFzc2VydEVxdWFsKHR5cGUoZS5yZWFzb24pLCBOZXdDb25uZWN0aW9uRXJyb3IpCgogICAgZGVmIHRlc3RfdGltZW91dF9zdWNjZXNzKHNlbGYpOgogICAgICAgIHRpbWVvdXQgPSBUaW1lb3V0KGNvbm5lY3Q9MywgcmVhZD01LCB0b3RhbD1Ob25lKQogICAgICAgIHBvb2wgPSBIVFRQQ29ubmVjdGlvblBvb2woc2VsZi5ob3N0LCBzZWxmLnBvcnQsIHRpbWVvdXQ9dGltZW91dCkKICAgICAgICBwb29sLnJlcXVlc3QoJ0dFVCcsICcvJykKICAgICAgICAjIFRoaXMgc2hvdWxkIG5vdCByYWlzZSBhICJUaW1lb3V0IGFscmVhZHkgc3RhcnRlZCIgZXJyb3IKICAgICAgICBwb29sLnJlcXVlc3QoJ0dFVCcsICcvJykKCiAgICAgICAgcG9vbCA9IEhUVFBDb25uZWN0aW9uUG9vbChzZWxmLmhvc3QsIHNlbGYucG9ydCwgdGltZW91dD10aW1lb3V0KQogICAgICAgICMgVGhpcyBzaG91bGQgYWxzbyBub3QgcmFpc2UgYSAiVGltZW91dCBhbHJlYWR5IHN0YXJ0ZWQiIGVycm9yCiAgICAgICAgcG9vbC5yZXF1ZXN0KCdHRVQnLCAnLycpCgogICAgICAgIHRpbWVvdXQgPSBUaW1lb3V0KHRvdGFsPU5vbmUpCiAgICAgICAgcG9vbCA9IEhUVFBDb25uZWN0aW9uUG9vbChzZWxmLmhvc3QsIHNlbGYucG9ydCwgdGltZW91dD10aW1lb3V0KQogICAgICAgIHBvb2wucmVxdWVzdCgnR0VUJywgJy8nKQoKICAgIGRlZiB0ZXN0X3R1bm5lbChzZWxmKToKICAgICAgICAjIG5vdGUgdGhlIGFjdHVhbCBodHRwbGliLnB5IGhhcyBubyB0ZXN0cyBmb3IgdGhpcyBmdW5jdGlvbmFsaXR5CiAgICAgICAgdGltZW91dCA9IFRpbWVvdXQodG90YWw9Tm9uZSkKICAgICAgICBwb29sID0gSFRUUENvbm5lY3Rpb25Qb29sKHNlbGYuaG9zdCwgc2VsZi5wb3J0LCB0aW1lb3V0PXRpbWVvdXQpCiAgICAgICAgY29ubiA9IHBvb2wuX2dldF9jb25uKCkKICAgICAgICB0cnk6CiAgICAgICAgICAgIGNvbm4uc2V0X3R1bm5lbChzZWxmLmhvc3QsIHNlbGYucG9ydCkKICAgICAgICBleGNlcHQgQXR0cmlidXRlRXJyb3I6ICAjIHB5dGhvbiAyLjYKICAgICAgICAgICAgY29ubi5fc2V0X3R1bm5lbChzZWxmLmhvc3QsIHNlbGYucG9ydCkKCiAgICAgICAgY29ubi5fdHVubmVsID0gbW9jay5Nb2NrKHJldHVybl92YWx1ZT1Ob25lKQogICAgICAgIHBvb2wuX21ha2VfcmVxdWVzdChjb25uLCAnR0VUJywgJy8nKQogICAgICAgIGNvbm4uX3R1bm5lbC5hc3NlcnRfY2FsbGVkX29uY2Vfd2l0aCgpCgogICAgICAgICMgdGVzdCB0aGF0IGl0J3Mgbm90IGNhbGxlZCB3aGVuIHR1bm5lbCBpcyBub3Qgc2V0CiAgICAgICAgdGltZW91dCA9IFRpbWVvdXQodG90YWw9Tm9uZSkKICAgICAgICBwb29sID0gSFRUUENvbm5lY3Rpb25Qb29sKHNlbGYuaG9zdCwgc2VsZi5wb3J0LCB0aW1lb3V0PXRpbWVvdXQpCiAgICAgICAgY29ubiA9IHBvb2wuX2dldF9jb25uKCkKCiAgICAgICAgY29ubi5fdHVubmVsID0gbW9jay5Nb2NrKHJldHVybl92YWx1ZT1Ob25lKQogICAgICAgIHBvb2wuX21ha2VfcmVxdWVzdChjb25uLCAnR0VUJywgJy8nKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoY29ubi5fdHVubmVsLmNhbGxlZCwgRmFsc2UpCgogICAgZGVmIHRlc3RfcmVkaXJlY3Qoc2VsZik6CiAgICAgICAgciA9IHNlbGYucG9vbC5yZXF1ZXN0KCdHRVQnLCAnL3JlZGlyZWN0JywgZmllbGRzPXsndGFyZ2V0JzogJy8nfSwgcmVkaXJlY3Q9RmFsc2UpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChyLnN0YXR1cywgMzAzKQoKICAgICAgICByID0gc2VsZi5wb29sLnJlcXVlc3QoJ0dFVCcsICcvcmVkaXJlY3QnLCBmaWVsZHM9eyd0YXJnZXQnOiAnLyd9KQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoci5zdGF0dXMsIDIwMCkKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKHIuZGF0YSwgYidEdW1teSBzZXJ2ZXIhJykKCiAgICBkZWYgdGVzdF9iYWRfY29ubmVjdChzZWxmKToKICAgICAgICBwb29sID0gSFRUUENvbm5lY3Rpb25Qb29sKCdiYWRob3N0LmludmFsaWQnLCBzZWxmLnBvcnQpCiAgICAgICAgdHJ5OgogICAgICAgICAgICBwb29sLnJlcXVlc3QoJ0dFVCcsICcvJywgcmV0cmllcz01KQogICAgICAgICAgICBzZWxmLmZhaWwoInNob3VsZCByYWlzZSB0aW1lb3V0IGV4Y2VwdGlvbiBoZXJlIikKICAgICAgICBleGNlcHQgTWF4UmV0cnlFcnJvciBhcyBlOgogICAgICAgICAgICBzZWxmLmFzc2VydEVxdWFsKHR5cGUoZS5yZWFzb24pLCBOZXdDb25uZWN0aW9uRXJyb3IpCgogICAgZGVmIHRlc3Rfa2VlcGFsaXZlKHNlbGYpOgogICAgICAgIHBvb2wgPSBIVFRQQ29ubmVjdGlvblBvb2woc2VsZi5ob3N0LCBzZWxmLnBvcnQsIGJsb2NrPVRydWUsIG1heHNpemU9MSkKCiAgICAgICAgciA9IHBvb2wucmVxdWVzdCgnR0VUJywgJy9rZWVwYWxpdmU/Y2xvc2U9MCcpCiAgICAgICAgciA9IHBvb2wucmVxdWVzdCgnR0VUJywgJy9rZWVwYWxpdmU/Y2xvc2U9MCcpCgogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoci5zdGF0dXMsIDIwMCkKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKHBvb2wubnVtX2Nvbm5lY3Rpb25zLCAxKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwocG9vbC5udW1fcmVxdWVzdHMsIDIpCgogICAgZGVmIHRlc3Rfa2VlcGFsaXZlX2Nsb3NlKHNlbGYpOgogICAgICAgIHBvb2wgPSBIVFRQQ29ubmVjdGlvblBvb2woc2VsZi5ob3N0LCBzZWxmLnBvcnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBibG9jaz1UcnVlLCBtYXhzaXplPTEsIHRpbWVvdXQ9MikKCiAgICAgICAgciA9IHBvb2wucmVxdWVzdCgnR0VUJywgJy9rZWVwYWxpdmU/Y2xvc2U9MScsIHJldHJpZXM9MCwKICAgICAgICAgICAgICAgICAgICAgICAgIGhlYWRlcnM9ewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICJDb25uZWN0aW9uIjogImNsb3NlIiwKICAgICAgICAgICAgICAgICAgICAgICAgIH0pCgogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwocG9vbC5udW1fY29ubmVjdGlvbnMsIDEpCgogICAgICAgICMgVGhlIGR1bW15c2VydmVyIHdpbGwgaGF2ZSByZXNwb25kZWQgd2l0aCBDb25uZWN0aW9uOmNsb3NlLAogICAgICAgICMgYW5kIGh0dHBsaWIgd2lsbCBwcm9wZXJseSBjbGVhbnVwIHRoZSBzb2NrZXQuCgogICAgICAgICMgV2UgZ3JhYiB0aGUgSFRUUENvbm5lY3Rpb24gb2JqZWN0IHN0cmFpZ2h0IGZyb20gdGhlIFF1ZXVlLAogICAgICAgICMgYmVjYXVzZSBfZ2V0X2Nvbm4oKSBpcyB3aGVyZSB0aGUgY2hlY2sgJiByZXNldCBvY2N1cnMKICAgICAgICAjIHB5bGludDogZGlzYWJsZS1tc2c9VzAyMTIKICAgICAgICBjb25uID0gcG9vbC5wb29sLmdldCgpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChjb25uLnNvY2ssIE5vbmUpCiAgICAgICAgcG9vbC5fcHV0X2Nvbm4oY29ubikKCiAgICAgICAgIyBOb3cgd2l0aCBrZWVwLWFsaXZlCiAgICAgICAgciA9IHBvb2wucmVxdWVzdCgnR0VUJywgJy9rZWVwYWxpdmU/Y2xvc2U9MCcsIHJldHJpZXM9MCwKICAgICAgICAgICAgICAgICAgICAgICAgIGhlYWRlcnM9ewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICJDb25uZWN0aW9uIjogImtlZXAtYWxpdmUiLAogICAgICAgICAgICAgICAgICAgICAgICAgfSkKCiAgICAgICAgIyBUaGUgZHVtbXlzZXJ2ZXIgcmVzcG9uZGVkIHdpdGggQ29ubmVjdGlvbjprZWVwLWFsaXZlLCB0aGUgY29ubmVjdGlvbgogICAgICAgICMgcGVyc2lzdHMuCiAgICAgICAgY29ubiA9IHBvb2wucG9vbC5nZXQoKQogICAgICAgIHNlbGYuYXNzZXJ0Tm90RXF1YWwoY29ubi5zb2NrLCBOb25lKQogICAgICAgIHBvb2wuX3B1dF9jb25uKGNvbm4pCgogICAgICAgICMgQW5vdGhlciByZXF1ZXN0IGFza2luZyB0aGUgc2VydmVyIHRvIGNsb3NlIHRoZSBjb25uZWN0aW9uLiBUaGlzIG9uZQogICAgICAgICMgc2hvdWxkIGdldCBjbGVhbmVkIHVwIGZvciB0aGUgbmV4dCByZXF1ZXN0LgogICAgICAgIHIgPSBwb29sLnJlcXVlc3QoJ0dFVCcsICcva2VlcGFsaXZlP2Nsb3NlPTEnLCByZXRyaWVzPTAsCiAgICAgICAgICAgICAgICAgICAgICAgICBoZWFkZXJzPXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiQ29ubmVjdGlvbiI6ICJjbG9zZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICB9KQoKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKHIuc3RhdHVzLCAyMDApCgogICAgICAgIGNvbm4gPSBwb29sLnBvb2wuZ2V0KCkKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKGNvbm4uc29jaywgTm9uZSkKICAgICAgICBwb29sLl9wdXRfY29ubihjb25uKQoKICAgICAgICAjIE5leHQgcmVxdWVzdAogICAgICAgIHIgPSBwb29sLnJlcXVlc3QoJ0dFVCcsICcva2VlcGFsaXZlP2Nsb3NlPTAnKQoKICAgIGRlZiB0ZXN0X3Bvc3Rfd2l0aF91cmxlbmNvZGUoc2VsZik6CiAgICAgICAgZGF0YSA9IHsnYmFuYW5hJzogJ2hhbW1vY2snLCAnbG9sJzogJ2NhdCd9CiAgICAgICAgciA9IHNlbGYucG9vbC5yZXF1ZXN0KCdQT1NUJywgJy9lY2hvJywgZmllbGRzPWRhdGEsIGVuY29kZV9tdWx0aXBhcnQ9RmFsc2UpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChyLmRhdGEuZGVjb2RlKCd1dGYtOCcpLCB1cmxlbmNvZGUoZGF0YSkpCgogICAgZGVmIHRlc3RfcG9zdF93aXRoX211bHRpcGFydChzZWxmKToKICAgICAgICBkYXRhID0geydiYW5hbmEnOiAnaGFtbW9jaycsICdsb2wnOiAnY2F0J30KICAgICAgICByID0gc2VsZi5wb29sLnJlcXVlc3QoJ1BPU1QnLCAnL2VjaG8nLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWVsZHM9ZGF0YSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZW5jb2RlX211bHRpcGFydD1UcnVlKQogICAgICAgIGJvZHkgPSByLmRhdGEuc3BsaXQoYidcclxuJykKCiAgICAgICAgZW5jb2RlZF9kYXRhID0gZW5jb2RlX211bHRpcGFydF9mb3JtZGF0YShkYXRhKVswXQogICAgICAgIGV4cGVjdGVkX2JvZHkgPSBlbmNvZGVkX2RhdGEuc3BsaXQoYidcclxuJykKCiAgICAgICAgIyBUT0RPOiBHZXQgcmlkIG9mIGV4dHJhIHBhcnNpbmcgc3R1ZmYgd2hlbiB5b3UgY2FuIHNwZWNpZnkKICAgICAgICAjIGEgY3VzdG9tIGJvdW5kYXJ5IHRvIGVuY29kZV9tdWx0aXBhcnRfZm9ybWRhdGEKICAgICAgICAiIiIKICAgICAgICBXZSBuZWVkIHRvIGxvb3AgdGhlIHJldHVybiBsaW5lcyBiZWNhdXNlIGEgdGltZXN0YW1wIGlzIGF0dGFjaGVkCiAgICAgICAgZnJvbSB3aXRoaW4gZW5jb2RlX211bHRpcGFydF9mb3JtZGF0YS4gV2hlbiB0aGUgc2VydmVyIGVjaG9zIGJhY2sKICAgICAgICB0aGUgZGF0YSwgaXQgaGFzIHRoZSB0aW1lc3RhbXAgZnJvbSB3aGVuIHRoZSBkYXRhIHdhcyBlbmNvZGVkLCB3aGljaAogICAgICAgIGlzIG5vdCBlcXVpdmFsZW50IHRvIHdoZW4gd2UgcnVuIGVuY29kZV9tdWx0aXBhcnRfZm9ybWRhdGEgb24KICAgICAgICB0aGUgZGF0YSBhZ2Fpbi4KICAgICAgICAiIiIKICAgICAgICBmb3IgaSwgbGluZSBpbiBlbnVtZXJhdGUoYm9keSk6CiAgICAgICAgICAgIGlmIGxpbmUuc3RhcnRzd2l0aChiJy0tJyk6CiAgICAgICAgICAgICAgICBjb250aW51ZQoKICAgICAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChib2R5W2ldLCBleHBlY3RlZF9ib2R5W2ldKQoKICAgIGRlZiB0ZXN0X2NoZWNrX2d6aXAoc2VsZik6CiAgICAgICAgciA9IHNlbGYucG9vbC5yZXF1ZXN0KCdHRVQnLCAnL2VuY29kaW5ncmVxdWVzdCcsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhlYWRlcnM9eydhY2NlcHQtZW5jb2RpbmcnOiAnZ3ppcCd9KQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoci5oZWFkZXJzLmdldCgnY29udGVudC1lbmNvZGluZycpLCAnZ3ppcCcpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChyLmRhdGEsIGInaGVsbG8sIHdvcmxkIScpCgogICAgZGVmIHRlc3RfY2hlY2tfZGVmbGF0ZShzZWxmKToKICAgICAgICByID0gc2VsZi5wb29sLnJlcXVlc3QoJ0dFVCcsICcvZW5jb2RpbmdyZXF1ZXN0JywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaGVhZGVycz17J2FjY2VwdC1lbmNvZGluZyc6ICdkZWZsYXRlJ30pCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChyLmhlYWRlcnMuZ2V0KCdjb250ZW50LWVuY29kaW5nJyksICdkZWZsYXRlJykKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKHIuZGF0YSwgYidoZWxsbywgd29ybGQhJykKCiAgICBkZWYgdGVzdF9iYWRfZGVjb2RlKHNlbGYpOgogICAgICAgIHNlbGYuYXNzZXJ0UmFpc2VzKERlY29kZUVycm9yLCBzZWxmLnBvb2wucmVxdWVzdCwKICAgICAgICAgICAgICAgICAgICAgICAgICAnR0VUJywgJy9lbmNvZGluZ3JlcXVlc3QnLAogICAgICAgICAgICAgICAgICAgICAgICAgIGhlYWRlcnM9eydhY2NlcHQtZW5jb2RpbmcnOiAnZ2FyYmFnZS1kZWZsYXRlJ30pCgogICAgICAgIHNlbGYuYXNzZXJ0UmFpc2VzKERlY29kZUVycm9yLCBzZWxmLnBvb2wucmVxdWVzdCwKICAgICAgICAgICAgICAgICAgICAgICAgICAnR0VUJywgJy9lbmNvZGluZ3JlcXVlc3QnLAogICAgICAgICAgICAgICAgICAgICAgICAgIGhlYWRlcnM9eydhY2NlcHQtZW5jb2RpbmcnOiAnZ2FyYmFnZS1nemlwJ30pCgogICAgZGVmIHRlc3RfY29ubmVjdGlvbl9jb3VudChzZWxmKToKICAgICAgICBwb29sID0gSFRUUENvbm5lY3Rpb25Qb29sKHNlbGYuaG9zdCwgc2VsZi5wb3J0LCBtYXhzaXplPTEpCgogICAgICAgIHBvb2wucmVxdWVzdCgnR0VUJywgJy8nKQogICAgICAgIHBvb2wucmVxdWVzdCgnR0VUJywgJy8nKQogICAgICAgIHBvb2wucmVxdWVzdCgnR0VUJywgJy8nKQoKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKHBvb2wubnVtX2Nvbm5lY3Rpb25zLCAxKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwocG9vbC5udW1fcmVxdWVzdHMsIDMpCgogICAgZGVmIHRlc3RfY29ubmVjdGlvbl9jb3VudF9iaWdwb29sKHNlbGYpOgogICAgICAgIGh0dHBfcG9vbCA9IEhUVFBDb25uZWN0aW9uUG9vbChzZWxmLmhvc3QsIHNlbGYucG9ydCwgbWF4c2l6ZT0xNikKCiAgICAgICAgaHR0cF9wb29sLnJlcXVlc3QoJ0dFVCcsICcvJykKICAgICAgICBodHRwX3Bvb2wucmVxdWVzdCgnR0VUJywgJy8nKQogICAgICAgIGh0dHBfcG9vbC5yZXF1ZXN0KCdHRVQnLCAnLycpCgogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoaHR0cF9wb29sLm51bV9jb25uZWN0aW9ucywgMSkKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKGh0dHBfcG9vbC5udW1fcmVxdWVzdHMsIDMpCgogICAgZGVmIHRlc3RfcGFydGlhbF9yZXNwb25zZShzZWxmKToKICAgICAgICBwb29sID0gSFRUUENvbm5lY3Rpb25Qb29sKHNlbGYuaG9zdCwgc2VsZi5wb3J0LCBtYXhzaXplPTEpCgogICAgICAgIHJlcV9kYXRhID0geydsb2wnOiAnY2F0J30KICAgICAgICByZXNwX2RhdGEgPSB1cmxlbmNvZGUocmVxX2RhdGEpLmVuY29kZSgndXRmLTgnKQoKICAgICAgICByID0gcG9vbC5yZXF1ZXN0KCdHRVQnLCAnL2VjaG8nLCBmaWVsZHM9cmVxX2RhdGEsIHByZWxvYWRfY29udGVudD1GYWxzZSkKCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChyLnJlYWQoNSksIHJlc3BfZGF0YVs6NV0pCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChyLnJlYWQoKSwgcmVzcF9kYXRhWzU6XSkKCiAgICBkZWYgdGVzdF9sYXp5X2xvYWRfdHdpY2Uoc2VsZik6CiAgICAgICAgIyBUaGlzIHRlc3QgaXMgc2FkIGFuZCBjb25mdXNpbmcuIE5lZWQgdG8gZmlndXJlIG91dCB3aGF0J3MKICAgICAgICAjIGdvaW5nIG9uIHdpdGggcGFydGlhbCByZWFkcyBhbmQgc29ja2V0IHJldXNlLgoKICAgICAgICBwb29sID0gSFRUUENvbm5lY3Rpb25Qb29sKHNlbGYuaG9zdCwgc2VsZi5wb3J0LCBibG9jaz1UcnVlLCBtYXhzaXplPTEsIHRpbWVvdXQ9MikKCiAgICAgICAgcGF5bG9hZF9zaXplID0gMTAyNCAqIDIKICAgICAgICBmaXJzdF9jaHVuayA9IDUxMgoKICAgICAgICBib3VuZGFyeSA9ICdmb28nCgogICAgICAgIHJlcV9kYXRhID0geydjb3VudCc6ICdhJyAqIHBheWxvYWRfc2l6ZX0KICAgICAgICByZXNwX2RhdGEgPSBlbmNvZGVfbXVsdGlwYXJ0X2Zvcm1kYXRhKHJlcV9kYXRhLCBib3VuZGFyeT1ib3VuZGFyeSlbMF0KCiAgICAgICAgcmVxMl9kYXRhID0geydjb3VudCc6ICdiJyAqIHBheWxvYWRfc2l6ZX0KICAgICAgICByZXNwMl9kYXRhID0gZW5jb2RlX211bHRpcGFydF9mb3JtZGF0YShyZXEyX2RhdGEsIGJvdW5kYXJ5PWJvdW5kYXJ5KVswXQoKICAgICAgICByMSA9IHBvb2wucmVxdWVzdCgnUE9TVCcsICcvZWNobycsCiAgICAgICAgICAgICAgICAgICAgICAgICAgZmllbGRzPXJlcV9kYXRhLAogICAgICAgICAgICAgICAgICAgICAgICAgIG11bHRpcGFydF9ib3VuZGFyeT1ib3VuZGFyeSwKICAgICAgICAgICAgICAgICAgICAgICAgICBwcmVsb2FkX2NvbnRlbnQ9RmFsc2UpCgogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwocjEucmVhZChmaXJzdF9jaHVuayksIHJlc3BfZGF0YVs6Zmlyc3RfY2h1bmtdKQoKICAgICAgICB0cnk6CiAgICAgICAgICAgIHIyID0gcG9vbC5yZXF1ZXN0KCdQT1NUJywgJy9lY2hvJywgZmllbGRzPXJlcTJfZGF0YSwgbXVsdGlwYXJ0X2JvdW5kYXJ5PWJvdW5kYXJ5LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmVsb2FkX2NvbnRlbnQ9RmFsc2UsIHBvb2xfdGltZW91dD0wLjAwMSkKCiAgICAgICAgICAgICMgVGhpcyBicmFuY2ggc2hvdWxkIGdlbmVyYWxseSBiYWlsIGhlcmUsIGJ1dCBtYXliZSBzb21lZGF5IGl0IHdpbGwKICAgICAgICAgICAgIyB3b3JrPyBQZXJoYXBzIGJ5IHNvbWUgc29ydCBvZiBtYWdpYy4gQ29uc2lkZXIgaXQgYSBUT0RPLgoKICAgICAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChyMi5yZWFkKGZpcnN0X2NodW5rKSwgcmVzcDJfZGF0YVs6Zmlyc3RfY2h1bmtdKQoKICAgICAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChyMS5yZWFkKCksIHJlc3BfZGF0YVtmaXJzdF9jaHVuazpdKQogICAgICAgICAgICBzZWxmLmFzc2VydEVxdWFsKHIyLnJlYWQoKSwgcmVzcDJfZGF0YVtmaXJzdF9jaHVuazpdKQogICAgICAgICAgICBzZWxmLmFzc2VydEVxdWFsKHBvb2wubnVtX3JlcXVlc3RzLCAyKQoKICAgICAgICBleGNlcHQgRW1wdHlQb29sRXJyb3I6CiAgICAgICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwocjEucmVhZCgpLCByZXNwX2RhdGFbZmlyc3RfY2h1bms6XSkKICAgICAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChwb29sLm51bV9yZXF1ZXN0cywgMSkKCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChwb29sLm51bV9jb25uZWN0aW9ucywgMSkKCiAgICBkZWYgdGVzdF9mb3JfZG91YmxlX3JlbGVhc2Uoc2VsZik6CiAgICAgICAgTUFYU0laRSA9IDUKCiAgICAgICAgIyBDaGVjayBkZWZhdWx0IHN0YXRlCiAgICAgICAgcG9vbCA9IEhUVFBDb25uZWN0aW9uUG9vbChzZWxmLmhvc3QsIHNlbGYucG9ydCwgbWF4c2l6ZT1NQVhTSVpFKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwocG9vbC5udW1fY29ubmVjdGlvbnMsIDApCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChwb29sLnBvb2wucXNpemUoKSwgTUFYU0laRSkKCiAgICAgICAgIyBNYWtlIGFuIGVtcHR5IHNsb3QgZm9yIHRlc3RpbmcKICAgICAgICBwb29sLnBvb2wuZ2V0KCkKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKHBvb2wucG9vbC5xc2l6ZSgpLCBNQVhTSVpFLTEpCgogICAgICAgICMgQ2hlY2sgc3RhdGUgYWZ0ZXIgc2ltcGxlIHJlcXVlc3QKICAgICAgICBwb29sLnVybG9wZW4oJ0dFVCcsICcvJykKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKHBvb2wucG9vbC5xc2l6ZSgpLCBNQVhTSVpFLTEpCgogICAgICAgICMgQ2hlY2sgc3RhdGUgd2l0aG91dCByZWxlYXNlCiAgICAgICAgcG9vbC51cmxvcGVuKCdHRVQnLCAnLycsIHByZWxvYWRfY29udGVudD1GYWxzZSkKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKHBvb2wucG9vbC5xc2l6ZSgpLCBNQVhTSVpFLTIpCgogICAgICAgIHBvb2wudXJsb3BlbignR0VUJywgJy8nKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwocG9vbC5wb29sLnFzaXplKCksIE1BWFNJWkUtMikKCiAgICAgICAgIyBDaGVjayBzdGF0ZSBhZnRlciByZWFkCiAgICAgICAgcG9vbC51cmxvcGVuKCdHRVQnLCAnLycpLmRhdGEKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKHBvb2wucG9vbC5xc2l6ZSgpLCBNQVhTSVpFLTIpCgogICAgICAgIHBvb2wudXJsb3BlbignR0VUJywgJy8nKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwocG9vbC5wb29sLnFzaXplKCksIE1BWFNJWkUtMikKCiAgICBkZWYgdGVzdF9yZWxlYXNlX2Nvbm5fcGFyYW1ldGVyKHNlbGYpOgogICAgICAgIE1BWFNJWkUgPSA1CiAgICAgICAgcG9vbCA9IEhUVFBDb25uZWN0aW9uUG9vbChzZWxmLmhvc3QsIHNlbGYucG9ydCwgbWF4c2l6ZT1NQVhTSVpFKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwocG9vbC5wb29sLnFzaXplKCksIE1BWFNJWkUpCgogICAgICAgICMgTWFrZSByZXF1ZXN0IHdpdGhvdXQgcmVsZWFzaW5nIGNvbm5lY3Rpb24KICAgICAgICBwb29sLnJlcXVlc3QoJ0dFVCcsICcvJywgcmVsZWFzZV9jb25uPUZhbHNlLCBwcmVsb2FkX2NvbnRlbnQ9RmFsc2UpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChwb29sLnBvb2wucXNpemUoKSwgTUFYU0laRS0xKQoKICAgIGRlZiB0ZXN0X2Ruc19lcnJvcihzZWxmKToKICAgICAgICBwb29sID0gSFRUUENvbm5lY3Rpb25Qb29sKCd0aGlzaG9zdGRvZXNub3RleGlzdC5pbnZhbGlkJywgc2VsZi5wb3J0LCB0aW1lb3V0PTAuMDAxKQogICAgICAgIHNlbGYuYXNzZXJ0UmFpc2VzKE1heFJldHJ5RXJyb3IsIHBvb2wucmVxdWVzdCwgJ0dFVCcsICcvdGVzdCcsIHJldHJpZXM9MikKCiAgICBkZWYgdGVzdF9zb3VyY2VfYWRkcmVzcyhzZWxmKToKICAgICAgICBmb3IgYWRkciwgaXNfaXB2NiBpbiBWQUxJRF9TT1VSQ0VfQUREUkVTU0VTOgogICAgICAgICAgICBpZiBpc19pcHY2IGFuZCBub3QgSEFTX0lQVjZfQU5EX0ROUzoKICAgICAgICAgICAgICAgIHdhcm5pbmdzLndhcm4oIk5vIElQdjYgc3VwcG9ydDogc2tpcHBpbmcuIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTm9JUHY2V2FybmluZykKICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgIHBvb2wgPSBIVFRQQ29ubmVjdGlvblBvb2woc2VsZi5ob3N0LCBzZWxmLnBvcnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc291cmNlX2FkZHJlc3M9YWRkciwgcmV0cmllcz1GYWxzZSkKICAgICAgICAgICAgciA9IHBvb2wucmVxdWVzdCgnR0VUJywgJy9zb3VyY2VfYWRkcmVzcycpCiAgICAgICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoci5kYXRhLCBiKGFkZHJbMF0pKQoKICAgIGRlZiB0ZXN0X3NvdXJjZV9hZGRyZXNzX2Vycm9yKHNlbGYpOgogICAgICAgIGZvciBhZGRyIGluIElOVkFMSURfU09VUkNFX0FERFJFU1NFUzoKICAgICAgICAgICAgcG9vbCA9IEhUVFBDb25uZWN0aW9uUG9vbChzZWxmLmhvc3QsIHNlbGYucG9ydCwgc291cmNlX2FkZHJlc3M9YWRkciwgcmV0cmllcz1GYWxzZSkKICAgICAgICAgICAgIyBGSVhNRTogVGhpcyBhc3NlcnQgZmxha2VzIHNvbWV0aW1lcy4gTm90IHN1cmUgd2h5LgogICAgICAgICAgICBzZWxmLmFzc2VydFJhaXNlcyhOZXdDb25uZWN0aW9uRXJyb3IsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBvb2wucmVxdWVzdCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ0dFVCcsICcvc291cmNlX2FkZHJlc3M/ezB9Jy5mb3JtYXQoYWRkcikpCgogICAgZGVmIHRlc3Rfc3RyZWFtX2tlZXBhbGl2ZShzZWxmKToKICAgICAgICB4ID0gMgoKICAgICAgICBmb3IgXyBpbiByYW5nZSh4KToKICAgICAgICAgICAgcmVzcG9uc2UgPSBzZWxmLnBvb2wucmVxdWVzdCgKICAgICAgICAgICAgICAgICAgICAnR0VUJywKICAgICAgICAgICAgICAgICAgICAnL2NodW5rZWQnLAogICAgICAgICAgICAgICAgICAgIGhlYWRlcnM9ewogICAgICAgICAgICAgICAgICAgICAgICAnQ29ubmVjdGlvbic6ICdrZWVwLWFsaXZlJywKICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBwcmVsb2FkX2NvbnRlbnQ9RmFsc2UsCiAgICAgICAgICAgICAgICAgICAgcmV0cmllcz1GYWxzZSwKICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgIGZvciBjaHVuayBpbiByZXNwb25zZS5zdHJlYW0oKToKICAgICAgICAgICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoY2h1bmssIGInMTIzJykKCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChzZWxmLnBvb2wubnVtX2Nvbm5lY3Rpb25zLCAxKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoc2VsZi5wb29sLm51bV9yZXF1ZXN0cywgeCkKCiAgICBkZWYgdGVzdF9jaHVua2VkX2d6aXAoc2VsZik6CiAgICAgICAgcmVzcG9uc2UgPSBzZWxmLnBvb2wucmVxdWVzdCgKICAgICAgICAgICAgICAgICdHRVQnLAogICAgICAgICAgICAgICAgJy9jaHVua2VkX2d6aXAnLAogICAgICAgICAgICAgICAgcHJlbG9hZF9jb250ZW50PUZhbHNlLAogICAgICAgICAgICAgICAgZGVjb2RlX2NvbnRlbnQ9VHJ1ZSwKICAgICAgICAgICAgICAgICkKCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChiJzEyMycgKiA0LCByZXNwb25zZS5yZWFkKCkpCgogICAgZGVmIHRlc3RfY2xlYW51cF9vbl9jb25uZWN0aW9uX2Vycm9yKHNlbGYpOgogICAgICAgICcnJwogICAgICAgIFRlc3QgdGhhdCBjb25uZWN0aW9ucyBhcmUgcmVjeWNsZWQgdG8gdGhlIHBvb2wgb24KICAgICAgICBjb25uZWN0aW9uIGVycm9ycyB3aGVyZSBubyBodHRwIHJlc3BvbnNlIGlzIHJlY2VpdmVkLgogICAgICAgICcnJwogICAgICAgIHBvb2xzaXplID0gMwogICAgICAgIHdpdGggSFRUUENvbm5lY3Rpb25Qb29sKHNlbGYuaG9zdCwgc2VsZi5wb3J0LCBtYXhzaXplPXBvb2xzaXplLCBibG9jaz1UcnVlKSBhcyBodHRwOgogICAgICAgICAgICBzZWxmLmFzc2VydEVxdWFsKGh0dHAucG9vbC5xc2l6ZSgpLCBwb29sc2l6ZSkKCiAgICAgICAgICAgICMgZm9yY2UgYSBjb25uZWN0aW9uIGVycm9yIGJ5IHN1cHBseWluZyBhIG5vbi1leGlzdGVudAogICAgICAgICAgICAjIHVybC4gV2Ugd29uJ3QgZ2V0IGEgcmVzcG9uc2UgZm9yIHRoaXMgIGFuZCBzbyB0aGUKICAgICAgICAgICAgIyBjb25uIHdvbid0IGJlIGltcGxpY2l0bHkgcmV0dXJuZWQgdG8gdGhlIHBvb2wuCiAgICAgICAgICAgIHNlbGYuYXNzZXJ0UmFpc2VzKE1heFJldHJ5RXJyb3IsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGh0dHAucmVxdWVzdCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ0dFVCcsICcvcmVkaXJlY3QnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWVsZHM9eyd0YXJnZXQnOiAnLyd9LCByZWxlYXNlX2Nvbm49RmFsc2UsIHJldHJpZXM9MCkKCiAgICAgICAgICAgIHIgPSBodHRwLnJlcXVlc3QoJ0dFVCcsICcvcmVkaXJlY3QnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpZWxkcz17J3RhcmdldCc6ICcvJ30sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVsZWFzZV9jb25uPUZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHJpZXM9MSkKICAgICAgICAgICAgci5yZWxlYXNlX2Nvbm4oKQoKICAgICAgICAgICAgIyB0aGUgcG9vbCBzaG91bGQgc3RpbGwgY29udGFpbiBwb29sc2l6ZSBlbGVtZW50cwogICAgICAgICAgICBzZWxmLmFzc2VydEVxdWFsKGh0dHAucG9vbC5xc2l6ZSgpLCBodHRwLnBvb2wubWF4c2l6ZSkKCiAgICBkZWYgdGVzdF9taXhlZF9jYXNlX2hvc3RuYW1lKHNlbGYpOgogICAgICAgIHBvb2wgPSBIVFRQQ29ubmVjdGlvblBvb2woIkxvQ2FMaE9zVCIsIHNlbGYucG9ydCkKICAgICAgICByZXNwb25zZSA9IHBvb2wucmVxdWVzdCgnR0VUJywgImh0dHA6Ly9Mb0NhTGhPc1Q6JWQvIiAlIHNlbGYucG9ydCkKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKHJlc3BvbnNlLnN0YXR1cywgMjAwKQoKCmNsYXNzIFRlc3RSZXRyeShIVFRQRHVtbXlTZXJ2ZXJUZXN0Q2FzZSk6CiAgICBkZWYgc2V0VXAoc2VsZik6CiAgICAgICAgc2VsZi5wb29sID0gSFRUUENvbm5lY3Rpb25Qb29sKHNlbGYuaG9zdCwgc2VsZi5wb3J0KQoKICAgIGRlZiB0ZXN0X21heF9yZXRyeShzZWxmKToKICAgICAgICB0cnk6CiAgICAgICAgICAgIHIgPSBzZWxmLnBvb2wucmVxdWVzdCgnR0VUJywgJy9yZWRpcmVjdCcsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWVsZHM9eyd0YXJnZXQnOiAnLyd9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0cmllcz0wKQogICAgICAgICAgICBzZWxmLmZhaWwoIkZhaWxlZCB0byByYWlzZSBNYXhSZXRyeUVycm9yIGV4Y2VwdGlvbiwgcmV0dXJuZWQgJXIiICUgci5zdGF0dXMpCiAgICAgICAgZXhjZXB0IE1heFJldHJ5RXJyb3I6CiAgICAgICAgICAgIHBhc3MKCiAgICBkZWYgdGVzdF9kaXNhYmxlZF9yZXRyeShzZWxmKToKICAgICAgICAiIiIgRGlzYWJsZWQgcmV0cmllcyBzaG91bGQgZGlzYWJsZSByZWRpcmVjdCBoYW5kbGluZy4gIiIiCiAgICAgICAgciA9IHNlbGYucG9vbC5yZXF1ZXN0KCdHRVQnLCAnL3JlZGlyZWN0JywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmllbGRzPXsndGFyZ2V0JzogJy8nfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0cmllcz1GYWxzZSkKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKHIuc3RhdHVzLCAzMDMpCgogICAgICAgIHIgPSBzZWxmLnBvb2wucmVxdWVzdCgnR0VUJywgJy9yZWRpcmVjdCcsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpZWxkcz17J3RhcmdldCc6ICcvJ30sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHJpZXM9UmV0cnkocmVkaXJlY3Q9RmFsc2UpKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoci5zdGF0dXMsIDMwMykKCiAgICAgICAgcG9vbCA9IEhUVFBDb25uZWN0aW9uUG9vbCgndGhpc2hvc3Rkb2Vzbm90ZXhpc3QuaW52YWxpZCcsIHNlbGYucG9ydCwgdGltZW91dD0wLjAwMSkKICAgICAgICBzZWxmLmFzc2VydFJhaXNlcyhOZXdDb25uZWN0aW9uRXJyb3IsIHBvb2wucmVxdWVzdCwgJ0dFVCcsICcvdGVzdCcsIHJldHJpZXM9RmFsc2UpCgogICAgZGVmIHRlc3RfcmVhZF9yZXRyaWVzKHNlbGYpOgogICAgICAgICIiIiBTaG91bGQgcmV0cnkgZm9yIHN0YXR1cyBjb2RlcyBpbiB0aGUgd2hpdGVsaXN0ICIiIgogICAgICAgIHJldHJ5ID0gUmV0cnkocmVhZD0xLCBzdGF0dXNfZm9yY2VsaXN0PVs0MThdKQogICAgICAgIHJlc3AgPSBzZWxmLnBvb2wucmVxdWVzdCgnR0VUJywgJy9zdWNjZXNzZnVsX3JldHJ5JywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaGVhZGVycz17J3Rlc3QtbmFtZSc6ICd0ZXN0X3JlYWRfcmV0cmllcyd9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXRyaWVzPXJldHJ5KQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwocmVzcC5zdGF0dXMsIDIwMCkKCiAgICBkZWYgdGVzdF9yZWFkX3RvdGFsX3JldHJpZXMoc2VsZik6CiAgICAgICAgIiIiIEhUVFAgcmVzcG9uc2Ugdy8gc3RhdHVzIGNvZGUgaW4gdGhlIHdoaXRlbGlzdCBzaG91bGQgYmUgcmV0cmllZCAiIiIKICAgICAgICBoZWFkZXJzID0geyd0ZXN0LW5hbWUnOiAndGVzdF9yZWFkX3RvdGFsX3JldHJpZXMnfQogICAgICAgIHJldHJ5ID0gUmV0cnkodG90YWw9MSwgc3RhdHVzX2ZvcmNlbGlzdD1bNDE4XSkKICAgICAgICByZXNwID0gc2VsZi5wb29sLnJlcXVlc3QoJ0dFVCcsICcvc3VjY2Vzc2Z1bF9yZXRyeScsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhlYWRlcnM9aGVhZGVycywgcmV0cmllcz1yZXRyeSkKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKHJlc3Auc3RhdHVzLCAyMDApCgogICAgZGVmIHRlc3RfcmV0cmllc193cm9uZ193aGl0ZWxpc3Qoc2VsZik6CiAgICAgICAgIiIiSFRUUCByZXNwb25zZSB3LyBzdGF0dXMgY29kZSBub3QgaW4gd2hpdGVsaXN0IHNob3VsZG4ndCBiZSByZXRyaWVkIiIiCiAgICAgICAgcmV0cnkgPSBSZXRyeSh0b3RhbD0xLCBzdGF0dXNfZm9yY2VsaXN0PVsyMDJdKQogICAgICAgIHJlc3AgPSBzZWxmLnBvb2wucmVxdWVzdCgnR0VUJywgJy9zdWNjZXNzZnVsX3JldHJ5JywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaGVhZGVycz17J3Rlc3QtbmFtZSc6ICd0ZXN0X3dyb25nX3doaXRlbGlzdCd9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXRyaWVzPXJldHJ5KQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwocmVzcC5zdGF0dXMsIDQxOCkKCiAgICBkZWYgdGVzdF9kZWZhdWx0X21ldGhvZF93aGl0ZWxpc3RfcmV0cmllZChzZWxmKToKICAgICAgICAiIiIgdXJsbGliMyBzaG91bGQgcmV0cnkgbWV0aG9kcyBpbiB0aGUgZGVmYXVsdCBtZXRob2Qgd2hpdGVsaXN0ICIiIgogICAgICAgIHJldHJ5ID0gUmV0cnkodG90YWw9MSwgc3RhdHVzX2ZvcmNlbGlzdD1bNDE4XSkKICAgICAgICByZXNwID0gc2VsZi5wb29sLnJlcXVlc3QoJ09QVElPTlMnLCAnL3N1Y2Nlc3NmdWxfcmV0cnknLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBoZWFkZXJzPXsndGVzdC1uYW1lJzogJ3Rlc3RfZGVmYXVsdF93aGl0ZWxpc3QnfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0cmllcz1yZXRyeSkKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKHJlc3Auc3RhdHVzLCAyMDApCgogICAgZGVmIHRlc3RfcmV0cmllc193cm9uZ19tZXRob2RfbGlzdChzZWxmKToKICAgICAgICAiIiJNZXRob2Qgbm90IGluIG91ciB3aGl0ZWxpc3Qgc2hvdWxkIG5vdCBiZSByZXRyaWVkLCBldmVuIGlmIGNvZGUgbWF0Y2hlcyIiIgogICAgICAgIGhlYWRlcnMgPSB7J3Rlc3QtbmFtZSc6ICd0ZXN0X3dyb25nX21ldGhvZF93aGl0ZWxpc3QnfQogICAgICAgIHJldHJ5ID0gUmV0cnkodG90YWw9MSwgc3RhdHVzX2ZvcmNlbGlzdD1bNDE4XSwKICAgICAgICAgICAgICAgICAgICAgIG1ldGhvZF93aGl0ZWxpc3Q9WydQT1NUJ10pCiAgICAgICAgcmVzcCA9IHNlbGYucG9vbC5yZXF1ZXN0KCdHRVQnLCAnL3N1Y2Nlc3NmdWxfcmV0cnknLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBoZWFkZXJzPWhlYWRlcnMsIHJldHJpZXM9cmV0cnkpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChyZXNwLnN0YXR1cywgNDE4KQoKICAgIGRlZiB0ZXN0X3JlYWRfcmV0cmllc191bnN1Y2Nlc3NmdWwoc2VsZik6CiAgICAgICAgaGVhZGVycyA9IHsndGVzdC1uYW1lJzogJ3Rlc3RfcmVhZF9yZXRyaWVzX3Vuc3VjY2Vzc2Z1bCd9CiAgICAgICAgcmVzcCA9IHNlbGYucG9vbC5yZXF1ZXN0KCdHRVQnLCAnL3N1Y2Nlc3NmdWxfcmV0cnknLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBoZWFkZXJzPWhlYWRlcnMsIHJldHJpZXM9MSkKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKHJlc3Auc3RhdHVzLCA0MTgpCgogICAgZGVmIHRlc3RfcmV0cnlfcmV1c2Vfc2FmZShzZWxmKToKICAgICAgICAiIiIgSXQgc2hvdWxkIGJlIHBvc3NpYmxlIHRvIHJldXNlIGEgUmV0cnkgb2JqZWN0IGFjcm9zcyByZXF1ZXN0cyAiIiIKICAgICAgICBoZWFkZXJzID0geyd0ZXN0LW5hbWUnOiAndGVzdF9yZXRyeV9zYWZlJ30KICAgICAgICByZXRyeSA9IFJldHJ5KHRvdGFsPTEsIHN0YXR1c19mb3JjZWxpc3Q9WzQxOF0pCiAgICAgICAgcmVzcCA9IHNlbGYucG9vbC5yZXF1ZXN0KCdHRVQnLCAnL3N1Y2Nlc3NmdWxfcmV0cnknLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBoZWFkZXJzPWhlYWRlcnMsIHJldHJpZXM9cmV0cnkpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChyZXNwLnN0YXR1cywgMjAwKQogICAgICAgIHJlc3AgPSBzZWxmLnBvb2wucmVxdWVzdCgnR0VUJywgJy9zdWNjZXNzZnVsX3JldHJ5JywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaGVhZGVycz1oZWFkZXJzLCByZXRyaWVzPXJldHJ5KQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwocmVzcC5zdGF0dXMsIDIwMCkKCiAgICBkZWYgdGVzdF9yZXRyeV9yZXR1cm5faW5fcmVzcG9uc2Uoc2VsZik6CiAgICAgICAgaGVhZGVycyA9IHsndGVzdC1uYW1lJzogJ3Rlc3RfcmV0cnlfcmV0dXJuX2luX3Jlc3BvbnNlJ30KICAgICAgICByZXRyeSA9IFJldHJ5KHRvdGFsPTIsIHN0YXR1c19mb3JjZWxpc3Q9WzQxOF0pCiAgICAgICAgcmVzcCA9IHNlbGYucG9vbC5yZXF1ZXN0KCdHRVQnLCAnL3N1Y2Nlc3NmdWxfcmV0cnknLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBoZWFkZXJzPWhlYWRlcnMsIHJldHJpZXM9cmV0cnkpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChyZXNwLnN0YXR1cywgMjAwKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwocmVzcC5yZXRyaWVzLnRvdGFsLCAxKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwocmVzcC5yZXRyaWVzLmhpc3RvcnksCiAgICAgICAgICAgICAgICAgICAgICAgICAoUmVxdWVzdEhpc3RvcnkoJ0dFVCcsICcvc3VjY2Vzc2Z1bF9yZXRyeScsIE5vbmUsIDQxOCwgTm9uZSksKSkKCiAgICBkZWYgdGVzdF9yZXRyeV9yZWRpcmVjdF9oaXN0b3J5KHNlbGYpOgogICAgICAgIHJlc3AgPSBzZWxmLnBvb2wucmVxdWVzdCgnR0VUJywgJy9yZWRpcmVjdCcsIGZpZWxkcz17J3RhcmdldCc6ICcvJ30pCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChyZXNwLnN0YXR1cywgMjAwKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwocmVzcC5yZXRyaWVzLmhpc3RvcnksCiAgICAgICAgICAgICAgICAgICAgICAgICAoUmVxdWVzdEhpc3RvcnkoJ0dFVCcsICcvcmVkaXJlY3Q/dGFyZ2V0PSUyRicsIE5vbmUsIDMwMywgJy8nKSwpKQoKICAgIGRlZiB0ZXN0X211bHRpX3JlZGlyZWN0X2hpc3Rvcnkoc2VsZik6CiAgICAgICAgciA9IHNlbGYucG9vbC5yZXF1ZXN0KCdHRVQnLCAnL211bHRpX3JlZGlyZWN0JywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmllbGRzPXsncmVkaXJlY3RfY29kZXMnOiAnMzAzLDMwMiwyMDAnfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVkaXJlY3Q9RmFsc2UpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChyLnN0YXR1cywgMzAzKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoci5yZXRyaWVzLmhpc3RvcnksIHR1cGxlKCkpCgogICAgICAgIHIgPSBzZWxmLnBvb2wucmVxdWVzdCgnR0VUJywgJy9tdWx0aV9yZWRpcmVjdCcsIHJldHJpZXM9MTAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpZWxkcz17J3JlZGlyZWN0X2NvZGVzJzogJzMwMywzMDIsMzAxLDMwNywzMDIsMjAwJ30pCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChyLnN0YXR1cywgMjAwKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoci5kYXRhLCBiJ0RvbmUgcmVkaXJlY3RpbmcnKQoKICAgICAgICBleHBlY3RlZCA9IFsoMzAzLCAnL211bHRpX3JlZGlyZWN0P3JlZGlyZWN0X2NvZGVzPTMwMiwzMDEsMzA3LDMwMiwyMDAnKSwKICAgICAgICAgICAgICAgICAgICAoMzAyLCAnL211bHRpX3JlZGlyZWN0P3JlZGlyZWN0X2NvZGVzPTMwMSwzMDcsMzAyLDIwMCcpLAogICAgICAgICAgICAgICAgICAgICgzMDEsICcvbXVsdGlfcmVkaXJlY3Q/cmVkaXJlY3RfY29kZXM9MzA3LDMwMiwyMDAnKSwKICAgICAgICAgICAgICAgICAgICAoMzA3LCAnL211bHRpX3JlZGlyZWN0P3JlZGlyZWN0X2NvZGVzPTMwMiwyMDAnKSwKICAgICAgICAgICAgICAgICAgICAoMzAyLCAnL211bHRpX3JlZGlyZWN0P3JlZGlyZWN0X2NvZGVzPTIwMCcpXQogICAgICAgIGFjdHVhbCA9IFsoaGlzdG9yeS5zdGF0dXMsIGhpc3RvcnkucmVkaXJlY3RfbG9jYXRpb24pIGZvciBoaXN0b3J5IGluIHIucmV0cmllcy5oaXN0b3J5XQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoYWN0dWFsLCBleHBlY3RlZCkKCgpjbGFzcyBUZXN0UmV0cnlBZnRlcihIVFRQRHVtbXlTZXJ2ZXJUZXN0Q2FzZSk6CiAgICBkZWYgc2V0VXAoc2VsZik6CiAgICAgICAgc2VsZi5wb29sID0gSFRUUENvbm5lY3Rpb25Qb29sKHNlbGYuaG9zdCwgc2VsZi5wb3J0KQoKICAgIGRlZiB0ZXN0X3JldHJ5X2FmdGVyKHNlbGYpOgogICAgICAgICMgUmVxdWVzdCB0d2ljZSBpbiBhIHNlY29uZCB0byBnZXQgYSA0MjkgcmVzcG9uc2UuCiAgICAgICAgciA9IHNlbGYucG9vbC5yZXF1ZXN0KCdHRVQnLCAnL3JldHJ5X2FmdGVyJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmllbGRzPXsnc3RhdHVzJzogJzQyOSBUb28gTWFueSBSZXF1ZXN0cyd9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXRyaWVzPUZhbHNlKQogICAgICAgIHIgPSBzZWxmLnBvb2wucmVxdWVzdCgnR0VUJywgJy9yZXRyeV9hZnRlcicsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpZWxkcz17J3N0YXR1cyc6ICc0MjkgVG9vIE1hbnkgUmVxdWVzdHMnfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0cmllcz1GYWxzZSkKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKHIuc3RhdHVzLCA0MjkpCgogICAgICAgIHIgPSBzZWxmLnBvb2wucmVxdWVzdCgnR0VUJywgJy9yZXRyeV9hZnRlcicsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpZWxkcz17J3N0YXR1cyc6ICc0MjkgVG9vIE1hbnkgUmVxdWVzdHMnfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0cmllcz1UcnVlKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoci5zdGF0dXMsIDIwMCkKCiAgICAgICAgIyBSZXF1ZXN0IHR3aWNlIGluIGEgc2Vjb25kIHRvIGdldCBhIDUwMyByZXNwb25zZS4KICAgICAgICByID0gc2VsZi5wb29sLnJlcXVlc3QoJ0dFVCcsICcvcmV0cnlfYWZ0ZXInLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWVsZHM9eydzdGF0dXMnOiAnNTAzIFNlcnZpY2UgVW5hdmFpbGFibGUnfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0cmllcz1GYWxzZSkKICAgICAgICByID0gc2VsZi5wb29sLnJlcXVlc3QoJ0dFVCcsICcvcmV0cnlfYWZ0ZXInLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWVsZHM9eydzdGF0dXMnOiAnNTAzIFNlcnZpY2UgVW5hdmFpbGFibGUnfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0cmllcz1GYWxzZSkKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKHIuc3RhdHVzLCA1MDMpCgogICAgICAgIHIgPSBzZWxmLnBvb2wucmVxdWVzdCgnR0VUJywgJy9yZXRyeV9hZnRlcicsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpZWxkcz17J3N0YXR1cyc6ICc1MDMgU2VydmljZSBVbmF2YWlsYWJsZSd9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXRyaWVzPVRydWUpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChyLnN0YXR1cywgMjAwKQoKICAgICAgICAjIElnbm9yZSBSZXRyeS1BZnRlciBoZWFkZXIgb24gc3RhdHVzIHdoaWNoIGlzIG5vdCBkZWZpbmVkIGluCiAgICAgICAgIyBSZXRyeS5SRVRSWV9BRlRFUl9TVEFUVVNfQ09ERVMuCiAgICAgICAgciA9IHNlbGYucG9vbC5yZXF1ZXN0KCdHRVQnLCAnL3JldHJ5X2FmdGVyJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmllbGRzPXsnc3RhdHVzJzogIjQxOCBJJ20gYSB0ZWFwb3QifSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0cmllcz1UcnVlKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoci5zdGF0dXMsIDQxOCkKCiAgICBkZWYgdGVzdF9yZWRpcmVjdF9hZnRlcihzZWxmKToKICAgICAgICByID0gc2VsZi5wb29sLnJlcXVlc3QoJ0dFVCcsICcvcmVkaXJlY3RfYWZ0ZXInLCByZXRyaWVzPUZhbHNlKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoci5zdGF0dXMsIDMwMykKCiAgICAgICAgdCA9IHRpbWUudGltZSgpCiAgICAgICAgciA9IHNlbGYucG9vbC5yZXF1ZXN0KCdHRVQnLCAnL3JlZGlyZWN0X2FmdGVyJykKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKHIuc3RhdHVzLCAyMDApCiAgICAgICAgZGVsdGEgPSB0aW1lLnRpbWUoKSAtIHQKICAgICAgICBzZWxmLmFzc2VydFRydWUoZGVsdGEgPj0gMSkKCiAgICAgICAgdCA9IHRpbWUudGltZSgpCiAgICAgICAgdGltZXN0YW1wID0gdCArIDIKICAgICAgICByID0gc2VsZi5wb29sLnJlcXVlc3QoJ0dFVCcsICcvcmVkaXJlY3RfYWZ0ZXI/ZGF0ZT0nICsgc3RyKHRpbWVzdGFtcCkpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChyLnN0YXR1cywgMjAwKQogICAgICAgIGRlbHRhID0gdGltZS50aW1lKCkgLSB0CiAgICAgICAgc2VsZi5hc3NlcnRUcnVlKGRlbHRhID49IDEpCgogICAgICAgICMgUmV0cnktQWZ0ZXIgaXMgcGFzdAogICAgICAgIHQgPSB0aW1lLnRpbWUoKQogICAgICAgIHRpbWVzdGFtcCA9IHQgLSAxCiAgICAgICAgciA9IHNlbGYucG9vbC5yZXF1ZXN0KCdHRVQnLCAnL3JlZGlyZWN0X2FmdGVyP2RhdGU9JyArIHN0cih0aW1lc3RhbXApKQogICAgICAgIGRlbHRhID0gdGltZS50aW1lKCkgLSB0CiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChyLnN0YXR1cywgMjAwKQogICAgICAgIHNlbGYuYXNzZXJ0VHJ1ZShkZWx0YSA8IDEpCgoKY2xhc3MgVGVzdEZpbGVCb2RpZXNPblJldHJ5T3JSZWRpcmVjdChIVFRQRHVtbXlTZXJ2ZXJUZXN0Q2FzZSk6CiAgICBkZWYgc2V0VXAoc2VsZik6CiAgICAgICAgc2VsZi5wb29sID0gSFRUUENvbm5lY3Rpb25Qb29sKHNlbGYuaG9zdCwgc2VsZi5wb3J0LCB0aW1lb3V0PTAuMSkKCiAgICBkZWYgdGVzdF9yZXRyaWVzX3B1dF9maWxlaGFuZGxlKHNlbGYpOgogICAgICAgICIiIkhUVFAgUFVUIHJldHJ5IHdpdGggYSBmaWxlLWxpa2Ugb2JqZWN0IHNob3VsZCBub3QgdGltZW91dCIiIgogICAgICAgIHJldHJ5ID0gUmV0cnkodG90YWw9Mywgc3RhdHVzX2ZvcmNlbGlzdD1bNDE4XSkKICAgICAgICAjIGh0dHBsaWIgcmVhZHMgaW4gOGsgY2h1bmtzOyB1c2UgYSBsYXJnZXIgY29udGVudCBsZW5ndGgKICAgICAgICBjb250ZW50X2xlbmd0aCA9IDY1NTM1CiAgICAgICAgZGF0YSA9IGInQScgKiBjb250ZW50X2xlbmd0aAogICAgICAgIHVwbG9hZGVkX2ZpbGUgPSBpby5CeXRlc0lPKGRhdGEpCiAgICAgICAgaGVhZGVycyA9IHsndGVzdC1uYW1lJzogJ3Rlc3RfcmV0cmllc19wdXRfZmlsZWhhbmRsZScsCiAgICAgICAgICAgICAgICAgICAnQ29udGVudC1MZW5ndGgnOiBzdHIoY29udGVudF9sZW5ndGgpfQogICAgICAgIHJlc3AgPSBzZWxmLnBvb2wudXJsb3BlbignUFVUJywgJy9zdWNjZXNzZnVsX3JldHJ5JywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaGVhZGVycz1oZWFkZXJzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXRyaWVzPXJldHJ5LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBib2R5PXVwbG9hZGVkX2ZpbGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFzc2VydF9zYW1lX2hvc3Q9RmFsc2UsIHJlZGlyZWN0PUZhbHNlKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwocmVzcC5zdGF0dXMsIDIwMCkKCiAgICBkZWYgdGVzdF9yZWRpcmVjdF9wdXRfZmlsZShzZWxmKToKICAgICAgICAiIiJQVVQgd2l0aCBmaWxlIG9iamVjdCBzaG91bGQgd29yayB3aXRoIGEgcmVkaXJlY3Rpb24gcmVzcG9uc2UiIiIKICAgICAgICByZXRyeSA9IFJldHJ5KHRvdGFsPTMsIHN0YXR1c19mb3JjZWxpc3Q9WzQxOF0pCiAgICAgICAgIyBodHRwbGliIHJlYWRzIGluIDhrIGNodW5rczsgdXNlIGEgbGFyZ2VyIGNvbnRlbnQgbGVuZ3RoCiAgICAgICAgY29udGVudF9sZW5ndGggPSA2NTUzNQogICAgICAgIGRhdGEgPSBiJ0EnICogY29udGVudF9sZW5ndGgKICAgICAgICB1cGxvYWRlZF9maWxlID0gaW8uQnl0ZXNJTyhkYXRhKQogICAgICAgIGhlYWRlcnMgPSB7J3Rlc3QtbmFtZSc6ICd0ZXN0X3JlZGlyZWN0X3B1dF9maWxlJywKICAgICAgICAgICAgICAgICAgICdDb250ZW50LUxlbmd0aCc6IHN0cihjb250ZW50X2xlbmd0aCl9CiAgICAgICAgdXJsID0gJy9yZWRpcmVjdD90YXJnZXQ9L2VjaG8mc3RhdHVzPTMwNycKICAgICAgICByZXNwID0gc2VsZi5wb29sLnVybG9wZW4oJ1BVVCcsIHVybCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaGVhZGVycz1oZWFkZXJzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXRyaWVzPXJldHJ5LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBib2R5PXVwbG9hZGVkX2ZpbGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFzc2VydF9zYW1lX2hvc3Q9RmFsc2UsIHJlZGlyZWN0PVRydWUpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChyZXNwLnN0YXR1cywgMjAwKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwocmVzcC5kYXRhLCBkYXRhKQoKICAgIGRlZiB0ZXN0X3JlZGlyZWN0X3dpdGhfZmFpbGVkX3RlbGwoc2VsZik6CiAgICAgICAgIiIiQWJvcnQgcmVxdWVzdCBpZiBmYWlsZWQgdG8gZ2V0IGEgcG9zaXRpb24gZnJvbSB0ZWxsKCkiIiIKICAgICAgICBjbGFzcyBCYWRUZWxsT2JqZWN0KGlvLkJ5dGVzSU8pOgoKICAgICAgICAgICAgZGVmIHRlbGwoc2VsZik6CiAgICAgICAgICAgICAgICByYWlzZSBJT0Vycm9yCgogICAgICAgIGJvZHkgPSBCYWRUZWxsT2JqZWN0KGIndGhlIGRhdGEnKQogICAgICAgIHVybCA9ICcvcmVkaXJlY3Q/dGFyZ2V0PS9zdWNjZXNzZnVsX3JldHJ5JwogICAgICAgICMgaHR0cGxpYiB1c2VzIGZpbGVubyBpZiBDb250ZW50LUxlbmd0aCBpc24ndCBzdXBwbGllZCwKICAgICAgICAjIHdoaWNoIGlzIHVuc3VwcG9ydGVkIGJ5IEJ5dGVzSU8uCiAgICAgICAgaGVhZGVycyA9IHsnQ29udGVudC1MZW5ndGgnOiAnOCd9CiAgICAgICAgdHJ5OgogICAgICAgICAgICBzZWxmLnBvb2wudXJsb3BlbignUFVUJywgdXJsLCBoZWFkZXJzPWhlYWRlcnMsIGJvZHk9Ym9keSkKICAgICAgICAgICAgc2VsZi5mYWlsKCdQVVQgc3VjY2Vzc2Z1bCBkZXNwaXRlIGZhaWxlZCByZXdpbmQuJykKICAgICAgICBleGNlcHQgVW5yZXdpbmRhYmxlQm9keUVycm9yIGFzIGU6CiAgICAgICAgICAgIHNlbGYuYXNzZXJ0VHJ1ZSgnVW5hYmxlIHRvIHJlY29yZCBmaWxlIHBvc2l0aW9uIGZvcicgaW4gc3RyKGUpKQoKCmlmIF9fbmFtZV9fID09ICdfX21haW5fXyc6CiAgICB1bml0dGVzdC5tYWluKCkK
