statistics:
  total_files: 1
  skipped_files: 0.0
  processed_objects: 1
  malicious_objects: 0
details:
- path: .repo_cache/malicious_repos/pypi_malregistry/requestsd/2.28.2/requestsd-2.28.2-py3-none-any/requests/adapters.py
  contents:
  - name: HTTPAdapter.cert_verify
    score: 0.0
    code: |-
      def cert_verify(self, conn, url, verify, cert):
              """Verify a SSL certificate. This method should not be called from user
              code, and is only exposed for use when subclassing the
              :class:`HTTPAdapter <requests.adapters.HTTPAdapter>`.

              :param conn: The urllib3 connection object associated with the cert.
              :param url: The requested URL.
              :param verify: Either a boolean, in which case it controls whether we verify
                  the server's TLS certificate, or a string, in which case it must be a path
                  to a CA bundle to use
              :param cert: The SSL certificate to verify.
              """
              if url.lower().startswith("https") and verify:

                  cert_loc = None

                  # Allow self-specified cert location.
                  if verify is not True:
                      cert_loc = verify

                  if not cert_loc:
                      cert_loc = extract_zipped_paths(DEFAULT_CA_BUNDLE_PATH)

                  if not cert_loc or not os.path.exists(cert_loc):
                      raise OSError(
                          f"Could not find a suitable TLS CA certificate bundle, "
                          f"invalid path: {cert_loc}"
                      )

                  conn.cert_reqs = "CERT_REQUIRED"

                  if not os.path.isdir(cert_loc):
                      conn.ca_certs = cert_loc
                  else:
                      conn.ca_cert_dir = cert_loc
              else:
                  conn.cert_reqs = "CERT_NONE"
                  conn.ca_certs = None
                  conn.ca_cert_dir = None

              if cert:
                  if not isinstance(cert, basestring):
                      conn.cert_file = cert[0]
                      conn.key_file = cert[1]
                  else:
                      conn.cert_file = cert
                      conn.key_file = None
                  if conn.cert_file and not os.path.exists(conn.cert_file):
                      raise OSError(
                          f"Could not find the TLS certificate file, "
                          f"invalid path: {conn.cert_file}"
                      )
                  if conn.key_file and not os.path.exists(conn.key_file):
                      raise OSError(
                          f"Could not find the TLS key file, invalid path: {conn.key_file}"
                      )
    tokens: resume load_fast url load_attr lower call load_attr startswith load_const https call pop_jump_if_false TO_NUMBER load_fast verify pop_jump_if_false TO_NUMBER load_const store_fast cert_loc load_fast verify load_const INTEGER is_op pop_jump_if_false TO_NUMBER load_fast verify store_fast cert_loc load_fast cert_loc pop_jump_if_true TO_NUMBER load_global STRING_LEN_S_ENT_HIGH load_global STRING_LEN_S_ENT_HIGH call store_fast cert_loc load_fast cert_loc pop_jump_if_false TO_NUMBER load_global os load_attr path load_attr exists load_fast cert_loc call pop_jump_if_true TO_NUMBER load_global OSError load_const STRING_LEN_S_ENT_HIGH load_fast cert_loc format_value INTEGER build_string call raise_varargs load_const CERT_REQUIRED load_fast conn store_attr cert_reqs load_global os load_attr path load_attr isdir load_fast cert_loc call pop_jump_if_true TO_NUMBER load_fast cert_loc load_fast conn store_attr ca_certs jump_forward TO_NUMBER load_fast cert_loc load_fast conn store_attr ca_cert_dir jump_forward TO_NUMBER load_const CERT_NONE load_fast conn store_attr cert_reqs load_const load_fast conn store_attr ca_certs load_const load_fast conn store_attr ca_cert_dir load_fast cert pop_jump_if_false TO_NUMBER load_global isinstance load_fast cert load_global basestring call pop_jump_if_true TO_NUMBER load_fast cert load_const INTEGER binary_subscr load_fast conn store_attr cert_file load_fast cert load_const INTEGER binary_subscr load_fast conn store_attr key_file jump_forward TO_NUMBER load_fast cert load_fast conn store_attr cert_file load_const load_fast conn store_attr key_file load_fast conn load_attr cert_file pop_jump_if_false TO_NUMBER load_global os load_attr path load_attr exists load_fast conn load_attr cert_file call pop_jump_if_true TO_NUMBER load_global OSError load_const STRING_LEN_S_ENT_HIGH load_fast conn load_attr cert_file format_value INTEGER build_string call raise_varargs load_fast conn load_attr key_file pop_jump_if_false TO_NUMBER load_global os load_attr path load_attr exists load_fast conn load_attr key_file call pop_jump_if_true TO_NUMBER load_global OSError load_const STRING_LEN_S_ENT_HIGH load_fast conn load_attr key_file format_value INTEGER build_string call raise_varargs return_const None return_const None return_const None
    hash: f3f12771a5d60f09bd779e90bf478beb3258b1cb7bc8d96f1a4dd16597f3f1a6
sources:
  .repo_cache/malicious_repos/pypi_malregistry/requestsd/2.28.2/requestsd-2.28.2-py3-none-any/requests/adapters.py: IiIiCnJlcXVlc3RzLmFkYXB0ZXJzCn5+fn5+fn5+fn5+fn5+fn5+CgpUaGlzIG1vZHVsZSBjb250YWlucyB0aGUgdHJhbnNwb3J0IGFkYXB0ZXJzIHRoYXQgUmVxdWVzdHMgdXNlcyB0byBkZWZpbmUKYW5kIG1haW50YWluIGNvbm5lY3Rpb25zLgoiIiIKCmltcG9ydCBvcy5wYXRoCmltcG9ydCBzb2NrZXQgICMgbm9xYTogRjQwMQoKZnJvbSB1cmxsaWIzLmV4Y2VwdGlvbnMgaW1wb3J0IENsb3NlZFBvb2xFcnJvciwgQ29ubmVjdFRpbWVvdXRFcnJvcgpmcm9tIHVybGxpYjMuZXhjZXB0aW9ucyBpbXBvcnQgSFRUUEVycm9yIGFzIF9IVFRQRXJyb3IKZnJvbSB1cmxsaWIzLmV4Y2VwdGlvbnMgaW1wb3J0IEludmFsaWRIZWFkZXIgYXMgX0ludmFsaWRIZWFkZXIKZnJvbSB1cmxsaWIzLmV4Y2VwdGlvbnMgaW1wb3J0ICgKICAgIExvY2F0aW9uVmFsdWVFcnJvciwKICAgIE1heFJldHJ5RXJyb3IsCiAgICBOZXdDb25uZWN0aW9uRXJyb3IsCiAgICBQcm90b2NvbEVycm9yLAopCmZyb20gdXJsbGliMy5leGNlcHRpb25zIGltcG9ydCBQcm94eUVycm9yIGFzIF9Qcm94eUVycm9yCmZyb20gdXJsbGliMy5leGNlcHRpb25zIGltcG9ydCBSZWFkVGltZW91dEVycm9yLCBSZXNwb25zZUVycm9yCmZyb20gdXJsbGliMy5leGNlcHRpb25zIGltcG9ydCBTU0xFcnJvciBhcyBfU1NMRXJyb3IKZnJvbSB1cmxsaWIzLnBvb2xtYW5hZ2VyIGltcG9ydCBQb29sTWFuYWdlciwgcHJveHlfZnJvbV91cmwKZnJvbSB1cmxsaWIzLnJlc3BvbnNlIGltcG9ydCBIVFRQUmVzcG9uc2UKZnJvbSB1cmxsaWIzLnV0aWwgaW1wb3J0IFRpbWVvdXQgYXMgVGltZW91dFNhdWNlCmZyb20gdXJsbGliMy51dGlsIGltcG9ydCBwYXJzZV91cmwKZnJvbSB1cmxsaWIzLnV0aWwucmV0cnkgaW1wb3J0IFJldHJ5Cgpmcm9tIC5hdXRoIGltcG9ydCBfYmFzaWNfYXV0aF9zdHIKZnJvbSAuY29tcGF0IGltcG9ydCBiYXNlc3RyaW5nLCB1cmxwYXJzZQpmcm9tIC5jb29raWVzIGltcG9ydCBleHRyYWN0X2Nvb2tpZXNfdG9famFyCmZyb20gLmV4Y2VwdGlvbnMgaW1wb3J0ICgKICAgIENvbm5lY3Rpb25FcnJvciwKICAgIENvbm5lY3RUaW1lb3V0LAogICAgSW52YWxpZEhlYWRlciwKICAgIEludmFsaWRQcm94eVVSTCwKICAgIEludmFsaWRTY2hlbWEsCiAgICBJbnZhbGlkVVJMLAogICAgUHJveHlFcnJvciwKICAgIFJlYWRUaW1lb3V0LAogICAgUmV0cnlFcnJvciwKICAgIFNTTEVycm9yLAopCmZyb20gLm1vZGVscyBpbXBvcnQgUmVzcG9uc2UKZnJvbSAuc3RydWN0dXJlcyBpbXBvcnQgQ2FzZUluc2Vuc2l0aXZlRGljdApmcm9tIC51dGlscyBpbXBvcnQgKAogICAgREVGQVVMVF9DQV9CVU5ETEVfUEFUSCwKICAgIGV4dHJhY3RfemlwcGVkX3BhdGhzLAogICAgZ2V0X2F1dGhfZnJvbV91cmwsCiAgICBnZXRfZW5jb2RpbmdfZnJvbV9oZWFkZXJzLAogICAgcHJlcGVuZF9zY2hlbWVfaWZfbmVlZGVkLAogICAgc2VsZWN0X3Byb3h5LAogICAgdXJsZGVmcmFnYXV0aCwKKQoKdHJ5OgogICAgZnJvbSB1cmxsaWIzLmNvbnRyaWIuc29ja3MgaW1wb3J0IFNPQ0tTUHJveHlNYW5hZ2VyCmV4Y2VwdCBJbXBvcnRFcnJvcjoKCiAgICBkZWYgU09DS1NQcm94eU1hbmFnZXIoKmFyZ3MsICoqa3dhcmdzKToKICAgICAgICByYWlzZSBJbnZhbGlkU2NoZW1hKCJNaXNzaW5nIGRlcGVuZGVuY2llcyBmb3IgU09DS1Mgc3VwcG9ydC4iKQoKCkRFRkFVTFRfUE9PTEJMT0NLID0gRmFsc2UKREVGQVVMVF9QT09MU0laRSA9IDEwCkRFRkFVTFRfUkVUUklFUyA9IDAKREVGQVVMVF9QT09MX1RJTUVPVVQgPSBOb25lCgoKY2xhc3MgQmFzZUFkYXB0ZXI6CiAgICAiIiJUaGUgQmFzZSBUcmFuc3BvcnQgQWRhcHRlciIiIgoKICAgIGRlZiBfX2luaXRfXyhzZWxmKToKICAgICAgICBzdXBlcigpLl9faW5pdF9fKCkKCiAgICBkZWYgc2VuZCgKICAgICAgICBzZWxmLCByZXF1ZXN0LCBzdHJlYW09RmFsc2UsIHRpbWVvdXQ9Tm9uZSwgdmVyaWZ5PVRydWUsIGNlcnQ9Tm9uZSwgcHJveGllcz1Ob25lCiAgICApOgogICAgICAgICIiIlNlbmRzIFByZXBhcmVkUmVxdWVzdCBvYmplY3QuIFJldHVybnMgUmVzcG9uc2Ugb2JqZWN0LgoKICAgICAgICA6cGFyYW0gcmVxdWVzdDogVGhlIDpjbGFzczpgUHJlcGFyZWRSZXF1ZXN0IDxQcmVwYXJlZFJlcXVlc3Q+YCBiZWluZyBzZW50LgogICAgICAgIDpwYXJhbSBzdHJlYW06IChvcHRpb25hbCkgV2hldGhlciB0byBzdHJlYW0gdGhlIHJlcXVlc3QgY29udGVudC4KICAgICAgICA6cGFyYW0gdGltZW91dDogKG9wdGlvbmFsKSBIb3cgbG9uZyB0byB3YWl0IGZvciB0aGUgc2VydmVyIHRvIHNlbmQKICAgICAgICAgICAgZGF0YSBiZWZvcmUgZ2l2aW5nIHVwLCBhcyBhIGZsb2F0LCBvciBhIDpyZWY6YChjb25uZWN0IHRpbWVvdXQsCiAgICAgICAgICAgIHJlYWQgdGltZW91dCkgPHRpbWVvdXRzPmAgdHVwbGUuCiAgICAgICAgOnR5cGUgdGltZW91dDogZmxvYXQgb3IgdHVwbGUKICAgICAgICA6cGFyYW0gdmVyaWZ5OiAob3B0aW9uYWwpIEVpdGhlciBhIGJvb2xlYW4sIGluIHdoaWNoIGNhc2UgaXQgY29udHJvbHMgd2hldGhlciB3ZSB2ZXJpZnkKICAgICAgICAgICAgdGhlIHNlcnZlcidzIFRMUyBjZXJ0aWZpY2F0ZSwgb3IgYSBzdHJpbmcsIGluIHdoaWNoIGNhc2UgaXQgbXVzdCBiZSBhIHBhdGgKICAgICAgICAgICAgdG8gYSBDQSBidW5kbGUgdG8gdXNlCiAgICAgICAgOnBhcmFtIGNlcnQ6IChvcHRpb25hbCkgQW55IHVzZXItcHJvdmlkZWQgU1NMIGNlcnRpZmljYXRlIHRvIGJlIHRydXN0ZWQuCiAgICAgICAgOnBhcmFtIHByb3hpZXM6IChvcHRpb25hbCkgVGhlIHByb3hpZXMgZGljdGlvbmFyeSB0byBhcHBseSB0byB0aGUgcmVxdWVzdC4KICAgICAgICAiIiIKICAgICAgICByYWlzZSBOb3RJbXBsZW1lbnRlZEVycm9yCgogICAgZGVmIGNsb3NlKHNlbGYpOgogICAgICAgICIiIkNsZWFucyB1cCBhZGFwdGVyIHNwZWNpZmljIGl0ZW1zLiIiIgogICAgICAgIHJhaXNlIE5vdEltcGxlbWVudGVkRXJyb3IKCgpjbGFzcyBIVFRQQWRhcHRlcihCYXNlQWRhcHRlcik6CiAgICAiIiJUaGUgYnVpbHQtaW4gSFRUUCBBZGFwdGVyIGZvciB1cmxsaWIzLgoKICAgIFByb3ZpZGVzIGEgZ2VuZXJhbC1jYXNlIGludGVyZmFjZSBmb3IgUmVxdWVzdHMgc2Vzc2lvbnMgdG8gY29udGFjdCBIVFRQIGFuZAogICAgSFRUUFMgdXJscyBieSBpbXBsZW1lbnRpbmcgdGhlIFRyYW5zcG9ydCBBZGFwdGVyIGludGVyZmFjZS4gVGhpcyBjbGFzcyB3aWxsCiAgICB1c3VhbGx5IGJlIGNyZWF0ZWQgYnkgdGhlIDpjbGFzczpgU2Vzc2lvbiA8U2Vzc2lvbj5gIGNsYXNzIHVuZGVyIHRoZQogICAgY292ZXJzLgoKICAgIDpwYXJhbSBwb29sX2Nvbm5lY3Rpb25zOiBUaGUgbnVtYmVyIG9mIHVybGxpYjMgY29ubmVjdGlvbiBwb29scyB0byBjYWNoZS4KICAgIDpwYXJhbSBwb29sX21heHNpemU6IFRoZSBtYXhpbXVtIG51bWJlciBvZiBjb25uZWN0aW9ucyB0byBzYXZlIGluIHRoZSBwb29sLgogICAgOnBhcmFtIG1heF9yZXRyaWVzOiBUaGUgbWF4aW11bSBudW1iZXIgb2YgcmV0cmllcyBlYWNoIGNvbm5lY3Rpb24KICAgICAgICBzaG91bGQgYXR0ZW1wdC4gTm90ZSwgdGhpcyBhcHBsaWVzIG9ubHkgdG8gZmFpbGVkIEROUyBsb29rdXBzLCBzb2NrZXQKICAgICAgICBjb25uZWN0aW9ucyBhbmQgY29ubmVjdGlvbiB0aW1lb3V0cywgbmV2ZXIgdG8gcmVxdWVzdHMgd2hlcmUgZGF0YSBoYXMKICAgICAgICBtYWRlIGl0IHRvIHRoZSBzZXJ2ZXIuIEJ5IGRlZmF1bHQsIFJlcXVlc3RzIGRvZXMgbm90IHJldHJ5IGZhaWxlZAogICAgICAgIGNvbm5lY3Rpb25zLiBJZiB5b3UgbmVlZCBncmFudWxhciBjb250cm9sIG92ZXIgdGhlIGNvbmRpdGlvbnMgdW5kZXIKICAgICAgICB3aGljaCB3ZSByZXRyeSBhIHJlcXVlc3QsIGltcG9ydCB1cmxsaWIzJ3MgYGBSZXRyeWBgIGNsYXNzIGFuZCBwYXNzCiAgICAgICAgdGhhdCBpbnN0ZWFkLgogICAgOnBhcmFtIHBvb2xfYmxvY2s6IFdoZXRoZXIgdGhlIGNvbm5lY3Rpb24gcG9vbCBzaG91bGQgYmxvY2sgZm9yIGNvbm5lY3Rpb25zLgoKICAgIFVzYWdlOjoKCiAgICAgID4+PiBpbXBvcnQgcmVxdWVzdHMKICAgICAgPj4+IHMgPSByZXF1ZXN0cy5TZXNzaW9uKCkKICAgICAgPj4+IGEgPSByZXF1ZXN0cy5hZGFwdGVycy5IVFRQQWRhcHRlcihtYXhfcmV0cmllcz0zKQogICAgICA+Pj4gcy5tb3VudCgnaHR0cDovLycsIGEpCiAgICAiIiIKCiAgICBfX2F0dHJzX18gPSBbCiAgICAgICAgIm1heF9yZXRyaWVzIiwKICAgICAgICAiY29uZmlnIiwKICAgICAgICAiX3Bvb2xfY29ubmVjdGlvbnMiLAogICAgICAgICJfcG9vbF9tYXhzaXplIiwKICAgICAgICAiX3Bvb2xfYmxvY2siLAogICAgXQoKICAgIGRlZiBfX2luaXRfXygKICAgICAgICBzZWxmLAogICAgICAgIHBvb2xfY29ubmVjdGlvbnM9REVGQVVMVF9QT09MU0laRSwKICAgICAgICBwb29sX21heHNpemU9REVGQVVMVF9QT09MU0laRSwKICAgICAgICBtYXhfcmV0cmllcz1ERUZBVUxUX1JFVFJJRVMsCiAgICAgICAgcG9vbF9ibG9jaz1ERUZBVUxUX1BPT0xCTE9DSywKICAgICk6CiAgICAgICAgaWYgbWF4X3JldHJpZXMgPT0gREVGQVVMVF9SRVRSSUVTOgogICAgICAgICAgICBzZWxmLm1heF9yZXRyaWVzID0gUmV0cnkoMCwgcmVhZD1GYWxzZSkKICAgICAgICBlbHNlOgogICAgICAgICAgICBzZWxmLm1heF9yZXRyaWVzID0gUmV0cnkuZnJvbV9pbnQobWF4X3JldHJpZXMpCiAgICAgICAgc2VsZi5jb25maWcgPSB7fQogICAgICAgIHNlbGYucHJveHlfbWFuYWdlciA9IHt9CgogICAgICAgIHN1cGVyKCkuX19pbml0X18oKQoKICAgICAgICBzZWxmLl9wb29sX2Nvbm5lY3Rpb25zID0gcG9vbF9jb25uZWN0aW9ucwogICAgICAgIHNlbGYuX3Bvb2xfbWF4c2l6ZSA9IHBvb2xfbWF4c2l6ZQogICAgICAgIHNlbGYuX3Bvb2xfYmxvY2sgPSBwb29sX2Jsb2NrCgogICAgICAgIHNlbGYuaW5pdF9wb29sbWFuYWdlcihwb29sX2Nvbm5lY3Rpb25zLCBwb29sX21heHNpemUsIGJsb2NrPXBvb2xfYmxvY2spCgogICAgZGVmIF9fZ2V0c3RhdGVfXyhzZWxmKToKICAgICAgICByZXR1cm4ge2F0dHI6IGdldGF0dHIoc2VsZiwgYXR0ciwgTm9uZSkgZm9yIGF0dHIgaW4gc2VsZi5fX2F0dHJzX199CgogICAgZGVmIF9fc2V0c3RhdGVfXyhzZWxmLCBzdGF0ZSk6CiAgICAgICAgIyBDYW4ndCBoYW5kbGUgYnkgYWRkaW5nICdwcm94eV9tYW5hZ2VyJyB0byBzZWxmLl9fYXR0cnNfXyBiZWNhdXNlCiAgICAgICAgIyBzZWxmLnBvb2xtYW5hZ2VyIHVzZXMgYSBsYW1iZGEgZnVuY3Rpb24sIHdoaWNoIGlzbid0IHBpY2tsZWFibGUuCiAgICAgICAgc2VsZi5wcm94eV9tYW5hZ2VyID0ge30KICAgICAgICBzZWxmLmNvbmZpZyA9IHt9CgogICAgICAgIGZvciBhdHRyLCB2YWx1ZSBpbiBzdGF0ZS5pdGVtcygpOgogICAgICAgICAgICBzZXRhdHRyKHNlbGYsIGF0dHIsIHZhbHVlKQoKICAgICAgICBzZWxmLmluaXRfcG9vbG1hbmFnZXIoCiAgICAgICAgICAgIHNlbGYuX3Bvb2xfY29ubmVjdGlvbnMsIHNlbGYuX3Bvb2xfbWF4c2l6ZSwgYmxvY2s9c2VsZi5fcG9vbF9ibG9jawogICAgICAgICkKCiAgICBkZWYgaW5pdF9wb29sbWFuYWdlcigKICAgICAgICBzZWxmLCBjb25uZWN0aW9ucywgbWF4c2l6ZSwgYmxvY2s9REVGQVVMVF9QT09MQkxPQ0ssICoqcG9vbF9rd2FyZ3MKICAgICk6CiAgICAgICAgIiIiSW5pdGlhbGl6ZXMgYSB1cmxsaWIzIFBvb2xNYW5hZ2VyLgoKICAgICAgICBUaGlzIG1ldGhvZCBzaG91bGQgbm90IGJlIGNhbGxlZCBmcm9tIHVzZXIgY29kZSwgYW5kIGlzIG9ubHkKICAgICAgICBleHBvc2VkIGZvciB1c2Ugd2hlbiBzdWJjbGFzc2luZyB0aGUKICAgICAgICA6Y2xhc3M6YEhUVFBBZGFwdGVyIDxyZXF1ZXN0cy5hZGFwdGVycy5IVFRQQWRhcHRlcj5gLgoKICAgICAgICA6cGFyYW0gY29ubmVjdGlvbnM6IFRoZSBudW1iZXIgb2YgdXJsbGliMyBjb25uZWN0aW9uIHBvb2xzIHRvIGNhY2hlLgogICAgICAgIDpwYXJhbSBtYXhzaXplOiBUaGUgbWF4aW11bSBudW1iZXIgb2YgY29ubmVjdGlvbnMgdG8gc2F2ZSBpbiB0aGUgcG9vbC4KICAgICAgICA6cGFyYW0gYmxvY2s6IEJsb2NrIHdoZW4gbm8gZnJlZSBjb25uZWN0aW9ucyBhcmUgYXZhaWxhYmxlLgogICAgICAgIDpwYXJhbSBwb29sX2t3YXJnczogRXh0cmEga2V5d29yZCBhcmd1bWVudHMgdXNlZCB0byBpbml0aWFsaXplIHRoZSBQb29sIE1hbmFnZXIuCiAgICAgICAgIiIiCiAgICAgICAgIyBzYXZlIHRoZXNlIHZhbHVlcyBmb3IgcGlja2xpbmcKICAgICAgICBzZWxmLl9wb29sX2Nvbm5lY3Rpb25zID0gY29ubmVjdGlvbnMKICAgICAgICBzZWxmLl9wb29sX21heHNpemUgPSBtYXhzaXplCiAgICAgICAgc2VsZi5fcG9vbF9ibG9jayA9IGJsb2NrCgogICAgICAgIHNlbGYucG9vbG1hbmFnZXIgPSBQb29sTWFuYWdlcigKICAgICAgICAgICAgbnVtX3Bvb2xzPWNvbm5lY3Rpb25zLAogICAgICAgICAgICBtYXhzaXplPW1heHNpemUsCiAgICAgICAgICAgIGJsb2NrPWJsb2NrLAogICAgICAgICAgICBzdHJpY3Q9VHJ1ZSwKICAgICAgICAgICAgKipwb29sX2t3YXJncywKICAgICAgICApCgogICAgZGVmIHByb3h5X21hbmFnZXJfZm9yKHNlbGYsIHByb3h5LCAqKnByb3h5X2t3YXJncyk6CiAgICAgICAgIiIiUmV0dXJuIHVybGxpYjMgUHJveHlNYW5hZ2VyIGZvciB0aGUgZ2l2ZW4gcHJveHkuCgogICAgICAgIFRoaXMgbWV0aG9kIHNob3VsZCBub3QgYmUgY2FsbGVkIGZyb20gdXNlciBjb2RlLCBhbmQgaXMgb25seQogICAgICAgIGV4cG9zZWQgZm9yIHVzZSB3aGVuIHN1YmNsYXNzaW5nIHRoZQogICAgICAgIDpjbGFzczpgSFRUUEFkYXB0ZXIgPHJlcXVlc3RzLmFkYXB0ZXJzLkhUVFBBZGFwdGVyPmAuCgogICAgICAgIDpwYXJhbSBwcm94eTogVGhlIHByb3h5IHRvIHJldHVybiBhIHVybGxpYjMgUHJveHlNYW5hZ2VyIGZvci4KICAgICAgICA6cGFyYW0gcHJveHlfa3dhcmdzOiBFeHRyYSBrZXl3b3JkIGFyZ3VtZW50cyB1c2VkIHRvIGNvbmZpZ3VyZSB0aGUgUHJveHkgTWFuYWdlci4KICAgICAgICA6cmV0dXJuczogUHJveHlNYW5hZ2VyCiAgICAgICAgOnJ0eXBlOiB1cmxsaWIzLlByb3h5TWFuYWdlcgogICAgICAgICIiIgogICAgICAgIGlmIHByb3h5IGluIHNlbGYucHJveHlfbWFuYWdlcjoKICAgICAgICAgICAgbWFuYWdlciA9IHNlbGYucHJveHlfbWFuYWdlcltwcm94eV0KICAgICAgICBlbGlmIHByb3h5Lmxvd2VyKCkuc3RhcnRzd2l0aCgic29ja3MiKToKICAgICAgICAgICAgdXNlcm5hbWUsIHBhc3N3b3JkID0gZ2V0X2F1dGhfZnJvbV91cmwocHJveHkpCiAgICAgICAgICAgIG1hbmFnZXIgPSBzZWxmLnByb3h5X21hbmFnZXJbcHJveHldID0gU09DS1NQcm94eU1hbmFnZXIoCiAgICAgICAgICAgICAgICBwcm94eSwKICAgICAgICAgICAgICAgIHVzZXJuYW1lPXVzZXJuYW1lLAogICAgICAgICAgICAgICAgcGFzc3dvcmQ9cGFzc3dvcmQsCiAgICAgICAgICAgICAgICBudW1fcG9vbHM9c2VsZi5fcG9vbF9jb25uZWN0aW9ucywKICAgICAgICAgICAgICAgIG1heHNpemU9c2VsZi5fcG9vbF9tYXhzaXplLAogICAgICAgICAgICAgICAgYmxvY2s9c2VsZi5fcG9vbF9ibG9jaywKICAgICAgICAgICAgICAgICoqcHJveHlfa3dhcmdzLAogICAgICAgICAgICApCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcHJveHlfaGVhZGVycyA9IHNlbGYucHJveHlfaGVhZGVycyhwcm94eSkKICAgICAgICAgICAgbWFuYWdlciA9IHNlbGYucHJveHlfbWFuYWdlcltwcm94eV0gPSBwcm94eV9mcm9tX3VybCgKICAgICAgICAgICAgICAgIHByb3h5LAogICAgICAgICAgICAgICAgcHJveHlfaGVhZGVycz1wcm94eV9oZWFkZXJzLAogICAgICAgICAgICAgICAgbnVtX3Bvb2xzPXNlbGYuX3Bvb2xfY29ubmVjdGlvbnMsCiAgICAgICAgICAgICAgICBtYXhzaXplPXNlbGYuX3Bvb2xfbWF4c2l6ZSwKICAgICAgICAgICAgICAgIGJsb2NrPXNlbGYuX3Bvb2xfYmxvY2ssCiAgICAgICAgICAgICAgICAqKnByb3h5X2t3YXJncywKICAgICAgICAgICAgKQoKICAgICAgICByZXR1cm4gbWFuYWdlcgoKICAgIGRlZiBjZXJ0X3ZlcmlmeShzZWxmLCBjb25uLCB1cmwsIHZlcmlmeSwgY2VydCk6CiAgICAgICAgIiIiVmVyaWZ5IGEgU1NMIGNlcnRpZmljYXRlLiBUaGlzIG1ldGhvZCBzaG91bGQgbm90IGJlIGNhbGxlZCBmcm9tIHVzZXIKICAgICAgICBjb2RlLCBhbmQgaXMgb25seSBleHBvc2VkIGZvciB1c2Ugd2hlbiBzdWJjbGFzc2luZyB0aGUKICAgICAgICA6Y2xhc3M6YEhUVFBBZGFwdGVyIDxyZXF1ZXN0cy5hZGFwdGVycy5IVFRQQWRhcHRlcj5gLgoKICAgICAgICA6cGFyYW0gY29ubjogVGhlIHVybGxpYjMgY29ubmVjdGlvbiBvYmplY3QgYXNzb2NpYXRlZCB3aXRoIHRoZSBjZXJ0LgogICAgICAgIDpwYXJhbSB1cmw6IFRoZSByZXF1ZXN0ZWQgVVJMLgogICAgICAgIDpwYXJhbSB2ZXJpZnk6IEVpdGhlciBhIGJvb2xlYW4sIGluIHdoaWNoIGNhc2UgaXQgY29udHJvbHMgd2hldGhlciB3ZSB2ZXJpZnkKICAgICAgICAgICAgdGhlIHNlcnZlcidzIFRMUyBjZXJ0aWZpY2F0ZSwgb3IgYSBzdHJpbmcsIGluIHdoaWNoIGNhc2UgaXQgbXVzdCBiZSBhIHBhdGgKICAgICAgICAgICAgdG8gYSBDQSBidW5kbGUgdG8gdXNlCiAgICAgICAgOnBhcmFtIGNlcnQ6IFRoZSBTU0wgY2VydGlmaWNhdGUgdG8gdmVyaWZ5LgogICAgICAgICIiIgogICAgICAgIGlmIHVybC5sb3dlcigpLnN0YXJ0c3dpdGgoImh0dHBzIikgYW5kIHZlcmlmeToKCiAgICAgICAgICAgIGNlcnRfbG9jID0gTm9uZQoKICAgICAgICAgICAgIyBBbGxvdyBzZWxmLXNwZWNpZmllZCBjZXJ0IGxvY2F0aW9uLgogICAgICAgICAgICBpZiB2ZXJpZnkgaXMgbm90IFRydWU6CiAgICAgICAgICAgICAgICBjZXJ0X2xvYyA9IHZlcmlmeQoKICAgICAgICAgICAgaWYgbm90IGNlcnRfbG9jOgogICAgICAgICAgICAgICAgY2VydF9sb2MgPSBleHRyYWN0X3ppcHBlZF9wYXRocyhERUZBVUxUX0NBX0JVTkRMRV9QQVRIKQoKICAgICAgICAgICAgaWYgbm90IGNlcnRfbG9jIG9yIG5vdCBvcy5wYXRoLmV4aXN0cyhjZXJ0X2xvYyk6CiAgICAgICAgICAgICAgICByYWlzZSBPU0Vycm9yKAogICAgICAgICAgICAgICAgICAgIGYiQ291bGQgbm90IGZpbmQgYSBzdWl0YWJsZSBUTFMgQ0EgY2VydGlmaWNhdGUgYnVuZGxlLCAiCiAgICAgICAgICAgICAgICAgICAgZiJpbnZhbGlkIHBhdGg6IHtjZXJ0X2xvY30iCiAgICAgICAgICAgICAgICApCgogICAgICAgICAgICBjb25uLmNlcnRfcmVxcyA9ICJDRVJUX1JFUVVJUkVEIgoKICAgICAgICAgICAgaWYgbm90IG9zLnBhdGguaXNkaXIoY2VydF9sb2MpOgogICAgICAgICAgICAgICAgY29ubi5jYV9jZXJ0cyA9IGNlcnRfbG9jCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBjb25uLmNhX2NlcnRfZGlyID0gY2VydF9sb2MKICAgICAgICBlbHNlOgogICAgICAgICAgICBjb25uLmNlcnRfcmVxcyA9ICJDRVJUX05PTkUiCiAgICAgICAgICAgIGNvbm4uY2FfY2VydHMgPSBOb25lCiAgICAgICAgICAgIGNvbm4uY2FfY2VydF9kaXIgPSBOb25lCgogICAgICAgIGlmIGNlcnQ6CiAgICAgICAgICAgIGlmIG5vdCBpc2luc3RhbmNlKGNlcnQsIGJhc2VzdHJpbmcpOgogICAgICAgICAgICAgICAgY29ubi5jZXJ0X2ZpbGUgPSBjZXJ0WzBdCiAgICAgICAgICAgICAgICBjb25uLmtleV9maWxlID0gY2VydFsxXQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgY29ubi5jZXJ0X2ZpbGUgPSBjZXJ0CiAgICAgICAgICAgICAgICBjb25uLmtleV9maWxlID0gTm9uZQogICAgICAgICAgICBpZiBjb25uLmNlcnRfZmlsZSBhbmQgbm90IG9zLnBhdGguZXhpc3RzKGNvbm4uY2VydF9maWxlKToKICAgICAgICAgICAgICAgIHJhaXNlIE9TRXJyb3IoCiAgICAgICAgICAgICAgICAgICAgZiJDb3VsZCBub3QgZmluZCB0aGUgVExTIGNlcnRpZmljYXRlIGZpbGUsICIKICAgICAgICAgICAgICAgICAgICBmImludmFsaWQgcGF0aDoge2Nvbm4uY2VydF9maWxlfSIKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgaWYgY29ubi5rZXlfZmlsZSBhbmQgbm90IG9zLnBhdGguZXhpc3RzKGNvbm4ua2V5X2ZpbGUpOgogICAgICAgICAgICAgICAgcmFpc2UgT1NFcnJvcigKICAgICAgICAgICAgICAgICAgICBmIkNvdWxkIG5vdCBmaW5kIHRoZSBUTFMga2V5IGZpbGUsIGludmFsaWQgcGF0aDoge2Nvbm4ua2V5X2ZpbGV9IgogICAgICAgICAgICAgICAgKQoKICAgIGRlZiBidWlsZF9yZXNwb25zZShzZWxmLCByZXEsIHJlc3ApOgogICAgICAgICIiIkJ1aWxkcyBhIDpjbGFzczpgUmVzcG9uc2UgPHJlcXVlc3RzLlJlc3BvbnNlPmAgb2JqZWN0IGZyb20gYSB1cmxsaWIzCiAgICAgICAgcmVzcG9uc2UuIFRoaXMgc2hvdWxkIG5vdCBiZSBjYWxsZWQgZnJvbSB1c2VyIGNvZGUsIGFuZCBpcyBvbmx5IGV4cG9zZWQKICAgICAgICBmb3IgdXNlIHdoZW4gc3ViY2xhc3NpbmcgdGhlCiAgICAgICAgOmNsYXNzOmBIVFRQQWRhcHRlciA8cmVxdWVzdHMuYWRhcHRlcnMuSFRUUEFkYXB0ZXI+YAoKICAgICAgICA6cGFyYW0gcmVxOiBUaGUgOmNsYXNzOmBQcmVwYXJlZFJlcXVlc3QgPFByZXBhcmVkUmVxdWVzdD5gIHVzZWQgdG8gZ2VuZXJhdGUgdGhlIHJlc3BvbnNlLgogICAgICAgIDpwYXJhbSByZXNwOiBUaGUgdXJsbGliMyByZXNwb25zZSBvYmplY3QuCiAgICAgICAgOnJ0eXBlOiByZXF1ZXN0cy5SZXNwb25zZQogICAgICAgICIiIgogICAgICAgIHJlc3BvbnNlID0gUmVzcG9uc2UoKQoKICAgICAgICAjIEZhbGxiYWNrIHRvIE5vbmUgaWYgdGhlcmUncyBubyBzdGF0dXNfY29kZSwgZm9yIHdoYXRldmVyIHJlYXNvbi4KICAgICAgICByZXNwb25zZS5zdGF0dXNfY29kZSA9IGdldGF0dHIocmVzcCwgInN0YXR1cyIsIE5vbmUpCgogICAgICAgICMgTWFrZSBoZWFkZXJzIGNhc2UtaW5zZW5zaXRpdmUuCiAgICAgICAgcmVzcG9uc2UuaGVhZGVycyA9IENhc2VJbnNlbnNpdGl2ZURpY3QoZ2V0YXR0cihyZXNwLCAiaGVhZGVycyIsIHt9KSkKCiAgICAgICAgIyBTZXQgZW5jb2RpbmcuCiAgICAgICAgcmVzcG9uc2UuZW5jb2RpbmcgPSBnZXRfZW5jb2RpbmdfZnJvbV9oZWFkZXJzKHJlc3BvbnNlLmhlYWRlcnMpCiAgICAgICAgcmVzcG9uc2UucmF3ID0gcmVzcAogICAgICAgIHJlc3BvbnNlLnJlYXNvbiA9IHJlc3BvbnNlLnJhdy5yZWFzb24KCiAgICAgICAgaWYgaXNpbnN0YW5jZShyZXEudXJsLCBieXRlcyk6CiAgICAgICAgICAgIHJlc3BvbnNlLnVybCA9IHJlcS51cmwuZGVjb2RlKCJ1dGYtOCIpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmVzcG9uc2UudXJsID0gcmVxLnVybAoKICAgICAgICAjIEFkZCBuZXcgY29va2llcyBmcm9tIHRoZSBzZXJ2ZXIuCiAgICAgICAgZXh0cmFjdF9jb29raWVzX3RvX2phcihyZXNwb25zZS5jb29raWVzLCByZXEsIHJlc3ApCgogICAgICAgICMgR2l2ZSB0aGUgUmVzcG9uc2Ugc29tZSBjb250ZXh0LgogICAgICAgIHJlc3BvbnNlLnJlcXVlc3QgPSByZXEKICAgICAgICByZXNwb25zZS5jb25uZWN0aW9uID0gc2VsZgoKICAgICAgICByZXR1cm4gcmVzcG9uc2UKCiAgICBkZWYgZ2V0X2Nvbm5lY3Rpb24oc2VsZiwgdXJsLCBwcm94aWVzPU5vbmUpOgogICAgICAgICIiIlJldHVybnMgYSB1cmxsaWIzIGNvbm5lY3Rpb24gZm9yIHRoZSBnaXZlbiBVUkwuIFRoaXMgc2hvdWxkIG5vdCBiZQogICAgICAgIGNhbGxlZCBmcm9tIHVzZXIgY29kZSwgYW5kIGlzIG9ubHkgZXhwb3NlZCBmb3IgdXNlIHdoZW4gc3ViY2xhc3NpbmcgdGhlCiAgICAgICAgOmNsYXNzOmBIVFRQQWRhcHRlciA8cmVxdWVzdHMuYWRhcHRlcnMuSFRUUEFkYXB0ZXI+YC4KCiAgICAgICAgOnBhcmFtIHVybDogVGhlIFVSTCB0byBjb25uZWN0IHRvLgogICAgICAgIDpwYXJhbSBwcm94aWVzOiAob3B0aW9uYWwpIEEgUmVxdWVzdHMtc3R5bGUgZGljdGlvbmFyeSBvZiBwcm94aWVzIHVzZWQgb24gdGhpcyByZXF1ZXN0LgogICAgICAgIDpydHlwZTogdXJsbGliMy5Db25uZWN0aW9uUG9vbAogICAgICAgICIiIgogICAgICAgIHByb3h5ID0gc2VsZWN0X3Byb3h5KHVybCwgcHJveGllcykKCiAgICAgICAgaWYgcHJveHk6CiAgICAgICAgICAgIHByb3h5ID0gcHJlcGVuZF9zY2hlbWVfaWZfbmVlZGVkKHByb3h5LCAiaHR0cCIpCiAgICAgICAgICAgIHByb3h5X3VybCA9IHBhcnNlX3VybChwcm94eSkKICAgICAgICAgICAgaWYgbm90IHByb3h5X3VybC5ob3N0OgogICAgICAgICAgICAgICAgcmFpc2UgSW52YWxpZFByb3h5VVJMKAogICAgICAgICAgICAgICAgICAgICJQbGVhc2UgY2hlY2sgcHJveHkgVVJMLiBJdCBpcyBtYWxmb3JtZWQgIgogICAgICAgICAgICAgICAgICAgICJhbmQgY291bGQgYmUgbWlzc2luZyB0aGUgaG9zdC4iCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgIHByb3h5X21hbmFnZXIgPSBzZWxmLnByb3h5X21hbmFnZXJfZm9yKHByb3h5KQogICAgICAgICAgICBjb25uID0gcHJveHlfbWFuYWdlci5jb25uZWN0aW9uX2Zyb21fdXJsKHVybCkKICAgICAgICBlbHNlOgogICAgICAgICAgICAjIE9ubHkgc2NoZW1lIHNob3VsZCBiZSBsb3dlciBjYXNlCiAgICAgICAgICAgIHBhcnNlZCA9IHVybHBhcnNlKHVybCkKICAgICAgICAgICAgdXJsID0gcGFyc2VkLmdldHVybCgpCiAgICAgICAgICAgIGNvbm4gPSBzZWxmLnBvb2xtYW5hZ2VyLmNvbm5lY3Rpb25fZnJvbV91cmwodXJsKQoKICAgICAgICByZXR1cm4gY29ubgoKICAgIGRlZiBjbG9zZShzZWxmKToKICAgICAgICAiIiJEaXNwb3NlcyBvZiBhbnkgaW50ZXJuYWwgc3RhdGUuCgogICAgICAgIEN1cnJlbnRseSwgdGhpcyBjbG9zZXMgdGhlIFBvb2xNYW5hZ2VyIGFuZCBhbnkgYWN0aXZlIFByb3h5TWFuYWdlciwKICAgICAgICB3aGljaCBjbG9zZXMgYW55IHBvb2xlZCBjb25uZWN0aW9ucy4KICAgICAgICAiIiIKICAgICAgICBzZWxmLnBvb2xtYW5hZ2VyLmNsZWFyKCkKICAgICAgICBmb3IgcHJveHkgaW4gc2VsZi5wcm94eV9tYW5hZ2VyLnZhbHVlcygpOgogICAgICAgICAgICBwcm94eS5jbGVhcigpCgogICAgZGVmIHJlcXVlc3RfdXJsKHNlbGYsIHJlcXVlc3QsIHByb3hpZXMpOgogICAgICAgICIiIk9idGFpbiB0aGUgdXJsIHRvIHVzZSB3aGVuIG1ha2luZyB0aGUgZmluYWwgcmVxdWVzdC4KCiAgICAgICAgSWYgdGhlIG1lc3NhZ2UgaXMgYmVpbmcgc2VudCB0aHJvdWdoIGEgSFRUUCBwcm94eSwgdGhlIGZ1bGwgVVJMIGhhcyB0bwogICAgICAgIGJlIHVzZWQuIE90aGVyd2lzZSwgd2Ugc2hvdWxkIG9ubHkgdXNlIHRoZSBwYXRoIHBvcnRpb24gb2YgdGhlIFVSTC4KCiAgICAgICAgVGhpcyBzaG91bGQgbm90IGJlIGNhbGxlZCBmcm9tIHVzZXIgY29kZSwgYW5kIGlzIG9ubHkgZXhwb3NlZCBmb3IgdXNlCiAgICAgICAgd2hlbiBzdWJjbGFzc2luZyB0aGUKICAgICAgICA6Y2xhc3M6YEhUVFBBZGFwdGVyIDxyZXF1ZXN0cy5hZGFwdGVycy5IVFRQQWRhcHRlcj5gLgoKICAgICAgICA6cGFyYW0gcmVxdWVzdDogVGhlIDpjbGFzczpgUHJlcGFyZWRSZXF1ZXN0IDxQcmVwYXJlZFJlcXVlc3Q+YCBiZWluZyBzZW50LgogICAgICAgIDpwYXJhbSBwcm94aWVzOiBBIGRpY3Rpb25hcnkgb2Ygc2NoZW1lcyBvciBzY2hlbWVzIGFuZCBob3N0cyB0byBwcm94eSBVUkxzLgogICAgICAgIDpydHlwZTogc3RyCiAgICAgICAgIiIiCiAgICAgICAgcHJveHkgPSBzZWxlY3RfcHJveHkocmVxdWVzdC51cmwsIHByb3hpZXMpCiAgICAgICAgc2NoZW1lID0gdXJscGFyc2UocmVxdWVzdC51cmwpLnNjaGVtZQoKICAgICAgICBpc19wcm94aWVkX2h0dHBfcmVxdWVzdCA9IHByb3h5IGFuZCBzY2hlbWUgIT0gImh0dHBzIgogICAgICAgIHVzaW5nX3NvY2tzX3Byb3h5ID0gRmFsc2UKICAgICAgICBpZiBwcm94eToKICAgICAgICAgICAgcHJveHlfc2NoZW1lID0gdXJscGFyc2UocHJveHkpLnNjaGVtZS5sb3dlcigpCiAgICAgICAgICAgIHVzaW5nX3NvY2tzX3Byb3h5ID0gcHJveHlfc2NoZW1lLnN0YXJ0c3dpdGgoInNvY2tzIikKCiAgICAgICAgdXJsID0gcmVxdWVzdC5wYXRoX3VybAogICAgICAgIGlmIGlzX3Byb3hpZWRfaHR0cF9yZXF1ZXN0IGFuZCBub3QgdXNpbmdfc29ja3NfcHJveHk6CiAgICAgICAgICAgIHVybCA9IHVybGRlZnJhZ2F1dGgocmVxdWVzdC51cmwpCgogICAgICAgIHJldHVybiB1cmwKCiAgICBkZWYgYWRkX2hlYWRlcnMoc2VsZiwgcmVxdWVzdCwgKiprd2FyZ3MpOgogICAgICAgICIiIkFkZCBhbnkgaGVhZGVycyBuZWVkZWQgYnkgdGhlIGNvbm5lY3Rpb24uIEFzIG9mIHYyLjAgdGhpcyBkb2VzCiAgICAgICAgbm90aGluZyBieSBkZWZhdWx0LCBidXQgaXMgbGVmdCBmb3Igb3ZlcnJpZGluZyBieSB1c2VycyB0aGF0IHN1YmNsYXNzCiAgICAgICAgdGhlIDpjbGFzczpgSFRUUEFkYXB0ZXIgPHJlcXVlc3RzLmFkYXB0ZXJzLkhUVFBBZGFwdGVyPmAuCgogICAgICAgIFRoaXMgc2hvdWxkIG5vdCBiZSBjYWxsZWQgZnJvbSB1c2VyIGNvZGUsIGFuZCBpcyBvbmx5IGV4cG9zZWQgZm9yIHVzZQogICAgICAgIHdoZW4gc3ViY2xhc3NpbmcgdGhlCiAgICAgICAgOmNsYXNzOmBIVFRQQWRhcHRlciA8cmVxdWVzdHMuYWRhcHRlcnMuSFRUUEFkYXB0ZXI+YC4KCiAgICAgICAgOnBhcmFtIHJlcXVlc3Q6IFRoZSA6Y2xhc3M6YFByZXBhcmVkUmVxdWVzdCA8UHJlcGFyZWRSZXF1ZXN0PmAgdG8gYWRkIGhlYWRlcnMgdG8uCiAgICAgICAgOnBhcmFtIGt3YXJnczogVGhlIGtleXdvcmQgYXJndW1lbnRzIGZyb20gdGhlIGNhbGwgdG8gc2VuZCgpLgogICAgICAgICIiIgogICAgICAgIHBhc3MKCiAgICBkZWYgcHJveHlfaGVhZGVycyhzZWxmLCBwcm94eSk6CiAgICAgICAgIiIiUmV0dXJucyBhIGRpY3Rpb25hcnkgb2YgdGhlIGhlYWRlcnMgdG8gYWRkIHRvIGFueSByZXF1ZXN0IHNlbnQKICAgICAgICB0aHJvdWdoIGEgcHJveHkuIFRoaXMgd29ya3Mgd2l0aCB1cmxsaWIzIG1hZ2ljIHRvIGVuc3VyZSB0aGF0IHRoZXkgYXJlCiAgICAgICAgY29ycmVjdGx5IHNlbnQgdG8gdGhlIHByb3h5LCByYXRoZXIgdGhhbiBpbiBhIHR1bm5lbGxlZCByZXF1ZXN0IGlmCiAgICAgICAgQ09OTkVDVCBpcyBiZWluZyB1c2VkLgoKICAgICAgICBUaGlzIHNob3VsZCBub3QgYmUgY2FsbGVkIGZyb20gdXNlciBjb2RlLCBhbmQgaXMgb25seSBleHBvc2VkIGZvciB1c2UKICAgICAgICB3aGVuIHN1YmNsYXNzaW5nIHRoZQogICAgICAgIDpjbGFzczpgSFRUUEFkYXB0ZXIgPHJlcXVlc3RzLmFkYXB0ZXJzLkhUVFBBZGFwdGVyPmAuCgogICAgICAgIDpwYXJhbSBwcm94eTogVGhlIHVybCBvZiB0aGUgcHJveHkgYmVpbmcgdXNlZCBmb3IgdGhpcyByZXF1ZXN0LgogICAgICAgIDpydHlwZTogZGljdAogICAgICAgICIiIgogICAgICAgIGhlYWRlcnMgPSB7fQogICAgICAgIHVzZXJuYW1lLCBwYXNzd29yZCA9IGdldF9hdXRoX2Zyb21fdXJsKHByb3h5KQoKICAgICAgICBpZiB1c2VybmFtZToKICAgICAgICAgICAgaGVhZGVyc1siUHJveHktQXV0aG9yaXphdGlvbiJdID0gX2Jhc2ljX2F1dGhfc3RyKHVzZXJuYW1lLCBwYXNzd29yZCkKCiAgICAgICAgcmV0dXJuIGhlYWRlcnMKCiAgICBkZWYgc2VuZCgKICAgICAgICBzZWxmLCByZXF1ZXN0LCBzdHJlYW09RmFsc2UsIHRpbWVvdXQ9Tm9uZSwgdmVyaWZ5PVRydWUsIGNlcnQ9Tm9uZSwgcHJveGllcz1Ob25lCiAgICApOgogICAgICAgICIiIlNlbmRzIFByZXBhcmVkUmVxdWVzdCBvYmplY3QuIFJldHVybnMgUmVzcG9uc2Ugb2JqZWN0LgoKICAgICAgICA6cGFyYW0gcmVxdWVzdDogVGhlIDpjbGFzczpgUHJlcGFyZWRSZXF1ZXN0IDxQcmVwYXJlZFJlcXVlc3Q+YCBiZWluZyBzZW50LgogICAgICAgIDpwYXJhbSBzdHJlYW06IChvcHRpb25hbCkgV2hldGhlciB0byBzdHJlYW0gdGhlIHJlcXVlc3QgY29udGVudC4KICAgICAgICA6cGFyYW0gdGltZW91dDogKG9wdGlvbmFsKSBIb3cgbG9uZyB0byB3YWl0IGZvciB0aGUgc2VydmVyIHRvIHNlbmQKICAgICAgICAgICAgZGF0YSBiZWZvcmUgZ2l2aW5nIHVwLCBhcyBhIGZsb2F0LCBvciBhIDpyZWY6YChjb25uZWN0IHRpbWVvdXQsCiAgICAgICAgICAgIHJlYWQgdGltZW91dCkgPHRpbWVvdXRzPmAgdHVwbGUuCiAgICAgICAgOnR5cGUgdGltZW91dDogZmxvYXQgb3IgdHVwbGUgb3IgdXJsbGliMyBUaW1lb3V0IG9iamVjdAogICAgICAgIDpwYXJhbSB2ZXJpZnk6IChvcHRpb25hbCkgRWl0aGVyIGEgYm9vbGVhbiwgaW4gd2hpY2ggY2FzZSBpdCBjb250cm9scyB3aGV0aGVyCiAgICAgICAgICAgIHdlIHZlcmlmeSB0aGUgc2VydmVyJ3MgVExTIGNlcnRpZmljYXRlLCBvciBhIHN0cmluZywgaW4gd2hpY2ggY2FzZSBpdAogICAgICAgICAgICBtdXN0IGJlIGEgcGF0aCB0byBhIENBIGJ1bmRsZSB0byB1c2UKICAgICAgICA6cGFyYW0gY2VydDogKG9wdGlvbmFsKSBBbnkgdXNlci1wcm92aWRlZCBTU0wgY2VydGlmaWNhdGUgdG8gYmUgdHJ1c3RlZC4KICAgICAgICA6cGFyYW0gcHJveGllczogKG9wdGlvbmFsKSBUaGUgcHJveGllcyBkaWN0aW9uYXJ5IHRvIGFwcGx5IHRvIHRoZSByZXF1ZXN0LgogICAgICAgIDpydHlwZTogcmVxdWVzdHMuUmVzcG9uc2UKICAgICAgICAiIiIKCiAgICAgICAgdHJ5OgogICAgICAgICAgICBjb25uID0gc2VsZi5nZXRfY29ubmVjdGlvbihyZXF1ZXN0LnVybCwgcHJveGllcykKICAgICAgICBleGNlcHQgTG9jYXRpb25WYWx1ZUVycm9yIGFzIGU6CiAgICAgICAgICAgIHJhaXNlIEludmFsaWRVUkwoZSwgcmVxdWVzdD1yZXF1ZXN0KQoKICAgICAgICBzZWxmLmNlcnRfdmVyaWZ5KGNvbm4sIHJlcXVlc3QudXJsLCB2ZXJpZnksIGNlcnQpCiAgICAgICAgdXJsID0gc2VsZi5yZXF1ZXN0X3VybChyZXF1ZXN0LCBwcm94aWVzKQogICAgICAgIHNlbGYuYWRkX2hlYWRlcnMoCiAgICAgICAgICAgIHJlcXVlc3QsCiAgICAgICAgICAgIHN0cmVhbT1zdHJlYW0sCiAgICAgICAgICAgIHRpbWVvdXQ9dGltZW91dCwKICAgICAgICAgICAgdmVyaWZ5PXZlcmlmeSwKICAgICAgICAgICAgY2VydD1jZXJ0LAogICAgICAgICAgICBwcm94aWVzPXByb3hpZXMsCiAgICAgICAgKQoKICAgICAgICBjaHVua2VkID0gbm90IChyZXF1ZXN0LmJvZHkgaXMgTm9uZSBvciAiQ29udGVudC1MZW5ndGgiIGluIHJlcXVlc3QuaGVhZGVycykKCiAgICAgICAgaWYgaXNpbnN0YW5jZSh0aW1lb3V0LCB0dXBsZSk6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGNvbm5lY3QsIHJlYWQgPSB0aW1lb3V0CiAgICAgICAgICAgICAgICB0aW1lb3V0ID0gVGltZW91dFNhdWNlKGNvbm5lY3Q9Y29ubmVjdCwgcmVhZD1yZWFkKQogICAgICAgICAgICBleGNlcHQgVmFsdWVFcnJvcjoKICAgICAgICAgICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoCiAgICAgICAgICAgICAgICAgICAgZiJJbnZhbGlkIHRpbWVvdXQge3RpbWVvdXR9LiBQYXNzIGEgKGNvbm5lY3QsIHJlYWQpIHRpbWVvdXQgdHVwbGUsICIKICAgICAgICAgICAgICAgICAgICBmIm9yIGEgc2luZ2xlIGZsb2F0IHRvIHNldCBib3RoIHRpbWVvdXRzIHRvIHRoZSBzYW1lIHZhbHVlLiIKICAgICAgICAgICAgICAgICkKICAgICAgICBlbGlmIGlzaW5zdGFuY2UodGltZW91dCwgVGltZW91dFNhdWNlKToKICAgICAgICAgICAgcGFzcwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHRpbWVvdXQgPSBUaW1lb3V0U2F1Y2UoY29ubmVjdD10aW1lb3V0LCByZWFkPXRpbWVvdXQpCgogICAgICAgIHRyeToKICAgICAgICAgICAgaWYgbm90IGNodW5rZWQ6CiAgICAgICAgICAgICAgICByZXNwID0gY29ubi51cmxvcGVuKAogICAgICAgICAgICAgICAgICAgIG1ldGhvZD1yZXF1ZXN0Lm1ldGhvZCwKICAgICAgICAgICAgICAgICAgICB1cmw9dXJsLAogICAgICAgICAgICAgICAgICAgIGJvZHk9cmVxdWVzdC5ib2R5LAogICAgICAgICAgICAgICAgICAgIGhlYWRlcnM9cmVxdWVzdC5oZWFkZXJzLAogICAgICAgICAgICAgICAgICAgIHJlZGlyZWN0PUZhbHNlLAogICAgICAgICAgICAgICAgICAgIGFzc2VydF9zYW1lX2hvc3Q9RmFsc2UsCiAgICAgICAgICAgICAgICAgICAgcHJlbG9hZF9jb250ZW50PUZhbHNlLAogICAgICAgICAgICAgICAgICAgIGRlY29kZV9jb250ZW50PUZhbHNlLAogICAgICAgICAgICAgICAgICAgIHJldHJpZXM9c2VsZi5tYXhfcmV0cmllcywKICAgICAgICAgICAgICAgICAgICB0aW1lb3V0PXRpbWVvdXQsCiAgICAgICAgICAgICAgICApCgogICAgICAgICAgICAjIFNlbmQgdGhlIHJlcXVlc3QuCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBpZiBoYXNhdHRyKGNvbm4sICJwcm94eV9wb29sIik6CiAgICAgICAgICAgICAgICAgICAgY29ubiA9IGNvbm4ucHJveHlfcG9vbAoKICAgICAgICAgICAgICAgIGxvd19jb25uID0gY29ubi5fZ2V0X2Nvbm4odGltZW91dD1ERUZBVUxUX1BPT0xfVElNRU9VVCkKCiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgc2tpcF9ob3N0ID0gIkhvc3QiIGluIHJlcXVlc3QuaGVhZGVycwogICAgICAgICAgICAgICAgICAgIGxvd19jb25uLnB1dHJlcXVlc3QoCiAgICAgICAgICAgICAgICAgICAgICAgIHJlcXVlc3QubWV0aG9kLAogICAgICAgICAgICAgICAgICAgICAgICB1cmwsCiAgICAgICAgICAgICAgICAgICAgICAgIHNraXBfYWNjZXB0X2VuY29kaW5nPVRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgIHNraXBfaG9zdD1za2lwX2hvc3QsCiAgICAgICAgICAgICAgICAgICAgKQoKICAgICAgICAgICAgICAgICAgICBmb3IgaGVhZGVyLCB2YWx1ZSBpbiByZXF1ZXN0LmhlYWRlcnMuaXRlbXMoKToKICAgICAgICAgICAgICAgICAgICAgICAgbG93X2Nvbm4ucHV0aGVhZGVyKGhlYWRlciwgdmFsdWUpCgogICAgICAgICAgICAgICAgICAgIGxvd19jb25uLmVuZGhlYWRlcnMoKQoKICAgICAgICAgICAgICAgICAgICBmb3IgaSBpbiByZXF1ZXN0LmJvZHk6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvd19jb25uLnNlbmQoaGV4KGxlbihpKSlbMjpdLmVuY29kZSgidXRmLTgiKSkKICAgICAgICAgICAgICAgICAgICAgICAgbG93X2Nvbm4uc2VuZChiIlxyXG4iKQogICAgICAgICAgICAgICAgICAgICAgICBsb3dfY29ubi5zZW5kKGkpCiAgICAgICAgICAgICAgICAgICAgICAgIGxvd19jb25uLnNlbmQoYiJcclxuIikKICAgICAgICAgICAgICAgICAgICBsb3dfY29ubi5zZW5kKGIiMFxyXG5cclxuIikKCiAgICAgICAgICAgICAgICAgICAgIyBSZWNlaXZlIHRoZSByZXNwb25zZSBmcm9tIHRoZSBzZXJ2ZXIKICAgICAgICAgICAgICAgICAgICByID0gbG93X2Nvbm4uZ2V0cmVzcG9uc2UoKQoKICAgICAgICAgICAgICAgICAgICByZXNwID0gSFRUUFJlc3BvbnNlLmZyb21faHR0cGxpYigKICAgICAgICAgICAgICAgICAgICAgICAgciwKICAgICAgICAgICAgICAgICAgICAgICAgcG9vbD1jb25uLAogICAgICAgICAgICAgICAgICAgICAgICBjb25uZWN0aW9uPWxvd19jb25uLAogICAgICAgICAgICAgICAgICAgICAgICBwcmVsb2FkX2NvbnRlbnQ9RmFsc2UsCiAgICAgICAgICAgICAgICAgICAgICAgIGRlY29kZV9jb250ZW50PUZhbHNlLAogICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICAgICAgIyBJZiB3ZSBoaXQgYW55IHByb2JsZW1zIGhlcmUsIGNsZWFuIHVwIHRoZSBjb25uZWN0aW9uLgogICAgICAgICAgICAgICAgICAgICMgVGhlbiwgcmFpc2Ugc28gdGhhdCB3ZSBjYW4gaGFuZGxlIHRoZSBhY3R1YWwgZXhjZXB0aW9uLgogICAgICAgICAgICAgICAgICAgIGxvd19jb25uLmNsb3NlKCkKICAgICAgICAgICAgICAgICAgICByYWlzZQoKICAgICAgICBleGNlcHQgKFByb3RvY29sRXJyb3IsIE9TRXJyb3IpIGFzIGVycjoKICAgICAgICAgICAgcmFpc2UgQ29ubmVjdGlvbkVycm9yKGVyciwgcmVxdWVzdD1yZXF1ZXN0KQoKICAgICAgICBleGNlcHQgTWF4UmV0cnlFcnJvciBhcyBlOgogICAgICAgICAgICBpZiBpc2luc3RhbmNlKGUucmVhc29uLCBDb25uZWN0VGltZW91dEVycm9yKToKICAgICAgICAgICAgICAgICMgVE9ETzogUmVtb3ZlIHRoaXMgaW4gMy4wLjA6IHNlZSAjMjgxMQogICAgICAgICAgICAgICAgaWYgbm90IGlzaW5zdGFuY2UoZS5yZWFzb24sIE5ld0Nvbm5lY3Rpb25FcnJvcik6CiAgICAgICAgICAgICAgICAgICAgcmFpc2UgQ29ubmVjdFRpbWVvdXQoZSwgcmVxdWVzdD1yZXF1ZXN0KQoKICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShlLnJlYXNvbiwgUmVzcG9uc2VFcnJvcik6CiAgICAgICAgICAgICAgICByYWlzZSBSZXRyeUVycm9yKGUsIHJlcXVlc3Q9cmVxdWVzdCkKCiAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UoZS5yZWFzb24sIF9Qcm94eUVycm9yKToKICAgICAgICAgICAgICAgIHJhaXNlIFByb3h5RXJyb3IoZSwgcmVxdWVzdD1yZXF1ZXN0KQoKICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShlLnJlYXNvbiwgX1NTTEVycm9yKToKICAgICAgICAgICAgICAgICMgVGhpcyBicmFuY2ggaXMgZm9yIHVybGxpYjMgdjEuMjIgYW5kIGxhdGVyLgogICAgICAgICAgICAgICAgcmFpc2UgU1NMRXJyb3IoZSwgcmVxdWVzdD1yZXF1ZXN0KQoKICAgICAgICAgICAgcmFpc2UgQ29ubmVjdGlvbkVycm9yKGUsIHJlcXVlc3Q9cmVxdWVzdCkKCiAgICAgICAgZXhjZXB0IENsb3NlZFBvb2xFcnJvciBhcyBlOgogICAgICAgICAgICByYWlzZSBDb25uZWN0aW9uRXJyb3IoZSwgcmVxdWVzdD1yZXF1ZXN0KQoKICAgICAgICBleGNlcHQgX1Byb3h5RXJyb3IgYXMgZToKICAgICAgICAgICAgcmFpc2UgUHJveHlFcnJvcihlKQoKICAgICAgICBleGNlcHQgKF9TU0xFcnJvciwgX0hUVFBFcnJvcikgYXMgZToKICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShlLCBfU1NMRXJyb3IpOgogICAgICAgICAgICAgICAgIyBUaGlzIGJyYW5jaCBpcyBmb3IgdXJsbGliMyB2ZXJzaW9ucyBlYXJsaWVyIHRoYW4gdjEuMjIKICAgICAgICAgICAgICAgIHJhaXNlIFNTTEVycm9yKGUsIHJlcXVlc3Q9cmVxdWVzdCkKICAgICAgICAgICAgZWxpZiBpc2luc3RhbmNlKGUsIFJlYWRUaW1lb3V0RXJyb3IpOgogICAgICAgICAgICAgICAgcmFpc2UgUmVhZFRpbWVvdXQoZSwgcmVxdWVzdD1yZXF1ZXN0KQogICAgICAgICAgICBlbGlmIGlzaW5zdGFuY2UoZSwgX0ludmFsaWRIZWFkZXIpOgogICAgICAgICAgICAgICAgcmFpc2UgSW52YWxpZEhlYWRlcihlLCByZXF1ZXN0PXJlcXVlc3QpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICByYWlzZQoKICAgICAgICByZXR1cm4gc2VsZi5idWlsZF9yZXNwb25zZShyZXF1ZXN0LCByZXNwKQo=
