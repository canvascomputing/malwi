statistics:
  total_files: 1
  skipped_files: 0.0
  processed_objects: 1
  malicious_objects: 0
details:
- path: .repo_cache/malicious_repos/pypi_malregistry/awscl/1.27.67/awscl-1.27.67/awscl-1.27.67/awscli/testutils.py
  contents:
  - name: CapturedRenderer.__init__
    score: 0.0
    code: |-
      def __init__(self):
              self.rendered_contents = ''
    tokens: resume load_const load_fast self store_attr STRING_LEN_S_ENT_HIGH return_const None
    hash: 0c1f6a4f60069c86fc4ee5ec66b673d331184603b0e00e6c32efcf69d8e77e19
sources:
  .repo_cache/malicious_repos/pypi_malregistry/awscl/1.27.67/awscl-1.27.67/awscl-1.27.67/awscli/testutils.py: IyBDb3B5cmlnaHQgMjAxMi0yMDE0IEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuCiMKIyBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgIkxpY2Vuc2UiKS4gWW91CiMgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuIEEgY29weSBvZgojIHRoZSBMaWNlbnNlIGlzIGxvY2F0ZWQgYXQKIwojICAgICBodHRwOi8vYXdzLmFtYXpvbi5jb20vYXBhY2hlMi4wLwojCiMgb3IgaW4gdGhlICJsaWNlbnNlIiBmaWxlIGFjY29tcGFueWluZyB0aGlzIGZpbGUuIFRoaXMgZmlsZSBpcwojIGRpc3RyaWJ1dGVkIG9uIGFuICJBUyBJUyIgQkFTSVMsIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GCiMgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljCiMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZCBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4KIiIiVGVzdCB1dGlsaXRpZXMgZm9yIHRoZSBBV1MgQ0xJLgoKVGhpcyBtb2R1bGUgaW5jbHVkZXMgdmFyaW91cyBjbGFzc2VzL2Z1bmN0aW9ucyB0aGF0IGhlbHAgaW4gd3JpdGluZwpDTEkgdW5pdC9pbnRlZ3JhdGlvbiB0ZXN0cy4gIFRoaXMgbW9kdWxlIHNob3VsZCBub3QgYmUgaW1wb3J0ZWQgYnkKYW55IG1vZHVsZSAqKmV4Y2VwdCoqIGZvciB0ZXN0IGNvZGUuICBUaGlzIGlzIGluY2x1ZGVkIGluIHRoZSBDTEkKcGFja2FnZSBzbyB0aGF0IGNvZGUgdGhhdCBpcyBub3QgcGFydCBvZiB0aGUgQ0xJIGNhbiBzdGlsbCB0YWtlCmFkdmFudGFnZSBvZiBhbGwgdGhlIHRlc3RpbmcgdXRpbGl0aWVzIHdlIHByb3ZpZGUuCgoiIiIKaW1wb3J0IG9zCmltcG9ydCBzeXMKaW1wb3J0IGNvcHkKaW1wb3J0IHNodXRpbAppbXBvcnQgdGltZQppbXBvcnQganNvbgppbXBvcnQgbG9nZ2luZwppbXBvcnQgdGVtcGZpbGUKaW1wb3J0IHBsYXRmb3JtCmltcG9ydCBjb250ZXh0bGliCmltcG9ydCBzdHJpbmcKaW1wb3J0IGJpbmFzY2lpCmZyb20gcHByaW50IGltcG9ydCBwZm9ybWF0CmZyb20gc3VicHJvY2VzcyBpbXBvcnQgUG9wZW4sIFBJUEUKZnJvbSB1bml0dGVzdCBpbXBvcnQgbW9jawoKZnJvbSBhd3NjbGkuY29tcGF0IGltcG9ydCBTdHJpbmdJTwoKCmZyb20gYXdzY2xpLmNvbXBhdCBpbXBvcnQgc2l4CmZyb20gYm90b2NvcmUuc2Vzc2lvbiBpbXBvcnQgU2Vzc2lvbgpmcm9tIGJvdG9jb3JlLmV4Y2VwdGlvbnMgaW1wb3J0IENsaWVudEVycm9yCmZyb20gYm90b2NvcmUuZXhjZXB0aW9ucyBpbXBvcnQgV2FpdGVyRXJyb3IKaW1wb3J0IGJvdG9jb3JlLmxvYWRlcnMKZnJvbSBib3RvY29yZS5hd3NyZXF1ZXN0IGltcG9ydCBBV1NSZXNwb25zZQoKaW1wb3J0IGF3c2NsaS5jbGlkcml2ZXIKZnJvbSBhd3NjbGkucGx1Z2luIGltcG9ydCBsb2FkX3BsdWdpbnMKZnJvbSBhd3NjbGkuY2xpZHJpdmVyIGltcG9ydCBDTElEcml2ZXIKZnJvbSBhd3NjbGkgaW1wb3J0IEVudmlyb25tZW50VmFyaWFibGVzCgoKaW1wb3J0IHVuaXR0ZXN0CgoKIyBJbiBweXRob24gMywgb3JkZXIgbWF0dGVycyB3aGVuIGNhbGxpbmcgYXNzZXJ0RXF1YWwgdG8KIyBjb21wYXJlIGxpc3RzIGFuZCBkaWN0aW9uYXJpZXMgd2l0aCBsaXN0cy4gVGhlcmVmb3JlLAojIGFzc2VydEl0ZW1zRXF1YWwgbmVlZHMgdG8gYmUgdXNlZCBidXQgaXQgaXMgcmVuYW1lZCB0bwojIGFzc2VydENvdW50RXF1YWwgaW4gcHl0aG9uIDMuCmlmIHNpeC5QWTI6CiAgICB1bml0dGVzdC5UZXN0Q2FzZS5hc3NlcnRDb3VudEVxdWFsID0gdW5pdHRlc3QuVGVzdENhc2UuYXNzZXJ0SXRlbXNFcXVhbAoKCl9MT0FERVIgPSBib3RvY29yZS5sb2FkZXJzLkxvYWRlcigpCklOVEVHX0xPRyA9IGxvZ2dpbmcuZ2V0TG9nZ2VyKCdhd3NjbGkudGVzdHMuaW50ZWdyYXRpb24nKQpBV1NfQ01EID0gTm9uZQoKCmRlZiBza2lwX2lmX3dpbmRvd3MocmVhc29uKToKICAgICIiIkRlY29yYXRvciB0byBza2lwIHRlc3RzIHRoYXQgc2hvdWxkIG5vdCBiZSBydW4gb24gd2luZG93cy4KCiAgICBFeGFtcGxlIHVzYWdlOgoKICAgICAgICBAc2tpcF9pZl93aW5kb3dzKCJOb3QgdmFsaWQiKQogICAgICAgIGRlZiB0ZXN0X3NvbWVfbm9uX3dpbmRvd3Nfc3R1ZmYoc2VsZik6CiAgICAgICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoLi4uKQoKICAgICIiIgogICAgZGVmIGRlY29yYXRvcihmdW5jKToKICAgICAgICByZXR1cm4gdW5pdHRlc3Quc2tpcElmKAogICAgICAgICAgICBwbGF0Zm9ybS5zeXN0ZW0oKSBub3QgaW4gWydEYXJ3aW4nLCAnTGludXgnXSwgcmVhc29uKShmdW5jKQogICAgcmV0dXJuIGRlY29yYXRvcgoKCmRlZiBjcmVhdGVfY2xpZHJpdmVyKCk6CiAgICBkcml2ZXIgPSBhd3NjbGkuY2xpZHJpdmVyLmNyZWF0ZV9jbGlkcml2ZXIoKQogICAgc2Vzc2lvbiA9IGRyaXZlci5zZXNzaW9uCiAgICBkYXRhX3BhdGggPSBzZXNzaW9uLmdldF9jb25maWdfdmFyaWFibGUoJ2RhdGFfcGF0aCcpLnNwbGl0KG9zLnBhdGhzZXApCiAgICBpZiBub3QgZGF0YV9wYXRoOgogICAgICAgIGRhdGFfcGF0aCA9IFtdCiAgICBfTE9BREVSLnNlYXJjaF9wYXRocy5leHRlbmQoZGF0YV9wYXRoKQogICAgc2Vzc2lvbi5yZWdpc3Rlcl9jb21wb25lbnQoJ2RhdGFfbG9hZGVyJywgX0xPQURFUikKICAgIHJldHVybiBkcml2ZXIKCgpkZWYgZ2V0X2F3c19jbWQoKToKICAgIGdsb2JhbCBBV1NfQ01ECiAgICBpbXBvcnQgYXdzY2xpCiAgICBpZiBBV1NfQ01EIGlzIE5vbmU6CiAgICAgICAgIyBUcnkgPHJlcG8+L2Jpbi9hd3MKICAgICAgICByZXBvX3Jvb3QgPSBvcy5wYXRoLmRpcm5hbWUob3MucGF0aC5hYnNwYXRoKGF3c2NsaS5fX2ZpbGVfXykpCiAgICAgICAgYXdzX2NtZCA9IG9zLnBhdGguam9pbihyZXBvX3Jvb3QsICdiaW4nLCAnYXdzJykKICAgICAgICBpZiBub3Qgb3MucGF0aC5pc2ZpbGUoYXdzX2NtZCk6CiAgICAgICAgICAgIGF3c19jbWQgPSBfc2VhcmNoX3BhdGhfZm9yX2NtZCgnYXdzJykKICAgICAgICAgICAgaWYgYXdzX2NtZCBpcyBOb25lOgogICAgICAgICAgICAgICAgcmFpc2UgVmFsdWVFcnJvcignQ291bGQgbm90IGZpbmQgImF3cyIgZXhlY3V0YWJsZS4gIEVpdGhlciAnCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdtYWtlIHN1cmUgaXQgaXMgb24geW91ciBQQVRILCBvciB5b3UgY2FuICcKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2V4cGxpY2l0bHkgc2V0IHRoaXMgdmFsdWUgdXNpbmcgJwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnInNldF9hd3NfY21kKCkiJykKICAgICAgICBBV1NfQ01EID0gYXdzX2NtZAogICAgcmV0dXJuIEFXU19DTUQKCgpkZWYgX3NlYXJjaF9wYXRoX2Zvcl9jbWQoY21kX25hbWUpOgogICAgZm9yIHBhdGggaW4gb3MuZW52aXJvbi5nZXQoJ1BBVEgnLCAnJykuc3BsaXQob3MucGF0aHNlcCk6CiAgICAgICAgZnVsbF9jbWRfcGF0aCA9IG9zLnBhdGguam9pbihwYXRoLCBjbWRfbmFtZSkKICAgICAgICBpZiBvcy5wYXRoLmlzZmlsZShmdWxsX2NtZF9wYXRoKToKICAgICAgICAgICAgcmV0dXJuIGZ1bGxfY21kX3BhdGgKICAgIHJldHVybiBOb25lCgoKZGVmIHNldF9hd3NfY21kKGF3c19jbWQpOgogICAgZ2xvYmFsIEFXU19DTUQKICAgIEFXU19DTUQgPSBhd3NfY21kCgoKQGNvbnRleHRsaWIuY29udGV4dG1hbmFnZXIKZGVmIHRlbXBvcmFyeV9maWxlKG1vZGUpOgogICAgIiIiVGhpcyBpcyBhIGNyb3NzIHBsYXRmb3JtIHRlbXBvcmFyeSBmaWxlIGNyZWF0aW9uLgoKICAgIHRlbXBmaWxlLk5hbWVkVGVtcG9yYXJ5IGZpbGUgb24gd2luZG93cyBjcmVhdGVzIGEgc2VjdXJlIHRlbXAgZmlsZQogICAgdGhhdCBjYW4ndCBiZSByZWFkIGJ5IG90aGVyIHByb2Nlc3NlcyBhbmQgY2FuJ3QgYmUgb3BlbmVkIGEgc2Vjb25kIHRpbWUuCgogICAgRm9yIHRlc3RzLCB3ZSBnZW5lcmFsbHkgKndhbnQqIHRoZW0gdG8gYmUgcmVhZCBtdWx0aXBsZSB0aW1lcy4KICAgIFRoZSB0ZXN0IGZpeHR1cmUgd3JpdGVzIHRoZSB0ZW1wIGZpbGUgY29udGVudHMsIHRoZSB0ZXN0IHJlYWRzIHRoZQogICAgdGVtcCBmaWxlLgoKICAgICIiIgogICAgdGVtcG9yYXJ5X2RpcmVjdG9yeSA9IHRlbXBmaWxlLm1rZHRlbXAoKQogICAgYmFzZW5hbWUgPSAndG1wZmlsZS0lcycgJSBzdHIocmFuZG9tX2NoYXJzKDgpKQogICAgZnVsbF9maWxlbmFtZSA9IG9zLnBhdGguam9pbih0ZW1wb3JhcnlfZGlyZWN0b3J5LCBiYXNlbmFtZSkKICAgIG9wZW4oZnVsbF9maWxlbmFtZSwgJ3cnKS5jbG9zZSgpCiAgICB0cnk6CiAgICAgICAgd2l0aCBvcGVuKGZ1bGxfZmlsZW5hbWUsIG1vZGUpIGFzIGY6CiAgICAgICAgICAgIHlpZWxkIGYKICAgIGZpbmFsbHk6CiAgICAgICAgc2h1dGlsLnJtdHJlZSh0ZW1wb3JhcnlfZGlyZWN0b3J5KQoKCmRlZiBjcmVhdGVfYnVja2V0KHNlc3Npb24sIG5hbWU9Tm9uZSwgcmVnaW9uPU5vbmUpOgogICAgIiIiCiAgICBDcmVhdGVzIGEgYnVja2V0CiAgICA6cmV0dXJuczogdGhlIG5hbWUgb2YgdGhlIGJ1Y2tldCBjcmVhdGVkCiAgICAiIiIKICAgIGlmIG5vdCByZWdpb246CiAgICAgICAgcmVnaW9uID0gJ3VzLXdlc3QtMicKICAgIGNsaWVudCA9IHNlc3Npb24uY3JlYXRlX2NsaWVudCgnczMnLCByZWdpb25fbmFtZT1yZWdpb24pCiAgICBpZiBuYW1lOgogICAgICAgIGJ1Y2tldF9uYW1lID0gbmFtZQogICAgZWxzZToKICAgICAgICBidWNrZXRfbmFtZSA9IHJhbmRvbV9idWNrZXRfbmFtZSgpCiAgICBwYXJhbXMgPSB7J0J1Y2tldCc6IGJ1Y2tldF9uYW1lfQogICAgaWYgcmVnaW9uICE9ICd1cy1lYXN0LTEnOgogICAgICAgIHBhcmFtc1snQ3JlYXRlQnVja2V0Q29uZmlndXJhdGlvbiddID0geydMb2NhdGlvbkNvbnN0cmFpbnQnOiByZWdpb259CiAgICB0cnk6CiAgICAgICAgY2xpZW50LmNyZWF0ZV9idWNrZXQoKipwYXJhbXMpCiAgICBleGNlcHQgQ2xpZW50RXJyb3IgYXMgZToKICAgICAgICBpZiBlLnJlc3BvbnNlWydFcnJvciddLmdldCgnQ29kZScpID09ICdCdWNrZXRBbHJlYWR5T3duZWRCeVlvdSc6CiAgICAgICAgICAgICMgVGhpcyBjYW4gaGFwcGVuIGluIHRoZSByZXRyaWVkIHJlcXVlc3QsIHdoZW4gdGhlIGZpcnN0IG9uZQogICAgICAgICAgICAjIHN1Y2NlZWRlZCBvbiBTMyBidXQgc29tZWhvdyB0aGUgcmVzcG9uc2UgbmV2ZXIgY29tZXMgYmFjay4KICAgICAgICAgICAgIyBXZSBzdGlsbCBnb3QgYSBidWNrZXQgcmVhZHkgZm9yIHRlc3QgYW55d2F5LgogICAgICAgICAgICBwYXNzCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmFpc2UKICAgIHJldHVybiBidWNrZXRfbmFtZQoKCmRlZiByYW5kb21fY2hhcnMobnVtX2NoYXJzKToKICAgICIiIlJldHVybnMgcmFuZG9tIGhleCBjaGFyYWN0ZXJzLgoKICAgIFVzZWZ1bCBmb3IgY3JlYXRpbmcgcmVzb3VyY2VzIHdpdGggcmFuZG9tIG5hbWVzLgoKICAgICIiIgogICAgcmV0dXJuIGJpbmFzY2lpLmhleGxpZnkob3MudXJhbmRvbShpbnQobnVtX2NoYXJzIC8gMikpKS5kZWNvZGUoJ2FzY2lpJykKCgpkZWYgcmFuZG9tX2J1Y2tldF9uYW1lKHByZWZpeD0nYXdzY2xpLXMzaW50ZWctJywgbnVtX3JhbmRvbT0xNSk6CiAgICAiIiJHZW5lcmF0ZSBhIHJhbmRvbSBTMyBidWNrZXQgbmFtZS4KCiAgICA6cGFyYW0gcHJlZml4OiBBIHByZWZpeCB0byB1c2UgaW4gdGhlIGJ1Y2tldCBuYW1lLiAgVXNlZnVsCiAgICAgICAgZm9yIHRyYWNraW5nIHJlc291cmNlcy4gIFRoaXMgZGVmYXVsdCB2YWx1ZSBtYWtlcyBpdCBlYXN5CiAgICAgICAgdG8gc2VlIHdoaWNoIGJ1Y2tldHMgd2VyZSBjcmVhdGVkIGZyb20gQ0xJIGludGVnIHRlc3RzLgogICAgOnBhcmFtIG51bV9yYW5kb206IE51bWJlciBvZiByYW5kb20gY2hhcnMgdG8gaW5jbHVkZSBpbiB0aGUgYnVja2V0IG5hbWUuCgogICAgOnJldHVybnM6IFRoZSBuYW1lIG9mIGEgcmFuZG9tbHkgZ2VuZXJhdGVkIGJ1Y2tldCBuYW1lIGFzIGEgc3RyaW5nLgoKICAgICIiIgogICAgcmV0dXJuIHByZWZpeCArIHJhbmRvbV9jaGFycyhudW1fcmFuZG9tKQoKCmNsYXNzIEJhc2VDTElEcml2ZXJUZXN0KHVuaXR0ZXN0LlRlc3RDYXNlKToKICAgICIiIkJhc2UgdW5pdHRlc3QgdGhhdCB1c2UgY2xpZHJpdmVyLgoKICAgIFRoaXMgd2lsbCBsb2FkIGFsbCB0aGUgZGVmYXVsdCBwbHVnaW5zIGFzIHdlbGwgc28gaXQKICAgIHdpbGwgc2ltdWxhdGUgdGhlIGJlaGF2aW9yIHRoZSB1c2VyIHdpbGwgc2VlLgogICAgIiIiCiAgICBkZWYgc2V0VXAoc2VsZik6CiAgICAgICAgc2VsZi5lbnZpcm9uID0gewogICAgICAgICAgICAnQVdTX0RBVEFfUEFUSCc6IG9zLmVudmlyb25bJ0FXU19EQVRBX1BBVEgnXSwKICAgICAgICAgICAgJ0FXU19ERUZBVUxUX1JFR0lPTic6ICd1cy1lYXN0LTEnLAogICAgICAgICAgICAnQVdTX0FDQ0VTU19LRVlfSUQnOiAnYWNjZXNzX2tleScsCiAgICAgICAgICAgICdBV1NfU0VDUkVUX0FDQ0VTU19LRVknOiAnc2VjcmV0X2tleScsCiAgICAgICAgICAgICdBV1NfQ09ORklHX0ZJTEUnOiAnJywKICAgICAgICB9CiAgICAgICAgc2VsZi5lbnZpcm9uX3BhdGNoID0gbW9jay5wYXRjaCgnb3MuZW52aXJvbicsIHNlbGYuZW52aXJvbikKICAgICAgICBzZWxmLmVudmlyb25fcGF0Y2guc3RhcnQoKQogICAgICAgIHNlbGYuZHJpdmVyID0gY3JlYXRlX2NsaWRyaXZlcigpCiAgICAgICAgc2VsZi5zZXNzaW9uID0gc2VsZi5kcml2ZXIuc2Vzc2lvbgoKICAgIGRlZiB0ZWFyRG93bihzZWxmKToKICAgICAgICBzZWxmLmVudmlyb25fcGF0Y2guc3RvcCgpCgoKY2xhc3MgQmFzZUFXU0hlbHBPdXRwdXRUZXN0KEJhc2VDTElEcml2ZXJUZXN0KToKICAgIGRlZiBzZXRVcChzZWxmKToKICAgICAgICBzdXBlcihCYXNlQVdTSGVscE91dHB1dFRlc3QsIHNlbGYpLnNldFVwKCkKICAgICAgICBzZWxmLnJlbmRlcmVyX3BhdGNoID0gbW9jay5wYXRjaCgnYXdzY2xpLmhlbHAuZ2V0X3JlbmRlcmVyJykKICAgICAgICBzZWxmLnJlbmRlcmVyX21vY2sgPSBzZWxmLnJlbmRlcmVyX3BhdGNoLnN0YXJ0KCkKICAgICAgICBzZWxmLnJlbmRlcmVyID0gQ2FwdHVyZWRSZW5kZXJlcigpCiAgICAgICAgc2VsZi5yZW5kZXJlcl9tb2NrLnJldHVybl92YWx1ZSA9IHNlbGYucmVuZGVyZXIKCiAgICBkZWYgdGVhckRvd24oc2VsZik6CiAgICAgICAgc3VwZXIoQmFzZUFXU0hlbHBPdXRwdXRUZXN0LCBzZWxmKS50ZWFyRG93bigpCiAgICAgICAgc2VsZi5yZW5kZXJlcl9wYXRjaC5zdG9wKCkKCiAgICBkZWYgYXNzZXJ0X2NvbnRhaW5zKHNlbGYsIGNvbnRhaW5zKToKICAgICAgICBpZiBjb250YWlucyBub3QgaW4gc2VsZi5yZW5kZXJlci5yZW5kZXJlZF9jb250ZW50czoKICAgICAgICAgICAgc2VsZi5mYWlsKCJUaGUgZXhwZWN0ZWQgY29udGVudHM6XG4lc1xud2VyZSBub3QgaW4gdGhlICIKICAgICAgICAgICAgICAgICAgICAgICJhY3R1YWwgcmVuZGVyZWQgY29udGVudHM6XG4lcyIgJSAoCiAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGFpbnMsIHNlbGYucmVuZGVyZXIucmVuZGVyZWRfY29udGVudHMpKQoKICAgIGRlZiBhc3NlcnRfY29udGFpbnNfd2l0aF9jb3VudChzZWxmLCBjb250YWlucywgY291bnQpOgogICAgICAgIHJfY291bnQgPSBzZWxmLnJlbmRlcmVyLnJlbmRlcmVkX2NvbnRlbnRzLmNvdW50KGNvbnRhaW5zKQogICAgICAgIGlmIHJfY291bnQgIT0gY291bnQ6CiAgICAgICAgICAgIHNlbGYuZmFpbCgiVGhlIGV4cGVjdGVkIGNvbnRlbnRzOlxuJXNcbiwgd2l0aCB0aGUgIgogICAgICAgICAgICAgICAgICAgICAgImNvdW50OlxuJWRcbndlcmUgbm90IGluIHRoZSBhY3R1YWwgcmVuZGVyZWQgIgogICAgICAgICAgICAgICAgICAgICAgIiBjb250ZW50czpcbiVzXG53aXRoIGNvdW50OlxuJWQiICUgKAogICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRhaW5zLCBjb3VudCwgc2VsZi5yZW5kZXJlci5yZW5kZXJlZF9jb250ZW50cywgcl9jb3VudCkpCgogICAgZGVmIGFzc2VydF9ub3RfY29udGFpbnMoc2VsZiwgY29udGVudHMpOgogICAgICAgIGlmIGNvbnRlbnRzIGluIHNlbGYucmVuZGVyZXIucmVuZGVyZWRfY29udGVudHM6CiAgICAgICAgICAgIHNlbGYuZmFpbCgiVGhlIGNvbnRlbnRzOlxuJXNcbndlcmUgbm90IHN1cHBvc2UgdG8gYmUgaW4gdGhlICIKICAgICAgICAgICAgICAgICAgICAgICJhY3R1YWwgcmVuZGVyZWQgY29udGVudHM6XG4lcyIgJSAoCiAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGVudHMsIHNlbGYucmVuZGVyZXIucmVuZGVyZWRfY29udGVudHMpKQoKICAgIGRlZiBhc3NlcnRfdGV4dF9vcmRlcihzZWxmLCAqYXJncywgKiprd2FyZ3MpOgogICAgICAgICMgRmlyc3Qgd2UgbmVlZCB0byBmaW5kIHdoZXJlIHRoZSBTWU5PUFNJUyBzZWN0aW9uIHN0YXJ0cy4KICAgICAgICBzdGFydGluZ19mcm9tID0ga3dhcmdzLnBvcCgnc3RhcnRpbmdfZnJvbScpCiAgICAgICAgYXJncyA9IGxpc3QoYXJncykKICAgICAgICBjb250ZW50cyA9IHNlbGYucmVuZGVyZXIucmVuZGVyZWRfY29udGVudHMKICAgICAgICBzZWxmLmFzc2VydEluKHN0YXJ0aW5nX2Zyb20sIGNvbnRlbnRzKQogICAgICAgIHN0YXJ0X2luZGV4ID0gY29udGVudHMuZmluZChzdGFydGluZ19mcm9tKQogICAgICAgIGFyZ19pbmRpY2VzID0gW2NvbnRlbnRzLmZpbmQoYXJnLCBzdGFydF9pbmRleCkgZm9yIGFyZyBpbiBhcmdzXQogICAgICAgIHByZXZpb3VzID0gYXJnX2luZGljZXNbMF0KICAgICAgICBmb3IgaSwgaW5kZXggaW4gZW51bWVyYXRlKGFyZ19pbmRpY2VzWzE6XSwgMSk6CiAgICAgICAgICAgIGlmIGluZGV4ID09IC0xOgogICAgICAgICAgICAgICAgc2VsZi5mYWlsKCdUaGUgc3RyaW5nICVyIHdhcyBub3QgZm91bmQgaW4gdGhlIGNvbnRlbnRzOiAlcycKICAgICAgICAgICAgICAgICAgICAgICAgICAlIChhcmdzW2luZGV4XSwgY29udGVudHMpKQogICAgICAgICAgICBpZiBpbmRleCA8IHByZXZpb3VzOgogICAgICAgICAgICAgICAgc2VsZi5mYWlsKCdUaGUgc3RyaW5nICVyIGNhbWUgYmVmb3JlICVyLCBidXQgd2FzIHN1cHBvc2UgdG8gY29tZSAnCiAgICAgICAgICAgICAgICAgICAgICAgICAgJ2FmdGVyIGl0LlxuJXMnICUgKGFyZ3NbaV0sIGFyZ3NbaSAtIDFdLCBjb250ZW50cykpCiAgICAgICAgICAgIHByZXZpb3VzID0gaW5kZXgKCgpjbGFzcyBDYXB0dXJlZFJlbmRlcmVyKG9iamVjdCk6CiAgICBkZWYgX19pbml0X18oc2VsZik6CiAgICAgICAgc2VsZi5yZW5kZXJlZF9jb250ZW50cyA9ICcnCgogICAgZGVmIHJlbmRlcihzZWxmLCBjb250ZW50cyk6CiAgICAgICAgc2VsZi5yZW5kZXJlZF9jb250ZW50cyA9IGNvbnRlbnRzLmRlY29kZSgndXRmLTgnKQoKCmNsYXNzIENhcHR1cmVkT3V0cHV0KG9iamVjdCk6CiAgICBkZWYgX19pbml0X18oc2VsZiwgc3Rkb3V0LCBzdGRlcnIpOgogICAgICAgIHNlbGYuc3Rkb3V0ID0gc3Rkb3V0CiAgICAgICAgc2VsZi5zdGRlcnIgPSBzdGRlcnIKCgpAY29udGV4dGxpYi5jb250ZXh0bWFuYWdlcgpkZWYgY2FwdHVyZV9vdXRwdXQoKToKICAgIHN0ZGVyciA9IHNpeC5TdHJpbmdJTygpCiAgICBzdGRvdXQgPSBzaXguU3RyaW5nSU8oKQogICAgd2l0aCBtb2NrLnBhdGNoKCdzeXMuc3RkZXJyJywgc3RkZXJyKToKICAgICAgICB3aXRoIG1vY2sucGF0Y2goJ3N5cy5zdGRvdXQnLCBzdGRvdXQpOgogICAgICAgICAgICB5aWVsZCBDYXB0dXJlZE91dHB1dChzdGRvdXQsIHN0ZGVycikKCgpAY29udGV4dGxpYi5jb250ZXh0bWFuYWdlcgpkZWYgY2FwdHVyZV9pbnB1dChpbnB1dF9ieXRlcz1iJycpOgogICAgaW5wdXRfZGF0YSA9IHNpeC5CeXRlc0lPKGlucHV0X2J5dGVzKQogICAgaWYgc2l4LlBZMzoKICAgICAgICBtb2NrX29iamVjdCA9IG1vY2suTW9jaygpCiAgICAgICAgbW9ja19vYmplY3QuYnVmZmVyID0gaW5wdXRfZGF0YQogICAgZWxzZToKICAgICAgICBtb2NrX29iamVjdCA9IGlucHV0X2RhdGEKCiAgICB3aXRoIG1vY2sucGF0Y2goJ3N5cy5zdGRpbicsIG1vY2tfb2JqZWN0KToKICAgICAgICB5aWVsZCBpbnB1dF9kYXRhCgoKY2xhc3MgQmFzZUFXU0NvbW1hbmRQYXJhbXNUZXN0KHVuaXR0ZXN0LlRlc3RDYXNlKToKICAgIG1heERpZmYgPSBOb25lCgogICAgZGVmIHNldFVwKHNlbGYpOgogICAgICAgIHNlbGYubGFzdF9wYXJhbXMgPSB7fQogICAgICAgIHNlbGYubGFzdF9rd2FyZ3MgPSBOb25lCiAgICAgICAgIyBhd3NjbGkvX19pbml0X18ucHkgaW5qZWN0cyBBV1NfREFUQV9QQVRIIGF0IGltcG9ydCB0aW1lCiAgICAgICAgIyBzbyB0aGF0IHdlIGNhbiBmaW5kIGNsaS5qc29uLiAgVGhpcyBtaWdodCBiZSBmaXhlZCBpbiB0aGUKICAgICAgICAjIGZ1dHVyZSwgYnV0IGZvciBub3cgd2UganVzdCBncmFiIHRoYXQgdmFsdWUgb3V0IG9mIHRoZSByZWFsCiAgICAgICAgIyBvcy5lbnZpcm9uIHNvIHRoZSBwYXRjaGVkIG9zLmVudmlyb24gaGFzIHRoaXMgZGF0YSBhbmQKICAgICAgICAjIHRoZSBDTEkgd29ya3MuCiAgICAgICAgc2VsZi5lbnZpcm9uID0gewogICAgICAgICAgICAnQVdTX0RBVEFfUEFUSCc6IG9zLmVudmlyb25bJ0FXU19EQVRBX1BBVEgnXSwKICAgICAgICAgICAgJ0FXU19ERUZBVUxUX1JFR0lPTic6ICd1cy1lYXN0LTEnLAogICAgICAgICAgICAnQVdTX0FDQ0VTU19LRVlfSUQnOiAnYWNjZXNzX2tleScsCiAgICAgICAgICAgICdBV1NfU0VDUkVUX0FDQ0VTU19LRVknOiAnc2VjcmV0X2tleScsCiAgICAgICAgICAgICdBV1NfQ09ORklHX0ZJTEUnOiAnJywKICAgICAgICAgICAgJ0FXU19TSEFSRURfQ1JFREVOVElBTFNfRklMRSc6ICcnLAogICAgICAgIH0KICAgICAgICBzZWxmLmVudmlyb25fcGF0Y2ggPSBtb2NrLnBhdGNoKCdvcy5lbnZpcm9uJywgc2VsZi5lbnZpcm9uKQogICAgICAgIHNlbGYuZW52aXJvbl9wYXRjaC5zdGFydCgpCiAgICAgICAgc2VsZi5odHRwX3Jlc3BvbnNlID0gQVdTUmVzcG9uc2UoTm9uZSwgMjAwLCB7fSwgTm9uZSkKICAgICAgICBzZWxmLnBhcnNlZF9yZXNwb25zZSA9IHt9CiAgICAgICAgc2VsZi5tYWtlX3JlcXVlc3RfcGF0Y2ggPSBtb2NrLnBhdGNoKCdib3RvY29yZS5lbmRwb2ludC5FbmRwb2ludC5tYWtlX3JlcXVlc3QnKQogICAgICAgIHNlbGYubWFrZV9yZXF1ZXN0X2lzX3BhdGNoZWQgPSBGYWxzZQogICAgICAgIHNlbGYub3BlcmF0aW9uc19jYWxsZWQgPSBbXQogICAgICAgIHNlbGYucGFyc2VkX3Jlc3BvbnNlcyA9IE5vbmUKICAgICAgICBzZWxmLmRyaXZlciA9IGNyZWF0ZV9jbGlkcml2ZXIoKQoKICAgIGRlZiB0ZWFyRG93bihzZWxmKToKICAgICAgICAjIFRoaXMgY2xlYXJzIGFsbCB0aGUgcHJldmlvdXMgcmVnaXN0cmF0aW9ucy4KICAgICAgICBzZWxmLmVudmlyb25fcGF0Y2guc3RvcCgpCiAgICAgICAgaWYgc2VsZi5tYWtlX3JlcXVlc3RfaXNfcGF0Y2hlZDoKICAgICAgICAgICAgc2VsZi5tYWtlX3JlcXVlc3RfcGF0Y2guc3RvcCgpCiAgICAgICAgICAgIHNlbGYubWFrZV9yZXF1ZXN0X2lzX3BhdGNoZWQgPSBGYWxzZQoKICAgIGRlZiBiZWZvcmVfY2FsbChzZWxmLCBwYXJhbXMsICoqa3dhcmdzKToKICAgICAgICBzZWxmLl9zdG9yZV9wYXJhbXMocGFyYW1zKQoKICAgIGRlZiBfc3RvcmVfcGFyYW1zKHNlbGYsIHBhcmFtcyk6CiAgICAgICAgc2VsZi5sYXN0X3JlcXVlc3RfZGljdCA9IHBhcmFtcwogICAgICAgIHNlbGYubGFzdF9wYXJhbXMgPSBwYXJhbXNbJ2JvZHknXQoKICAgIGRlZiBwYXRjaF9tYWtlX3JlcXVlc3Qoc2VsZik6CiAgICAgICAgIyBJZiB5b3UgZG8gbm90IHN0b3AgYSBwcmV2aW91c2x5IHN0YXJ0ZWQgcGF0Y2gsCiAgICAgICAgIyBpdCBjYW4gbmV2ZXIgYmUgc3RvcHBlZCBpZiB5b3UgY2FsbCBzdGFydCgpIGFnYWluIG9uIHRoZSBzYW1lCiAgICAgICAgIyBwYXRjaCBhZ2Fpbi4uLgogICAgICAgICMgU28gc3RvcCB0aGUgY3VycmVudCBwYXRjaCBiZWZvcmUgY2FsbGluZyBzdGFydCgpIG9uIGl0IGFnYWluLgogICAgICAgIGlmIHNlbGYubWFrZV9yZXF1ZXN0X2lzX3BhdGNoZWQ6CiAgICAgICAgICAgIHNlbGYubWFrZV9yZXF1ZXN0X3BhdGNoLnN0b3AoKQogICAgICAgICAgICBzZWxmLm1ha2VfcmVxdWVzdF9pc19wYXRjaGVkID0gRmFsc2UKICAgICAgICBtYWtlX3JlcXVlc3RfcGF0Y2ggPSBzZWxmLm1ha2VfcmVxdWVzdF9wYXRjaC5zdGFydCgpCiAgICAgICAgaWYgc2VsZi5wYXJzZWRfcmVzcG9uc2VzIGlzIG5vdCBOb25lOgogICAgICAgICAgICBtYWtlX3JlcXVlc3RfcGF0Y2guc2lkZV9lZmZlY3QgPSBsYW1iZGEgKmFyZ3MsICoqa3dhcmdzOiBcCiAgICAgICAgICAgICAgICAoc2VsZi5odHRwX3Jlc3BvbnNlLCBzZWxmLnBhcnNlZF9yZXNwb25zZXMucG9wKDApKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIG1ha2VfcmVxdWVzdF9wYXRjaC5yZXR1cm5fdmFsdWUgPSAoc2VsZi5odHRwX3Jlc3BvbnNlLCBzZWxmLnBhcnNlZF9yZXNwb25zZSkKICAgICAgICBzZWxmLm1ha2VfcmVxdWVzdF9pc19wYXRjaGVkID0gVHJ1ZQoKICAgIGRlZiBhc3NlcnRfcGFyYW1zX2Zvcl9jbWQoc2VsZiwgY21kLCBwYXJhbXM9Tm9uZSwgZXhwZWN0ZWRfcmM9MCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RkZXJyX2NvbnRhaW5zPU5vbmUsIGlnbm9yZV9wYXJhbXM9Tm9uZSk6CiAgICAgICAgc3Rkb3V0LCBzdGRlcnIsIHJjID0gc2VsZi5ydW5fY21kKGNtZCwgZXhwZWN0ZWRfcmMpCiAgICAgICAgaWYgc3RkZXJyX2NvbnRhaW5zIGlzIG5vdCBOb25lOgogICAgICAgICAgICBzZWxmLmFzc2VydEluKHN0ZGVycl9jb250YWlucywgc3RkZXJyKQogICAgICAgIGlmIHBhcmFtcyBpcyBub3QgTm9uZToKICAgICAgICAgICAgIyBUaGUgbGFzdCBrd2FyZ3Mgb2YgT3BlcmF0aW9uLmNhbGwoKSBpbiBib3RvY29yZS4KICAgICAgICAgICAgbGFzdF9rd2FyZ3MgPSBjb3B5LmNvcHkoc2VsZi5sYXN0X2t3YXJncykKICAgICAgICAgICAgaWYgaWdub3JlX3BhcmFtcyBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgIGZvciBrZXkgaW4gaWdub3JlX3BhcmFtczoKICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgIGRlbCBsYXN0X2t3YXJnc1trZXldCiAgICAgICAgICAgICAgICAgICAgZXhjZXB0IEtleUVycm9yOgogICAgICAgICAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgIGlmIHBhcmFtcyAhPSBsYXN0X2t3YXJnczoKICAgICAgICAgICAgICAgIHNlbGYuZmFpbCgiQWN0dWFsIHBhcmFtcyBkaWQgbm90IG1hdGNoIGV4cGVjdGVkIHBhcmFtcy5cbiIKICAgICAgICAgICAgICAgICAgICAgICAgICAiRXhwZWN0ZWQ6XG5cbiIKICAgICAgICAgICAgICAgICAgICAgICAgICAiJXNcbiIKICAgICAgICAgICAgICAgICAgICAgICAgICAiQWN0dWFsOlxuXG4lc1xuIiAlICgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGZvcm1hdChwYXJhbXMpLCBwZm9ybWF0KGxhc3Rfa3dhcmdzKSkpCiAgICAgICAgcmV0dXJuIHN0ZG91dCwgc3RkZXJyLCByYwoKICAgIGRlZiBiZWZvcmVfcGFyYW1ldGVyX2J1aWxkKHNlbGYsIHBhcmFtcywgbW9kZWwsICoqa3dhcmdzKToKICAgICAgICBzZWxmLmxhc3Rfa3dhcmdzID0gcGFyYW1zCiAgICAgICAgc2VsZi5vcGVyYXRpb25zX2NhbGxlZC5hcHBlbmQoKG1vZGVsLCBwYXJhbXMuY29weSgpKSkKCiAgICBkZWYgcnVuX2NtZChzZWxmLCBjbWQsIGV4cGVjdGVkX3JjPTApOgogICAgICAgIGxvZ2dpbmcuZGVidWcoIkNhbGxpbmcgY21kOiAlcyIsIGNtZCkKICAgICAgICBzZWxmLnBhdGNoX21ha2VfcmVxdWVzdCgpCiAgICAgICAgZXZlbnRfZW1pdHRlciA9IHNlbGYuZHJpdmVyLnNlc3Npb24uZ2V0X2NvbXBvbmVudCgnZXZlbnRfZW1pdHRlcicpCiAgICAgICAgZXZlbnRfZW1pdHRlci5yZWdpc3RlcignYmVmb3JlLWNhbGwnLCBzZWxmLmJlZm9yZV9jYWxsKQogICAgICAgIGV2ZW50X2VtaXR0ZXIucmVnaXN0ZXJfZmlyc3QoCiAgICAgICAgICAgICdiZWZvcmUtcGFyYW1ldGVyLWJ1aWxkLiouKicsIHNlbGYuYmVmb3JlX3BhcmFtZXRlcl9idWlsZCkKICAgICAgICBpZiBub3QgaXNpbnN0YW5jZShjbWQsIGxpc3QpOgogICAgICAgICAgICBjbWRsaXN0ID0gY21kLnNwbGl0KCkKICAgICAgICBlbHNlOgogICAgICAgICAgICBjbWRsaXN0ID0gY21kCgogICAgICAgIHdpdGggY2FwdHVyZV9vdXRwdXQoKSBhcyBjYXB0dXJlZDoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgcmMgPSBzZWxmLmRyaXZlci5tYWluKGNtZGxpc3QpCiAgICAgICAgICAgIGV4Y2VwdCBTeXN0ZW1FeGl0IGFzIGU6CiAgICAgICAgICAgICAgICAjIFdlIG5lZWQgdG8gY2F0Y2ggU3lzdGVtRXhpdCBzbyB0aGF0IHdlCiAgICAgICAgICAgICAgICAjIGNhbiBnZXQgYSBwcm9wZXIgcmMgYW5kIHN0aWxsIHByZXNlbnQgdGhlCiAgICAgICAgICAgICAgICAjIHN0ZG91dC9zdGRlcnIgdG8gdGhlIHRlc3QgcnVubmVyIHNvIHdlIGNhbgogICAgICAgICAgICAgICAgIyBmaWd1cmUgb3V0IHdoYXQgd2VudCB3cm9uZy4KICAgICAgICAgICAgICAgIHJjID0gZS5jb2RlCiAgICAgICAgc3RkZXJyID0gY2FwdHVyZWQuc3RkZXJyLmdldHZhbHVlKCkKICAgICAgICBzdGRvdXQgPSBjYXB0dXJlZC5zdGRvdXQuZ2V0dmFsdWUoKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoCiAgICAgICAgICAgIHJjLCBleHBlY3RlZF9yYywKICAgICAgICAgICAgIlVuZXhwZWN0ZWQgcmMgKGV4cGVjdGVkOiAlcywgYWN0dWFsOiAlcykgZm9yIGNvbW1hbmQ6ICVzXG4iCiAgICAgICAgICAgICJzdGRvdXQ6XG4lc3N0ZGVycjpcbiVzIiAlICgKICAgICAgICAgICAgICAgIGV4cGVjdGVkX3JjLCByYywgY21kLCBzdGRvdXQsIHN0ZGVycikpCiAgICAgICAgcmV0dXJuIHN0ZG91dCwgc3RkZXJyLCByYwoKCmNsYXNzIEJhc2VBV1NQcmV2aWV3Q29tbWFuZFBhcmFtc1Rlc3QoQmFzZUFXU0NvbW1hbmRQYXJhbXNUZXN0KToKICAgIGRlZiBzZXRVcChzZWxmKToKICAgICAgICBzZWxmLnByZXZpZXdfcGF0Y2ggPSBtb2NrLnBhdGNoKAogICAgICAgICAgICAnYXdzY2xpLmN1c3RvbWl6YXRpb25zLnByZXZpZXcubWFya19hc19wcmV2aWV3JykKICAgICAgICBzZWxmLnByZXZpZXdfcGF0Y2guc3RhcnQoKQogICAgICAgIHN1cGVyKEJhc2VBV1NQcmV2aWV3Q29tbWFuZFBhcmFtc1Rlc3QsIHNlbGYpLnNldFVwKCkKCiAgICBkZWYgdGVhckRvd24oc2VsZik6CiAgICAgICAgc2VsZi5wcmV2aWV3X3BhdGNoLnN0b3AoKQogICAgICAgIHN1cGVyKEJhc2VBV1NQcmV2aWV3Q29tbWFuZFBhcmFtc1Rlc3QsIHNlbGYpLnRlYXJEb3duKCkKCgpjbGFzcyBCYXNlQ0xJV2lyZVJlc3BvbnNlVGVzdCh1bml0dGVzdC5UZXN0Q2FzZSk6CiAgICBkZWYgc2V0VXAoc2VsZik6CiAgICAgICAgc2VsZi5lbnZpcm9uID0gewogICAgICAgICAgICAnQVdTX0RBVEFfUEFUSCc6IG9zLmVudmlyb25bJ0FXU19EQVRBX1BBVEgnXSwKICAgICAgICAgICAgJ0FXU19ERUZBVUxUX1JFR0lPTic6ICd1cy1lYXN0LTEnLAogICAgICAgICAgICAnQVdTX0FDQ0VTU19LRVlfSUQnOiAnYWNjZXNzX2tleScsCiAgICAgICAgICAgICdBV1NfU0VDUkVUX0FDQ0VTU19LRVknOiAnc2VjcmV0X2tleScsCiAgICAgICAgICAgICdBV1NfQ09ORklHX0ZJTEUnOiAnJwogICAgICAgIH0KICAgICAgICBzZWxmLmVudmlyb25fcGF0Y2ggPSBtb2NrLnBhdGNoKCdvcy5lbnZpcm9uJywgc2VsZi5lbnZpcm9uKQogICAgICAgIHNlbGYuZW52aXJvbl9wYXRjaC5zdGFydCgpCiAgICAgICAgIyBUT0RPOiBmaXggdGhpcyBwYXRjaCB3aGVuIHdlIGhhdmUgYSBiZXR0ZXIgd2F5IHRvIHN0dWIgb3V0IHJlc3BvbnNlcwogICAgICAgIHNlbGYuc2VuZF9wYXRjaCA9IG1vY2sucGF0Y2goJ2JvdG9jb3JlLmVuZHBvaW50LkVuZHBvaW50Ll9zZW5kJykKICAgICAgICBzZWxmLnNlbmRfaXNfcGF0Y2hlZCA9IEZhbHNlCiAgICAgICAgc2VsZi5kcml2ZXIgPSBjcmVhdGVfY2xpZHJpdmVyKCkKCiAgICBkZWYgdGVhckRvd24oc2VsZik6CiAgICAgICAgc2VsZi5lbnZpcm9uX3BhdGNoLnN0b3AoKQogICAgICAgIGlmIHNlbGYuc2VuZF9pc19wYXRjaGVkOgogICAgICAgICAgICBzZWxmLnNlbmRfcGF0Y2guc3RvcCgpCiAgICAgICAgICAgIHNlbGYuc2VuZF9pc19wYXRjaGVkID0gRmFsc2UKCiAgICBkZWYgcGF0Y2hfc2VuZChzZWxmLCBzdGF0dXNfY29kZT0yMDAsIGhlYWRlcnM9e30sIGNvbnRlbnQ9YicnKToKICAgICAgICBpZiBzZWxmLnNlbmRfaXNfcGF0Y2hlZDoKICAgICAgICAgICAgc2VsZi5zZW5kX3BhdGNoLnN0b3AoKQogICAgICAgICAgICBzZWxmLnNlbmRfaXNfcGF0Y2hlZCA9IEZhbHNlCiAgICAgICAgc2VuZF9wYXRjaCA9IHNlbGYuc2VuZF9wYXRjaC5zdGFydCgpCiAgICAgICAgc2VuZF9wYXRjaC5yZXR1cm5fdmFsdWUgPSBtb2NrLk1vY2soc3RhdHVzX2NvZGU9c3RhdHVzX2NvZGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaGVhZGVycz1oZWFkZXJzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRlbnQ9Y29udGVudCkKICAgICAgICBzZWxmLnNlbmRfaXNfcGF0Y2hlZCA9IFRydWUKCiAgICBkZWYgcnVuX2NtZChzZWxmLCBjbWQsIGV4cGVjdGVkX3JjPTApOgogICAgICAgIGlmIG5vdCBpc2luc3RhbmNlKGNtZCwgbGlzdCk6CiAgICAgICAgICAgIGNtZGxpc3QgPSBjbWQuc3BsaXQoKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGNtZGxpc3QgPSBjbWQKICAgICAgICB3aXRoIGNhcHR1cmVfb3V0cHV0KCkgYXMgY2FwdHVyZWQ6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHJjID0gc2VsZi5kcml2ZXIubWFpbihjbWRsaXN0KQogICAgICAgICAgICBleGNlcHQgU3lzdGVtRXhpdCBhcyBlOgogICAgICAgICAgICAgICAgcmMgPSBlLmNvZGUKICAgICAgICBzdGRlcnIgPSBjYXB0dXJlZC5zdGRlcnIuZ2V0dmFsdWUoKQogICAgICAgIHN0ZG91dCA9IGNhcHR1cmVkLnN0ZG91dC5nZXR2YWx1ZSgpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbCgKICAgICAgICAgICAgcmMsIGV4cGVjdGVkX3JjLAogICAgICAgICAgICAiVW5leHBlY3RlZCByYyAoZXhwZWN0ZWQ6ICVzLCBhY3R1YWw6ICVzKSBmb3IgY29tbWFuZDogJXNcbiIKICAgICAgICAgICAgInN0ZG91dDpcbiVzc3RkZXJyOlxuJXMiICUgKAogICAgICAgICAgICAgICAgZXhwZWN0ZWRfcmMsIHJjLCBjbWQsIHN0ZG91dCwgc3RkZXJyKSkKICAgICAgICByZXR1cm4gc3Rkb3V0LCBzdGRlcnIsIHJjCgoKCmNsYXNzIEZpbGVDcmVhdG9yKG9iamVjdCk6CiAgICBkZWYgX19pbml0X18oc2VsZik6CiAgICAgICAgc2VsZi5yb290ZGlyID0gdGVtcGZpbGUubWtkdGVtcCgpCgogICAgZGVmIHJlbW92ZV9hbGwoc2VsZik6CiAgICAgICAgaWYgb3MucGF0aC5leGlzdHMoc2VsZi5yb290ZGlyKToKICAgICAgICAgICAgc2h1dGlsLnJtdHJlZShzZWxmLnJvb3RkaXIpCgogICAgZGVmIGNyZWF0ZV9maWxlKHNlbGYsIGZpbGVuYW1lLCBjb250ZW50cywgbXRpbWU9Tm9uZSwgbW9kZT0ndycpOgogICAgICAgICIiIkNyZWF0ZXMgYSBmaWxlIGluIGEgdG1wZGlyCgogICAgICAgIGBgZmlsZW5hbWVgYCBzaG91bGQgYmUgYSByZWxhdGl2ZSBwYXRoLCBlLmcuICJmb28vYmFyL2Jhei50eHQiCiAgICAgICAgSXQgd2lsbCBiZSB0cmFuc2xhdGVkIGludG8gYSBmdWxsIHBhdGggaW4gYSB0bXAgZGlyLgoKICAgICAgICBJZiB0aGUgYGBtdGltZWBgIGFyZ3VtZW50IGlzIHByb3ZpZGVkLCB0aGVuIHRoZSBmaWxlJ3MKICAgICAgICBtdGltZSB3aWxsIGJlIHNldCB0byB0aGUgcHJvdmlkZWQgdmFsdWUgKG11c3QgYmUgYW4gZXBvY2ggdGltZSkuCiAgICAgICAgT3RoZXJ3aXNlIHRoZSBtdGltZSBpcyBsZWZ0IHVudG91Y2hlZC4KCiAgICAgICAgYGBtb2RlYGAgaXMgdGhlIG1vZGUgdGhlIGZpbGUgc2hvdWxkIGJlIG9wZW5lZCBlaXRoZXIgYXMgYGB3YGAgb3IKICAgICAgICBgd2JgYC4KCiAgICAgICAgUmV0dXJucyB0aGUgZnVsbCBwYXRoIHRvIHRoZSBmaWxlLgoKICAgICAgICAiIiIKICAgICAgICBmdWxsX3BhdGggPSBvcy5wYXRoLmpvaW4oc2VsZi5yb290ZGlyLCBmaWxlbmFtZSkKICAgICAgICBpZiBub3Qgb3MucGF0aC5pc2Rpcihvcy5wYXRoLmRpcm5hbWUoZnVsbF9wYXRoKSk6CiAgICAgICAgICAgIG9zLm1ha2VkaXJzKG9zLnBhdGguZGlybmFtZShmdWxsX3BhdGgpKQogICAgICAgIHdpdGggb3BlbihmdWxsX3BhdGgsIG1vZGUpIGFzIGY6CiAgICAgICAgICAgIGYud3JpdGUoY29udGVudHMpCiAgICAgICAgY3VycmVudF90aW1lID0gb3MucGF0aC5nZXRtdGltZShmdWxsX3BhdGgpCiAgICAgICAgIyBTdWJ0cmFjdCBhIGZldyB5ZWFycyBvZmYgdGhlIGxhc3QgbW9kaWZpY2F0aW9uIGRhdGUuCiAgICAgICAgb3MudXRpbWUoZnVsbF9wYXRoLCAoY3VycmVudF90aW1lLCBjdXJyZW50X3RpbWUgLSAxMDAwMDAwMDApKQogICAgICAgIGlmIG10aW1lIGlzIG5vdCBOb25lOgogICAgICAgICAgICBvcy51dGltZShmdWxsX3BhdGgsIChtdGltZSwgbXRpbWUpKQogICAgICAgIHJldHVybiBmdWxsX3BhdGgKCiAgICBkZWYgYXBwZW5kX2ZpbGUoc2VsZiwgZmlsZW5hbWUsIGNvbnRlbnRzKToKICAgICAgICAiIiJBcHBlbmQgY29udGVudHMgdG8gYSBmaWxlCgogICAgICAgIGBgZmlsZW5hbWVgYCBzaG91bGQgYmUgYSByZWxhdGl2ZSBwYXRoLCBlLmcuICJmb28vYmFyL2Jhei50eHQiCiAgICAgICAgSXQgd2lsbCBiZSB0cmFuc2xhdGVkIGludG8gYSBmdWxsIHBhdGggaW4gYSB0bXAgZGlyLgoKICAgICAgICBSZXR1cm5zIHRoZSBmdWxsIHBhdGggdG8gdGhlIGZpbGUuCiAgICAgICAgIiIiCiAgICAgICAgZnVsbF9wYXRoID0gb3MucGF0aC5qb2luKHNlbGYucm9vdGRpciwgZmlsZW5hbWUpCiAgICAgICAgaWYgbm90IG9zLnBhdGguaXNkaXIob3MucGF0aC5kaXJuYW1lKGZ1bGxfcGF0aCkpOgogICAgICAgICAgICBvcy5tYWtlZGlycyhvcy5wYXRoLmRpcm5hbWUoZnVsbF9wYXRoKSkKICAgICAgICB3aXRoIG9wZW4oZnVsbF9wYXRoLCAnYScpIGFzIGY6CiAgICAgICAgICAgIGYud3JpdGUoY29udGVudHMpCiAgICAgICAgcmV0dXJuIGZ1bGxfcGF0aAoKICAgIGRlZiBmdWxsX3BhdGgoc2VsZiwgZmlsZW5hbWUpOgogICAgICAgICIiIlRyYW5zbGF0ZSByZWxhdGl2ZSBwYXRoIHRvIGZ1bGwgcGF0aCBpbiB0ZW1wIGRpci4KCiAgICAgICAgZi5mdWxsX3BhdGgoJ2Zvby9iYXIudHh0JykgLT4gL3RtcC9hc2RmYXNkL2Zvby9iYXIudHh0CiAgICAgICAgIiIiCiAgICAgICAgcmV0dXJuIG9zLnBhdGguam9pbihzZWxmLnJvb3RkaXIsIGZpbGVuYW1lKQoKCmNsYXNzIFByb2Nlc3NUZXJtaW5hdGVkRXJyb3IoRXhjZXB0aW9uKToKICAgIHBhc3MKCgpjbGFzcyBSZXN1bHQob2JqZWN0KToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCByYywgc3Rkb3V0LCBzdGRlcnIsIG1lbW9yeV91c2FnZT1Ob25lKToKICAgICAgICBzZWxmLnJjID0gcmMKICAgICAgICBzZWxmLnN0ZG91dCA9IHN0ZG91dAogICAgICAgIHNlbGYuc3RkZXJyID0gc3RkZXJyCiAgICAgICAgSU5URUdfTE9HLmRlYnVnKCJyYzogJXMiLCByYykKICAgICAgICBJTlRFR19MT0cuZGVidWcoInN0ZG91dDogJXMiLCBzdGRvdXQpCiAgICAgICAgSU5URUdfTE9HLmRlYnVnKCJzdGRlcnI6ICVzIiwgc3RkZXJyKQogICAgICAgIGlmIG1lbW9yeV91c2FnZSBpcyBOb25lOgogICAgICAgICAgICBtZW1vcnlfdXNhZ2UgPSBbXQogICAgICAgIHNlbGYubWVtb3J5X3VzYWdlID0gbWVtb3J5X3VzYWdlCgogICAgQHByb3BlcnR5CiAgICBkZWYganNvbihzZWxmKToKICAgICAgICByZXR1cm4ganNvbi5sb2FkcyhzZWxmLnN0ZG91dCkKCgpkZWYgX2VzY2FwZV9xdW90ZXMoY29tbWFuZCk6CiAgICAjIEZvciB3aW5kb3dzIHdlIGhhdmUgZGlmZmVyZW50IHJ1bGVzIGZvciBlc2NhcGluZy4KICAgICMgRmlyc3QsIGRvdWJsZSBxdW90ZXMgbXVzdCBiZSBlc2NhcGVkLgogICAgY29tbWFuZCA9IGNvbW1hbmQucmVwbGFjZSgnIicsICdcXCInKQogICAgIyBTZWNvbmQsIHNpbmdsZSBxdW90ZXMgZG8gbm90aGluZywgdG8gcXVvdGUgYSB2YWx1ZSB3ZSBuZWVkCiAgICAjIHRvIHVzZSBkb3VibGUgcXVvdGVzLgogICAgY29tbWFuZCA9IGNvbW1hbmQucmVwbGFjZSgiJyIsICciJykKICAgIHJldHVybiBjb21tYW5kCgoKZGVmIGF3cyhjb21tYW5kLCBjb2xsZWN0X21lbW9yeT1GYWxzZSwgZW52X3ZhcnM9Tm9uZSwKICAgICAgICB3YWl0X2Zvcl9maW5pc2g9VHJ1ZSwgaW5wdXRfZGF0YT1Ob25lLCBpbnB1dF9maWxlPU5vbmUpOgogICAgIiIiUnVuIGFuIGF3cyBjb21tYW5kLgoKICAgIFRoaXMgaGVscCBmdW5jdGlvbiBhYnN0cmFjdHMgdGhlIGRpZmZlcmVuY2VzIG9mIHJ1bm5pbmcgdGhlICJhd3MiCiAgICBjb21tYW5kIG9uIGRpZmZlcmVudCBwbGF0Zm9ybXMuCgogICAgSWYgY29sbGVjdF9tZW1vcnkgaXMgYGBUcnVlYGAgdGhlIHRoZSBSZXN1bHQgb2JqZWN0IHdpbGwgaGF2ZSBhIGxpc3QKICAgIG9mIG1lbW9yeSB1c2FnZSB0YWtlbiBhdCAyIHNlY29uZCBpbnRlcnZhbHMuICBUaGUgbWVtb3J5IHVzYWdlCiAgICB3aWxsIGJlIGluIGJ5dGVzLgoKICAgIElmIGVudl92YXJzIGlzIE5vbmUsIHRoaXMgd2lsbCBzZXQgdGhlIGVudmlyb25tZW50IHZhcmlhYmxlcwogICAgdG8gYmUgdXNlZCBieSB0aGUgYXdzIHByb2Nlc3MuCgogICAgSWYgd2FpdF9mb3JfZmluaXNoIGlzIEZhbHNlLCB0aGVuIHRoZSBQcm9jZXNzIG9iamVjdCBpcyByZXR1cm5lZAogICAgdG8gdGhlIGNhbGxlci4gIEl0IGlzIHRoZW4gdGhlIGNhbGxlcidzIHJlc3BvbnNpYmlsaXR5IHRvIGVuc3VyZQogICAgcHJvcGVyIGNsZWFudXAuICBUaGlzIGNhbiBiZSB1c2VmdWwgaWYgeW91IHdhbnQgdG8gdGVzdCB0aW1lb3V0J3MKICAgIG9yIGhvdyB0aGUgQ0xJIHJlc3BvbmRzIHRvIHZhcmlvdXMgc2lnbmFscy4KCiAgICA6dHlwZSBpbnB1dF9kYXRhOiBzdHJpbmcKICAgIDpwYXJhbSBpbnB1dF9kYXRhOiBUaGlzIHN0cmluZyB3aWxsIGJlIGNvbW11bmljYXRlZCB0byB0aGUgcHJvY2VzcyB0aHJvdWdoCiAgICAgICAgdGhlIHN0ZGluIG9mIHRoZSBwcm9jZXNzLiAgSXQgZXNzZW50aWFsbHkgYWxsb3dzIHRoZSB1c2VyIHRvCiAgICAgICAgYXZvaWQgaGF2aW5nIHRvIHVzZSBhIGZpbGUgaGFuZGxlIHRvIHBhc3MgaW5mb3JtYXRpb24gdG8gdGhlIHByb2Nlc3MuCiAgICAgICAgTm90ZSB0aGF0IHRoaXMgc3RyaW5nIGlzIG5vdCBwYXNzZWQgb24gY3JlYXRpb24gb2YgdGhlIHByb2Nlc3MsIGJ1dAogICAgICAgIHJhdGhlciBjb21tdW5pY2F0ZWQgdG8gdGhlIHByb2Nlc3MuCgogICAgOnR5cGUgaW5wdXRfZmlsZTogYSBmaWxlIGhhbmRsZQogICAgOnBhcmFtIGlucHV0X2ZpbGU6IFRoaXMgaXMgYSBmaWxlIGhhbmRsZSB0aGF0IHdpbGwgYWN0IGFzIHRoZQogICAgICAgIHRoZSBzdGRpbiBvZiB0aGUgcHJvY2VzcyBpbW1lZGlhdGVseSBvbiBjcmVhdGlvbi4gIEVzc2VudGlhbGx5CiAgICAgICAgYW55IGRhdGEgd3JpdHRlbiB0byB0aGUgZmlsZSB3aWxsIGJlIHJlYWQgZnJvbSBzdGRpbiBvZiB0aGUKICAgICAgICBwcm9jZXNzLiBUaGlzIGlzIG5lZWRlZCBpZiB5b3UgcGxhbiB0byBzdHJlYW0gZGF0YSBpbnRvIHN0ZGluIHdoaWxlCiAgICAgICAgY29sbGVjdGluZyBtZW1vcnkuCiAgICAiIiIKICAgIGlmIHBsYXRmb3JtLnN5c3RlbSgpID09ICdXaW5kb3dzJzoKICAgICAgICBjb21tYW5kID0gX2VzY2FwZV9xdW90ZXMoY29tbWFuZCkKICAgIGlmICdBV1NfVEVTVF9DT01NQU5EJyBpbiBvcy5lbnZpcm9uOgogICAgICAgIGF3c19jb21tYW5kID0gb3MuZW52aXJvblsnQVdTX1RFU1RfQ09NTUFORCddCiAgICBlbHNlOgogICAgICAgIGF3c19jb21tYW5kID0gJ3B5dGhvbiAlcycgJSBnZXRfYXdzX2NtZCgpCiAgICBmdWxsX2NvbW1hbmQgPSAnJXMgJXMnICUgKGF3c19jb21tYW5kLCBjb21tYW5kKQogICAgc3Rkb3V0X2VuY29kaW5nID0gZ2V0X3N0ZG91dF9lbmNvZGluZygpCiAgICBpZiBpc2luc3RhbmNlKGZ1bGxfY29tbWFuZCwgc2l4LnRleHRfdHlwZSkgYW5kIG5vdCBzaXguUFkzOgogICAgICAgIGZ1bGxfY29tbWFuZCA9IGZ1bGxfY29tbWFuZC5lbmNvZGUoc3Rkb3V0X2VuY29kaW5nKQogICAgSU5URUdfTE9HLmRlYnVnKCJSdW5uaW5nIGNvbW1hbmQ6ICVzIiwgZnVsbF9jb21tYW5kKQogICAgZW52ID0gb3MuZW52aXJvbi5jb3B5KCkKICAgIGlmICdBV1NfREVGQVVMVF9SRUdJT04nIG5vdCBpbiBlbnY6CiAgICAgICAgZW52WydBV1NfREVGQVVMVF9SRUdJT04nXSA9ICJ1cy1lYXN0LTEiCiAgICBpZiBlbnZfdmFycyBpcyBub3QgTm9uZToKICAgICAgICBlbnYgPSBlbnZfdmFycwogICAgaWYgaW5wdXRfZmlsZSBpcyBOb25lOgogICAgICAgIGlucHV0X2ZpbGUgPSBQSVBFCiAgICBwcm9jZXNzID0gUG9wZW4oZnVsbF9jb21tYW5kLCBzdGRvdXQ9UElQRSwgc3RkZXJyPVBJUEUsIHN0ZGluPWlucHV0X2ZpbGUsCiAgICAgICAgICAgICAgICAgICAgc2hlbGw9VHJ1ZSwgZW52PWVudikKICAgIGlmIG5vdCB3YWl0X2Zvcl9maW5pc2g6CiAgICAgICAgcmV0dXJuIHByb2Nlc3MKICAgIG1lbW9yeSA9IE5vbmUKICAgIGlmIG5vdCBjb2xsZWN0X21lbW9yeToKICAgICAgICBrd2FyZ3MgPSB7fQogICAgICAgIGlmIGlucHV0X2RhdGE6CiAgICAgICAgICAgIGt3YXJncyA9IHsnaW5wdXQnOiBpbnB1dF9kYXRhfQogICAgICAgIHN0ZG91dCwgc3RkZXJyID0gcHJvY2Vzcy5jb21tdW5pY2F0ZSgqKmt3YXJncykKICAgIGVsc2U6CiAgICAgICAgc3Rkb3V0LCBzdGRlcnIsIG1lbW9yeSA9IF93YWl0X2FuZF9jb2xsZWN0X21lbShwcm9jZXNzKQogICAgcmV0dXJuIFJlc3VsdChwcm9jZXNzLnJldHVybmNvZGUsCiAgICAgICAgICAgICAgICAgIHN0ZG91dC5kZWNvZGUoc3Rkb3V0X2VuY29kaW5nKSwKICAgICAgICAgICAgICAgICAgc3RkZXJyLmRlY29kZShzdGRvdXRfZW5jb2RpbmcpLAogICAgICAgICAgICAgICAgICBtZW1vcnkpCgoKZGVmIGdldF9zdGRvdXRfZW5jb2RpbmcoKToKICAgIGVuY29kaW5nID0gZ2V0YXR0cihzeXMuX19zdGRvdXRfXywgJ2VuY29kaW5nJywgTm9uZSkKICAgIGlmIGVuY29kaW5nIGlzIE5vbmU6CiAgICAgICAgZW5jb2RpbmcgPSAndXRmLTgnCiAgICByZXR1cm4gZW5jb2RpbmcKCgpkZWYgX3dhaXRfYW5kX2NvbGxlY3RfbWVtKHByb2Nlc3MpOgogICAgIyBXZSBvbmx5IGtub3cgaG93IHRvIGNvbGxlY3QgbWVtb3J5IG9uIG1hYy9saW51eC4KICAgIGlmIHBsYXRmb3JtLnN5c3RlbSgpID09ICdEYXJ3aW4nOgogICAgICAgIGdldF9tZW1vcnkgPSBfZ2V0X21lbW9yeV93aXRoX3BzCiAgICBlbGlmIHBsYXRmb3JtLnN5c3RlbSgpID09ICdMaW51eCc6CiAgICAgICAgZ2V0X21lbW9yeSA9IF9nZXRfbWVtb3J5X3dpdGhfcHMKICAgIGVsc2U6CiAgICAgICAgcmFpc2UgVmFsdWVFcnJvcigKICAgICAgICAgICAgIkNhbid0IGNvbGxlY3QgbWVtb3J5IGZvciBwcm9jZXNzIG9uIHBsYXRmb3JtICVzLiIgJQogICAgICAgICAgICBwbGF0Zm9ybS5zeXN0ZW0oKSkKICAgIG1lbW9yeSA9IFtdCiAgICB3aGlsZSBwcm9jZXNzLnBvbGwoKSBpcyBOb25lOgogICAgICAgIHRyeToKICAgICAgICAgICAgY3VycmVudCA9IGdldF9tZW1vcnkocHJvY2Vzcy5waWQpCiAgICAgICAgZXhjZXB0IFByb2Nlc3NUZXJtaW5hdGVkRXJyb3I6CiAgICAgICAgICAgICMgSXQncyBwb3NzaWJsZSB0aGUgcHJvY2VzcyB0ZXJtaW5hdGVkIGJldHdlZW4gLnBvbGwoKQogICAgICAgICAgICAjIGFuZCBnZXRfbWVtb3J5KCkuCiAgICAgICAgICAgIGJyZWFrCiAgICAgICAgbWVtb3J5LmFwcGVuZChjdXJyZW50KQogICAgc3Rkb3V0LCBzdGRlcnIgPSBwcm9jZXNzLmNvbW11bmljYXRlKCkKICAgIHJldHVybiBzdGRvdXQsIHN0ZGVyciwgbWVtb3J5CgoKZGVmIF9nZXRfbWVtb3J5X3dpdGhfcHMocGlkKToKICAgICMgSXQncyBwcm9iYWJseSBwb3NzaWJsZSB0byBkbyB3aXRoIHByb2NfcGlkaW5mbyBhbmQgY3R5cGVzIG9uIGEgTWFjLAogICAgIyBidXQgd2UnbGwgZG8gaXQgdGhlIGVhc3kgd2F5IHdpdGggcGFyc2luZyBwcyBvdXRwdXQuCiAgICBjb21tYW5kX2xpc3QgPSAncHMgdSAtcCcuc3BsaXQoKQogICAgY29tbWFuZF9saXN0LmFwcGVuZChzdHIocGlkKSkKICAgIHAgPSBQb3Blbihjb21tYW5kX2xpc3QsIHN0ZG91dD1QSVBFKQogICAgc3Rkb3V0ID0gcC5jb21tdW5pY2F0ZSgpWzBdCiAgICBpZiBub3QgcC5yZXR1cm5jb2RlID09IDA6CiAgICAgICAgcmFpc2UgUHJvY2Vzc1Rlcm1pbmF0ZWRFcnJvcihzdHIocGlkKSkKICAgIGVsc2U6CiAgICAgICAgIyBHZXQgdGhlIFJTUyBmcm9tIG91dHB1dCB0aGF0IGxvb2tzIGxpa2UgdGhpczoKICAgICAgICAjIFVTRVIgICAgICAgUElEICAlQ1BVICVNRU0gICAgICBWU1ogICAgUlNTICAgVFQgIFNUQVQgU1RBUlRFRCAgICAgIFRJTUUgQ09NTUFORAogICAgICAgICMgdXNlciAgICAgNDcxMDIgICAwLjAgIDAuMSAgMjQzNzAwMCAgIDQ0OTYgczAwMiAgUysgICAgNzowNFBNICAgMDowMC4xMiBweXRob24yLjYKICAgICAgICByZXR1cm4gaW50KHN0ZG91dC5zcGxpdGxpbmVzKClbMV0uc3BsaXQoKVs1XSkgKiAxMDI0CgoKY2xhc3MgQmFzZVMzQ0xJQ29tbWFuZCh1bml0dGVzdC5UZXN0Q2FzZSk6CiAgICAiIiJCYXNlIGNsYXNzIGZvciBhd3MgczMgY29tbWFuZC4KCiAgICBUaGlzIGNvbnRhaW5zIGNvbnZlbmllbmNlIGZ1bmN0aW9ucyB0byBtYWtlIHdyaXRpbmcgdGhlc2UgdGVzdHMgZWFzaWVyCiAgICBhbmQgbW9yZSBzdHJlYW1saW5lZC4KCiAgICAiIiIKICAgIF9QVVRfSEVBRF9TSEFSRURfRVhUUkFTID0gWwogICAgICAgICdTU0VDdXN0b21lckFsZ29yaXRobScsCiAgICAgICAgJ1NTRUN1c3RvbWVyS2V5JywKICAgICAgICAnU1NFQ3VzdG9tZXJLZXlNRDUnLAogICAgICAgICdSZXF1ZXN0UGF5ZXInLAogICAgXQoKICAgIGRlZiBzZXRVcChzZWxmKToKICAgICAgICBzZWxmLmZpbGVzID0gRmlsZUNyZWF0b3IoKQogICAgICAgIHNlbGYuc2Vzc2lvbiA9IGJvdG9jb3JlLnNlc3Npb24uZ2V0X3Nlc3Npb24oKQogICAgICAgIHNlbGYucmVnaW9ucyA9IHt9CiAgICAgICAgc2VsZi5yZWdpb24gPSAndXMtd2VzdC0yJwogICAgICAgIHNlbGYuY2xpZW50ID0gc2VsZi5zZXNzaW9uLmNyZWF0ZV9jbGllbnQoJ3MzJywgcmVnaW9uX25hbWU9c2VsZi5yZWdpb24pCiAgICAgICAgc2VsZi5leHRyYV9zZXR1cCgpCgogICAgZGVmIGV4dHJhX3NldHVwKHNlbGYpOgogICAgICAgICMgU3ViY2xhc3NlcyBjYW4gdXNlIHRoaXMgdG8gZGVmaW5lIGV4dHJhIHNldHVwIHN0ZXBzLgogICAgICAgIHBhc3MKCiAgICBkZWYgdGVhckRvd24oc2VsZik6CiAgICAgICAgc2VsZi5maWxlcy5yZW1vdmVfYWxsKCkKICAgICAgICBzZWxmLmV4dHJhX3RlYXJkb3duKCkKCiAgICBkZWYgZXh0cmFfdGVhcmRvd24oc2VsZik6CiAgICAgICAgIyBTdWJjbGFzc2VzIGNhbiB1c2UgdGhpcyB0byBkZWZpbmUgZXh0cmEgdGVhcmRvd24gc3RlcHMuCiAgICAgICAgcGFzcwoKICAgIGRlZiBvdmVycmlkZV9wYXJzZXIoc2VsZiwgKiprd2FyZ3MpOgogICAgICAgIGZhY3RvcnkgPSBzZWxmLnNlc3Npb24uZ2V0X2NvbXBvbmVudCgncmVzcG9uc2VfcGFyc2VyX2ZhY3RvcnknKQogICAgICAgIGZhY3Rvcnkuc2V0X3BhcnNlcl9kZWZhdWx0cygqKmt3YXJncykKCiAgICBkZWYgY3JlYXRlX2NsaWVudF9mb3JfYnVja2V0KHNlbGYsIGJ1Y2tldF9uYW1lKToKICAgICAgICByZWdpb24gPSBzZWxmLnJlZ2lvbnMuZ2V0KGJ1Y2tldF9uYW1lLCBzZWxmLnJlZ2lvbikKICAgICAgICBjbGllbnQgPSBzZWxmLnNlc3Npb24uY3JlYXRlX2NsaWVudCgnczMnLCByZWdpb25fbmFtZT1yZWdpb24pCiAgICAgICAgcmV0dXJuIGNsaWVudAoKICAgIGRlZiBhc3NlcnRfa2V5X2NvbnRlbnRzX2VxdWFsKHNlbGYsIGJ1Y2tldCwga2V5LCBleHBlY3RlZF9jb250ZW50cyk6CiAgICAgICAgc2VsZi53YWl0X3VudGlsX2tleV9leGlzdHMoYnVja2V0LCBrZXkpCiAgICAgICAgaWYgaXNpbnN0YW5jZShleHBlY3RlZF9jb250ZW50cywgc2l4LkJ5dGVzSU8pOgogICAgICAgICAgICBleHBlY3RlZF9jb250ZW50cyA9IGV4cGVjdGVkX2NvbnRlbnRzLmdldHZhbHVlKCkuZGVjb2RlKCd1dGYtOCcpCiAgICAgICAgYWN0dWFsX2NvbnRlbnRzID0gc2VsZi5nZXRfa2V5X2NvbnRlbnRzKGJ1Y2tldCwga2V5KQogICAgICAgICMgVGhlIGNvbnRlbnRzIGNhbiBiZSBodWdlIHNvIHdlIHRyeSB0byBnaXZlIGhlbHBmdWwgZXJyb3IgbWVzc2FnZXMKICAgICAgICAjIHdpdGhvdXQgbmVjZXNzYXJpbHkgcHJpbnRpbmcgdGhlIGFjdHVhbCBjb250ZW50cy4KICAgICAgICBzZWxmLmFzc2VydEVxdWFsKGxlbihhY3R1YWxfY29udGVudHMpLCBsZW4oZXhwZWN0ZWRfY29udGVudHMpKQogICAgICAgIGlmIGFjdHVhbF9jb250ZW50cyAhPSBleHBlY3RlZF9jb250ZW50czoKICAgICAgICAgICAgc2VsZi5mYWlsKCJDb250ZW50cyBmb3IgJXMvJXMgZG8gbm90IG1hdGNoIChidXQgdGhleSAiCiAgICAgICAgICAgICAgICAgICAgICAiaGF2ZSB0aGUgc2FtZSBsZW5ndGgpIiAlIChidWNrZXQsIGtleSkpCgogICAgZGVmIGNyZWF0ZV9idWNrZXQoc2VsZiwgbmFtZT1Ob25lLCByZWdpb249Tm9uZSk6CiAgICAgICAgaWYgbm90IHJlZ2lvbjoKICAgICAgICAgICAgcmVnaW9uID0gc2VsZi5yZWdpb24KICAgICAgICBidWNrZXRfbmFtZSA9IGNyZWF0ZV9idWNrZXQoc2VsZi5zZXNzaW9uLCBuYW1lLCByZWdpb24pCiAgICAgICAgc2VsZi5yZWdpb25zW2J1Y2tldF9uYW1lXSA9IHJlZ2lvbgogICAgICAgIHNlbGYuYWRkQ2xlYW51cChzZWxmLmRlbGV0ZV9idWNrZXQsIGJ1Y2tldF9uYW1lKQoKICAgICAgICAjIFdhaXQgZm9yIHRoZSBidWNrZXQgdG8gZXhpc3QgYmVmb3JlIGxldHRpbmcgaXQgYmUgdXNlZC4KICAgICAgICBzZWxmLndhaXRfYnVja2V0X2V4aXN0cyhidWNrZXRfbmFtZSkKICAgICAgICByZXR1cm4gYnVja2V0X25hbWUKCiAgICBkZWYgcHV0X29iamVjdChzZWxmLCBidWNrZXRfbmFtZSwga2V5X25hbWUsIGNvbnRlbnRzPScnLCBleHRyYV9hcmdzPU5vbmUpOgogICAgICAgIGNsaWVudCA9IHNlbGYuY3JlYXRlX2NsaWVudF9mb3JfYnVja2V0KGJ1Y2tldF9uYW1lKQogICAgICAgIGNhbGxfYXJncyA9IHsKICAgICAgICAgICAgJ0J1Y2tldCc6IGJ1Y2tldF9uYW1lLAogICAgICAgICAgICAnS2V5Jzoga2V5X25hbWUsICdCb2R5JzogY29udGVudHMKICAgICAgICB9CiAgICAgICAgaWYgZXh0cmFfYXJncyBpcyBub3QgTm9uZToKICAgICAgICAgICAgY2FsbF9hcmdzLnVwZGF0ZShleHRyYV9hcmdzKQogICAgICAgIHJlc3BvbnNlID0gY2xpZW50LnB1dF9vYmplY3QoKipjYWxsX2FyZ3MpCiAgICAgICAgc2VsZi5hZGRDbGVhbnVwKHNlbGYuZGVsZXRlX2tleSwgYnVja2V0X25hbWUsIGtleV9uYW1lKQogICAgICAgIGV4dHJhX2hlYWRfcGFyYW1zID0ge30KICAgICAgICBpZiBleHRyYV9hcmdzOgogICAgICAgICAgICBleHRyYV9oZWFkX3BhcmFtcyA9IGRpY3QoCiAgICAgICAgICAgICAgICAoaywgdikgZm9yIChrLCB2KSBpbiBleHRyYV9hcmdzLml0ZW1zKCkKICAgICAgICAgICAgICAgIGlmIGsgaW4gc2VsZi5fUFVUX0hFQURfU0hBUkVEX0VYVFJBUwogICAgICAgICAgICApCiAgICAgICAgc2VsZi53YWl0X3VudGlsX2tleV9leGlzdHMoCiAgICAgICAgICAgIGJ1Y2tldF9uYW1lLAogICAgICAgICAgICBrZXlfbmFtZSwKICAgICAgICAgICAgZXh0cmFfcGFyYW1zPWV4dHJhX2hlYWRfcGFyYW1zLAogICAgICAgICkKICAgICAgICByZXR1cm4gcmVzcG9uc2UKCiAgICBkZWYgZGVsZXRlX2J1Y2tldChzZWxmLCBidWNrZXRfbmFtZSwgYXR0ZW1wdHM9NSwgZGVsYXk9NSk6CiAgICAgICAgc2VsZi5yZW1vdmVfYWxsX29iamVjdHMoYnVja2V0X25hbWUpCiAgICAgICAgY2xpZW50ID0gc2VsZi5jcmVhdGVfY2xpZW50X2Zvcl9idWNrZXQoYnVja2V0X25hbWUpCgogICAgICAgICMgVGhlcmUncyBhIGNoYW5jZSB0aGF0LCBldmVuIHRob3VnaCB0aGUgYnVja2V0IGhhcyBiZWVuIHVzZWQKICAgICAgICAjIHNldmVyYWwgdGltZXMsIHRoZSBkZWxldGUgd2lsbCBmYWlsIGR1ZSB0byBldmVudHVhbCBjb25zaXN0ZW5jeQogICAgICAgICMgaXNzdWVzLgogICAgICAgIGF0dGVtcHRzX3JlbWFpbmluZyA9IGF0dGVtcHRzCiAgICAgICAgd2hpbGUgVHJ1ZToKICAgICAgICAgICAgYXR0ZW1wdHNfcmVtYWluaW5nIC09IDEKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgY2xpZW50LmRlbGV0ZV9idWNrZXQoQnVja2V0PWJ1Y2tldF9uYW1lKQogICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgZXhjZXB0IGNsaWVudC5leGNlcHRpb25zLk5vU3VjaEJ1Y2tldDoKICAgICAgICAgICAgICAgIGlmIHNlbGYuYnVja2V0X25vdF9leGlzdHMoYnVja2V0X25hbWUpOgogICAgICAgICAgICAgICAgICAgICMgRmFzdCBmYWlsIHdoZW4gdGhlIE5vU3VjaEJ1Y2tldCBlcnJvciBpcyByZWFsLgogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICBpZiBhdHRlbXB0c19yZW1haW5pbmcgPD0gMDoKICAgICAgICAgICAgICAgICAgICByYWlzZQogICAgICAgICAgICAgICAgdGltZS5zbGVlcChkZWxheSkKCiAgICAgICAgc2VsZi5yZWdpb25zLnBvcChidWNrZXRfbmFtZSwgTm9uZSkKCiAgICBkZWYgcmVtb3ZlX2FsbF9vYmplY3RzKHNlbGYsIGJ1Y2tldF9uYW1lKToKICAgICAgICBjbGllbnQgPSBzZWxmLmNyZWF0ZV9jbGllbnRfZm9yX2J1Y2tldChidWNrZXRfbmFtZSkKICAgICAgICBwYWdpbmF0b3IgPSBjbGllbnQuZ2V0X3BhZ2luYXRvcignbGlzdF9vYmplY3RzJykKICAgICAgICBwYWdlcyA9IHBhZ2luYXRvci5wYWdpbmF0ZShCdWNrZXQ9YnVja2V0X25hbWUpCiAgICAgICAga2V5X25hbWVzID0gW10KICAgICAgICBmb3IgcGFnZSBpbiBwYWdlczoKICAgICAgICAgICAga2V5X25hbWVzICs9IFtvYmpbJ0tleSddIGZvciBvYmogaW4gcGFnZS5nZXQoJ0NvbnRlbnRzJywgW10pXQogICAgICAgIGZvciBrZXlfbmFtZSBpbiBrZXlfbmFtZXM6CiAgICAgICAgICAgIHNlbGYuZGVsZXRlX2tleShidWNrZXRfbmFtZSwga2V5X25hbWUpCgogICAgZGVmIGRlbGV0ZV9rZXkoc2VsZiwgYnVja2V0X25hbWUsIGtleV9uYW1lKToKICAgICAgICBjbGllbnQgPSBzZWxmLmNyZWF0ZV9jbGllbnRfZm9yX2J1Y2tldChidWNrZXRfbmFtZSkKICAgICAgICByZXNwb25zZSA9IGNsaWVudC5kZWxldGVfb2JqZWN0KEJ1Y2tldD1idWNrZXRfbmFtZSwgS2V5PWtleV9uYW1lKQoKICAgIGRlZiBnZXRfa2V5X2NvbnRlbnRzKHNlbGYsIGJ1Y2tldF9uYW1lLCBrZXlfbmFtZSk6CiAgICAgICAgc2VsZi53YWl0X3VudGlsX2tleV9leGlzdHMoYnVja2V0X25hbWUsIGtleV9uYW1lKQogICAgICAgIGNsaWVudCA9IHNlbGYuY3JlYXRlX2NsaWVudF9mb3JfYnVja2V0KGJ1Y2tldF9uYW1lKQogICAgICAgIHJlc3BvbnNlID0gY2xpZW50LmdldF9vYmplY3QoQnVja2V0PWJ1Y2tldF9uYW1lLCBLZXk9a2V5X25hbWUpCiAgICAgICAgcmV0dXJuIHJlc3BvbnNlWydCb2R5J10ucmVhZCgpLmRlY29kZSgndXRmLTgnKQoKICAgIGRlZiB3YWl0X2J1Y2tldF9leGlzdHMoc2VsZiwgYnVja2V0X25hbWUsIG1pbl9zdWNjZXNzZXM9Myk6CiAgICAgICAgY2xpZW50ID0gc2VsZi5jcmVhdGVfY2xpZW50X2Zvcl9idWNrZXQoYnVja2V0X25hbWUpCiAgICAgICAgd2FpdGVyID0gY2xpZW50LmdldF93YWl0ZXIoJ2J1Y2tldF9leGlzdHMnKQogICAgICAgIGNvbnNpc3RlbmN5X3dhaXRlciA9IENvbnNpc3RlbmN5V2FpdGVyKAogICAgICAgICAgICBtaW5fc3VjY2Vzc2VzPW1pbl9zdWNjZXNzZXMsIGRlbGF5X2luaXRpYWxfcG9sbD1UcnVlKQogICAgICAgIGNvbnNpc3RlbmN5X3dhaXRlci53YWl0KAogICAgICAgICAgICBsYW1iZGE6IHdhaXRlci53YWl0KEJ1Y2tldD1idWNrZXRfbmFtZSkgaXMgTm9uZQogICAgICAgICkKCiAgICBkZWYgYnVja2V0X25vdF9leGlzdHMoc2VsZiwgYnVja2V0X25hbWUpOgogICAgICAgIGNsaWVudCA9IHNlbGYuY3JlYXRlX2NsaWVudF9mb3JfYnVja2V0KGJ1Y2tldF9uYW1lKQogICAgICAgIHRyeToKICAgICAgICAgICAgY2xpZW50LmhlYWRfYnVja2V0KEJ1Y2tldD1idWNrZXRfbmFtZSkKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICBleGNlcHQgQ2xpZW50RXJyb3IgYXMgZXJyb3I6CiAgICAgICAgICAgIGlmIGVycm9yLnJlc3BvbnNlLmdldCgnQ29kZScpID09ICc0MDQnOgogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIHJhaXNlCgogICAgZGVmIGtleV9leGlzdHMoc2VsZiwgYnVja2V0X25hbWUsIGtleV9uYW1lLCBtaW5fc3VjY2Vzc2VzPTMpOgogICAgICAgIHRyeToKICAgICAgICAgICAgc2VsZi53YWl0X3VudGlsX2tleV9leGlzdHMoCiAgICAgICAgICAgICAgICAgICAgYnVja2V0X25hbWUsIGtleV9uYW1lLCBtaW5fc3VjY2Vzc2VzPW1pbl9zdWNjZXNzZXMpCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgZXhjZXB0IChDbGllbnRFcnJvciwgV2FpdGVyRXJyb3IpOgogICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICBkZWYga2V5X25vdF9leGlzdHMoc2VsZiwgYnVja2V0X25hbWUsIGtleV9uYW1lLCBtaW5fc3VjY2Vzc2VzPTMpOgogICAgICAgIHRyeToKICAgICAgICAgICAgc2VsZi53YWl0X3VudGlsX2tleV9ub3RfZXhpc3RzKAogICAgICAgICAgICAgICAgICAgIGJ1Y2tldF9uYW1lLCBrZXlfbmFtZSwgbWluX3N1Y2Nlc3Nlcz1taW5fc3VjY2Vzc2VzKQogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIGV4Y2VwdCAoQ2xpZW50RXJyb3IsIFdhaXRlckVycm9yKToKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgZGVmIGxpc3RfYnVja2V0cyhzZWxmKToKICAgICAgICByZXNwb25zZSA9IHNlbGYuY2xpZW50Lmxpc3RfYnVja2V0cygpCiAgICAgICAgcmV0dXJuIHJlc3BvbnNlWydCdWNrZXRzJ10KCiAgICBkZWYgY29udGVudF90eXBlX2Zvcl9rZXkoc2VsZiwgYnVja2V0X25hbWUsIGtleV9uYW1lKToKICAgICAgICBwYXJzZWQgPSBzZWxmLmhlYWRfb2JqZWN0KGJ1Y2tldF9uYW1lLCBrZXlfbmFtZSkKICAgICAgICByZXR1cm4gcGFyc2VkWydDb250ZW50VHlwZSddCgogICAgZGVmIGhlYWRfb2JqZWN0KHNlbGYsIGJ1Y2tldF9uYW1lLCBrZXlfbmFtZSk6CiAgICAgICAgY2xpZW50ID0gc2VsZi5jcmVhdGVfY2xpZW50X2Zvcl9idWNrZXQoYnVja2V0X25hbWUpCiAgICAgICAgcmVzcG9uc2UgPSBjbGllbnQuaGVhZF9vYmplY3QoQnVja2V0PWJ1Y2tldF9uYW1lLCBLZXk9a2V5X25hbWUpCiAgICAgICAgcmV0dXJuIHJlc3BvbnNlCgogICAgZGVmIHdhaXRfdW50aWxfa2V5X2V4aXN0cyhzZWxmLCBidWNrZXRfbmFtZSwga2V5X25hbWUsIGV4dHJhX3BhcmFtcz1Ob25lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtaW5fc3VjY2Vzc2VzPTMpOgogICAgICAgIHNlbGYuX3dhaXRfZm9yX2tleShidWNrZXRfbmFtZSwga2V5X25hbWUsIGV4dHJhX3BhcmFtcywKICAgICAgICAgICAgICAgICAgICAgICAgICAgbWluX3N1Y2Nlc3NlcywgZXhpc3RzPVRydWUpCgogICAgZGVmIHdhaXRfdW50aWxfa2V5X25vdF9leGlzdHMoc2VsZiwgYnVja2V0X25hbWUsIGtleV9uYW1lLCBleHRyYV9wYXJhbXM9Tm9uZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1pbl9zdWNjZXNzZXM9Myk6CiAgICAgICAgc2VsZi5fd2FpdF9mb3Jfa2V5KGJ1Y2tldF9uYW1lLCBrZXlfbmFtZSwgZXh0cmFfcGFyYW1zLAogICAgICAgICAgICAgICAgICAgICAgICAgICBtaW5fc3VjY2Vzc2VzLCBleGlzdHM9RmFsc2UpCgogICAgZGVmIF93YWl0X2Zvcl9rZXkoc2VsZiwgYnVja2V0X25hbWUsIGtleV9uYW1lLCBleHRyYV9wYXJhbXM9Tm9uZSwKICAgICAgICAgICAgICAgICAgICAgIG1pbl9zdWNjZXNzZXM9MywgZXhpc3RzPVRydWUpOgogICAgICAgIGNsaWVudCA9IHNlbGYuY3JlYXRlX2NsaWVudF9mb3JfYnVja2V0KGJ1Y2tldF9uYW1lKQogICAgICAgIGlmIGV4aXN0czoKICAgICAgICAgICAgd2FpdGVyID0gY2xpZW50LmdldF93YWl0ZXIoJ29iamVjdF9leGlzdHMnKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHdhaXRlciA9IGNsaWVudC5nZXRfd2FpdGVyKCdvYmplY3Rfbm90X2V4aXN0cycpCiAgICAgICAgcGFyYW1zID0geydCdWNrZXQnOiBidWNrZXRfbmFtZSwgJ0tleSc6IGtleV9uYW1lfQogICAgICAgIGlmIGV4dHJhX3BhcmFtcyBpcyBub3QgTm9uZToKICAgICAgICAgICAgcGFyYW1zLnVwZGF0ZShleHRyYV9wYXJhbXMpCiAgICAgICAgZm9yIF8gaW4gcmFuZ2UobWluX3N1Y2Nlc3Nlcyk6CiAgICAgICAgICAgIHdhaXRlci53YWl0KCoqcGFyYW1zKQoKICAgIGRlZiBhc3NlcnRfbm9fZXJyb3JzKHNlbGYsIHApOgogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoCiAgICAgICAgICAgIHAucmMsIDAsCiAgICAgICAgICAgICJOb24gemVybyByYyAoJXMpIHJlY2VpdmVkOiAlcyIgJSAocC5yYywgcC5zdGRvdXQgKyBwLnN0ZGVycikpCiAgICAgICAgc2VsZi5hc3NlcnROb3RJbigiRXJyb3I6IiwgcC5zdGRlcnIpCiAgICAgICAgc2VsZi5hc3NlcnROb3RJbigiZmFpbGVkOiIsIHAuc3RkZXJyKQogICAgICAgIHNlbGYuYXNzZXJ0Tm90SW4oImNsaWVudCBlcnJvciIsIHAuc3RkZXJyKQogICAgICAgIHNlbGYuYXNzZXJ0Tm90SW4oInNlcnZlciBlcnJvciIsIHAuc3RkZXJyKQoKCmNsYXNzIFN0cmluZ0lPV2l0aEZpbGVObyhTdHJpbmdJTyk6CiAgICBkZWYgZmlsZW5vKHNlbGYpOgogICAgICAgIHJldHVybiAwCgoKY2xhc3MgVGVzdEV2ZW50SGFuZGxlcihvYmplY3QpOgogICAgZGVmIF9faW5pdF9fKHNlbGYsIGhhbmRsZXI9Tm9uZSk6CiAgICAgICAgc2VsZi5faGFuZGxlciA9IGhhbmRsZXIKICAgICAgICBzZWxmLl9jYWxsZWQgPSBGYWxzZQogICAgICAgIHNlbGYuX190ZXN0X18gPSBGYWxzZQoKICAgIEBwcm9wZXJ0eQogICAgZGVmIGNhbGxlZChzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5fY2FsbGVkCgogICAgZGVmIGhhbmRsZXIoc2VsZiwgKiprd2FyZ3MpOgogICAgICAgIHNlbGYuX2NhbGxlZCA9IFRydWUKICAgICAgICBpZiBzZWxmLl9oYW5kbGVyIGlzIG5vdCBOb25lOgogICAgICAgICAgICBzZWxmLl9oYW5kbGVyKCoqa3dhcmdzKQoKCmNsYXNzIENvbnNpc3RlbmN5V2FpdGVyRXhjZXB0aW9uKEV4Y2VwdGlvbik6CiAgICBwYXNzCgoKY2xhc3MgQ29uc2lzdGVuY3lXYWl0ZXIob2JqZWN0KToKICAgICIiIgogICAgQSB3YWl0ZXIgY2xhc3MgZm9yIHNvbWUgY2hlY2sgdG8gcmVhY2ggYSBjb25zaXN0ZW50IHN0YXRlLgoKICAgIDp0eXBlIG1pbl9zdWNjZXNzZXM6IGludAogICAgOnBhcmFtIG1pbl9zdWNjZXNzZXM6IFRoZSBtaW5pbXVtIG51bWJlciBvZiBzdWNjZXNzZnVsIGNoZWNrIGNhbGxzIHRvCiAgICB0cmVhdCB0aGUgY2hlY2sgYXMgc3RhYmxlLiBEZWZhdWx0IG9mIDEgc3VjY2Vzcy4KCiAgICA6dHlwZSBtYXhfYXR0ZW1wdHM6IGludAogICAgOnBhcmFtIG1pbl9zdWNjZXNzZXM6IFRoZSBtYXhpbXVtIG51bWJlciBvZiB0aW1lcyB0byBhdHRlbXB0IGNhbGxpbmcKICAgIHRoZSBjaGVjay4gRGVmYXVsdCBvZiAyMCBhdHRlbXB0cy4KCiAgICA6dHlwZSBkZWxheTogaW50CiAgICA6cGFyYW0gZGVsYXk6IFRoZSBudW1iZXIgb2Ygc2Vjb25kcyB0byBkZWxheSB0aGUgbmV4dCBBUEkgY2FsbCBhZnRlciBhCiAgICBmYWlsZWQgY2hlY2sgY2FsbC4gRGVmYXVsdCBvZiA1IHNlY29uZHMuCiAgICAiIiIKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBtaW5fc3VjY2Vzc2VzPTEsIG1heF9hdHRlbXB0cz0yMCwgZGVsYXk9NSwKICAgICAgICAgICAgICAgICBkZWxheV9pbml0aWFsX3BvbGw9RmFsc2UpOgogICAgICAgIHNlbGYubWluX3N1Y2Nlc3NlcyA9IG1pbl9zdWNjZXNzZXMKICAgICAgICBzZWxmLm1heF9hdHRlbXB0cyA9IG1heF9hdHRlbXB0cwogICAgICAgIHNlbGYuZGVsYXkgPSBkZWxheQogICAgICAgIHNlbGYuZGVsYXlfaW5pdGlhbF9wb2xsID0gZGVsYXlfaW5pdGlhbF9wb2xsCgogICAgZGVmIHdhaXQoc2VsZiwgY2hlY2ssICphcmdzLCAqKmt3YXJncyk6CiAgICAgICAgIiIiCiAgICAgICAgV2FpdCB1bnRpbCB0aGUgY2hlY2sgc3VjY2VlZHMgdGhlIGNvbmZpZ3VyZWQgbnVtYmVyIG9mIHRpbWVzCgogICAgICAgIDp0eXBlIGNoZWNrOiBjYWxsYWJsZQogICAgICAgIDpwYXJhbSBjaGVjazogQSBjYWxsYWJsZSB0aGF0IHJldHVybnMgVHJ1ZSBvciBGYWxzZSB0byBpbmRpY2F0ZQogICAgICAgIGlmIHRoZSBjaGVjayBzdWNjZWVkZWQgb3IgZmFpbGVkLgoKICAgICAgICA6dHlwZSBhcmdzOiBsaXN0CiAgICAgICAgOnBhcmFtIGFyZ3M6IEFueSBvcmRlcmVkIGFyZ3VtZW50cyB0byBiZSBwYXNzZWQgdG8gdGhlIGNoZWNrLgoKICAgICAgICA6dHlwZSBrd2FyZ3M6IGRpY3QKICAgICAgICA6cGFyYW0ga3dhcmdzOiBBbnkga2V5d29yZCBhcmd1bWVudHMgdG8gYmUgcGFzc2VkIHRvIHRoZSBjaGVjay4KICAgICAgICAiIiIKICAgICAgICBhdHRlbXB0cyA9IDAKICAgICAgICBzdWNjZXNzZXMgPSAwCiAgICAgICAgaWYgc2VsZi5kZWxheV9pbml0aWFsX3BvbGw6CiAgICAgICAgICAgIHRpbWUuc2xlZXAoc2VsZi5kZWxheSkKICAgICAgICB3aGlsZSBhdHRlbXB0cyA8IHNlbGYubWF4X2F0dGVtcHRzOgogICAgICAgICAgICBhdHRlbXB0cyArPSAxCiAgICAgICAgICAgIGlmIGNoZWNrKCphcmdzLCAqKmt3YXJncyk6CiAgICAgICAgICAgICAgICBzdWNjZXNzZXMgKz0gMQogICAgICAgICAgICAgICAgaWYgc3VjY2Vzc2VzID49IHNlbGYubWluX3N1Y2Nlc3NlczoKICAgICAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHRpbWUuc2xlZXAoc2VsZi5kZWxheSkKICAgICAgICBmYWlsX21zZyA9IHNlbGYuX2ZhaWxfbWVzc2FnZShhdHRlbXB0cywgc3VjY2Vzc2VzKQogICAgICAgIHJhaXNlIENvbnNpc3RlbmN5V2FpdGVyRXhjZXB0aW9uKGZhaWxfbXNnKQoKICAgIGRlZiBfZmFpbF9tZXNzYWdlKHNlbGYsIGF0dGVtcHRzLCBzdWNjZXNzZXMpOgogICAgICAgIGZvcm1hdF9hcmdzID0gKGF0dGVtcHRzLCBzdWNjZXNzZXMpCiAgICAgICAgcmV0dXJuICdGYWlsZWQgYWZ0ZXIgJXMgYXR0ZW1wdHMsIG9ubHkgaGFkICVzIHN1Y2Nlc3NlcycgJSBmb3JtYXRfYXJncwo=
