statistics:
  total_files: 1
  skipped_files: 0.0
  processed_objects: 1
  malicious_objects: 0
details:
- path: .repo_cache/malicious_repos/pypi_malregistry/discord-py-v13/1.3/discord_py_v13-1.3-py3-none-any/discord-py-v13/gateway.py
  contents:
  - name: DiscordWebSocket.send
    score: 0.0
    code: |-
      async def send(self, data):
              await self._rate_limiter.block()
              self._dispatch('socket_raw_send', data)
              await self.socket.send_str(data)
    tokens: return_generator pop_top resume load_fast self load_attr _rate_limiter load_attr block call get_awaitable load_const send TO_NUMBER yield_value resume jump_backward_no_interrupt TO_NUMBER end_send pop_top load_fast self load_attr _dispatch load_const socket_raw_send load_fast data call pop_top load_fast self load_attr socket load_attr send_str load_fast data call get_awaitable load_const send TO_NUMBER yield_value resume jump_backward_no_interrupt TO_NUMBER end_send pop_top return_const None cleanup_throw jump_backward TO_NUMBER cleanup_throw jump_backward TO_NUMBER call_intrinsic_1 INTRINSIC_STOPITERATION_ERROR reraise
    hash: c45d93ebe9d9d60d9b83de20d0d5bf5ac25d70ef52ffa9530dbe327142b6f1da
sources:
  .repo_cache/malicious_repos/pypi_malregistry/discord-py-v13/1.3/discord_py_v13-1.3-py3-none-any/discord-py-v13/gateway.py: IyAtKi0gY29kaW5nOiB1dGYtOCAtKi0KCiIiIgpUaGUgTUlUIExpY2Vuc2UgKE1JVCkKCkNvcHlyaWdodCAoYykgMjAxNS1wcmVzZW50IFJhcHB0egoKUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEKY29weSBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZSAiU29mdHdhcmUiKSwKdG8gZGVhbCBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbgp0aGUgcmlnaHRzIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwKYW5kL29yIHNlbGwgY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlClNvZnR3YXJlIGlzIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6CgpUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbgphbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KClRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTCk9SIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLApGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEUKQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUgpMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORwpGUk9NLCBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSCkRFQUxJTkdTIElOIFRIRSBTT0ZUV0FSRS4KIiIiCgppbXBvcnQgYXN5bmNpbwpmcm9tIGNvbGxlY3Rpb25zIGltcG9ydCBuYW1lZHR1cGxlLCBkZXF1ZQppbXBvcnQgY29uY3VycmVudC5mdXR1cmVzCmltcG9ydCBqc29uCmltcG9ydCBsb2dnaW5nCmltcG9ydCBzdHJ1Y3QKaW1wb3J0IHN5cwppbXBvcnQgdGltZQppbXBvcnQgdGhyZWFkaW5nCmltcG9ydCB0cmFjZWJhY2sKaW1wb3J0IHpsaWIKCmltcG9ydCBhaW9odHRwCgpmcm9tIC4gaW1wb3J0IHV0aWxzCmZyb20gLmFjdGl2aXR5IGltcG9ydCBCYXNlQWN0aXZpdHkKZnJvbSAuZW51bXMgaW1wb3J0IFNwZWFraW5nU3RhdGUKZnJvbSAuZXJyb3JzIGltcG9ydCBDb25uZWN0aW9uQ2xvc2VkLCBJbnZhbGlkQXJndW1lbnQKCmxvZyA9IGxvZ2dpbmcuZ2V0TG9nZ2VyKF9fbmFtZV9fKQoKX19hbGxfXyA9ICgKICAgICdEaXNjb3JkV2ViU29ja2V0JywKICAgICdLZWVwQWxpdmVIYW5kbGVyJywKICAgICdWb2ljZUtlZXBBbGl2ZUhhbmRsZXInLAogICAgJ0Rpc2NvcmRWb2ljZVdlYlNvY2tldCcsCiAgICAnUmVjb25uZWN0V2ViU29ja2V0JywKKQoKY2xhc3MgUmVjb25uZWN0V2ViU29ja2V0KEV4Y2VwdGlvbik6CiAgICAiIiJTaWduYWxzIHRvIHNhZmVseSByZWNvbm5lY3QgdGhlIHdlYnNvY2tldC4iIiIKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBzaGFyZF9pZCwgKiwgcmVzdW1lPVRydWUpOgogICAgICAgIHNlbGYuc2hhcmRfaWQgPSBzaGFyZF9pZAogICAgICAgIHNlbGYucmVzdW1lID0gcmVzdW1lCiAgICAgICAgc2VsZi5vcCA9ICdSRVNVTUUnIGlmIHJlc3VtZSBlbHNlICdJREVOVElGWScKCmNsYXNzIFdlYlNvY2tldENsb3N1cmUoRXhjZXB0aW9uKToKICAgICIiIkFuIGV4Y2VwdGlvbiB0byBtYWtlIHVwIGZvciB0aGUgZmFjdCB0aGF0IGFpb2h0dHAgZG9lc24ndCBzaWduYWwgY2xvc3VyZS4iIiIKICAgIHBhc3MKCkV2ZW50TGlzdGVuZXIgPSBuYW1lZHR1cGxlKCdFdmVudExpc3RlbmVyJywgJ3ByZWRpY2F0ZSBldmVudCByZXN1bHQgZnV0dXJlJykKCmNsYXNzIEdhdGV3YXlSYXRlbGltaXRlcjoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBjb3VudD0xMTAsIHBlcj02MC4wKToKICAgICAgICAjIFRoZSBkZWZhdWx0IGlzIDExMCB0byBnaXZlIHJvb20gZm9yIGF0IGxlYXN0IDEwIGhlYXJ0YmVhdHMgcGVyIG1pbnV0ZQogICAgICAgIHNlbGYubWF4ID0gY291bnQKICAgICAgICBzZWxmLnJlbWFpbmluZyA9IGNvdW50CiAgICAgICAgc2VsZi53aW5kb3cgPSAwLjAKICAgICAgICBzZWxmLnBlciA9IHBlcgogICAgICAgIHNlbGYubG9jayA9IGFzeW5jaW8uTG9jaygpCiAgICAgICAgc2VsZi5zaGFyZF9pZCA9IE5vbmUKCiAgICBkZWYgaXNfcmF0ZWxpbWl0ZWQoc2VsZik6CiAgICAgICAgY3VycmVudCA9IHRpbWUudGltZSgpCiAgICAgICAgaWYgY3VycmVudCA+IHNlbGYud2luZG93ICsgc2VsZi5wZXI6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgIHJldHVybiBzZWxmLnJlbWFpbmluZyA9PSAwCgogICAgZGVmIGdldF9kZWxheShzZWxmKToKICAgICAgICBjdXJyZW50ID0gdGltZS50aW1lKCkKCiAgICAgICAgaWYgY3VycmVudCA+IHNlbGYud2luZG93ICsgc2VsZi5wZXI6CiAgICAgICAgICAgIHNlbGYucmVtYWluaW5nID0gc2VsZi5tYXgKCiAgICAgICAgaWYgc2VsZi5yZW1haW5pbmcgPT0gc2VsZi5tYXg6CiAgICAgICAgICAgIHNlbGYud2luZG93ID0gY3VycmVudAoKICAgICAgICBpZiBzZWxmLnJlbWFpbmluZyA9PSAwOgogICAgICAgICAgICByZXR1cm4gc2VsZi5wZXIgLSAoY3VycmVudCAtIHNlbGYud2luZG93KQoKICAgICAgICBzZWxmLnJlbWFpbmluZyAtPSAxCiAgICAgICAgaWYgc2VsZi5yZW1haW5pbmcgPT0gMDoKICAgICAgICAgICAgc2VsZi53aW5kb3cgPSBjdXJyZW50CgogICAgICAgIHJldHVybiAwLjAKCiAgICBhc3luYyBkZWYgYmxvY2soc2VsZik6CiAgICAgICAgYXN5bmMgd2l0aCBzZWxmLmxvY2s6CiAgICAgICAgICAgIGRlbHRhID0gc2VsZi5nZXRfZGVsYXkoKQogICAgICAgICAgICBpZiBkZWx0YToKICAgICAgICAgICAgICAgIGxvZy53YXJuaW5nKCdXZWJTb2NrZXQgaW4gc2hhcmQgSUQgJXMgaXMgcmF0ZWxpbWl0ZWQsIHdhaXRpbmcgJS4yZiBzZWNvbmRzJywgc2VsZi5zaGFyZF9pZCwgZGVsdGEpCiAgICAgICAgICAgICAgICBhd2FpdCBhc3luY2lvLnNsZWVwKGRlbHRhKQoKCmNsYXNzIEtlZXBBbGl2ZUhhbmRsZXIodGhyZWFkaW5nLlRocmVhZCk6CiAgICBkZWYgX19pbml0X18oc2VsZiwgKmFyZ3MsICoqa3dhcmdzKToKICAgICAgICB3cyA9IGt3YXJncy5wb3AoJ3dzJywgTm9uZSkKICAgICAgICBpbnRlcnZhbCA9IGt3YXJncy5wb3AoJ2ludGVydmFsJywgTm9uZSkKICAgICAgICBzaGFyZF9pZCA9IGt3YXJncy5wb3AoJ3NoYXJkX2lkJywgTm9uZSkKICAgICAgICB0aHJlYWRpbmcuVGhyZWFkLl9faW5pdF9fKHNlbGYsICphcmdzLCAqKmt3YXJncykKICAgICAgICBzZWxmLndzID0gd3MKICAgICAgICBzZWxmLl9tYWluX3RocmVhZF9pZCA9IHdzLnRocmVhZF9pZAogICAgICAgIHNlbGYuaW50ZXJ2YWwgPSBpbnRlcnZhbAogICAgICAgIHNlbGYuZGFlbW9uID0gVHJ1ZQogICAgICAgIHNlbGYuc2hhcmRfaWQgPSBzaGFyZF9pZAogICAgICAgIHNlbGYubXNnID0gJ0tlZXBpbmcgc2hhcmQgSUQgJXMgd2Vic29ja2V0IGFsaXZlIHdpdGggc2VxdWVuY2UgJXMuJwogICAgICAgIHNlbGYuYmxvY2tfbXNnID0gJ1NoYXJkIElEICVzIGhlYXJ0YmVhdCBibG9ja2VkIGZvciBtb3JlIHRoYW4gJXMgc2Vjb25kcy4nCiAgICAgICAgc2VsZi5iZWhpbmRfbXNnID0gJ0NhblwndCBrZWVwIHVwLCBzaGFyZCBJRCAlcyB3ZWJzb2NrZXQgaXMgJS4xZnMgYmVoaW5kLicKICAgICAgICBzZWxmLl9zdG9wX2V2ID0gdGhyZWFkaW5nLkV2ZW50KCkKICAgICAgICBzZWxmLl9sYXN0X2FjayA9IHRpbWUucGVyZl9jb3VudGVyKCkKICAgICAgICBzZWxmLl9sYXN0X3NlbmQgPSB0aW1lLnBlcmZfY291bnRlcigpCiAgICAgICAgc2VsZi5fbGFzdF9yZWN2ID0gdGltZS5wZXJmX2NvdW50ZXIoKQogICAgICAgIHNlbGYubGF0ZW5jeSA9IGZsb2F0KCdpbmYnKQogICAgICAgIHNlbGYuaGVhcnRiZWF0X3RpbWVvdXQgPSB3cy5fbWF4X2hlYXJ0YmVhdF90aW1lb3V0CgogICAgZGVmIHJ1bihzZWxmKToKICAgICAgICB3aGlsZSBub3Qgc2VsZi5fc3RvcF9ldi53YWl0KHNlbGYuaW50ZXJ2YWwpOgogICAgICAgICAgICBpZiBzZWxmLl9sYXN0X3JlY3YgKyBzZWxmLmhlYXJ0YmVhdF90aW1lb3V0IDwgdGltZS5wZXJmX2NvdW50ZXIoKToKICAgICAgICAgICAgICAgIGxvZy53YXJuaW5nKCJTaGFyZCBJRCAlcyBoYXMgc3RvcHBlZCByZXNwb25kaW5nIHRvIHRoZSBnYXRld2F5LiBDbG9zaW5nIGFuZCByZXN0YXJ0aW5nLiIsIHNlbGYuc2hhcmRfaWQpCiAgICAgICAgICAgICAgICBjb3JvID0gc2VsZi53cy5jbG9zZSg0MDAwKQogICAgICAgICAgICAgICAgZiA9IGFzeW5jaW8ucnVuX2Nvcm91dGluZV90aHJlYWRzYWZlKGNvcm8sIGxvb3A9c2VsZi53cy5sb29wKQoKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBmLnJlc3VsdCgpCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgICAgIGxvZy5leGNlcHRpb24oJ0FuIGVycm9yIG9jY3VycmVkIHdoaWxlIHN0b3BwaW5nIHRoZSBnYXRld2F5LiBJZ25vcmluZy4nKQogICAgICAgICAgICAgICAgZmluYWxseToKICAgICAgICAgICAgICAgICAgICBzZWxmLnN0b3AoKQogICAgICAgICAgICAgICAgICAgIHJldHVybgoKICAgICAgICAgICAgZGF0YSA9IHNlbGYuZ2V0X3BheWxvYWQoKQogICAgICAgICAgICBsb2cuZGVidWcoc2VsZi5tc2csIHNlbGYuc2hhcmRfaWQsIGRhdGFbJ2QnXSkKICAgICAgICAgICAgY29ybyA9IHNlbGYud3Muc2VuZF9oZWFydGJlYXQoZGF0YSkKICAgICAgICAgICAgZiA9IGFzeW5jaW8ucnVuX2Nvcm91dGluZV90aHJlYWRzYWZlKGNvcm8sIGxvb3A9c2VsZi53cy5sb29wKQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAjIGJsb2NrIHVudGlsIHNlbmRpbmcgaXMgY29tcGxldGUKICAgICAgICAgICAgICAgIHRvdGFsID0gMAogICAgICAgICAgICAgICAgd2hpbGUgVHJ1ZToKICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgIGYucmVzdWx0KDEwKQogICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBjb25jdXJyZW50LmZ1dHVyZXMuVGltZW91dEVycm9yOgogICAgICAgICAgICAgICAgICAgICAgICB0b3RhbCArPSAxMAogICAgICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmcmFtZSA9IHN5cy5fY3VycmVudF9mcmFtZXMoKVtzZWxmLl9tYWluX3RocmVhZF9pZF0KICAgICAgICAgICAgICAgICAgICAgICAgZXhjZXB0IEtleUVycm9yOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbXNnID0gc2VsZi5ibG9ja19tc2cKICAgICAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YWNrID0gdHJhY2ViYWNrLmZvcm1hdF9zdGFjayhmcmFtZSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1zZyA9ICclc1xuTG9vcCB0aHJlYWQgdHJhY2ViYWNrIChtb3N0IHJlY2VudCBjYWxsIGxhc3QpOlxuJXMnICUgKHNlbGYuYmxvY2tfbXNnLCAnJy5qb2luKHN0YWNrKSkKICAgICAgICAgICAgICAgICAgICAgICAgbG9nLndhcm5pbmcobXNnLCBzZWxmLnNoYXJkX2lkLCB0b3RhbCkKCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICBzZWxmLnN0b3AoKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgc2VsZi5fbGFzdF9zZW5kID0gdGltZS5wZXJmX2NvdW50ZXIoKQoKICAgIGRlZiBnZXRfcGF5bG9hZChzZWxmKToKICAgICAgICByZXR1cm4gewogICAgICAgICAgICAnb3AnOiBzZWxmLndzLkhFQVJUQkVBVCwKICAgICAgICAgICAgJ2QnOiBzZWxmLndzLnNlcXVlbmNlCiAgICAgICAgfQoKICAgIGRlZiBzdG9wKHNlbGYpOgogICAgICAgIHNlbGYuX3N0b3BfZXYuc2V0KCkKCiAgICBkZWYgdGljayhzZWxmKToKICAgICAgICBzZWxmLl9sYXN0X3JlY3YgPSB0aW1lLnBlcmZfY291bnRlcigpCgogICAgZGVmIGFjayhzZWxmKToKICAgICAgICBhY2tfdGltZSA9IHRpbWUucGVyZl9jb3VudGVyKCkKICAgICAgICBzZWxmLl9sYXN0X2FjayA9IGFja190aW1lCiAgICAgICAgc2VsZi5sYXRlbmN5ID0gYWNrX3RpbWUgLSBzZWxmLl9sYXN0X3NlbmQKICAgICAgICBpZiBzZWxmLmxhdGVuY3kgPiAxMDoKICAgICAgICAgICAgbG9nLndhcm5pbmcoc2VsZi5iZWhpbmRfbXNnLCBzZWxmLnNoYXJkX2lkLCBzZWxmLmxhdGVuY3kpCgpjbGFzcyBWb2ljZUtlZXBBbGl2ZUhhbmRsZXIoS2VlcEFsaXZlSGFuZGxlcik6CiAgICBkZWYgX19pbml0X18oc2VsZiwgKmFyZ3MsICoqa3dhcmdzKToKICAgICAgICBzdXBlcigpLl9faW5pdF9fKCphcmdzLCAqKmt3YXJncykKICAgICAgICBzZWxmLnJlY2VudF9hY2tfbGF0ZW5jaWVzID0gZGVxdWUobWF4bGVuPTIwKQogICAgICAgIHNlbGYubXNnID0gJ0tlZXBpbmcgc2hhcmQgSUQgJXMgdm9pY2Ugd2Vic29ja2V0IGFsaXZlIHdpdGggdGltZXN0YW1wICVzLicKICAgICAgICBzZWxmLmJsb2NrX21zZyA9ICdTaGFyZCBJRCAlcyB2b2ljZSBoZWFydGJlYXQgYmxvY2tlZCBmb3IgbW9yZSB0aGFuICVzIHNlY29uZHMnCiAgICAgICAgc2VsZi5iZWhpbmRfbXNnID0gJ0hpZ2ggc29ja2V0IGxhdGVuY3ksIHNoYXJkIElEICVzIGhlYXJ0YmVhdCBpcyAlLjFmcyBiZWhpbmQnCgogICAgZGVmIGdldF9wYXlsb2FkKHNlbGYpOgogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICdvcCc6IHNlbGYud3MuSEVBUlRCRUFULAogICAgICAgICAgICAnZCc6IGludCh0aW1lLnRpbWUoKSAqIDEwMDApCiAgICAgICAgfQoKICAgIGRlZiBhY2soc2VsZik6CiAgICAgICAgYWNrX3RpbWUgPSB0aW1lLnBlcmZfY291bnRlcigpCiAgICAgICAgc2VsZi5fbGFzdF9hY2sgPSBhY2tfdGltZQogICAgICAgIHNlbGYuX2xhc3RfcmVjdiA9IGFja190aW1lCiAgICAgICAgc2VsZi5sYXRlbmN5ID0gYWNrX3RpbWUgLSBzZWxmLl9sYXN0X3NlbmQKICAgICAgICBzZWxmLnJlY2VudF9hY2tfbGF0ZW5jaWVzLmFwcGVuZChzZWxmLmxhdGVuY3kpCgpjbGFzcyBEaXNjb3JkQ2xpZW50V2ViU29ja2V0UmVzcG9uc2UoYWlvaHR0cC5DbGllbnRXZWJTb2NrZXRSZXNwb25zZSk6CiAgICBhc3luYyBkZWYgY2xvc2Uoc2VsZiwgKiwgY29kZTogaW50ID0gNDAwMCwgbWVzc2FnZTogYnl0ZXMgPSBiJycpIC0+IGJvb2w6CiAgICAgICAgcmV0dXJuIGF3YWl0IHN1cGVyKCkuY2xvc2UoY29kZT1jb2RlLCBtZXNzYWdlPW1lc3NhZ2UpCgpjbGFzcyBEaXNjb3JkV2ViU29ja2V0OgogICAgIiIiSW1wbGVtZW50cyBhIFdlYlNvY2tldCBmb3IgRGlzY29yZCdzIGdhdGV3YXkgdjYuCgogICAgQXR0cmlidXRlcwogICAgLS0tLS0tLS0tLS0KICAgIERJU1BBVENICiAgICAgICAgUmVjZWl2ZSBvbmx5LiBEZW5vdGVzIGFuIGV2ZW50IHRvIGJlIHNlbnQgdG8gRGlzY29yZCwgc3VjaCBhcyBSRUFEWS4KICAgIEhFQVJUQkVBVAogICAgICAgIFdoZW4gcmVjZWl2ZWQgdGVsbHMgRGlzY29yZCB0byBrZWVwIHRoZSBjb25uZWN0aW9uIGFsaXZlLgogICAgICAgIFdoZW4gc2VudCBhc2tzIGlmIHlvdXIgY29ubmVjdGlvbiBpcyBjdXJyZW50bHkgYWxpdmUuCiAgICBJREVOVElGWQogICAgICAgIFNlbmQgb25seS4gU3RhcnRzIGEgbmV3IHNlc3Npb24uCiAgICBQUkVTRU5DRQogICAgICAgIFNlbmQgb25seS4gVXBkYXRlcyB5b3VyIHByZXNlbmNlLgogICAgVk9JQ0VfU1RBVEUKICAgICAgICBTZW5kIG9ubHkuIFN0YXJ0cyBhIG5ldyBjb25uZWN0aW9uIHRvIGEgdm9pY2UgZ3VpbGQuCiAgICBWT0lDRV9QSU5HCiAgICAgICAgU2VuZCBvbmx5LiBDaGVja3MgcGluZyB0aW1lIHRvIGEgdm9pY2UgZ3VpbGQsIGRvIG5vdCB1c2UuCiAgICBSRVNVTUUKICAgICAgICBTZW5kIG9ubHkuIFJlc3VtZXMgYW4gZXhpc3RpbmcgY29ubmVjdGlvbi4KICAgIFJFQ09OTkVDVAogICAgICAgIFJlY2VpdmUgb25seS4gVGVsbHMgdGhlIGNsaWVudCB0byByZWNvbm5lY3QgdG8gYSBuZXcgZ2F0ZXdheS4KICAgIFJFUVVFU1RfTUVNQkVSUwogICAgICAgIFNlbmQgb25seS4gQXNrcyBmb3IgdGhlIGZ1bGwgbWVtYmVyIGxpc3Qgb2YgYSBndWlsZC4KICAgIElOVkFMSURBVEVfU0VTU0lPTgogICAgICAgIFJlY2VpdmUgb25seS4gVGVsbHMgdGhlIGNsaWVudCB0byBvcHRpb25hbGx5IGludmFsaWRhdGUgdGhlIHNlc3Npb24KICAgICAgICBhbmQgSURFTlRJRlkgYWdhaW4uCiAgICBIRUxMTwogICAgICAgIFJlY2VpdmUgb25seS4gVGVsbHMgdGhlIGNsaWVudCB0aGUgaGVhcnRiZWF0IGludGVydmFsLgogICAgSEVBUlRCRUFUX0FDSwogICAgICAgIFJlY2VpdmUgb25seS4gQ29uZmlybXMgcmVjZWl2aW5nIG9mIGEgaGVhcnRiZWF0LiBOb3QgaGF2aW5nIGl0IGltcGxpZXMKICAgICAgICBhIGNvbm5lY3Rpb24gaXNzdWUuCiAgICBHVUlMRF9TWU5DCiAgICAgICAgU2VuZCBvbmx5LiBSZXF1ZXN0cyBhIGd1aWxkIHN5bmMuCiAgICBnYXRld2F5CiAgICAgICAgVGhlIGdhdGV3YXkgd2UgYXJlIGN1cnJlbnRseSBjb25uZWN0ZWQgdG8uCiAgICB0b2tlbgogICAgICAgIFRoZSBhdXRoZW50aWNhdGlvbiB0b2tlbiBmb3IgZGlzY29yZC4KICAgICIiIgoKICAgIERJU1BBVENIICAgICAgICAgICA9IDAKICAgIEhFQVJUQkVBVCAgICAgICAgICA9IDEKICAgIElERU5USUZZICAgICAgICAgICA9IDIKICAgIFBSRVNFTkNFICAgICAgICAgICA9IDMKICAgIFZPSUNFX1NUQVRFICAgICAgICA9IDQKICAgIFZPSUNFX1BJTkcgICAgICAgICA9IDUKICAgIFJFU1VNRSAgICAgICAgICAgICA9IDYKICAgIFJFQ09OTkVDVCAgICAgICAgICA9IDcKICAgIFJFUVVFU1RfTUVNQkVSUyAgICA9IDgKICAgIElOVkFMSURBVEVfU0VTU0lPTiA9IDkKICAgIEhFTExPICAgICAgICAgICAgICA9IDEwCiAgICBIRUFSVEJFQVRfQUNLICAgICAgPSAxMQogICAgR1VJTERfU1lOQyAgICAgICAgID0gMTIKCiAgICBkZWYgX19pbml0X18oc2VsZiwgc29ja2V0LCAqLCBsb29wKToKICAgICAgICBzZWxmLnNvY2tldCA9IHNvY2tldAogICAgICAgIHNlbGYubG9vcCA9IGxvb3AKCiAgICAgICAgIyBhbiBlbXB0eSBkaXNwYXRjaGVyIHRvIHByZXZlbnQgY3Jhc2hlcwogICAgICAgIHNlbGYuX2Rpc3BhdGNoID0gbGFtYmRhICphcmdzOiBOb25lCiAgICAgICAgIyBnZW5lcmljIGV2ZW50IGxpc3RlbmVycwogICAgICAgIHNlbGYuX2Rpc3BhdGNoX2xpc3RlbmVycyA9IFtdCiAgICAgICAgIyB0aGUga2VlcCBhbGl2ZQogICAgICAgIHNlbGYuX2tlZXBfYWxpdmUgPSBOb25lCiAgICAgICAgc2VsZi50aHJlYWRfaWQgPSB0aHJlYWRpbmcuZ2V0X2lkZW50KCkKCiAgICAgICAgIyB3cyByZWxhdGVkIHN0dWZmCiAgICAgICAgc2VsZi5zZXNzaW9uX2lkID0gTm9uZQogICAgICAgIHNlbGYuc2VxdWVuY2UgPSBOb25lCiAgICAgICAgc2VsZi5femxpYiA9IHpsaWIuZGVjb21wcmVzc29iaigpCiAgICAgICAgc2VsZi5fYnVmZmVyID0gYnl0ZWFycmF5KCkKICAgICAgICBzZWxmLl9jbG9zZV9jb2RlID0gTm9uZQogICAgICAgIHNlbGYuX3JhdGVfbGltaXRlciA9IEdhdGV3YXlSYXRlbGltaXRlcigpCgogICAgQHByb3BlcnR5CiAgICBkZWYgb3BlbihzZWxmKToKICAgICAgICByZXR1cm4gbm90IHNlbGYuc29ja2V0LmNsb3NlZAoKICAgIGRlZiBpc19yYXRlbGltaXRlZChzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5fcmF0ZV9saW1pdGVyLmlzX3JhdGVsaW1pdGVkKCkKCiAgICBAY2xhc3NtZXRob2QKICAgIGFzeW5jIGRlZiBmcm9tX2NsaWVudChjbHMsIGNsaWVudCwgKiwgaW5pdGlhbD1GYWxzZSwgZ2F0ZXdheT1Ob25lLCBzaGFyZF9pZD1Ob25lLCBzZXNzaW9uPU5vbmUsIHNlcXVlbmNlPU5vbmUsIHJlc3VtZT1GYWxzZSk6CiAgICAgICAgIiIiQ3JlYXRlcyBhIG1haW4gd2Vic29ja2V0IGZvciBEaXNjb3JkIGZyb20gYSA6Y2xhc3M6YENsaWVudGAuCgogICAgICAgIFRoaXMgaXMgZm9yIGludGVybmFsIHVzZSBvbmx5LgogICAgICAgICIiIgogICAgICAgIGdhdGV3YXkgPSBnYXRld2F5IG9yIGF3YWl0IGNsaWVudC5odHRwLmdldF9nYXRld2F5KCkKICAgICAgICBzb2NrZXQgPSBhd2FpdCBjbGllbnQuaHR0cC53c19jb25uZWN0KGdhdGV3YXkpCiAgICAgICAgd3MgPSBjbHMoc29ja2V0LCBsb29wPWNsaWVudC5sb29wKQoKICAgICAgICAjIGR5bmFtaWNhbGx5IGFkZCBhdHRyaWJ1dGVzIG5lZWRlZAogICAgICAgIHdzLnRva2VuID0gY2xpZW50Lmh0dHAudG9rZW4KICAgICAgICB3cy5fY29ubmVjdGlvbiA9IGNsaWVudC5fY29ubmVjdGlvbgogICAgICAgIHdzLl9kaXNjb3JkX3BhcnNlcnMgPSBjbGllbnQuX2Nvbm5lY3Rpb24ucGFyc2VycwogICAgICAgIHdzLl9kaXNwYXRjaCA9IGNsaWVudC5kaXNwYXRjaAogICAgICAgIHdzLmdhdGV3YXkgPSBnYXRld2F5CiAgICAgICAgd3MuY2FsbF9ob29rcyA9IGNsaWVudC5fY29ubmVjdGlvbi5jYWxsX2hvb2tzCiAgICAgICAgd3MuX2luaXRpYWxfaWRlbnRpZnkgPSBpbml0aWFsCiAgICAgICAgd3Muc2hhcmRfaWQgPSBzaGFyZF9pZAogICAgICAgIHdzLl9yYXRlX2xpbWl0ZXIuc2hhcmRfaWQgPSBzaGFyZF9pZAogICAgICAgIHdzLnNoYXJkX2NvdW50ID0gY2xpZW50Ll9jb25uZWN0aW9uLnNoYXJkX2NvdW50CiAgICAgICAgd3Muc2Vzc2lvbl9pZCA9IHNlc3Npb24KICAgICAgICB3cy5zZXF1ZW5jZSA9IHNlcXVlbmNlCiAgICAgICAgd3MuX21heF9oZWFydGJlYXRfdGltZW91dCA9IGNsaWVudC5fY29ubmVjdGlvbi5oZWFydGJlYXRfdGltZW91dAoKICAgICAgICBjbGllbnQuX2Nvbm5lY3Rpb24uX3VwZGF0ZV9yZWZlcmVuY2VzKHdzKQoKICAgICAgICBsb2cuZGVidWcoJ0NyZWF0ZWQgd2Vic29ja2V0IGNvbm5lY3RlZCB0byAlcycsIGdhdGV3YXkpCgogICAgICAgICMgcG9sbCBldmVudCBmb3IgT1AgSGVsbG8KICAgICAgICBhd2FpdCB3cy5wb2xsX2V2ZW50KCkKCiAgICAgICAgaWYgbm90IHJlc3VtZToKICAgICAgICAgICAgYXdhaXQgd3MuaWRlbnRpZnkoKQogICAgICAgICAgICByZXR1cm4gd3MKCiAgICAgICAgYXdhaXQgd3MucmVzdW1lKCkKICAgICAgICByZXR1cm4gd3MKCiAgICBkZWYgd2FpdF9mb3Ioc2VsZiwgZXZlbnQsIHByZWRpY2F0ZSwgcmVzdWx0PU5vbmUpOgogICAgICAgICIiIldhaXRzIGZvciBhIERJU1BBVENIJ2QgZXZlbnQgdGhhdCBtZWV0cyB0aGUgcHJlZGljYXRlLgoKICAgICAgICBQYXJhbWV0ZXJzCiAgICAgICAgLS0tLS0tLS0tLS0KICAgICAgICBldmVudDogOmNsYXNzOmBzdHJgCiAgICAgICAgICAgIFRoZSBldmVudCBuYW1lIGluIGFsbCB1cHBlciBjYXNlIHRvIHdhaXQgZm9yLgogICAgICAgIHByZWRpY2F0ZQogICAgICAgICAgICBBIGZ1bmN0aW9uIHRoYXQgdGFrZXMgYSBkYXRhIHBhcmFtZXRlciB0byBjaGVjayBmb3IgZXZlbnQKICAgICAgICAgICAgcHJvcGVydGllcy4gVGhlIGRhdGEgcGFyYW1ldGVyIGlzIHRoZSAnZCcga2V5IGluIHRoZSBKU09OIG1lc3NhZ2UuCiAgICAgICAgcmVzdWx0CiAgICAgICAgICAgIEEgZnVuY3Rpb24gdGhhdCB0YWtlcyB0aGUgc2FtZSBkYXRhIHBhcmFtZXRlciBhbmQgZXhlY3V0ZXMgdG8gc2VuZAogICAgICAgICAgICB0aGUgcmVzdWx0IHRvIHRoZSBmdXR1cmUuIElmIGBgTm9uZWBgLCByZXR1cm5zIHRoZSBkYXRhLgoKICAgICAgICBSZXR1cm5zCiAgICAgICAgLS0tLS0tLS0KICAgICAgICBhc3luY2lvLkZ1dHVyZQogICAgICAgICAgICBBIGZ1dHVyZSB0byB3YWl0IGZvci4KICAgICAgICAiIiIKCiAgICAgICAgZnV0dXJlID0gc2VsZi5sb29wLmNyZWF0ZV9mdXR1cmUoKQogICAgICAgIGVudHJ5ID0gRXZlbnRMaXN0ZW5lcihldmVudD1ldmVudCwgcHJlZGljYXRlPXByZWRpY2F0ZSwgcmVzdWx0PXJlc3VsdCwgZnV0dXJlPWZ1dHVyZSkKICAgICAgICBzZWxmLl9kaXNwYXRjaF9saXN0ZW5lcnMuYXBwZW5kKGVudHJ5KQogICAgICAgIHJldHVybiBmdXR1cmUKCiAgICBhc3luYyBkZWYgaWRlbnRpZnkoc2VsZik6CiAgICAgICAgIiIiU2VuZHMgdGhlIElERU5USUZZIHBhY2tldC4iIiIKICAgICAgICBwYXlsb2FkID0gewogICAgICAgICAgICAnb3AnOiBzZWxmLklERU5USUZZLAogICAgICAgICAgICAnZCc6IHsKICAgICAgICAgICAgICAgICd0b2tlbic6IHNlbGYudG9rZW4sCiAgICAgICAgICAgICAgICAncHJvcGVydGllcyc6IHsKICAgICAgICAgICAgICAgICAgICAnJG9zJzogc3lzLnBsYXRmb3JtLAogICAgICAgICAgICAgICAgICAgICckYnJvd3Nlcic6ICdkaXNjb3JkLnB5JywKICAgICAgICAgICAgICAgICAgICAnJGRldmljZSc6ICdkaXNjb3JkLnB5JywKICAgICAgICAgICAgICAgICAgICAnJHJlZmVycmVyJzogJycsCiAgICAgICAgICAgICAgICAgICAgJyRyZWZlcnJpbmdfZG9tYWluJzogJycKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAnY29tcHJlc3MnOiBUcnVlLAogICAgICAgICAgICAgICAgJ2xhcmdlX3RocmVzaG9sZCc6IDI1MCwKICAgICAgICAgICAgICAgICdndWlsZF9zdWJzY3JpcHRpb25zJzogc2VsZi5fY29ubmVjdGlvbi5ndWlsZF9zdWJzY3JpcHRpb25zLAogICAgICAgICAgICAgICAgJ3YnOiAzCiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmIG5vdCBzZWxmLl9jb25uZWN0aW9uLmlzX2JvdDoKICAgICAgICAgICAgcGF5bG9hZFsnZCddWydzeW5jZWRfZ3VpbGRzJ10gPSBbXQoKICAgICAgICBpZiBzZWxmLnNoYXJkX2lkIGlzIG5vdCBOb25lIGFuZCBzZWxmLnNoYXJkX2NvdW50IGlzIG5vdCBOb25lOgogICAgICAgICAgICBwYXlsb2FkWydkJ11bJ3NoYXJkJ10gPSBbc2VsZi5zaGFyZF9pZCwgc2VsZi5zaGFyZF9jb3VudF0KCiAgICAgICAgc3RhdGUgPSBzZWxmLl9jb25uZWN0aW9uCiAgICAgICAgaWYgc3RhdGUuX2FjdGl2aXR5IGlzIG5vdCBOb25lIG9yIHN0YXRlLl9zdGF0dXMgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHBheWxvYWRbJ2QnXVsncHJlc2VuY2UnXSA9IHsKICAgICAgICAgICAgICAgICdzdGF0dXMnOiBzdGF0ZS5fc3RhdHVzLAogICAgICAgICAgICAgICAgJ2dhbWUnOiBzdGF0ZS5fYWN0aXZpdHksCiAgICAgICAgICAgICAgICAnc2luY2UnOiAwLAogICAgICAgICAgICAgICAgJ2Fmayc6IEZhbHNlCiAgICAgICAgICAgIH0KCiAgICAgICAgaWYgc3RhdGUuX2ludGVudHMgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHBheWxvYWRbJ2QnXVsnaW50ZW50cyddID0gc3RhdGUuX2ludGVudHMudmFsdWUKCiAgICAgICAgYXdhaXQgc2VsZi5jYWxsX2hvb2tzKCdiZWZvcmVfaWRlbnRpZnknLCBzZWxmLnNoYXJkX2lkLCBpbml0aWFsPXNlbGYuX2luaXRpYWxfaWRlbnRpZnkpCiAgICAgICAgYXdhaXQgc2VsZi5zZW5kX2FzX2pzb24ocGF5bG9hZCkKICAgICAgICBsb2cuaW5mbygnU2hhcmQgSUQgJXMgaGFzIHNlbnQgdGhlIElERU5USUZZIHBheWxvYWQuJywgc2VsZi5zaGFyZF9pZCkKCiAgICBhc3luYyBkZWYgcmVzdW1lKHNlbGYpOgogICAgICAgICIiIlNlbmRzIHRoZSBSRVNVTUUgcGFja2V0LiIiIgogICAgICAgIHBheWxvYWQgPSB7CiAgICAgICAgICAgICdvcCc6IHNlbGYuUkVTVU1FLAogICAgICAgICAgICAnZCc6IHsKICAgICAgICAgICAgICAgICdzZXEnOiBzZWxmLnNlcXVlbmNlLAogICAgICAgICAgICAgICAgJ3Nlc3Npb25faWQnOiBzZWxmLnNlc3Npb25faWQsCiAgICAgICAgICAgICAgICAndG9rZW4nOiBzZWxmLnRva2VuCiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGF3YWl0IHNlbGYuc2VuZF9hc19qc29uKHBheWxvYWQpCiAgICAgICAgbG9nLmluZm8oJ1NoYXJkIElEICVzIGhhcyBzZW50IHRoZSBSRVNVTUUgcGF5bG9hZC4nLCBzZWxmLnNoYXJkX2lkKQoKICAgIGFzeW5jIGRlZiByZWNlaXZlZF9tZXNzYWdlKHNlbGYsIG1zZyk6CiAgICAgICAgc2VsZi5fZGlzcGF0Y2goJ3NvY2tldF9yYXdfcmVjZWl2ZScsIG1zZykKCiAgICAgICAgaWYgdHlwZShtc2cpIGlzIGJ5dGVzOgogICAgICAgICAgICBzZWxmLl9idWZmZXIuZXh0ZW5kKG1zZykKCiAgICAgICAgICAgIGlmIGxlbihtc2cpIDwgNCBvciBtc2dbLTQ6XSAhPSBiJ1x4MDBceDAwXHhmZlx4ZmYnOgogICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgIG1zZyA9IHNlbGYuX3psaWIuZGVjb21wcmVzcyhzZWxmLl9idWZmZXIpCiAgICAgICAgICAgIG1zZyA9IG1zZy5kZWNvZGUoJ3V0Zi04JykKICAgICAgICAgICAgc2VsZi5fYnVmZmVyID0gYnl0ZWFycmF5KCkKICAgICAgICBtc2cgPSBqc29uLmxvYWRzKG1zZykKCiAgICAgICAgbG9nLmRlYnVnKCdGb3IgU2hhcmQgSUQgJXM6IFdlYlNvY2tldCBFdmVudDogJXMnLCBzZWxmLnNoYXJkX2lkLCBtc2cpCiAgICAgICAgc2VsZi5fZGlzcGF0Y2goJ3NvY2tldF9yZXNwb25zZScsIG1zZykKCiAgICAgICAgb3AgPSBtc2cuZ2V0KCdvcCcpCiAgICAgICAgZGF0YSA9IG1zZy5nZXQoJ2QnKQogICAgICAgIHNlcSA9IG1zZy5nZXQoJ3MnKQogICAgICAgIGlmIHNlcSBpcyBub3QgTm9uZToKICAgICAgICAgICAgc2VsZi5zZXF1ZW5jZSA9IHNlcQoKICAgICAgICBpZiBzZWxmLl9rZWVwX2FsaXZlOgogICAgICAgICAgICBzZWxmLl9rZWVwX2FsaXZlLnRpY2soKQoKICAgICAgICBpZiBvcCAhPSBzZWxmLkRJU1BBVENIOgogICAgICAgICAgICBpZiBvcCA9PSBzZWxmLlJFQ09OTkVDVDoKICAgICAgICAgICAgICAgICMgInJlY29ubmVjdCIgY2FuIG9ubHkgYmUgaGFuZGxlZCBieSB0aGUgQ2xpZW50CiAgICAgICAgICAgICAgICAjIHNvIHdlIHRlcm1pbmF0ZSBvdXIgY29ubmVjdGlvbiBhbmQgcmFpc2UgYW4KICAgICAgICAgICAgICAgICMgaW50ZXJuYWwgZXhjZXB0aW9uIHNpZ25hbGxpbmcgdG8gcmVjb25uZWN0LgogICAgICAgICAgICAgICAgbG9nLmRlYnVnKCdSZWNlaXZlZCBSRUNPTk5FQ1Qgb3Bjb2RlLicpCiAgICAgICAgICAgICAgICBhd2FpdCBzZWxmLmNsb3NlKCkKICAgICAgICAgICAgICAgIHJhaXNlIFJlY29ubmVjdFdlYlNvY2tldChzZWxmLnNoYXJkX2lkKQoKICAgICAgICAgICAgaWYgb3AgPT0gc2VsZi5IRUFSVEJFQVRfQUNLOgogICAgICAgICAgICAgICAgaWYgc2VsZi5fa2VlcF9hbGl2ZToKICAgICAgICAgICAgICAgICAgICBzZWxmLl9rZWVwX2FsaXZlLmFjaygpCiAgICAgICAgICAgICAgICByZXR1cm4KCiAgICAgICAgICAgIGlmIG9wID09IHNlbGYuSEVBUlRCRUFUOgogICAgICAgICAgICAgICAgaWYgc2VsZi5fa2VlcF9hbGl2ZToKICAgICAgICAgICAgICAgICAgICBiZWF0ID0gc2VsZi5fa2VlcF9hbGl2ZS5nZXRfcGF5bG9hZCgpCiAgICAgICAgICAgICAgICAgICAgYXdhaXQgc2VsZi5zZW5kX2FzX2pzb24oYmVhdCkKICAgICAgICAgICAgICAgIHJldHVybgoKICAgICAgICAgICAgaWYgb3AgPT0gc2VsZi5IRUxMTzoKICAgICAgICAgICAgICAgIGludGVydmFsID0gZGF0YVsnaGVhcnRiZWF0X2ludGVydmFsJ10gLyAxMDAwLjAKICAgICAgICAgICAgICAgIHNlbGYuX2tlZXBfYWxpdmUgPSBLZWVwQWxpdmVIYW5kbGVyKHdzPXNlbGYsIGludGVydmFsPWludGVydmFsLCBzaGFyZF9pZD1zZWxmLnNoYXJkX2lkKQogICAgICAgICAgICAgICAgIyBzZW5kIGEgaGVhcnRiZWF0IGltbWVkaWF0ZWx5CiAgICAgICAgICAgICAgICBhd2FpdCBzZWxmLnNlbmRfYXNfanNvbihzZWxmLl9rZWVwX2FsaXZlLmdldF9wYXlsb2FkKCkpCiAgICAgICAgICAgICAgICBzZWxmLl9rZWVwX2FsaXZlLnN0YXJ0KCkKICAgICAgICAgICAgICAgIHJldHVybgoKICAgICAgICAgICAgaWYgb3AgPT0gc2VsZi5JTlZBTElEQVRFX1NFU1NJT046CiAgICAgICAgICAgICAgICBpZiBkYXRhIGlzIFRydWU6CiAgICAgICAgICAgICAgICAgICAgYXdhaXQgc2VsZi5jbG9zZSgpCiAgICAgICAgICAgICAgICAgICAgcmFpc2UgUmVjb25uZWN0V2ViU29ja2V0KHNlbGYuc2hhcmRfaWQpCgogICAgICAgICAgICAgICAgc2VsZi5zZXF1ZW5jZSA9IE5vbmUKICAgICAgICAgICAgICAgIHNlbGYuc2Vzc2lvbl9pZCA9IE5vbmUKICAgICAgICAgICAgICAgIGxvZy5pbmZvKCdTaGFyZCBJRCAlcyBzZXNzaW9uIGhhcyBiZWVuIGludmFsaWRhdGVkLicsIHNlbGYuc2hhcmRfaWQpCiAgICAgICAgICAgICAgICBhd2FpdCBzZWxmLmNsb3NlKGNvZGU9MTAwMCkKICAgICAgICAgICAgICAgIHJhaXNlIFJlY29ubmVjdFdlYlNvY2tldChzZWxmLnNoYXJkX2lkLCByZXN1bWU9RmFsc2UpCgogICAgICAgICAgICBsb2cud2FybmluZygnVW5rbm93biBPUCBjb2RlICVzLicsIG9wKQogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgZXZlbnQgPSBtc2cuZ2V0KCd0JykKCiAgICAgICAgaWYgZXZlbnQgPT0gJ1JFQURZJzoKICAgICAgICAgICAgc2VsZi5fdHJhY2UgPSB0cmFjZSA9IGRhdGEuZ2V0KCdfdHJhY2UnLCBbXSkKICAgICAgICAgICAgc2VsZi5zZXF1ZW5jZSA9IG1zZ1sncyddCiAgICAgICAgICAgIHNlbGYuc2Vzc2lvbl9pZCA9IGRhdGFbJ3Nlc3Npb25faWQnXQogICAgICAgICAgICAjIHBhc3MgYmFjayBzaGFyZCBJRCB0byByZWFkeSBoYW5kbGVyCiAgICAgICAgICAgIGRhdGFbJ19fc2hhcmRfaWRfXyddID0gc2VsZi5zaGFyZF9pZAogICAgICAgICAgICBsb2cuaW5mbygnU2hhcmQgSUQgJXMgaGFzIGNvbm5lY3RlZCB0byBHYXRld2F5OiAlcyAoU2Vzc2lvbiBJRDogJXMpLicsCiAgICAgICAgICAgICAgICAgICAgIHNlbGYuc2hhcmRfaWQsICcsICcuam9pbih0cmFjZSksIHNlbGYuc2Vzc2lvbl9pZCkKCiAgICAgICAgZWxpZiBldmVudCA9PSAnUkVTVU1FRCc6CiAgICAgICAgICAgIHNlbGYuX3RyYWNlID0gdHJhY2UgPSBkYXRhLmdldCgnX3RyYWNlJywgW10pCiAgICAgICAgICAgICMgcGFzcyBiYWNrIHRoZSBzaGFyZCBJRCB0byB0aGUgcmVzdW1lZCBoYW5kbGVyCiAgICAgICAgICAgIGRhdGFbJ19fc2hhcmRfaWRfXyddID0gc2VsZi5zaGFyZF9pZAogICAgICAgICAgICBsb2cuaW5mbygnU2hhcmQgSUQgJXMgaGFzIHN1Y2Nlc3NmdWxseSBSRVNVTUVEIHNlc3Npb24gJXMgdW5kZXIgdHJhY2UgJXMuJywKICAgICAgICAgICAgICAgICAgICAgc2VsZi5zaGFyZF9pZCwgc2VsZi5zZXNzaW9uX2lkLCAnLCAnLmpvaW4odHJhY2UpKQoKICAgICAgICB0cnk6CiAgICAgICAgICAgIGZ1bmMgPSBzZWxmLl9kaXNjb3JkX3BhcnNlcnNbZXZlbnRdCiAgICAgICAgZXhjZXB0IEtleUVycm9yOgogICAgICAgICAgICBsb2cuZGVidWcoJ1Vua25vd24gZXZlbnQgJXMuJywgZXZlbnQpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgZnVuYyhkYXRhKQoKICAgICAgICAjIHJlbW92ZSB0aGUgZGlzcGF0Y2hlZCBsaXN0ZW5lcnMKICAgICAgICByZW1vdmVkID0gW10KICAgICAgICBmb3IgaW5kZXgsIGVudHJ5IGluIGVudW1lcmF0ZShzZWxmLl9kaXNwYXRjaF9saXN0ZW5lcnMpOgogICAgICAgICAgICBpZiBlbnRyeS5ldmVudCAhPSBldmVudDoKICAgICAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgICAgICBmdXR1cmUgPSBlbnRyeS5mdXR1cmUKICAgICAgICAgICAgaWYgZnV0dXJlLmNhbmNlbGxlZCgpOgogICAgICAgICAgICAgICAgcmVtb3ZlZC5hcHBlbmQoaW5kZXgpCiAgICAgICAgICAgICAgICBjb250aW51ZQoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgdmFsaWQgPSBlbnRyeS5wcmVkaWNhdGUoZGF0YSkKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBleGM6CiAgICAgICAgICAgICAgICBmdXR1cmUuc2V0X2V4Y2VwdGlvbihleGMpCiAgICAgICAgICAgICAgICByZW1vdmVkLmFwcGVuZChpbmRleCkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGlmIHZhbGlkOgogICAgICAgICAgICAgICAgICAgIHJldCA9IGRhdGEgaWYgZW50cnkucmVzdWx0IGlzIE5vbmUgZWxzZSBlbnRyeS5yZXN1bHQoZGF0YSkKICAgICAgICAgICAgICAgICAgICBmdXR1cmUuc2V0X3Jlc3VsdChyZXQpCiAgICAgICAgICAgICAgICAgICAgcmVtb3ZlZC5hcHBlbmQoaW5kZXgpCgogICAgICAgIGZvciBpbmRleCBpbiByZXZlcnNlZChyZW1vdmVkKToKICAgICAgICAgICAgZGVsIHNlbGYuX2Rpc3BhdGNoX2xpc3RlbmVyc1tpbmRleF0KCiAgICBAcHJvcGVydHkKICAgIGRlZiBsYXRlbmN5KHNlbGYpOgogICAgICAgICIiIjpjbGFzczpgZmxvYXRgOiBNZWFzdXJlcyBsYXRlbmN5IGJldHdlZW4gYSBIRUFSVEJFQVQgYW5kIGEgSEVBUlRCRUFUX0FDSyBpbiBzZWNvbmRzLiIiIgogICAgICAgIGhlYXJ0YmVhdCA9IHNlbGYuX2tlZXBfYWxpdmUKICAgICAgICByZXR1cm4gZmxvYXQoJ2luZicpIGlmIGhlYXJ0YmVhdCBpcyBOb25lIGVsc2UgaGVhcnRiZWF0LmxhdGVuY3kKCiAgICBkZWYgX2Nhbl9oYW5kbGVfY2xvc2Uoc2VsZik6CiAgICAgICAgY29kZSA9IHNlbGYuX2Nsb3NlX2NvZGUgb3Igc2VsZi5zb2NrZXQuY2xvc2VfY29kZQogICAgICAgIHJldHVybiBjb2RlIG5vdCBpbiAoMTAwMCwgNDAwNCwgNDAxMCwgNDAxMSwgNDAxMiwgNDAxMywgNDAxNCkKCiAgICBhc3luYyBkZWYgcG9sbF9ldmVudChzZWxmKToKICAgICAgICAiIiJQb2xscyBmb3IgYSBESVNQQVRDSCBldmVudCBhbmQgaGFuZGxlcyB0aGUgZ2VuZXJhbCBnYXRld2F5IGxvb3AuCgogICAgICAgIFJhaXNlcwogICAgICAgIC0tLS0tLQogICAgICAgIENvbm5lY3Rpb25DbG9zZWQKICAgICAgICAgICAgVGhlIHdlYnNvY2tldCBjb25uZWN0aW9uIHdhcyB0ZXJtaW5hdGVkIGZvciB1bmhhbmRsZWQgcmVhc29ucy4KICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIG1zZyA9IGF3YWl0IHNlbGYuc29ja2V0LnJlY2VpdmUodGltZW91dD1zZWxmLl9tYXhfaGVhcnRiZWF0X3RpbWVvdXQpCiAgICAgICAgICAgIGlmIG1zZy50eXBlIGlzIGFpb2h0dHAuV1NNc2dUeXBlLlRFWFQ6CiAgICAgICAgICAgICAgICBhd2FpdCBzZWxmLnJlY2VpdmVkX21lc3NhZ2UobXNnLmRhdGEpCiAgICAgICAgICAgIGVsaWYgbXNnLnR5cGUgaXMgYWlvaHR0cC5XU01zZ1R5cGUuQklOQVJZOgogICAgICAgICAgICAgICAgYXdhaXQgc2VsZi5yZWNlaXZlZF9tZXNzYWdlKG1zZy5kYXRhKQogICAgICAgICAgICBlbGlmIG1zZy50eXBlIGlzIGFpb2h0dHAuV1NNc2dUeXBlLkVSUk9SOgogICAgICAgICAgICAgICAgbG9nLmRlYnVnKCdSZWNlaXZlZCAlcycsIG1zZykKICAgICAgICAgICAgICAgIHJhaXNlIG1zZy5kYXRhCiAgICAgICAgICAgIGVsaWYgbXNnLnR5cGUgaW4gKGFpb2h0dHAuV1NNc2dUeXBlLkNMT1NFRCwgYWlvaHR0cC5XU01zZ1R5cGUuQ0xPU0lORywgYWlvaHR0cC5XU01zZ1R5cGUuQ0xPU0UpOgogICAgICAgICAgICAgICAgbG9nLmRlYnVnKCdSZWNlaXZlZCAlcycsIG1zZykKICAgICAgICAgICAgICAgIHJhaXNlIFdlYlNvY2tldENsb3N1cmUKICAgICAgICBleGNlcHQgKGFzeW5jaW8uVGltZW91dEVycm9yLCBXZWJTb2NrZXRDbG9zdXJlKSBhcyBlOgogICAgICAgICAgICAjIEVuc3VyZSB0aGUga2VlcCBhbGl2ZSBoYW5kbGVyIGlzIGNsb3NlZAogICAgICAgICAgICBpZiBzZWxmLl9rZWVwX2FsaXZlOgogICAgICAgICAgICAgICAgc2VsZi5fa2VlcF9hbGl2ZS5zdG9wKCkKICAgICAgICAgICAgICAgIHNlbGYuX2tlZXBfYWxpdmUgPSBOb25lCgogICAgICAgICAgICBpZiBpc2luc3RhbmNlKGUsIGFzeW5jaW8uVGltZW91dEVycm9yKToKICAgICAgICAgICAgICAgIGxvZy5pbmZvKCdUaW1lZCBvdXQgcmVjZWl2aW5nIHBhY2tldC4gQXR0ZW1wdGluZyBhIHJlY29ubmVjdC4nKQogICAgICAgICAgICAgICAgcmFpc2UgUmVjb25uZWN0V2ViU29ja2V0KHNlbGYuc2hhcmRfaWQpIGZyb20gTm9uZQoKICAgICAgICAgICAgY29kZSA9IHNlbGYuX2Nsb3NlX2NvZGUgb3Igc2VsZi5zb2NrZXQuY2xvc2VfY29kZQogICAgICAgICAgICBpZiBzZWxmLl9jYW5faGFuZGxlX2Nsb3NlKCk6CiAgICAgICAgICAgICAgICBsb2cuaW5mbygnV2Vic29ja2V0IGNsb3NlZCB3aXRoICVzLCBhdHRlbXB0aW5nIGEgcmVjb25uZWN0LicsIGNvZGUpCiAgICAgICAgICAgICAgICByYWlzZSBSZWNvbm5lY3RXZWJTb2NrZXQoc2VsZi5zaGFyZF9pZCkgZnJvbSBOb25lCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBsb2cuaW5mbygnV2Vic29ja2V0IGNsb3NlZCB3aXRoICVzLCBjYW5ub3QgcmVjb25uZWN0LicsIGNvZGUpCiAgICAgICAgICAgICAgICByYWlzZSBDb25uZWN0aW9uQ2xvc2VkKHNlbGYuc29ja2V0LCBzaGFyZF9pZD1zZWxmLnNoYXJkX2lkLCBjb2RlPWNvZGUpIGZyb20gTm9uZQoKICAgIGFzeW5jIGRlZiBzZW5kKHNlbGYsIGRhdGEpOgogICAgICAgIGF3YWl0IHNlbGYuX3JhdGVfbGltaXRlci5ibG9jaygpCiAgICAgICAgc2VsZi5fZGlzcGF0Y2goJ3NvY2tldF9yYXdfc2VuZCcsIGRhdGEpCiAgICAgICAgYXdhaXQgc2VsZi5zb2NrZXQuc2VuZF9zdHIoZGF0YSkKCiAgICBhc3luYyBkZWYgc2VuZF9hc19qc29uKHNlbGYsIGRhdGEpOgogICAgICAgIHRyeToKICAgICAgICAgICAgYXdhaXQgc2VsZi5zZW5kKHV0aWxzLnRvX2pzb24oZGF0YSkpCiAgICAgICAgZXhjZXB0IFJ1bnRpbWVFcnJvciBhcyBleGM6CiAgICAgICAgICAgIGlmIG5vdCBzZWxmLl9jYW5faGFuZGxlX2Nsb3NlKCk6CiAgICAgICAgICAgICAgICByYWlzZSBDb25uZWN0aW9uQ2xvc2VkKHNlbGYuc29ja2V0LCBzaGFyZF9pZD1zZWxmLnNoYXJkX2lkKSBmcm9tIGV4YwoKICAgIGFzeW5jIGRlZiBzZW5kX2hlYXJ0YmVhdChzZWxmLCBkYXRhKToKICAgICAgICAjIFRoaXMgYnlwYXNzZXMgdGhlIHJhdGUgbGltaXQgaGFuZGxpbmcgY29kZSBzaW5jZSBpdCBoYXMgYSBoaWdoZXIgcHJpb3JpdHkKICAgICAgICB0cnk6CiAgICAgICAgICAgIGF3YWl0IHNlbGYuc29ja2V0LnNlbmRfc3RyKHV0aWxzLnRvX2pzb24oZGF0YSkpCiAgICAgICAgZXhjZXB0IFJ1bnRpbWVFcnJvciBhcyBleGM6CiAgICAgICAgICAgIGlmIG5vdCBzZWxmLl9jYW5faGFuZGxlX2Nsb3NlKCk6CiAgICAgICAgICAgICAgICByYWlzZSBDb25uZWN0aW9uQ2xvc2VkKHNlbGYuc29ja2V0LCBzaGFyZF9pZD1zZWxmLnNoYXJkX2lkKSBmcm9tIGV4YwoKICAgIGFzeW5jIGRlZiBjaGFuZ2VfcHJlc2VuY2Uoc2VsZiwgKiwgYWN0aXZpdHk9Tm9uZSwgc3RhdHVzPU5vbmUsIGFmaz1GYWxzZSwgc2luY2U9MC4wKToKICAgICAgICBpZiBhY3Rpdml0eSBpcyBub3QgTm9uZToKICAgICAgICAgICAgaWYgbm90IGlzaW5zdGFuY2UoYWN0aXZpdHksIEJhc2VBY3Rpdml0eSk6CiAgICAgICAgICAgICAgICByYWlzZSBJbnZhbGlkQXJndW1lbnQoJ2FjdGl2aXR5IG11c3QgZGVyaXZlIGZyb20gQmFzZUFjdGl2aXR5LicpCiAgICAgICAgICAgIGFjdGl2aXR5ID0gYWN0aXZpdHkudG9fZGljdCgpCgogICAgICAgIGlmIHN0YXR1cyA9PSAnaWRsZSc6CiAgICAgICAgICAgIHNpbmNlID0gaW50KHRpbWUudGltZSgpICogMTAwMCkKCiAgICAgICAgcGF5bG9hZCA9IHsKICAgICAgICAgICAgJ29wJzogc2VsZi5QUkVTRU5DRSwKICAgICAgICAgICAgJ2QnOiB7CiAgICAgICAgICAgICAgICAnZ2FtZSc6IGFjdGl2aXR5LAogICAgICAgICAgICAgICAgJ2Fmayc6IGFmaywKICAgICAgICAgICAgICAgICdzaW5jZSc6IHNpbmNlLAogICAgICAgICAgICAgICAgJ3N0YXR1cyc6IHN0YXR1cwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBzZW50ID0gdXRpbHMudG9fanNvbihwYXlsb2FkKQogICAgICAgIGxvZy5kZWJ1ZygnU2VuZGluZyAiJXMiIHRvIGNoYW5nZSBzdGF0dXMnLCBzZW50KQogICAgICAgIGF3YWl0IHNlbGYuc2VuZChzZW50KQoKICAgIGFzeW5jIGRlZiByZXF1ZXN0X3N5bmMoc2VsZiwgZ3VpbGRfaWRzKToKICAgICAgICBwYXlsb2FkID0gewogICAgICAgICAgICAnb3AnOiBzZWxmLkdVSUxEX1NZTkMsCiAgICAgICAgICAgICdkJzogbGlzdChndWlsZF9pZHMpCiAgICAgICAgfQogICAgICAgIGF3YWl0IHNlbGYuc2VuZF9hc19qc29uKHBheWxvYWQpCgogICAgYXN5bmMgZGVmIHJlcXVlc3RfY2h1bmtzKHNlbGYsIGd1aWxkX2lkLCBxdWVyeT1Ob25lLCAqLCBsaW1pdCwgdXNlcl9pZHM9Tm9uZSwgcHJlc2VuY2VzPUZhbHNlLCBub25jZT1Ob25lKToKICAgICAgICBwYXlsb2FkID0gewogICAgICAgICAgICAnb3AnOiBzZWxmLlJFUVVFU1RfTUVNQkVSUywKICAgICAgICAgICAgJ2QnOiB7CiAgICAgICAgICAgICAgICAnZ3VpbGRfaWQnOiBndWlsZF9pZCwKICAgICAgICAgICAgICAgICdwcmVzZW5jZXMnOiBwcmVzZW5jZXMsCiAgICAgICAgICAgICAgICAnbGltaXQnOiBsaW1pdAogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiBub25jZToKICAgICAgICAgICAgcGF5bG9hZFsnZCddWydub25jZSddID0gbm9uY2UKCiAgICAgICAgaWYgdXNlcl9pZHM6CiAgICAgICAgICAgIHBheWxvYWRbJ2QnXVsndXNlcl9pZHMnXSA9IHVzZXJfaWRzCgogICAgICAgIGlmIHF1ZXJ5IGlzIG5vdCBOb25lOgogICAgICAgICAgICBwYXlsb2FkWydkJ11bJ3F1ZXJ5J10gPSBxdWVyeQoKCiAgICAgICAgYXdhaXQgc2VsZi5zZW5kX2FzX2pzb24ocGF5bG9hZCkKCiAgICBhc3luYyBkZWYgdm9pY2Vfc3RhdGUoc2VsZiwgZ3VpbGRfaWQsIGNoYW5uZWxfaWQsIHNlbGZfbXV0ZT1GYWxzZSwgc2VsZl9kZWFmPUZhbHNlKToKICAgICAgICBwYXlsb2FkID0gewogICAgICAgICAgICAnb3AnOiBzZWxmLlZPSUNFX1NUQVRFLAogICAgICAgICAgICAnZCc6IHsKICAgICAgICAgICAgICAgICdndWlsZF9pZCc6IGd1aWxkX2lkLAogICAgICAgICAgICAgICAgJ2NoYW5uZWxfaWQnOiBjaGFubmVsX2lkLAogICAgICAgICAgICAgICAgJ3NlbGZfbXV0ZSc6IHNlbGZfbXV0ZSwKICAgICAgICAgICAgICAgICdzZWxmX2RlYWYnOiBzZWxmX2RlYWYKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgbG9nLmRlYnVnKCdVcGRhdGluZyBvdXIgdm9pY2Ugc3RhdGUgdG8gJXMuJywgcGF5bG9hZCkKICAgICAgICBhd2FpdCBzZWxmLnNlbmRfYXNfanNvbihwYXlsb2FkKQoKICAgIGFzeW5jIGRlZiBjbG9zZShzZWxmLCBjb2RlPTQwMDApOgogICAgICAgIGlmIHNlbGYuX2tlZXBfYWxpdmU6CiAgICAgICAgICAgIHNlbGYuX2tlZXBfYWxpdmUuc3RvcCgpCiAgICAgICAgICAgIHNlbGYuX2tlZXBfYWxpdmUgPSBOb25lCgogICAgICAgIHNlbGYuX2Nsb3NlX2NvZGUgPSBjb2RlCiAgICAgICAgYXdhaXQgc2VsZi5zb2NrZXQuY2xvc2UoY29kZT1jb2RlKQoKY2xhc3MgRGlzY29yZFZvaWNlV2ViU29ja2V0OgogICAgIiIiSW1wbGVtZW50cyB0aGUgd2Vic29ja2V0IHByb3RvY29sIGZvciBoYW5kbGluZyB2b2ljZSBjb25uZWN0aW9ucy4KCiAgICBBdHRyaWJ1dGVzCiAgICAtLS0tLS0tLS0tLQogICAgSURFTlRJRlkKICAgICAgICBTZW5kIG9ubHkuIFN0YXJ0cyBhIG5ldyB2b2ljZSBzZXNzaW9uLgogICAgU0VMRUNUX1BST1RPQ09MCiAgICAgICAgU2VuZCBvbmx5LiBUZWxscyBkaXNjb3JkIHdoYXQgZW5jcnlwdGlvbiBtb2RlIGFuZCBob3cgdG8gY29ubmVjdCBmb3Igdm9pY2UuCiAgICBSRUFEWQogICAgICAgIFJlY2VpdmUgb25seS4gVGVsbHMgdGhlIHdlYnNvY2tldCB0aGF0IHRoZSBpbml0aWFsIGNvbm5lY3Rpb24gaGFzIGNvbXBsZXRlZC4KICAgIEhFQVJUQkVBVAogICAgICAgIFNlbmQgb25seS4gS2VlcHMgeW91ciB3ZWJzb2NrZXQgY29ubmVjdGlvbiBhbGl2ZS4KICAgIFNFU1NJT05fREVTQ1JJUFRJT04KICAgICAgICBSZWNlaXZlIG9ubHkuIEdpdmVzIHlvdSB0aGUgc2VjcmV0IGtleSByZXF1aXJlZCBmb3Igdm9pY2UuCiAgICBTUEVBS0lORwogICAgICAgIFNlbmQgb25seS4gTm90aWZpZXMgdGhlIGNsaWVudCBpZiB5b3UgYXJlIGN1cnJlbnRseSBzcGVha2luZy4KICAgIEhFQVJUQkVBVF9BQ0sKICAgICAgICBSZWNlaXZlIG9ubHkuIFRlbGxzIHlvdSB5b3VyIGhlYXJ0YmVhdCBoYXMgYmVlbiBhY2tub3dsZWRnZWQuCiAgICBSRVNVTUUKICAgICAgICBTZW50IG9ubHkuIFRlbGxzIHRoZSBjbGllbnQgdG8gcmVzdW1lIGl0cyBzZXNzaW9uLgogICAgSEVMTE8KICAgICAgICBSZWNlaXZlIG9ubHkuIFRlbGxzIHlvdSB0aGF0IHlvdXIgd2Vic29ja2V0IGNvbm5lY3Rpb24gd2FzIGFja25vd2xlZGdlZC4KICAgIFJFU1VNRUQKICAgICAgICBTZW50IG9ubHkuIFRlbGxzIHlvdSB0aGF0IHlvdXIgUkVTVU1FIHJlcXVlc3QgaGFzIHN1Y2NlZWRlZC4KICAgIENMSUVOVF9DT05ORUNUCiAgICAgICAgSW5kaWNhdGVzIGEgdXNlciBoYXMgY29ubmVjdGVkIHRvIHZvaWNlLgogICAgQ0xJRU5UX0RJU0NPTk5FQ1QKICAgICAgICBSZWNlaXZlIG9ubHkuICBJbmRpY2F0ZXMgYSB1c2VyIGhhcyBkaXNjb25uZWN0ZWQgZnJvbSB2b2ljZS4KICAgICIiIgoKICAgIElERU5USUZZICAgICAgICAgICAgPSAwCiAgICBTRUxFQ1RfUFJPVE9DT0wgICAgID0gMQogICAgUkVBRFkgICAgICAgICAgICAgICA9IDIKICAgIEhFQVJUQkVBVCAgICAgICAgICAgPSAzCiAgICBTRVNTSU9OX0RFU0NSSVBUSU9OID0gNAogICAgU1BFQUtJTkcgICAgICAgICAgICA9IDUKICAgIEhFQVJUQkVBVF9BQ0sgICAgICAgPSA2CiAgICBSRVNVTUUgICAgICAgICAgICAgID0gNwogICAgSEVMTE8gICAgICAgICAgICAgICA9IDgKICAgIFJFU1VNRUQgICAgICAgICAgICAgPSA5CiAgICBDTElFTlRfQ09OTkVDVCAgICAgID0gMTIKICAgIENMSUVOVF9ESVNDT05ORUNUICAgPSAxMwoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBzb2NrZXQsIGxvb3ApOgogICAgICAgIHNlbGYud3MgPSBzb2NrZXQKICAgICAgICBzZWxmLmxvb3AgPSBsb29wCiAgICAgICAgc2VsZi5fa2VlcF9hbGl2ZSA9IE5vbmUKICAgICAgICBzZWxmLl9jbG9zZV9jb2RlID0gTm9uZQogICAgICAgIHNlbGYuc2VjcmV0X2tleSA9IE5vbmUKCiAgICBhc3luYyBkZWYgc2VuZF9hc19qc29uKHNlbGYsIGRhdGEpOgogICAgICAgIGxvZy5kZWJ1ZygnU2VuZGluZyB2b2ljZSB3ZWJzb2NrZXQgZnJhbWU6ICVzLicsIGRhdGEpCiAgICAgICAgYXdhaXQgc2VsZi53cy5zZW5kX3N0cih1dGlscy50b19qc29uKGRhdGEpKQoKICAgIHNlbmRfaGVhcnRiZWF0ID0gc2VuZF9hc19qc29uCgogICAgYXN5bmMgZGVmIHJlc3VtZShzZWxmKToKICAgICAgICBzdGF0ZSA9IHNlbGYuX2Nvbm5lY3Rpb24KICAgICAgICBwYXlsb2FkID0gewogICAgICAgICAgICAnb3AnOiBzZWxmLlJFU1VNRSwKICAgICAgICAgICAgJ2QnOiB7CiAgICAgICAgICAgICAgICAndG9rZW4nOiBzdGF0ZS50b2tlbiwKICAgICAgICAgICAgICAgICdzZXJ2ZXJfaWQnOiBzdHIoc3RhdGUuc2VydmVyX2lkKSwKICAgICAgICAgICAgICAgICdzZXNzaW9uX2lkJzogc3RhdGUuc2Vzc2lvbl9pZAogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGF3YWl0IHNlbGYuc2VuZF9hc19qc29uKHBheWxvYWQpCgogICAgYXN5bmMgZGVmIGlkZW50aWZ5KHNlbGYpOgogICAgICAgIHN0YXRlID0gc2VsZi5fY29ubmVjdGlvbgogICAgICAgIHBheWxvYWQgPSB7CiAgICAgICAgICAgICdvcCc6IHNlbGYuSURFTlRJRlksCiAgICAgICAgICAgICdkJzogewogICAgICAgICAgICAgICAgJ3NlcnZlcl9pZCc6IHN0cihzdGF0ZS5zZXJ2ZXJfaWQpLAogICAgICAgICAgICAgICAgJ3VzZXJfaWQnOiBzdHIoc3RhdGUudXNlci5pZCksCiAgICAgICAgICAgICAgICAnc2Vzc2lvbl9pZCc6IHN0YXRlLnNlc3Npb25faWQsCiAgICAgICAgICAgICAgICAndG9rZW4nOiBzdGF0ZS50b2tlbgogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGF3YWl0IHNlbGYuc2VuZF9hc19qc29uKHBheWxvYWQpCgogICAgQGNsYXNzbWV0aG9kCiAgICBhc3luYyBkZWYgZnJvbV9jbGllbnQoY2xzLCBjbGllbnQsICosIHJlc3VtZT1GYWxzZSk6CiAgICAgICAgIiIiQ3JlYXRlcyBhIHZvaWNlIHdlYnNvY2tldCBmb3IgdGhlIDpjbGFzczpgVm9pY2VDbGllbnRgLiIiIgogICAgICAgIGdhdGV3YXkgPSAnd3NzOi8vJyArIGNsaWVudC5lbmRwb2ludCArICcvP3Y9NCcKICAgICAgICBodHRwID0gY2xpZW50Ll9zdGF0ZS5odHRwCiAgICAgICAgc29ja2V0ID0gYXdhaXQgaHR0cC53c19jb25uZWN0KGdhdGV3YXksIGNvbXByZXNzPTE1KQogICAgICAgIHdzID0gY2xzKHNvY2tldCwgbG9vcD1jbGllbnQubG9vcCkKICAgICAgICB3cy5nYXRld2F5ID0gZ2F0ZXdheQogICAgICAgIHdzLl9jb25uZWN0aW9uID0gY2xpZW50CiAgICAgICAgd3MuX21heF9oZWFydGJlYXRfdGltZW91dCA9IDYwLjAKICAgICAgICB3cy50aHJlYWRfaWQgPSB0aHJlYWRpbmcuZ2V0X2lkZW50KCkKCiAgICAgICAgaWYgcmVzdW1lOgogICAgICAgICAgICBhd2FpdCB3cy5yZXN1bWUoKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGF3YWl0IHdzLmlkZW50aWZ5KCkKCiAgICAgICAgcmV0dXJuIHdzCgogICAgYXN5bmMgZGVmIHNlbGVjdF9wcm90b2NvbChzZWxmLCBpcCwgcG9ydCwgbW9kZSk6CiAgICAgICAgcGF5bG9hZCA9IHsKICAgICAgICAgICAgJ29wJzogc2VsZi5TRUxFQ1RfUFJPVE9DT0wsCiAgICAgICAgICAgICdkJzogewogICAgICAgICAgICAgICAgJ3Byb3RvY29sJzogJ3VkcCcsCiAgICAgICAgICAgICAgICAnZGF0YSc6IHsKICAgICAgICAgICAgICAgICAgICAnYWRkcmVzcyc6IGlwLAogICAgICAgICAgICAgICAgICAgICdwb3J0JzogcG9ydCwKICAgICAgICAgICAgICAgICAgICAnbW9kZSc6IG1vZGUKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgYXdhaXQgc2VsZi5zZW5kX2FzX2pzb24ocGF5bG9hZCkKCiAgICBhc3luYyBkZWYgY2xpZW50X2Nvbm5lY3Qoc2VsZik6CiAgICAgICAgcGF5bG9hZCA9IHsKICAgICAgICAgICAgJ29wJzogc2VsZi5DTElFTlRfQ09OTkVDVCwKICAgICAgICAgICAgJ2QnOiB7CiAgICAgICAgICAgICAgICAnYXVkaW9fc3NyYyc6IHNlbGYuX2Nvbm5lY3Rpb24uc3NyYwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBhd2FpdCBzZWxmLnNlbmRfYXNfanNvbihwYXlsb2FkKQoKICAgIGFzeW5jIGRlZiBzcGVhayhzZWxmLCBzdGF0ZT1TcGVha2luZ1N0YXRlLnZvaWNlKToKICAgICAgICBwYXlsb2FkID0gewogICAgICAgICAgICAnb3AnOiBzZWxmLlNQRUFLSU5HLAogICAgICAgICAgICAnZCc6IHsKICAgICAgICAgICAgICAgICdzcGVha2luZyc6IGludChzdGF0ZSksCiAgICAgICAgICAgICAgICAnZGVsYXknOiAwCiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGF3YWl0IHNlbGYuc2VuZF9hc19qc29uKHBheWxvYWQpCgogICAgYXN5bmMgZGVmIHJlY2VpdmVkX21lc3NhZ2Uoc2VsZiwgbXNnKToKICAgICAgICBsb2cuZGVidWcoJ1ZvaWNlIHdlYnNvY2tldCBmcmFtZSByZWNlaXZlZDogJXMnLCBtc2cpCiAgICAgICAgb3AgPSBtc2dbJ29wJ10KICAgICAgICBkYXRhID0gbXNnLmdldCgnZCcpCgogICAgICAgIGlmIG9wID09IHNlbGYuUkVBRFk6CiAgICAgICAgICAgIGF3YWl0IHNlbGYuaW5pdGlhbF9jb25uZWN0aW9uKGRhdGEpCiAgICAgICAgZWxpZiBvcCA9PSBzZWxmLkhFQVJUQkVBVF9BQ0s6CiAgICAgICAgICAgIHNlbGYuX2tlZXBfYWxpdmUuYWNrKCkKICAgICAgICBlbGlmIG9wID09IHNlbGYuUkVTVU1FRDoKICAgICAgICAgICAgbG9nLmluZm8oJ1ZvaWNlIFJFU1VNRSBzdWNjZWVkZWQuJykKICAgICAgICBlbGlmIG9wID09IHNlbGYuU0VTU0lPTl9ERVNDUklQVElPTjoKICAgICAgICAgICAgc2VsZi5fY29ubmVjdGlvbi5tb2RlID0gZGF0YVsnbW9kZSddCiAgICAgICAgICAgIGF3YWl0IHNlbGYubG9hZF9zZWNyZXRfa2V5KGRhdGEpCiAgICAgICAgZWxpZiBvcCA9PSBzZWxmLkhFTExPOgogICAgICAgICAgICBpbnRlcnZhbCA9IGRhdGFbJ2hlYXJ0YmVhdF9pbnRlcnZhbCddIC8gMTAwMC4wCiAgICAgICAgICAgIHNlbGYuX2tlZXBfYWxpdmUgPSBWb2ljZUtlZXBBbGl2ZUhhbmRsZXIod3M9c2VsZiwgaW50ZXJ2YWw9bWluKGludGVydmFsLCA1LjApKQogICAgICAgICAgICBzZWxmLl9rZWVwX2FsaXZlLnN0YXJ0KCkKCiAgICBhc3luYyBkZWYgaW5pdGlhbF9jb25uZWN0aW9uKHNlbGYsIGRhdGEpOgogICAgICAgIHN0YXRlID0gc2VsZi5fY29ubmVjdGlvbgogICAgICAgIHN0YXRlLnNzcmMgPSBkYXRhWydzc3JjJ10KICAgICAgICBzdGF0ZS52b2ljZV9wb3J0ID0gZGF0YVsncG9ydCddCiAgICAgICAgc3RhdGUuZW5kcG9pbnRfaXAgPSBkYXRhWydpcCddCgogICAgICAgIHBhY2tldCA9IGJ5dGVhcnJheSg3MCkKICAgICAgICBzdHJ1Y3QucGFja19pbnRvKCc+SCcsIHBhY2tldCwgMCwgMSkgIyAxID0gU2VuZAogICAgICAgIHN0cnVjdC5wYWNrX2ludG8oJz5IJywgcGFja2V0LCAyLCA3MCkgIyA3MCA9IExlbmd0aAogICAgICAgIHN0cnVjdC5wYWNrX2ludG8oJz5JJywgcGFja2V0LCA0LCBzdGF0ZS5zc3JjKQogICAgICAgIHN0YXRlLnNvY2tldC5zZW5kdG8ocGFja2V0LCAoc3RhdGUuZW5kcG9pbnRfaXAsIHN0YXRlLnZvaWNlX3BvcnQpKQogICAgICAgIHJlY3YgPSBhd2FpdCBzZWxmLmxvb3Auc29ja19yZWN2KHN0YXRlLnNvY2tldCwgNzApCiAgICAgICAgbG9nLmRlYnVnKCdyZWNlaXZlZCBwYWNrZXQgaW4gaW5pdGlhbF9jb25uZWN0aW9uOiAlcycsIHJlY3YpCgogICAgICAgICMgdGhlIGlwIGlzIGFzY2lpIHN0YXJ0aW5nIGF0IHRoZSA0dGggYnl0ZSBhbmQgZW5kaW5nIGF0IHRoZSBmaXJzdCBudWxsCiAgICAgICAgaXBfc3RhcnQgPSA0CiAgICAgICAgaXBfZW5kID0gcmVjdi5pbmRleCgwLCBpcF9zdGFydCkKICAgICAgICBzdGF0ZS5pcCA9IHJlY3ZbaXBfc3RhcnQ6aXBfZW5kXS5kZWNvZGUoJ2FzY2lpJykKCiAgICAgICAgc3RhdGUucG9ydCA9IHN0cnVjdC51bnBhY2tfZnJvbSgnPkgnLCByZWN2LCBsZW4ocmVjdikgLSAyKVswXQogICAgICAgIGxvZy5kZWJ1ZygnZGV0ZWN0ZWQgaXA6ICVzIHBvcnQ6ICVzJywgc3RhdGUuaXAsIHN0YXRlLnBvcnQpCgogICAgICAgICMgdGhlcmUgKnNob3VsZCogYWx3YXlzIGJlIGF0IGxlYXN0IG9uZSBzdXBwb3J0ZWQgbW9kZSAoeHNhbHNhMjBfcG9seTEzMDUpCiAgICAgICAgbW9kZXMgPSBbbW9kZSBmb3IgbW9kZSBpbiBkYXRhWydtb2RlcyddIGlmIG1vZGUgaW4gc2VsZi5fY29ubmVjdGlvbi5zdXBwb3J0ZWRfbW9kZXNdCiAgICAgICAgbG9nLmRlYnVnKCdyZWNlaXZlZCBzdXBwb3J0ZWQgZW5jcnlwdGlvbiBtb2RlczogJXMnLCAiLCAiLmpvaW4obW9kZXMpKQoKICAgICAgICBtb2RlID0gbW9kZXNbMF0KICAgICAgICBhd2FpdCBzZWxmLnNlbGVjdF9wcm90b2NvbChzdGF0ZS5pcCwgc3RhdGUucG9ydCwgbW9kZSkKICAgICAgICBsb2cuaW5mbygnc2VsZWN0ZWQgdGhlIHZvaWNlIHByb3RvY29sIGZvciB1c2UgKCVzKScsIG1vZGUpCgogICAgQHByb3BlcnR5CiAgICBkZWYgbGF0ZW5jeShzZWxmKToKICAgICAgICAiIiI6Y2xhc3M6YGZsb2F0YDogTGF0ZW5jeSBiZXR3ZWVuIGEgSEVBUlRCRUFUIGFuZCBpdHMgSEVBUlRCRUFUX0FDSyBpbiBzZWNvbmRzLiIiIgogICAgICAgIGhlYXJ0YmVhdCA9IHNlbGYuX2tlZXBfYWxpdmUKICAgICAgICByZXR1cm4gZmxvYXQoJ2luZicpIGlmIGhlYXJ0YmVhdCBpcyBOb25lIGVsc2UgaGVhcnRiZWF0LmxhdGVuY3kKCiAgICBAcHJvcGVydHkKICAgIGRlZiBhdmVyYWdlX2xhdGVuY3koc2VsZik6CiAgICAgICAgIiIiOmNsYXNzOmBsaXN0YDogQXZlcmFnZSBvZiBsYXN0IDIwIEhFQVJUQkVBVCBsYXRlbmNpZXMuIiIiCiAgICAgICAgaGVhcnRiZWF0ID0gc2VsZi5fa2VlcF9hbGl2ZQogICAgICAgIGlmIGhlYXJ0YmVhdCBpcyBOb25lIG9yIG5vdCBoZWFydGJlYXQucmVjZW50X2Fja19sYXRlbmNpZXM6CiAgICAgICAgICAgIHJldHVybiBmbG9hdCgnaW5mJykKCiAgICAgICAgcmV0dXJuIHN1bShoZWFydGJlYXQucmVjZW50X2Fja19sYXRlbmNpZXMpIC8gbGVuKGhlYXJ0YmVhdC5yZWNlbnRfYWNrX2xhdGVuY2llcykKCiAgICBhc3luYyBkZWYgbG9hZF9zZWNyZXRfa2V5KHNlbGYsIGRhdGEpOgogICAgICAgIGxvZy5pbmZvKCdyZWNlaXZlZCBzZWNyZXQga2V5IGZvciB2b2ljZSBjb25uZWN0aW9uJykKICAgICAgICBzZWxmLnNlY3JldF9rZXkgPSBzZWxmLl9jb25uZWN0aW9uLnNlY3JldF9rZXkgPSBkYXRhLmdldCgnc2VjcmV0X2tleScpCiAgICAgICAgYXdhaXQgc2VsZi5zcGVhaygpCiAgICAgICAgYXdhaXQgc2VsZi5zcGVhayhGYWxzZSkKCiAgICBhc3luYyBkZWYgcG9sbF9ldmVudChzZWxmKToKICAgICAgICAjIFRoaXMgZXhjZXB0aW9uIGlzIGhhbmRsZWQgdXAgdGhlIGNoYWluCiAgICAgICAgbXNnID0gYXdhaXQgYXN5bmNpby53YWl0X2ZvcihzZWxmLndzLnJlY2VpdmUoKSwgdGltZW91dD0zMC4wKQogICAgICAgIGlmIG1zZy50eXBlIGlzIGFpb2h0dHAuV1NNc2dUeXBlLlRFWFQ6CiAgICAgICAgICAgIGF3YWl0IHNlbGYucmVjZWl2ZWRfbWVzc2FnZShqc29uLmxvYWRzKG1zZy5kYXRhKSkKICAgICAgICBlbGlmIG1zZy50eXBlIGlzIGFpb2h0dHAuV1NNc2dUeXBlLkVSUk9SOgogICAgICAgICAgICBsb2cuZGVidWcoJ1JlY2VpdmVkICVzJywgbXNnKQogICAgICAgICAgICByYWlzZSBDb25uZWN0aW9uQ2xvc2VkKHNlbGYud3MsIHNoYXJkX2lkPU5vbmUpIGZyb20gbXNnLmRhdGEKICAgICAgICBlbGlmIG1zZy50eXBlIGluIChhaW9odHRwLldTTXNnVHlwZS5DTE9TRUQsIGFpb2h0dHAuV1NNc2dUeXBlLkNMT1NFLCBhaW9odHRwLldTTXNnVHlwZS5DTE9TSU5HKToKICAgICAgICAgICAgbG9nLmRlYnVnKCdSZWNlaXZlZCAlcycsIG1zZykKICAgICAgICAgICAgcmFpc2UgQ29ubmVjdGlvbkNsb3NlZChzZWxmLndzLCBzaGFyZF9pZD1Ob25lLCBjb2RlPXNlbGYuX2Nsb3NlX2NvZGUpCgogICAgYXN5bmMgZGVmIGNsb3NlKHNlbGYsIGNvZGU9MTAwMCk6CiAgICAgICAgaWYgc2VsZi5fa2VlcF9hbGl2ZSBpcyBub3QgTm9uZToKICAgICAgICAgICAgc2VsZi5fa2VlcF9hbGl2ZS5zdG9wKCkKCiAgICAgICAgc2VsZi5fY2xvc2VfY29kZSA9IGNvZGUKICAgICAgICBhd2FpdCBzZWxmLndzLmNsb3NlKGNvZGU9Y29kZSkK
