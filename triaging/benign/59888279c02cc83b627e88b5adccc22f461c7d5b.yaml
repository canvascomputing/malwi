statistics:
  total_files: 1
  skipped_files: 0.0
  processed_objects: 1
  malicious_objects: 0
details:
- path: .repo_cache/malicious_repos/pypi_malregistry/discord-py-v13/1.3/discord_py_v13-1.3-py3-none-any/discord-py-v13/channel.py
  contents:
  - name: GroupChannel.permissions_for
    score: 0.0
    code: |-
      def permissions_for(self, user):
              """Handles permission resolution for a :class:`User`.

              This function is there for compatibility with other channel types.

              Actual direct messages do not really have the concept of permissions.

              This returns all the Text related permissions set to ``True`` except:

              - :attr:`~Permissions.send_tts_messages`: You cannot send TTS messages in a DM.
              - :attr:`~Permissions.manage_messages`: You cannot delete others messages in a DM.

              This also checks the kick_members permission if the user is the owner.

              Parameters
              -----------
              user: :class:`User`
                  The user to check permissions for.

              Returns
              --------
              :class:`Permissions`
                  The resolved permissions for the user.
              """

              base = Permissions.text()
              base.read_messages = True
              base.send_tts_messages = False
              base.manage_messages = False
              base.mention_everyone = True

              if user.id == self.owner.id:
                  base.kick_members = True

              return base
    tokens: resume load_global Permissions load_attr text call store_fast base load_const INTEGER load_fast base store_attr read_messages load_const INTEGER load_fast base store_attr STRING_LEN_S_ENT_HIGH load_const INTEGER load_fast base store_attr manage_messages load_const INTEGER load_fast base store_attr STRING_LEN_S_ENT_HIGH load_fast user load_attr id load_fast self load_attr owner load_attr id compare_op == pop_jump_if_false TO_NUMBER load_const INTEGER load_fast base store_attr kick_members load_fast base return_value
    hash: 3efebf7a4581569411c2015bc41e03c6fa7dfdccc9e9587defc14e23107336e2
sources:
  .repo_cache/malicious_repos/pypi_malregistry/discord-py-v13/1.3/discord_py_v13-1.3-py3-none-any/discord-py-v13/channel.py: IyAtKi0gY29kaW5nOiB1dGYtOCAtKi0KCiIiIgpUaGUgTUlUIExpY2Vuc2UgKE1JVCkKCkNvcHlyaWdodCAoYykgMjAxNS1wcmVzZW50IFJhcHB0egoKUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEKY29weSBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZSAiU29mdHdhcmUiKSwKdG8gZGVhbCBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbgp0aGUgcmlnaHRzIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwKYW5kL29yIHNlbGwgY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlClNvZnR3YXJlIGlzIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6CgpUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbgphbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KClRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTCk9SIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLApGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEUKQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUgpMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORwpGUk9NLCBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSCkRFQUxJTkdTIElOIFRIRSBTT0ZUV0FSRS4KIiIiCgppbXBvcnQgdGltZQppbXBvcnQgYXN5bmNpbwoKaW1wb3J0IGRpc2NvcmQuYWJjCmZyb20gLnBlcm1pc3Npb25zIGltcG9ydCBQZXJtaXNzaW9ucwpmcm9tIC5lbnVtcyBpbXBvcnQgQ2hhbm5lbFR5cGUsIHRyeV9lbnVtLCBWb2ljZVJlZ2lvbgpmcm9tIC5taXhpbnMgaW1wb3J0IEhhc2hhYmxlCmZyb20gLiBpbXBvcnQgdXRpbHMKZnJvbSAuYXNzZXQgaW1wb3J0IEFzc2V0CmZyb20gLmVycm9ycyBpbXBvcnQgQ2xpZW50RXhjZXB0aW9uLCBOb01vcmVJdGVtcywgSW52YWxpZEFyZ3VtZW50CgpfX2FsbF9fID0gKAogICAgJ1RleHRDaGFubmVsJywKICAgICdWb2ljZUNoYW5uZWwnLAogICAgJ1N0YWdlQ2hhbm5lbCcsCiAgICAnRE1DaGFubmVsJywKICAgICdDYXRlZ29yeUNoYW5uZWwnLAogICAgJ1N0b3JlQ2hhbm5lbCcsCiAgICAnR3JvdXBDaGFubmVsJywKICAgICdfY2hhbm5lbF9mYWN0b3J5JywKKQoKYXN5bmMgZGVmIF9zaW5nbGVfZGVsZXRlX3N0cmF0ZWd5KG1lc3NhZ2VzKToKICAgIGZvciBtIGluIG1lc3NhZ2VzOgogICAgICAgIGF3YWl0IG0uZGVsZXRlKCkKCmNsYXNzIFRleHRDaGFubmVsKGRpc2NvcmQuYWJjLk1lc3NhZ2VhYmxlLCBkaXNjb3JkLmFiYy5HdWlsZENoYW5uZWwsIEhhc2hhYmxlKToKICAgICIiIlJlcHJlc2VudHMgYSBEaXNjb3JkIGd1aWxkIHRleHQgY2hhbm5lbC4KCiAgICAuLiBjb250YWluZXI6OiBvcGVyYXRpb25zCgogICAgICAgIC4uIGRlc2NyaWJlOjogeCA9PSB5CgogICAgICAgICAgICBDaGVja3MgaWYgdHdvIGNoYW5uZWxzIGFyZSBlcXVhbC4KCiAgICAgICAgLi4gZGVzY3JpYmU6OiB4ICE9IHkKCiAgICAgICAgICAgIENoZWNrcyBpZiB0d28gY2hhbm5lbHMgYXJlIG5vdCBlcXVhbC4KCiAgICAgICAgLi4gZGVzY3JpYmU6OiBoYXNoKHgpCgogICAgICAgICAgICBSZXR1cm5zIHRoZSBjaGFubmVsJ3MgaGFzaC4KCiAgICAgICAgLi4gZGVzY3JpYmU6OiBzdHIoeCkKCiAgICAgICAgICAgIFJldHVybnMgdGhlIGNoYW5uZWwncyBuYW1lLgoKICAgIEF0dHJpYnV0ZXMKICAgIC0tLS0tLS0tLS0tCiAgICBuYW1lOiA6Y2xhc3M6YHN0cmAKICAgICAgICBUaGUgY2hhbm5lbCBuYW1lLgogICAgZ3VpbGQ6IDpjbGFzczpgR3VpbGRgCiAgICAgICAgVGhlIGd1aWxkIHRoZSBjaGFubmVsIGJlbG9uZ3MgdG8uCiAgICBpZDogOmNsYXNzOmBpbnRgCiAgICAgICAgVGhlIGNoYW5uZWwgSUQuCiAgICBjYXRlZ29yeV9pZDogT3B0aW9uYWxbOmNsYXNzOmBpbnRgXQogICAgICAgIFRoZSBjYXRlZ29yeSBjaGFubmVsIElEIHRoaXMgY2hhbm5lbCBiZWxvbmdzIHRvLCBpZiBhcHBsaWNhYmxlLgogICAgdG9waWM6IE9wdGlvbmFsWzpjbGFzczpgc3RyYF0KICAgICAgICBUaGUgY2hhbm5lbCdzIHRvcGljLiBgYE5vbmVgYCBpZiBpdCBkb2Vzbid0IGV4aXN0LgogICAgcG9zaXRpb246IDpjbGFzczpgaW50YAogICAgICAgIFRoZSBwb3NpdGlvbiBpbiB0aGUgY2hhbm5lbCBsaXN0LiBUaGlzIGlzIGEgbnVtYmVyIHRoYXQgc3RhcnRzIGF0IDAuIGUuZy4gdGhlCiAgICAgICAgdG9wIGNoYW5uZWwgaXMgcG9zaXRpb24gMC4KICAgIGxhc3RfbWVzc2FnZV9pZDogT3B0aW9uYWxbOmNsYXNzOmBpbnRgXQogICAgICAgIFRoZSBsYXN0IG1lc3NhZ2UgSUQgb2YgdGhlIG1lc3NhZ2Ugc2VudCB0byB0aGlzIGNoYW5uZWwuIEl0IG1heQogICAgICAgICpub3QqIHBvaW50IHRvIGFuIGV4aXN0aW5nIG9yIHZhbGlkIG1lc3NhZ2UuCiAgICBzbG93bW9kZV9kZWxheTogOmNsYXNzOmBpbnRgCiAgICAgICAgVGhlIG51bWJlciBvZiBzZWNvbmRzIGEgbWVtYmVyIG11c3Qgd2FpdCBiZXR3ZWVuIHNlbmRpbmcgbWVzc2FnZXMKICAgICAgICBpbiB0aGlzIGNoYW5uZWwuIEEgdmFsdWUgb2YgYDBgIGRlbm90ZXMgdGhhdCBpdCBpcyBkaXNhYmxlZC4KICAgICAgICBCb3RzIGFuZCB1c2VycyB3aXRoIDphdHRyOmB+UGVybWlzc2lvbnMubWFuYWdlX2NoYW5uZWxzYCBvcgogICAgICAgIDphdHRyOmB+UGVybWlzc2lvbnMubWFuYWdlX21lc3NhZ2VzYCBieXBhc3Mgc2xvd21vZGUuCiAgICAiIiIKCiAgICBfX3Nsb3RzX18gPSAoJ25hbWUnLCAnaWQnLCAnZ3VpbGQnLCAndG9waWMnLCAnX3N0YXRlJywgJ25zZncnLAogICAgICAgICAgICAgICAgICdjYXRlZ29yeV9pZCcsICdwb3NpdGlvbicsICdzbG93bW9kZV9kZWxheScsICdfb3ZlcndyaXRlcycsCiAgICAgICAgICAgICAgICAgJ190eXBlJywgJ2xhc3RfbWVzc2FnZV9pZCcpCgogICAgZGVmIF9faW5pdF9fKHNlbGYsICosIHN0YXRlLCBndWlsZCwgZGF0YSk6CiAgICAgICAgc2VsZi5fc3RhdGUgPSBzdGF0ZQogICAgICAgIHNlbGYuaWQgPSBpbnQoZGF0YVsnaWQnXSkKICAgICAgICBzZWxmLl90eXBlID0gZGF0YVsndHlwZSddCiAgICAgICAgc2VsZi5fdXBkYXRlKGd1aWxkLCBkYXRhKQoKICAgIGRlZiBfX3JlcHJfXyhzZWxmKToKICAgICAgICBhdHRycyA9IFsKICAgICAgICAgICAgKCdpZCcsIHNlbGYuaWQpLAogICAgICAgICAgICAoJ25hbWUnLCBzZWxmLm5hbWUpLAogICAgICAgICAgICAoJ3Bvc2l0aW9uJywgc2VsZi5wb3NpdGlvbiksCiAgICAgICAgICAgICgnbnNmdycsIHNlbGYubnNmdyksCiAgICAgICAgICAgICgnbmV3cycsIHNlbGYuaXNfbmV3cygpKSwKICAgICAgICAgICAgKCdjYXRlZ29yeV9pZCcsIHNlbGYuY2F0ZWdvcnlfaWQpCiAgICAgICAgXQogICAgICAgIHJldHVybiAnPCVzICVzPicgJSAoc2VsZi5fX2NsYXNzX18uX19uYW1lX18sICcgJy5qb2luKCclcz0lcicgJSB0IGZvciB0IGluIGF0dHJzKSkKCiAgICBkZWYgX3VwZGF0ZShzZWxmLCBndWlsZCwgZGF0YSk6CiAgICAgICAgc2VsZi5ndWlsZCA9IGd1aWxkCiAgICAgICAgc2VsZi5uYW1lID0gZGF0YVsnbmFtZSddCiAgICAgICAgc2VsZi5jYXRlZ29yeV9pZCA9IHV0aWxzLl9nZXRfYXNfc25vd2ZsYWtlKGRhdGEsICdwYXJlbnRfaWQnKQogICAgICAgIHNlbGYudG9waWMgPSBkYXRhLmdldCgndG9waWMnKQogICAgICAgIHNlbGYucG9zaXRpb24gPSBkYXRhWydwb3NpdGlvbiddCiAgICAgICAgc2VsZi5uc2Z3ID0gZGF0YS5nZXQoJ25zZncnLCBGYWxzZSkKICAgICAgICAjIERvZXMgdGhpcyBuZWVkIGNvZXJjaW9uIGludG8gYGludGA/IE5vIGlkZWEgeWV0LgogICAgICAgIHNlbGYuc2xvd21vZGVfZGVsYXkgPSBkYXRhLmdldCgncmF0ZV9saW1pdF9wZXJfdXNlcicsIDApCiAgICAgICAgc2VsZi5fdHlwZSA9IGRhdGEuZ2V0KCd0eXBlJywgc2VsZi5fdHlwZSkKICAgICAgICBzZWxmLmxhc3RfbWVzc2FnZV9pZCA9IHV0aWxzLl9nZXRfYXNfc25vd2ZsYWtlKGRhdGEsICdsYXN0X21lc3NhZ2VfaWQnKQogICAgICAgIHNlbGYuX2ZpbGxfb3ZlcndyaXRlcyhkYXRhKQoKICAgIGFzeW5jIGRlZiBfZ2V0X2NoYW5uZWwoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYKCiAgICBAcHJvcGVydHkKICAgIGRlZiB0eXBlKHNlbGYpOgogICAgICAgICIiIjpjbGFzczpgQ2hhbm5lbFR5cGVgOiBUaGUgY2hhbm5lbCdzIERpc2NvcmQgdHlwZS4iIiIKICAgICAgICByZXR1cm4gdHJ5X2VudW0oQ2hhbm5lbFR5cGUsIHNlbGYuX3R5cGUpCgogICAgQHByb3BlcnR5CiAgICBkZWYgX3NvcnRpbmdfYnVja2V0KHNlbGYpOgogICAgICAgIHJldHVybiBDaGFubmVsVHlwZS50ZXh0LnZhbHVlCgogICAgQHV0aWxzLmNvcHlfZG9jKGRpc2NvcmQuYWJjLkd1aWxkQ2hhbm5lbC5wZXJtaXNzaW9uc19mb3IpCiAgICBkZWYgcGVybWlzc2lvbnNfZm9yKHNlbGYsIG1lbWJlcik6CiAgICAgICAgYmFzZSA9IHN1cGVyKCkucGVybWlzc2lvbnNfZm9yKG1lbWJlcikKCiAgICAgICAgIyB0ZXh0IGNoYW5uZWxzIGRvIG5vdCBoYXZlIHZvaWNlIHJlbGF0ZWQgcGVybWlzc2lvbnMKICAgICAgICBkZW5pZWQgPSBQZXJtaXNzaW9ucy52b2ljZSgpCiAgICAgICAgYmFzZS52YWx1ZSAmPSB+ZGVuaWVkLnZhbHVlCiAgICAgICAgcmV0dXJuIGJhc2UKCiAgICBAcHJvcGVydHkKICAgIGRlZiBtZW1iZXJzKHNlbGYpOgogICAgICAgICIiIkxpc3RbOmNsYXNzOmBNZW1iZXJgXTogUmV0dXJucyBhbGwgbWVtYmVycyB0aGF0IGNhbiBzZWUgdGhpcyBjaGFubmVsLiIiIgogICAgICAgIHJldHVybiBbbSBmb3IgbSBpbiBzZWxmLmd1aWxkLm1lbWJlcnMgaWYgc2VsZi5wZXJtaXNzaW9uc19mb3IobSkucmVhZF9tZXNzYWdlc10KCiAgICBkZWYgaXNfbnNmdyhzZWxmKToKICAgICAgICAiIiI6Y2xhc3M6YGJvb2xgOiBDaGVja3MgaWYgdGhlIGNoYW5uZWwgaXMgTlNGVy4iIiIKICAgICAgICByZXR1cm4gc2VsZi5uc2Z3CgogICAgZGVmIGlzX25ld3Moc2VsZik6CiAgICAgICAgIiIiOmNsYXNzOmBib29sYDogQ2hlY2tzIGlmIHRoZSBjaGFubmVsIGlzIGEgbmV3cyBjaGFubmVsLiIiIgogICAgICAgIHJldHVybiBzZWxmLl90eXBlID09IENoYW5uZWxUeXBlLm5ld3MudmFsdWUKCiAgICBAcHJvcGVydHkKICAgIGRlZiBsYXN0X21lc3NhZ2Uoc2VsZik6CiAgICAgICAgIiIiRmV0Y2hlcyB0aGUgbGFzdCBtZXNzYWdlIGZyb20gdGhpcyBjaGFubmVsIGluIGNhY2hlLgoKICAgICAgICBUaGUgbWVzc2FnZSBtaWdodCBub3QgYmUgdmFsaWQgb3IgcG9pbnQgdG8gYW4gZXhpc3RpbmcgbWVzc2FnZS4KCiAgICAgICAgLi4gYWRtb25pdGlvbjo6IFJlbGlhYmxlIEZldGNoaW5nCiAgICAgICAgICAgIDpjbGFzczogaGVscGZ1bAoKICAgICAgICAgICAgRm9yIGEgc2xpZ2h0bHkgbW9yZSByZWxpYWJsZSBtZXRob2Qgb2YgZmV0Y2hpbmcgdGhlCiAgICAgICAgICAgIGxhc3QgbWVzc2FnZSwgY29uc2lkZXIgdXNpbmcgZWl0aGVyIDptZXRoOmBoaXN0b3J5YAogICAgICAgICAgICBvciA6bWV0aDpgZmV0Y2hfbWVzc2FnZWAgd2l0aCB0aGUgOmF0dHI6YGxhc3RfbWVzc2FnZV9pZGAKICAgICAgICAgICAgYXR0cmlidXRlLgoKICAgICAgICBSZXR1cm5zCiAgICAgICAgLS0tLS0tLS0tCiAgICAgICAgT3B0aW9uYWxbOmNsYXNzOmBNZXNzYWdlYF0KICAgICAgICAgICAgVGhlIGxhc3QgbWVzc2FnZSBpbiB0aGlzIGNoYW5uZWwgb3IgYGBOb25lYGAgaWYgbm90IGZvdW5kLgogICAgICAgICIiIgogICAgICAgIHJldHVybiBzZWxmLl9zdGF0ZS5fZ2V0X21lc3NhZ2Uoc2VsZi5sYXN0X21lc3NhZ2VfaWQpIGlmIHNlbGYubGFzdF9tZXNzYWdlX2lkIGVsc2UgTm9uZQoKICAgIGFzeW5jIGRlZiBlZGl0KHNlbGYsICosIHJlYXNvbj1Ob25lLCAqKm9wdGlvbnMpOgogICAgICAgICIiInxjb3JvfAoKICAgICAgICBFZGl0cyB0aGUgY2hhbm5lbC4KCiAgICAgICAgWW91IG11c3QgaGF2ZSB0aGUgOmF0dHI6YH5QZXJtaXNzaW9ucy5tYW5hZ2VfY2hhbm5lbHNgIHBlcm1pc3Npb24gdG8KICAgICAgICB1c2UgdGhpcy4KCiAgICAgICAgLi4gdmVyc2lvbmNoYW5nZWQ6OiAxLjMKICAgICAgICAgICAgVGhlIGBgb3ZlcndyaXRlc2BgIGtleXdvcmQtb25seSBwYXJhbWV0ZXIgd2FzIGFkZGVkLgoKICAgICAgICAuLiB2ZXJzaW9uY2hhbmdlZDo6IDEuNAogICAgICAgICAgICBUaGUgYGB0eXBlYGAga2V5d29yZC1vbmx5IHBhcmFtZXRlciB3YXMgYWRkZWQuCgogICAgICAgIFBhcmFtZXRlcnMKICAgICAgICAtLS0tLS0tLS0tCiAgICAgICAgbmFtZTogOmNsYXNzOmBzdHJgCiAgICAgICAgICAgIFRoZSBuZXcgY2hhbm5lbCBuYW1lLgogICAgICAgIHRvcGljOiA6Y2xhc3M6YHN0cmAKICAgICAgICAgICAgVGhlIG5ldyBjaGFubmVsJ3MgdG9waWMuCiAgICAgICAgcG9zaXRpb246IDpjbGFzczpgaW50YAogICAgICAgICAgICBUaGUgbmV3IGNoYW5uZWwncyBwb3NpdGlvbi4KICAgICAgICBuc2Z3OiA6Y2xhc3M6YGJvb2xgCiAgICAgICAgICAgIFRvIG1hcmsgdGhlIGNoYW5uZWwgYXMgTlNGVyBvciBub3QuCiAgICAgICAgc3luY19wZXJtaXNzaW9uczogOmNsYXNzOmBib29sYAogICAgICAgICAgICBXaGV0aGVyIHRvIHN5bmMgcGVybWlzc2lvbnMgd2l0aCB0aGUgY2hhbm5lbCdzIG5ldyBvciBwcmUtZXhpc3RpbmcKICAgICAgICAgICAgY2F0ZWdvcnkuIERlZmF1bHRzIHRvIGBgRmFsc2VgYC4KICAgICAgICBjYXRlZ29yeTogT3B0aW9uYWxbOmNsYXNzOmBDYXRlZ29yeUNoYW5uZWxgXQogICAgICAgICAgICBUaGUgbmV3IGNhdGVnb3J5IGZvciB0aGlzIGNoYW5uZWwuIENhbiBiZSBgYE5vbmVgYCB0byByZW1vdmUgdGhlCiAgICAgICAgICAgIGNhdGVnb3J5LgogICAgICAgIHNsb3dtb2RlX2RlbGF5OiA6Y2xhc3M6YGludGAKICAgICAgICAgICAgU3BlY2lmaWVzIHRoZSBzbG93bW9kZSByYXRlIGxpbWl0IGZvciB1c2VyIGluIHRoaXMgY2hhbm5lbCwgaW4gc2Vjb25kcy4KICAgICAgICAgICAgQSB2YWx1ZSBvZiBgMGAgZGlzYWJsZXMgc2xvd21vZGUuIFRoZSBtYXhpbXVtIHZhbHVlIHBvc3NpYmxlIGlzIGAyMTYwMGAuCiAgICAgICAgdHlwZTogOmNsYXNzOmBDaGFubmVsVHlwZWAKICAgICAgICAgICAgQ2hhbmdlIHRoZSB0eXBlIG9mIHRoaXMgdGV4dCBjaGFubmVsLiBDdXJyZW50bHksIG9ubHkgY29udmVyc2lvbiBiZXR3ZWVuCiAgICAgICAgICAgIDphdHRyOmBDaGFubmVsVHlwZS50ZXh0YCBhbmQgOmF0dHI6YENoYW5uZWxUeXBlLm5ld3NgIGlzIHN1cHBvcnRlZC4gVGhpcwogICAgICAgICAgICBpcyBvbmx5IGF2YWlsYWJsZSB0byBndWlsZHMgdGhhdCBjb250YWluIGBgTkVXU2BgIGluIDphdHRyOmBHdWlsZC5mZWF0dXJlc2AuCiAgICAgICAgcmVhc29uOiBPcHRpb25hbFs6Y2xhc3M6YHN0cmBdCiAgICAgICAgICAgIFRoZSByZWFzb24gZm9yIGVkaXRpbmcgdGhpcyBjaGFubmVsLiBTaG93cyB1cCBvbiB0aGUgYXVkaXQgbG9nLgogICAgICAgIG92ZXJ3cml0ZXM6IDpjbGFzczpgZGljdGAKICAgICAgICAgICAgQSA6Y2xhc3M6YGRpY3RgIG9mIHRhcmdldCAoZWl0aGVyIGEgcm9sZSBvciBhIG1lbWJlcikgdG8KICAgICAgICAgICAgOmNsYXNzOmBQZXJtaXNzaW9uT3ZlcndyaXRlYCB0byBhcHBseSB0byB0aGUgY2hhbm5lbC4KCiAgICAgICAgUmFpc2VzCiAgICAgICAgLS0tLS0tCiAgICAgICAgSW52YWxpZEFyZ3VtZW50CiAgICAgICAgICAgIElmIHBvc2l0aW9uIGlzIGxlc3MgdGhhbiAwIG9yIGdyZWF0ZXIgdGhhbiB0aGUgbnVtYmVyIG9mIGNoYW5uZWxzLCBvciBpZgogICAgICAgICAgICB0aGUgcGVybWlzc2lvbiBvdmVyd3JpdGUgaW5mb3JtYXRpb24gaXMgbm90IGluIHByb3BlciBmb3JtLgogICAgICAgIEZvcmJpZGRlbgogICAgICAgICAgICBZb3UgZG8gbm90IGhhdmUgcGVybWlzc2lvbnMgdG8gZWRpdCB0aGUgY2hhbm5lbC4KICAgICAgICBIVFRQRXhjZXB0aW9uCiAgICAgICAgICAgIEVkaXRpbmcgdGhlIGNoYW5uZWwgZmFpbGVkLgogICAgICAgICIiIgogICAgICAgIGF3YWl0IHNlbGYuX2VkaXQob3B0aW9ucywgcmVhc29uPXJlYXNvbikKCiAgICBAdXRpbHMuY29weV9kb2MoZGlzY29yZC5hYmMuR3VpbGRDaGFubmVsLmNsb25lKQogICAgYXN5bmMgZGVmIGNsb25lKHNlbGYsICosIG5hbWU9Tm9uZSwgcmVhc29uPU5vbmUpOgogICAgICAgIHJldHVybiBhd2FpdCBzZWxmLl9jbG9uZV9pbXBsKHsKICAgICAgICAgICAgJ3RvcGljJzogc2VsZi50b3BpYywKICAgICAgICAgICAgJ25zZncnOiBzZWxmLm5zZncsCiAgICAgICAgICAgICdyYXRlX2xpbWl0X3Blcl91c2VyJzogc2VsZi5zbG93bW9kZV9kZWxheQogICAgICAgIH0sIG5hbWU9bmFtZSwgcmVhc29uPXJlYXNvbikKCiAgICBhc3luYyBkZWYgZGVsZXRlX21lc3NhZ2VzKHNlbGYsIG1lc3NhZ2VzKToKICAgICAgICAiIiJ8Y29yb3wKCiAgICAgICAgRGVsZXRlcyBhIGxpc3Qgb2YgbWVzc2FnZXMuIFRoaXMgaXMgc2ltaWxhciB0byA6bWV0aDpgTWVzc2FnZS5kZWxldGVgCiAgICAgICAgZXhjZXB0IGl0IGJ1bGsgZGVsZXRlcyBtdWx0aXBsZSBtZXNzYWdlcy4KCiAgICAgICAgQXMgYSBzcGVjaWFsIGNhc2UsIGlmIHRoZSBudW1iZXIgb2YgbWVzc2FnZXMgaXMgMCwgdGhlbiBub3RoaW5nCiAgICAgICAgaXMgZG9uZS4gSWYgdGhlIG51bWJlciBvZiBtZXNzYWdlcyBpcyAxIHRoZW4gc2luZ2xlIG1lc3NhZ2UKICAgICAgICBkZWxldGUgaXMgZG9uZS4gSWYgaXQncyBtb3JlIHRoYW4gdHdvLCB0aGVuIGJ1bGsgZGVsZXRlIGlzIHVzZWQuCgogICAgICAgIFlvdSBjYW5ub3QgYnVsayBkZWxldGUgbW9yZSB0aGFuIDEwMCBtZXNzYWdlcyBvciBtZXNzYWdlcyB0aGF0CiAgICAgICAgYXJlIG9sZGVyIHRoYW4gMTQgZGF5cyBvbGQuCgogICAgICAgIFlvdSBtdXN0IGhhdmUgdGhlIDphdHRyOmB+UGVybWlzc2lvbnMubWFuYWdlX21lc3NhZ2VzYCBwZXJtaXNzaW9uIHRvCiAgICAgICAgdXNlIHRoaXMuCgogICAgICAgIFVzYWJsZSBvbmx5IGJ5IGJvdCBhY2NvdW50cy4KCiAgICAgICAgUGFyYW1ldGVycwogICAgICAgIC0tLS0tLS0tLS0tCiAgICAgICAgbWVzc2FnZXM6IEl0ZXJhYmxlWzpjbGFzczpgYWJjLlNub3dmbGFrZWBdCiAgICAgICAgICAgIEFuIGl0ZXJhYmxlIG9mIG1lc3NhZ2VzIGRlbm90aW5nIHdoaWNoIG9uZXMgdG8gYnVsayBkZWxldGUuCgogICAgICAgIFJhaXNlcwogICAgICAgIC0tLS0tLQogICAgICAgIENsaWVudEV4Y2VwdGlvbgogICAgICAgICAgICBUaGUgbnVtYmVyIG9mIG1lc3NhZ2VzIHRvIGRlbGV0ZSB3YXMgbW9yZSB0aGFuIDEwMC4KICAgICAgICBGb3JiaWRkZW4KICAgICAgICAgICAgWW91IGRvIG5vdCBoYXZlIHByb3BlciBwZXJtaXNzaW9ucyB0byBkZWxldGUgdGhlIG1lc3NhZ2VzIG9yCiAgICAgICAgICAgIHlvdSdyZSBub3QgdXNpbmcgYSBib3QgYWNjb3VudC4KICAgICAgICBOb3RGb3VuZAogICAgICAgICAgICBJZiBzaW5nbGUgZGVsZXRlLCB0aGVuIHRoZSBtZXNzYWdlIHdhcyBhbHJlYWR5IGRlbGV0ZWQuCiAgICAgICAgSFRUUEV4Y2VwdGlvbgogICAgICAgICAgICBEZWxldGluZyB0aGUgbWVzc2FnZXMgZmFpbGVkLgogICAgICAgICIiIgogICAgICAgIGlmIG5vdCBpc2luc3RhbmNlKG1lc3NhZ2VzLCAobGlzdCwgdHVwbGUpKToKICAgICAgICAgICAgbWVzc2FnZXMgPSBsaXN0KG1lc3NhZ2VzKQoKICAgICAgICBpZiBsZW4obWVzc2FnZXMpID09IDA6CiAgICAgICAgICAgIHJldHVybiAjIGRvIG5vdGhpbmcKCiAgICAgICAgaWYgbGVuKG1lc3NhZ2VzKSA9PSAxOgogICAgICAgICAgICBtZXNzYWdlX2lkID0gbWVzc2FnZXNbMF0uaWQKICAgICAgICAgICAgYXdhaXQgc2VsZi5fc3RhdGUuaHR0cC5kZWxldGVfbWVzc2FnZShzZWxmLmlkLCBtZXNzYWdlX2lkKQogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgaWYgbGVuKG1lc3NhZ2VzKSA+IDEwMDoKICAgICAgICAgICAgcmFpc2UgQ2xpZW50RXhjZXB0aW9uKCdDYW4gb25seSBidWxrIGRlbGV0ZSBtZXNzYWdlcyB1cCB0byAxMDAgbWVzc2FnZXMnKQoKICAgICAgICBtZXNzYWdlX2lkcyA9IFttLmlkIGZvciBtIGluIG1lc3NhZ2VzXQogICAgICAgIGF3YWl0IHNlbGYuX3N0YXRlLmh0dHAuZGVsZXRlX21lc3NhZ2VzKHNlbGYuaWQsIG1lc3NhZ2VfaWRzKQoKICAgIGFzeW5jIGRlZiBwdXJnZShzZWxmLCAqLCBsaW1pdD0xMDAsIGNoZWNrPU5vbmUsIGJlZm9yZT1Ob25lLCBhZnRlcj1Ob25lLCBhcm91bmQ9Tm9uZSwgb2xkZXN0X2ZpcnN0PUZhbHNlLCBidWxrPVRydWUpOgogICAgICAgICIiInxjb3JvfAoKICAgICAgICBQdXJnZXMgYSBsaXN0IG9mIG1lc3NhZ2VzIHRoYXQgbWVldCB0aGUgY3JpdGVyaWEgZ2l2ZW4gYnkgdGhlIHByZWRpY2F0ZQogICAgICAgIGBgY2hlY2tgYC4gSWYgYSBgYGNoZWNrYGAgaXMgbm90IHByb3ZpZGVkIHRoZW4gYWxsIG1lc3NhZ2VzIGFyZSBkZWxldGVkCiAgICAgICAgd2l0aG91dCBkaXNjcmltaW5hdGlvbi4KCiAgICAgICAgWW91IG11c3QgaGF2ZSB0aGUgOmF0dHI6YH5QZXJtaXNzaW9ucy5tYW5hZ2VfbWVzc2FnZXNgIHBlcm1pc3Npb24gdG8KICAgICAgICBkZWxldGUgbWVzc2FnZXMgZXZlbiBpZiB0aGV5IGFyZSB5b3VyIG93biAodW5sZXNzIHlvdSBhcmUgYSB1c2VyCiAgICAgICAgYWNjb3VudCkuIFRoZSA6YXR0cjpgflBlcm1pc3Npb25zLnJlYWRfbWVzc2FnZV9oaXN0b3J5YCBwZXJtaXNzaW9uIGlzCiAgICAgICAgYWxzbyBuZWVkZWQgdG8gcmV0cmlldmUgbWVzc2FnZSBoaXN0b3J5LgoKICAgICAgICBJbnRlcm5hbGx5LCB0aGlzIGVtcGxveXMgYSBkaWZmZXJlbnQgbnVtYmVyIG9mIHN0cmF0ZWdpZXMgZGVwZW5kaW5nCiAgICAgICAgb24gdGhlIGNvbmRpdGlvbnMgbWV0IHN1Y2ggYXMgaWYgYSBidWxrIGRlbGV0ZSBpcyBwb3NzaWJsZSBvciBpZgogICAgICAgIHRoZSBhY2NvdW50IGlzIGEgdXNlciBib3Qgb3Igbm90LgoKICAgICAgICBFeGFtcGxlcwogICAgICAgIC0tLS0tLS0tLQoKICAgICAgICBEZWxldGluZyBib3QncyBtZXNzYWdlcyA6OgoKICAgICAgICAgICAgZGVmIGlzX21lKG0pOgogICAgICAgICAgICAgICAgcmV0dXJuIG0uYXV0aG9yID09IGNsaWVudC51c2VyCgogICAgICAgICAgICBkZWxldGVkID0gYXdhaXQgY2hhbm5lbC5wdXJnZShsaW1pdD0xMDAsIGNoZWNrPWlzX21lKQogICAgICAgICAgICBhd2FpdCBjaGFubmVsLnNlbmQoJ0RlbGV0ZWQge30gbWVzc2FnZShzKScuZm9ybWF0KGxlbihkZWxldGVkKSkpCgogICAgICAgIFBhcmFtZXRlcnMKICAgICAgICAtLS0tLS0tLS0tLQogICAgICAgIGxpbWl0OiBPcHRpb25hbFs6Y2xhc3M6YGludGBdCiAgICAgICAgICAgIFRoZSBudW1iZXIgb2YgbWVzc2FnZXMgdG8gc2VhcmNoIHRocm91Z2guIFRoaXMgaXMgbm90IHRoZSBudW1iZXIKICAgICAgICAgICAgb2YgbWVzc2FnZXMgdGhhdCB3aWxsIGJlIGRlbGV0ZWQsIHRob3VnaCBpdCBjYW4gYmUuCiAgICAgICAgY2hlY2s6IENhbGxhYmxlW1s6Y2xhc3M6YE1lc3NhZ2VgXSwgOmNsYXNzOmBib29sYF0KICAgICAgICAgICAgVGhlIGZ1bmN0aW9uIHVzZWQgdG8gY2hlY2sgaWYgYSBtZXNzYWdlIHNob3VsZCBiZSBkZWxldGVkLgogICAgICAgICAgICBJdCBtdXN0IHRha2UgYSA6Y2xhc3M6YE1lc3NhZ2VgIGFzIGl0cyBzb2xlIHBhcmFtZXRlci4KICAgICAgICBiZWZvcmU6IE9wdGlvbmFsW1VuaW9uWzpjbGFzczpgYWJjLlNub3dmbGFrZWAsIDpjbGFzczpgZGF0ZXRpbWUuZGF0ZXRpbWVgXV0KICAgICAgICAgICAgU2FtZSBhcyBgYGJlZm9yZWBgIGluIDptZXRoOmBoaXN0b3J5YC4KICAgICAgICBhZnRlcjogT3B0aW9uYWxbVW5pb25bOmNsYXNzOmBhYmMuU25vd2ZsYWtlYCwgOmNsYXNzOmBkYXRldGltZS5kYXRldGltZWBdXQogICAgICAgICAgICBTYW1lIGFzIGBgYWZ0ZXJgYCBpbiA6bWV0aDpgaGlzdG9yeWAuCiAgICAgICAgYXJvdW5kOiBPcHRpb25hbFtVbmlvbls6Y2xhc3M6YGFiYy5Tbm93Zmxha2VgLCA6Y2xhc3M6YGRhdGV0aW1lLmRhdGV0aW1lYF1dCiAgICAgICAgICAgIFNhbWUgYXMgYGBhcm91bmRgYCBpbiA6bWV0aDpgaGlzdG9yeWAuCiAgICAgICAgb2xkZXN0X2ZpcnN0OiBPcHRpb25hbFs6Y2xhc3M6YGJvb2xgXQogICAgICAgICAgICBTYW1lIGFzIGBgb2xkZXN0X2ZpcnN0YGAgaW4gOm1ldGg6YGhpc3RvcnlgLgogICAgICAgIGJ1bGs6IDpjbGFzczpgYm9vbGAKICAgICAgICAgICAgSWYgYGBUcnVlYGAsIHVzZSBidWxrIGRlbGV0ZS4gU2V0dGluZyB0aGlzIHRvIGBgRmFsc2VgYCBpcyB1c2VmdWwgZm9yIG1hc3MtZGVsZXRpbmcKICAgICAgICAgICAgYSBib3QncyBvd24gbWVzc2FnZXMgd2l0aG91dCA6YXR0cjpgUGVybWlzc2lvbnMubWFuYWdlX21lc3NhZ2VzYC4gV2hlbiBgYFRydWVgYCwgd2lsbAogICAgICAgICAgICBmYWxsIGJhY2sgdG8gc2luZ2xlIGRlbGV0ZSBpZiBjdXJyZW50IGFjY291bnQgaXMgYSB1c2VyIGJvdCAobm93IGRlcHJlY2F0ZWQpLCBvciBpZiBtZXNzYWdlcyBhcmUKICAgICAgICAgICAgb2xkZXIgdGhhbiB0d28gd2Vla3MuCgogICAgICAgIFJhaXNlcwogICAgICAgIC0tLS0tLS0KICAgICAgICBGb3JiaWRkZW4KICAgICAgICAgICAgWW91IGRvIG5vdCBoYXZlIHByb3BlciBwZXJtaXNzaW9ucyB0byBkbyB0aGUgYWN0aW9ucyByZXF1aXJlZC4KICAgICAgICBIVFRQRXhjZXB0aW9uCiAgICAgICAgICAgIFB1cmdpbmcgdGhlIG1lc3NhZ2VzIGZhaWxlZC4KCiAgICAgICAgUmV0dXJucwogICAgICAgIC0tLS0tLS0tCiAgICAgICAgTGlzdFs6Y2xhc3M6YC5NZXNzYWdlYF0KICAgICAgICAgICAgVGhlIGxpc3Qgb2YgbWVzc2FnZXMgdGhhdCB3ZXJlIGRlbGV0ZWQuCiAgICAgICAgIiIiCgogICAgICAgIGlmIGNoZWNrIGlzIE5vbmU6CiAgICAgICAgICAgIGNoZWNrID0gbGFtYmRhIG06IFRydWUKCiAgICAgICAgaXRlcmF0b3IgPSBzZWxmLmhpc3RvcnkobGltaXQ9bGltaXQsIGJlZm9yZT1iZWZvcmUsIGFmdGVyPWFmdGVyLCBvbGRlc3RfZmlyc3Q9b2xkZXN0X2ZpcnN0LCBhcm91bmQ9YXJvdW5kKQogICAgICAgIHJldCA9IFtdCiAgICAgICAgY291bnQgPSAwCgogICAgICAgIG1pbmltdW1fdGltZSA9IGludCgodGltZS50aW1lKCkgLSAxNCAqIDI0ICogNjAgKiA2MCkgKiAxMDAwLjAgLSAxNDIwMDcwNDAwMDAwKSA8PCAyMgogICAgICAgIHN0cmF0ZWd5ID0gc2VsZi5kZWxldGVfbWVzc2FnZXMgaWYgc2VsZi5fc3RhdGUuaXNfYm90IGFuZCBidWxrIGVsc2UgX3NpbmdsZV9kZWxldGVfc3RyYXRlZ3kKCiAgICAgICAgd2hpbGUgVHJ1ZToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgbXNnID0gYXdhaXQgaXRlcmF0b3IubmV4dCgpCiAgICAgICAgICAgIGV4Y2VwdCBOb01vcmVJdGVtczoKICAgICAgICAgICAgICAgICMgbm8gbW9yZSBtZXNzYWdlcyB0byBwb2xsCiAgICAgICAgICAgICAgICBpZiBjb3VudCA+PSAyOgogICAgICAgICAgICAgICAgICAgICMgbW9yZSB0aGFuIDIgbWVzc2FnZXMgLT4gYnVsayBkZWxldGUKICAgICAgICAgICAgICAgICAgICB0b19kZWxldGUgPSByZXRbLWNvdW50Ol0KICAgICAgICAgICAgICAgICAgICBhd2FpdCBzdHJhdGVneSh0b19kZWxldGUpCiAgICAgICAgICAgICAgICBlbGlmIGNvdW50ID09IDE6CiAgICAgICAgICAgICAgICAgICAgIyBkZWxldGUgYSBzaW5nbGUgbWVzc2FnZQogICAgICAgICAgICAgICAgICAgIGF3YWl0IHJldFstMV0uZGVsZXRlKCkKCiAgICAgICAgICAgICAgICByZXR1cm4gcmV0CiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBpZiBjb3VudCA9PSAxMDA6CiAgICAgICAgICAgICAgICAgICAgIyB3ZSd2ZSByZWFjaGVkIGEgZnVsbCAncXVldWUnCiAgICAgICAgICAgICAgICAgICAgdG9fZGVsZXRlID0gcmV0Wy0xMDA6XQogICAgICAgICAgICAgICAgICAgIGF3YWl0IHN0cmF0ZWd5KHRvX2RlbGV0ZSkKICAgICAgICAgICAgICAgICAgICBjb3VudCA9IDAKICAgICAgICAgICAgICAgICAgICBhd2FpdCBhc3luY2lvLnNsZWVwKDEpCgogICAgICAgICAgICAgICAgaWYgY2hlY2sobXNnKToKICAgICAgICAgICAgICAgICAgICBpZiBtc2cuaWQgPCBtaW5pbXVtX3RpbWU6CiAgICAgICAgICAgICAgICAgICAgICAgICMgb2xkZXIgdGhhbiAxNCBkYXlzIG9sZAogICAgICAgICAgICAgICAgICAgICAgICBpZiBjb3VudCA9PSAxOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXdhaXQgcmV0Wy0xXS5kZWxldGUoKQogICAgICAgICAgICAgICAgICAgICAgICBlbGlmIGNvdW50ID49IDI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b19kZWxldGUgPSByZXRbLWNvdW50Ol0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF3YWl0IHN0cmF0ZWd5KHRvX2RlbGV0ZSkKCiAgICAgICAgICAgICAgICAgICAgICAgIGNvdW50ID0gMAogICAgICAgICAgICAgICAgICAgICAgICBzdHJhdGVneSA9IF9zaW5nbGVfZGVsZXRlX3N0cmF0ZWd5CgogICAgICAgICAgICAgICAgICAgIGNvdW50ICs9IDEKICAgICAgICAgICAgICAgICAgICByZXQuYXBwZW5kKG1zZykKCiAgICBhc3luYyBkZWYgd2ViaG9va3Moc2VsZik6CiAgICAgICAgIiIifGNvcm98CgogICAgICAgIEdldHMgdGhlIGxpc3Qgb2Ygd2ViaG9va3MgZnJvbSB0aGlzIGNoYW5uZWwuCgogICAgICAgIFJlcXVpcmVzIDphdHRyOmB+LlBlcm1pc3Npb25zLm1hbmFnZV93ZWJob29rc2AgcGVybWlzc2lvbnMuCgogICAgICAgIFJhaXNlcwogICAgICAgIC0tLS0tLS0KICAgICAgICBGb3JiaWRkZW4KICAgICAgICAgICAgWW91IGRvbid0IGhhdmUgcGVybWlzc2lvbnMgdG8gZ2V0IHRoZSB3ZWJob29rcy4KCiAgICAgICAgUmV0dXJucwogICAgICAgIC0tLS0tLS0tCiAgICAgICAgTGlzdFs6Y2xhc3M6YFdlYmhvb2tgXQogICAgICAgICAgICBUaGUgd2ViaG9va3MgZm9yIHRoaXMgY2hhbm5lbC4KICAgICAgICAiIiIKCiAgICAgICAgZnJvbSAud2ViaG9vayBpbXBvcnQgV2ViaG9vawogICAgICAgIGRhdGEgPSBhd2FpdCBzZWxmLl9zdGF0ZS5odHRwLmNoYW5uZWxfd2ViaG9va3Moc2VsZi5pZCkKICAgICAgICByZXR1cm4gW1dlYmhvb2suZnJvbV9zdGF0ZShkLCBzdGF0ZT1zZWxmLl9zdGF0ZSkgZm9yIGQgaW4gZGF0YV0KCiAgICBhc3luYyBkZWYgY3JlYXRlX3dlYmhvb2soc2VsZiwgKiwgbmFtZSwgYXZhdGFyPU5vbmUsIHJlYXNvbj1Ob25lKToKICAgICAgICAiIiJ8Y29yb3wKCiAgICAgICAgQ3JlYXRlcyBhIHdlYmhvb2sgZm9yIHRoaXMgY2hhbm5lbC4KCiAgICAgICAgUmVxdWlyZXMgOmF0dHI6YH4uUGVybWlzc2lvbnMubWFuYWdlX3dlYmhvb2tzYCBwZXJtaXNzaW9ucy4KCiAgICAgICAgLi4gdmVyc2lvbmNoYW5nZWQ6OiAxLjEKICAgICAgICAgICAgQWRkZWQgdGhlIGBgcmVhc29uYGAga2V5d29yZC1vbmx5IHBhcmFtZXRlci4KCiAgICAgICAgUGFyYW1ldGVycwogICAgICAgIC0tLS0tLS0tLS0tLS0KICAgICAgICBuYW1lOiA6Y2xhc3M6YHN0cmAKICAgICAgICAgICAgVGhlIHdlYmhvb2sncyBuYW1lLgogICAgICAgIGF2YXRhcjogT3B0aW9uYWxbOmNsYXNzOmBieXRlc2BdCiAgICAgICAgICAgIEEgOnRlcm06YHB5OmJ5dGVzLWxpa2Ugb2JqZWN0YCByZXByZXNlbnRpbmcgdGhlIHdlYmhvb2sncyBkZWZhdWx0IGF2YXRhci4KICAgICAgICAgICAgVGhpcyBvcGVyYXRlcyBzaW1pbGFybHkgdG8gOm1ldGg6YH5DbGllbnRVc2VyLmVkaXRgLgogICAgICAgIHJlYXNvbjogT3B0aW9uYWxbOmNsYXNzOmBzdHJgXQogICAgICAgICAgICBUaGUgcmVhc29uIGZvciBjcmVhdGluZyB0aGlzIHdlYmhvb2suIFNob3dzIHVwIGluIHRoZSBhdWRpdCBsb2dzLgoKICAgICAgICBSYWlzZXMKICAgICAgICAtLS0tLS0tCiAgICAgICAgSFRUUEV4Y2VwdGlvbgogICAgICAgICAgICBDcmVhdGluZyB0aGUgd2ViaG9vayBmYWlsZWQuCiAgICAgICAgRm9yYmlkZGVuCiAgICAgICAgICAgIFlvdSBkbyBub3QgaGF2ZSBwZXJtaXNzaW9ucyB0byBjcmVhdGUgYSB3ZWJob29rLgoKICAgICAgICBSZXR1cm5zCiAgICAgICAgLS0tLS0tLS0KICAgICAgICA6Y2xhc3M6YFdlYmhvb2tgCiAgICAgICAgICAgIFRoZSBjcmVhdGVkIHdlYmhvb2suCiAgICAgICAgIiIiCgogICAgICAgIGZyb20gLndlYmhvb2sgaW1wb3J0IFdlYmhvb2sKICAgICAgICBpZiBhdmF0YXIgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIGF2YXRhciA9IHV0aWxzLl9ieXRlc190b19iYXNlNjRfZGF0YShhdmF0YXIpCgogICAgICAgIGRhdGEgPSBhd2FpdCBzZWxmLl9zdGF0ZS5odHRwLmNyZWF0ZV93ZWJob29rKHNlbGYuaWQsIG5hbWU9c3RyKG5hbWUpLCBhdmF0YXI9YXZhdGFyLCByZWFzb249cmVhc29uKQogICAgICAgIHJldHVybiBXZWJob29rLmZyb21fc3RhdGUoZGF0YSwgc3RhdGU9c2VsZi5fc3RhdGUpCgogICAgYXN5bmMgZGVmIGZvbGxvdyhzZWxmLCAqLCBkZXN0aW5hdGlvbiwgcmVhc29uPU5vbmUpOgogICAgICAgICIiIgogICAgICAgIEZvbGxvd3MgYSBjaGFubmVsIHVzaW5nIGEgd2ViaG9vay4KCiAgICAgICAgT25seSBuZXdzIGNoYW5uZWxzIGNhbiBiZSBmb2xsb3dlZC4KCiAgICAgICAgLi4gbm90ZTo6CgogICAgICAgICAgICBUaGUgd2ViaG9vayByZXR1cm5lZCB3aWxsIG5vdCBwcm92aWRlIGEgdG9rZW4gdG8gZG8gd2ViaG9vawogICAgICAgICAgICBhY3Rpb25zLCBhcyBEaXNjb3JkIGRvZXMgbm90IHByb3ZpZGUgaXQuCgogICAgICAgIC4uIHZlcnNpb25hZGRlZDo6IDEuMwoKICAgICAgICBQYXJhbWV0ZXJzCiAgICAgICAgLS0tLS0tLS0tLS0KICAgICAgICBkZXN0aW5hdGlvbjogOmNsYXNzOmBUZXh0Q2hhbm5lbGAKICAgICAgICAgICAgVGhlIGNoYW5uZWwgeW91IHdvdWxkIGxpa2UgdG8gZm9sbG93IGZyb20uCiAgICAgICAgcmVhc29uOiBPcHRpb25hbFs6Y2xhc3M6YHN0cmBdCiAgICAgICAgICAgIFRoZSByZWFzb24gZm9yIGZvbGxvd2luZyB0aGUgY2hhbm5lbC4gU2hvd3MgdXAgb24gdGhlIGRlc3RpbmF0aW9uIGd1aWxkJ3MgYXVkaXQgbG9nLgoKICAgICAgICAgICAgLi4gdmVyc2lvbmFkZGVkOjogMS40CgogICAgICAgIFJhaXNlcwogICAgICAgIC0tLS0tLS0KICAgICAgICBIVFRQRXhjZXB0aW9uCiAgICAgICAgICAgIEZvbGxvd2luZyB0aGUgY2hhbm5lbCBmYWlsZWQuCiAgICAgICAgRm9yYmlkZGVuCiAgICAgICAgICAgIFlvdSBkbyBub3QgaGF2ZSB0aGUgcGVybWlzc2lvbnMgdG8gY3JlYXRlIGEgd2ViaG9vay4KCiAgICAgICAgUmV0dXJucwogICAgICAgIC0tLS0tLS0tCiAgICAgICAgOmNsYXNzOmBXZWJob29rYAogICAgICAgICAgICBUaGUgY3JlYXRlZCB3ZWJob29rLgogICAgICAgICIiIgoKICAgICAgICBpZiBub3Qgc2VsZi5pc19uZXdzKCk6CiAgICAgICAgICAgIHJhaXNlIENsaWVudEV4Y2VwdGlvbignVGhlIGNoYW5uZWwgbXVzdCBiZSBhIG5ld3MgY2hhbm5lbC4nKQoKICAgICAgICBpZiBub3QgaXNpbnN0YW5jZShkZXN0aW5hdGlvbiwgVGV4dENoYW5uZWwpOgogICAgICAgICAgICByYWlzZSBJbnZhbGlkQXJndW1lbnQoJ0V4cGVjdGVkIFRleHRDaGFubmVsIHJlY2VpdmVkIHswLl9fbmFtZV9ffScuZm9ybWF0KHR5cGUoZGVzdGluYXRpb24pKSkKCiAgICAgICAgZnJvbSAud2ViaG9vayBpbXBvcnQgV2ViaG9vawogICAgICAgIGRhdGEgPSBhd2FpdCBzZWxmLl9zdGF0ZS5odHRwLmZvbGxvd193ZWJob29rKHNlbGYuaWQsIHdlYmhvb2tfY2hhbm5lbF9pZD1kZXN0aW5hdGlvbi5pZCwgcmVhc29uPXJlYXNvbikKICAgICAgICByZXR1cm4gV2ViaG9vay5fYXNfZm9sbG93ZXIoZGF0YSwgY2hhbm5lbD1kZXN0aW5hdGlvbiwgdXNlcj1zZWxmLl9zdGF0ZS51c2VyKQoKICAgIGRlZiBnZXRfcGFydGlhbF9tZXNzYWdlKHNlbGYsIG1lc3NhZ2VfaWQpOgogICAgICAgICIiIkNyZWF0ZXMgYSA6Y2xhc3M6YFBhcnRpYWxNZXNzYWdlYCBmcm9tIHRoZSBtZXNzYWdlIElELgoKICAgICAgICBUaGlzIGlzIHVzZWZ1bCBpZiB5b3Ugd2FudCB0byB3b3JrIHdpdGggYSBtZXNzYWdlIGFuZCBvbmx5IGhhdmUgaXRzIElEIHdpdGhvdXQKICAgICAgICBkb2luZyBhbiB1bm5lY2Vzc2FyeSBBUEkgY2FsbC4KCiAgICAgICAgLi4gdmVyc2lvbmFkZGVkOjogMS42CgogICAgICAgIFBhcmFtZXRlcnMKICAgICAgICAtLS0tLS0tLS0tLS0KICAgICAgICBtZXNzYWdlX2lkOiA6Y2xhc3M6YGludGAKICAgICAgICAgICAgVGhlIG1lc3NhZ2UgSUQgdG8gY3JlYXRlIGEgcGFydGlhbCBtZXNzYWdlIGZvci4KCiAgICAgICAgUmV0dXJucwogICAgICAgIC0tLS0tLS0tLQogICAgICAgIDpjbGFzczpgUGFydGlhbE1lc3NhZ2VgCiAgICAgICAgICAgIFRoZSBwYXJ0aWFsIG1lc3NhZ2UuCiAgICAgICAgIiIiCgogICAgICAgIGZyb20gLm1lc3NhZ2UgaW1wb3J0IFBhcnRpYWxNZXNzYWdlCiAgICAgICAgcmV0dXJuIFBhcnRpYWxNZXNzYWdlKGNoYW5uZWw9c2VsZiwgaWQ9bWVzc2FnZV9pZCkKCmNsYXNzIFZvY2FsR3VpbGRDaGFubmVsKGRpc2NvcmQuYWJjLkNvbm5lY3RhYmxlLCBkaXNjb3JkLmFiYy5HdWlsZENoYW5uZWwsIEhhc2hhYmxlKToKICAgIF9fc2xvdHNfXyA9ICgnbmFtZScsICdpZCcsICdndWlsZCcsICdiaXRyYXRlJywgJ3VzZXJfbGltaXQnLAogICAgICAgICAgICAgICAgICdfc3RhdGUnLCAncG9zaXRpb24nLCAnX292ZXJ3cml0ZXMnLCAnY2F0ZWdvcnlfaWQnLAogICAgICAgICAgICAgICAgICdydGNfcmVnaW9uJykKCiAgICBkZWYgX19pbml0X18oc2VsZiwgKiwgc3RhdGUsIGd1aWxkLCBkYXRhKToKICAgICAgICBzZWxmLl9zdGF0ZSA9IHN0YXRlCiAgICAgICAgc2VsZi5pZCA9IGludChkYXRhWydpZCddKQogICAgICAgIHNlbGYuX3VwZGF0ZShndWlsZCwgZGF0YSkKCiAgICBkZWYgX2dldF92b2ljZV9jbGllbnRfa2V5KHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmd1aWxkLmlkLCAnZ3VpbGRfaWQnCgogICAgZGVmIF9nZXRfdm9pY2Vfc3RhdGVfcGFpcihzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5ndWlsZC5pZCwgc2VsZi5pZAoKICAgIGRlZiBfdXBkYXRlKHNlbGYsIGd1aWxkLCBkYXRhKToKICAgICAgICBzZWxmLmd1aWxkID0gZ3VpbGQKICAgICAgICBzZWxmLm5hbWUgPSBkYXRhWyduYW1lJ10KICAgICAgICBzZWxmLnJ0Y19yZWdpb24gPSBkYXRhLmdldCgncnRjX3JlZ2lvbicpCiAgICAgICAgaWYgc2VsZi5ydGNfcmVnaW9uOgogICAgICAgICAgICBzZWxmLnJ0Y19yZWdpb24gPSB0cnlfZW51bShWb2ljZVJlZ2lvbiwgc2VsZi5ydGNfcmVnaW9uKQogICAgICAgIHNlbGYuY2F0ZWdvcnlfaWQgPSB1dGlscy5fZ2V0X2FzX3Nub3dmbGFrZShkYXRhLCAncGFyZW50X2lkJykKICAgICAgICBzZWxmLnBvc2l0aW9uID0gZGF0YVsncG9zaXRpb24nXQogICAgICAgIHNlbGYuYml0cmF0ZSA9IGRhdGEuZ2V0KCdiaXRyYXRlJykKICAgICAgICBzZWxmLnVzZXJfbGltaXQgPSBkYXRhLmdldCgndXNlcl9saW1pdCcpCiAgICAgICAgc2VsZi5fZmlsbF9vdmVyd3JpdGVzKGRhdGEpCgogICAgQHByb3BlcnR5CiAgICBkZWYgX3NvcnRpbmdfYnVja2V0KHNlbGYpOgogICAgICAgIHJldHVybiBDaGFubmVsVHlwZS52b2ljZS52YWx1ZQoKICAgIEBwcm9wZXJ0eQogICAgZGVmIG1lbWJlcnMoc2VsZik6CiAgICAgICAgIiIiTGlzdFs6Y2xhc3M6YE1lbWJlcmBdOiBSZXR1cm5zIGFsbCBtZW1iZXJzIHRoYXQgYXJlIGN1cnJlbnRseSBpbnNpZGUgdGhpcyB2b2ljZSBjaGFubmVsLiIiIgogICAgICAgIHJldCA9IFtdCiAgICAgICAgZm9yIHVzZXJfaWQsIHN0YXRlIGluIHNlbGYuZ3VpbGQuX3ZvaWNlX3N0YXRlcy5pdGVtcygpOgogICAgICAgICAgICBpZiBzdGF0ZS5jaGFubmVsIGFuZCBzdGF0ZS5jaGFubmVsLmlkID09IHNlbGYuaWQ6CiAgICAgICAgICAgICAgICBtZW1iZXIgPSBzZWxmLmd1aWxkLmdldF9tZW1iZXIodXNlcl9pZCkKICAgICAgICAgICAgICAgIGlmIG1lbWJlciBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgICAgICByZXQuYXBwZW5kKG1lbWJlcikKICAgICAgICByZXR1cm4gcmV0CgogICAgQHByb3BlcnR5CiAgICBkZWYgdm9pY2Vfc3RhdGVzKHNlbGYpOgogICAgICAgICIiIlJldHVybnMgYSBtYXBwaW5nIG9mIG1lbWJlciBJRHMgd2hvIGhhdmUgdm9pY2Ugc3RhdGVzIGluIHRoaXMgY2hhbm5lbC4KCiAgICAgICAgLi4gdmVyc2lvbmFkZGVkOjogMS4zCgogICAgICAgIC4uIG5vdGU6OgoKICAgICAgICAgICAgVGhpcyBmdW5jdGlvbiBpcyBpbnRlbnRpb25hbGx5IGxvdyBsZXZlbCB0byByZXBsYWNlIDphdHRyOmBtZW1iZXJzYAogICAgICAgICAgICB3aGVuIHRoZSBtZW1iZXIgY2FjaGUgaXMgdW5hdmFpbGFibGUuCgogICAgICAgIFJldHVybnMKICAgICAgICAtLS0tLS0tLQogICAgICAgIE1hcHBpbmdbOmNsYXNzOmBpbnRgLCA6Y2xhc3M6YFZvaWNlU3RhdGVgXQogICAgICAgICAgICBUaGUgbWFwcGluZyBvZiBtZW1iZXIgSUQgdG8gYSB2b2ljZSBzdGF0ZS4KICAgICAgICAiIiIKICAgICAgICByZXR1cm4ge2tleTogdmFsdWUgZm9yIGtleSwgdmFsdWUgaW4gc2VsZi5ndWlsZC5fdm9pY2Vfc3RhdGVzLml0ZW1zKCkgaWYgdmFsdWUuY2hhbm5lbC5pZCA9PSBzZWxmLmlkfQoKICAgIEB1dGlscy5jb3B5X2RvYyhkaXNjb3JkLmFiYy5HdWlsZENoYW5uZWwucGVybWlzc2lvbnNfZm9yKQogICAgZGVmIHBlcm1pc3Npb25zX2ZvcihzZWxmLCBtZW1iZXIpOgogICAgICAgIGJhc2UgPSBzdXBlcigpLnBlcm1pc3Npb25zX2ZvcihtZW1iZXIpCgogICAgICAgICMgdm9pY2UgY2hhbm5lbHMgY2Fubm90IGJlIGVkaXRlZCBieSBwZW9wbGUgd2hvIGNhbid0IGNvbm5lY3QgdG8gdGhlbQogICAgICAgICMgSXQgYWxzbyBpbXBsaWNpdGx5IGRlbmllcyBhbGwgb3RoZXIgdm9pY2UgcGVybXMKICAgICAgICBpZiBub3QgYmFzZS5jb25uZWN0OgogICAgICAgICAgICBkZW5pZWQgPSBQZXJtaXNzaW9ucy52b2ljZSgpCiAgICAgICAgICAgIGRlbmllZC51cGRhdGUobWFuYWdlX2NoYW5uZWxzPVRydWUsIG1hbmFnZV9yb2xlcz1UcnVlKQogICAgICAgICAgICBiYXNlLnZhbHVlICY9IH5kZW5pZWQudmFsdWUKICAgICAgICByZXR1cm4gYmFzZQoKY2xhc3MgVm9pY2VDaGFubmVsKFZvY2FsR3VpbGRDaGFubmVsKToKICAgICIiIlJlcHJlc2VudHMgYSBEaXNjb3JkIGd1aWxkIHZvaWNlIGNoYW5uZWwuCgogICAgLi4gY29udGFpbmVyOjogb3BlcmF0aW9ucwoKICAgICAgICAuLiBkZXNjcmliZTo6IHggPT0geQoKICAgICAgICAgICAgQ2hlY2tzIGlmIHR3byBjaGFubmVscyBhcmUgZXF1YWwuCgogICAgICAgIC4uIGRlc2NyaWJlOjogeCAhPSB5CgogICAgICAgICAgICBDaGVja3MgaWYgdHdvIGNoYW5uZWxzIGFyZSBub3QgZXF1YWwuCgogICAgICAgIC4uIGRlc2NyaWJlOjogaGFzaCh4KQoKICAgICAgICAgICAgUmV0dXJucyB0aGUgY2hhbm5lbCdzIGhhc2guCgogICAgICAgIC4uIGRlc2NyaWJlOjogc3RyKHgpCgogICAgICAgICAgICBSZXR1cm5zIHRoZSBjaGFubmVsJ3MgbmFtZS4KCiAgICBBdHRyaWJ1dGVzCiAgICAtLS0tLS0tLS0tLQogICAgbmFtZTogOmNsYXNzOmBzdHJgCiAgICAgICAgVGhlIGNoYW5uZWwgbmFtZS4KICAgIGd1aWxkOiA6Y2xhc3M6YEd1aWxkYAogICAgICAgIFRoZSBndWlsZCB0aGUgY2hhbm5lbCBiZWxvbmdzIHRvLgogICAgaWQ6IDpjbGFzczpgaW50YAogICAgICAgIFRoZSBjaGFubmVsIElELgogICAgY2F0ZWdvcnlfaWQ6IE9wdGlvbmFsWzpjbGFzczpgaW50YF0KICAgICAgICBUaGUgY2F0ZWdvcnkgY2hhbm5lbCBJRCB0aGlzIGNoYW5uZWwgYmVsb25ncyB0bywgaWYgYXBwbGljYWJsZS4KICAgIHBvc2l0aW9uOiA6Y2xhc3M6YGludGAKICAgICAgICBUaGUgcG9zaXRpb24gaW4gdGhlIGNoYW5uZWwgbGlzdC4gVGhpcyBpcyBhIG51bWJlciB0aGF0IHN0YXJ0cyBhdCAwLiBlLmcuIHRoZQogICAgICAgIHRvcCBjaGFubmVsIGlzIHBvc2l0aW9uIDAuCiAgICBiaXRyYXRlOiA6Y2xhc3M6YGludGAKICAgICAgICBUaGUgY2hhbm5lbCdzIHByZWZlcnJlZCBhdWRpbyBiaXRyYXRlIGluIGJpdHMgcGVyIHNlY29uZC4KICAgIHVzZXJfbGltaXQ6IDpjbGFzczpgaW50YAogICAgICAgIFRoZSBjaGFubmVsJ3MgbGltaXQgZm9yIG51bWJlciBvZiBtZW1iZXJzIHRoYXQgY2FuIGJlIGluIGEgdm9pY2UgY2hhbm5lbC4KICAgIHJ0Y19yZWdpb246IE9wdGlvbmFsWzpjbGFzczpgVm9pY2VSZWdpb25gXQogICAgICAgIFRoZSByZWdpb24gZm9yIHRoZSB2b2ljZSBjaGFubmVsJ3Mgdm9pY2UgY29tbXVuaWNhdGlvbi4KICAgICAgICBBIHZhbHVlIG9mIGBgTm9uZWBgIGluZGljYXRlcyBhdXRvbWF0aWMgdm9pY2UgcmVnaW9uIGRldGVjdGlvbi4KCiAgICAgICAgLi4gdmVyc2lvbmFkZGVkOjogMS43CiAgICAiIiIKCiAgICBfX3Nsb3RzX18gPSAoKQoKICAgIGRlZiBfX3JlcHJfXyhzZWxmKToKICAgICAgICBhdHRycyA9IFsKICAgICAgICAgICAgKCdpZCcsIHNlbGYuaWQpLAogICAgICAgICAgICAoJ25hbWUnLCBzZWxmLm5hbWUpLAogICAgICAgICAgICAoJ3J0Y19yZWdpb24nLCBzZWxmLnJ0Y19yZWdpb24pLAogICAgICAgICAgICAoJ3Bvc2l0aW9uJywgc2VsZi5wb3NpdGlvbiksCiAgICAgICAgICAgICgnYml0cmF0ZScsIHNlbGYuYml0cmF0ZSksCiAgICAgICAgICAgICgndXNlcl9saW1pdCcsIHNlbGYudXNlcl9saW1pdCksCiAgICAgICAgICAgICgnY2F0ZWdvcnlfaWQnLCBzZWxmLmNhdGVnb3J5X2lkKQogICAgICAgIF0KICAgICAgICByZXR1cm4gJzwlcyAlcz4nICUgKHNlbGYuX19jbGFzc19fLl9fbmFtZV9fLCAnICcuam9pbignJXM9JXInICUgdCBmb3IgdCBpbiBhdHRycykpCgogICAgQHByb3BlcnR5CiAgICBkZWYgdHlwZShzZWxmKToKICAgICAgICAiIiI6Y2xhc3M6YENoYW5uZWxUeXBlYDogVGhlIGNoYW5uZWwncyBEaXNjb3JkIHR5cGUuIiIiCiAgICAgICAgcmV0dXJuIENoYW5uZWxUeXBlLnZvaWNlCgogICAgQHV0aWxzLmNvcHlfZG9jKGRpc2NvcmQuYWJjLkd1aWxkQ2hhbm5lbC5jbG9uZSkKICAgIGFzeW5jIGRlZiBjbG9uZShzZWxmLCAqLCBuYW1lPU5vbmUsIHJlYXNvbj1Ob25lKToKICAgICAgICByZXR1cm4gYXdhaXQgc2VsZi5fY2xvbmVfaW1wbCh7CiAgICAgICAgICAgICdiaXRyYXRlJzogc2VsZi5iaXRyYXRlLAogICAgICAgICAgICAndXNlcl9saW1pdCc6IHNlbGYudXNlcl9saW1pdAogICAgICAgIH0sIG5hbWU9bmFtZSwgcmVhc29uPXJlYXNvbikKCiAgICBhc3luYyBkZWYgZWRpdChzZWxmLCAqLCByZWFzb249Tm9uZSwgKipvcHRpb25zKToKICAgICAgICAiIiJ8Y29yb3wKCiAgICAgICAgRWRpdHMgdGhlIGNoYW5uZWwuCgogICAgICAgIFlvdSBtdXN0IGhhdmUgdGhlIDphdHRyOmB+UGVybWlzc2lvbnMubWFuYWdlX2NoYW5uZWxzYCBwZXJtaXNzaW9uIHRvCiAgICAgICAgdXNlIHRoaXMuCgogICAgICAgIC4uIHZlcnNpb25jaGFuZ2VkOjogMS4zCiAgICAgICAgICAgIFRoZSBgYG92ZXJ3cml0ZXNgYCBrZXl3b3JkLW9ubHkgcGFyYW1ldGVyIHdhcyBhZGRlZC4KCiAgICAgICAgUGFyYW1ldGVycwogICAgICAgIC0tLS0tLS0tLS0KICAgICAgICBuYW1lOiA6Y2xhc3M6YHN0cmAKICAgICAgICAgICAgVGhlIG5ldyBjaGFubmVsJ3MgbmFtZS4KICAgICAgICBiaXRyYXRlOiA6Y2xhc3M6YGludGAKICAgICAgICAgICAgVGhlIG5ldyBjaGFubmVsJ3MgYml0cmF0ZS4KICAgICAgICB1c2VyX2xpbWl0OiA6Y2xhc3M6YGludGAKICAgICAgICAgICAgVGhlIG5ldyBjaGFubmVsJ3MgdXNlciBsaW1pdC4KICAgICAgICBwb3NpdGlvbjogOmNsYXNzOmBpbnRgCiAgICAgICAgICAgIFRoZSBuZXcgY2hhbm5lbCdzIHBvc2l0aW9uLgogICAgICAgIHN5bmNfcGVybWlzc2lvbnM6IDpjbGFzczpgYm9vbGAKICAgICAgICAgICAgV2hldGhlciB0byBzeW5jIHBlcm1pc3Npb25zIHdpdGggdGhlIGNoYW5uZWwncyBuZXcgb3IgcHJlLWV4aXN0aW5nCiAgICAgICAgICAgIGNhdGVnb3J5LiBEZWZhdWx0cyB0byBgYEZhbHNlYGAuCiAgICAgICAgY2F0ZWdvcnk6IE9wdGlvbmFsWzpjbGFzczpgQ2F0ZWdvcnlDaGFubmVsYF0KICAgICAgICAgICAgVGhlIG5ldyBjYXRlZ29yeSBmb3IgdGhpcyBjaGFubmVsLiBDYW4gYmUgYGBOb25lYGAgdG8gcmVtb3ZlIHRoZQogICAgICAgICAgICBjYXRlZ29yeS4KICAgICAgICByZWFzb246IE9wdGlvbmFsWzpjbGFzczpgc3RyYF0KICAgICAgICAgICAgVGhlIHJlYXNvbiBmb3IgZWRpdGluZyB0aGlzIGNoYW5uZWwuIFNob3dzIHVwIG9uIHRoZSBhdWRpdCBsb2cuCiAgICAgICAgb3ZlcndyaXRlczogOmNsYXNzOmBkaWN0YAogICAgICAgICAgICBBIDpjbGFzczpgZGljdGAgb2YgdGFyZ2V0IChlaXRoZXIgYSByb2xlIG9yIGEgbWVtYmVyKSB0bwogICAgICAgICAgICA6Y2xhc3M6YFBlcm1pc3Npb25PdmVyd3JpdGVgIHRvIGFwcGx5IHRvIHRoZSBjaGFubmVsLgogICAgICAgIHJ0Y19yZWdpb246IE9wdGlvbmFsWzpjbGFzczpgVm9pY2VSZWdpb25gXQogICAgICAgICAgICBUaGUgbmV3IHJlZ2lvbiBmb3IgdGhlIHZvaWNlIGNoYW5uZWwncyB2b2ljZSBjb21tdW5pY2F0aW9uLgogICAgICAgICAgICBBIHZhbHVlIG9mIGBgTm9uZWBgIGluZGljYXRlcyBhdXRvbWF0aWMgdm9pY2UgcmVnaW9uIGRldGVjdGlvbi4KCiAgICAgICAgICAgIC4uIHZlcnNpb25hZGRlZDo6IDEuNwoKICAgICAgICBSYWlzZXMKICAgICAgICAtLS0tLS0KICAgICAgICBJbnZhbGlkQXJndW1lbnQKICAgICAgICAgICAgSWYgdGhlIHBlcm1pc3Npb24gb3ZlcndyaXRlIGluZm9ybWF0aW9uIGlzIG5vdCBpbiBwcm9wZXIgZm9ybS4KICAgICAgICBGb3JiaWRkZW4KICAgICAgICAgICAgWW91IGRvIG5vdCBoYXZlIHBlcm1pc3Npb25zIHRvIGVkaXQgdGhlIGNoYW5uZWwuCiAgICAgICAgSFRUUEV4Y2VwdGlvbgogICAgICAgICAgICBFZGl0aW5nIHRoZSBjaGFubmVsIGZhaWxlZC4KICAgICAgICAiIiIKCiAgICAgICAgYXdhaXQgc2VsZi5fZWRpdChvcHRpb25zLCByZWFzb249cmVhc29uKQoKY2xhc3MgU3RhZ2VDaGFubmVsKFZvY2FsR3VpbGRDaGFubmVsKToKICAgICIiIlJlcHJlc2VudHMgYSBEaXNjb3JkIGd1aWxkIHN0YWdlIGNoYW5uZWwuCgogICAgLi4gdmVyc2lvbmFkZGVkOjogMS43CgogICAgLi4gY29udGFpbmVyOjogb3BlcmF0aW9ucwoKICAgICAgICAuLiBkZXNjcmliZTo6IHggPT0geQoKICAgICAgICAgICAgQ2hlY2tzIGlmIHR3byBjaGFubmVscyBhcmUgZXF1YWwuCgogICAgICAgIC4uIGRlc2NyaWJlOjogeCAhPSB5CgogICAgICAgICAgICBDaGVja3MgaWYgdHdvIGNoYW5uZWxzIGFyZSBub3QgZXF1YWwuCgogICAgICAgIC4uIGRlc2NyaWJlOjogaGFzaCh4KQoKICAgICAgICAgICAgUmV0dXJucyB0aGUgY2hhbm5lbCdzIGhhc2guCgogICAgICAgIC4uIGRlc2NyaWJlOjogc3RyKHgpCgogICAgICAgICAgICBSZXR1cm5zIHRoZSBjaGFubmVsJ3MgbmFtZS4KCiAgICBBdHRyaWJ1dGVzCiAgICAtLS0tLS0tLS0tLQogICAgbmFtZTogOmNsYXNzOmBzdHJgCiAgICAgICAgVGhlIGNoYW5uZWwgbmFtZS4KICAgIGd1aWxkOiA6Y2xhc3M6YEd1aWxkYAogICAgICAgIFRoZSBndWlsZCB0aGUgY2hhbm5lbCBiZWxvbmdzIHRvLgogICAgaWQ6IDpjbGFzczpgaW50YAogICAgICAgIFRoZSBjaGFubmVsIElELgogICAgdG9waWM6IE9wdGlvbmFsWzpjbGFzczpgc3RyYF0KICAgICAgICBUaGUgY2hhbm5lbCdzIHRvcGljLiBgYE5vbmVgYCBpZiBpdCBpc24ndCBzZXQuCiAgICBjYXRlZ29yeV9pZDogT3B0aW9uYWxbOmNsYXNzOmBpbnRgXQogICAgICAgIFRoZSBjYXRlZ29yeSBjaGFubmVsIElEIHRoaXMgY2hhbm5lbCBiZWxvbmdzIHRvLCBpZiBhcHBsaWNhYmxlLgogICAgcG9zaXRpb246IDpjbGFzczpgaW50YAogICAgICAgIFRoZSBwb3NpdGlvbiBpbiB0aGUgY2hhbm5lbCBsaXN0LiBUaGlzIGlzIGEgbnVtYmVyIHRoYXQgc3RhcnRzIGF0IDAuIGUuZy4gdGhlCiAgICAgICAgdG9wIGNoYW5uZWwgaXMgcG9zaXRpb24gMC4KICAgIGJpdHJhdGU6IDpjbGFzczpgaW50YAogICAgICAgIFRoZSBjaGFubmVsJ3MgcHJlZmVycmVkIGF1ZGlvIGJpdHJhdGUgaW4gYml0cyBwZXIgc2Vjb25kLgogICAgdXNlcl9saW1pdDogOmNsYXNzOmBpbnRgCiAgICAgICAgVGhlIGNoYW5uZWwncyBsaW1pdCBmb3IgbnVtYmVyIG9mIG1lbWJlcnMgdGhhdCBjYW4gYmUgaW4gYSBzdGFnZSBjaGFubmVsLgogICAgcnRjX3JlZ2lvbjogT3B0aW9uYWxbOmNsYXNzOmBWb2ljZVJlZ2lvbmBdCiAgICAgICAgVGhlIHJlZ2lvbiBmb3IgdGhlIHN0YWdlIGNoYW5uZWwncyB2b2ljZSBjb21tdW5pY2F0aW9uLgogICAgICAgIEEgdmFsdWUgb2YgYGBOb25lYGAgaW5kaWNhdGVzIGF1dG9tYXRpYyB2b2ljZSByZWdpb24gZGV0ZWN0aW9uLgogICAgIiIiCiAgICBfX3Nsb3RzX18gPSAoJ3RvcGljJywpCgogICAgZGVmIF9fcmVwcl9fKHNlbGYpOgogICAgICAgIGF0dHJzID0gWwogICAgICAgICAgICAoJ2lkJywgc2VsZi5pZCksCiAgICAgICAgICAgICgnbmFtZScsIHNlbGYubmFtZSksCiAgICAgICAgICAgICgndG9waWMnLCBzZWxmLnRvcGljKSwKICAgICAgICAgICAgKCdydGNfcmVnaW9uJywgc2VsZi5ydGNfcmVnaW9uKSwKICAgICAgICAgICAgKCdwb3NpdGlvbicsIHNlbGYucG9zaXRpb24pLAogICAgICAgICAgICAoJ2JpdHJhdGUnLCBzZWxmLmJpdHJhdGUpLAogICAgICAgICAgICAoJ3VzZXJfbGltaXQnLCBzZWxmLnVzZXJfbGltaXQpLAogICAgICAgICAgICAoJ2NhdGVnb3J5X2lkJywgc2VsZi5jYXRlZ29yeV9pZCkKICAgICAgICBdCiAgICAgICAgcmV0dXJuICc8JXMgJXM+JyAlIChzZWxmLl9fY2xhc3NfXy5fX25hbWVfXywgJyAnLmpvaW4oJyVzPSVyJyAlIHQgZm9yIHQgaW4gYXR0cnMpKQoKICAgIGRlZiBfdXBkYXRlKHNlbGYsIGd1aWxkLCBkYXRhKToKICAgICAgICBzdXBlcigpLl91cGRhdGUoZ3VpbGQsIGRhdGEpCiAgICAgICAgc2VsZi50b3BpYyA9IGRhdGEuZ2V0KCd0b3BpYycpCgogICAgQHByb3BlcnR5CiAgICBkZWYgcmVxdWVzdGluZ190b19zcGVhayhzZWxmKToKICAgICAgICAiIiJMaXN0WzpjbGFzczpgTWVtYmVyYF06IEEgbGlzdCBvZiBtZW1iZXJzIHdobyBhcmUgcmVxdWVzdGluZyB0byBzcGVhayBpbiB0aGUgc3RhZ2UgY2hhbm5lbC4iIiIKICAgICAgICByZXR1cm4gW21lbWJlciBmb3IgbWVtYmVyIGluIHNlbGYubWVtYmVycyBpZiBtZW1iZXIudm9pY2UucmVxdWVzdGVkX3RvX3NwZWFrX2F0IGlzIG5vdCBOb25lXQoKICAgIEBwcm9wZXJ0eQogICAgZGVmIHR5cGUoc2VsZik6CiAgICAgICAgIiIiOmNsYXNzOmBDaGFubmVsVHlwZWA6IFRoZSBjaGFubmVsJ3MgRGlzY29yZCB0eXBlLiIiIgogICAgICAgIHJldHVybiBDaGFubmVsVHlwZS5zdGFnZV92b2ljZQoKICAgIEB1dGlscy5jb3B5X2RvYyhkaXNjb3JkLmFiYy5HdWlsZENoYW5uZWwuY2xvbmUpCiAgICBhc3luYyBkZWYgY2xvbmUoc2VsZiwgKiwgbmFtZT1Ob25lLCByZWFzb249Tm9uZSk6CiAgICAgICAgcmV0dXJuIGF3YWl0IHNlbGYuX2Nsb25lX2ltcGwoewogICAgICAgICAgICAndG9waWMnOiBzZWxmLnRvcGljLAogICAgICAgIH0sIG5hbWU9bmFtZSwgcmVhc29uPXJlYXNvbikKCiAgICBhc3luYyBkZWYgZWRpdChzZWxmLCAqLCByZWFzb249Tm9uZSwgKipvcHRpb25zKToKICAgICAgICAiIiJ8Y29yb3wKCiAgICAgICAgRWRpdHMgdGhlIGNoYW5uZWwuCgogICAgICAgIFlvdSBtdXN0IGhhdmUgdGhlIDphdHRyOmB+UGVybWlzc2lvbnMubWFuYWdlX2NoYW5uZWxzYCBwZXJtaXNzaW9uIHRvCiAgICAgICAgdXNlIHRoaXMuCgogICAgICAgIFBhcmFtZXRlcnMKICAgICAgICAtLS0tLS0tLS0tCiAgICAgICAgbmFtZTogOmNsYXNzOmBzdHJgCiAgICAgICAgICAgIFRoZSBuZXcgY2hhbm5lbCdzIG5hbWUuCiAgICAgICAgdG9waWM6IDpjbGFzczpgc3RyYAogICAgICAgICAgICBUaGUgbmV3IGNoYW5uZWwncyB0b3BpYy4KICAgICAgICBwb3NpdGlvbjogOmNsYXNzOmBpbnRgCiAgICAgICAgICAgIFRoZSBuZXcgY2hhbm5lbCdzIHBvc2l0aW9uLgogICAgICAgIHN5bmNfcGVybWlzc2lvbnM6IDpjbGFzczpgYm9vbGAKICAgICAgICAgICAgV2hldGhlciB0byBzeW5jIHBlcm1pc3Npb25zIHdpdGggdGhlIGNoYW5uZWwncyBuZXcgb3IgcHJlLWV4aXN0aW5nCiAgICAgICAgICAgIGNhdGVnb3J5LiBEZWZhdWx0cyB0byBgYEZhbHNlYGAuCiAgICAgICAgY2F0ZWdvcnk6IE9wdGlvbmFsWzpjbGFzczpgQ2F0ZWdvcnlDaGFubmVsYF0KICAgICAgICAgICAgVGhlIG5ldyBjYXRlZ29yeSBmb3IgdGhpcyBjaGFubmVsLiBDYW4gYmUgYGBOb25lYGAgdG8gcmVtb3ZlIHRoZQogICAgICAgICAgICBjYXRlZ29yeS4KICAgICAgICByZWFzb246IE9wdGlvbmFsWzpjbGFzczpgc3RyYF0KICAgICAgICAgICAgVGhlIHJlYXNvbiBmb3IgZWRpdGluZyB0aGlzIGNoYW5uZWwuIFNob3dzIHVwIG9uIHRoZSBhdWRpdCBsb2cuCiAgICAgICAgb3ZlcndyaXRlczogOmNsYXNzOmBkaWN0YAogICAgICAgICAgICBBIDpjbGFzczpgZGljdGAgb2YgdGFyZ2V0IChlaXRoZXIgYSByb2xlIG9yIGEgbWVtYmVyKSB0bwogICAgICAgICAgICA6Y2xhc3M6YFBlcm1pc3Npb25PdmVyd3JpdGVgIHRvIGFwcGx5IHRvIHRoZSBjaGFubmVsLgogICAgICAgIHJ0Y19yZWdpb246IE9wdGlvbmFsWzpjbGFzczpgVm9pY2VSZWdpb25gXQogICAgICAgICAgICBUaGUgbmV3IHJlZ2lvbiBmb3IgdGhlIHN0YWdlIGNoYW5uZWwncyB2b2ljZSBjb21tdW5pY2F0aW9uLgogICAgICAgICAgICBBIHZhbHVlIG9mIGBgTm9uZWBgIGluZGljYXRlcyBhdXRvbWF0aWMgdm9pY2UgcmVnaW9uIGRldGVjdGlvbi4KCiAgICAgICAgUmFpc2VzCiAgICAgICAgLS0tLS0tCiAgICAgICAgSW52YWxpZEFyZ3VtZW50CiAgICAgICAgICAgIElmIHRoZSBwZXJtaXNzaW9uIG92ZXJ3cml0ZSBpbmZvcm1hdGlvbiBpcyBub3QgaW4gcHJvcGVyIGZvcm0uCiAgICAgICAgRm9yYmlkZGVuCiAgICAgICAgICAgIFlvdSBkbyBub3QgaGF2ZSBwZXJtaXNzaW9ucyB0byBlZGl0IHRoZSBjaGFubmVsLgogICAgICAgIEhUVFBFeGNlcHRpb24KICAgICAgICAgICAgRWRpdGluZyB0aGUgY2hhbm5lbCBmYWlsZWQuCiAgICAgICAgIiIiCgogICAgICAgIGF3YWl0IHNlbGYuX2VkaXQob3B0aW9ucywgcmVhc29uPXJlYXNvbikKCmNsYXNzIENhdGVnb3J5Q2hhbm5lbChkaXNjb3JkLmFiYy5HdWlsZENoYW5uZWwsIEhhc2hhYmxlKToKICAgICIiIlJlcHJlc2VudHMgYSBEaXNjb3JkIGNoYW5uZWwgY2F0ZWdvcnkuCgogICAgVGhlc2UgYXJlIHVzZWZ1bCB0byBncm91cCBjaGFubmVscyB0byBsb2dpY2FsIGNvbXBhcnRtZW50cy4KCiAgICAuLiBjb250YWluZXI6OiBvcGVyYXRpb25zCgogICAgICAgIC4uIGRlc2NyaWJlOjogeCA9PSB5CgogICAgICAgICAgICBDaGVja3MgaWYgdHdvIGNoYW5uZWxzIGFyZSBlcXVhbC4KCiAgICAgICAgLi4gZGVzY3JpYmU6OiB4ICE9IHkKCiAgICAgICAgICAgIENoZWNrcyBpZiB0d28gY2hhbm5lbHMgYXJlIG5vdCBlcXVhbC4KCiAgICAgICAgLi4gZGVzY3JpYmU6OiBoYXNoKHgpCgogICAgICAgICAgICBSZXR1cm5zIHRoZSBjYXRlZ29yeSdzIGhhc2guCgogICAgICAgIC4uIGRlc2NyaWJlOjogc3RyKHgpCgogICAgICAgICAgICBSZXR1cm5zIHRoZSBjYXRlZ29yeSdzIG5hbWUuCgogICAgQXR0cmlidXRlcwogICAgLS0tLS0tLS0tLS0KICAgIG5hbWU6IDpjbGFzczpgc3RyYAogICAgICAgIFRoZSBjYXRlZ29yeSBuYW1lLgogICAgZ3VpbGQ6IDpjbGFzczpgR3VpbGRgCiAgICAgICAgVGhlIGd1aWxkIHRoZSBjYXRlZ29yeSBiZWxvbmdzIHRvLgogICAgaWQ6IDpjbGFzczpgaW50YAogICAgICAgIFRoZSBjYXRlZ29yeSBjaGFubmVsIElELgogICAgcG9zaXRpb246IDpjbGFzczpgaW50YAogICAgICAgIFRoZSBwb3NpdGlvbiBpbiB0aGUgY2F0ZWdvcnkgbGlzdC4gVGhpcyBpcyBhIG51bWJlciB0aGF0IHN0YXJ0cyBhdCAwLiBlLmcuIHRoZQogICAgICAgIHRvcCBjYXRlZ29yeSBpcyBwb3NpdGlvbiAwLgogICAgIiIiCgogICAgX19zbG90c19fID0gKCduYW1lJywgJ2lkJywgJ2d1aWxkJywgJ25zZncnLCAnX3N0YXRlJywgJ3Bvc2l0aW9uJywgJ19vdmVyd3JpdGVzJywgJ2NhdGVnb3J5X2lkJykKCiAgICBkZWYgX19pbml0X18oc2VsZiwgKiwgc3RhdGUsIGd1aWxkLCBkYXRhKToKICAgICAgICBzZWxmLl9zdGF0ZSA9IHN0YXRlCiAgICAgICAgc2VsZi5pZCA9IGludChkYXRhWydpZCddKQogICAgICAgIHNlbGYuX3VwZGF0ZShndWlsZCwgZGF0YSkKCiAgICBkZWYgX19yZXByX18oc2VsZik6CiAgICAgICAgcmV0dXJuICc8Q2F0ZWdvcnlDaGFubmVsIGlkPXswLmlkfSBuYW1lPXswLm5hbWUhcn0gcG9zaXRpb249ezAucG9zaXRpb259IG5zZnc9ezAubnNmd30+Jy5mb3JtYXQoc2VsZikKCiAgICBkZWYgX3VwZGF0ZShzZWxmLCBndWlsZCwgZGF0YSk6CiAgICAgICAgc2VsZi5ndWlsZCA9IGd1aWxkCiAgICAgICAgc2VsZi5uYW1lID0gZGF0YVsnbmFtZSddCiAgICAgICAgc2VsZi5jYXRlZ29yeV9pZCA9IHV0aWxzLl9nZXRfYXNfc25vd2ZsYWtlKGRhdGEsICdwYXJlbnRfaWQnKQogICAgICAgIHNlbGYubnNmdyA9IGRhdGEuZ2V0KCduc2Z3JywgRmFsc2UpCiAgICAgICAgc2VsZi5wb3NpdGlvbiA9IGRhdGFbJ3Bvc2l0aW9uJ10KICAgICAgICBzZWxmLl9maWxsX292ZXJ3cml0ZXMoZGF0YSkKCiAgICBAcHJvcGVydHkKICAgIGRlZiBfc29ydGluZ19idWNrZXQoc2VsZik6CiAgICAgICAgcmV0dXJuIENoYW5uZWxUeXBlLmNhdGVnb3J5LnZhbHVlCgogICAgQHByb3BlcnR5CiAgICBkZWYgdHlwZShzZWxmKToKICAgICAgICAiIiI6Y2xhc3M6YENoYW5uZWxUeXBlYDogVGhlIGNoYW5uZWwncyBEaXNjb3JkIHR5cGUuIiIiCiAgICAgICAgcmV0dXJuIENoYW5uZWxUeXBlLmNhdGVnb3J5CgogICAgZGVmIGlzX25zZncoc2VsZik6CiAgICAgICAgIiIiOmNsYXNzOmBib29sYDogQ2hlY2tzIGlmIHRoZSBjYXRlZ29yeSBpcyBOU0ZXLiIiIgogICAgICAgIHJldHVybiBzZWxmLm5zZncKCiAgICBAdXRpbHMuY29weV9kb2MoZGlzY29yZC5hYmMuR3VpbGRDaGFubmVsLmNsb25lKQogICAgYXN5bmMgZGVmIGNsb25lKHNlbGYsICosIG5hbWU9Tm9uZSwgcmVhc29uPU5vbmUpOgogICAgICAgIHJldHVybiBhd2FpdCBzZWxmLl9jbG9uZV9pbXBsKHsKICAgICAgICAgICAgJ25zZncnOiBzZWxmLm5zZncKICAgICAgICB9LCBuYW1lPW5hbWUsIHJlYXNvbj1yZWFzb24pCgogICAgYXN5bmMgZGVmIGVkaXQoc2VsZiwgKiwgcmVhc29uPU5vbmUsICoqb3B0aW9ucyk6CiAgICAgICAgIiIifGNvcm98CgogICAgICAgIEVkaXRzIHRoZSBjaGFubmVsLgoKICAgICAgICBZb3UgbXVzdCBoYXZlIHRoZSA6YXR0cjpgflBlcm1pc3Npb25zLm1hbmFnZV9jaGFubmVsc2AgcGVybWlzc2lvbiB0bwogICAgICAgIHVzZSB0aGlzLgoKICAgICAgICAuLiB2ZXJzaW9uY2hhbmdlZDo6IDEuMwogICAgICAgICAgICBUaGUgYGBvdmVyd3JpdGVzYGAga2V5d29yZC1vbmx5IHBhcmFtZXRlciB3YXMgYWRkZWQuCgogICAgICAgIFBhcmFtZXRlcnMKICAgICAgICAtLS0tLS0tLS0tCiAgICAgICAgbmFtZTogOmNsYXNzOmBzdHJgCiAgICAgICAgICAgIFRoZSBuZXcgY2F0ZWdvcnkncyBuYW1lLgogICAgICAgIHBvc2l0aW9uOiA6Y2xhc3M6YGludGAKICAgICAgICAgICAgVGhlIG5ldyBjYXRlZ29yeSdzIHBvc2l0aW9uLgogICAgICAgIG5zZnc6IDpjbGFzczpgYm9vbGAKICAgICAgICAgICAgVG8gbWFyayB0aGUgY2F0ZWdvcnkgYXMgTlNGVyBvciBub3QuCiAgICAgICAgcmVhc29uOiBPcHRpb25hbFs6Y2xhc3M6YHN0cmBdCiAgICAgICAgICAgIFRoZSByZWFzb24gZm9yIGVkaXRpbmcgdGhpcyBjYXRlZ29yeS4gU2hvd3MgdXAgb24gdGhlIGF1ZGl0IGxvZy4KICAgICAgICBvdmVyd3JpdGVzOiA6Y2xhc3M6YGRpY3RgCiAgICAgICAgICAgIEEgOmNsYXNzOmBkaWN0YCBvZiB0YXJnZXQgKGVpdGhlciBhIHJvbGUgb3IgYSBtZW1iZXIpIHRvCiAgICAgICAgICAgIDpjbGFzczpgUGVybWlzc2lvbk92ZXJ3cml0ZWAgdG8gYXBwbHkgdG8gdGhlIGNoYW5uZWwuCgogICAgICAgIFJhaXNlcwogICAgICAgIC0tLS0tLQogICAgICAgIEludmFsaWRBcmd1bWVudAogICAgICAgICAgICBJZiBwb3NpdGlvbiBpcyBsZXNzIHRoYW4gMCBvciBncmVhdGVyIHRoYW4gdGhlIG51bWJlciBvZiBjYXRlZ29yaWVzLgogICAgICAgIEZvcmJpZGRlbgogICAgICAgICAgICBZb3UgZG8gbm90IGhhdmUgcGVybWlzc2lvbnMgdG8gZWRpdCB0aGUgY2F0ZWdvcnkuCiAgICAgICAgSFRUUEV4Y2VwdGlvbgogICAgICAgICAgICBFZGl0aW5nIHRoZSBjYXRlZ29yeSBmYWlsZWQuCiAgICAgICAgIiIiCgogICAgICAgIGF3YWl0IHNlbGYuX2VkaXQob3B0aW9ucz1vcHRpb25zLCByZWFzb249cmVhc29uKQoKICAgIEB1dGlscy5jb3B5X2RvYyhkaXNjb3JkLmFiYy5HdWlsZENoYW5uZWwubW92ZSkKICAgIGFzeW5jIGRlZiBtb3ZlKHNlbGYsICoqa3dhcmdzKToKICAgICAgICBrd2FyZ3MucG9wKCdjYXRlZ29yeScsIE5vbmUpCiAgICAgICAgYXdhaXQgc3VwZXIoKS5tb3ZlKCoqa3dhcmdzKQoKICAgIEBwcm9wZXJ0eQogICAgZGVmIGNoYW5uZWxzKHNlbGYpOgogICAgICAgICIiIkxpc3RbOmNsYXNzOmBhYmMuR3VpbGRDaGFubmVsYF06IFJldHVybnMgdGhlIGNoYW5uZWxzIHRoYXQgYXJlIHVuZGVyIHRoaXMgY2F0ZWdvcnkuCgogICAgICAgIFRoZXNlIGFyZSBzb3J0ZWQgYnkgdGhlIG9mZmljaWFsIERpc2NvcmQgVUksIHdoaWNoIHBsYWNlcyB2b2ljZSBjaGFubmVscyBiZWxvdyB0aGUgdGV4dCBjaGFubmVscy4KICAgICAgICAiIiIKICAgICAgICBkZWYgY29tcGFyYXRvcihjaGFubmVsKToKICAgICAgICAgICAgcmV0dXJuIChub3QgaXNpbnN0YW5jZShjaGFubmVsLCBUZXh0Q2hhbm5lbCksIGNoYW5uZWwucG9zaXRpb24pCgogICAgICAgIHJldCA9IFtjIGZvciBjIGluIHNlbGYuZ3VpbGQuY2hhbm5lbHMgaWYgYy5jYXRlZ29yeV9pZCA9PSBzZWxmLmlkXQogICAgICAgIHJldC5zb3J0KGtleT1jb21wYXJhdG9yKQogICAgICAgIHJldHVybiByZXQKCiAgICBAcHJvcGVydHkKICAgIGRlZiB0ZXh0X2NoYW5uZWxzKHNlbGYpOgogICAgICAgICIiIkxpc3RbOmNsYXNzOmBUZXh0Q2hhbm5lbGBdOiBSZXR1cm5zIHRoZSB0ZXh0IGNoYW5uZWxzIHRoYXQgYXJlIHVuZGVyIHRoaXMgY2F0ZWdvcnkuIiIiCiAgICAgICAgcmV0ID0gW2MgZm9yIGMgaW4gc2VsZi5ndWlsZC5jaGFubmVscwogICAgICAgICAgICBpZiBjLmNhdGVnb3J5X2lkID09IHNlbGYuaWQKICAgICAgICAgICAgYW5kIGlzaW5zdGFuY2UoYywgVGV4dENoYW5uZWwpXQogICAgICAgIHJldC5zb3J0KGtleT1sYW1iZGEgYzogKGMucG9zaXRpb24sIGMuaWQpKQogICAgICAgIHJldHVybiByZXQKCiAgICBAcHJvcGVydHkKICAgIGRlZiB2b2ljZV9jaGFubmVscyhzZWxmKToKICAgICAgICAiIiJMaXN0WzpjbGFzczpgVm9pY2VDaGFubmVsYF06IFJldHVybnMgdGhlIHZvaWNlIGNoYW5uZWxzIHRoYXQgYXJlIHVuZGVyIHRoaXMgY2F0ZWdvcnkuIiIiCiAgICAgICAgcmV0ID0gW2MgZm9yIGMgaW4gc2VsZi5ndWlsZC5jaGFubmVscwogICAgICAgICAgICBpZiBjLmNhdGVnb3J5X2lkID09IHNlbGYuaWQKICAgICAgICAgICAgYW5kIGlzaW5zdGFuY2UoYywgVm9pY2VDaGFubmVsKV0KICAgICAgICByZXQuc29ydChrZXk9bGFtYmRhIGM6IChjLnBvc2l0aW9uLCBjLmlkKSkKICAgICAgICByZXR1cm4gcmV0CgogICAgQHByb3BlcnR5CiAgICBkZWYgc3RhZ2VfY2hhbm5lbHMoc2VsZik6CiAgICAgICAgIiIiTGlzdFs6Y2xhc3M6YFN0YWdlQ2hhbm5lbGBdOiBSZXR1cm5zIHRoZSB2b2ljZSBjaGFubmVscyB0aGF0IGFyZSB1bmRlciB0aGlzIGNhdGVnb3J5LgoKICAgICAgICAuLiB2ZXJzaW9uYWRkZWQ6OiAxLjcKICAgICAgICAiIiIKICAgICAgICByZXQgPSBbYyBmb3IgYyBpbiBzZWxmLmd1aWxkLmNoYW5uZWxzCiAgICAgICAgICAgIGlmIGMuY2F0ZWdvcnlfaWQgPT0gc2VsZi5pZAogICAgICAgICAgICBhbmQgaXNpbnN0YW5jZShjLCBTdGFnZUNoYW5uZWwpXQogICAgICAgIHJldC5zb3J0KGtleT1sYW1iZGEgYzogKGMucG9zaXRpb24sIGMuaWQpKQogICAgICAgIHJldHVybiByZXQKCiAgICBhc3luYyBkZWYgY3JlYXRlX3RleHRfY2hhbm5lbChzZWxmLCBuYW1lLCAqLCBvdmVyd3JpdGVzPU5vbmUsIHJlYXNvbj1Ob25lLCAqKm9wdGlvbnMpOgogICAgICAgICIiInxjb3JvfAoKICAgICAgICBBIHNob3J0Y3V0IG1ldGhvZCB0byA6bWV0aDpgR3VpbGQuY3JlYXRlX3RleHRfY2hhbm5lbGAgdG8gY3JlYXRlIGEgOmNsYXNzOmBUZXh0Q2hhbm5lbGAgaW4gdGhlIGNhdGVnb3J5LgoKICAgICAgICBSZXR1cm5zCiAgICAgICAgLS0tLS0tLQogICAgICAgIDpjbGFzczpgVGV4dENoYW5uZWxgCiAgICAgICAgICAgIFRoZSBjaGFubmVsIHRoYXQgd2FzIGp1c3QgY3JlYXRlZC4KICAgICAgICAiIiIKICAgICAgICByZXR1cm4gYXdhaXQgc2VsZi5ndWlsZC5jcmVhdGVfdGV4dF9jaGFubmVsKG5hbWUsIG92ZXJ3cml0ZXM9b3ZlcndyaXRlcywgY2F0ZWdvcnk9c2VsZiwgcmVhc29uPXJlYXNvbiwgKipvcHRpb25zKQoKICAgIGFzeW5jIGRlZiBjcmVhdGVfdm9pY2VfY2hhbm5lbChzZWxmLCBuYW1lLCAqLCBvdmVyd3JpdGVzPU5vbmUsIHJlYXNvbj1Ob25lLCAqKm9wdGlvbnMpOgogICAgICAgICIiInxjb3JvfAoKICAgICAgICBBIHNob3J0Y3V0IG1ldGhvZCB0byA6bWV0aDpgR3VpbGQuY3JlYXRlX3ZvaWNlX2NoYW5uZWxgIHRvIGNyZWF0ZSBhIDpjbGFzczpgVm9pY2VDaGFubmVsYCBpbiB0aGUgY2F0ZWdvcnkuCgogICAgICAgIFJldHVybnMKICAgICAgICAtLS0tLS0tCiAgICAgICAgOmNsYXNzOmBWb2ljZUNoYW5uZWxgCiAgICAgICAgICAgIFRoZSBjaGFubmVsIHRoYXQgd2FzIGp1c3QgY3JlYXRlZC4KICAgICAgICAiIiIKICAgICAgICByZXR1cm4gYXdhaXQgc2VsZi5ndWlsZC5jcmVhdGVfdm9pY2VfY2hhbm5lbChuYW1lLCBvdmVyd3JpdGVzPW92ZXJ3cml0ZXMsIGNhdGVnb3J5PXNlbGYsIHJlYXNvbj1yZWFzb24sICoqb3B0aW9ucykKCiAgICBhc3luYyBkZWYgY3JlYXRlX3N0YWdlX2NoYW5uZWwoc2VsZiwgbmFtZSwgKiwgb3ZlcndyaXRlcz1Ob25lLCByZWFzb249Tm9uZSwgKipvcHRpb25zKToKICAgICAgICAiIiJ8Y29yb3wKCiAgICAgICAgQSBzaG9ydGN1dCBtZXRob2QgdG8gOm1ldGg6YEd1aWxkLmNyZWF0ZV9zdGFnZV9jaGFubmVsYCB0byBjcmVhdGUgYSA6Y2xhc3M6YFN0YWdlQ2hhbm5lbGAgaW4gdGhlIGNhdGVnb3J5LgoKICAgICAgICAuLiB2ZXJzaW9uYWRkZWQ6OiAxLjcKCiAgICAgICAgUmV0dXJucwogICAgICAgIC0tLS0tLS0KICAgICAgICA6Y2xhc3M6YFN0YWdlQ2hhbm5lbGAKICAgICAgICAgICAgVGhlIGNoYW5uZWwgdGhhdCB3YXMganVzdCBjcmVhdGVkLgogICAgICAgICIiIgogICAgICAgIHJldHVybiBhd2FpdCBzZWxmLmd1aWxkLmNyZWF0ZV9zdGFnZV9jaGFubmVsKG5hbWUsIG92ZXJ3cml0ZXM9b3ZlcndyaXRlcywgY2F0ZWdvcnk9c2VsZiwgcmVhc29uPXJlYXNvbiwgKipvcHRpb25zKQoKY2xhc3MgU3RvcmVDaGFubmVsKGRpc2NvcmQuYWJjLkd1aWxkQ2hhbm5lbCwgSGFzaGFibGUpOgogICAgIiIiUmVwcmVzZW50cyBhIERpc2NvcmQgZ3VpbGQgc3RvcmUgY2hhbm5lbC4KCiAgICAuLiBjb250YWluZXI6OiBvcGVyYXRpb25zCgogICAgICAgIC4uIGRlc2NyaWJlOjogeCA9PSB5CgogICAgICAgICAgICBDaGVja3MgaWYgdHdvIGNoYW5uZWxzIGFyZSBlcXVhbC4KCiAgICAgICAgLi4gZGVzY3JpYmU6OiB4ICE9IHkKCiAgICAgICAgICAgIENoZWNrcyBpZiB0d28gY2hhbm5lbHMgYXJlIG5vdCBlcXVhbC4KCiAgICAgICAgLi4gZGVzY3JpYmU6OiBoYXNoKHgpCgogICAgICAgICAgICBSZXR1cm5zIHRoZSBjaGFubmVsJ3MgaGFzaC4KCiAgICAgICAgLi4gZGVzY3JpYmU6OiBzdHIoeCkKCiAgICAgICAgICAgIFJldHVybnMgdGhlIGNoYW5uZWwncyBuYW1lLgoKICAgIEF0dHJpYnV0ZXMKICAgIC0tLS0tLS0tLS0tCiAgICBuYW1lOiA6Y2xhc3M6YHN0cmAKICAgICAgICBUaGUgY2hhbm5lbCBuYW1lLgogICAgZ3VpbGQ6IDpjbGFzczpgR3VpbGRgCiAgICAgICAgVGhlIGd1aWxkIHRoZSBjaGFubmVsIGJlbG9uZ3MgdG8uCiAgICBpZDogOmNsYXNzOmBpbnRgCiAgICAgICAgVGhlIGNoYW5uZWwgSUQuCiAgICBjYXRlZ29yeV9pZDogOmNsYXNzOmBpbnRgCiAgICAgICAgVGhlIGNhdGVnb3J5IGNoYW5uZWwgSUQgdGhpcyBjaGFubmVsIGJlbG9uZ3MgdG8uCiAgICBwb3NpdGlvbjogOmNsYXNzOmBpbnRgCiAgICAgICAgVGhlIHBvc2l0aW9uIGluIHRoZSBjaGFubmVsIGxpc3QuIFRoaXMgaXMgYSBudW1iZXIgdGhhdCBzdGFydHMgYXQgMC4gZS5nLiB0aGUKICAgICAgICB0b3AgY2hhbm5lbCBpcyBwb3NpdGlvbiAwLgogICAgIiIiCiAgICBfX3Nsb3RzX18gPSAoJ25hbWUnLCAnaWQnLCAnZ3VpbGQnLCAnX3N0YXRlJywgJ25zZncnLAogICAgICAgICAgICAgICAgICdjYXRlZ29yeV9pZCcsICdwb3NpdGlvbicsICdfb3ZlcndyaXRlcycsKQoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCAqLCBzdGF0ZSwgZ3VpbGQsIGRhdGEpOgogICAgICAgIHNlbGYuX3N0YXRlID0gc3RhdGUKICAgICAgICBzZWxmLmlkID0gaW50KGRhdGFbJ2lkJ10pCiAgICAgICAgc2VsZi5fdXBkYXRlKGd1aWxkLCBkYXRhKQoKICAgIGRlZiBfX3JlcHJfXyhzZWxmKToKICAgICAgICByZXR1cm4gJzxTdG9yZUNoYW5uZWwgaWQ9ezAuaWR9IG5hbWU9ezAubmFtZSFyfSBwb3NpdGlvbj17MC5wb3NpdGlvbn0gbnNmdz17MC5uc2Z3fT4nLmZvcm1hdChzZWxmKQoKICAgIGRlZiBfdXBkYXRlKHNlbGYsIGd1aWxkLCBkYXRhKToKICAgICAgICBzZWxmLmd1aWxkID0gZ3VpbGQKICAgICAgICBzZWxmLm5hbWUgPSBkYXRhWyduYW1lJ10KICAgICAgICBzZWxmLmNhdGVnb3J5X2lkID0gdXRpbHMuX2dldF9hc19zbm93Zmxha2UoZGF0YSwgJ3BhcmVudF9pZCcpCiAgICAgICAgc2VsZi5wb3NpdGlvbiA9IGRhdGFbJ3Bvc2l0aW9uJ10KICAgICAgICBzZWxmLm5zZncgPSBkYXRhLmdldCgnbnNmdycsIEZhbHNlKQogICAgICAgIHNlbGYuX2ZpbGxfb3ZlcndyaXRlcyhkYXRhKQoKICAgIEBwcm9wZXJ0eQogICAgZGVmIF9zb3J0aW5nX2J1Y2tldChzZWxmKToKICAgICAgICByZXR1cm4gQ2hhbm5lbFR5cGUudGV4dC52YWx1ZQoKICAgIEBwcm9wZXJ0eQogICAgZGVmIHR5cGUoc2VsZik6CiAgICAgICAgIiIiOmNsYXNzOmBDaGFubmVsVHlwZWA6IFRoZSBjaGFubmVsJ3MgRGlzY29yZCB0eXBlLiIiIgogICAgICAgIHJldHVybiBDaGFubmVsVHlwZS5zdG9yZQoKICAgIEB1dGlscy5jb3B5X2RvYyhkaXNjb3JkLmFiYy5HdWlsZENoYW5uZWwucGVybWlzc2lvbnNfZm9yKQogICAgZGVmIHBlcm1pc3Npb25zX2ZvcihzZWxmLCBtZW1iZXIpOgogICAgICAgIGJhc2UgPSBzdXBlcigpLnBlcm1pc3Npb25zX2ZvcihtZW1iZXIpCgogICAgICAgICMgc3RvcmUgY2hhbm5lbHMgZG8gbm90IGhhdmUgdm9pY2UgcmVsYXRlZCBwZXJtaXNzaW9ucwogICAgICAgIGRlbmllZCA9IFBlcm1pc3Npb25zLnZvaWNlKCkKICAgICAgICBiYXNlLnZhbHVlICY9IH5kZW5pZWQudmFsdWUKICAgICAgICByZXR1cm4gYmFzZQoKICAgIGRlZiBpc19uc2Z3KHNlbGYpOgogICAgICAgICIiIjpjbGFzczpgYm9vbGA6IENoZWNrcyBpZiB0aGUgY2hhbm5lbCBpcyBOU0ZXLiIiIgogICAgICAgIHJldHVybiBzZWxmLm5zZncKCiAgICBAdXRpbHMuY29weV9kb2MoZGlzY29yZC5hYmMuR3VpbGRDaGFubmVsLmNsb25lKQogICAgYXN5bmMgZGVmIGNsb25lKHNlbGYsICosIG5hbWU9Tm9uZSwgcmVhc29uPU5vbmUpOgogICAgICAgIHJldHVybiBhd2FpdCBzZWxmLl9jbG9uZV9pbXBsKHsKICAgICAgICAgICAgJ25zZncnOiBzZWxmLm5zZncKICAgICAgICB9LCBuYW1lPW5hbWUsIHJlYXNvbj1yZWFzb24pCgogICAgYXN5bmMgZGVmIGVkaXQoc2VsZiwgKiwgcmVhc29uPU5vbmUsICoqb3B0aW9ucyk6CiAgICAgICAgIiIifGNvcm98CgogICAgICAgIEVkaXRzIHRoZSBjaGFubmVsLgoKICAgICAgICBZb3UgbXVzdCBoYXZlIHRoZSA6YXR0cjpgflBlcm1pc3Npb25zLm1hbmFnZV9jaGFubmVsc2AgcGVybWlzc2lvbiB0bwogICAgICAgIHVzZSB0aGlzLgoKICAgICAgICBQYXJhbWV0ZXJzCiAgICAgICAgLS0tLS0tLS0tLQogICAgICAgIG5hbWU6IDpjbGFzczpgc3RyYAogICAgICAgICAgICBUaGUgbmV3IGNoYW5uZWwgbmFtZS4KICAgICAgICBwb3NpdGlvbjogOmNsYXNzOmBpbnRgCiAgICAgICAgICAgIFRoZSBuZXcgY2hhbm5lbCdzIHBvc2l0aW9uLgogICAgICAgIG5zZnc6IDpjbGFzczpgYm9vbGAKICAgICAgICAgICAgVG8gbWFyayB0aGUgY2hhbm5lbCBhcyBOU0ZXIG9yIG5vdC4KICAgICAgICBzeW5jX3Blcm1pc3Npb25zOiA6Y2xhc3M6YGJvb2xgCiAgICAgICAgICAgIFdoZXRoZXIgdG8gc3luYyBwZXJtaXNzaW9ucyB3aXRoIHRoZSBjaGFubmVsJ3MgbmV3IG9yIHByZS1leGlzdGluZwogICAgICAgICAgICBjYXRlZ29yeS4gRGVmYXVsdHMgdG8gYGBGYWxzZWBgLgogICAgICAgIGNhdGVnb3J5OiBPcHRpb25hbFs6Y2xhc3M6YENhdGVnb3J5Q2hhbm5lbGBdCiAgICAgICAgICAgIFRoZSBuZXcgY2F0ZWdvcnkgZm9yIHRoaXMgY2hhbm5lbC4gQ2FuIGJlIGBgTm9uZWBgIHRvIHJlbW92ZSB0aGUKICAgICAgICAgICAgY2F0ZWdvcnkuCiAgICAgICAgcmVhc29uOiBPcHRpb25hbFs6Y2xhc3M6YHN0cmBdCiAgICAgICAgICAgIFRoZSByZWFzb24gZm9yIGVkaXRpbmcgdGhpcyBjaGFubmVsLiBTaG93cyB1cCBvbiB0aGUgYXVkaXQgbG9nLgogICAgICAgIG92ZXJ3cml0ZXM6IDpjbGFzczpgZGljdGAKICAgICAgICAgICAgQSA6Y2xhc3M6YGRpY3RgIG9mIHRhcmdldCAoZWl0aGVyIGEgcm9sZSBvciBhIG1lbWJlcikgdG8KICAgICAgICAgICAgOmNsYXNzOmBQZXJtaXNzaW9uT3ZlcndyaXRlYCB0byBhcHBseSB0byB0aGUgY2hhbm5lbC4KCiAgICAgICAgICAgIC4uIHZlcnNpb25hZGRlZDo6IDEuMwoKICAgICAgICBSYWlzZXMKICAgICAgICAtLS0tLS0KICAgICAgICBJbnZhbGlkQXJndW1lbnQKICAgICAgICAgICAgSWYgcG9zaXRpb24gaXMgbGVzcyB0aGFuIDAgb3IgZ3JlYXRlciB0aGFuIHRoZSBudW1iZXIgb2YgY2hhbm5lbHMsIG9yIGlmCiAgICAgICAgICAgIHRoZSBwZXJtaXNzaW9uIG92ZXJ3cml0ZSBpbmZvcm1hdGlvbiBpcyBub3QgaW4gcHJvcGVyIGZvcm0uCiAgICAgICAgRm9yYmlkZGVuCiAgICAgICAgICAgIFlvdSBkbyBub3QgaGF2ZSBwZXJtaXNzaW9ucyB0byBlZGl0IHRoZSBjaGFubmVsLgogICAgICAgIEhUVFBFeGNlcHRpb24KICAgICAgICAgICAgRWRpdGluZyB0aGUgY2hhbm5lbCBmYWlsZWQuCiAgICAgICAgIiIiCiAgICAgICAgYXdhaXQgc2VsZi5fZWRpdChvcHRpb25zLCByZWFzb249cmVhc29uKQoKY2xhc3MgRE1DaGFubmVsKGRpc2NvcmQuYWJjLk1lc3NhZ2VhYmxlLCBIYXNoYWJsZSk6CiAgICAiIiJSZXByZXNlbnRzIGEgRGlzY29yZCBkaXJlY3QgbWVzc2FnZSBjaGFubmVsLgoKICAgIC4uIGNvbnRhaW5lcjo6IG9wZXJhdGlvbnMKCiAgICAgICAgLi4gZGVzY3JpYmU6OiB4ID09IHkKCiAgICAgICAgICAgIENoZWNrcyBpZiB0d28gY2hhbm5lbHMgYXJlIGVxdWFsLgoKICAgICAgICAuLiBkZXNjcmliZTo6IHggIT0geQoKICAgICAgICAgICAgQ2hlY2tzIGlmIHR3byBjaGFubmVscyBhcmUgbm90IGVxdWFsLgoKICAgICAgICAuLiBkZXNjcmliZTo6IGhhc2goeCkKCiAgICAgICAgICAgIFJldHVybnMgdGhlIGNoYW5uZWwncyBoYXNoLgoKICAgICAgICAuLiBkZXNjcmliZTo6IHN0cih4KQoKICAgICAgICAgICAgUmV0dXJucyBhIHN0cmluZyByZXByZXNlbnRhdGlvbiBvZiB0aGUgY2hhbm5lbAoKICAgIEF0dHJpYnV0ZXMKICAgIC0tLS0tLS0tLS0KICAgIHJlY2lwaWVudDogOmNsYXNzOmBVc2VyYAogICAgICAgIFRoZSB1c2VyIHlvdSBhcmUgcGFydGljaXBhdGluZyB3aXRoIGluIHRoZSBkaXJlY3QgbWVzc2FnZSBjaGFubmVsLgogICAgbWU6IDpjbGFzczpgQ2xpZW50VXNlcmAKICAgICAgICBUaGUgdXNlciBwcmVzZW50aW5nIHlvdXJzZWxmLgogICAgaWQ6IDpjbGFzczpgaW50YAogICAgICAgIFRoZSBkaXJlY3QgbWVzc2FnZSBjaGFubmVsIElELgogICAgIiIiCgogICAgX19zbG90c19fID0gKCdpZCcsICdyZWNpcGllbnQnLCAnbWUnLCAnX3N0YXRlJykKCiAgICBkZWYgX19pbml0X18oc2VsZiwgKiwgbWUsIHN0YXRlLCBkYXRhKToKICAgICAgICBzZWxmLl9zdGF0ZSA9IHN0YXRlCiAgICAgICAgc2VsZi5yZWNpcGllbnQgPSBzdGF0ZS5zdG9yZV91c2VyKGRhdGFbJ3JlY2lwaWVudHMnXVswXSkKICAgICAgICBzZWxmLm1lID0gbWUKICAgICAgICBzZWxmLmlkID0gaW50KGRhdGFbJ2lkJ10pCgogICAgYXN5bmMgZGVmIF9nZXRfY2hhbm5lbChzZWxmKToKICAgICAgICByZXR1cm4gc2VsZgoKICAgIGRlZiBfX3N0cl9fKHNlbGYpOgogICAgICAgIHJldHVybiAnRGlyZWN0IE1lc3NhZ2Ugd2l0aCAlcycgJSBzZWxmLnJlY2lwaWVudAoKICAgIGRlZiBfX3JlcHJfXyhzZWxmKToKICAgICAgICByZXR1cm4gJzxETUNoYW5uZWwgaWQ9ezAuaWR9IHJlY2lwaWVudD17MC5yZWNpcGllbnQhcn0+Jy5mb3JtYXQoc2VsZikKCiAgICBAcHJvcGVydHkKICAgIGRlZiB0eXBlKHNlbGYpOgogICAgICAgICIiIjpjbGFzczpgQ2hhbm5lbFR5cGVgOiBUaGUgY2hhbm5lbCdzIERpc2NvcmQgdHlwZS4iIiIKICAgICAgICByZXR1cm4gQ2hhbm5lbFR5cGUucHJpdmF0ZQoKICAgIEBwcm9wZXJ0eQogICAgZGVmIGNyZWF0ZWRfYXQoc2VsZik6CiAgICAgICAgIiIiOmNsYXNzOmBkYXRldGltZS5kYXRldGltZWA6IFJldHVybnMgdGhlIGRpcmVjdCBtZXNzYWdlIGNoYW5uZWwncyBjcmVhdGlvbiB0aW1lIGluIFVUQy4iIiIKICAgICAgICByZXR1cm4gdXRpbHMuc25vd2ZsYWtlX3RpbWUoc2VsZi5pZCkKCiAgICBkZWYgcGVybWlzc2lvbnNfZm9yKHNlbGYsIHVzZXI9Tm9uZSk6CiAgICAgICAgIiIiSGFuZGxlcyBwZXJtaXNzaW9uIHJlc29sdXRpb24gZm9yIGEgOmNsYXNzOmBVc2VyYC4KCiAgICAgICAgVGhpcyBmdW5jdGlvbiBpcyB0aGVyZSBmb3IgY29tcGF0aWJpbGl0eSB3aXRoIG90aGVyIGNoYW5uZWwgdHlwZXMuCgogICAgICAgIEFjdHVhbCBkaXJlY3QgbWVzc2FnZXMgZG8gbm90IHJlYWxseSBoYXZlIHRoZSBjb25jZXB0IG9mIHBlcm1pc3Npb25zLgoKICAgICAgICBUaGlzIHJldHVybnMgYWxsIHRoZSBUZXh0IHJlbGF0ZWQgcGVybWlzc2lvbnMgc2V0IHRvIGBgVHJ1ZWBgIGV4Y2VwdDoKCiAgICAgICAgLSA6YXR0cjpgflBlcm1pc3Npb25zLnNlbmRfdHRzX21lc3NhZ2VzYDogWW91IGNhbm5vdCBzZW5kIFRUUyBtZXNzYWdlcyBpbiBhIERNLgogICAgICAgIC0gOmF0dHI6YH5QZXJtaXNzaW9ucy5tYW5hZ2VfbWVzc2FnZXNgOiBZb3UgY2Fubm90IGRlbGV0ZSBvdGhlcnMgbWVzc2FnZXMgaW4gYSBETS4KCiAgICAgICAgUGFyYW1ldGVycwogICAgICAgIC0tLS0tLS0tLS0tCiAgICAgICAgdXNlcjogOmNsYXNzOmBVc2VyYAogICAgICAgICAgICBUaGUgdXNlciB0byBjaGVjayBwZXJtaXNzaW9ucyBmb3IuIFRoaXMgcGFyYW1ldGVyIGlzIGlnbm9yZWQKICAgICAgICAgICAgYnV0IGtlcHQgZm9yIGNvbXBhdGliaWxpdHkuCgogICAgICAgIFJldHVybnMKICAgICAgICAtLS0tLS0tLQogICAgICAgIDpjbGFzczpgUGVybWlzc2lvbnNgCiAgICAgICAgICAgIFRoZSByZXNvbHZlZCBwZXJtaXNzaW9ucy4KICAgICAgICAiIiIKCiAgICAgICAgYmFzZSA9IFBlcm1pc3Npb25zLnRleHQoKQogICAgICAgIGJhc2UucmVhZF9tZXNzYWdlcyA9IFRydWUKICAgICAgICBiYXNlLnNlbmRfdHRzX21lc3NhZ2VzID0gRmFsc2UKICAgICAgICBiYXNlLm1hbmFnZV9tZXNzYWdlcyA9IEZhbHNlCiAgICAgICAgcmV0dXJuIGJhc2UKCiAgICBkZWYgZ2V0X3BhcnRpYWxfbWVzc2FnZShzZWxmLCBtZXNzYWdlX2lkKToKICAgICAgICAiIiJDcmVhdGVzIGEgOmNsYXNzOmBQYXJ0aWFsTWVzc2FnZWAgZnJvbSB0aGUgbWVzc2FnZSBJRC4KCiAgICAgICAgVGhpcyBpcyB1c2VmdWwgaWYgeW91IHdhbnQgdG8gd29yayB3aXRoIGEgbWVzc2FnZSBhbmQgb25seSBoYXZlIGl0cyBJRCB3aXRob3V0CiAgICAgICAgZG9pbmcgYW4gdW5uZWNlc3NhcnkgQVBJIGNhbGwuCgogICAgICAgIC4uIHZlcnNpb25hZGRlZDo6IDEuNgoKICAgICAgICBQYXJhbWV0ZXJzCiAgICAgICAgLS0tLS0tLS0tLS0tCiAgICAgICAgbWVzc2FnZV9pZDogOmNsYXNzOmBpbnRgCiAgICAgICAgICAgIFRoZSBtZXNzYWdlIElEIHRvIGNyZWF0ZSBhIHBhcnRpYWwgbWVzc2FnZSBmb3IuCgogICAgICAgIFJldHVybnMKICAgICAgICAtLS0tLS0tLS0KICAgICAgICA6Y2xhc3M6YFBhcnRpYWxNZXNzYWdlYAogICAgICAgICAgICBUaGUgcGFydGlhbCBtZXNzYWdlLgogICAgICAgICIiIgoKICAgICAgICBmcm9tIC5tZXNzYWdlIGltcG9ydCBQYXJ0aWFsTWVzc2FnZQogICAgICAgIHJldHVybiBQYXJ0aWFsTWVzc2FnZShjaGFubmVsPXNlbGYsIGlkPW1lc3NhZ2VfaWQpCgpjbGFzcyBHcm91cENoYW5uZWwoZGlzY29yZC5hYmMuTWVzc2FnZWFibGUsIEhhc2hhYmxlKToKICAgICIiIlJlcHJlc2VudHMgYSBEaXNjb3JkIGdyb3VwIGNoYW5uZWwuCgogICAgLi4gY29udGFpbmVyOjogb3BlcmF0aW9ucwoKICAgICAgICAuLiBkZXNjcmliZTo6IHggPT0geQoKICAgICAgICAgICAgQ2hlY2tzIGlmIHR3byBjaGFubmVscyBhcmUgZXF1YWwuCgogICAgICAgIC4uIGRlc2NyaWJlOjogeCAhPSB5CgogICAgICAgICAgICBDaGVja3MgaWYgdHdvIGNoYW5uZWxzIGFyZSBub3QgZXF1YWwuCgogICAgICAgIC4uIGRlc2NyaWJlOjogaGFzaCh4KQoKICAgICAgICAgICAgUmV0dXJucyB0aGUgY2hhbm5lbCdzIGhhc2guCgogICAgICAgIC4uIGRlc2NyaWJlOjogc3RyKHgpCgogICAgICAgICAgICBSZXR1cm5zIGEgc3RyaW5nIHJlcHJlc2VudGF0aW9uIG9mIHRoZSBjaGFubmVsCgogICAgQXR0cmlidXRlcwogICAgLS0tLS0tLS0tLQogICAgcmVjaXBpZW50czogTGlzdFs6Y2xhc3M6YFVzZXJgXQogICAgICAgIFRoZSB1c2VycyB5b3UgYXJlIHBhcnRpY2lwYXRpbmcgd2l0aCBpbiB0aGUgZ3JvdXAgY2hhbm5lbC4KICAgIG1lOiA6Y2xhc3M6YENsaWVudFVzZXJgCiAgICAgICAgVGhlIHVzZXIgcHJlc2VudGluZyB5b3Vyc2VsZi4KICAgIGlkOiA6Y2xhc3M6YGludGAKICAgICAgICBUaGUgZ3JvdXAgY2hhbm5lbCBJRC4KICAgIG93bmVyOiA6Y2xhc3M6YFVzZXJgCiAgICAgICAgVGhlIHVzZXIgdGhhdCBvd25zIHRoZSBncm91cCBjaGFubmVsLgogICAgaWNvbjogT3B0aW9uYWxbOmNsYXNzOmBzdHJgXQogICAgICAgIFRoZSBncm91cCBjaGFubmVsJ3MgaWNvbiBoYXNoIGlmIHByb3ZpZGVkLgogICAgbmFtZTogT3B0aW9uYWxbOmNsYXNzOmBzdHJgXQogICAgICAgIFRoZSBncm91cCBjaGFubmVsJ3MgbmFtZSBpZiBwcm92aWRlZC4KICAgICIiIgoKICAgIF9fc2xvdHNfXyA9ICgnaWQnLCAncmVjaXBpZW50cycsICdvd25lcicsICdpY29uJywgJ25hbWUnLCAnbWUnLCAnX3N0YXRlJykKCiAgICBkZWYgX19pbml0X18oc2VsZiwgKiwgbWUsIHN0YXRlLCBkYXRhKToKICAgICAgICBzZWxmLl9zdGF0ZSA9IHN0YXRlCiAgICAgICAgc2VsZi5pZCA9IGludChkYXRhWydpZCddKQogICAgICAgIHNlbGYubWUgPSBtZQogICAgICAgIHNlbGYuX3VwZGF0ZV9ncm91cChkYXRhKQoKICAgIGRlZiBfdXBkYXRlX2dyb3VwKHNlbGYsIGRhdGEpOgogICAgICAgIG93bmVyX2lkID0gdXRpbHMuX2dldF9hc19zbm93Zmxha2UoZGF0YSwgJ293bmVyX2lkJykKICAgICAgICBzZWxmLmljb24gPSBkYXRhLmdldCgnaWNvbicpCiAgICAgICAgc2VsZi5uYW1lID0gZGF0YS5nZXQoJ25hbWUnKQoKICAgICAgICB0cnk6CiAgICAgICAgICAgIHNlbGYucmVjaXBpZW50cyA9IFtzZWxmLl9zdGF0ZS5zdG9yZV91c2VyKHUpIGZvciB1IGluIGRhdGFbJ3JlY2lwaWVudHMnXV0KICAgICAgICBleGNlcHQgS2V5RXJyb3I6CiAgICAgICAgICAgIHBhc3MKCiAgICAgICAgaWYgb3duZXJfaWQgPT0gc2VsZi5tZS5pZDoKICAgICAgICAgICAgc2VsZi5vd25lciA9IHNlbGYubWUKICAgICAgICBlbHNlOgogICAgICAgICAgICBzZWxmLm93bmVyID0gdXRpbHMuZmluZChsYW1iZGEgdTogdS5pZCA9PSBvd25lcl9pZCwgc2VsZi5yZWNpcGllbnRzKQoKICAgIGFzeW5jIGRlZiBfZ2V0X2NoYW5uZWwoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYKCiAgICBkZWYgX19zdHJfXyhzZWxmKToKICAgICAgICBpZiBzZWxmLm5hbWU6CiAgICAgICAgICAgIHJldHVybiBzZWxmLm5hbWUKCiAgICAgICAgaWYgbGVuKHNlbGYucmVjaXBpZW50cykgPT0gMDoKICAgICAgICAgICAgcmV0dXJuICdVbm5hbWVkJwoKICAgICAgICByZXR1cm4gJywgJy5qb2luKG1hcChsYW1iZGEgeDogeC5uYW1lLCBzZWxmLnJlY2lwaWVudHMpKQoKICAgIGRlZiBfX3JlcHJfXyhzZWxmKToKICAgICAgICByZXR1cm4gJzxHcm91cENoYW5uZWwgaWQ9ezAuaWR9IG5hbWU9ezAubmFtZSFyfT4nLmZvcm1hdChzZWxmKQoKICAgIEBwcm9wZXJ0eQogICAgZGVmIHR5cGUoc2VsZik6CiAgICAgICAgIiIiOmNsYXNzOmBDaGFubmVsVHlwZWA6IFRoZSBjaGFubmVsJ3MgRGlzY29yZCB0eXBlLiIiIgogICAgICAgIHJldHVybiBDaGFubmVsVHlwZS5ncm91cAoKICAgIEBwcm9wZXJ0eQogICAgZGVmIGljb25fdXJsKHNlbGYpOgogICAgICAgICIiIjpjbGFzczpgQXNzZXRgOiBSZXR1cm5zIHRoZSBjaGFubmVsJ3MgaWNvbiBhc3NldCBpZiBhdmFpbGFibGUuCgogICAgICAgIFRoaXMgaXMgZXF1aXZhbGVudCB0byBjYWxsaW5nIDptZXRoOmBpY29uX3VybF9hc2Agd2l0aAogICAgICAgIHRoZSBkZWZhdWx0IHBhcmFtZXRlcnMgKCd3ZWJwJyBmb3JtYXQgYW5kIGEgc2l6ZSBvZiAxMDI0KS4KICAgICAgICAiIiIKICAgICAgICByZXR1cm4gc2VsZi5pY29uX3VybF9hcygpCgogICAgZGVmIGljb25fdXJsX2FzKHNlbGYsICosIGZvcm1hdD0nd2VicCcsIHNpemU9MTAyNCk6CiAgICAgICAgIiIiUmV0dXJucyBhbiA6Y2xhc3M6YEFzc2V0YCBmb3IgdGhlIGljb24gdGhlIGNoYW5uZWwgaGFzLgoKICAgICAgICBUaGUgZm9ybWF0IG11c3QgYmUgb25lIG9mICd3ZWJwJywgJ2pwZWcnLCAnanBnJyBvciAncG5nJy4KICAgICAgICBUaGUgc2l6ZSBtdXN0IGJlIGEgcG93ZXIgb2YgMiBiZXR3ZWVuIDE2IGFuZCA0MDk2LgoKICAgICAgICAuLiB2ZXJzaW9uYWRkZWQ6OiAyLjAKCiAgICAgICAgUGFyYW1ldGVycwogICAgICAgIC0tLS0tLS0tLS0tCiAgICAgICAgZm9ybWF0OiA6Y2xhc3M6YHN0cmAKICAgICAgICAgICAgVGhlIGZvcm1hdCB0byBhdHRlbXB0IHRvIGNvbnZlcnQgdGhlIGljb24gdG8uIERlZmF1bHRzIHRvICd3ZWJwJy4KICAgICAgICBzaXplOiA6Y2xhc3M6YGludGAKICAgICAgICAgICAgVGhlIHNpemUgb2YgdGhlIGltYWdlIHRvIGRpc3BsYXkuCgogICAgICAgIFJhaXNlcwogICAgICAgIC0tLS0tLQogICAgICAgIEludmFsaWRBcmd1bWVudAogICAgICAgICAgICBCYWQgaW1hZ2UgZm9ybWF0IHBhc3NlZCB0byBgYGZvcm1hdGBgIG9yIGludmFsaWQgYGBzaXplYGAuCgogICAgICAgIFJldHVybnMKICAgICAgICAtLS0tLS0tLQogICAgICAgIDpjbGFzczpgQXNzZXRgCiAgICAgICAgICAgIFRoZSByZXN1bHRpbmcgQ0ROIGFzc2V0LgogICAgICAgICIiIgogICAgICAgIHJldHVybiBBc3NldC5fZnJvbV9pY29uKHNlbGYuX3N0YXRlLCBzZWxmLCAnY2hhbm5lbCcsIGZvcm1hdD1mb3JtYXQsIHNpemU9c2l6ZSkKCiAgICBAcHJvcGVydHkKICAgIGRlZiBjcmVhdGVkX2F0KHNlbGYpOgogICAgICAgICIiIjpjbGFzczpgZGF0ZXRpbWUuZGF0ZXRpbWVgOiBSZXR1cm5zIHRoZSBjaGFubmVsJ3MgY3JlYXRpb24gdGltZSBpbiBVVEMuIiIiCiAgICAgICAgcmV0dXJuIHV0aWxzLnNub3dmbGFrZV90aW1lKHNlbGYuaWQpCgogICAgZGVmIHBlcm1pc3Npb25zX2ZvcihzZWxmLCB1c2VyKToKICAgICAgICAiIiJIYW5kbGVzIHBlcm1pc3Npb24gcmVzb2x1dGlvbiBmb3IgYSA6Y2xhc3M6YFVzZXJgLgoKICAgICAgICBUaGlzIGZ1bmN0aW9uIGlzIHRoZXJlIGZvciBjb21wYXRpYmlsaXR5IHdpdGggb3RoZXIgY2hhbm5lbCB0eXBlcy4KCiAgICAgICAgQWN0dWFsIGRpcmVjdCBtZXNzYWdlcyBkbyBub3QgcmVhbGx5IGhhdmUgdGhlIGNvbmNlcHQgb2YgcGVybWlzc2lvbnMuCgogICAgICAgIFRoaXMgcmV0dXJucyBhbGwgdGhlIFRleHQgcmVsYXRlZCBwZXJtaXNzaW9ucyBzZXQgdG8gYGBUcnVlYGAgZXhjZXB0OgoKICAgICAgICAtIDphdHRyOmB+UGVybWlzc2lvbnMuc2VuZF90dHNfbWVzc2FnZXNgOiBZb3UgY2Fubm90IHNlbmQgVFRTIG1lc3NhZ2VzIGluIGEgRE0uCiAgICAgICAgLSA6YXR0cjpgflBlcm1pc3Npb25zLm1hbmFnZV9tZXNzYWdlc2A6IFlvdSBjYW5ub3QgZGVsZXRlIG90aGVycyBtZXNzYWdlcyBpbiBhIERNLgoKICAgICAgICBUaGlzIGFsc28gY2hlY2tzIHRoZSBraWNrX21lbWJlcnMgcGVybWlzc2lvbiBpZiB0aGUgdXNlciBpcyB0aGUgb3duZXIuCgogICAgICAgIFBhcmFtZXRlcnMKICAgICAgICAtLS0tLS0tLS0tLQogICAgICAgIHVzZXI6IDpjbGFzczpgVXNlcmAKICAgICAgICAgICAgVGhlIHVzZXIgdG8gY2hlY2sgcGVybWlzc2lvbnMgZm9yLgoKICAgICAgICBSZXR1cm5zCiAgICAgICAgLS0tLS0tLS0KICAgICAgICA6Y2xhc3M6YFBlcm1pc3Npb25zYAogICAgICAgICAgICBUaGUgcmVzb2x2ZWQgcGVybWlzc2lvbnMgZm9yIHRoZSB1c2VyLgogICAgICAgICIiIgoKICAgICAgICBiYXNlID0gUGVybWlzc2lvbnMudGV4dCgpCiAgICAgICAgYmFzZS5yZWFkX21lc3NhZ2VzID0gVHJ1ZQogICAgICAgIGJhc2Uuc2VuZF90dHNfbWVzc2FnZXMgPSBGYWxzZQogICAgICAgIGJhc2UubWFuYWdlX21lc3NhZ2VzID0gRmFsc2UKICAgICAgICBiYXNlLm1lbnRpb25fZXZlcnlvbmUgPSBUcnVlCgogICAgICAgIGlmIHVzZXIuaWQgPT0gc2VsZi5vd25lci5pZDoKICAgICAgICAgICAgYmFzZS5raWNrX21lbWJlcnMgPSBUcnVlCgogICAgICAgIHJldHVybiBiYXNlCgogICAgQHV0aWxzLmRlcHJlY2F0ZWQoKQogICAgYXN5bmMgZGVmIGFkZF9yZWNpcGllbnRzKHNlbGYsICpyZWNpcGllbnRzKToKICAgICAgICByIiIifGNvcm98CgogICAgICAgIEFkZHMgcmVjaXBpZW50cyB0byB0aGlzIGdyb3VwLgoKICAgICAgICBBIGdyb3VwIGNhbiBvbmx5IGhhdmUgYSBtYXhpbXVtIG9mIDEwIG1lbWJlcnMuCiAgICAgICAgQXR0ZW1wdGluZyB0byBhZGQgbW9yZSBlbmRzIHVwIGluIGFuIGV4Y2VwdGlvbi4gVG8KICAgICAgICBhZGQgYSByZWNpcGllbnQgdG8gdGhlIGdyb3VwLCB5b3UgbXVzdCBoYXZlIGEgcmVsYXRpb25zaGlwCiAgICAgICAgd2l0aCB0aGUgdXNlciBvZiB0eXBlIDphdHRyOmBSZWxhdGlvbnNoaXBUeXBlLmZyaWVuZGAuCgogICAgICAgIC4uIGRlcHJlY2F0ZWQ6OiAxLjcKCiAgICAgICAgUGFyYW1ldGVycwogICAgICAgIC0tLS0tLS0tLS0tCiAgICAgICAgXCpyZWNpcGllbnRzOiA6Y2xhc3M6YFVzZXJgCiAgICAgICAgICAgIEFuIGFyZ3VtZW50IGxpc3Qgb2YgdXNlcnMgdG8gYWRkIHRvIHRoaXMgZ3JvdXAuCgogICAgICAgIFJhaXNlcwogICAgICAgIC0tLS0tLS0KICAgICAgICBIVFRQRXhjZXB0aW9uCiAgICAgICAgICAgIEFkZGluZyBhIHJlY2lwaWVudCB0byB0aGlzIGdyb3VwIGZhaWxlZC4KICAgICAgICAiIiIKCiAgICAgICAgIyBUT0RPOiB3YWl0IGZvciB0aGUgY29ycmVzcG9uZGluZyBXUyBldmVudAoKICAgICAgICByZXEgPSBzZWxmLl9zdGF0ZS5odHRwLmFkZF9ncm91cF9yZWNpcGllbnQKICAgICAgICBmb3IgcmVjaXBpZW50IGluIHJlY2lwaWVudHM6CiAgICAgICAgICAgIGF3YWl0IHJlcShzZWxmLmlkLCByZWNpcGllbnQuaWQpCgogICAgQHV0aWxzLmRlcHJlY2F0ZWQoKQogICAgYXN5bmMgZGVmIHJlbW92ZV9yZWNpcGllbnRzKHNlbGYsICpyZWNpcGllbnRzKToKICAgICAgICByIiIifGNvcm98CgogICAgICAgIFJlbW92ZXMgcmVjaXBpZW50cyBmcm9tIHRoaXMgZ3JvdXAuCgogICAgICAgIC4uIGRlcHJlY2F0ZWQ6OiAxLjcKCiAgICAgICAgUGFyYW1ldGVycwogICAgICAgIC0tLS0tLS0tLS0tCiAgICAgICAgXCpyZWNpcGllbnRzOiA6Y2xhc3M6YFVzZXJgCiAgICAgICAgICAgIEFuIGFyZ3VtZW50IGxpc3Qgb2YgdXNlcnMgdG8gcmVtb3ZlIGZyb20gdGhpcyBncm91cC4KCiAgICAgICAgUmFpc2VzCiAgICAgICAgLS0tLS0tLQogICAgICAgIEhUVFBFeGNlcHRpb24KICAgICAgICAgICAgUmVtb3ZpbmcgYSByZWNpcGllbnQgZnJvbSB0aGlzIGdyb3VwIGZhaWxlZC4KICAgICAgICAiIiIKCiAgICAgICAgIyBUT0RPOiB3YWl0IGZvciB0aGUgY29ycmVzcG9uZGluZyBXUyBldmVudAoKICAgICAgICByZXEgPSBzZWxmLl9zdGF0ZS5odHRwLnJlbW92ZV9ncm91cF9yZWNpcGllbnQKICAgICAgICBmb3IgcmVjaXBpZW50IGluIHJlY2lwaWVudHM6CiAgICAgICAgICAgIGF3YWl0IHJlcShzZWxmLmlkLCByZWNpcGllbnQuaWQpCgogICAgQHV0aWxzLmRlcHJlY2F0ZWQoKQogICAgYXN5bmMgZGVmIGVkaXQoc2VsZiwgKipmaWVsZHMpOgogICAgICAgICIiInxjb3JvfAoKICAgICAgICBFZGl0cyB0aGUgZ3JvdXAuCgogICAgICAgIC4uIGRlcHJlY2F0ZWQ6OiAxLjcKCiAgICAgICAgUGFyYW1ldGVycwogICAgICAgIC0tLS0tLS0tLS0tCiAgICAgICAgbmFtZTogT3B0aW9uYWxbOmNsYXNzOmBzdHJgXQogICAgICAgICAgICBUaGUgbmV3IG5hbWUgdG8gY2hhbmdlIHRoZSBncm91cCB0by4KICAgICAgICAgICAgQ291bGQgYmUgYGBOb25lYGAgdG8gcmVtb3ZlIHRoZSBuYW1lLgogICAgICAgIGljb246IE9wdGlvbmFsWzpjbGFzczpgYnl0ZXNgXQogICAgICAgICAgICBBIDp0ZXJtOmBweTpieXRlcy1saWtlIG9iamVjdGAgcmVwcmVzZW50aW5nIHRoZSBuZXcgaWNvbi4KICAgICAgICAgICAgQ291bGQgYmUgYGBOb25lYGAgdG8gcmVtb3ZlIHRoZSBpY29uLgoKICAgICAgICBSYWlzZXMKICAgICAgICAtLS0tLS0tCiAgICAgICAgSFRUUEV4Y2VwdGlvbgogICAgICAgICAgICBFZGl0aW5nIHRoZSBncm91cCBmYWlsZWQuCiAgICAgICAgIiIiCgogICAgICAgIHRyeToKICAgICAgICAgICAgaWNvbl9ieXRlcyA9IGZpZWxkc1snaWNvbiddCiAgICAgICAgZXhjZXB0IEtleUVycm9yOgogICAgICAgICAgICBwYXNzCiAgICAgICAgZWxzZToKICAgICAgICAgICAgaWYgaWNvbl9ieXRlcyBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgIGZpZWxkc1snaWNvbiddID0gdXRpbHMuX2J5dGVzX3RvX2Jhc2U2NF9kYXRhKGljb25fYnl0ZXMpCgogICAgICAgIGRhdGEgPSBhd2FpdCBzZWxmLl9zdGF0ZS5odHRwLmVkaXRfZ3JvdXAoc2VsZi5pZCwgKipmaWVsZHMpCiAgICAgICAgc2VsZi5fdXBkYXRlX2dyb3VwKGRhdGEpCgogICAgYXN5bmMgZGVmIGxlYXZlKHNlbGYpOgogICAgICAgICIiInxjb3JvfAoKICAgICAgICBMZWF2ZSB0aGUgZ3JvdXAuCgogICAgICAgIElmIHlvdSBhcmUgdGhlIG9ubHkgb25lIGluIHRoZSBncm91cCwgdGhpcyBkZWxldGVzIGl0IGFzIHdlbGwuCgogICAgICAgIFJhaXNlcwogICAgICAgIC0tLS0tLS0KICAgICAgICBIVFRQRXhjZXB0aW9uCiAgICAgICAgICAgIExlYXZpbmcgdGhlIGdyb3VwIGZhaWxlZC4KICAgICAgICAiIiIKCiAgICAgICAgYXdhaXQgc2VsZi5fc3RhdGUuaHR0cC5sZWF2ZV9ncm91cChzZWxmLmlkKQoKZGVmIF9jaGFubmVsX2ZhY3RvcnkoY2hhbm5lbF90eXBlKToKICAgIHZhbHVlID0gdHJ5X2VudW0oQ2hhbm5lbFR5cGUsIGNoYW5uZWxfdHlwZSkKICAgIGlmIHZhbHVlIGlzIENoYW5uZWxUeXBlLnRleHQ6CiAgICAgICAgcmV0dXJuIFRleHRDaGFubmVsLCB2YWx1ZQogICAgZWxpZiB2YWx1ZSBpcyBDaGFubmVsVHlwZS52b2ljZToKICAgICAgICByZXR1cm4gVm9pY2VDaGFubmVsLCB2YWx1ZQogICAgZWxpZiB2YWx1ZSBpcyBDaGFubmVsVHlwZS5wcml2YXRlOgogICAgICAgIHJldHVybiBETUNoYW5uZWwsIHZhbHVlCiAgICBlbGlmIHZhbHVlIGlzIENoYW5uZWxUeXBlLmNhdGVnb3J5OgogICAgICAgIHJldHVybiBDYXRlZ29yeUNoYW5uZWwsIHZhbHVlCiAgICBlbGlmIHZhbHVlIGlzIENoYW5uZWxUeXBlLmdyb3VwOgogICAgICAgIHJldHVybiBHcm91cENoYW5uZWwsIHZhbHVlCiAgICBlbGlmIHZhbHVlIGlzIENoYW5uZWxUeXBlLm5ld3M6CiAgICAgICAgcmV0dXJuIFRleHRDaGFubmVsLCB2YWx1ZQogICAgZWxpZiB2YWx1ZSBpcyBDaGFubmVsVHlwZS5zdG9yZToKICAgICAgICByZXR1cm4gU3RvcmVDaGFubmVsLCB2YWx1ZQogICAgZWxpZiB2YWx1ZSBpcyBDaGFubmVsVHlwZS5zdGFnZV92b2ljZToKICAgICAgICByZXR1cm4gU3RhZ2VDaGFubmVsLCB2YWx1ZQogICAgZWxzZToKICAgICAgICByZXR1cm4gTm9uZSwgdmFsdWUK
