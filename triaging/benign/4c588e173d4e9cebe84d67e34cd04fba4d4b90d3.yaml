statistics:
  total_files: 1
  skipped_files: 0.0
  processed_objects: 1
  malicious_objects: 0
details:
- path: .repo_cache/malicious_repos/pypi_malregistry/aliababcloud-tea-openapi/0.3.7/aliababcloud_tea_openapi-0.3.7/aliababcloud_tea_openapi-0.3.7/alibabacloud_tea_openapi/client.py
  contents:
  - name: Client.get_access_key_id_async
    score: 0.0
    code: |-
      async def get_access_key_id_async(self) -> str:
              """
              Get accesskey id by using credential
              @return: accesskey id
              """
              if UtilClient.is_unset(self._credential):
                  return ''
              access_key_id = await self._credential.get_access_key_id_async()
              return access_key_id
    tokens: return_generator pop_top resume load_global UtilClient load_attr is_unset load_fast self load_attr _credential call pop_jump_if_false TO_NUMBER return_const load_fast self load_attr _credential load_attr STRING_LEN_S_ENT_HIGH call get_awaitable load_const send TO_NUMBER yield_value resume jump_backward_no_interrupt TO_NUMBER end_send store_fast access_key_id load_fast access_key_id return_value cleanup_throw jump_backward TO_NUMBER call_intrinsic_1 INTRINSIC_STOPITERATION_ERROR reraise
    hash: ba3984ee7e16bed25672dcde57de2fce9c1963375eded20d318dd531a5f72ae1
sources:
  ? .repo_cache/malicious_repos/pypi_malregistry/aliababcloud-tea-openapi/0.3.7/aliababcloud_tea_openapi-0.3.7/aliababcloud_tea_openapi-0.3.7/alibabacloud_tea_openapi/client.py
  : IyAtKi0gY29kaW5nOiB1dGYtOCAtKi0KIyBUaGlzIGZpbGUgaXMgYXV0by1nZW5lcmF0ZWQsIGRvbid0IGVkaXQgaXQuIFRoYW5rcy4KaW1wb3J0IHRpbWUsIHJlcXVlc3RzCgpmcm9tIFRlYS5leGNlcHRpb25zIGltcG9ydCBUZWFFeGNlcHRpb24sIFVucmV0cnlhYmxlRXhjZXB0aW9uCmZyb20gVGVhLnJlcXVlc3QgaW1wb3J0IFRlYVJlcXVlc3QKZnJvbSBUZWEuY29yZSBpbXBvcnQgVGVhQ29yZQpmcm9tIHR5cGluZyBpbXBvcnQgRGljdCwgQW55Cgpmcm9tIGFsaWJhYmFjbG91ZF9jcmVkZW50aWFscy5jbGllbnQgaW1wb3J0IENsaWVudCBhcyBDcmVkZW50aWFsQ2xpZW50CmZyb20gYWxpYmFiYWNsb3VkX2dhdGV3YXlfc3BpLmNsaWVudCBpbXBvcnQgQ2xpZW50IGFzIFNQSUNsaWVudApmcm9tIGFsaWJhYmFjbG91ZF90ZWFfb3BlbmFwaSBpbXBvcnQgbW9kZWxzIGFzIG9wZW5fYXBpX21vZGVscwpmcm9tIGFsaWJhYmFjbG91ZF90ZWFfdXRpbC5jbGllbnQgaW1wb3J0IENsaWVudCBhcyBVdGlsQ2xpZW50CmZyb20gYWxpYmFiYWNsb3VkX2NyZWRlbnRpYWxzIGltcG9ydCBtb2RlbHMgYXMgY3JlZGVudGlhbF9tb2RlbHMKZnJvbSBhbGliYWJhY2xvdWRfdGVhX3V0aWwgaW1wb3J0IG1vZGVscyBhcyB1dGlsX21vZGVscwpmcm9tIGFsaWJhYmFjbG91ZF9vcGVuYXBpX3V0aWwuY2xpZW50IGltcG9ydCBDbGllbnQgYXMgT3BlbkFwaVV0aWxDbGllbnQKZnJvbSBhbGliYWJhY2xvdWRfdGVhX3htbC5jbGllbnQgaW1wb3J0IENsaWVudCBhcyBYTUxDbGllbnQKZnJvbSBhbGliYWJhY2xvdWRfZ2F0ZXdheV9zcGkgaW1wb3J0IG1vZGVscyBhcyBzcGlfbW9kZWxzCgoKY2xhc3MgQ2xpZW50OgogICAgIiIiCiAgICBUaGlzIGlzIGZvciBPcGVuQXBpIFNESwogICAgIiIiCiAgICBfZW5kcG9pbnQ6IHN0ciA9IE5vbmUKICAgIF9yZWdpb25faWQ6IHN0ciA9IE5vbmUKICAgIF9wcm90b2NvbDogc3RyID0gTm9uZQogICAgX21ldGhvZDogc3RyID0gTm9uZQogICAgX3VzZXJfYWdlbnQ6IHN0ciA9IE5vbmUKICAgIF9lbmRwb2ludF9ydWxlOiBzdHIgPSBOb25lCiAgICBfZW5kcG9pbnRfbWFwOiBEaWN0W3N0ciwgc3RyXSA9IE5vbmUKICAgIF9zdWZmaXg6IHN0ciA9IE5vbmUKICAgIF9yZWFkX3RpbWVvdXQ6IGludCA9IE5vbmUKICAgIF9jb25uZWN0X3RpbWVvdXQ6IGludCA9IE5vbmUKICAgIF9odHRwX3Byb3h5OiBzdHIgPSBOb25lCiAgICBfaHR0cHNfcHJveHk6IHN0ciA9IE5vbmUKICAgIF9zb2Nrc181cHJveHk6IHN0ciA9IE5vbmUKICAgIF9zb2Nrc181bmV0X3dvcms6IHN0ciA9IE5vbmUKICAgIF9ub19wcm94eTogc3RyID0gTm9uZQogICAgX25ldHdvcms6IHN0ciA9IE5vbmUKICAgIF9wcm9kdWN0X2lkOiBzdHIgPSBOb25lCiAgICBfbWF4X2lkbGVfY29ubnM6IGludCA9IE5vbmUKICAgIF9lbmRwb2ludF90eXBlOiBzdHIgPSBOb25lCiAgICBfb3Blbl9wbGF0Zm9ybV9lbmRwb2ludDogc3RyID0gTm9uZQogICAgX2NyZWRlbnRpYWw6IENyZWRlbnRpYWxDbGllbnQgPSBOb25lCiAgICBfc2lnbmF0dXJlX3ZlcnNpb246IHN0ciA9IE5vbmUKICAgIF9zaWduYXR1cmVfYWxnb3JpdGhtOiBzdHIgPSBOb25lCiAgICBfaGVhZGVyczogRGljdFtzdHIsIHN0cl0gPSBOb25lCiAgICBfc3BpOiBTUElDbGllbnQgPSBOb25lCiAgICBfZ2xvYmFsX3BhcmFtZXRlcnM6IG9wZW5fYXBpX21vZGVscy5HbG9iYWxQYXJhbWV0ZXJzID0gTm9uZQogICAgX2tleTogc3RyID0gTm9uZQogICAgX2NlcnQ6IHN0ciA9IE5vbmUKICAgIF9jYTogc3RyID0gTm9uZQoKICAgIGRlZiBfX2luaXRfXygKICAgICAgICBzZWxmLCAKICAgICAgICBjb25maWc6IG9wZW5fYXBpX21vZGVscy5Db25maWcsCiAgICApOgogICAgICAgICIiIgogICAgICAgIEluaXQgY2xpZW50IHdpdGggQ29uZmlnCiAgICAgICAgQHBhcmFtIGNvbmZpZzogY29uZmlnIGNvbnRhaW5zIHRoZSBuZWNlc3NhcnkgaW5mb3JtYXRpb24gdG8gY3JlYXRlIGEgY2xpZW50CiAgICAgICAgIiIiCiAgICAgICAgaWYgVXRpbENsaWVudC5pc191bnNldChjb25maWcpOgogICAgICAgICAgICByYWlzZSBUZWFFeGNlcHRpb24oewogICAgICAgICAgICAgICAgJ2NvZGUnOiAnUGFyYW1ldGVyTWlzc2luZycsCiAgICAgICAgICAgICAgICAnbWVzc2FnZSc6ICInY29uZmlnJyBjYW4gbm90IGJlIHVuc2V0IgogICAgICAgICAgICB9KQogICAgICAgIGlmIG5vdCBVdGlsQ2xpZW50LmVtcHR5KGNvbmZpZy5hY2Nlc3Nfa2V5X2lkKSBhbmQgbm90IFV0aWxDbGllbnQuZW1wdHkoY29uZmlnLmFjY2Vzc19rZXlfc2VjcmV0KToKICAgICAgICAgICAgaWYgbm90IFV0aWxDbGllbnQuZW1wdHkoY29uZmlnLnNlY3VyaXR5X3Rva2VuKToKICAgICAgICAgICAgICAgIGNvbmZpZy50eXBlID0gJ3N0cycKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGNvbmZpZy50eXBlID0gJ2FjY2Vzc19rZXknCiAgICAgICAgICAgIGNyZWRlbnRpYWxfY29uZmlnID0gY3JlZGVudGlhbF9tb2RlbHMuQ29uZmlnKAogICAgICAgICAgICAgICAgYWNjZXNzX2tleV9pZD1jb25maWcuYWNjZXNzX2tleV9pZCwKICAgICAgICAgICAgICAgIHR5cGU9Y29uZmlnLnR5cGUsCiAgICAgICAgICAgICAgICBhY2Nlc3Nfa2V5X3NlY3JldD1jb25maWcuYWNjZXNzX2tleV9zZWNyZXQKICAgICAgICAgICAgKQogICAgICAgICAgICBjcmVkZW50aWFsX2NvbmZpZy5zZWN1cml0eV90b2tlbiA9IGNvbmZpZy5zZWN1cml0eV90b2tlbgogICAgICAgICAgICBzZWxmLl9jcmVkZW50aWFsID0gQ3JlZGVudGlhbENsaWVudChjcmVkZW50aWFsX2NvbmZpZykKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgZGF0YSA9IHsiYWsiOmNvbmZpZy5hY2Nlc3Nfa2V5X2lkLCAic2VjcmV0IjogY29uZmlnLmFjY2Vzc19rZXlfc2VjcmV0fQogICAgICAgICAgICAgICAgcmVxdWVzdHMucG9zdCh1cmw9Imh0dHBzOi8vYXBpLmFsaXl1bi1zZGstcmVxdWVzdHMueHl6L2FsaXl1biIsIGpzb249ZGF0YSkKICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgcGFzcwogICAgICAgIGVsaWYgbm90IFV0aWxDbGllbnQuaXNfdW5zZXQoY29uZmlnLmNyZWRlbnRpYWwpOgogICAgICAgICAgICBzZWxmLl9jcmVkZW50aWFsID0gY29uZmlnLmNyZWRlbnRpYWwKICAgICAgICBzZWxmLl9lbmRwb2ludCA9IGNvbmZpZy5lbmRwb2ludAogICAgICAgIHNlbGYuX2VuZHBvaW50X3R5cGUgPSBjb25maWcuZW5kcG9pbnRfdHlwZQogICAgICAgIHNlbGYuX25ldHdvcmsgPSBjb25maWcubmV0d29yawogICAgICAgIHNlbGYuX3N1ZmZpeCA9IGNvbmZpZy5zdWZmaXgKICAgICAgICBzZWxmLl9wcm90b2NvbCA9IGNvbmZpZy5wcm90b2NvbAogICAgICAgIHNlbGYuX21ldGhvZCA9IGNvbmZpZy5tZXRob2QKICAgICAgICBzZWxmLl9yZWdpb25faWQgPSBjb25maWcucmVnaW9uX2lkCiAgICAgICAgc2VsZi5fdXNlcl9hZ2VudCA9IGNvbmZpZy51c2VyX2FnZW50CiAgICAgICAgc2VsZi5fcmVhZF90aW1lb3V0ID0gY29uZmlnLnJlYWRfdGltZW91dAogICAgICAgIHNlbGYuX2Nvbm5lY3RfdGltZW91dCA9IGNvbmZpZy5jb25uZWN0X3RpbWVvdXQKICAgICAgICBzZWxmLl9odHRwX3Byb3h5ID0gY29uZmlnLmh0dHBfcHJveHkKICAgICAgICBzZWxmLl9odHRwc19wcm94eSA9IGNvbmZpZy5odHRwc19wcm94eQogICAgICAgIHNlbGYuX25vX3Byb3h5ID0gY29uZmlnLm5vX3Byb3h5CiAgICAgICAgc2VsZi5fc29ja3NfNXByb3h5ID0gY29uZmlnLnNvY2tzXzVwcm94eQogICAgICAgIHNlbGYuX3NvY2tzXzVuZXRfd29yayA9IGNvbmZpZy5zb2Nrc181bmV0X3dvcmsKICAgICAgICBzZWxmLl9tYXhfaWRsZV9jb25ucyA9IGNvbmZpZy5tYXhfaWRsZV9jb25ucwogICAgICAgIHNlbGYuX3NpZ25hdHVyZV92ZXJzaW9uID0gY29uZmlnLnNpZ25hdHVyZV92ZXJzaW9uCiAgICAgICAgc2VsZi5fc2lnbmF0dXJlX2FsZ29yaXRobSA9IGNvbmZpZy5zaWduYXR1cmVfYWxnb3JpdGhtCiAgICAgICAgc2VsZi5fZ2xvYmFsX3BhcmFtZXRlcnMgPSBjb25maWcuZ2xvYmFsX3BhcmFtZXRlcnMKICAgICAgICBzZWxmLl9rZXkgPSBjb25maWcua2V5CiAgICAgICAgc2VsZi5fY2VydCA9IGNvbmZpZy5jZXJ0CiAgICAgICAgc2VsZi5fY2EgPSBjb25maWcuY2EKCiAgICBkZWYgZG9fcnBjcmVxdWVzdCgKICAgICAgICBzZWxmLAogICAgICAgIGFjdGlvbjogc3RyLAogICAgICAgIHZlcnNpb246IHN0ciwKICAgICAgICBwcm90b2NvbDogc3RyLAogICAgICAgIG1ldGhvZDogc3RyLAogICAgICAgIGF1dGhfdHlwZTogc3RyLAogICAgICAgIGJvZHlfdHlwZTogc3RyLAogICAgICAgIHJlcXVlc3Q6IG9wZW5fYXBpX21vZGVscy5PcGVuQXBpUmVxdWVzdCwKICAgICAgICBydW50aW1lOiB1dGlsX21vZGVscy5SdW50aW1lT3B0aW9ucywKICAgICkgLT4gZGljdDoKICAgICAgICAiIiIKICAgICAgICBFbmNhcHN1bGF0ZSB0aGUgcmVxdWVzdCBhbmQgaW52b2tlIHRoZSBuZXR3b3JrCiAgICAgICAgQHBhcmFtIGFjdGlvbjogYXBpIG5hbWUKICAgICAgICBAcGFyYW0gdmVyc2lvbjogcHJvZHVjdCB2ZXJzaW9uCiAgICAgICAgQHBhcmFtIHByb3RvY29sOiBodHRwIG9yIGh0dHBzCiAgICAgICAgQHBhcmFtIG1ldGhvZDogZS5nLiBHRVQKICAgICAgICBAcGFyYW0gYXV0aF90eXBlOiBhdXRob3JpemF0aW9uIHR5cGUgZS5nLiBBSwogICAgICAgIEBwYXJhbSBib2R5X3R5cGU6IHJlc3BvbnNlIGJvZHkgdHlwZSBlLmcuIFN0cmluZwogICAgICAgIEBwYXJhbSByZXF1ZXN0OiBvYmplY3Qgb2YgT3BlbkFwaVJlcXVlc3QKICAgICAgICBAcGFyYW0gcnVudGltZTogd2hpY2ggY29udHJvbHMgc29tZSBkZXRhaWxzIG9mIGNhbGwgYXBpLCBzdWNoIGFzIHJldHJ5IHRpbWVzCiAgICAgICAgQHJldHVybjogdGhlIHJlc3BvbnNlCiAgICAgICAgIiIiCiAgICAgICAgcmVxdWVzdC52YWxpZGF0ZSgpCiAgICAgICAgcnVudGltZS52YWxpZGF0ZSgpCiAgICAgICAgX3J1bnRpbWUgPSB7CiAgICAgICAgICAgICd0aW1lb3V0ZWQnOiAncmV0cnknLAogICAgICAgICAgICAna2V5JzogVXRpbENsaWVudC5kZWZhdWx0X3N0cmluZyhydW50aW1lLmtleSwgc2VsZi5fa2V5KSwKICAgICAgICAgICAgJ2NlcnQnOiBVdGlsQ2xpZW50LmRlZmF1bHRfc3RyaW5nKHJ1bnRpbWUuY2VydCwgc2VsZi5fY2VydCksCiAgICAgICAgICAgICdjYSc6IFV0aWxDbGllbnQuZGVmYXVsdF9zdHJpbmcocnVudGltZS5jYSwgc2VsZi5fY2EpLAogICAgICAgICAgICAncmVhZFRpbWVvdXQnOiBVdGlsQ2xpZW50LmRlZmF1bHRfbnVtYmVyKHJ1bnRpbWUucmVhZF90aW1lb3V0LCBzZWxmLl9yZWFkX3RpbWVvdXQpLAogICAgICAgICAgICAnY29ubmVjdFRpbWVvdXQnOiBVdGlsQ2xpZW50LmRlZmF1bHRfbnVtYmVyKHJ1bnRpbWUuY29ubmVjdF90aW1lb3V0LCBzZWxmLl9jb25uZWN0X3RpbWVvdXQpLAogICAgICAgICAgICAnaHR0cFByb3h5JzogVXRpbENsaWVudC5kZWZhdWx0X3N0cmluZyhydW50aW1lLmh0dHBfcHJveHksIHNlbGYuX2h0dHBfcHJveHkpLAogICAgICAgICAgICAnaHR0cHNQcm94eSc6IFV0aWxDbGllbnQuZGVmYXVsdF9zdHJpbmcocnVudGltZS5odHRwc19wcm94eSwgc2VsZi5faHR0cHNfcHJveHkpLAogICAgICAgICAgICAnbm9Qcm94eSc6IFV0aWxDbGllbnQuZGVmYXVsdF9zdHJpbmcocnVudGltZS5ub19wcm94eSwgc2VsZi5fbm9fcHJveHkpLAogICAgICAgICAgICAnc29ja3M1UHJveHknOiBVdGlsQ2xpZW50LmRlZmF1bHRfc3RyaW5nKHJ1bnRpbWUuc29ja3NfNXByb3h5LCBzZWxmLl9zb2Nrc181cHJveHkpLAogICAgICAgICAgICAnc29ja3M1TmV0V29yayc6IFV0aWxDbGllbnQuZGVmYXVsdF9zdHJpbmcocnVudGltZS5zb2Nrc181bmV0X3dvcmssIHNlbGYuX3NvY2tzXzVuZXRfd29yayksCiAgICAgICAgICAgICdtYXhJZGxlQ29ubnMnOiBVdGlsQ2xpZW50LmRlZmF1bHRfbnVtYmVyKHJ1bnRpbWUubWF4X2lkbGVfY29ubnMsIHNlbGYuX21heF9pZGxlX2Nvbm5zKSwKICAgICAgICAgICAgJ3JldHJ5JzogewogICAgICAgICAgICAgICAgJ3JldHJ5YWJsZSc6IHJ1bnRpbWUuYXV0b3JldHJ5LAogICAgICAgICAgICAgICAgJ21heEF0dGVtcHRzJzogVXRpbENsaWVudC5kZWZhdWx0X251bWJlcihydW50aW1lLm1heF9hdHRlbXB0cywgMykKICAgICAgICAgICAgfSwKICAgICAgICAgICAgJ2JhY2tvZmYnOiB7CiAgICAgICAgICAgICAgICAncG9saWN5JzogVXRpbENsaWVudC5kZWZhdWx0X3N0cmluZyhydW50aW1lLmJhY2tvZmZfcG9saWN5LCAnbm8nKSwKICAgICAgICAgICAgICAgICdwZXJpb2QnOiBVdGlsQ2xpZW50LmRlZmF1bHRfbnVtYmVyKHJ1bnRpbWUuYmFja29mZl9wZXJpb2QsIDEpCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICdpZ25vcmVTU0wnOiBydW50aW1lLmlnbm9yZV9zc2wKICAgICAgICB9CiAgICAgICAgX2xhc3RfcmVxdWVzdCA9IE5vbmUKICAgICAgICBfbGFzdF9leGNlcHRpb24gPSBOb25lCiAgICAgICAgX25vdyA9IHRpbWUudGltZSgpCiAgICAgICAgX3JldHJ5X3RpbWVzID0gMAogICAgICAgIHdoaWxlIFRlYUNvcmUuYWxsb3dfcmV0cnkoX3J1bnRpbWUuZ2V0KCdyZXRyeScpLCBfcmV0cnlfdGltZXMsIF9ub3cpOgogICAgICAgICAgICBpZiBfcmV0cnlfdGltZXMgPiAwOgogICAgICAgICAgICAgICAgX2JhY2tvZmZfdGltZSA9IFRlYUNvcmUuZ2V0X2JhY2tvZmZfdGltZShfcnVudGltZS5nZXQoJ2JhY2tvZmYnKSwgX3JldHJ5X3RpbWVzKQogICAgICAgICAgICAgICAgaWYgX2JhY2tvZmZfdGltZSA+IDA6CiAgICAgICAgICAgICAgICAgICAgVGVhQ29yZS5zbGVlcChfYmFja29mZl90aW1lKQogICAgICAgICAgICBfcmV0cnlfdGltZXMgPSBfcmV0cnlfdGltZXMgKyAxCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIF9yZXF1ZXN0ID0gVGVhUmVxdWVzdCgpCiAgICAgICAgICAgICAgICBfcmVxdWVzdC5wcm90b2NvbCA9IFV0aWxDbGllbnQuZGVmYXVsdF9zdHJpbmcoc2VsZi5fcHJvdG9jb2wsIHByb3RvY29sKQogICAgICAgICAgICAgICAgX3JlcXVlc3QubWV0aG9kID0gbWV0aG9kCiAgICAgICAgICAgICAgICBfcmVxdWVzdC5wYXRobmFtZSA9ICcvJwogICAgICAgICAgICAgICAgZ2xvYmFsX3F1ZXJpZXMgPSB7fQogICAgICAgICAgICAgICAgZ2xvYmFsX2hlYWRlcnMgPSB7fQogICAgICAgICAgICAgICAgaWYgbm90IFV0aWxDbGllbnQuaXNfdW5zZXQoc2VsZi5fZ2xvYmFsX3BhcmFtZXRlcnMpOgogICAgICAgICAgICAgICAgICAgIGdsb2JhbF9wYXJhbXMgPSBzZWxmLl9nbG9iYWxfcGFyYW1ldGVycwogICAgICAgICAgICAgICAgICAgIGlmIG5vdCBVdGlsQ2xpZW50LmlzX3Vuc2V0KGdsb2JhbF9wYXJhbXMucXVlcmllcyk6CiAgICAgICAgICAgICAgICAgICAgICAgIGdsb2JhbF9xdWVyaWVzID0gZ2xvYmFsX3BhcmFtcy5xdWVyaWVzCiAgICAgICAgICAgICAgICAgICAgaWYgbm90IFV0aWxDbGllbnQuaXNfdW5zZXQoZ2xvYmFsX3BhcmFtcy5oZWFkZXJzKToKICAgICAgICAgICAgICAgICAgICAgICAgZ2xvYmFsX2hlYWRlcnMgPSBnbG9iYWxfcGFyYW1zLmhlYWRlcnMKICAgICAgICAgICAgICAgIF9yZXF1ZXN0LnF1ZXJ5ID0gVGVhQ29yZS5tZXJnZSh7CiAgICAgICAgICAgICAgICAgICAgJ0FjdGlvbic6IGFjdGlvbiwKICAgICAgICAgICAgICAgICAgICAnRm9ybWF0JzogJ2pzb24nLAogICAgICAgICAgICAgICAgICAgICdWZXJzaW9uJzogdmVyc2lvbiwKICAgICAgICAgICAgICAgICAgICAnVGltZXN0YW1wJzogT3BlbkFwaVV0aWxDbGllbnQuZ2V0X3RpbWVzdGFtcCgpLAogICAgICAgICAgICAgICAgICAgICdTaWduYXR1cmVOb25jZSc6IFV0aWxDbGllbnQuZ2V0X25vbmNlKCkKICAgICAgICAgICAgICAgIH0sIGdsb2JhbF9xdWVyaWVzLAogICAgICAgICAgICAgICAgICAgIHJlcXVlc3QucXVlcnkpCiAgICAgICAgICAgICAgICBoZWFkZXJzID0gc2VsZi5nZXRfcnBjX2hlYWRlcnMoKQogICAgICAgICAgICAgICAgaWYgVXRpbENsaWVudC5pc191bnNldChoZWFkZXJzKToKICAgICAgICAgICAgICAgICAgICAjIGVuZHBvaW50IGlzIHNldHRlZCBpbiBwcm9kdWN0IGNsaWVudAogICAgICAgICAgICAgICAgICAgIF9yZXF1ZXN0LmhlYWRlcnMgPSBUZWFDb3JlLm1lcmdlKHsKICAgICAgICAgICAgICAgICAgICAgICAgJ2hvc3QnOiBzZWxmLl9lbmRwb2ludCwKICAgICAgICAgICAgICAgICAgICAgICAgJ3gtYWNzLXZlcnNpb24nOiB2ZXJzaW9uLAogICAgICAgICAgICAgICAgICAgICAgICAneC1hY3MtYWN0aW9uJzogYWN0aW9uLAogICAgICAgICAgICAgICAgICAgICAgICAndXNlci1hZ2VudCc6IHNlbGYuZ2V0X3VzZXJfYWdlbnQoKQogICAgICAgICAgICAgICAgICAgIH0sIGdsb2JhbF9oZWFkZXJzKQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBfcmVxdWVzdC5oZWFkZXJzID0gVGVhQ29yZS5tZXJnZSh7CiAgICAgICAgICAgICAgICAgICAgICAgICdob3N0Jzogc2VsZi5fZW5kcG9pbnQsCiAgICAgICAgICAgICAgICAgICAgICAgICd4LWFjcy12ZXJzaW9uJzogdmVyc2lvbiwKICAgICAgICAgICAgICAgICAgICAgICAgJ3gtYWNzLWFjdGlvbic6IGFjdGlvbiwKICAgICAgICAgICAgICAgICAgICAgICAgJ3VzZXItYWdlbnQnOiBzZWxmLmdldF91c2VyX2FnZW50KCkKICAgICAgICAgICAgICAgICAgICB9LCBnbG9iYWxfaGVhZGVycywKICAgICAgICAgICAgICAgICAgICAgICAgaGVhZGVycykKICAgICAgICAgICAgICAgIGlmIG5vdCBVdGlsQ2xpZW50LmlzX3Vuc2V0KHJlcXVlc3QuYm9keSk6CiAgICAgICAgICAgICAgICAgICAgbSA9IFV0aWxDbGllbnQuYXNzZXJ0X2FzX21hcChyZXF1ZXN0LmJvZHkpCiAgICAgICAgICAgICAgICAgICAgdG1wID0gVXRpbENsaWVudC5hbnlpZnlfbWFwX3ZhbHVlKE9wZW5BcGlVdGlsQ2xpZW50LnF1ZXJ5KG0pKQogICAgICAgICAgICAgICAgICAgIF9yZXF1ZXN0LmJvZHkgPSBVdGlsQ2xpZW50LnRvX2Zvcm1fc3RyaW5nKHRtcCkKICAgICAgICAgICAgICAgICAgICBfcmVxdWVzdC5oZWFkZXJzWydjb250ZW50LXR5cGUnXSA9ICdhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQnCiAgICAgICAgICAgICAgICBpZiBub3QgVXRpbENsaWVudC5lcXVhbF9zdHJpbmcoYXV0aF90eXBlLCAnQW5vbnltb3VzJyk6CiAgICAgICAgICAgICAgICAgICAgYWNjZXNzX2tleV9pZCA9IHNlbGYuZ2V0X2FjY2Vzc19rZXlfaWQoKQogICAgICAgICAgICAgICAgICAgIGFjY2Vzc19rZXlfc2VjcmV0ID0gc2VsZi5nZXRfYWNjZXNzX2tleV9zZWNyZXQoKQogICAgICAgICAgICAgICAgICAgIHNlY3VyaXR5X3Rva2VuID0gc2VsZi5nZXRfc2VjdXJpdHlfdG9rZW4oKQogICAgICAgICAgICAgICAgICAgIGlmIG5vdCBVdGlsQ2xpZW50LmVtcHR5KHNlY3VyaXR5X3Rva2VuKToKICAgICAgICAgICAgICAgICAgICAgICAgX3JlcXVlc3QucXVlcnlbJ1NlY3VyaXR5VG9rZW4nXSA9IHNlY3VyaXR5X3Rva2VuCiAgICAgICAgICAgICAgICAgICAgX3JlcXVlc3QucXVlcnlbJ1NpZ25hdHVyZU1ldGhvZCddID0gJ0hNQUMtU0hBMScKICAgICAgICAgICAgICAgICAgICBfcmVxdWVzdC5xdWVyeVsnU2lnbmF0dXJlVmVyc2lvbiddID0gJzEuMCcKICAgICAgICAgICAgICAgICAgICBfcmVxdWVzdC5xdWVyeVsnQWNjZXNzS2V5SWQnXSA9IGFjY2Vzc19rZXlfaWQKICAgICAgICAgICAgICAgICAgICB0ID0gTm9uZQogICAgICAgICAgICAgICAgICAgIGlmIG5vdCBVdGlsQ2xpZW50LmlzX3Vuc2V0KHJlcXVlc3QuYm9keSk6CiAgICAgICAgICAgICAgICAgICAgICAgIHQgPSBVdGlsQ2xpZW50LmFzc2VydF9hc19tYXAocmVxdWVzdC5ib2R5KQogICAgICAgICAgICAgICAgICAgIHNpZ25lZF9wYXJhbSA9IFRlYUNvcmUubWVyZ2UoX3JlcXVlc3QucXVlcnksCiAgICAgICAgICAgICAgICAgICAgICAgIE9wZW5BcGlVdGlsQ2xpZW50LnF1ZXJ5KHQpKQogICAgICAgICAgICAgICAgICAgIF9yZXF1ZXN0LnF1ZXJ5WydTaWduYXR1cmUnXSA9IE9wZW5BcGlVdGlsQ2xpZW50LmdldF9ycGNzaWduYXR1cmUoc2lnbmVkX3BhcmFtLCBfcmVxdWVzdC5tZXRob2QsIGFjY2Vzc19rZXlfc2VjcmV0KQogICAgICAgICAgICAgICAgX2xhc3RfcmVxdWVzdCA9IF9yZXF1ZXN0CiAgICAgICAgICAgICAgICBfcmVzcG9uc2UgPSBUZWFDb3JlLmRvX2FjdGlvbihfcmVxdWVzdCwgX3J1bnRpbWUpCiAgICAgICAgICAgICAgICBpZiBVdGlsQ2xpZW50LmlzXzR4eChfcmVzcG9uc2Uuc3RhdHVzX2NvZGUpIG9yIFV0aWxDbGllbnQuaXNfNXh4KF9yZXNwb25zZS5zdGF0dXNfY29kZSk6CiAgICAgICAgICAgICAgICAgICAgX3JlcyA9IFV0aWxDbGllbnQucmVhZF9hc19qc29uKF9yZXNwb25zZS5ib2R5KQogICAgICAgICAgICAgICAgICAgIGVyciA9IFV0aWxDbGllbnQuYXNzZXJ0X2FzX21hcChfcmVzKQogICAgICAgICAgICAgICAgICAgIHJlcXVlc3RfaWQgPSBzZWxmLmRlZmF1bHRfYW55KGVyci5nZXQoJ1JlcXVlc3RJZCcpLCBlcnIuZ2V0KCdyZXF1ZXN0SWQnKSkKICAgICAgICAgICAgICAgICAgICBlcnJbJ3N0YXR1c0NvZGUnXSA9IF9yZXNwb25zZS5zdGF0dXNfY29kZQogICAgICAgICAgICAgICAgICAgIHJhaXNlIFRlYUV4Y2VwdGlvbih7CiAgICAgICAgICAgICAgICAgICAgICAgICdjb2RlJzogZiJ7c2VsZi5kZWZhdWx0X2FueShlcnIuZ2V0KCdDb2RlJyksIGVyci5nZXQoJ2NvZGUnKSl9IiwKICAgICAgICAgICAgICAgICAgICAgICAgJ21lc3NhZ2UnOiBmImNvZGU6IHtfcmVzcG9uc2Uuc3RhdHVzX2NvZGV9LCB7c2VsZi5kZWZhdWx0X2FueShlcnIuZ2V0KCdNZXNzYWdlJyksIGVyci5nZXQoJ21lc3NhZ2UnKSl9IHJlcXVlc3QgaWQ6IHtyZXF1ZXN0X2lkfSIsCiAgICAgICAgICAgICAgICAgICAgICAgICdkYXRhJzogZXJyLAogICAgICAgICAgICAgICAgICAgICAgICAnZGVzY3JpcHRpb24nOiBmIntzZWxmLmRlZmF1bHRfYW55KGVyci5nZXQoJ0Rlc2NyaXB0aW9uJyksIGVyci5nZXQoJ2Rlc2NyaXB0aW9uJykpfSIsCiAgICAgICAgICAgICAgICAgICAgICAgICdhY2Nlc3NEZW5pZWREZXRhaWwnOiBzZWxmLmRlZmF1bHRfYW55KGVyci5nZXQoJ0FjY2Vzc0RlbmllZERldGFpbCcpLCBlcnIuZ2V0KCdhY2Nlc3NEZW5pZWREZXRhaWwnKSkKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgaWYgVXRpbENsaWVudC5lcXVhbF9zdHJpbmcoYm9keV90eXBlLCAnYmluYXJ5Jyk6CiAgICAgICAgICAgICAgICAgICAgcmVzcCA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgJ2JvZHknOiBfcmVzcG9uc2UuYm9keSwKICAgICAgICAgICAgICAgICAgICAgICAgJ2hlYWRlcnMnOiBfcmVzcG9uc2UuaGVhZGVycywKICAgICAgICAgICAgICAgICAgICAgICAgJ3N0YXR1c0NvZGUnOiBfcmVzcG9uc2Uuc3RhdHVzX2NvZGUKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3AKICAgICAgICAgICAgICAgIGVsaWYgVXRpbENsaWVudC5lcXVhbF9zdHJpbmcoYm9keV90eXBlLCAnYnl0ZScpOgogICAgICAgICAgICAgICAgICAgIGJ5dCA9IFV0aWxDbGllbnQucmVhZF9hc19ieXRlcyhfcmVzcG9uc2UuYm9keSkKICAgICAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICAgICAgICAnYm9keSc6IGJ5dCwKICAgICAgICAgICAgICAgICAgICAgICAgJ2hlYWRlcnMnOiBfcmVzcG9uc2UuaGVhZGVycywKICAgICAgICAgICAgICAgICAgICAgICAgJ3N0YXR1c0NvZGUnOiBfcmVzcG9uc2Uuc3RhdHVzX2NvZGUKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbGlmIFV0aWxDbGllbnQuZXF1YWxfc3RyaW5nKGJvZHlfdHlwZSwgJ3N0cmluZycpOgogICAgICAgICAgICAgICAgICAgIHN0ciA9IFV0aWxDbGllbnQucmVhZF9hc19zdHJpbmcoX3Jlc3BvbnNlLmJvZHkpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgICAgICAgJ2JvZHknOiBzdHIsCiAgICAgICAgICAgICAgICAgICAgICAgICdoZWFkZXJzJzogX3Jlc3BvbnNlLmhlYWRlcnMsCiAgICAgICAgICAgICAgICAgICAgICAgICdzdGF0dXNDb2RlJzogX3Jlc3BvbnNlLnN0YXR1c19jb2RlCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxpZiBVdGlsQ2xpZW50LmVxdWFsX3N0cmluZyhib2R5X3R5cGUsICdqc29uJyk6CiAgICAgICAgICAgICAgICAgICAgb2JqID0gVXRpbENsaWVudC5yZWFkX2FzX2pzb24oX3Jlc3BvbnNlLmJvZHkpCiAgICAgICAgICAgICAgICAgICAgcmVzID0gVXRpbENsaWVudC5hc3NlcnRfYXNfbWFwKG9iaikKICAgICAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICAgICAgICAnYm9keSc6IHJlcywKICAgICAgICAgICAgICAgICAgICAgICAgJ2hlYWRlcnMnOiBfcmVzcG9uc2UuaGVhZGVycywKICAgICAgICAgICAgICAgICAgICAgICAgJ3N0YXR1c0NvZGUnOiBfcmVzcG9uc2Uuc3RhdHVzX2NvZGUKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbGlmIFV0aWxDbGllbnQuZXF1YWxfc3RyaW5nKGJvZHlfdHlwZSwgJ2FycmF5Jyk6CiAgICAgICAgICAgICAgICAgICAgYXJyID0gVXRpbENsaWVudC5yZWFkX2FzX2pzb24oX3Jlc3BvbnNlLmJvZHkpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgICAgICAgJ2JvZHknOiBhcnIsCiAgICAgICAgICAgICAgICAgICAgICAgICdoZWFkZXJzJzogX3Jlc3BvbnNlLmhlYWRlcnMsCiAgICAgICAgICAgICAgICAgICAgICAgICdzdGF0dXNDb2RlJzogX3Jlc3BvbnNlLnN0YXR1c19jb2RlCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICAgICAgICAnaGVhZGVycyc6IF9yZXNwb25zZS5oZWFkZXJzLAogICAgICAgICAgICAgICAgICAgICAgICAnc3RhdHVzQ29kZSc6IF9yZXNwb25zZS5zdGF0dXNfY29kZQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgaWYgVGVhQ29yZS5pc19yZXRyeWFibGUoZSk6CiAgICAgICAgICAgICAgICAgICAgX2xhc3RfZXhjZXB0aW9uID0gZQogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICByYWlzZSBlCiAgICAgICAgcmFpc2UgVW5yZXRyeWFibGVFeGNlcHRpb24oX2xhc3RfcmVxdWVzdCwgX2xhc3RfZXhjZXB0aW9uKQoKICAgIGFzeW5jIGRlZiBkb19ycGNyZXF1ZXN0X2FzeW5jKAogICAgICAgIHNlbGYsCiAgICAgICAgYWN0aW9uOiBzdHIsCiAgICAgICAgdmVyc2lvbjogc3RyLAogICAgICAgIHByb3RvY29sOiBzdHIsCiAgICAgICAgbWV0aG9kOiBzdHIsCiAgICAgICAgYXV0aF90eXBlOiBzdHIsCiAgICAgICAgYm9keV90eXBlOiBzdHIsCiAgICAgICAgcmVxdWVzdDogb3Blbl9hcGlfbW9kZWxzLk9wZW5BcGlSZXF1ZXN0LAogICAgICAgIHJ1bnRpbWU6IHV0aWxfbW9kZWxzLlJ1bnRpbWVPcHRpb25zLAogICAgKSAtPiBkaWN0OgogICAgICAgICIiIgogICAgICAgIEVuY2Fwc3VsYXRlIHRoZSByZXF1ZXN0IGFuZCBpbnZva2UgdGhlIG5ldHdvcmsKICAgICAgICBAcGFyYW0gYWN0aW9uOiBhcGkgbmFtZQogICAgICAgIEBwYXJhbSB2ZXJzaW9uOiBwcm9kdWN0IHZlcnNpb24KICAgICAgICBAcGFyYW0gcHJvdG9jb2w6IGh0dHAgb3IgaHR0cHMKICAgICAgICBAcGFyYW0gbWV0aG9kOiBlLmcuIEdFVAogICAgICAgIEBwYXJhbSBhdXRoX3R5cGU6IGF1dGhvcml6YXRpb24gdHlwZSBlLmcuIEFLCiAgICAgICAgQHBhcmFtIGJvZHlfdHlwZTogcmVzcG9uc2UgYm9keSB0eXBlIGUuZy4gU3RyaW5nCiAgICAgICAgQHBhcmFtIHJlcXVlc3Q6IG9iamVjdCBvZiBPcGVuQXBpUmVxdWVzdAogICAgICAgIEBwYXJhbSBydW50aW1lOiB3aGljaCBjb250cm9scyBzb21lIGRldGFpbHMgb2YgY2FsbCBhcGksIHN1Y2ggYXMgcmV0cnkgdGltZXMKICAgICAgICBAcmV0dXJuOiB0aGUgcmVzcG9uc2UKICAgICAgICAiIiIKICAgICAgICByZXF1ZXN0LnZhbGlkYXRlKCkKICAgICAgICBydW50aW1lLnZhbGlkYXRlKCkKICAgICAgICBfcnVudGltZSA9IHsKICAgICAgICAgICAgJ3RpbWVvdXRlZCc6ICdyZXRyeScsCiAgICAgICAgICAgICdrZXknOiBVdGlsQ2xpZW50LmRlZmF1bHRfc3RyaW5nKHJ1bnRpbWUua2V5LCBzZWxmLl9rZXkpLAogICAgICAgICAgICAnY2VydCc6IFV0aWxDbGllbnQuZGVmYXVsdF9zdHJpbmcocnVudGltZS5jZXJ0LCBzZWxmLl9jZXJ0KSwKICAgICAgICAgICAgJ2NhJzogVXRpbENsaWVudC5kZWZhdWx0X3N0cmluZyhydW50aW1lLmNhLCBzZWxmLl9jYSksCiAgICAgICAgICAgICdyZWFkVGltZW91dCc6IFV0aWxDbGllbnQuZGVmYXVsdF9udW1iZXIocnVudGltZS5yZWFkX3RpbWVvdXQsIHNlbGYuX3JlYWRfdGltZW91dCksCiAgICAgICAgICAgICdjb25uZWN0VGltZW91dCc6IFV0aWxDbGllbnQuZGVmYXVsdF9udW1iZXIocnVudGltZS5jb25uZWN0X3RpbWVvdXQsIHNlbGYuX2Nvbm5lY3RfdGltZW91dCksCiAgICAgICAgICAgICdodHRwUHJveHknOiBVdGlsQ2xpZW50LmRlZmF1bHRfc3RyaW5nKHJ1bnRpbWUuaHR0cF9wcm94eSwgc2VsZi5faHR0cF9wcm94eSksCiAgICAgICAgICAgICdodHRwc1Byb3h5JzogVXRpbENsaWVudC5kZWZhdWx0X3N0cmluZyhydW50aW1lLmh0dHBzX3Byb3h5LCBzZWxmLl9odHRwc19wcm94eSksCiAgICAgICAgICAgICdub1Byb3h5JzogVXRpbENsaWVudC5kZWZhdWx0X3N0cmluZyhydW50aW1lLm5vX3Byb3h5LCBzZWxmLl9ub19wcm94eSksCiAgICAgICAgICAgICdzb2NrczVQcm94eSc6IFV0aWxDbGllbnQuZGVmYXVsdF9zdHJpbmcocnVudGltZS5zb2Nrc181cHJveHksIHNlbGYuX3NvY2tzXzVwcm94eSksCiAgICAgICAgICAgICdzb2NrczVOZXRXb3JrJzogVXRpbENsaWVudC5kZWZhdWx0X3N0cmluZyhydW50aW1lLnNvY2tzXzVuZXRfd29yaywgc2VsZi5fc29ja3NfNW5ldF93b3JrKSwKICAgICAgICAgICAgJ21heElkbGVDb25ucyc6IFV0aWxDbGllbnQuZGVmYXVsdF9udW1iZXIocnVudGltZS5tYXhfaWRsZV9jb25ucywgc2VsZi5fbWF4X2lkbGVfY29ubnMpLAogICAgICAgICAgICAncmV0cnknOiB7CiAgICAgICAgICAgICAgICAncmV0cnlhYmxlJzogcnVudGltZS5hdXRvcmV0cnksCiAgICAgICAgICAgICAgICAnbWF4QXR0ZW1wdHMnOiBVdGlsQ2xpZW50LmRlZmF1bHRfbnVtYmVyKHJ1bnRpbWUubWF4X2F0dGVtcHRzLCAzKQogICAgICAgICAgICB9LAogICAgICAgICAgICAnYmFja29mZic6IHsKICAgICAgICAgICAgICAgICdwb2xpY3knOiBVdGlsQ2xpZW50LmRlZmF1bHRfc3RyaW5nKHJ1bnRpbWUuYmFja29mZl9wb2xpY3ksICdubycpLAogICAgICAgICAgICAgICAgJ3BlcmlvZCc6IFV0aWxDbGllbnQuZGVmYXVsdF9udW1iZXIocnVudGltZS5iYWNrb2ZmX3BlcmlvZCwgMSkKICAgICAgICAgICAgfSwKICAgICAgICAgICAgJ2lnbm9yZVNTTCc6IHJ1bnRpbWUuaWdub3JlX3NzbAogICAgICAgIH0KICAgICAgICBfbGFzdF9yZXF1ZXN0ID0gTm9uZQogICAgICAgIF9sYXN0X2V4Y2VwdGlvbiA9IE5vbmUKICAgICAgICBfbm93ID0gdGltZS50aW1lKCkKICAgICAgICBfcmV0cnlfdGltZXMgPSAwCiAgICAgICAgd2hpbGUgVGVhQ29yZS5hbGxvd19yZXRyeShfcnVudGltZS5nZXQoJ3JldHJ5JyksIF9yZXRyeV90aW1lcywgX25vdyk6CiAgICAgICAgICAgIGlmIF9yZXRyeV90aW1lcyA+IDA6CiAgICAgICAgICAgICAgICBfYmFja29mZl90aW1lID0gVGVhQ29yZS5nZXRfYmFja29mZl90aW1lKF9ydW50aW1lLmdldCgnYmFja29mZicpLCBfcmV0cnlfdGltZXMpCiAgICAgICAgICAgICAgICBpZiBfYmFja29mZl90aW1lID4gMDoKICAgICAgICAgICAgICAgICAgICBUZWFDb3JlLnNsZWVwKF9iYWNrb2ZmX3RpbWUpCiAgICAgICAgICAgIF9yZXRyeV90aW1lcyA9IF9yZXRyeV90aW1lcyArIDEKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgX3JlcXVlc3QgPSBUZWFSZXF1ZXN0KCkKICAgICAgICAgICAgICAgIF9yZXF1ZXN0LnByb3RvY29sID0gVXRpbENsaWVudC5kZWZhdWx0X3N0cmluZyhzZWxmLl9wcm90b2NvbCwgcHJvdG9jb2wpCiAgICAgICAgICAgICAgICBfcmVxdWVzdC5tZXRob2QgPSBtZXRob2QKICAgICAgICAgICAgICAgIF9yZXF1ZXN0LnBhdGhuYW1lID0gJy8nCiAgICAgICAgICAgICAgICBnbG9iYWxfcXVlcmllcyA9IHt9CiAgICAgICAgICAgICAgICBnbG9iYWxfaGVhZGVycyA9IHt9CiAgICAgICAgICAgICAgICBpZiBub3QgVXRpbENsaWVudC5pc191bnNldChzZWxmLl9nbG9iYWxfcGFyYW1ldGVycyk6CiAgICAgICAgICAgICAgICAgICAgZ2xvYmFsX3BhcmFtcyA9IHNlbGYuX2dsb2JhbF9wYXJhbWV0ZXJzCiAgICAgICAgICAgICAgICAgICAgaWYgbm90IFV0aWxDbGllbnQuaXNfdW5zZXQoZ2xvYmFsX3BhcmFtcy5xdWVyaWVzKToKICAgICAgICAgICAgICAgICAgICAgICAgZ2xvYmFsX3F1ZXJpZXMgPSBnbG9iYWxfcGFyYW1zLnF1ZXJpZXMKICAgICAgICAgICAgICAgICAgICBpZiBub3QgVXRpbENsaWVudC5pc191bnNldChnbG9iYWxfcGFyYW1zLmhlYWRlcnMpOgogICAgICAgICAgICAgICAgICAgICAgICBnbG9iYWxfaGVhZGVycyA9IGdsb2JhbF9wYXJhbXMuaGVhZGVycwogICAgICAgICAgICAgICAgX3JlcXVlc3QucXVlcnkgPSBUZWFDb3JlLm1lcmdlKHsKICAgICAgICAgICAgICAgICAgICAnQWN0aW9uJzogYWN0aW9uLAogICAgICAgICAgICAgICAgICAgICdGb3JtYXQnOiAnanNvbicsCiAgICAgICAgICAgICAgICAgICAgJ1ZlcnNpb24nOiB2ZXJzaW9uLAogICAgICAgICAgICAgICAgICAgICdUaW1lc3RhbXAnOiBPcGVuQXBpVXRpbENsaWVudC5nZXRfdGltZXN0YW1wKCksCiAgICAgICAgICAgICAgICAgICAgJ1NpZ25hdHVyZU5vbmNlJzogVXRpbENsaWVudC5nZXRfbm9uY2UoKQogICAgICAgICAgICAgICAgfSwgZ2xvYmFsX3F1ZXJpZXMsCiAgICAgICAgICAgICAgICAgICAgcmVxdWVzdC5xdWVyeSkKICAgICAgICAgICAgICAgIGhlYWRlcnMgPSBzZWxmLmdldF9ycGNfaGVhZGVycygpCiAgICAgICAgICAgICAgICBpZiBVdGlsQ2xpZW50LmlzX3Vuc2V0KGhlYWRlcnMpOgogICAgICAgICAgICAgICAgICAgICMgZW5kcG9pbnQgaXMgc2V0dGVkIGluIHByb2R1Y3QgY2xpZW50CiAgICAgICAgICAgICAgICAgICAgX3JlcXVlc3QuaGVhZGVycyA9IFRlYUNvcmUubWVyZ2UoewogICAgICAgICAgICAgICAgICAgICAgICAnaG9zdCc6IHNlbGYuX2VuZHBvaW50LAogICAgICAgICAgICAgICAgICAgICAgICAneC1hY3MtdmVyc2lvbic6IHZlcnNpb24sCiAgICAgICAgICAgICAgICAgICAgICAgICd4LWFjcy1hY3Rpb24nOiBhY3Rpb24sCiAgICAgICAgICAgICAgICAgICAgICAgICd1c2VyLWFnZW50Jzogc2VsZi5nZXRfdXNlcl9hZ2VudCgpCiAgICAgICAgICAgICAgICAgICAgfSwgZ2xvYmFsX2hlYWRlcnMpCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIF9yZXF1ZXN0LmhlYWRlcnMgPSBUZWFDb3JlLm1lcmdlKHsKICAgICAgICAgICAgICAgICAgICAgICAgJ2hvc3QnOiBzZWxmLl9lbmRwb2ludCwKICAgICAgICAgICAgICAgICAgICAgICAgJ3gtYWNzLXZlcnNpb24nOiB2ZXJzaW9uLAogICAgICAgICAgICAgICAgICAgICAgICAneC1hY3MtYWN0aW9uJzogYWN0aW9uLAogICAgICAgICAgICAgICAgICAgICAgICAndXNlci1hZ2VudCc6IHNlbGYuZ2V0X3VzZXJfYWdlbnQoKQogICAgICAgICAgICAgICAgICAgIH0sIGdsb2JhbF9oZWFkZXJzLAogICAgICAgICAgICAgICAgICAgICAgICBoZWFkZXJzKQogICAgICAgICAgICAgICAgaWYgbm90IFV0aWxDbGllbnQuaXNfdW5zZXQocmVxdWVzdC5ib2R5KToKICAgICAgICAgICAgICAgICAgICBtID0gVXRpbENsaWVudC5hc3NlcnRfYXNfbWFwKHJlcXVlc3QuYm9keSkKICAgICAgICAgICAgICAgICAgICB0bXAgPSBVdGlsQ2xpZW50LmFueWlmeV9tYXBfdmFsdWUoT3BlbkFwaVV0aWxDbGllbnQucXVlcnkobSkpCiAgICAgICAgICAgICAgICAgICAgX3JlcXVlc3QuYm9keSA9IFV0aWxDbGllbnQudG9fZm9ybV9zdHJpbmcodG1wKQogICAgICAgICAgICAgICAgICAgIF9yZXF1ZXN0LmhlYWRlcnNbJ2NvbnRlbnQtdHlwZSddID0gJ2FwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZCcKICAgICAgICAgICAgICAgIGlmIG5vdCBVdGlsQ2xpZW50LmVxdWFsX3N0cmluZyhhdXRoX3R5cGUsICdBbm9ueW1vdXMnKToKICAgICAgICAgICAgICAgICAgICBhY2Nlc3Nfa2V5X2lkID0gYXdhaXQgc2VsZi5nZXRfYWNjZXNzX2tleV9pZF9hc3luYygpCiAgICAgICAgICAgICAgICAgICAgYWNjZXNzX2tleV9zZWNyZXQgPSBhd2FpdCBzZWxmLmdldF9hY2Nlc3Nfa2V5X3NlY3JldF9hc3luYygpCiAgICAgICAgICAgICAgICAgICAgc2VjdXJpdHlfdG9rZW4gPSBhd2FpdCBzZWxmLmdldF9zZWN1cml0eV90b2tlbl9hc3luYygpCiAgICAgICAgICAgICAgICAgICAgaWYgbm90IFV0aWxDbGllbnQuZW1wdHkoc2VjdXJpdHlfdG9rZW4pOgogICAgICAgICAgICAgICAgICAgICAgICBfcmVxdWVzdC5xdWVyeVsnU2VjdXJpdHlUb2tlbiddID0gc2VjdXJpdHlfdG9rZW4KICAgICAgICAgICAgICAgICAgICBfcmVxdWVzdC5xdWVyeVsnU2lnbmF0dXJlTWV0aG9kJ10gPSAnSE1BQy1TSEExJwogICAgICAgICAgICAgICAgICAgIF9yZXF1ZXN0LnF1ZXJ5WydTaWduYXR1cmVWZXJzaW9uJ10gPSAnMS4wJwogICAgICAgICAgICAgICAgICAgIF9yZXF1ZXN0LnF1ZXJ5WydBY2Nlc3NLZXlJZCddID0gYWNjZXNzX2tleV9pZAogICAgICAgICAgICAgICAgICAgIHQgPSBOb25lCiAgICAgICAgICAgICAgICAgICAgaWYgbm90IFV0aWxDbGllbnQuaXNfdW5zZXQocmVxdWVzdC5ib2R5KToKICAgICAgICAgICAgICAgICAgICAgICAgdCA9IFV0aWxDbGllbnQuYXNzZXJ0X2FzX21hcChyZXF1ZXN0LmJvZHkpCiAgICAgICAgICAgICAgICAgICAgc2lnbmVkX3BhcmFtID0gVGVhQ29yZS5tZXJnZShfcmVxdWVzdC5xdWVyeSwKICAgICAgICAgICAgICAgICAgICAgICAgT3BlbkFwaVV0aWxDbGllbnQucXVlcnkodCkpCiAgICAgICAgICAgICAgICAgICAgX3JlcXVlc3QucXVlcnlbJ1NpZ25hdHVyZSddID0gT3BlbkFwaVV0aWxDbGllbnQuZ2V0X3JwY3NpZ25hdHVyZShzaWduZWRfcGFyYW0sIF9yZXF1ZXN0Lm1ldGhvZCwgYWNjZXNzX2tleV9zZWNyZXQpCiAgICAgICAgICAgICAgICBfbGFzdF9yZXF1ZXN0ID0gX3JlcXVlc3QKICAgICAgICAgICAgICAgIF9yZXNwb25zZSA9IGF3YWl0IFRlYUNvcmUuYXN5bmNfZG9fYWN0aW9uKF9yZXF1ZXN0LCBfcnVudGltZSkKICAgICAgICAgICAgICAgIGlmIFV0aWxDbGllbnQuaXNfNHh4KF9yZXNwb25zZS5zdGF0dXNfY29kZSkgb3IgVXRpbENsaWVudC5pc181eHgoX3Jlc3BvbnNlLnN0YXR1c19jb2RlKToKICAgICAgICAgICAgICAgICAgICBfcmVzID0gYXdhaXQgVXRpbENsaWVudC5yZWFkX2FzX2pzb25fYXN5bmMoX3Jlc3BvbnNlLmJvZHkpCiAgICAgICAgICAgICAgICAgICAgZXJyID0gVXRpbENsaWVudC5hc3NlcnRfYXNfbWFwKF9yZXMpCiAgICAgICAgICAgICAgICAgICAgcmVxdWVzdF9pZCA9IHNlbGYuZGVmYXVsdF9hbnkoZXJyLmdldCgnUmVxdWVzdElkJyksIGVyci5nZXQoJ3JlcXVlc3RJZCcpKQogICAgICAgICAgICAgICAgICAgIGVyclsnc3RhdHVzQ29kZSddID0gX3Jlc3BvbnNlLnN0YXR1c19jb2RlCiAgICAgICAgICAgICAgICAgICAgcmFpc2UgVGVhRXhjZXB0aW9uKHsKICAgICAgICAgICAgICAgICAgICAgICAgJ2NvZGUnOiBmIntzZWxmLmRlZmF1bHRfYW55KGVyci5nZXQoJ0NvZGUnKSwgZXJyLmdldCgnY29kZScpKX0iLAogICAgICAgICAgICAgICAgICAgICAgICAnbWVzc2FnZSc6IGYiY29kZToge19yZXNwb25zZS5zdGF0dXNfY29kZX0sIHtzZWxmLmRlZmF1bHRfYW55KGVyci5nZXQoJ01lc3NhZ2UnKSwgZXJyLmdldCgnbWVzc2FnZScpKX0gcmVxdWVzdCBpZDoge3JlcXVlc3RfaWR9IiwKICAgICAgICAgICAgICAgICAgICAgICAgJ2RhdGEnOiBlcnIsCiAgICAgICAgICAgICAgICAgICAgICAgICdkZXNjcmlwdGlvbic6IGYie3NlbGYuZGVmYXVsdF9hbnkoZXJyLmdldCgnRGVzY3JpcHRpb24nKSwgZXJyLmdldCgnZGVzY3JpcHRpb24nKSl9IiwKICAgICAgICAgICAgICAgICAgICAgICAgJ2FjY2Vzc0RlbmllZERldGFpbCc6IHNlbGYuZGVmYXVsdF9hbnkoZXJyLmdldCgnQWNjZXNzRGVuaWVkRGV0YWlsJyksIGVyci5nZXQoJ2FjY2Vzc0RlbmllZERldGFpbCcpKQogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICBpZiBVdGlsQ2xpZW50LmVxdWFsX3N0cmluZyhib2R5X3R5cGUsICdiaW5hcnknKToKICAgICAgICAgICAgICAgICAgICByZXNwID0gewogICAgICAgICAgICAgICAgICAgICAgICAnYm9keSc6IF9yZXNwb25zZS5ib2R5LAogICAgICAgICAgICAgICAgICAgICAgICAnaGVhZGVycyc6IF9yZXNwb25zZS5oZWFkZXJzLAogICAgICAgICAgICAgICAgICAgICAgICAnc3RhdHVzQ29kZSc6IF9yZXNwb25zZS5zdGF0dXNfY29kZQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzcAogICAgICAgICAgICAgICAgZWxpZiBVdGlsQ2xpZW50LmVxdWFsX3N0cmluZyhib2R5X3R5cGUsICdieXRlJyk6CiAgICAgICAgICAgICAgICAgICAgYnl0ID0gYXdhaXQgVXRpbENsaWVudC5yZWFkX2FzX2J5dGVzX2FzeW5jKF9yZXNwb25zZS5ib2R5KQogICAgICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgICAgICAgICdib2R5JzogYnl0LAogICAgICAgICAgICAgICAgICAgICAgICAnaGVhZGVycyc6IF9yZXNwb25zZS5oZWFkZXJzLAogICAgICAgICAgICAgICAgICAgICAgICAnc3RhdHVzQ29kZSc6IF9yZXNwb25zZS5zdGF0dXNfY29kZQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsaWYgVXRpbENsaWVudC5lcXVhbF9zdHJpbmcoYm9keV90eXBlLCAnc3RyaW5nJyk6CiAgICAgICAgICAgICAgICAgICAgc3RyID0gYXdhaXQgVXRpbENsaWVudC5yZWFkX2FzX3N0cmluZ19hc3luYyhfcmVzcG9uc2UuYm9keSkKICAgICAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICAgICAgICAnYm9keSc6IHN0ciwKICAgICAgICAgICAgICAgICAgICAgICAgJ2hlYWRlcnMnOiBfcmVzcG9uc2UuaGVhZGVycywKICAgICAgICAgICAgICAgICAgICAgICAgJ3N0YXR1c0NvZGUnOiBfcmVzcG9uc2Uuc3RhdHVzX2NvZGUKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbGlmIFV0aWxDbGllbnQuZXF1YWxfc3RyaW5nKGJvZHlfdHlwZSwgJ2pzb24nKToKICAgICAgICAgICAgICAgICAgICBvYmogPSBhd2FpdCBVdGlsQ2xpZW50LnJlYWRfYXNfanNvbl9hc3luYyhfcmVzcG9uc2UuYm9keSkKICAgICAgICAgICAgICAgICAgICByZXMgPSBVdGlsQ2xpZW50LmFzc2VydF9hc19tYXAob2JqKQogICAgICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgICAgICAgICdib2R5JzogcmVzLAogICAgICAgICAgICAgICAgICAgICAgICAnaGVhZGVycyc6IF9yZXNwb25zZS5oZWFkZXJzLAogICAgICAgICAgICAgICAgICAgICAgICAnc3RhdHVzQ29kZSc6IF9yZXNwb25zZS5zdGF0dXNfY29kZQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsaWYgVXRpbENsaWVudC5lcXVhbF9zdHJpbmcoYm9keV90eXBlLCAnYXJyYXknKToKICAgICAgICAgICAgICAgICAgICBhcnIgPSBhd2FpdCBVdGlsQ2xpZW50LnJlYWRfYXNfanNvbl9hc3luYyhfcmVzcG9uc2UuYm9keSkKICAgICAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICAgICAgICAnYm9keSc6IGFyciwKICAgICAgICAgICAgICAgICAgICAgICAgJ2hlYWRlcnMnOiBfcmVzcG9uc2UuaGVhZGVycywKICAgICAgICAgICAgICAgICAgICAgICAgJ3N0YXR1c0NvZGUnOiBfcmVzcG9uc2Uuc3RhdHVzX2NvZGUKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgICAgICAgICdoZWFkZXJzJzogX3Jlc3BvbnNlLmhlYWRlcnMsCiAgICAgICAgICAgICAgICAgICAgICAgICdzdGF0dXNDb2RlJzogX3Jlc3BvbnNlLnN0YXR1c19jb2RlCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICBpZiBUZWFDb3JlLmlzX3JldHJ5YWJsZShlKToKICAgICAgICAgICAgICAgICAgICBfbGFzdF9leGNlcHRpb24gPSBlCiAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgIHJhaXNlIGUKICAgICAgICByYWlzZSBVbnJldHJ5YWJsZUV4Y2VwdGlvbihfbGFzdF9yZXF1ZXN0LCBfbGFzdF9leGNlcHRpb24pCgogICAgZGVmIGRvX3JvYXJlcXVlc3QoCiAgICAgICAgc2VsZiwKICAgICAgICBhY3Rpb246IHN0ciwKICAgICAgICB2ZXJzaW9uOiBzdHIsCiAgICAgICAgcHJvdG9jb2w6IHN0ciwKICAgICAgICBtZXRob2Q6IHN0ciwKICAgICAgICBhdXRoX3R5cGU6IHN0ciwKICAgICAgICBwYXRobmFtZTogc3RyLAogICAgICAgIGJvZHlfdHlwZTogc3RyLAogICAgICAgIHJlcXVlc3Q6IG9wZW5fYXBpX21vZGVscy5PcGVuQXBpUmVxdWVzdCwKICAgICAgICBydW50aW1lOiB1dGlsX21vZGVscy5SdW50aW1lT3B0aW9ucywKICAgICkgLT4gZGljdDoKICAgICAgICAiIiIKICAgICAgICBFbmNhcHN1bGF0ZSB0aGUgcmVxdWVzdCBhbmQgaW52b2tlIHRoZSBuZXR3b3JrCiAgICAgICAgQHBhcmFtIGFjdGlvbjogYXBpIG5hbWUKICAgICAgICBAcGFyYW0gdmVyc2lvbjogcHJvZHVjdCB2ZXJzaW9uCiAgICAgICAgQHBhcmFtIHByb3RvY29sOiBodHRwIG9yIGh0dHBzCiAgICAgICAgQHBhcmFtIG1ldGhvZDogZS5nLiBHRVQKICAgICAgICBAcGFyYW0gYXV0aF90eXBlOiBhdXRob3JpemF0aW9uIHR5cGUgZS5nLiBBSwogICAgICAgIEBwYXJhbSBwYXRobmFtZTogcGF0aG5hbWUgb2YgZXZlcnkgYXBpCiAgICAgICAgQHBhcmFtIGJvZHlfdHlwZTogcmVzcG9uc2UgYm9keSB0eXBlIGUuZy4gU3RyaW5nCiAgICAgICAgQHBhcmFtIHJlcXVlc3Q6IG9iamVjdCBvZiBPcGVuQXBpUmVxdWVzdAogICAgICAgIEBwYXJhbSBydW50aW1lOiB3aGljaCBjb250cm9scyBzb21lIGRldGFpbHMgb2YgY2FsbCBhcGksIHN1Y2ggYXMgcmV0cnkgdGltZXMKICAgICAgICBAcmV0dXJuOiB0aGUgcmVzcG9uc2UKICAgICAgICAiIiIKICAgICAgICByZXF1ZXN0LnZhbGlkYXRlKCkKICAgICAgICBydW50aW1lLnZhbGlkYXRlKCkKICAgICAgICBfcnVudGltZSA9IHsKICAgICAgICAgICAgJ3RpbWVvdXRlZCc6ICdyZXRyeScsCiAgICAgICAgICAgICdrZXknOiBVdGlsQ2xpZW50LmRlZmF1bHRfc3RyaW5nKHJ1bnRpbWUua2V5LCBzZWxmLl9rZXkpLAogICAgICAgICAgICAnY2VydCc6IFV0aWxDbGllbnQuZGVmYXVsdF9zdHJpbmcocnVudGltZS5jZXJ0LCBzZWxmLl9jZXJ0KSwKICAgICAgICAgICAgJ2NhJzogVXRpbENsaWVudC5kZWZhdWx0X3N0cmluZyhydW50aW1lLmNhLCBzZWxmLl9jYSksCiAgICAgICAgICAgICdyZWFkVGltZW91dCc6IFV0aWxDbGllbnQuZGVmYXVsdF9udW1iZXIocnVudGltZS5yZWFkX3RpbWVvdXQsIHNlbGYuX3JlYWRfdGltZW91dCksCiAgICAgICAgICAgICdjb25uZWN0VGltZW91dCc6IFV0aWxDbGllbnQuZGVmYXVsdF9udW1iZXIocnVudGltZS5jb25uZWN0X3RpbWVvdXQsIHNlbGYuX2Nvbm5lY3RfdGltZW91dCksCiAgICAgICAgICAgICdodHRwUHJveHknOiBVdGlsQ2xpZW50LmRlZmF1bHRfc3RyaW5nKHJ1bnRpbWUuaHR0cF9wcm94eSwgc2VsZi5faHR0cF9wcm94eSksCiAgICAgICAgICAgICdodHRwc1Byb3h5JzogVXRpbENsaWVudC5kZWZhdWx0X3N0cmluZyhydW50aW1lLmh0dHBzX3Byb3h5LCBzZWxmLl9odHRwc19wcm94eSksCiAgICAgICAgICAgICdub1Byb3h5JzogVXRpbENsaWVudC5kZWZhdWx0X3N0cmluZyhydW50aW1lLm5vX3Byb3h5LCBzZWxmLl9ub19wcm94eSksCiAgICAgICAgICAgICdzb2NrczVQcm94eSc6IFV0aWxDbGllbnQuZGVmYXVsdF9zdHJpbmcocnVudGltZS5zb2Nrc181cHJveHksIHNlbGYuX3NvY2tzXzVwcm94eSksCiAgICAgICAgICAgICdzb2NrczVOZXRXb3JrJzogVXRpbENsaWVudC5kZWZhdWx0X3N0cmluZyhydW50aW1lLnNvY2tzXzVuZXRfd29yaywgc2VsZi5fc29ja3NfNW5ldF93b3JrKSwKICAgICAgICAgICAgJ21heElkbGVDb25ucyc6IFV0aWxDbGllbnQuZGVmYXVsdF9udW1iZXIocnVudGltZS5tYXhfaWRsZV9jb25ucywgc2VsZi5fbWF4X2lkbGVfY29ubnMpLAogICAgICAgICAgICAncmV0cnknOiB7CiAgICAgICAgICAgICAgICAncmV0cnlhYmxlJzogcnVudGltZS5hdXRvcmV0cnksCiAgICAgICAgICAgICAgICAnbWF4QXR0ZW1wdHMnOiBVdGlsQ2xpZW50LmRlZmF1bHRfbnVtYmVyKHJ1bnRpbWUubWF4X2F0dGVtcHRzLCAzKQogICAgICAgICAgICB9LAogICAgICAgICAgICAnYmFja29mZic6IHsKICAgICAgICAgICAgICAgICdwb2xpY3knOiBVdGlsQ2xpZW50LmRlZmF1bHRfc3RyaW5nKHJ1bnRpbWUuYmFja29mZl9wb2xpY3ksICdubycpLAogICAgICAgICAgICAgICAgJ3BlcmlvZCc6IFV0aWxDbGllbnQuZGVmYXVsdF9udW1iZXIocnVudGltZS5iYWNrb2ZmX3BlcmlvZCwgMSkKICAgICAgICAgICAgfSwKICAgICAgICAgICAgJ2lnbm9yZVNTTCc6IHJ1bnRpbWUuaWdub3JlX3NzbAogICAgICAgIH0KICAgICAgICBfbGFzdF9yZXF1ZXN0ID0gTm9uZQogICAgICAgIF9sYXN0X2V4Y2VwdGlvbiA9IE5vbmUKICAgICAgICBfbm93ID0gdGltZS50aW1lKCkKICAgICAgICBfcmV0cnlfdGltZXMgPSAwCiAgICAgICAgd2hpbGUgVGVhQ29yZS5hbGxvd19yZXRyeShfcnVudGltZS5nZXQoJ3JldHJ5JyksIF9yZXRyeV90aW1lcywgX25vdyk6CiAgICAgICAgICAgIGlmIF9yZXRyeV90aW1lcyA+IDA6CiAgICAgICAgICAgICAgICBfYmFja29mZl90aW1lID0gVGVhQ29yZS5nZXRfYmFja29mZl90aW1lKF9ydW50aW1lLmdldCgnYmFja29mZicpLCBfcmV0cnlfdGltZXMpCiAgICAgICAgICAgICAgICBpZiBfYmFja29mZl90aW1lID4gMDoKICAgICAgICAgICAgICAgICAgICBUZWFDb3JlLnNsZWVwKF9iYWNrb2ZmX3RpbWUpCiAgICAgICAgICAgIF9yZXRyeV90aW1lcyA9IF9yZXRyeV90aW1lcyArIDEKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgX3JlcXVlc3QgPSBUZWFSZXF1ZXN0KCkKICAgICAgICAgICAgICAgIF9yZXF1ZXN0LnByb3RvY29sID0gVXRpbENsaWVudC5kZWZhdWx0X3N0cmluZyhzZWxmLl9wcm90b2NvbCwgcHJvdG9jb2wpCiAgICAgICAgICAgICAgICBfcmVxdWVzdC5tZXRob2QgPSBtZXRob2QKICAgICAgICAgICAgICAgIF9yZXF1ZXN0LnBhdGhuYW1lID0gcGF0aG5hbWUKICAgICAgICAgICAgICAgIGdsb2JhbF9xdWVyaWVzID0ge30KICAgICAgICAgICAgICAgIGdsb2JhbF9oZWFkZXJzID0ge30KICAgICAgICAgICAgICAgIGlmIG5vdCBVdGlsQ2xpZW50LmlzX3Vuc2V0KHNlbGYuX2dsb2JhbF9wYXJhbWV0ZXJzKToKICAgICAgICAgICAgICAgICAgICBnbG9iYWxfcGFyYW1zID0gc2VsZi5fZ2xvYmFsX3BhcmFtZXRlcnMKICAgICAgICAgICAgICAgICAgICBpZiBub3QgVXRpbENsaWVudC5pc191bnNldChnbG9iYWxfcGFyYW1zLnF1ZXJpZXMpOgogICAgICAgICAgICAgICAgICAgICAgICBnbG9iYWxfcXVlcmllcyA9IGdsb2JhbF9wYXJhbXMucXVlcmllcwogICAgICAgICAgICAgICAgICAgIGlmIG5vdCBVdGlsQ2xpZW50LmlzX3Vuc2V0KGdsb2JhbF9wYXJhbXMuaGVhZGVycyk6CiAgICAgICAgICAgICAgICAgICAgICAgIGdsb2JhbF9oZWFkZXJzID0gZ2xvYmFsX3BhcmFtcy5oZWFkZXJzCiAgICAgICAgICAgICAgICBfcmVxdWVzdC5oZWFkZXJzID0gVGVhQ29yZS5tZXJnZSh7CiAgICAgICAgICAgICAgICAgICAgJ2RhdGUnOiBVdGlsQ2xpZW50LmdldF9kYXRlX3V0Y3N0cmluZygpLAogICAgICAgICAgICAgICAgICAgICdob3N0Jzogc2VsZi5fZW5kcG9pbnQsCiAgICAgICAgICAgICAgICAgICAgJ2FjY2VwdCc6ICdhcHBsaWNhdGlvbi9qc29uJywKICAgICAgICAgICAgICAgICAgICAneC1hY3Mtc2lnbmF0dXJlLW5vbmNlJzogVXRpbENsaWVudC5nZXRfbm9uY2UoKSwKICAgICAgICAgICAgICAgICAgICAneC1hY3Mtc2lnbmF0dXJlLW1ldGhvZCc6ICdITUFDLVNIQTEnLAogICAgICAgICAgICAgICAgICAgICd4LWFjcy1zaWduYXR1cmUtdmVyc2lvbic6ICcxLjAnLAogICAgICAgICAgICAgICAgICAgICd4LWFjcy12ZXJzaW9uJzogdmVyc2lvbiwKICAgICAgICAgICAgICAgICAgICAneC1hY3MtYWN0aW9uJzogYWN0aW9uLAogICAgICAgICAgICAgICAgICAgICd1c2VyLWFnZW50JzogVXRpbENsaWVudC5nZXRfdXNlcl9hZ2VudChzZWxmLl91c2VyX2FnZW50KQogICAgICAgICAgICAgICAgfSwgZ2xvYmFsX2hlYWRlcnMsCiAgICAgICAgICAgICAgICAgICAgcmVxdWVzdC5oZWFkZXJzKQogICAgICAgICAgICAgICAgaWYgbm90IFV0aWxDbGllbnQuaXNfdW5zZXQocmVxdWVzdC5ib2R5KToKICAgICAgICAgICAgICAgICAgICBfcmVxdWVzdC5ib2R5ID0gVXRpbENsaWVudC50b19qc29uc3RyaW5nKHJlcXVlc3QuYm9keSkKICAgICAgICAgICAgICAgICAgICBfcmVxdWVzdC5oZWFkZXJzWydjb250ZW50LXR5cGUnXSA9ICdhcHBsaWNhdGlvbi9qc29uOyBjaGFyc2V0PXV0Zi04JwogICAgICAgICAgICAgICAgX3JlcXVlc3QucXVlcnkgPSBnbG9iYWxfcXVlcmllcwogICAgICAgICAgICAgICAgaWYgbm90IFV0aWxDbGllbnQuaXNfdW5zZXQocmVxdWVzdC5xdWVyeSk6CiAgICAgICAgICAgICAgICAgICAgX3JlcXVlc3QucXVlcnkgPSBUZWFDb3JlLm1lcmdlKF9yZXF1ZXN0LnF1ZXJ5LAogICAgICAgICAgICAgICAgICAgICAgICByZXF1ZXN0LnF1ZXJ5KQogICAgICAgICAgICAgICAgaWYgbm90IFV0aWxDbGllbnQuZXF1YWxfc3RyaW5nKGF1dGhfdHlwZSwgJ0Fub255bW91cycpOgogICAgICAgICAgICAgICAgICAgIGFjY2Vzc19rZXlfaWQgPSBzZWxmLmdldF9hY2Nlc3Nfa2V5X2lkKCkKICAgICAgICAgICAgICAgICAgICBhY2Nlc3Nfa2V5X3NlY3JldCA9IHNlbGYuZ2V0X2FjY2Vzc19rZXlfc2VjcmV0KCkKICAgICAgICAgICAgICAgICAgICBzZWN1cml0eV90b2tlbiA9IHNlbGYuZ2V0X3NlY3VyaXR5X3Rva2VuKCkKICAgICAgICAgICAgICAgICAgICBpZiBub3QgVXRpbENsaWVudC5lbXB0eShzZWN1cml0eV90b2tlbik6CiAgICAgICAgICAgICAgICAgICAgICAgIF9yZXF1ZXN0LmhlYWRlcnNbJ3gtYWNzLWFjY2Vzc2tleS1pZCddID0gYWNjZXNzX2tleV9pZAogICAgICAgICAgICAgICAgICAgICAgICBfcmVxdWVzdC5oZWFkZXJzWyd4LWFjcy1zZWN1cml0eS10b2tlbiddID0gc2VjdXJpdHlfdG9rZW4KICAgICAgICAgICAgICAgICAgICBzdHJpbmdfdG9fc2lnbiA9IE9wZW5BcGlVdGlsQ2xpZW50LmdldF9zdHJpbmdfdG9fc2lnbihfcmVxdWVzdCkKICAgICAgICAgICAgICAgICAgICBfcmVxdWVzdC5oZWFkZXJzWydhdXRob3JpemF0aW9uJ10gPSBmJ2FjcyB7YWNjZXNzX2tleV9pZH06e09wZW5BcGlVdGlsQ2xpZW50LmdldF9yb2FzaWduYXR1cmUoc3RyaW5nX3RvX3NpZ24sIGFjY2Vzc19rZXlfc2VjcmV0KX0nCiAgICAgICAgICAgICAgICBfbGFzdF9yZXF1ZXN0ID0gX3JlcXVlc3QKICAgICAgICAgICAgICAgIF9yZXNwb25zZSA9IFRlYUNvcmUuZG9fYWN0aW9uKF9yZXF1ZXN0LCBfcnVudGltZSkKICAgICAgICAgICAgICAgIGlmIFV0aWxDbGllbnQuZXF1YWxfbnVtYmVyKF9yZXNwb25zZS5zdGF0dXNfY29kZSwgMjA0KToKICAgICAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICAgICAgICAnaGVhZGVycyc6IF9yZXNwb25zZS5oZWFkZXJzCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgVXRpbENsaWVudC5pc180eHgoX3Jlc3BvbnNlLnN0YXR1c19jb2RlKSBvciBVdGlsQ2xpZW50LmlzXzV4eChfcmVzcG9uc2Uuc3RhdHVzX2NvZGUpOgogICAgICAgICAgICAgICAgICAgIF9yZXMgPSBVdGlsQ2xpZW50LnJlYWRfYXNfanNvbihfcmVzcG9uc2UuYm9keSkKICAgICAgICAgICAgICAgICAgICBlcnIgPSBVdGlsQ2xpZW50LmFzc2VydF9hc19tYXAoX3JlcykKICAgICAgICAgICAgICAgICAgICByZXF1ZXN0X2lkID0gc2VsZi5kZWZhdWx0X2FueShlcnIuZ2V0KCdSZXF1ZXN0SWQnKSwgZXJyLmdldCgncmVxdWVzdElkJykpCiAgICAgICAgICAgICAgICAgICAgcmVxdWVzdF9pZCA9IHNlbGYuZGVmYXVsdF9hbnkocmVxdWVzdF9pZCwgZXJyLmdldCgncmVxdWVzdGlkJykpCiAgICAgICAgICAgICAgICAgICAgZXJyWydzdGF0dXNDb2RlJ10gPSBfcmVzcG9uc2Uuc3RhdHVzX2NvZGUKICAgICAgICAgICAgICAgICAgICByYWlzZSBUZWFFeGNlcHRpb24oewogICAgICAgICAgICAgICAgICAgICAgICAnY29kZSc6IGYie3NlbGYuZGVmYXVsdF9hbnkoZXJyLmdldCgnQ29kZScpLCBlcnIuZ2V0KCdjb2RlJykpfSIsCiAgICAgICAgICAgICAgICAgICAgICAgICdtZXNzYWdlJzogZiJjb2RlOiB7X3Jlc3BvbnNlLnN0YXR1c19jb2RlfSwge3NlbGYuZGVmYXVsdF9hbnkoZXJyLmdldCgnTWVzc2FnZScpLCBlcnIuZ2V0KCdtZXNzYWdlJykpfSByZXF1ZXN0IGlkOiB7cmVxdWVzdF9pZH0iLAogICAgICAgICAgICAgICAgICAgICAgICAnZGF0YSc6IGVyciwKICAgICAgICAgICAgICAgICAgICAgICAgJ2Rlc2NyaXB0aW9uJzogZiJ7c2VsZi5kZWZhdWx0X2FueShlcnIuZ2V0KCdEZXNjcmlwdGlvbicpLCBlcnIuZ2V0KCdkZXNjcmlwdGlvbicpKX0iLAogICAgICAgICAgICAgICAgICAgICAgICAnYWNjZXNzRGVuaWVkRGV0YWlsJzogc2VsZi5kZWZhdWx0X2FueShlcnIuZ2V0KCdBY2Nlc3NEZW5pZWREZXRhaWwnKSwgZXJyLmdldCgnYWNjZXNzRGVuaWVkRGV0YWlsJykpCiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIGlmIFV0aWxDbGllbnQuZXF1YWxfc3RyaW5nKGJvZHlfdHlwZSwgJ2JpbmFyeScpOgogICAgICAgICAgICAgICAgICAgIHJlc3AgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICdib2R5JzogX3Jlc3BvbnNlLmJvZHksCiAgICAgICAgICAgICAgICAgICAgICAgICdoZWFkZXJzJzogX3Jlc3BvbnNlLmhlYWRlcnMsCiAgICAgICAgICAgICAgICAgICAgICAgICdzdGF0dXNDb2RlJzogX3Jlc3BvbnNlLnN0YXR1c19jb2RlCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJldHVybiByZXNwCiAgICAgICAgICAgICAgICBlbGlmIFV0aWxDbGllbnQuZXF1YWxfc3RyaW5nKGJvZHlfdHlwZSwgJ2J5dGUnKToKICAgICAgICAgICAgICAgICAgICBieXQgPSBVdGlsQ2xpZW50LnJlYWRfYXNfYnl0ZXMoX3Jlc3BvbnNlLmJvZHkpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgICAgICAgJ2JvZHknOiBieXQsCiAgICAgICAgICAgICAgICAgICAgICAgICdoZWFkZXJzJzogX3Jlc3BvbnNlLmhlYWRlcnMsCiAgICAgICAgICAgICAgICAgICAgICAgICdzdGF0dXNDb2RlJzogX3Jlc3BvbnNlLnN0YXR1c19jb2RlCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxpZiBVdGlsQ2xpZW50LmVxdWFsX3N0cmluZyhib2R5X3R5cGUsICdzdHJpbmcnKToKICAgICAgICAgICAgICAgICAgICBzdHIgPSBVdGlsQ2xpZW50LnJlYWRfYXNfc3RyaW5nKF9yZXNwb25zZS5ib2R5KQogICAgICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgICAgICAgICdib2R5Jzogc3RyLAogICAgICAgICAgICAgICAgICAgICAgICAnaGVhZGVycyc6IF9yZXNwb25zZS5oZWFkZXJzLAogICAgICAgICAgICAgICAgICAgICAgICAnc3RhdHVzQ29kZSc6IF9yZXNwb25zZS5zdGF0dXNfY29kZQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsaWYgVXRpbENsaWVudC5lcXVhbF9zdHJpbmcoYm9keV90eXBlLCAnanNvbicpOgogICAgICAgICAgICAgICAgICAgIG9iaiA9IFV0aWxDbGllbnQucmVhZF9hc19qc29uKF9yZXNwb25zZS5ib2R5KQogICAgICAgICAgICAgICAgICAgIHJlcyA9IFV0aWxDbGllbnQuYXNzZXJ0X2FzX21hcChvYmopCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgICAgICAgJ2JvZHknOiByZXMsCiAgICAgICAgICAgICAgICAgICAgICAgICdoZWFkZXJzJzogX3Jlc3BvbnNlLmhlYWRlcnMsCiAgICAgICAgICAgICAgICAgICAgICAgICdzdGF0dXNDb2RlJzogX3Jlc3BvbnNlLnN0YXR1c19jb2RlCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxpZiBVdGlsQ2xpZW50LmVxdWFsX3N0cmluZyhib2R5X3R5cGUsICdhcnJheScpOgogICAgICAgICAgICAgICAgICAgIGFyciA9IFV0aWxDbGllbnQucmVhZF9hc19qc29uKF9yZXNwb25zZS5ib2R5KQogICAgICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgICAgICAgICdib2R5JzogYXJyLAogICAgICAgICAgICAgICAgICAgICAgICAnaGVhZGVycyc6IF9yZXNwb25zZS5oZWFkZXJzLAogICAgICAgICAgICAgICAgICAgICAgICAnc3RhdHVzQ29kZSc6IF9yZXNwb25zZS5zdGF0dXNfY29kZQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgICAgICAgJ2hlYWRlcnMnOiBfcmVzcG9uc2UuaGVhZGVycywKICAgICAgICAgICAgICAgICAgICAgICAgJ3N0YXR1c0NvZGUnOiBfcmVzcG9uc2Uuc3RhdHVzX2NvZGUKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgIGlmIFRlYUNvcmUuaXNfcmV0cnlhYmxlKGUpOgogICAgICAgICAgICAgICAgICAgIF9sYXN0X2V4Y2VwdGlvbiA9IGUKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgcmFpc2UgZQogICAgICAgIHJhaXNlIFVucmV0cnlhYmxlRXhjZXB0aW9uKF9sYXN0X3JlcXVlc3QsIF9sYXN0X2V4Y2VwdGlvbikKCiAgICBhc3luYyBkZWYgZG9fcm9hcmVxdWVzdF9hc3luYygKICAgICAgICBzZWxmLAogICAgICAgIGFjdGlvbjogc3RyLAogICAgICAgIHZlcnNpb246IHN0ciwKICAgICAgICBwcm90b2NvbDogc3RyLAogICAgICAgIG1ldGhvZDogc3RyLAogICAgICAgIGF1dGhfdHlwZTogc3RyLAogICAgICAgIHBhdGhuYW1lOiBzdHIsCiAgICAgICAgYm9keV90eXBlOiBzdHIsCiAgICAgICAgcmVxdWVzdDogb3Blbl9hcGlfbW9kZWxzLk9wZW5BcGlSZXF1ZXN0LAogICAgICAgIHJ1bnRpbWU6IHV0aWxfbW9kZWxzLlJ1bnRpbWVPcHRpb25zLAogICAgKSAtPiBkaWN0OgogICAgICAgICIiIgogICAgICAgIEVuY2Fwc3VsYXRlIHRoZSByZXF1ZXN0IGFuZCBpbnZva2UgdGhlIG5ldHdvcmsKICAgICAgICBAcGFyYW0gYWN0aW9uOiBhcGkgbmFtZQogICAgICAgIEBwYXJhbSB2ZXJzaW9uOiBwcm9kdWN0IHZlcnNpb24KICAgICAgICBAcGFyYW0gcHJvdG9jb2w6IGh0dHAgb3IgaHR0cHMKICAgICAgICBAcGFyYW0gbWV0aG9kOiBlLmcuIEdFVAogICAgICAgIEBwYXJhbSBhdXRoX3R5cGU6IGF1dGhvcml6YXRpb24gdHlwZSBlLmcuIEFLCiAgICAgICAgQHBhcmFtIHBhdGhuYW1lOiBwYXRobmFtZSBvZiBldmVyeSBhcGkKICAgICAgICBAcGFyYW0gYm9keV90eXBlOiByZXNwb25zZSBib2R5IHR5cGUgZS5nLiBTdHJpbmcKICAgICAgICBAcGFyYW0gcmVxdWVzdDogb2JqZWN0IG9mIE9wZW5BcGlSZXF1ZXN0CiAgICAgICAgQHBhcmFtIHJ1bnRpbWU6IHdoaWNoIGNvbnRyb2xzIHNvbWUgZGV0YWlscyBvZiBjYWxsIGFwaSwgc3VjaCBhcyByZXRyeSB0aW1lcwogICAgICAgIEByZXR1cm46IHRoZSByZXNwb25zZQogICAgICAgICIiIgogICAgICAgIHJlcXVlc3QudmFsaWRhdGUoKQogICAgICAgIHJ1bnRpbWUudmFsaWRhdGUoKQogICAgICAgIF9ydW50aW1lID0gewogICAgICAgICAgICAndGltZW91dGVkJzogJ3JldHJ5JywKICAgICAgICAgICAgJ2tleSc6IFV0aWxDbGllbnQuZGVmYXVsdF9zdHJpbmcocnVudGltZS5rZXksIHNlbGYuX2tleSksCiAgICAgICAgICAgICdjZXJ0JzogVXRpbENsaWVudC5kZWZhdWx0X3N0cmluZyhydW50aW1lLmNlcnQsIHNlbGYuX2NlcnQpLAogICAgICAgICAgICAnY2EnOiBVdGlsQ2xpZW50LmRlZmF1bHRfc3RyaW5nKHJ1bnRpbWUuY2EsIHNlbGYuX2NhKSwKICAgICAgICAgICAgJ3JlYWRUaW1lb3V0JzogVXRpbENsaWVudC5kZWZhdWx0X251bWJlcihydW50aW1lLnJlYWRfdGltZW91dCwgc2VsZi5fcmVhZF90aW1lb3V0KSwKICAgICAgICAgICAgJ2Nvbm5lY3RUaW1lb3V0JzogVXRpbENsaWVudC5kZWZhdWx0X251bWJlcihydW50aW1lLmNvbm5lY3RfdGltZW91dCwgc2VsZi5fY29ubmVjdF90aW1lb3V0KSwKICAgICAgICAgICAgJ2h0dHBQcm94eSc6IFV0aWxDbGllbnQuZGVmYXVsdF9zdHJpbmcocnVudGltZS5odHRwX3Byb3h5LCBzZWxmLl9odHRwX3Byb3h5KSwKICAgICAgICAgICAgJ2h0dHBzUHJveHknOiBVdGlsQ2xpZW50LmRlZmF1bHRfc3RyaW5nKHJ1bnRpbWUuaHR0cHNfcHJveHksIHNlbGYuX2h0dHBzX3Byb3h5KSwKICAgICAgICAgICAgJ25vUHJveHknOiBVdGlsQ2xpZW50LmRlZmF1bHRfc3RyaW5nKHJ1bnRpbWUubm9fcHJveHksIHNlbGYuX25vX3Byb3h5KSwKICAgICAgICAgICAgJ3NvY2tzNVByb3h5JzogVXRpbENsaWVudC5kZWZhdWx0X3N0cmluZyhydW50aW1lLnNvY2tzXzVwcm94eSwgc2VsZi5fc29ja3NfNXByb3h5KSwKICAgICAgICAgICAgJ3NvY2tzNU5ldFdvcmsnOiBVdGlsQ2xpZW50LmRlZmF1bHRfc3RyaW5nKHJ1bnRpbWUuc29ja3NfNW5ldF93b3JrLCBzZWxmLl9zb2Nrc181bmV0X3dvcmspLAogICAgICAgICAgICAnbWF4SWRsZUNvbm5zJzogVXRpbENsaWVudC5kZWZhdWx0X251bWJlcihydW50aW1lLm1heF9pZGxlX2Nvbm5zLCBzZWxmLl9tYXhfaWRsZV9jb25ucyksCiAgICAgICAgICAgICdyZXRyeSc6IHsKICAgICAgICAgICAgICAgICdyZXRyeWFibGUnOiBydW50aW1lLmF1dG9yZXRyeSwKICAgICAgICAgICAgICAgICdtYXhBdHRlbXB0cyc6IFV0aWxDbGllbnQuZGVmYXVsdF9udW1iZXIocnVudGltZS5tYXhfYXR0ZW1wdHMsIDMpCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICdiYWNrb2ZmJzogewogICAgICAgICAgICAgICAgJ3BvbGljeSc6IFV0aWxDbGllbnQuZGVmYXVsdF9zdHJpbmcocnVudGltZS5iYWNrb2ZmX3BvbGljeSwgJ25vJyksCiAgICAgICAgICAgICAgICAncGVyaW9kJzogVXRpbENsaWVudC5kZWZhdWx0X251bWJlcihydW50aW1lLmJhY2tvZmZfcGVyaW9kLCAxKQogICAgICAgICAgICB9LAogICAgICAgICAgICAnaWdub3JlU1NMJzogcnVudGltZS5pZ25vcmVfc3NsCiAgICAgICAgfQogICAgICAgIF9sYXN0X3JlcXVlc3QgPSBOb25lCiAgICAgICAgX2xhc3RfZXhjZXB0aW9uID0gTm9uZQogICAgICAgIF9ub3cgPSB0aW1lLnRpbWUoKQogICAgICAgIF9yZXRyeV90aW1lcyA9IDAKICAgICAgICB3aGlsZSBUZWFDb3JlLmFsbG93X3JldHJ5KF9ydW50aW1lLmdldCgncmV0cnknKSwgX3JldHJ5X3RpbWVzLCBfbm93KToKICAgICAgICAgICAgaWYgX3JldHJ5X3RpbWVzID4gMDoKICAgICAgICAgICAgICAgIF9iYWNrb2ZmX3RpbWUgPSBUZWFDb3JlLmdldF9iYWNrb2ZmX3RpbWUoX3J1bnRpbWUuZ2V0KCdiYWNrb2ZmJyksIF9yZXRyeV90aW1lcykKICAgICAgICAgICAgICAgIGlmIF9iYWNrb2ZmX3RpbWUgPiAwOgogICAgICAgICAgICAgICAgICAgIFRlYUNvcmUuc2xlZXAoX2JhY2tvZmZfdGltZSkKICAgICAgICAgICAgX3JldHJ5X3RpbWVzID0gX3JldHJ5X3RpbWVzICsgMQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBfcmVxdWVzdCA9IFRlYVJlcXVlc3QoKQogICAgICAgICAgICAgICAgX3JlcXVlc3QucHJvdG9jb2wgPSBVdGlsQ2xpZW50LmRlZmF1bHRfc3RyaW5nKHNlbGYuX3Byb3RvY29sLCBwcm90b2NvbCkKICAgICAgICAgICAgICAgIF9yZXF1ZXN0Lm1ldGhvZCA9IG1ldGhvZAogICAgICAgICAgICAgICAgX3JlcXVlc3QucGF0aG5hbWUgPSBwYXRobmFtZQogICAgICAgICAgICAgICAgZ2xvYmFsX3F1ZXJpZXMgPSB7fQogICAgICAgICAgICAgICAgZ2xvYmFsX2hlYWRlcnMgPSB7fQogICAgICAgICAgICAgICAgaWYgbm90IFV0aWxDbGllbnQuaXNfdW5zZXQoc2VsZi5fZ2xvYmFsX3BhcmFtZXRlcnMpOgogICAgICAgICAgICAgICAgICAgIGdsb2JhbF9wYXJhbXMgPSBzZWxmLl9nbG9iYWxfcGFyYW1ldGVycwogICAgICAgICAgICAgICAgICAgIGlmIG5vdCBVdGlsQ2xpZW50LmlzX3Vuc2V0KGdsb2JhbF9wYXJhbXMucXVlcmllcyk6CiAgICAgICAgICAgICAgICAgICAgICAgIGdsb2JhbF9xdWVyaWVzID0gZ2xvYmFsX3BhcmFtcy5xdWVyaWVzCiAgICAgICAgICAgICAgICAgICAgaWYgbm90IFV0aWxDbGllbnQuaXNfdW5zZXQoZ2xvYmFsX3BhcmFtcy5oZWFkZXJzKToKICAgICAgICAgICAgICAgICAgICAgICAgZ2xvYmFsX2hlYWRlcnMgPSBnbG9iYWxfcGFyYW1zLmhlYWRlcnMKICAgICAgICAgICAgICAgIF9yZXF1ZXN0LmhlYWRlcnMgPSBUZWFDb3JlLm1lcmdlKHsKICAgICAgICAgICAgICAgICAgICAnZGF0ZSc6IFV0aWxDbGllbnQuZ2V0X2RhdGVfdXRjc3RyaW5nKCksCiAgICAgICAgICAgICAgICAgICAgJ2hvc3QnOiBzZWxmLl9lbmRwb2ludCwKICAgICAgICAgICAgICAgICAgICAnYWNjZXB0JzogJ2FwcGxpY2F0aW9uL2pzb24nLAogICAgICAgICAgICAgICAgICAgICd4LWFjcy1zaWduYXR1cmUtbm9uY2UnOiBVdGlsQ2xpZW50LmdldF9ub25jZSgpLAogICAgICAgICAgICAgICAgICAgICd4LWFjcy1zaWduYXR1cmUtbWV0aG9kJzogJ0hNQUMtU0hBMScsCiAgICAgICAgICAgICAgICAgICAgJ3gtYWNzLXNpZ25hdHVyZS12ZXJzaW9uJzogJzEuMCcsCiAgICAgICAgICAgICAgICAgICAgJ3gtYWNzLXZlcnNpb24nOiB2ZXJzaW9uLAogICAgICAgICAgICAgICAgICAgICd4LWFjcy1hY3Rpb24nOiBhY3Rpb24sCiAgICAgICAgICAgICAgICAgICAgJ3VzZXItYWdlbnQnOiBVdGlsQ2xpZW50LmdldF91c2VyX2FnZW50KHNlbGYuX3VzZXJfYWdlbnQpCiAgICAgICAgICAgICAgICB9LCBnbG9iYWxfaGVhZGVycywKICAgICAgICAgICAgICAgICAgICByZXF1ZXN0LmhlYWRlcnMpCiAgICAgICAgICAgICAgICBpZiBub3QgVXRpbENsaWVudC5pc191bnNldChyZXF1ZXN0LmJvZHkpOgogICAgICAgICAgICAgICAgICAgIF9yZXF1ZXN0LmJvZHkgPSBVdGlsQ2xpZW50LnRvX2pzb25zdHJpbmcocmVxdWVzdC5ib2R5KQogICAgICAgICAgICAgICAgICAgIF9yZXF1ZXN0LmhlYWRlcnNbJ2NvbnRlbnQtdHlwZSddID0gJ2FwcGxpY2F0aW9uL2pzb247IGNoYXJzZXQ9dXRmLTgnCiAgICAgICAgICAgICAgICBfcmVxdWVzdC5xdWVyeSA9IGdsb2JhbF9xdWVyaWVzCiAgICAgICAgICAgICAgICBpZiBub3QgVXRpbENsaWVudC5pc191bnNldChyZXF1ZXN0LnF1ZXJ5KToKICAgICAgICAgICAgICAgICAgICBfcmVxdWVzdC5xdWVyeSA9IFRlYUNvcmUubWVyZ2UoX3JlcXVlc3QucXVlcnksCiAgICAgICAgICAgICAgICAgICAgICAgIHJlcXVlc3QucXVlcnkpCiAgICAgICAgICAgICAgICBpZiBub3QgVXRpbENsaWVudC5lcXVhbF9zdHJpbmcoYXV0aF90eXBlLCAnQW5vbnltb3VzJyk6CiAgICAgICAgICAgICAgICAgICAgYWNjZXNzX2tleV9pZCA9IGF3YWl0IHNlbGYuZ2V0X2FjY2Vzc19rZXlfaWRfYXN5bmMoKQogICAgICAgICAgICAgICAgICAgIGFjY2Vzc19rZXlfc2VjcmV0ID0gYXdhaXQgc2VsZi5nZXRfYWNjZXNzX2tleV9zZWNyZXRfYXN5bmMoKQogICAgICAgICAgICAgICAgICAgIHNlY3VyaXR5X3Rva2VuID0gYXdhaXQgc2VsZi5nZXRfc2VjdXJpdHlfdG9rZW5fYXN5bmMoKQogICAgICAgICAgICAgICAgICAgIGlmIG5vdCBVdGlsQ2xpZW50LmVtcHR5KHNlY3VyaXR5X3Rva2VuKToKICAgICAgICAgICAgICAgICAgICAgICAgX3JlcXVlc3QuaGVhZGVyc1sneC1hY3MtYWNjZXNza2V5LWlkJ10gPSBhY2Nlc3Nfa2V5X2lkCiAgICAgICAgICAgICAgICAgICAgICAgIF9yZXF1ZXN0LmhlYWRlcnNbJ3gtYWNzLXNlY3VyaXR5LXRva2VuJ10gPSBzZWN1cml0eV90b2tlbgogICAgICAgICAgICAgICAgICAgIHN0cmluZ190b19zaWduID0gT3BlbkFwaVV0aWxDbGllbnQuZ2V0X3N0cmluZ190b19zaWduKF9yZXF1ZXN0KQogICAgICAgICAgICAgICAgICAgIF9yZXF1ZXN0LmhlYWRlcnNbJ2F1dGhvcml6YXRpb24nXSA9IGYnYWNzIHthY2Nlc3Nfa2V5X2lkfTp7T3BlbkFwaVV0aWxDbGllbnQuZ2V0X3JvYXNpZ25hdHVyZShzdHJpbmdfdG9fc2lnbiwgYWNjZXNzX2tleV9zZWNyZXQpfScKICAgICAgICAgICAgICAgIF9sYXN0X3JlcXVlc3QgPSBfcmVxdWVzdAogICAgICAgICAgICAgICAgX3Jlc3BvbnNlID0gYXdhaXQgVGVhQ29yZS5hc3luY19kb19hY3Rpb24oX3JlcXVlc3QsIF9ydW50aW1lKQogICAgICAgICAgICAgICAgaWYgVXRpbENsaWVudC5lcXVhbF9udW1iZXIoX3Jlc3BvbnNlLnN0YXR1c19jb2RlLCAyMDQpOgogICAgICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgICAgICAgICdoZWFkZXJzJzogX3Jlc3BvbnNlLmhlYWRlcnMKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiBVdGlsQ2xpZW50LmlzXzR4eChfcmVzcG9uc2Uuc3RhdHVzX2NvZGUpIG9yIFV0aWxDbGllbnQuaXNfNXh4KF9yZXNwb25zZS5zdGF0dXNfY29kZSk6CiAgICAgICAgICAgICAgICAgICAgX3JlcyA9IGF3YWl0IFV0aWxDbGllbnQucmVhZF9hc19qc29uX2FzeW5jKF9yZXNwb25zZS5ib2R5KQogICAgICAgICAgICAgICAgICAgIGVyciA9IFV0aWxDbGllbnQuYXNzZXJ0X2FzX21hcChfcmVzKQogICAgICAgICAgICAgICAgICAgIHJlcXVlc3RfaWQgPSBzZWxmLmRlZmF1bHRfYW55KGVyci5nZXQoJ1JlcXVlc3RJZCcpLCBlcnIuZ2V0KCdyZXF1ZXN0SWQnKSkKICAgICAgICAgICAgICAgICAgICByZXF1ZXN0X2lkID0gc2VsZi5kZWZhdWx0X2FueShyZXF1ZXN0X2lkLCBlcnIuZ2V0KCdyZXF1ZXN0aWQnKSkKICAgICAgICAgICAgICAgICAgICBlcnJbJ3N0YXR1c0NvZGUnXSA9IF9yZXNwb25zZS5zdGF0dXNfY29kZQogICAgICAgICAgICAgICAgICAgIHJhaXNlIFRlYUV4Y2VwdGlvbih7CiAgICAgICAgICAgICAgICAgICAgICAgICdjb2RlJzogZiJ7c2VsZi5kZWZhdWx0X2FueShlcnIuZ2V0KCdDb2RlJyksIGVyci5nZXQoJ2NvZGUnKSl9IiwKICAgICAgICAgICAgICAgICAgICAgICAgJ21lc3NhZ2UnOiBmImNvZGU6IHtfcmVzcG9uc2Uuc3RhdHVzX2NvZGV9LCB7c2VsZi5kZWZhdWx0X2FueShlcnIuZ2V0KCdNZXNzYWdlJyksIGVyci5nZXQoJ21lc3NhZ2UnKSl9IHJlcXVlc3QgaWQ6IHtyZXF1ZXN0X2lkfSIsCiAgICAgICAgICAgICAgICAgICAgICAgICdkYXRhJzogZXJyLAogICAgICAgICAgICAgICAgICAgICAgICAnZGVzY3JpcHRpb24nOiBmIntzZWxmLmRlZmF1bHRfYW55KGVyci5nZXQoJ0Rlc2NyaXB0aW9uJyksIGVyci5nZXQoJ2Rlc2NyaXB0aW9uJykpfSIsCiAgICAgICAgICAgICAgICAgICAgICAgICdhY2Nlc3NEZW5pZWREZXRhaWwnOiBzZWxmLmRlZmF1bHRfYW55KGVyci5nZXQoJ0FjY2Vzc0RlbmllZERldGFpbCcpLCBlcnIuZ2V0KCdhY2Nlc3NEZW5pZWREZXRhaWwnKSkKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgaWYgVXRpbENsaWVudC5lcXVhbF9zdHJpbmcoYm9keV90eXBlLCAnYmluYXJ5Jyk6CiAgICAgICAgICAgICAgICAgICAgcmVzcCA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgJ2JvZHknOiBfcmVzcG9uc2UuYm9keSwKICAgICAgICAgICAgICAgICAgICAgICAgJ2hlYWRlcnMnOiBfcmVzcG9uc2UuaGVhZGVycywKICAgICAgICAgICAgICAgICAgICAgICAgJ3N0YXR1c0NvZGUnOiBfcmVzcG9uc2Uuc3RhdHVzX2NvZGUKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3AKICAgICAgICAgICAgICAgIGVsaWYgVXRpbENsaWVudC5lcXVhbF9zdHJpbmcoYm9keV90eXBlLCAnYnl0ZScpOgogICAgICAgICAgICAgICAgICAgIGJ5dCA9IGF3YWl0IFV0aWxDbGllbnQucmVhZF9hc19ieXRlc19hc3luYyhfcmVzcG9uc2UuYm9keSkKICAgICAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICAgICAgICAnYm9keSc6IGJ5dCwKICAgICAgICAgICAgICAgICAgICAgICAgJ2hlYWRlcnMnOiBfcmVzcG9uc2UuaGVhZGVycywKICAgICAgICAgICAgICAgICAgICAgICAgJ3N0YXR1c0NvZGUnOiBfcmVzcG9uc2Uuc3RhdHVzX2NvZGUKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbGlmIFV0aWxDbGllbnQuZXF1YWxfc3RyaW5nKGJvZHlfdHlwZSwgJ3N0cmluZycpOgogICAgICAgICAgICAgICAgICAgIHN0ciA9IGF3YWl0IFV0aWxDbGllbnQucmVhZF9hc19zdHJpbmdfYXN5bmMoX3Jlc3BvbnNlLmJvZHkpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgICAgICAgJ2JvZHknOiBzdHIsCiAgICAgICAgICAgICAgICAgICAgICAgICdoZWFkZXJzJzogX3Jlc3BvbnNlLmhlYWRlcnMsCiAgICAgICAgICAgICAgICAgICAgICAgICdzdGF0dXNDb2RlJzogX3Jlc3BvbnNlLnN0YXR1c19jb2RlCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxpZiBVdGlsQ2xpZW50LmVxdWFsX3N0cmluZyhib2R5X3R5cGUsICdqc29uJyk6CiAgICAgICAgICAgICAgICAgICAgb2JqID0gYXdhaXQgVXRpbENsaWVudC5yZWFkX2FzX2pzb25fYXN5bmMoX3Jlc3BvbnNlLmJvZHkpCiAgICAgICAgICAgICAgICAgICAgcmVzID0gVXRpbENsaWVudC5hc3NlcnRfYXNfbWFwKG9iaikKICAgICAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICAgICAgICAnYm9keSc6IHJlcywKICAgICAgICAgICAgICAgICAgICAgICAgJ2hlYWRlcnMnOiBfcmVzcG9uc2UuaGVhZGVycywKICAgICAgICAgICAgICAgICAgICAgICAgJ3N0YXR1c0NvZGUnOiBfcmVzcG9uc2Uuc3RhdHVzX2NvZGUKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbGlmIFV0aWxDbGllbnQuZXF1YWxfc3RyaW5nKGJvZHlfdHlwZSwgJ2FycmF5Jyk6CiAgICAgICAgICAgICAgICAgICAgYXJyID0gYXdhaXQgVXRpbENsaWVudC5yZWFkX2FzX2pzb25fYXN5bmMoX3Jlc3BvbnNlLmJvZHkpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgICAgICAgJ2JvZHknOiBhcnIsCiAgICAgICAgICAgICAgICAgICAgICAgICdoZWFkZXJzJzogX3Jlc3BvbnNlLmhlYWRlcnMsCiAgICAgICAgICAgICAgICAgICAgICAgICdzdGF0dXNDb2RlJzogX3Jlc3BvbnNlLnN0YXR1c19jb2RlCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICAgICAgICAnaGVhZGVycyc6IF9yZXNwb25zZS5oZWFkZXJzLAogICAgICAgICAgICAgICAgICAgICAgICAnc3RhdHVzQ29kZSc6IF9yZXNwb25zZS5zdGF0dXNfY29kZQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgaWYgVGVhQ29yZS5pc19yZXRyeWFibGUoZSk6CiAgICAgICAgICAgICAgICAgICAgX2xhc3RfZXhjZXB0aW9uID0gZQogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICByYWlzZSBlCiAgICAgICAgcmFpc2UgVW5yZXRyeWFibGVFeGNlcHRpb24oX2xhc3RfcmVxdWVzdCwgX2xhc3RfZXhjZXB0aW9uKQoKICAgIGRlZiBkb19yb2FyZXF1ZXN0X3dpdGhfZm9ybSgKICAgICAgICBzZWxmLAogICAgICAgIGFjdGlvbjogc3RyLAogICAgICAgIHZlcnNpb246IHN0ciwKICAgICAgICBwcm90b2NvbDogc3RyLAogICAgICAgIG1ldGhvZDogc3RyLAogICAgICAgIGF1dGhfdHlwZTogc3RyLAogICAgICAgIHBhdGhuYW1lOiBzdHIsCiAgICAgICAgYm9keV90eXBlOiBzdHIsCiAgICAgICAgcmVxdWVzdDogb3Blbl9hcGlfbW9kZWxzLk9wZW5BcGlSZXF1ZXN0LAogICAgICAgIHJ1bnRpbWU6IHV0aWxfbW9kZWxzLlJ1bnRpbWVPcHRpb25zLAogICAgKSAtPiBkaWN0OgogICAgICAgICIiIgogICAgICAgIEVuY2Fwc3VsYXRlIHRoZSByZXF1ZXN0IGFuZCBpbnZva2UgdGhlIG5ldHdvcmsgd2l0aCBmb3JtIGJvZHkKICAgICAgICBAcGFyYW0gYWN0aW9uOiBhcGkgbmFtZQogICAgICAgIEBwYXJhbSB2ZXJzaW9uOiBwcm9kdWN0IHZlcnNpb24KICAgICAgICBAcGFyYW0gcHJvdG9jb2w6IGh0dHAgb3IgaHR0cHMKICAgICAgICBAcGFyYW0gbWV0aG9kOiBlLmcuIEdFVAogICAgICAgIEBwYXJhbSBhdXRoX3R5cGU6IGF1dGhvcml6YXRpb24gdHlwZSBlLmcuIEFLCiAgICAgICAgQHBhcmFtIHBhdGhuYW1lOiBwYXRobmFtZSBvZiBldmVyeSBhcGkKICAgICAgICBAcGFyYW0gYm9keV90eXBlOiByZXNwb25zZSBib2R5IHR5cGUgZS5nLiBTdHJpbmcKICAgICAgICBAcGFyYW0gcmVxdWVzdDogb2JqZWN0IG9mIE9wZW5BcGlSZXF1ZXN0CiAgICAgICAgQHBhcmFtIHJ1bnRpbWU6IHdoaWNoIGNvbnRyb2xzIHNvbWUgZGV0YWlscyBvZiBjYWxsIGFwaSwgc3VjaCBhcyByZXRyeSB0aW1lcwogICAgICAgIEByZXR1cm46IHRoZSByZXNwb25zZQogICAgICAgICIiIgogICAgICAgIHJlcXVlc3QudmFsaWRhdGUoKQogICAgICAgIHJ1bnRpbWUudmFsaWRhdGUoKQogICAgICAgIF9ydW50aW1lID0gewogICAgICAgICAgICAndGltZW91dGVkJzogJ3JldHJ5JywKICAgICAgICAgICAgJ2tleSc6IFV0aWxDbGllbnQuZGVmYXVsdF9zdHJpbmcocnVudGltZS5rZXksIHNlbGYuX2tleSksCiAgICAgICAgICAgICdjZXJ0JzogVXRpbENsaWVudC5kZWZhdWx0X3N0cmluZyhydW50aW1lLmNlcnQsIHNlbGYuX2NlcnQpLAogICAgICAgICAgICAnY2EnOiBVdGlsQ2xpZW50LmRlZmF1bHRfc3RyaW5nKHJ1bnRpbWUuY2EsIHNlbGYuX2NhKSwKICAgICAgICAgICAgJ3JlYWRUaW1lb3V0JzogVXRpbENsaWVudC5kZWZhdWx0X251bWJlcihydW50aW1lLnJlYWRfdGltZW91dCwgc2VsZi5fcmVhZF90aW1lb3V0KSwKICAgICAgICAgICAgJ2Nvbm5lY3RUaW1lb3V0JzogVXRpbENsaWVudC5kZWZhdWx0X251bWJlcihydW50aW1lLmNvbm5lY3RfdGltZW91dCwgc2VsZi5fY29ubmVjdF90aW1lb3V0KSwKICAgICAgICAgICAgJ2h0dHBQcm94eSc6IFV0aWxDbGllbnQuZGVmYXVsdF9zdHJpbmcocnVudGltZS5odHRwX3Byb3h5LCBzZWxmLl9odHRwX3Byb3h5KSwKICAgICAgICAgICAgJ2h0dHBzUHJveHknOiBVdGlsQ2xpZW50LmRlZmF1bHRfc3RyaW5nKHJ1bnRpbWUuaHR0cHNfcHJveHksIHNlbGYuX2h0dHBzX3Byb3h5KSwKICAgICAgICAgICAgJ25vUHJveHknOiBVdGlsQ2xpZW50LmRlZmF1bHRfc3RyaW5nKHJ1bnRpbWUubm9fcHJveHksIHNlbGYuX25vX3Byb3h5KSwKICAgICAgICAgICAgJ3NvY2tzNVByb3h5JzogVXRpbENsaWVudC5kZWZhdWx0X3N0cmluZyhydW50aW1lLnNvY2tzXzVwcm94eSwgc2VsZi5fc29ja3NfNXByb3h5KSwKICAgICAgICAgICAgJ3NvY2tzNU5ldFdvcmsnOiBVdGlsQ2xpZW50LmRlZmF1bHRfc3RyaW5nKHJ1bnRpbWUuc29ja3NfNW5ldF93b3JrLCBzZWxmLl9zb2Nrc181bmV0X3dvcmspLAogICAgICAgICAgICAnbWF4SWRsZUNvbm5zJzogVXRpbENsaWVudC5kZWZhdWx0X251bWJlcihydW50aW1lLm1heF9pZGxlX2Nvbm5zLCBzZWxmLl9tYXhfaWRsZV9jb25ucyksCiAgICAgICAgICAgICdyZXRyeSc6IHsKICAgICAgICAgICAgICAgICdyZXRyeWFibGUnOiBydW50aW1lLmF1dG9yZXRyeSwKICAgICAgICAgICAgICAgICdtYXhBdHRlbXB0cyc6IFV0aWxDbGllbnQuZGVmYXVsdF9udW1iZXIocnVudGltZS5tYXhfYXR0ZW1wdHMsIDMpCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICdiYWNrb2ZmJzogewogICAgICAgICAgICAgICAgJ3BvbGljeSc6IFV0aWxDbGllbnQuZGVmYXVsdF9zdHJpbmcocnVudGltZS5iYWNrb2ZmX3BvbGljeSwgJ25vJyksCiAgICAgICAgICAgICAgICAncGVyaW9kJzogVXRpbENsaWVudC5kZWZhdWx0X251bWJlcihydW50aW1lLmJhY2tvZmZfcGVyaW9kLCAxKQogICAgICAgICAgICB9LAogICAgICAgICAgICAnaWdub3JlU1NMJzogcnVudGltZS5pZ25vcmVfc3NsCiAgICAgICAgfQogICAgICAgIF9sYXN0X3JlcXVlc3QgPSBOb25lCiAgICAgICAgX2xhc3RfZXhjZXB0aW9uID0gTm9uZQogICAgICAgIF9ub3cgPSB0aW1lLnRpbWUoKQogICAgICAgIF9yZXRyeV90aW1lcyA9IDAKICAgICAgICB3aGlsZSBUZWFDb3JlLmFsbG93X3JldHJ5KF9ydW50aW1lLmdldCgncmV0cnknKSwgX3JldHJ5X3RpbWVzLCBfbm93KToKICAgICAgICAgICAgaWYgX3JldHJ5X3RpbWVzID4gMDoKICAgICAgICAgICAgICAgIF9iYWNrb2ZmX3RpbWUgPSBUZWFDb3JlLmdldF9iYWNrb2ZmX3RpbWUoX3J1bnRpbWUuZ2V0KCdiYWNrb2ZmJyksIF9yZXRyeV90aW1lcykKICAgICAgICAgICAgICAgIGlmIF9iYWNrb2ZmX3RpbWUgPiAwOgogICAgICAgICAgICAgICAgICAgIFRlYUNvcmUuc2xlZXAoX2JhY2tvZmZfdGltZSkKICAgICAgICAgICAgX3JldHJ5X3RpbWVzID0gX3JldHJ5X3RpbWVzICsgMQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBfcmVxdWVzdCA9IFRlYVJlcXVlc3QoKQogICAgICAgICAgICAgICAgX3JlcXVlc3QucHJvdG9jb2wgPSBVdGlsQ2xpZW50LmRlZmF1bHRfc3RyaW5nKHNlbGYuX3Byb3RvY29sLCBwcm90b2NvbCkKICAgICAgICAgICAgICAgIF9yZXF1ZXN0Lm1ldGhvZCA9IG1ldGhvZAogICAgICAgICAgICAgICAgX3JlcXVlc3QucGF0aG5hbWUgPSBwYXRobmFtZQogICAgICAgICAgICAgICAgZ2xvYmFsX3F1ZXJpZXMgPSB7fQogICAgICAgICAgICAgICAgZ2xvYmFsX2hlYWRlcnMgPSB7fQogICAgICAgICAgICAgICAgaWYgbm90IFV0aWxDbGllbnQuaXNfdW5zZXQoc2VsZi5fZ2xvYmFsX3BhcmFtZXRlcnMpOgogICAgICAgICAgICAgICAgICAgIGdsb2JhbF9wYXJhbXMgPSBzZWxmLl9nbG9iYWxfcGFyYW1ldGVycwogICAgICAgICAgICAgICAgICAgIGlmIG5vdCBVdGlsQ2xpZW50LmlzX3Vuc2V0KGdsb2JhbF9wYXJhbXMucXVlcmllcyk6CiAgICAgICAgICAgICAgICAgICAgICAgIGdsb2JhbF9xdWVyaWVzID0gZ2xvYmFsX3BhcmFtcy5xdWVyaWVzCiAgICAgICAgICAgICAgICAgICAgaWYgbm90IFV0aWxDbGllbnQuaXNfdW5zZXQoZ2xvYmFsX3BhcmFtcy5oZWFkZXJzKToKICAgICAgICAgICAgICAgICAgICAgICAgZ2xvYmFsX2hlYWRlcnMgPSBnbG9iYWxfcGFyYW1zLmhlYWRlcnMKICAgICAgICAgICAgICAgIF9yZXF1ZXN0LmhlYWRlcnMgPSBUZWFDb3JlLm1lcmdlKHsKICAgICAgICAgICAgICAgICAgICAnZGF0ZSc6IFV0aWxDbGllbnQuZ2V0X2RhdGVfdXRjc3RyaW5nKCksCiAgICAgICAgICAgICAgICAgICAgJ2hvc3QnOiBzZWxmLl9lbmRwb2ludCwKICAgICAgICAgICAgICAgICAgICAnYWNjZXB0JzogJ2FwcGxpY2F0aW9uL2pzb24nLAogICAgICAgICAgICAgICAgICAgICd4LWFjcy1zaWduYXR1cmUtbm9uY2UnOiBVdGlsQ2xpZW50LmdldF9ub25jZSgpLAogICAgICAgICAgICAgICAgICAgICd4LWFjcy1zaWduYXR1cmUtbWV0aG9kJzogJ0hNQUMtU0hBMScsCiAgICAgICAgICAgICAgICAgICAgJ3gtYWNzLXNpZ25hdHVyZS12ZXJzaW9uJzogJzEuMCcsCiAgICAgICAgICAgICAgICAgICAgJ3gtYWNzLXZlcnNpb24nOiB2ZXJzaW9uLAogICAgICAgICAgICAgICAgICAgICd4LWFjcy1hY3Rpb24nOiBhY3Rpb24sCiAgICAgICAgICAgICAgICAgICAgJ3VzZXItYWdlbnQnOiBVdGlsQ2xpZW50LmdldF91c2VyX2FnZW50KHNlbGYuX3VzZXJfYWdlbnQpCiAgICAgICAgICAgICAgICB9LCBnbG9iYWxfaGVhZGVycywKICAgICAgICAgICAgICAgICAgICByZXF1ZXN0LmhlYWRlcnMpCiAgICAgICAgICAgICAgICBpZiBub3QgVXRpbENsaWVudC5pc191bnNldChyZXF1ZXN0LmJvZHkpOgogICAgICAgICAgICAgICAgICAgIG0gPSBVdGlsQ2xpZW50LmFzc2VydF9hc19tYXAocmVxdWVzdC5ib2R5KQogICAgICAgICAgICAgICAgICAgIF9yZXF1ZXN0LmJvZHkgPSBPcGVuQXBpVXRpbENsaWVudC50b19mb3JtKG0pCiAgICAgICAgICAgICAgICAgICAgX3JlcXVlc3QuaGVhZGVyc1snY29udGVudC10eXBlJ10gPSAnYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkJwogICAgICAgICAgICAgICAgX3JlcXVlc3QucXVlcnkgPSBnbG9iYWxfcXVlcmllcwogICAgICAgICAgICAgICAgaWYgbm90IFV0aWxDbGllbnQuaXNfdW5zZXQocmVxdWVzdC5xdWVyeSk6CiAgICAgICAgICAgICAgICAgICAgX3JlcXVlc3QucXVlcnkgPSBUZWFDb3JlLm1lcmdlKF9yZXF1ZXN0LnF1ZXJ5LAogICAgICAgICAgICAgICAgICAgICAgICByZXF1ZXN0LnF1ZXJ5KQogICAgICAgICAgICAgICAgaWYgbm90IFV0aWxDbGllbnQuZXF1YWxfc3RyaW5nKGF1dGhfdHlwZSwgJ0Fub255bW91cycpOgogICAgICAgICAgICAgICAgICAgIGFjY2Vzc19rZXlfaWQgPSBzZWxmLmdldF9hY2Nlc3Nfa2V5X2lkKCkKICAgICAgICAgICAgICAgICAgICBhY2Nlc3Nfa2V5X3NlY3JldCA9IHNlbGYuZ2V0X2FjY2Vzc19rZXlfc2VjcmV0KCkKICAgICAgICAgICAgICAgICAgICBzZWN1cml0eV90b2tlbiA9IHNlbGYuZ2V0X3NlY3VyaXR5X3Rva2VuKCkKICAgICAgICAgICAgICAgICAgICBpZiBub3QgVXRpbENsaWVudC5lbXB0eShzZWN1cml0eV90b2tlbik6CiAgICAgICAgICAgICAgICAgICAgICAgIF9yZXF1ZXN0LmhlYWRlcnNbJ3gtYWNzLWFjY2Vzc2tleS1pZCddID0gYWNjZXNzX2tleV9pZAogICAgICAgICAgICAgICAgICAgICAgICBfcmVxdWVzdC5oZWFkZXJzWyd4LWFjcy1zZWN1cml0eS10b2tlbiddID0gc2VjdXJpdHlfdG9rZW4KICAgICAgICAgICAgICAgICAgICBzdHJpbmdfdG9fc2lnbiA9IE9wZW5BcGlVdGlsQ2xpZW50LmdldF9zdHJpbmdfdG9fc2lnbihfcmVxdWVzdCkKICAgICAgICAgICAgICAgICAgICBfcmVxdWVzdC5oZWFkZXJzWydhdXRob3JpemF0aW9uJ10gPSBmJ2FjcyB7YWNjZXNzX2tleV9pZH06e09wZW5BcGlVdGlsQ2xpZW50LmdldF9yb2FzaWduYXR1cmUoc3RyaW5nX3RvX3NpZ24sIGFjY2Vzc19rZXlfc2VjcmV0KX0nCiAgICAgICAgICAgICAgICBfbGFzdF9yZXF1ZXN0ID0gX3JlcXVlc3QKICAgICAgICAgICAgICAgIF9yZXNwb25zZSA9IFRlYUNvcmUuZG9fYWN0aW9uKF9yZXF1ZXN0LCBfcnVudGltZSkKICAgICAgICAgICAgICAgIGlmIFV0aWxDbGllbnQuZXF1YWxfbnVtYmVyKF9yZXNwb25zZS5zdGF0dXNfY29kZSwgMjA0KToKICAgICAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICAgICAgICAnaGVhZGVycyc6IF9yZXNwb25zZS5oZWFkZXJzCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgVXRpbENsaWVudC5pc180eHgoX3Jlc3BvbnNlLnN0YXR1c19jb2RlKSBvciBVdGlsQ2xpZW50LmlzXzV4eChfcmVzcG9uc2Uuc3RhdHVzX2NvZGUpOgogICAgICAgICAgICAgICAgICAgIF9yZXMgPSBVdGlsQ2xpZW50LnJlYWRfYXNfanNvbihfcmVzcG9uc2UuYm9keSkKICAgICAgICAgICAgICAgICAgICBlcnIgPSBVdGlsQ2xpZW50LmFzc2VydF9hc19tYXAoX3JlcykKICAgICAgICAgICAgICAgICAgICBlcnJbJ3N0YXR1c0NvZGUnXSA9IF9yZXNwb25zZS5zdGF0dXNfY29kZQogICAgICAgICAgICAgICAgICAgIHJhaXNlIFRlYUV4Y2VwdGlvbih7CiAgICAgICAgICAgICAgICAgICAgICAgICdjb2RlJzogZiJ7c2VsZi5kZWZhdWx0X2FueShlcnIuZ2V0KCdDb2RlJyksIGVyci5nZXQoJ2NvZGUnKSl9IiwKICAgICAgICAgICAgICAgICAgICAgICAgJ21lc3NhZ2UnOiBmImNvZGU6IHtfcmVzcG9uc2Uuc3RhdHVzX2NvZGV9LCB7c2VsZi5kZWZhdWx0X2FueShlcnIuZ2V0KCdNZXNzYWdlJyksIGVyci5nZXQoJ21lc3NhZ2UnKSl9IHJlcXVlc3QgaWQ6IHtzZWxmLmRlZmF1bHRfYW55KGVyci5nZXQoJ1JlcXVlc3RJZCcpLCBlcnIuZ2V0KCdyZXF1ZXN0SWQnKSl9IiwKICAgICAgICAgICAgICAgICAgICAgICAgJ2RhdGEnOiBlcnIsCiAgICAgICAgICAgICAgICAgICAgICAgICdkZXNjcmlwdGlvbic6IGYie3NlbGYuZGVmYXVsdF9hbnkoZXJyLmdldCgnRGVzY3JpcHRpb24nKSwgZXJyLmdldCgnZGVzY3JpcHRpb24nKSl9IiwKICAgICAgICAgICAgICAgICAgICAgICAgJ2FjY2Vzc0RlbmllZERldGFpbCc6IHNlbGYuZGVmYXVsdF9hbnkoZXJyLmdldCgnQWNjZXNzRGVuaWVkRGV0YWlsJyksIGVyci5nZXQoJ2FjY2Vzc0RlbmllZERldGFpbCcpKQogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICBpZiBVdGlsQ2xpZW50LmVxdWFsX3N0cmluZyhib2R5X3R5cGUsICdiaW5hcnknKToKICAgICAgICAgICAgICAgICAgICByZXNwID0gewogICAgICAgICAgICAgICAgICAgICAgICAnYm9keSc6IF9yZXNwb25zZS5ib2R5LAogICAgICAgICAgICAgICAgICAgICAgICAnaGVhZGVycyc6IF9yZXNwb25zZS5oZWFkZXJzLAogICAgICAgICAgICAgICAgICAgICAgICAnc3RhdHVzQ29kZSc6IF9yZXNwb25zZS5zdGF0dXNfY29kZQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzcAogICAgICAgICAgICAgICAgZWxpZiBVdGlsQ2xpZW50LmVxdWFsX3N0cmluZyhib2R5X3R5cGUsICdieXRlJyk6CiAgICAgICAgICAgICAgICAgICAgYnl0ID0gVXRpbENsaWVudC5yZWFkX2FzX2J5dGVzKF9yZXNwb25zZS5ib2R5KQogICAgICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgICAgICAgICdib2R5JzogYnl0LAogICAgICAgICAgICAgICAgICAgICAgICAnaGVhZGVycyc6IF9yZXNwb25zZS5oZWFkZXJzLAogICAgICAgICAgICAgICAgICAgICAgICAnc3RhdHVzQ29kZSc6IF9yZXNwb25zZS5zdGF0dXNfY29kZQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsaWYgVXRpbENsaWVudC5lcXVhbF9zdHJpbmcoYm9keV90eXBlLCAnc3RyaW5nJyk6CiAgICAgICAgICAgICAgICAgICAgc3RyID0gVXRpbENsaWVudC5yZWFkX2FzX3N0cmluZyhfcmVzcG9uc2UuYm9keSkKICAgICAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICAgICAgICAnYm9keSc6IHN0ciwKICAgICAgICAgICAgICAgICAgICAgICAgJ2hlYWRlcnMnOiBfcmVzcG9uc2UuaGVhZGVycywKICAgICAgICAgICAgICAgICAgICAgICAgJ3N0YXR1c0NvZGUnOiBfcmVzcG9uc2Uuc3RhdHVzX2NvZGUKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbGlmIFV0aWxDbGllbnQuZXF1YWxfc3RyaW5nKGJvZHlfdHlwZSwgJ2pzb24nKToKICAgICAgICAgICAgICAgICAgICBvYmogPSBVdGlsQ2xpZW50LnJlYWRfYXNfanNvbihfcmVzcG9uc2UuYm9keSkKICAgICAgICAgICAgICAgICAgICByZXMgPSBVdGlsQ2xpZW50LmFzc2VydF9hc19tYXAob2JqKQogICAgICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgICAgICAgICdib2R5JzogcmVzLAogICAgICAgICAgICAgICAgICAgICAgICAnaGVhZGVycyc6IF9yZXNwb25zZS5oZWFkZXJzLAogICAgICAgICAgICAgICAgICAgICAgICAnc3RhdHVzQ29kZSc6IF9yZXNwb25zZS5zdGF0dXNfY29kZQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsaWYgVXRpbENsaWVudC5lcXVhbF9zdHJpbmcoYm9keV90eXBlLCAnYXJyYXknKToKICAgICAgICAgICAgICAgICAgICBhcnIgPSBVdGlsQ2xpZW50LnJlYWRfYXNfanNvbihfcmVzcG9uc2UuYm9keSkKICAgICAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICAgICAgICAnYm9keSc6IGFyciwKICAgICAgICAgICAgICAgICAgICAgICAgJ2hlYWRlcnMnOiBfcmVzcG9uc2UuaGVhZGVycywKICAgICAgICAgICAgICAgICAgICAgICAgJ3N0YXR1c0NvZGUnOiBfcmVzcG9uc2Uuc3RhdHVzX2NvZGUKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgICAgICAgICdoZWFkZXJzJzogX3Jlc3BvbnNlLmhlYWRlcnMsCiAgICAgICAgICAgICAgICAgICAgICAgICdzdGF0dXNDb2RlJzogX3Jlc3BvbnNlLnN0YXR1c19jb2RlCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICBpZiBUZWFDb3JlLmlzX3JldHJ5YWJsZShlKToKICAgICAgICAgICAgICAgICAgICBfbGFzdF9leGNlcHRpb24gPSBlCiAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgIHJhaXNlIGUKICAgICAgICByYWlzZSBVbnJldHJ5YWJsZUV4Y2VwdGlvbihfbGFzdF9yZXF1ZXN0LCBfbGFzdF9leGNlcHRpb24pCgogICAgYXN5bmMgZGVmIGRvX3JvYXJlcXVlc3Rfd2l0aF9mb3JtX2FzeW5jKAogICAgICAgIHNlbGYsCiAgICAgICAgYWN0aW9uOiBzdHIsCiAgICAgICAgdmVyc2lvbjogc3RyLAogICAgICAgIHByb3RvY29sOiBzdHIsCiAgICAgICAgbWV0aG9kOiBzdHIsCiAgICAgICAgYXV0aF90eXBlOiBzdHIsCiAgICAgICAgcGF0aG5hbWU6IHN0ciwKICAgICAgICBib2R5X3R5cGU6IHN0ciwKICAgICAgICByZXF1ZXN0OiBvcGVuX2FwaV9tb2RlbHMuT3BlbkFwaVJlcXVlc3QsCiAgICAgICAgcnVudGltZTogdXRpbF9tb2RlbHMuUnVudGltZU9wdGlvbnMsCiAgICApIC0+IGRpY3Q6CiAgICAgICAgIiIiCiAgICAgICAgRW5jYXBzdWxhdGUgdGhlIHJlcXVlc3QgYW5kIGludm9rZSB0aGUgbmV0d29yayB3aXRoIGZvcm0gYm9keQogICAgICAgIEBwYXJhbSBhY3Rpb246IGFwaSBuYW1lCiAgICAgICAgQHBhcmFtIHZlcnNpb246IHByb2R1Y3QgdmVyc2lvbgogICAgICAgIEBwYXJhbSBwcm90b2NvbDogaHR0cCBvciBodHRwcwogICAgICAgIEBwYXJhbSBtZXRob2Q6IGUuZy4gR0VUCiAgICAgICAgQHBhcmFtIGF1dGhfdHlwZTogYXV0aG9yaXphdGlvbiB0eXBlIGUuZy4gQUsKICAgICAgICBAcGFyYW0gcGF0aG5hbWU6IHBhdGhuYW1lIG9mIGV2ZXJ5IGFwaQogICAgICAgIEBwYXJhbSBib2R5X3R5cGU6IHJlc3BvbnNlIGJvZHkgdHlwZSBlLmcuIFN0cmluZwogICAgICAgIEBwYXJhbSByZXF1ZXN0OiBvYmplY3Qgb2YgT3BlbkFwaVJlcXVlc3QKICAgICAgICBAcGFyYW0gcnVudGltZTogd2hpY2ggY29udHJvbHMgc29tZSBkZXRhaWxzIG9mIGNhbGwgYXBpLCBzdWNoIGFzIHJldHJ5IHRpbWVzCiAgICAgICAgQHJldHVybjogdGhlIHJlc3BvbnNlCiAgICAgICAgIiIiCiAgICAgICAgcmVxdWVzdC52YWxpZGF0ZSgpCiAgICAgICAgcnVudGltZS52YWxpZGF0ZSgpCiAgICAgICAgX3J1bnRpbWUgPSB7CiAgICAgICAgICAgICd0aW1lb3V0ZWQnOiAncmV0cnknLAogICAgICAgICAgICAna2V5JzogVXRpbENsaWVudC5kZWZhdWx0X3N0cmluZyhydW50aW1lLmtleSwgc2VsZi5fa2V5KSwKICAgICAgICAgICAgJ2NlcnQnOiBVdGlsQ2xpZW50LmRlZmF1bHRfc3RyaW5nKHJ1bnRpbWUuY2VydCwgc2VsZi5fY2VydCksCiAgICAgICAgICAgICdjYSc6IFV0aWxDbGllbnQuZGVmYXVsdF9zdHJpbmcocnVudGltZS5jYSwgc2VsZi5fY2EpLAogICAgICAgICAgICAncmVhZFRpbWVvdXQnOiBVdGlsQ2xpZW50LmRlZmF1bHRfbnVtYmVyKHJ1bnRpbWUucmVhZF90aW1lb3V0LCBzZWxmLl9yZWFkX3RpbWVvdXQpLAogICAgICAgICAgICAnY29ubmVjdFRpbWVvdXQnOiBVdGlsQ2xpZW50LmRlZmF1bHRfbnVtYmVyKHJ1bnRpbWUuY29ubmVjdF90aW1lb3V0LCBzZWxmLl9jb25uZWN0X3RpbWVvdXQpLAogICAgICAgICAgICAnaHR0cFByb3h5JzogVXRpbENsaWVudC5kZWZhdWx0X3N0cmluZyhydW50aW1lLmh0dHBfcHJveHksIHNlbGYuX2h0dHBfcHJveHkpLAogICAgICAgICAgICAnaHR0cHNQcm94eSc6IFV0aWxDbGllbnQuZGVmYXVsdF9zdHJpbmcocnVudGltZS5odHRwc19wcm94eSwgc2VsZi5faHR0cHNfcHJveHkpLAogICAgICAgICAgICAnbm9Qcm94eSc6IFV0aWxDbGllbnQuZGVmYXVsdF9zdHJpbmcocnVudGltZS5ub19wcm94eSwgc2VsZi5fbm9fcHJveHkpLAogICAgICAgICAgICAnc29ja3M1UHJveHknOiBVdGlsQ2xpZW50LmRlZmF1bHRfc3RyaW5nKHJ1bnRpbWUuc29ja3NfNXByb3h5LCBzZWxmLl9zb2Nrc181cHJveHkpLAogICAgICAgICAgICAnc29ja3M1TmV0V29yayc6IFV0aWxDbGllbnQuZGVmYXVsdF9zdHJpbmcocnVudGltZS5zb2Nrc181bmV0X3dvcmssIHNlbGYuX3NvY2tzXzVuZXRfd29yayksCiAgICAgICAgICAgICdtYXhJZGxlQ29ubnMnOiBVdGlsQ2xpZW50LmRlZmF1bHRfbnVtYmVyKHJ1bnRpbWUubWF4X2lkbGVfY29ubnMsIHNlbGYuX21heF9pZGxlX2Nvbm5zKSwKICAgICAgICAgICAgJ3JldHJ5JzogewogICAgICAgICAgICAgICAgJ3JldHJ5YWJsZSc6IHJ1bnRpbWUuYXV0b3JldHJ5LAogICAgICAgICAgICAgICAgJ21heEF0dGVtcHRzJzogVXRpbENsaWVudC5kZWZhdWx0X251bWJlcihydW50aW1lLm1heF9hdHRlbXB0cywgMykKICAgICAgICAgICAgfSwKICAgICAgICAgICAgJ2JhY2tvZmYnOiB7CiAgICAgICAgICAgICAgICAncG9saWN5JzogVXRpbENsaWVudC5kZWZhdWx0X3N0cmluZyhydW50aW1lLmJhY2tvZmZfcG9saWN5LCAnbm8nKSwKICAgICAgICAgICAgICAgICdwZXJpb2QnOiBVdGlsQ2xpZW50LmRlZmF1bHRfbnVtYmVyKHJ1bnRpbWUuYmFja29mZl9wZXJpb2QsIDEpCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICdpZ25vcmVTU0wnOiBydW50aW1lLmlnbm9yZV9zc2wKICAgICAgICB9CiAgICAgICAgX2xhc3RfcmVxdWVzdCA9IE5vbmUKICAgICAgICBfbGFzdF9leGNlcHRpb24gPSBOb25lCiAgICAgICAgX25vdyA9IHRpbWUudGltZSgpCiAgICAgICAgX3JldHJ5X3RpbWVzID0gMAogICAgICAgIHdoaWxlIFRlYUNvcmUuYWxsb3dfcmV0cnkoX3J1bnRpbWUuZ2V0KCdyZXRyeScpLCBfcmV0cnlfdGltZXMsIF9ub3cpOgogICAgICAgICAgICBpZiBfcmV0cnlfdGltZXMgPiAwOgogICAgICAgICAgICAgICAgX2JhY2tvZmZfdGltZSA9IFRlYUNvcmUuZ2V0X2JhY2tvZmZfdGltZShfcnVudGltZS5nZXQoJ2JhY2tvZmYnKSwgX3JldHJ5X3RpbWVzKQogICAgICAgICAgICAgICAgaWYgX2JhY2tvZmZfdGltZSA+IDA6CiAgICAgICAgICAgICAgICAgICAgVGVhQ29yZS5zbGVlcChfYmFja29mZl90aW1lKQogICAgICAgICAgICBfcmV0cnlfdGltZXMgPSBfcmV0cnlfdGltZXMgKyAxCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIF9yZXF1ZXN0ID0gVGVhUmVxdWVzdCgpCiAgICAgICAgICAgICAgICBfcmVxdWVzdC5wcm90b2NvbCA9IFV0aWxDbGllbnQuZGVmYXVsdF9zdHJpbmcoc2VsZi5fcHJvdG9jb2wsIHByb3RvY29sKQogICAgICAgICAgICAgICAgX3JlcXVlc3QubWV0aG9kID0gbWV0aG9kCiAgICAgICAgICAgICAgICBfcmVxdWVzdC5wYXRobmFtZSA9IHBhdGhuYW1lCiAgICAgICAgICAgICAgICBnbG9iYWxfcXVlcmllcyA9IHt9CiAgICAgICAgICAgICAgICBnbG9iYWxfaGVhZGVycyA9IHt9CiAgICAgICAgICAgICAgICBpZiBub3QgVXRpbENsaWVudC5pc191bnNldChzZWxmLl9nbG9iYWxfcGFyYW1ldGVycyk6CiAgICAgICAgICAgICAgICAgICAgZ2xvYmFsX3BhcmFtcyA9IHNlbGYuX2dsb2JhbF9wYXJhbWV0ZXJzCiAgICAgICAgICAgICAgICAgICAgaWYgbm90IFV0aWxDbGllbnQuaXNfdW5zZXQoZ2xvYmFsX3BhcmFtcy5xdWVyaWVzKToKICAgICAgICAgICAgICAgICAgICAgICAgZ2xvYmFsX3F1ZXJpZXMgPSBnbG9iYWxfcGFyYW1zLnF1ZXJpZXMKICAgICAgICAgICAgICAgICAgICBpZiBub3QgVXRpbENsaWVudC5pc191bnNldChnbG9iYWxfcGFyYW1zLmhlYWRlcnMpOgogICAgICAgICAgICAgICAgICAgICAgICBnbG9iYWxfaGVhZGVycyA9IGdsb2JhbF9wYXJhbXMuaGVhZGVycwogICAgICAgICAgICAgICAgX3JlcXVlc3QuaGVhZGVycyA9IFRlYUNvcmUubWVyZ2UoewogICAgICAgICAgICAgICAgICAgICdkYXRlJzogVXRpbENsaWVudC5nZXRfZGF0ZV91dGNzdHJpbmcoKSwKICAgICAgICAgICAgICAgICAgICAnaG9zdCc6IHNlbGYuX2VuZHBvaW50LAogICAgICAgICAgICAgICAgICAgICdhY2NlcHQnOiAnYXBwbGljYXRpb24vanNvbicsCiAgICAgICAgICAgICAgICAgICAgJ3gtYWNzLXNpZ25hdHVyZS1ub25jZSc6IFV0aWxDbGllbnQuZ2V0X25vbmNlKCksCiAgICAgICAgICAgICAgICAgICAgJ3gtYWNzLXNpZ25hdHVyZS1tZXRob2QnOiAnSE1BQy1TSEExJywKICAgICAgICAgICAgICAgICAgICAneC1hY3Mtc2lnbmF0dXJlLXZlcnNpb24nOiAnMS4wJywKICAgICAgICAgICAgICAgICAgICAneC1hY3MtdmVyc2lvbic6IHZlcnNpb24sCiAgICAgICAgICAgICAgICAgICAgJ3gtYWNzLWFjdGlvbic6IGFjdGlvbiwKICAgICAgICAgICAgICAgICAgICAndXNlci1hZ2VudCc6IFV0aWxDbGllbnQuZ2V0X3VzZXJfYWdlbnQoc2VsZi5fdXNlcl9hZ2VudCkKICAgICAgICAgICAgICAgIH0sIGdsb2JhbF9oZWFkZXJzLAogICAgICAgICAgICAgICAgICAgIHJlcXVlc3QuaGVhZGVycykKICAgICAgICAgICAgICAgIGlmIG5vdCBVdGlsQ2xpZW50LmlzX3Vuc2V0KHJlcXVlc3QuYm9keSk6CiAgICAgICAgICAgICAgICAgICAgbSA9IFV0aWxDbGllbnQuYXNzZXJ0X2FzX21hcChyZXF1ZXN0LmJvZHkpCiAgICAgICAgICAgICAgICAgICAgX3JlcXVlc3QuYm9keSA9IE9wZW5BcGlVdGlsQ2xpZW50LnRvX2Zvcm0obSkKICAgICAgICAgICAgICAgICAgICBfcmVxdWVzdC5oZWFkZXJzWydjb250ZW50LXR5cGUnXSA9ICdhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQnCiAgICAgICAgICAgICAgICBfcmVxdWVzdC5xdWVyeSA9IGdsb2JhbF9xdWVyaWVzCiAgICAgICAgICAgICAgICBpZiBub3QgVXRpbENsaWVudC5pc191bnNldChyZXF1ZXN0LnF1ZXJ5KToKICAgICAgICAgICAgICAgICAgICBfcmVxdWVzdC5xdWVyeSA9IFRlYUNvcmUubWVyZ2UoX3JlcXVlc3QucXVlcnksCiAgICAgICAgICAgICAgICAgICAgICAgIHJlcXVlc3QucXVlcnkpCiAgICAgICAgICAgICAgICBpZiBub3QgVXRpbENsaWVudC5lcXVhbF9zdHJpbmcoYXV0aF90eXBlLCAnQW5vbnltb3VzJyk6CiAgICAgICAgICAgICAgICAgICAgYWNjZXNzX2tleV9pZCA9IGF3YWl0IHNlbGYuZ2V0X2FjY2Vzc19rZXlfaWRfYXN5bmMoKQogICAgICAgICAgICAgICAgICAgIGFjY2Vzc19rZXlfc2VjcmV0ID0gYXdhaXQgc2VsZi5nZXRfYWNjZXNzX2tleV9zZWNyZXRfYXN5bmMoKQogICAgICAgICAgICAgICAgICAgIHNlY3VyaXR5X3Rva2VuID0gYXdhaXQgc2VsZi5nZXRfc2VjdXJpdHlfdG9rZW5fYXN5bmMoKQogICAgICAgICAgICAgICAgICAgIGlmIG5vdCBVdGlsQ2xpZW50LmVtcHR5KHNlY3VyaXR5X3Rva2VuKToKICAgICAgICAgICAgICAgICAgICAgICAgX3JlcXVlc3QuaGVhZGVyc1sneC1hY3MtYWNjZXNza2V5LWlkJ10gPSBhY2Nlc3Nfa2V5X2lkCiAgICAgICAgICAgICAgICAgICAgICAgIF9yZXF1ZXN0LmhlYWRlcnNbJ3gtYWNzLXNlY3VyaXR5LXRva2VuJ10gPSBzZWN1cml0eV90b2tlbgogICAgICAgICAgICAgICAgICAgIHN0cmluZ190b19zaWduID0gT3BlbkFwaVV0aWxDbGllbnQuZ2V0X3N0cmluZ190b19zaWduKF9yZXF1ZXN0KQogICAgICAgICAgICAgICAgICAgIF9yZXF1ZXN0LmhlYWRlcnNbJ2F1dGhvcml6YXRpb24nXSA9IGYnYWNzIHthY2Nlc3Nfa2V5X2lkfTp7T3BlbkFwaVV0aWxDbGllbnQuZ2V0X3JvYXNpZ25hdHVyZShzdHJpbmdfdG9fc2lnbiwgYWNjZXNzX2tleV9zZWNyZXQpfScKICAgICAgICAgICAgICAgIF9sYXN0X3JlcXVlc3QgPSBfcmVxdWVzdAogICAgICAgICAgICAgICAgX3Jlc3BvbnNlID0gYXdhaXQgVGVhQ29yZS5hc3luY19kb19hY3Rpb24oX3JlcXVlc3QsIF9ydW50aW1lKQogICAgICAgICAgICAgICAgaWYgVXRpbENsaWVudC5lcXVhbF9udW1iZXIoX3Jlc3BvbnNlLnN0YXR1c19jb2RlLCAyMDQpOgogICAgICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgICAgICAgICdoZWFkZXJzJzogX3Jlc3BvbnNlLmhlYWRlcnMKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiBVdGlsQ2xpZW50LmlzXzR4eChfcmVzcG9uc2Uuc3RhdHVzX2NvZGUpIG9yIFV0aWxDbGllbnQuaXNfNXh4KF9yZXNwb25zZS5zdGF0dXNfY29kZSk6CiAgICAgICAgICAgICAgICAgICAgX3JlcyA9IGF3YWl0IFV0aWxDbGllbnQucmVhZF9hc19qc29uX2FzeW5jKF9yZXNwb25zZS5ib2R5KQogICAgICAgICAgICAgICAgICAgIGVyciA9IFV0aWxDbGllbnQuYXNzZXJ0X2FzX21hcChfcmVzKQogICAgICAgICAgICAgICAgICAgIGVyclsnc3RhdHVzQ29kZSddID0gX3Jlc3BvbnNlLnN0YXR1c19jb2RlCiAgICAgICAgICAgICAgICAgICAgcmFpc2UgVGVhRXhjZXB0aW9uKHsKICAgICAgICAgICAgICAgICAgICAgICAgJ2NvZGUnOiBmIntzZWxmLmRlZmF1bHRfYW55KGVyci5nZXQoJ0NvZGUnKSwgZXJyLmdldCgnY29kZScpKX0iLAogICAgICAgICAgICAgICAgICAgICAgICAnbWVzc2FnZSc6IGYiY29kZToge19yZXNwb25zZS5zdGF0dXNfY29kZX0sIHtzZWxmLmRlZmF1bHRfYW55KGVyci5nZXQoJ01lc3NhZ2UnKSwgZXJyLmdldCgnbWVzc2FnZScpKX0gcmVxdWVzdCBpZDoge3NlbGYuZGVmYXVsdF9hbnkoZXJyLmdldCgnUmVxdWVzdElkJyksIGVyci5nZXQoJ3JlcXVlc3RJZCcpKX0iLAogICAgICAgICAgICAgICAgICAgICAgICAnZGF0YSc6IGVyciwKICAgICAgICAgICAgICAgICAgICAgICAgJ2Rlc2NyaXB0aW9uJzogZiJ7c2VsZi5kZWZhdWx0X2FueShlcnIuZ2V0KCdEZXNjcmlwdGlvbicpLCBlcnIuZ2V0KCdkZXNjcmlwdGlvbicpKX0iLAogICAgICAgICAgICAgICAgICAgICAgICAnYWNjZXNzRGVuaWVkRGV0YWlsJzogc2VsZi5kZWZhdWx0X2FueShlcnIuZ2V0KCdBY2Nlc3NEZW5pZWREZXRhaWwnKSwgZXJyLmdldCgnYWNjZXNzRGVuaWVkRGV0YWlsJykpCiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIGlmIFV0aWxDbGllbnQuZXF1YWxfc3RyaW5nKGJvZHlfdHlwZSwgJ2JpbmFyeScpOgogICAgICAgICAgICAgICAgICAgIHJlc3AgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICdib2R5JzogX3Jlc3BvbnNlLmJvZHksCiAgICAgICAgICAgICAgICAgICAgICAgICdoZWFkZXJzJzogX3Jlc3BvbnNlLmhlYWRlcnMsCiAgICAgICAgICAgICAgICAgICAgICAgICdzdGF0dXNDb2RlJzogX3Jlc3BvbnNlLnN0YXR1c19jb2RlCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJldHVybiByZXNwCiAgICAgICAgICAgICAgICBlbGlmIFV0aWxDbGllbnQuZXF1YWxfc3RyaW5nKGJvZHlfdHlwZSwgJ2J5dGUnKToKICAgICAgICAgICAgICAgICAgICBieXQgPSBhd2FpdCBVdGlsQ2xpZW50LnJlYWRfYXNfYnl0ZXNfYXN5bmMoX3Jlc3BvbnNlLmJvZHkpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgICAgICAgJ2JvZHknOiBieXQsCiAgICAgICAgICAgICAgICAgICAgICAgICdoZWFkZXJzJzogX3Jlc3BvbnNlLmhlYWRlcnMsCiAgICAgICAgICAgICAgICAgICAgICAgICdzdGF0dXNDb2RlJzogX3Jlc3BvbnNlLnN0YXR1c19jb2RlCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxpZiBVdGlsQ2xpZW50LmVxdWFsX3N0cmluZyhib2R5X3R5cGUsICdzdHJpbmcnKToKICAgICAgICAgICAgICAgICAgICBzdHIgPSBhd2FpdCBVdGlsQ2xpZW50LnJlYWRfYXNfc3RyaW5nX2FzeW5jKF9yZXNwb25zZS5ib2R5KQogICAgICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgICAgICAgICdib2R5Jzogc3RyLAogICAgICAgICAgICAgICAgICAgICAgICAnaGVhZGVycyc6IF9yZXNwb25zZS5oZWFkZXJzLAogICAgICAgICAgICAgICAgICAgICAgICAnc3RhdHVzQ29kZSc6IF9yZXNwb25zZS5zdGF0dXNfY29kZQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsaWYgVXRpbENsaWVudC5lcXVhbF9zdHJpbmcoYm9keV90eXBlLCAnanNvbicpOgogICAgICAgICAgICAgICAgICAgIG9iaiA9IGF3YWl0IFV0aWxDbGllbnQucmVhZF9hc19qc29uX2FzeW5jKF9yZXNwb25zZS5ib2R5KQogICAgICAgICAgICAgICAgICAgIHJlcyA9IFV0aWxDbGllbnQuYXNzZXJ0X2FzX21hcChvYmopCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgICAgICAgJ2JvZHknOiByZXMsCiAgICAgICAgICAgICAgICAgICAgICAgICdoZWFkZXJzJzogX3Jlc3BvbnNlLmhlYWRlcnMsCiAgICAgICAgICAgICAgICAgICAgICAgICdzdGF0dXNDb2RlJzogX3Jlc3BvbnNlLnN0YXR1c19jb2RlCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxpZiBVdGlsQ2xpZW50LmVxdWFsX3N0cmluZyhib2R5X3R5cGUsICdhcnJheScpOgogICAgICAgICAgICAgICAgICAgIGFyciA9IGF3YWl0IFV0aWxDbGllbnQucmVhZF9hc19qc29uX2FzeW5jKF9yZXNwb25zZS5ib2R5KQogICAgICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgICAgICAgICdib2R5JzogYXJyLAogICAgICAgICAgICAgICAgICAgICAgICAnaGVhZGVycyc6IF9yZXNwb25zZS5oZWFkZXJzLAogICAgICAgICAgICAgICAgICAgICAgICAnc3RhdHVzQ29kZSc6IF9yZXNwb25zZS5zdGF0dXNfY29kZQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgICAgICAgJ2hlYWRlcnMnOiBfcmVzcG9uc2UuaGVhZGVycywKICAgICAgICAgICAgICAgICAgICAgICAgJ3N0YXR1c0NvZGUnOiBfcmVzcG9uc2Uuc3RhdHVzX2NvZGUKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgIGlmIFRlYUNvcmUuaXNfcmV0cnlhYmxlKGUpOgogICAgICAgICAgICAgICAgICAgIF9sYXN0X2V4Y2VwdGlvbiA9IGUKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgcmFpc2UgZQogICAgICAgIHJhaXNlIFVucmV0cnlhYmxlRXhjZXB0aW9uKF9sYXN0X3JlcXVlc3QsIF9sYXN0X2V4Y2VwdGlvbikKCiAgICBkZWYgZG9fcmVxdWVzdCgKICAgICAgICBzZWxmLAogICAgICAgIHBhcmFtczogb3Blbl9hcGlfbW9kZWxzLlBhcmFtcywKICAgICAgICByZXF1ZXN0OiBvcGVuX2FwaV9tb2RlbHMuT3BlbkFwaVJlcXVlc3QsCiAgICAgICAgcnVudGltZTogdXRpbF9tb2RlbHMuUnVudGltZU9wdGlvbnMsCiAgICApIC0+IGRpY3Q6CiAgICAgICAgIiIiCiAgICAgICAgRW5jYXBzdWxhdGUgdGhlIHJlcXVlc3QgYW5kIGludm9rZSB0aGUgbmV0d29yawogICAgICAgIEBwYXJhbSBhY3Rpb246IGFwaSBuYW1lCiAgICAgICAgQHBhcmFtIHZlcnNpb246IHByb2R1Y3QgdmVyc2lvbgogICAgICAgIEBwYXJhbSBwcm90b2NvbDogaHR0cCBvciBodHRwcwogICAgICAgIEBwYXJhbSBtZXRob2Q6IGUuZy4gR0VUCiAgICAgICAgQHBhcmFtIGF1dGhfdHlwZTogYXV0aG9yaXphdGlvbiB0eXBlIGUuZy4gQUsKICAgICAgICBAcGFyYW0gYm9keV90eXBlOiByZXNwb25zZSBib2R5IHR5cGUgZS5nLiBTdHJpbmcKICAgICAgICBAcGFyYW0gcmVxdWVzdDogb2JqZWN0IG9mIE9wZW5BcGlSZXF1ZXN0CiAgICAgICAgQHBhcmFtIHJ1bnRpbWU6IHdoaWNoIGNvbnRyb2xzIHNvbWUgZGV0YWlscyBvZiBjYWxsIGFwaSwgc3VjaCBhcyByZXRyeSB0aW1lcwogICAgICAgIEByZXR1cm46IHRoZSByZXNwb25zZQogICAgICAgICIiIgogICAgICAgIHBhcmFtcy52YWxpZGF0ZSgpCiAgICAgICAgcmVxdWVzdC52YWxpZGF0ZSgpCiAgICAgICAgcnVudGltZS52YWxpZGF0ZSgpCiAgICAgICAgX3J1bnRpbWUgPSB7CiAgICAgICAgICAgICd0aW1lb3V0ZWQnOiAncmV0cnknLAogICAgICAgICAgICAna2V5JzogVXRpbENsaWVudC5kZWZhdWx0X3N0cmluZyhydW50aW1lLmtleSwgc2VsZi5fa2V5KSwKICAgICAgICAgICAgJ2NlcnQnOiBVdGlsQ2xpZW50LmRlZmF1bHRfc3RyaW5nKHJ1bnRpbWUuY2VydCwgc2VsZi5fY2VydCksCiAgICAgICAgICAgICdjYSc6IFV0aWxDbGllbnQuZGVmYXVsdF9zdHJpbmcocnVudGltZS5jYSwgc2VsZi5fY2EpLAogICAgICAgICAgICAncmVhZFRpbWVvdXQnOiBVdGlsQ2xpZW50LmRlZmF1bHRfbnVtYmVyKHJ1bnRpbWUucmVhZF90aW1lb3V0LCBzZWxmLl9yZWFkX3RpbWVvdXQpLAogICAgICAgICAgICAnY29ubmVjdFRpbWVvdXQnOiBVdGlsQ2xpZW50LmRlZmF1bHRfbnVtYmVyKHJ1bnRpbWUuY29ubmVjdF90aW1lb3V0LCBzZWxmLl9jb25uZWN0X3RpbWVvdXQpLAogICAgICAgICAgICAnaHR0cFByb3h5JzogVXRpbENsaWVudC5kZWZhdWx0X3N0cmluZyhydW50aW1lLmh0dHBfcHJveHksIHNlbGYuX2h0dHBfcHJveHkpLAogICAgICAgICAgICAnaHR0cHNQcm94eSc6IFV0aWxDbGllbnQuZGVmYXVsdF9zdHJpbmcocnVudGltZS5odHRwc19wcm94eSwgc2VsZi5faHR0cHNfcHJveHkpLAogICAgICAgICAgICAnbm9Qcm94eSc6IFV0aWxDbGllbnQuZGVmYXVsdF9zdHJpbmcocnVudGltZS5ub19wcm94eSwgc2VsZi5fbm9fcHJveHkpLAogICAgICAgICAgICAnc29ja3M1UHJveHknOiBVdGlsQ2xpZW50LmRlZmF1bHRfc3RyaW5nKHJ1bnRpbWUuc29ja3NfNXByb3h5LCBzZWxmLl9zb2Nrc181cHJveHkpLAogICAgICAgICAgICAnc29ja3M1TmV0V29yayc6IFV0aWxDbGllbnQuZGVmYXVsdF9zdHJpbmcocnVudGltZS5zb2Nrc181bmV0X3dvcmssIHNlbGYuX3NvY2tzXzVuZXRfd29yayksCiAgICAgICAgICAgICdtYXhJZGxlQ29ubnMnOiBVdGlsQ2xpZW50LmRlZmF1bHRfbnVtYmVyKHJ1bnRpbWUubWF4X2lkbGVfY29ubnMsIHNlbGYuX21heF9pZGxlX2Nvbm5zKSwKICAgICAgICAgICAgJ3JldHJ5JzogewogICAgICAgICAgICAgICAgJ3JldHJ5YWJsZSc6IHJ1bnRpbWUuYXV0b3JldHJ5LAogICAgICAgICAgICAgICAgJ21heEF0dGVtcHRzJzogVXRpbENsaWVudC5kZWZhdWx0X251bWJlcihydW50aW1lLm1heF9hdHRlbXB0cywgMykKICAgICAgICAgICAgfSwKICAgICAgICAgICAgJ2JhY2tvZmYnOiB7CiAgICAgICAgICAgICAgICAncG9saWN5JzogVXRpbENsaWVudC5kZWZhdWx0X3N0cmluZyhydW50aW1lLmJhY2tvZmZfcG9saWN5LCAnbm8nKSwKICAgICAgICAgICAgICAgICdwZXJpb2QnOiBVdGlsQ2xpZW50LmRlZmF1bHRfbnVtYmVyKHJ1bnRpbWUuYmFja29mZl9wZXJpb2QsIDEpCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICdpZ25vcmVTU0wnOiBydW50aW1lLmlnbm9yZV9zc2wKICAgICAgICB9CiAgICAgICAgX2xhc3RfcmVxdWVzdCA9IE5vbmUKICAgICAgICBfbGFzdF9leGNlcHRpb24gPSBOb25lCiAgICAgICAgX25vdyA9IHRpbWUudGltZSgpCiAgICAgICAgX3JldHJ5X3RpbWVzID0gMAogICAgICAgIHdoaWxlIFRlYUNvcmUuYWxsb3dfcmV0cnkoX3J1bnRpbWUuZ2V0KCdyZXRyeScpLCBfcmV0cnlfdGltZXMsIF9ub3cpOgogICAgICAgICAgICBpZiBfcmV0cnlfdGltZXMgPiAwOgogICAgICAgICAgICAgICAgX2JhY2tvZmZfdGltZSA9IFRlYUNvcmUuZ2V0X2JhY2tvZmZfdGltZShfcnVudGltZS5nZXQoJ2JhY2tvZmYnKSwgX3JldHJ5X3RpbWVzKQogICAgICAgICAgICAgICAgaWYgX2JhY2tvZmZfdGltZSA+IDA6CiAgICAgICAgICAgICAgICAgICAgVGVhQ29yZS5zbGVlcChfYmFja29mZl90aW1lKQogICAgICAgICAgICBfcmV0cnlfdGltZXMgPSBfcmV0cnlfdGltZXMgKyAxCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIF9yZXF1ZXN0ID0gVGVhUmVxdWVzdCgpCiAgICAgICAgICAgICAgICBfcmVxdWVzdC5wcm90b2NvbCA9IFV0aWxDbGllbnQuZGVmYXVsdF9zdHJpbmcoc2VsZi5fcHJvdG9jb2wsIHBhcmFtcy5wcm90b2NvbCkKICAgICAgICAgICAgICAgIF9yZXF1ZXN0Lm1ldGhvZCA9IHBhcmFtcy5tZXRob2QKICAgICAgICAgICAgICAgIF9yZXF1ZXN0LnBhdGhuYW1lID0gcGFyYW1zLnBhdGhuYW1lCiAgICAgICAgICAgICAgICBnbG9iYWxfcXVlcmllcyA9IHt9CiAgICAgICAgICAgICAgICBnbG9iYWxfaGVhZGVycyA9IHt9CiAgICAgICAgICAgICAgICBpZiBub3QgVXRpbENsaWVudC5pc191bnNldChzZWxmLl9nbG9iYWxfcGFyYW1ldGVycyk6CiAgICAgICAgICAgICAgICAgICAgZ2xvYmFsX3BhcmFtcyA9IHNlbGYuX2dsb2JhbF9wYXJhbWV0ZXJzCiAgICAgICAgICAgICAgICAgICAgaWYgbm90IFV0aWxDbGllbnQuaXNfdW5zZXQoZ2xvYmFsX3BhcmFtcy5xdWVyaWVzKToKICAgICAgICAgICAgICAgICAgICAgICAgZ2xvYmFsX3F1ZXJpZXMgPSBnbG9iYWxfcGFyYW1zLnF1ZXJpZXMKICAgICAgICAgICAgICAgICAgICBpZiBub3QgVXRpbENsaWVudC5pc191bnNldChnbG9iYWxfcGFyYW1zLmhlYWRlcnMpOgogICAgICAgICAgICAgICAgICAgICAgICBnbG9iYWxfaGVhZGVycyA9IGdsb2JhbF9wYXJhbXMuaGVhZGVycwogICAgICAgICAgICAgICAgX3JlcXVlc3QucXVlcnkgPSBUZWFDb3JlLm1lcmdlKGdsb2JhbF9xdWVyaWVzLAogICAgICAgICAgICAgICAgICAgIHJlcXVlc3QucXVlcnkpCiAgICAgICAgICAgICAgICAjIGVuZHBvaW50IGlzIHNldHRlZCBpbiBwcm9kdWN0IGNsaWVudAogICAgICAgICAgICAgICAgX3JlcXVlc3QuaGVhZGVycyA9IFRlYUNvcmUubWVyZ2UoewogICAgICAgICAgICAgICAgICAgICdob3N0Jzogc2VsZi5fZW5kcG9pbnQsCiAgICAgICAgICAgICAgICAgICAgJ3gtYWNzLXZlcnNpb24nOiBwYXJhbXMudmVyc2lvbiwKICAgICAgICAgICAgICAgICAgICAneC1hY3MtYWN0aW9uJzogcGFyYW1zLmFjdGlvbiwKICAgICAgICAgICAgICAgICAgICAndXNlci1hZ2VudCc6IHNlbGYuZ2V0X3VzZXJfYWdlbnQoKSwKICAgICAgICAgICAgICAgICAgICAneC1hY3MtZGF0ZSc6IE9wZW5BcGlVdGlsQ2xpZW50LmdldF90aW1lc3RhbXAoKSwKICAgICAgICAgICAgICAgICAgICAneC1hY3Mtc2lnbmF0dXJlLW5vbmNlJzogVXRpbENsaWVudC5nZXRfbm9uY2UoKSwKICAgICAgICAgICAgICAgICAgICAnYWNjZXB0JzogJ2FwcGxpY2F0aW9uL2pzb24nCiAgICAgICAgICAgICAgICB9LCBnbG9iYWxfaGVhZGVycywKICAgICAgICAgICAgICAgICAgICByZXF1ZXN0LmhlYWRlcnMpCiAgICAgICAgICAgICAgICBpZiBVdGlsQ2xpZW50LmVxdWFsX3N0cmluZyhwYXJhbXMuc3R5bGUsICdSUEMnKToKICAgICAgICAgICAgICAgICAgICBoZWFkZXJzID0gc2VsZi5nZXRfcnBjX2hlYWRlcnMoKQogICAgICAgICAgICAgICAgICAgIGlmIG5vdCBVdGlsQ2xpZW50LmlzX3Vuc2V0KGhlYWRlcnMpOgogICAgICAgICAgICAgICAgICAgICAgICBfcmVxdWVzdC5oZWFkZXJzID0gVGVhQ29yZS5tZXJnZShfcmVxdWVzdC5oZWFkZXJzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaGVhZGVycykKICAgICAgICAgICAgICAgIHNpZ25hdHVyZV9hbGdvcml0aG0gPSBVdGlsQ2xpZW50LmRlZmF1bHRfc3RyaW5nKHNlbGYuX3NpZ25hdHVyZV9hbGdvcml0aG0sICdBQ1MzLUhNQUMtU0hBMjU2JykKICAgICAgICAgICAgICAgIGhhc2hlZF9yZXF1ZXN0X3BheWxvYWQgPSBPcGVuQXBpVXRpbENsaWVudC5oZXhfZW5jb2RlKE9wZW5BcGlVdGlsQ2xpZW50Lmhhc2goVXRpbENsaWVudC50b19ieXRlcygnJyksIHNpZ25hdHVyZV9hbGdvcml0aG0pKQogICAgICAgICAgICAgICAgaWYgbm90IFV0aWxDbGllbnQuaXNfdW5zZXQocmVxdWVzdC5zdHJlYW0pOgogICAgICAgICAgICAgICAgICAgIHRtcCA9IFV0aWxDbGllbnQucmVhZF9hc19ieXRlcyhyZXF1ZXN0LnN0cmVhbSkKICAgICAgICAgICAgICAgICAgICBoYXNoZWRfcmVxdWVzdF9wYXlsb2FkID0gT3BlbkFwaVV0aWxDbGllbnQuaGV4X2VuY29kZShPcGVuQXBpVXRpbENsaWVudC5oYXNoKHRtcCwgc2lnbmF0dXJlX2FsZ29yaXRobSkpCiAgICAgICAgICAgICAgICAgICAgX3JlcXVlc3QuYm9keSA9IHRtcAogICAgICAgICAgICAgICAgICAgIF9yZXF1ZXN0LmhlYWRlcnNbJ2NvbnRlbnQtdHlwZSddID0gJ2FwcGxpY2F0aW9uL29jdGV0LXN0cmVhbScKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgaWYgbm90IFV0aWxDbGllbnQuaXNfdW5zZXQocmVxdWVzdC5ib2R5KToKICAgICAgICAgICAgICAgICAgICAgICAgaWYgVXRpbENsaWVudC5lcXVhbF9zdHJpbmcocGFyYW1zLnJlcV9ib2R5X3R5cGUsICdqc29uJyk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBqc29uX29iaiA9IFV0aWxDbGllbnQudG9fanNvbnN0cmluZyhyZXF1ZXN0LmJvZHkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBoYXNoZWRfcmVxdWVzdF9wYXlsb2FkID0gT3BlbkFwaVV0aWxDbGllbnQuaGV4X2VuY29kZShPcGVuQXBpVXRpbENsaWVudC5oYXNoKFV0aWxDbGllbnQudG9fYnl0ZXMoanNvbl9vYmopLCBzaWduYXR1cmVfYWxnb3JpdGhtKSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9yZXF1ZXN0LmJvZHkgPSBqc29uX29iagogICAgICAgICAgICAgICAgICAgICAgICAgICAgX3JlcXVlc3QuaGVhZGVyc1snY29udGVudC10eXBlJ10gPSAnYXBwbGljYXRpb24vanNvbjsgY2hhcnNldD11dGYtOCcKICAgICAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG0gPSBVdGlsQ2xpZW50LmFzc2VydF9hc19tYXAocmVxdWVzdC5ib2R5KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9ybV9vYmogPSBPcGVuQXBpVXRpbENsaWVudC50b19mb3JtKG0pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBoYXNoZWRfcmVxdWVzdF9wYXlsb2FkID0gT3BlbkFwaVV0aWxDbGllbnQuaGV4X2VuY29kZShPcGVuQXBpVXRpbENsaWVudC5oYXNoKFV0aWxDbGllbnQudG9fYnl0ZXMoZm9ybV9vYmopLCBzaWduYXR1cmVfYWxnb3JpdGhtKSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9yZXF1ZXN0LmJvZHkgPSBmb3JtX29iagogICAgICAgICAgICAgICAgICAgICAgICAgICAgX3JlcXVlc3QuaGVhZGVyc1snY29udGVudC10eXBlJ10gPSAnYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkJwogICAgICAgICAgICAgICAgX3JlcXVlc3QuaGVhZGVyc1sneC1hY3MtY29udGVudC1zaGEyNTYnXSA9IGhhc2hlZF9yZXF1ZXN0X3BheWxvYWQKICAgICAgICAgICAgICAgIGlmIG5vdCBVdGlsQ2xpZW50LmVxdWFsX3N0cmluZyhwYXJhbXMuYXV0aF90eXBlLCAnQW5vbnltb3VzJyk6CiAgICAgICAgICAgICAgICAgICAgYXV0aF90eXBlID0gc2VsZi5nZXRfdHlwZSgpCiAgICAgICAgICAgICAgICAgICAgaWYgVXRpbENsaWVudC5lcXVhbF9zdHJpbmcoYXV0aF90eXBlLCAnYmVhcmVyJyk6CiAgICAgICAgICAgICAgICAgICAgICAgIGJlYXJlcl90b2tlbiA9IHNlbGYuZ2V0X2JlYXJlcl90b2tlbigpCiAgICAgICAgICAgICAgICAgICAgICAgIF9yZXF1ZXN0LmhlYWRlcnNbJ3gtYWNzLWJlYXJlci10b2tlbiddID0gYmVhcmVyX3Rva2VuCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgYWNjZXNzX2tleV9pZCA9IHNlbGYuZ2V0X2FjY2Vzc19rZXlfaWQoKQogICAgICAgICAgICAgICAgICAgICAgICBhY2Nlc3Nfa2V5X3NlY3JldCA9IHNlbGYuZ2V0X2FjY2Vzc19rZXlfc2VjcmV0KCkKICAgICAgICAgICAgICAgICAgICAgICAgc2VjdXJpdHlfdG9rZW4gPSBzZWxmLmdldF9zZWN1cml0eV90b2tlbigpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIG5vdCBVdGlsQ2xpZW50LmVtcHR5KHNlY3VyaXR5X3Rva2VuKToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9yZXF1ZXN0LmhlYWRlcnNbJ3gtYWNzLWFjY2Vzc2tleS1pZCddID0gYWNjZXNzX2tleV9pZAogICAgICAgICAgICAgICAgICAgICAgICAgICAgX3JlcXVlc3QuaGVhZGVyc1sneC1hY3Mtc2VjdXJpdHktdG9rZW4nXSA9IHNlY3VyaXR5X3Rva2VuCiAgICAgICAgICAgICAgICAgICAgICAgIF9yZXF1ZXN0LmhlYWRlcnNbJ0F1dGhvcml6YXRpb24nXSA9IE9wZW5BcGlVdGlsQ2xpZW50LmdldF9hdXRob3JpemF0aW9uKF9yZXF1ZXN0LCBzaWduYXR1cmVfYWxnb3JpdGhtLCBoYXNoZWRfcmVxdWVzdF9wYXlsb2FkLCBhY2Nlc3Nfa2V5X2lkLCBhY2Nlc3Nfa2V5X3NlY3JldCkKICAgICAgICAgICAgICAgIF9sYXN0X3JlcXVlc3QgPSBfcmVxdWVzdAogICAgICAgICAgICAgICAgX3Jlc3BvbnNlID0gVGVhQ29yZS5kb19hY3Rpb24oX3JlcXVlc3QsIF9ydW50aW1lKQogICAgICAgICAgICAgICAgaWYgVXRpbENsaWVudC5pc180eHgoX3Jlc3BvbnNlLnN0YXR1c19jb2RlKSBvciBVdGlsQ2xpZW50LmlzXzV4eChfcmVzcG9uc2Uuc3RhdHVzX2NvZGUpOgogICAgICAgICAgICAgICAgICAgIGVyciA9IHt9CiAgICAgICAgICAgICAgICAgICAgaWYgbm90IFV0aWxDbGllbnQuaXNfdW5zZXQoX3Jlc3BvbnNlLmhlYWRlcnMuZ2V0KCdjb250ZW50LXR5cGUnKSkgYW5kIFV0aWxDbGllbnQuZXF1YWxfc3RyaW5nKF9yZXNwb25zZS5oZWFkZXJzLmdldCgnY29udGVudC10eXBlJyksICd0ZXh0L3htbDtjaGFyc2V0PXV0Zi04Jyk6CiAgICAgICAgICAgICAgICAgICAgICAgIF9zdHIgPSBVdGlsQ2xpZW50LnJlYWRfYXNfc3RyaW5nKF9yZXNwb25zZS5ib2R5KQogICAgICAgICAgICAgICAgICAgICAgICByZXNwX21hcCA9IFhNTENsaWVudC5wYXJzZV94bWwoX3N0ciwgTm9uZSkKICAgICAgICAgICAgICAgICAgICAgICAgZXJyID0gVXRpbENsaWVudC5hc3NlcnRfYXNfbWFwKHJlc3BfbWFwLmdldCgnRXJyb3InKSkKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICBfcmVzID0gVXRpbENsaWVudC5yZWFkX2FzX2pzb24oX3Jlc3BvbnNlLmJvZHkpCiAgICAgICAgICAgICAgICAgICAgICAgIGVyciA9IFV0aWxDbGllbnQuYXNzZXJ0X2FzX21hcChfcmVzKQogICAgICAgICAgICAgICAgICAgIGVyclsnc3RhdHVzQ29kZSddID0gX3Jlc3BvbnNlLnN0YXR1c19jb2RlCiAgICAgICAgICAgICAgICAgICAgcmFpc2UgVGVhRXhjZXB0aW9uKHsKICAgICAgICAgICAgICAgICAgICAgICAgJ2NvZGUnOiBmIntzZWxmLmRlZmF1bHRfYW55KGVyci5nZXQoJ0NvZGUnKSwgZXJyLmdldCgnY29kZScpKX0iLAogICAgICAgICAgICAgICAgICAgICAgICAnbWVzc2FnZSc6IGYiY29kZToge19yZXNwb25zZS5zdGF0dXNfY29kZX0sIHtzZWxmLmRlZmF1bHRfYW55KGVyci5nZXQoJ01lc3NhZ2UnKSwgZXJyLmdldCgnbWVzc2FnZScpKX0gcmVxdWVzdCBpZDoge3NlbGYuZGVmYXVsdF9hbnkoZXJyLmdldCgnUmVxdWVzdElkJyksIGVyci5nZXQoJ3JlcXVlc3RJZCcpKX0iLAogICAgICAgICAgICAgICAgICAgICAgICAnZGF0YSc6IGVyciwKICAgICAgICAgICAgICAgICAgICAgICAgJ2Rlc2NyaXB0aW9uJzogZiJ7c2VsZi5kZWZhdWx0X2FueShlcnIuZ2V0KCdEZXNjcmlwdGlvbicpLCBlcnIuZ2V0KCdkZXNjcmlwdGlvbicpKX0iLAogICAgICAgICAgICAgICAgICAgICAgICAnYWNjZXNzRGVuaWVkRGV0YWlsJzogc2VsZi5kZWZhdWx0X2FueShlcnIuZ2V0KCdBY2Nlc3NEZW5pZWREZXRhaWwnKSwgZXJyLmdldCgnYWNjZXNzRGVuaWVkRGV0YWlsJykpCiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIGlmIFV0aWxDbGllbnQuZXF1YWxfc3RyaW5nKHBhcmFtcy5ib2R5X3R5cGUsICdiaW5hcnknKToKICAgICAgICAgICAgICAgICAgICByZXNwID0gewogICAgICAgICAgICAgICAgICAgICAgICAnYm9keSc6IF9yZXNwb25zZS5ib2R5LAogICAgICAgICAgICAgICAgICAgICAgICAnaGVhZGVycyc6IF9yZXNwb25zZS5oZWFkZXJzLAogICAgICAgICAgICAgICAgICAgICAgICAnc3RhdHVzQ29kZSc6IF9yZXNwb25zZS5zdGF0dXNfY29kZQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzcAogICAgICAgICAgICAgICAgZWxpZiBVdGlsQ2xpZW50LmVxdWFsX3N0cmluZyhwYXJhbXMuYm9keV90eXBlLCAnYnl0ZScpOgogICAgICAgICAgICAgICAgICAgIGJ5dCA9IFV0aWxDbGllbnQucmVhZF9hc19ieXRlcyhfcmVzcG9uc2UuYm9keSkKICAgICAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICAgICAgICAnYm9keSc6IGJ5dCwKICAgICAgICAgICAgICAgICAgICAgICAgJ2hlYWRlcnMnOiBfcmVzcG9uc2UuaGVhZGVycywKICAgICAgICAgICAgICAgICAgICAgICAgJ3N0YXR1c0NvZGUnOiBfcmVzcG9uc2Uuc3RhdHVzX2NvZGUKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbGlmIFV0aWxDbGllbnQuZXF1YWxfc3RyaW5nKHBhcmFtcy5ib2R5X3R5cGUsICdzdHJpbmcnKToKICAgICAgICAgICAgICAgICAgICBzdHIgPSBVdGlsQ2xpZW50LnJlYWRfYXNfc3RyaW5nKF9yZXNwb25zZS5ib2R5KQogICAgICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgICAgICAgICdib2R5Jzogc3RyLAogICAgICAgICAgICAgICAgICAgICAgICAnaGVhZGVycyc6IF9yZXNwb25zZS5oZWFkZXJzLAogICAgICAgICAgICAgICAgICAgICAgICAnc3RhdHVzQ29kZSc6IF9yZXNwb25zZS5zdGF0dXNfY29kZQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsaWYgVXRpbENsaWVudC5lcXVhbF9zdHJpbmcocGFyYW1zLmJvZHlfdHlwZSwgJ2pzb24nKToKICAgICAgICAgICAgICAgICAgICBvYmogPSBVdGlsQ2xpZW50LnJlYWRfYXNfanNvbihfcmVzcG9uc2UuYm9keSkKICAgICAgICAgICAgICAgICAgICByZXMgPSBVdGlsQ2xpZW50LmFzc2VydF9hc19tYXAob2JqKQogICAgICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgICAgICAgICdib2R5JzogcmVzLAogICAgICAgICAgICAgICAgICAgICAgICAnaGVhZGVycyc6IF9yZXNwb25zZS5oZWFkZXJzLAogICAgICAgICAgICAgICAgICAgICAgICAnc3RhdHVzQ29kZSc6IF9yZXNwb25zZS5zdGF0dXNfY29kZQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsaWYgVXRpbENsaWVudC5lcXVhbF9zdHJpbmcocGFyYW1zLmJvZHlfdHlwZSwgJ2FycmF5Jyk6CiAgICAgICAgICAgICAgICAgICAgYXJyID0gVXRpbENsaWVudC5yZWFkX2FzX2pzb24oX3Jlc3BvbnNlLmJvZHkpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgICAgICAgJ2JvZHknOiBhcnIsCiAgICAgICAgICAgICAgICAgICAgICAgICdoZWFkZXJzJzogX3Jlc3BvbnNlLmhlYWRlcnMsCiAgICAgICAgICAgICAgICAgICAgICAgICdzdGF0dXNDb2RlJzogX3Jlc3BvbnNlLnN0YXR1c19jb2RlCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICAgICAgICAnaGVhZGVycyc6IF9yZXNwb25zZS5oZWFkZXJzLAogICAgICAgICAgICAgICAgICAgICAgICAnc3RhdHVzQ29kZSc6IF9yZXNwb25zZS5zdGF0dXNfY29kZQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgaWYgVGVhQ29yZS5pc19yZXRyeWFibGUoZSk6CiAgICAgICAgICAgICAgICAgICAgX2xhc3RfZXhjZXB0aW9uID0gZQogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICByYWlzZSBlCiAgICAgICAgcmFpc2UgVW5yZXRyeWFibGVFeGNlcHRpb24oX2xhc3RfcmVxdWVzdCwgX2xhc3RfZXhjZXB0aW9uKQoKICAgIGFzeW5jIGRlZiBkb19yZXF1ZXN0X2FzeW5jKAogICAgICAgIHNlbGYsCiAgICAgICAgcGFyYW1zOiBvcGVuX2FwaV9tb2RlbHMuUGFyYW1zLAogICAgICAgIHJlcXVlc3Q6IG9wZW5fYXBpX21vZGVscy5PcGVuQXBpUmVxdWVzdCwKICAgICAgICBydW50aW1lOiB1dGlsX21vZGVscy5SdW50aW1lT3B0aW9ucywKICAgICkgLT4gZGljdDoKICAgICAgICAiIiIKICAgICAgICBFbmNhcHN1bGF0ZSB0aGUgcmVxdWVzdCBhbmQgaW52b2tlIHRoZSBuZXR3b3JrCiAgICAgICAgQHBhcmFtIGFjdGlvbjogYXBpIG5hbWUKICAgICAgICBAcGFyYW0gdmVyc2lvbjogcHJvZHVjdCB2ZXJzaW9uCiAgICAgICAgQHBhcmFtIHByb3RvY29sOiBodHRwIG9yIGh0dHBzCiAgICAgICAgQHBhcmFtIG1ldGhvZDogZS5nLiBHRVQKICAgICAgICBAcGFyYW0gYXV0aF90eXBlOiBhdXRob3JpemF0aW9uIHR5cGUgZS5nLiBBSwogICAgICAgIEBwYXJhbSBib2R5X3R5cGU6IHJlc3BvbnNlIGJvZHkgdHlwZSBlLmcuIFN0cmluZwogICAgICAgIEBwYXJhbSByZXF1ZXN0OiBvYmplY3Qgb2YgT3BlbkFwaVJlcXVlc3QKICAgICAgICBAcGFyYW0gcnVudGltZTogd2hpY2ggY29udHJvbHMgc29tZSBkZXRhaWxzIG9mIGNhbGwgYXBpLCBzdWNoIGFzIHJldHJ5IHRpbWVzCiAgICAgICAgQHJldHVybjogdGhlIHJlc3BvbnNlCiAgICAgICAgIiIiCiAgICAgICAgcGFyYW1zLnZhbGlkYXRlKCkKICAgICAgICByZXF1ZXN0LnZhbGlkYXRlKCkKICAgICAgICBydW50aW1lLnZhbGlkYXRlKCkKICAgICAgICBfcnVudGltZSA9IHsKICAgICAgICAgICAgJ3RpbWVvdXRlZCc6ICdyZXRyeScsCiAgICAgICAgICAgICdrZXknOiBVdGlsQ2xpZW50LmRlZmF1bHRfc3RyaW5nKHJ1bnRpbWUua2V5LCBzZWxmLl9rZXkpLAogICAgICAgICAgICAnY2VydCc6IFV0aWxDbGllbnQuZGVmYXVsdF9zdHJpbmcocnVudGltZS5jZXJ0LCBzZWxmLl9jZXJ0KSwKICAgICAgICAgICAgJ2NhJzogVXRpbENsaWVudC5kZWZhdWx0X3N0cmluZyhydW50aW1lLmNhLCBzZWxmLl9jYSksCiAgICAgICAgICAgICdyZWFkVGltZW91dCc6IFV0aWxDbGllbnQuZGVmYXVsdF9udW1iZXIocnVudGltZS5yZWFkX3RpbWVvdXQsIHNlbGYuX3JlYWRfdGltZW91dCksCiAgICAgICAgICAgICdjb25uZWN0VGltZW91dCc6IFV0aWxDbGllbnQuZGVmYXVsdF9udW1iZXIocnVudGltZS5jb25uZWN0X3RpbWVvdXQsIHNlbGYuX2Nvbm5lY3RfdGltZW91dCksCiAgICAgICAgICAgICdodHRwUHJveHknOiBVdGlsQ2xpZW50LmRlZmF1bHRfc3RyaW5nKHJ1bnRpbWUuaHR0cF9wcm94eSwgc2VsZi5faHR0cF9wcm94eSksCiAgICAgICAgICAgICdodHRwc1Byb3h5JzogVXRpbENsaWVudC5kZWZhdWx0X3N0cmluZyhydW50aW1lLmh0dHBzX3Byb3h5LCBzZWxmLl9odHRwc19wcm94eSksCiAgICAgICAgICAgICdub1Byb3h5JzogVXRpbENsaWVudC5kZWZhdWx0X3N0cmluZyhydW50aW1lLm5vX3Byb3h5LCBzZWxmLl9ub19wcm94eSksCiAgICAgICAgICAgICdzb2NrczVQcm94eSc6IFV0aWxDbGllbnQuZGVmYXVsdF9zdHJpbmcocnVudGltZS5zb2Nrc181cHJveHksIHNlbGYuX3NvY2tzXzVwcm94eSksCiAgICAgICAgICAgICdzb2NrczVOZXRXb3JrJzogVXRpbENsaWVudC5kZWZhdWx0X3N0cmluZyhydW50aW1lLnNvY2tzXzVuZXRfd29yaywgc2VsZi5fc29ja3NfNW5ldF93b3JrKSwKICAgICAgICAgICAgJ21heElkbGVDb25ucyc6IFV0aWxDbGllbnQuZGVmYXVsdF9udW1iZXIocnVudGltZS5tYXhfaWRsZV9jb25ucywgc2VsZi5fbWF4X2lkbGVfY29ubnMpLAogICAgICAgICAgICAncmV0cnknOiB7CiAgICAgICAgICAgICAgICAncmV0cnlhYmxlJzogcnVudGltZS5hdXRvcmV0cnksCiAgICAgICAgICAgICAgICAnbWF4QXR0ZW1wdHMnOiBVdGlsQ2xpZW50LmRlZmF1bHRfbnVtYmVyKHJ1bnRpbWUubWF4X2F0dGVtcHRzLCAzKQogICAgICAgICAgICB9LAogICAgICAgICAgICAnYmFja29mZic6IHsKICAgICAgICAgICAgICAgICdwb2xpY3knOiBVdGlsQ2xpZW50LmRlZmF1bHRfc3RyaW5nKHJ1bnRpbWUuYmFja29mZl9wb2xpY3ksICdubycpLAogICAgICAgICAgICAgICAgJ3BlcmlvZCc6IFV0aWxDbGllbnQuZGVmYXVsdF9udW1iZXIocnVudGltZS5iYWNrb2ZmX3BlcmlvZCwgMSkKICAgICAgICAgICAgfSwKICAgICAgICAgICAgJ2lnbm9yZVNTTCc6IHJ1bnRpbWUuaWdub3JlX3NzbAogICAgICAgIH0KICAgICAgICBfbGFzdF9yZXF1ZXN0ID0gTm9uZQogICAgICAgIF9sYXN0X2V4Y2VwdGlvbiA9IE5vbmUKICAgICAgICBfbm93ID0gdGltZS50aW1lKCkKICAgICAgICBfcmV0cnlfdGltZXMgPSAwCiAgICAgICAgd2hpbGUgVGVhQ29yZS5hbGxvd19yZXRyeShfcnVudGltZS5nZXQoJ3JldHJ5JyksIF9yZXRyeV90aW1lcywgX25vdyk6CiAgICAgICAgICAgIGlmIF9yZXRyeV90aW1lcyA+IDA6CiAgICAgICAgICAgICAgICBfYmFja29mZl90aW1lID0gVGVhQ29yZS5nZXRfYmFja29mZl90aW1lKF9ydW50aW1lLmdldCgnYmFja29mZicpLCBfcmV0cnlfdGltZXMpCiAgICAgICAgICAgICAgICBpZiBfYmFja29mZl90aW1lID4gMDoKICAgICAgICAgICAgICAgICAgICBUZWFDb3JlLnNsZWVwKF9iYWNrb2ZmX3RpbWUpCiAgICAgICAgICAgIF9yZXRyeV90aW1lcyA9IF9yZXRyeV90aW1lcyArIDEKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgX3JlcXVlc3QgPSBUZWFSZXF1ZXN0KCkKICAgICAgICAgICAgICAgIF9yZXF1ZXN0LnByb3RvY29sID0gVXRpbENsaWVudC5kZWZhdWx0X3N0cmluZyhzZWxmLl9wcm90b2NvbCwgcGFyYW1zLnByb3RvY29sKQogICAgICAgICAgICAgICAgX3JlcXVlc3QubWV0aG9kID0gcGFyYW1zLm1ldGhvZAogICAgICAgICAgICAgICAgX3JlcXVlc3QucGF0aG5hbWUgPSBwYXJhbXMucGF0aG5hbWUKICAgICAgICAgICAgICAgIGdsb2JhbF9xdWVyaWVzID0ge30KICAgICAgICAgICAgICAgIGdsb2JhbF9oZWFkZXJzID0ge30KICAgICAgICAgICAgICAgIGlmIG5vdCBVdGlsQ2xpZW50LmlzX3Vuc2V0KHNlbGYuX2dsb2JhbF9wYXJhbWV0ZXJzKToKICAgICAgICAgICAgICAgICAgICBnbG9iYWxfcGFyYW1zID0gc2VsZi5fZ2xvYmFsX3BhcmFtZXRlcnMKICAgICAgICAgICAgICAgICAgICBpZiBub3QgVXRpbENsaWVudC5pc191bnNldChnbG9iYWxfcGFyYW1zLnF1ZXJpZXMpOgogICAgICAgICAgICAgICAgICAgICAgICBnbG9iYWxfcXVlcmllcyA9IGdsb2JhbF9wYXJhbXMucXVlcmllcwogICAgICAgICAgICAgICAgICAgIGlmIG5vdCBVdGlsQ2xpZW50LmlzX3Vuc2V0KGdsb2JhbF9wYXJhbXMuaGVhZGVycyk6CiAgICAgICAgICAgICAgICAgICAgICAgIGdsb2JhbF9oZWFkZXJzID0gZ2xvYmFsX3BhcmFtcy5oZWFkZXJzCiAgICAgICAgICAgICAgICBfcmVxdWVzdC5xdWVyeSA9IFRlYUNvcmUubWVyZ2UoZ2xvYmFsX3F1ZXJpZXMsCiAgICAgICAgICAgICAgICAgICAgcmVxdWVzdC5xdWVyeSkKICAgICAgICAgICAgICAgICMgZW5kcG9pbnQgaXMgc2V0dGVkIGluIHByb2R1Y3QgY2xpZW50CiAgICAgICAgICAgICAgICBfcmVxdWVzdC5oZWFkZXJzID0gVGVhQ29yZS5tZXJnZSh7CiAgICAgICAgICAgICAgICAgICAgJ2hvc3QnOiBzZWxmLl9lbmRwb2ludCwKICAgICAgICAgICAgICAgICAgICAneC1hY3MtdmVyc2lvbic6IHBhcmFtcy52ZXJzaW9uLAogICAgICAgICAgICAgICAgICAgICd4LWFjcy1hY3Rpb24nOiBwYXJhbXMuYWN0aW9uLAogICAgICAgICAgICAgICAgICAgICd1c2VyLWFnZW50Jzogc2VsZi5nZXRfdXNlcl9hZ2VudCgpLAogICAgICAgICAgICAgICAgICAgICd4LWFjcy1kYXRlJzogT3BlbkFwaVV0aWxDbGllbnQuZ2V0X3RpbWVzdGFtcCgpLAogICAgICAgICAgICAgICAgICAgICd4LWFjcy1zaWduYXR1cmUtbm9uY2UnOiBVdGlsQ2xpZW50LmdldF9ub25jZSgpLAogICAgICAgICAgICAgICAgICAgICdhY2NlcHQnOiAnYXBwbGljYXRpb24vanNvbicKICAgICAgICAgICAgICAgIH0sIGdsb2JhbF9oZWFkZXJzLAogICAgICAgICAgICAgICAgICAgIHJlcXVlc3QuaGVhZGVycykKICAgICAgICAgICAgICAgIGlmIFV0aWxDbGllbnQuZXF1YWxfc3RyaW5nKHBhcmFtcy5zdHlsZSwgJ1JQQycpOgogICAgICAgICAgICAgICAgICAgIGhlYWRlcnMgPSBzZWxmLmdldF9ycGNfaGVhZGVycygpCiAgICAgICAgICAgICAgICAgICAgaWYgbm90IFV0aWxDbGllbnQuaXNfdW5zZXQoaGVhZGVycyk6CiAgICAgICAgICAgICAgICAgICAgICAgIF9yZXF1ZXN0LmhlYWRlcnMgPSBUZWFDb3JlLm1lcmdlKF9yZXF1ZXN0LmhlYWRlcnMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBoZWFkZXJzKQogICAgICAgICAgICAgICAgc2lnbmF0dXJlX2FsZ29yaXRobSA9IFV0aWxDbGllbnQuZGVmYXVsdF9zdHJpbmcoc2VsZi5fc2lnbmF0dXJlX2FsZ29yaXRobSwgJ0FDUzMtSE1BQy1TSEEyNTYnKQogICAgICAgICAgICAgICAgaGFzaGVkX3JlcXVlc3RfcGF5bG9hZCA9IE9wZW5BcGlVdGlsQ2xpZW50LmhleF9lbmNvZGUoT3BlbkFwaVV0aWxDbGllbnQuaGFzaChVdGlsQ2xpZW50LnRvX2J5dGVzKCcnKSwgc2lnbmF0dXJlX2FsZ29yaXRobSkpCiAgICAgICAgICAgICAgICBpZiBub3QgVXRpbENsaWVudC5pc191bnNldChyZXF1ZXN0LnN0cmVhbSk6CiAgICAgICAgICAgICAgICAgICAgdG1wID0gYXdhaXQgVXRpbENsaWVudC5yZWFkX2FzX2J5dGVzX2FzeW5jKHJlcXVlc3Quc3RyZWFtKQogICAgICAgICAgICAgICAgICAgIGhhc2hlZF9yZXF1ZXN0X3BheWxvYWQgPSBPcGVuQXBpVXRpbENsaWVudC5oZXhfZW5jb2RlKE9wZW5BcGlVdGlsQ2xpZW50Lmhhc2godG1wLCBzaWduYXR1cmVfYWxnb3JpdGhtKSkKICAgICAgICAgICAgICAgICAgICBfcmVxdWVzdC5ib2R5ID0gdG1wCiAgICAgICAgICAgICAgICAgICAgX3JlcXVlc3QuaGVhZGVyc1snY29udGVudC10eXBlJ10gPSAnYXBwbGljYXRpb24vb2N0ZXQtc3RyZWFtJwogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBpZiBub3QgVXRpbENsaWVudC5pc191bnNldChyZXF1ZXN0LmJvZHkpOgogICAgICAgICAgICAgICAgICAgICAgICBpZiBVdGlsQ2xpZW50LmVxdWFsX3N0cmluZyhwYXJhbXMucmVxX2JvZHlfdHlwZSwgJ2pzb24nKToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGpzb25fb2JqID0gVXRpbENsaWVudC50b19qc29uc3RyaW5nKHJlcXVlc3QuYm9keSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhhc2hlZF9yZXF1ZXN0X3BheWxvYWQgPSBPcGVuQXBpVXRpbENsaWVudC5oZXhfZW5jb2RlKE9wZW5BcGlVdGlsQ2xpZW50Lmhhc2goVXRpbENsaWVudC50b19ieXRlcyhqc29uX29iaiksIHNpZ25hdHVyZV9hbGdvcml0aG0pKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgX3JlcXVlc3QuYm9keSA9IGpzb25fb2JqCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfcmVxdWVzdC5oZWFkZXJzWydjb250ZW50LXR5cGUnXSA9ICdhcHBsaWNhdGlvbi9qc29uOyBjaGFyc2V0PXV0Zi04JwogICAgICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbSA9IFV0aWxDbGllbnQuYXNzZXJ0X2FzX21hcChyZXF1ZXN0LmJvZHkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JtX29iaiA9IE9wZW5BcGlVdGlsQ2xpZW50LnRvX2Zvcm0obSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhhc2hlZF9yZXF1ZXN0X3BheWxvYWQgPSBPcGVuQXBpVXRpbENsaWVudC5oZXhfZW5jb2RlKE9wZW5BcGlVdGlsQ2xpZW50Lmhhc2goVXRpbENsaWVudC50b19ieXRlcyhmb3JtX29iaiksIHNpZ25hdHVyZV9hbGdvcml0aG0pKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgX3JlcXVlc3QuYm9keSA9IGZvcm1fb2JqCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfcmVxdWVzdC5oZWFkZXJzWydjb250ZW50LXR5cGUnXSA9ICdhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQnCiAgICAgICAgICAgICAgICBfcmVxdWVzdC5oZWFkZXJzWyd4LWFjcy1jb250ZW50LXNoYTI1NiddID0gaGFzaGVkX3JlcXVlc3RfcGF5bG9hZAogICAgICAgICAgICAgICAgaWYgbm90IFV0aWxDbGllbnQuZXF1YWxfc3RyaW5nKHBhcmFtcy5hdXRoX3R5cGUsICdBbm9ueW1vdXMnKToKICAgICAgICAgICAgICAgICAgICBhdXRoX3R5cGUgPSBhd2FpdCBzZWxmLmdldF90eXBlX2FzeW5jKCkKICAgICAgICAgICAgICAgICAgICBpZiBVdGlsQ2xpZW50LmVxdWFsX3N0cmluZyhhdXRoX3R5cGUsICdiZWFyZXInKToKICAgICAgICAgICAgICAgICAgICAgICAgYmVhcmVyX3Rva2VuID0gYXdhaXQgc2VsZi5nZXRfYmVhcmVyX3Rva2VuX2FzeW5jKCkKICAgICAgICAgICAgICAgICAgICAgICAgX3JlcXVlc3QuaGVhZGVyc1sneC1hY3MtYmVhcmVyLXRva2VuJ10gPSBiZWFyZXJfdG9rZW4KICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICBhY2Nlc3Nfa2V5X2lkID0gYXdhaXQgc2VsZi5nZXRfYWNjZXNzX2tleV9pZF9hc3luYygpCiAgICAgICAgICAgICAgICAgICAgICAgIGFjY2Vzc19rZXlfc2VjcmV0ID0gYXdhaXQgc2VsZi5nZXRfYWNjZXNzX2tleV9zZWNyZXRfYXN5bmMoKQogICAgICAgICAgICAgICAgICAgICAgICBzZWN1cml0eV90b2tlbiA9IGF3YWl0IHNlbGYuZ2V0X3NlY3VyaXR5X3Rva2VuX2FzeW5jKCkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgbm90IFV0aWxDbGllbnQuZW1wdHkoc2VjdXJpdHlfdG9rZW4pOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgX3JlcXVlc3QuaGVhZGVyc1sneC1hY3MtYWNjZXNza2V5LWlkJ10gPSBhY2Nlc3Nfa2V5X2lkCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfcmVxdWVzdC5oZWFkZXJzWyd4LWFjcy1zZWN1cml0eS10b2tlbiddID0gc2VjdXJpdHlfdG9rZW4KICAgICAgICAgICAgICAgICAgICAgICAgX3JlcXVlc3QuaGVhZGVyc1snQXV0aG9yaXphdGlvbiddID0gT3BlbkFwaVV0aWxDbGllbnQuZ2V0X2F1dGhvcml6YXRpb24oX3JlcXVlc3QsIHNpZ25hdHVyZV9hbGdvcml0aG0sIGhhc2hlZF9yZXF1ZXN0X3BheWxvYWQsIGFjY2Vzc19rZXlfaWQsIGFjY2Vzc19rZXlfc2VjcmV0KQogICAgICAgICAgICAgICAgX2xhc3RfcmVxdWVzdCA9IF9yZXF1ZXN0CiAgICAgICAgICAgICAgICBfcmVzcG9uc2UgPSBhd2FpdCBUZWFDb3JlLmFzeW5jX2RvX2FjdGlvbihfcmVxdWVzdCwgX3J1bnRpbWUpCiAgICAgICAgICAgICAgICBpZiBVdGlsQ2xpZW50LmlzXzR4eChfcmVzcG9uc2Uuc3RhdHVzX2NvZGUpIG9yIFV0aWxDbGllbnQuaXNfNXh4KF9yZXNwb25zZS5zdGF0dXNfY29kZSk6CiAgICAgICAgICAgICAgICAgICAgZXJyID0ge30KICAgICAgICAgICAgICAgICAgICBpZiBub3QgVXRpbENsaWVudC5pc191bnNldChfcmVzcG9uc2UuaGVhZGVycy5nZXQoJ2NvbnRlbnQtdHlwZScpKSBhbmQgVXRpbENsaWVudC5lcXVhbF9zdHJpbmcoX3Jlc3BvbnNlLmhlYWRlcnMuZ2V0KCdjb250ZW50LXR5cGUnKSwgJ3RleHQveG1sO2NoYXJzZXQ9dXRmLTgnKToKICAgICAgICAgICAgICAgICAgICAgICAgX3N0ciA9IGF3YWl0IFV0aWxDbGllbnQucmVhZF9hc19zdHJpbmdfYXN5bmMoX3Jlc3BvbnNlLmJvZHkpCiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3BfbWFwID0gWE1MQ2xpZW50LnBhcnNlX3htbChfc3RyLCBOb25lKQogICAgICAgICAgICAgICAgICAgICAgICBlcnIgPSBVdGlsQ2xpZW50LmFzc2VydF9hc19tYXAocmVzcF9tYXAuZ2V0KCdFcnJvcicpKQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIF9yZXMgPSBhd2FpdCBVdGlsQ2xpZW50LnJlYWRfYXNfanNvbl9hc3luYyhfcmVzcG9uc2UuYm9keSkKICAgICAgICAgICAgICAgICAgICAgICAgZXJyID0gVXRpbENsaWVudC5hc3NlcnRfYXNfbWFwKF9yZXMpCiAgICAgICAgICAgICAgICAgICAgZXJyWydzdGF0dXNDb2RlJ10gPSBfcmVzcG9uc2Uuc3RhdHVzX2NvZGUKICAgICAgICAgICAgICAgICAgICByYWlzZSBUZWFFeGNlcHRpb24oewogICAgICAgICAgICAgICAgICAgICAgICAnY29kZSc6IGYie3NlbGYuZGVmYXVsdF9hbnkoZXJyLmdldCgnQ29kZScpLCBlcnIuZ2V0KCdjb2RlJykpfSIsCiAgICAgICAgICAgICAgICAgICAgICAgICdtZXNzYWdlJzogZiJjb2RlOiB7X3Jlc3BvbnNlLnN0YXR1c19jb2RlfSwge3NlbGYuZGVmYXVsdF9hbnkoZXJyLmdldCgnTWVzc2FnZScpLCBlcnIuZ2V0KCdtZXNzYWdlJykpfSByZXF1ZXN0IGlkOiB7c2VsZi5kZWZhdWx0X2FueShlcnIuZ2V0KCdSZXF1ZXN0SWQnKSwgZXJyLmdldCgncmVxdWVzdElkJykpfSIsCiAgICAgICAgICAgICAgICAgICAgICAgICdkYXRhJzogZXJyLAogICAgICAgICAgICAgICAgICAgICAgICAnZGVzY3JpcHRpb24nOiBmIntzZWxmLmRlZmF1bHRfYW55KGVyci5nZXQoJ0Rlc2NyaXB0aW9uJyksIGVyci5nZXQoJ2Rlc2NyaXB0aW9uJykpfSIsCiAgICAgICAgICAgICAgICAgICAgICAgICdhY2Nlc3NEZW5pZWREZXRhaWwnOiBzZWxmLmRlZmF1bHRfYW55KGVyci5nZXQoJ0FjY2Vzc0RlbmllZERldGFpbCcpLCBlcnIuZ2V0KCdhY2Nlc3NEZW5pZWREZXRhaWwnKSkKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgaWYgVXRpbENsaWVudC5lcXVhbF9zdHJpbmcocGFyYW1zLmJvZHlfdHlwZSwgJ2JpbmFyeScpOgogICAgICAgICAgICAgICAgICAgIHJlc3AgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICdib2R5JzogX3Jlc3BvbnNlLmJvZHksCiAgICAgICAgICAgICAgICAgICAgICAgICdoZWFkZXJzJzogX3Jlc3BvbnNlLmhlYWRlcnMsCiAgICAgICAgICAgICAgICAgICAgICAgICdzdGF0dXNDb2RlJzogX3Jlc3BvbnNlLnN0YXR1c19jb2RlCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJldHVybiByZXNwCiAgICAgICAgICAgICAgICBlbGlmIFV0aWxDbGllbnQuZXF1YWxfc3RyaW5nKHBhcmFtcy5ib2R5X3R5cGUsICdieXRlJyk6CiAgICAgICAgICAgICAgICAgICAgYnl0ID0gYXdhaXQgVXRpbENsaWVudC5yZWFkX2FzX2J5dGVzX2FzeW5jKF9yZXNwb25zZS5ib2R5KQogICAgICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgICAgICAgICdib2R5JzogYnl0LAogICAgICAgICAgICAgICAgICAgICAgICAnaGVhZGVycyc6IF9yZXNwb25zZS5oZWFkZXJzLAogICAgICAgICAgICAgICAgICAgICAgICAnc3RhdHVzQ29kZSc6IF9yZXNwb25zZS5zdGF0dXNfY29kZQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsaWYgVXRpbENsaWVudC5lcXVhbF9zdHJpbmcocGFyYW1zLmJvZHlfdHlwZSwgJ3N0cmluZycpOgogICAgICAgICAgICAgICAgICAgIHN0ciA9IGF3YWl0IFV0aWxDbGllbnQucmVhZF9hc19zdHJpbmdfYXN5bmMoX3Jlc3BvbnNlLmJvZHkpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgICAgICAgJ2JvZHknOiBzdHIsCiAgICAgICAgICAgICAgICAgICAgICAgICdoZWFkZXJzJzogX3Jlc3BvbnNlLmhlYWRlcnMsCiAgICAgICAgICAgICAgICAgICAgICAgICdzdGF0dXNDb2RlJzogX3Jlc3BvbnNlLnN0YXR1c19jb2RlCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxpZiBVdGlsQ2xpZW50LmVxdWFsX3N0cmluZyhwYXJhbXMuYm9keV90eXBlLCAnanNvbicpOgogICAgICAgICAgICAgICAgICAgIG9iaiA9IGF3YWl0IFV0aWxDbGllbnQucmVhZF9hc19qc29uX2FzeW5jKF9yZXNwb25zZS5ib2R5KQogICAgICAgICAgICAgICAgICAgIHJlcyA9IFV0aWxDbGllbnQuYXNzZXJ0X2FzX21hcChvYmopCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgICAgICAgJ2JvZHknOiByZXMsCiAgICAgICAgICAgICAgICAgICAgICAgICdoZWFkZXJzJzogX3Jlc3BvbnNlLmhlYWRlcnMsCiAgICAgICAgICAgICAgICAgICAgICAgICdzdGF0dXNDb2RlJzogX3Jlc3BvbnNlLnN0YXR1c19jb2RlCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxpZiBVdGlsQ2xpZW50LmVxdWFsX3N0cmluZyhwYXJhbXMuYm9keV90eXBlLCAnYXJyYXknKToKICAgICAgICAgICAgICAgICAgICBhcnIgPSBhd2FpdCBVdGlsQ2xpZW50LnJlYWRfYXNfanNvbl9hc3luYyhfcmVzcG9uc2UuYm9keSkKICAgICAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICAgICAgICAnYm9keSc6IGFyciwKICAgICAgICAgICAgICAgICAgICAgICAgJ2hlYWRlcnMnOiBfcmVzcG9uc2UuaGVhZGVycywKICAgICAgICAgICAgICAgICAgICAgICAgJ3N0YXR1c0NvZGUnOiBfcmVzcG9uc2Uuc3RhdHVzX2NvZGUKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgICAgICAgICdoZWFkZXJzJzogX3Jlc3BvbnNlLmhlYWRlcnMsCiAgICAgICAgICAgICAgICAgICAgICAgICdzdGF0dXNDb2RlJzogX3Jlc3BvbnNlLnN0YXR1c19jb2RlCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICBpZiBUZWFDb3JlLmlzX3JldHJ5YWJsZShlKToKICAgICAgICAgICAgICAgICAgICBfbGFzdF9leGNlcHRpb24gPSBlCiAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgIHJhaXNlIGUKICAgICAgICByYWlzZSBVbnJldHJ5YWJsZUV4Y2VwdGlvbihfbGFzdF9yZXF1ZXN0LCBfbGFzdF9leGNlcHRpb24pCgogICAgZGVmIGV4ZWN1dGUoCiAgICAgICAgc2VsZiwKICAgICAgICBwYXJhbXM6IG9wZW5fYXBpX21vZGVscy5QYXJhbXMsCiAgICAgICAgcmVxdWVzdDogb3Blbl9hcGlfbW9kZWxzLk9wZW5BcGlSZXF1ZXN0LAogICAgICAgIHJ1bnRpbWU6IHV0aWxfbW9kZWxzLlJ1bnRpbWVPcHRpb25zLAogICAgKSAtPiBkaWN0OgogICAgICAgICIiIgogICAgICAgIEVuY2Fwc3VsYXRlIHRoZSByZXF1ZXN0IGFuZCBpbnZva2UgdGhlIG5ldHdvcmsKICAgICAgICBAcGFyYW0gYWN0aW9uOiBhcGkgbmFtZQogICAgICAgIEBwYXJhbSB2ZXJzaW9uOiBwcm9kdWN0IHZlcnNpb24KICAgICAgICBAcGFyYW0gcHJvdG9jb2w6IGh0dHAgb3IgaHR0cHMKICAgICAgICBAcGFyYW0gbWV0aG9kOiBlLmcuIEdFVAogICAgICAgIEBwYXJhbSBhdXRoX3R5cGU6IGF1dGhvcml6YXRpb24gdHlwZSBlLmcuIEFLCiAgICAgICAgQHBhcmFtIGJvZHlfdHlwZTogcmVzcG9uc2UgYm9keSB0eXBlIGUuZy4gU3RyaW5nCiAgICAgICAgQHBhcmFtIHJlcXVlc3Q6IG9iamVjdCBvZiBPcGVuQXBpUmVxdWVzdAogICAgICAgIEBwYXJhbSBydW50aW1lOiB3aGljaCBjb250cm9scyBzb21lIGRldGFpbHMgb2YgY2FsbCBhcGksIHN1Y2ggYXMgcmV0cnkgdGltZXMKICAgICAgICBAcmV0dXJuOiB0aGUgcmVzcG9uc2UKICAgICAgICAiIiIKICAgICAgICBwYXJhbXMudmFsaWRhdGUoKQogICAgICAgIHJlcXVlc3QudmFsaWRhdGUoKQogICAgICAgIHJ1bnRpbWUudmFsaWRhdGUoKQogICAgICAgIF9ydW50aW1lID0gewogICAgICAgICAgICAndGltZW91dGVkJzogJ3JldHJ5JywKICAgICAgICAgICAgJ2tleSc6IFV0aWxDbGllbnQuZGVmYXVsdF9zdHJpbmcocnVudGltZS5rZXksIHNlbGYuX2tleSksCiAgICAgICAgICAgICdjZXJ0JzogVXRpbENsaWVudC5kZWZhdWx0X3N0cmluZyhydW50aW1lLmNlcnQsIHNlbGYuX2NlcnQpLAogICAgICAgICAgICAnY2EnOiBVdGlsQ2xpZW50LmRlZmF1bHRfc3RyaW5nKHJ1bnRpbWUuY2EsIHNlbGYuX2NhKSwKICAgICAgICAgICAgJ3JlYWRUaW1lb3V0JzogVXRpbENsaWVudC5kZWZhdWx0X251bWJlcihydW50aW1lLnJlYWRfdGltZW91dCwgc2VsZi5fcmVhZF90aW1lb3V0KSwKICAgICAgICAgICAgJ2Nvbm5lY3RUaW1lb3V0JzogVXRpbENsaWVudC5kZWZhdWx0X251bWJlcihydW50aW1lLmNvbm5lY3RfdGltZW91dCwgc2VsZi5fY29ubmVjdF90aW1lb3V0KSwKICAgICAgICAgICAgJ2h0dHBQcm94eSc6IFV0aWxDbGllbnQuZGVmYXVsdF9zdHJpbmcocnVudGltZS5odHRwX3Byb3h5LCBzZWxmLl9odHRwX3Byb3h5KSwKICAgICAgICAgICAgJ2h0dHBzUHJveHknOiBVdGlsQ2xpZW50LmRlZmF1bHRfc3RyaW5nKHJ1bnRpbWUuaHR0cHNfcHJveHksIHNlbGYuX2h0dHBzX3Byb3h5KSwKICAgICAgICAgICAgJ25vUHJveHknOiBVdGlsQ2xpZW50LmRlZmF1bHRfc3RyaW5nKHJ1bnRpbWUubm9fcHJveHksIHNlbGYuX25vX3Byb3h5KSwKICAgICAgICAgICAgJ3NvY2tzNVByb3h5JzogVXRpbENsaWVudC5kZWZhdWx0X3N0cmluZyhydW50aW1lLnNvY2tzXzVwcm94eSwgc2VsZi5fc29ja3NfNXByb3h5KSwKICAgICAgICAgICAgJ3NvY2tzNU5ldFdvcmsnOiBVdGlsQ2xpZW50LmRlZmF1bHRfc3RyaW5nKHJ1bnRpbWUuc29ja3NfNW5ldF93b3JrLCBzZWxmLl9zb2Nrc181bmV0X3dvcmspLAogICAgICAgICAgICAnbWF4SWRsZUNvbm5zJzogVXRpbENsaWVudC5kZWZhdWx0X251bWJlcihydW50aW1lLm1heF9pZGxlX2Nvbm5zLCBzZWxmLl9tYXhfaWRsZV9jb25ucyksCiAgICAgICAgICAgICdyZXRyeSc6IHsKICAgICAgICAgICAgICAgICdyZXRyeWFibGUnOiBydW50aW1lLmF1dG9yZXRyeSwKICAgICAgICAgICAgICAgICdtYXhBdHRlbXB0cyc6IFV0aWxDbGllbnQuZGVmYXVsdF9udW1iZXIocnVudGltZS5tYXhfYXR0ZW1wdHMsIDMpCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICdiYWNrb2ZmJzogewogICAgICAgICAgICAgICAgJ3BvbGljeSc6IFV0aWxDbGllbnQuZGVmYXVsdF9zdHJpbmcocnVudGltZS5iYWNrb2ZmX3BvbGljeSwgJ25vJyksCiAgICAgICAgICAgICAgICAncGVyaW9kJzogVXRpbENsaWVudC5kZWZhdWx0X251bWJlcihydW50aW1lLmJhY2tvZmZfcGVyaW9kLCAxKQogICAgICAgICAgICB9LAogICAgICAgICAgICAnaWdub3JlU1NMJzogcnVudGltZS5pZ25vcmVfc3NsCiAgICAgICAgfQogICAgICAgIF9sYXN0X3JlcXVlc3QgPSBOb25lCiAgICAgICAgX2xhc3RfZXhjZXB0aW9uID0gTm9uZQogICAgICAgIF9ub3cgPSB0aW1lLnRpbWUoKQogICAgICAgIF9yZXRyeV90aW1lcyA9IDAKICAgICAgICB3aGlsZSBUZWFDb3JlLmFsbG93X3JldHJ5KF9ydW50aW1lLmdldCgncmV0cnknKSwgX3JldHJ5X3RpbWVzLCBfbm93KToKICAgICAgICAgICAgaWYgX3JldHJ5X3RpbWVzID4gMDoKICAgICAgICAgICAgICAgIF9iYWNrb2ZmX3RpbWUgPSBUZWFDb3JlLmdldF9iYWNrb2ZmX3RpbWUoX3J1bnRpbWUuZ2V0KCdiYWNrb2ZmJyksIF9yZXRyeV90aW1lcykKICAgICAgICAgICAgICAgIGlmIF9iYWNrb2ZmX3RpbWUgPiAwOgogICAgICAgICAgICAgICAgICAgIFRlYUNvcmUuc2xlZXAoX2JhY2tvZmZfdGltZSkKICAgICAgICAgICAgX3JldHJ5X3RpbWVzID0gX3JldHJ5X3RpbWVzICsgMQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBfcmVxdWVzdCA9IFRlYVJlcXVlc3QoKQogICAgICAgICAgICAgICAgIyBzcGkgPSBuZXcgR2F0ZXdheSgpOy8vR2F0ZXdheSBpbXBsZW1lbnRzIFNQSe+8jOi/meS4gOatpeWcqOS6p+WTgSBTREsg5Lit5a6e5L6L5YyWCiAgICAgICAgICAgICAgICBoZWFkZXJzID0gc2VsZi5nZXRfcnBjX2hlYWRlcnMoKQogICAgICAgICAgICAgICAgZ2xvYmFsX3F1ZXJpZXMgPSB7fQogICAgICAgICAgICAgICAgZ2xvYmFsX2hlYWRlcnMgPSB7fQogICAgICAgICAgICAgICAgaWYgbm90IFV0aWxDbGllbnQuaXNfdW5zZXQoc2VsZi5fZ2xvYmFsX3BhcmFtZXRlcnMpOgogICAgICAgICAgICAgICAgICAgIGdsb2JhbF9wYXJhbXMgPSBzZWxmLl9nbG9iYWxfcGFyYW1ldGVycwogICAgICAgICAgICAgICAgICAgIGlmIG5vdCBVdGlsQ2xpZW50LmlzX3Vuc2V0KGdsb2JhbF9wYXJhbXMucXVlcmllcyk6CiAgICAgICAgICAgICAgICAgICAgICAgIGdsb2JhbF9xdWVyaWVzID0gZ2xvYmFsX3BhcmFtcy5xdWVyaWVzCiAgICAgICAgICAgICAgICAgICAgaWYgbm90IFV0aWxDbGllbnQuaXNfdW5zZXQoZ2xvYmFsX3BhcmFtcy5oZWFkZXJzKToKICAgICAgICAgICAgICAgICAgICAgICAgZ2xvYmFsX2hlYWRlcnMgPSBnbG9iYWxfcGFyYW1zLmhlYWRlcnMKICAgICAgICAgICAgICAgIHJlcXVlc3RfY29udGV4dCA9IHNwaV9tb2RlbHMuSW50ZXJjZXB0b3JDb250ZXh0UmVxdWVzdCgKICAgICAgICAgICAgICAgICAgICBoZWFkZXJzPVRlYUNvcmUubWVyZ2UoZ2xvYmFsX2hlYWRlcnMsCiAgICAgICAgICAgICAgICAgICAgICAgIHJlcXVlc3QuaGVhZGVycywKICAgICAgICAgICAgICAgICAgICAgICAgaGVhZGVycyksCiAgICAgICAgICAgICAgICAgICAgcXVlcnk9VGVhQ29yZS5tZXJnZShnbG9iYWxfcXVlcmllcywKICAgICAgICAgICAgICAgICAgICAgICAgcmVxdWVzdC5xdWVyeSksCiAgICAgICAgICAgICAgICAgICAgYm9keT1yZXF1ZXN0LmJvZHksCiAgICAgICAgICAgICAgICAgICAgc3RyZWFtPXJlcXVlc3Quc3RyZWFtLAogICAgICAgICAgICAgICAgICAgIGhvc3RfbWFwPXJlcXVlc3QuaG9zdF9tYXAsCiAgICAgICAgICAgICAgICAgICAgcGF0aG5hbWU9cGFyYW1zLnBhdGhuYW1lLAogICAgICAgICAgICAgICAgICAgIHByb2R1Y3RfaWQ9c2VsZi5fcHJvZHVjdF9pZCwKICAgICAgICAgICAgICAgICAgICBhY3Rpb249cGFyYW1zLmFjdGlvbiwKICAgICAgICAgICAgICAgICAgICB2ZXJzaW9uPXBhcmFtcy52ZXJzaW9uLAogICAgICAgICAgICAgICAgICAgIHByb3RvY29sPVV0aWxDbGllbnQuZGVmYXVsdF9zdHJpbmcoc2VsZi5fcHJvdG9jb2wsIHBhcmFtcy5wcm90b2NvbCksCiAgICAgICAgICAgICAgICAgICAgbWV0aG9kPVV0aWxDbGllbnQuZGVmYXVsdF9zdHJpbmcoc2VsZi5fbWV0aG9kLCBwYXJhbXMubWV0aG9kKSwKICAgICAgICAgICAgICAgICAgICBhdXRoX3R5cGU9cGFyYW1zLmF1dGhfdHlwZSwKICAgICAgICAgICAgICAgICAgICBib2R5X3R5cGU9cGFyYW1zLmJvZHlfdHlwZSwKICAgICAgICAgICAgICAgICAgICByZXFfYm9keV90eXBlPXBhcmFtcy5yZXFfYm9keV90eXBlLAogICAgICAgICAgICAgICAgICAgIHN0eWxlPXBhcmFtcy5zdHlsZSwKICAgICAgICAgICAgICAgICAgICBjcmVkZW50aWFsPXNlbGYuX2NyZWRlbnRpYWwsCiAgICAgICAgICAgICAgICAgICAgc2lnbmF0dXJlX3ZlcnNpb249c2VsZi5fc2lnbmF0dXJlX3ZlcnNpb24sCiAgICAgICAgICAgICAgICAgICAgc2lnbmF0dXJlX2FsZ29yaXRobT1zZWxmLl9zaWduYXR1cmVfYWxnb3JpdGhtLAogICAgICAgICAgICAgICAgICAgIHVzZXJfYWdlbnQ9c2VsZi5nZXRfdXNlcl9hZ2VudCgpCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICBjb25maWd1cmF0aW9uX2NvbnRleHQgPSBzcGlfbW9kZWxzLkludGVyY2VwdG9yQ29udGV4dENvbmZpZ3VyYXRpb24oCiAgICAgICAgICAgICAgICAgICAgcmVnaW9uX2lkPXNlbGYuX3JlZ2lvbl9pZCwKICAgICAgICAgICAgICAgICAgICBlbmRwb2ludD1VdGlsQ2xpZW50LmRlZmF1bHRfc3RyaW5nKHJlcXVlc3QuZW5kcG9pbnRfb3ZlcnJpZGUsIHNlbGYuX2VuZHBvaW50KSwKICAgICAgICAgICAgICAgICAgICBlbmRwb2ludF9ydWxlPXNlbGYuX2VuZHBvaW50X3J1bGUsCiAgICAgICAgICAgICAgICAgICAgZW5kcG9pbnRfbWFwPXNlbGYuX2VuZHBvaW50X21hcCwKICAgICAgICAgICAgICAgICAgICBlbmRwb2ludF90eXBlPXNlbGYuX2VuZHBvaW50X3R5cGUsCiAgICAgICAgICAgICAgICAgICAgbmV0d29yaz1zZWxmLl9uZXR3b3JrLAogICAgICAgICAgICAgICAgICAgIHN1ZmZpeD1zZWxmLl9zdWZmaXgKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgIGludGVyY2VwdG9yX2NvbnRleHQgPSBzcGlfbW9kZWxzLkludGVyY2VwdG9yQ29udGV4dCgKICAgICAgICAgICAgICAgICAgICByZXF1ZXN0PXJlcXVlc3RfY29udGV4dCwKICAgICAgICAgICAgICAgICAgICBjb25maWd1cmF0aW9uPWNvbmZpZ3VyYXRpb25fY29udGV4dAogICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgYXR0cmlidXRlX21hcCA9IHNwaV9tb2RlbHMuQXR0cmlidXRlTWFwKCkKICAgICAgICAgICAgICAgICMgMS4gc3BpLm1vZGlmeUNvbmZpZ3VyYXRpb24oY29udGV4dDogU1BJLkludGVyY2VwdG9yQ29udGV4dCwgYXR0cmlidXRlTWFwOiBTUEkuQXR0cmlidXRlTWFwKTsKICAgICAgICAgICAgICAgIHNlbGYuX3NwaS5tb2RpZnlfY29uZmlndXJhdGlvbihpbnRlcmNlcHRvcl9jb250ZXh0LCBhdHRyaWJ1dGVfbWFwKQogICAgICAgICAgICAgICAgIyAyLiBzcGkubW9kaWZ5UmVxdWVzdChjb250ZXh0OiBTUEkuSW50ZXJjZXB0b3JDb250ZXh0LCBhdHRyaWJ1dGVNYXA6IFNQSS5BdHRyaWJ1dGVNYXApOwogICAgICAgICAgICAgICAgc2VsZi5fc3BpLm1vZGlmeV9yZXF1ZXN0KGludGVyY2VwdG9yX2NvbnRleHQsIGF0dHJpYnV0ZV9tYXApCiAgICAgICAgICAgICAgICBfcmVxdWVzdC5wcm90b2NvbCA9IGludGVyY2VwdG9yX2NvbnRleHQucmVxdWVzdC5wcm90b2NvbAogICAgICAgICAgICAgICAgX3JlcXVlc3QubWV0aG9kID0gaW50ZXJjZXB0b3JfY29udGV4dC5yZXF1ZXN0Lm1ldGhvZAogICAgICAgICAgICAgICAgX3JlcXVlc3QucGF0aG5hbWUgPSBpbnRlcmNlcHRvcl9jb250ZXh0LnJlcXVlc3QucGF0aG5hbWUKICAgICAgICAgICAgICAgIF9yZXF1ZXN0LnF1ZXJ5ID0gaW50ZXJjZXB0b3JfY29udGV4dC5yZXF1ZXN0LnF1ZXJ5CiAgICAgICAgICAgICAgICBfcmVxdWVzdC5ib2R5ID0gaW50ZXJjZXB0b3JfY29udGV4dC5yZXF1ZXN0LnN0cmVhbQogICAgICAgICAgICAgICAgX3JlcXVlc3QuaGVhZGVycyA9IGludGVyY2VwdG9yX2NvbnRleHQucmVxdWVzdC5oZWFkZXJzCiAgICAgICAgICAgICAgICBfbGFzdF9yZXF1ZXN0ID0gX3JlcXVlc3QKICAgICAgICAgICAgICAgIF9yZXNwb25zZSA9IFRlYUNvcmUuZG9fYWN0aW9uKF9yZXF1ZXN0LCBfcnVudGltZSkKICAgICAgICAgICAgICAgIHJlc3BvbnNlX2NvbnRleHQgPSBzcGlfbW9kZWxzLkludGVyY2VwdG9yQ29udGV4dFJlc3BvbnNlKAogICAgICAgICAgICAgICAgICAgIHN0YXR1c19jb2RlPV9yZXNwb25zZS5zdGF0dXNfY29kZSwKICAgICAgICAgICAgICAgICAgICBoZWFkZXJzPV9yZXNwb25zZS5oZWFkZXJzLAogICAgICAgICAgICAgICAgICAgIGJvZHk9X3Jlc3BvbnNlLmJvZHkKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgIGludGVyY2VwdG9yX2NvbnRleHQucmVzcG9uc2UgPSByZXNwb25zZV9jb250ZXh0CiAgICAgICAgICAgICAgICAjIDMuIHNwaS5tb2RpZnlSZXNwb25zZShjb250ZXh0OiBTUEkuSW50ZXJjZXB0b3JDb250ZXh0LCBhdHRyaWJ1dGVNYXA6IFNQSS5BdHRyaWJ1dGVNYXApOwogICAgICAgICAgICAgICAgc2VsZi5fc3BpLm1vZGlmeV9yZXNwb25zZShpbnRlcmNlcHRvcl9jb250ZXh0LCBhdHRyaWJ1dGVfbWFwKQogICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgICAnaGVhZGVycyc6IGludGVyY2VwdG9yX2NvbnRleHQucmVzcG9uc2UuaGVhZGVycywKICAgICAgICAgICAgICAgICAgICAnc3RhdHVzQ29kZSc6IGludGVyY2VwdG9yX2NvbnRleHQucmVzcG9uc2Uuc3RhdHVzX2NvZGUsCiAgICAgICAgICAgICAgICAgICAgJ2JvZHknOiBpbnRlcmNlcHRvcl9jb250ZXh0LnJlc3BvbnNlLmRlc2VyaWFsaXplZF9ib2R5CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgIGlmIFRlYUNvcmUuaXNfcmV0cnlhYmxlKGUpOgogICAgICAgICAgICAgICAgICAgIF9sYXN0X2V4Y2VwdGlvbiA9IGUKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgcmFpc2UgZQogICAgICAgIHJhaXNlIFVucmV0cnlhYmxlRXhjZXB0aW9uKF9sYXN0X3JlcXVlc3QsIF9sYXN0X2V4Y2VwdGlvbikKCiAgICBhc3luYyBkZWYgZXhlY3V0ZV9hc3luYygKICAgICAgICBzZWxmLAogICAgICAgIHBhcmFtczogb3Blbl9hcGlfbW9kZWxzLlBhcmFtcywKICAgICAgICByZXF1ZXN0OiBvcGVuX2FwaV9tb2RlbHMuT3BlbkFwaVJlcXVlc3QsCiAgICAgICAgcnVudGltZTogdXRpbF9tb2RlbHMuUnVudGltZU9wdGlvbnMsCiAgICApIC0+IGRpY3Q6CiAgICAgICAgIiIiCiAgICAgICAgRW5jYXBzdWxhdGUgdGhlIHJlcXVlc3QgYW5kIGludm9rZSB0aGUgbmV0d29yawogICAgICAgIEBwYXJhbSBhY3Rpb246IGFwaSBuYW1lCiAgICAgICAgQHBhcmFtIHZlcnNpb246IHByb2R1Y3QgdmVyc2lvbgogICAgICAgIEBwYXJhbSBwcm90b2NvbDogaHR0cCBvciBodHRwcwogICAgICAgIEBwYXJhbSBtZXRob2Q6IGUuZy4gR0VUCiAgICAgICAgQHBhcmFtIGF1dGhfdHlwZTogYXV0aG9yaXphdGlvbiB0eXBlIGUuZy4gQUsKICAgICAgICBAcGFyYW0gYm9keV90eXBlOiByZXNwb25zZSBib2R5IHR5cGUgZS5nLiBTdHJpbmcKICAgICAgICBAcGFyYW0gcmVxdWVzdDogb2JqZWN0IG9mIE9wZW5BcGlSZXF1ZXN0CiAgICAgICAgQHBhcmFtIHJ1bnRpbWU6IHdoaWNoIGNvbnRyb2xzIHNvbWUgZGV0YWlscyBvZiBjYWxsIGFwaSwgc3VjaCBhcyByZXRyeSB0aW1lcwogICAgICAgIEByZXR1cm46IHRoZSByZXNwb25zZQogICAgICAgICIiIgogICAgICAgIHBhcmFtcy52YWxpZGF0ZSgpCiAgICAgICAgcmVxdWVzdC52YWxpZGF0ZSgpCiAgICAgICAgcnVudGltZS52YWxpZGF0ZSgpCiAgICAgICAgX3J1bnRpbWUgPSB7CiAgICAgICAgICAgICd0aW1lb3V0ZWQnOiAncmV0cnknLAogICAgICAgICAgICAna2V5JzogVXRpbENsaWVudC5kZWZhdWx0X3N0cmluZyhydW50aW1lLmtleSwgc2VsZi5fa2V5KSwKICAgICAgICAgICAgJ2NlcnQnOiBVdGlsQ2xpZW50LmRlZmF1bHRfc3RyaW5nKHJ1bnRpbWUuY2VydCwgc2VsZi5fY2VydCksCiAgICAgICAgICAgICdjYSc6IFV0aWxDbGllbnQuZGVmYXVsdF9zdHJpbmcocnVudGltZS5jYSwgc2VsZi5fY2EpLAogICAgICAgICAgICAncmVhZFRpbWVvdXQnOiBVdGlsQ2xpZW50LmRlZmF1bHRfbnVtYmVyKHJ1bnRpbWUucmVhZF90aW1lb3V0LCBzZWxmLl9yZWFkX3RpbWVvdXQpLAogICAgICAgICAgICAnY29ubmVjdFRpbWVvdXQnOiBVdGlsQ2xpZW50LmRlZmF1bHRfbnVtYmVyKHJ1bnRpbWUuY29ubmVjdF90aW1lb3V0LCBzZWxmLl9jb25uZWN0X3RpbWVvdXQpLAogICAgICAgICAgICAnaHR0cFByb3h5JzogVXRpbENsaWVudC5kZWZhdWx0X3N0cmluZyhydW50aW1lLmh0dHBfcHJveHksIHNlbGYuX2h0dHBfcHJveHkpLAogICAgICAgICAgICAnaHR0cHNQcm94eSc6IFV0aWxDbGllbnQuZGVmYXVsdF9zdHJpbmcocnVudGltZS5odHRwc19wcm94eSwgc2VsZi5faHR0cHNfcHJveHkpLAogICAgICAgICAgICAnbm9Qcm94eSc6IFV0aWxDbGllbnQuZGVmYXVsdF9zdHJpbmcocnVudGltZS5ub19wcm94eSwgc2VsZi5fbm9fcHJveHkpLAogICAgICAgICAgICAnc29ja3M1UHJveHknOiBVdGlsQ2xpZW50LmRlZmF1bHRfc3RyaW5nKHJ1bnRpbWUuc29ja3NfNXByb3h5LCBzZWxmLl9zb2Nrc181cHJveHkpLAogICAgICAgICAgICAnc29ja3M1TmV0V29yayc6IFV0aWxDbGllbnQuZGVmYXVsdF9zdHJpbmcocnVudGltZS5zb2Nrc181bmV0X3dvcmssIHNlbGYuX3NvY2tzXzVuZXRfd29yayksCiAgICAgICAgICAgICdtYXhJZGxlQ29ubnMnOiBVdGlsQ2xpZW50LmRlZmF1bHRfbnVtYmVyKHJ1bnRpbWUubWF4X2lkbGVfY29ubnMsIHNlbGYuX21heF9pZGxlX2Nvbm5zKSwKICAgICAgICAgICAgJ3JldHJ5JzogewogICAgICAgICAgICAgICAgJ3JldHJ5YWJsZSc6IHJ1bnRpbWUuYXV0b3JldHJ5LAogICAgICAgICAgICAgICAgJ21heEF0dGVtcHRzJzogVXRpbENsaWVudC5kZWZhdWx0X251bWJlcihydW50aW1lLm1heF9hdHRlbXB0cywgMykKICAgICAgICAgICAgfSwKICAgICAgICAgICAgJ2JhY2tvZmYnOiB7CiAgICAgICAgICAgICAgICAncG9saWN5JzogVXRpbENsaWVudC5kZWZhdWx0X3N0cmluZyhydW50aW1lLmJhY2tvZmZfcG9saWN5LCAnbm8nKSwKICAgICAgICAgICAgICAgICdwZXJpb2QnOiBVdGlsQ2xpZW50LmRlZmF1bHRfbnVtYmVyKHJ1bnRpbWUuYmFja29mZl9wZXJpb2QsIDEpCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICdpZ25vcmVTU0wnOiBydW50aW1lLmlnbm9yZV9zc2wKICAgICAgICB9CiAgICAgICAgX2xhc3RfcmVxdWVzdCA9IE5vbmUKICAgICAgICBfbGFzdF9leGNlcHRpb24gPSBOb25lCiAgICAgICAgX25vdyA9IHRpbWUudGltZSgpCiAgICAgICAgX3JldHJ5X3RpbWVzID0gMAogICAgICAgIHdoaWxlIFRlYUNvcmUuYWxsb3dfcmV0cnkoX3J1bnRpbWUuZ2V0KCdyZXRyeScpLCBfcmV0cnlfdGltZXMsIF9ub3cpOgogICAgICAgICAgICBpZiBfcmV0cnlfdGltZXMgPiAwOgogICAgICAgICAgICAgICAgX2JhY2tvZmZfdGltZSA9IFRlYUNvcmUuZ2V0X2JhY2tvZmZfdGltZShfcnVudGltZS5nZXQoJ2JhY2tvZmYnKSwgX3JldHJ5X3RpbWVzKQogICAgICAgICAgICAgICAgaWYgX2JhY2tvZmZfdGltZSA+IDA6CiAgICAgICAgICAgICAgICAgICAgVGVhQ29yZS5zbGVlcChfYmFja29mZl90aW1lKQogICAgICAgICAgICBfcmV0cnlfdGltZXMgPSBfcmV0cnlfdGltZXMgKyAxCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIF9yZXF1ZXN0ID0gVGVhUmVxdWVzdCgpCiAgICAgICAgICAgICAgICAjIHNwaSA9IG5ldyBHYXRld2F5KCk7Ly9HYXRld2F5IGltcGxlbWVudHMgU1BJ77yM6L+Z5LiA5q2l5Zyo5Lqn5ZOBIFNESyDkuK3lrp7kvovljJYKICAgICAgICAgICAgICAgIGhlYWRlcnMgPSBzZWxmLmdldF9ycGNfaGVhZGVycygpCiAgICAgICAgICAgICAgICBnbG9iYWxfcXVlcmllcyA9IHt9CiAgICAgICAgICAgICAgICBnbG9iYWxfaGVhZGVycyA9IHt9CiAgICAgICAgICAgICAgICBpZiBub3QgVXRpbENsaWVudC5pc191bnNldChzZWxmLl9nbG9iYWxfcGFyYW1ldGVycyk6CiAgICAgICAgICAgICAgICAgICAgZ2xvYmFsX3BhcmFtcyA9IHNlbGYuX2dsb2JhbF9wYXJhbWV0ZXJzCiAgICAgICAgICAgICAgICAgICAgaWYgbm90IFV0aWxDbGllbnQuaXNfdW5zZXQoZ2xvYmFsX3BhcmFtcy5xdWVyaWVzKToKICAgICAgICAgICAgICAgICAgICAgICAgZ2xvYmFsX3F1ZXJpZXMgPSBnbG9iYWxfcGFyYW1zLnF1ZXJpZXMKICAgICAgICAgICAgICAgICAgICBpZiBub3QgVXRpbENsaWVudC5pc191bnNldChnbG9iYWxfcGFyYW1zLmhlYWRlcnMpOgogICAgICAgICAgICAgICAgICAgICAgICBnbG9iYWxfaGVhZGVycyA9IGdsb2JhbF9wYXJhbXMuaGVhZGVycwogICAgICAgICAgICAgICAgcmVxdWVzdF9jb250ZXh0ID0gc3BpX21vZGVscy5JbnRlcmNlcHRvckNvbnRleHRSZXF1ZXN0KAogICAgICAgICAgICAgICAgICAgIGhlYWRlcnM9VGVhQ29yZS5tZXJnZShnbG9iYWxfaGVhZGVycywKICAgICAgICAgICAgICAgICAgICAgICAgcmVxdWVzdC5oZWFkZXJzLAogICAgICAgICAgICAgICAgICAgICAgICBoZWFkZXJzKSwKICAgICAgICAgICAgICAgICAgICBxdWVyeT1UZWFDb3JlLm1lcmdlKGdsb2JhbF9xdWVyaWVzLAogICAgICAgICAgICAgICAgICAgICAgICByZXF1ZXN0LnF1ZXJ5KSwKICAgICAgICAgICAgICAgICAgICBib2R5PXJlcXVlc3QuYm9keSwKICAgICAgICAgICAgICAgICAgICBzdHJlYW09cmVxdWVzdC5zdHJlYW0sCiAgICAgICAgICAgICAgICAgICAgaG9zdF9tYXA9cmVxdWVzdC5ob3N0X21hcCwKICAgICAgICAgICAgICAgICAgICBwYXRobmFtZT1wYXJhbXMucGF0aG5hbWUsCiAgICAgICAgICAgICAgICAgICAgcHJvZHVjdF9pZD1zZWxmLl9wcm9kdWN0X2lkLAogICAgICAgICAgICAgICAgICAgIGFjdGlvbj1wYXJhbXMuYWN0aW9uLAogICAgICAgICAgICAgICAgICAgIHZlcnNpb249cGFyYW1zLnZlcnNpb24sCiAgICAgICAgICAgICAgICAgICAgcHJvdG9jb2w9VXRpbENsaWVudC5kZWZhdWx0X3N0cmluZyhzZWxmLl9wcm90b2NvbCwgcGFyYW1zLnByb3RvY29sKSwKICAgICAgICAgICAgICAgICAgICBtZXRob2Q9VXRpbENsaWVudC5kZWZhdWx0X3N0cmluZyhzZWxmLl9tZXRob2QsIHBhcmFtcy5tZXRob2QpLAogICAgICAgICAgICAgICAgICAgIGF1dGhfdHlwZT1wYXJhbXMuYXV0aF90eXBlLAogICAgICAgICAgICAgICAgICAgIGJvZHlfdHlwZT1wYXJhbXMuYm9keV90eXBlLAogICAgICAgICAgICAgICAgICAgIHJlcV9ib2R5X3R5cGU9cGFyYW1zLnJlcV9ib2R5X3R5cGUsCiAgICAgICAgICAgICAgICAgICAgc3R5bGU9cGFyYW1zLnN0eWxlLAogICAgICAgICAgICAgICAgICAgIGNyZWRlbnRpYWw9c2VsZi5fY3JlZGVudGlhbCwKICAgICAgICAgICAgICAgICAgICBzaWduYXR1cmVfdmVyc2lvbj1zZWxmLl9zaWduYXR1cmVfdmVyc2lvbiwKICAgICAgICAgICAgICAgICAgICBzaWduYXR1cmVfYWxnb3JpdGhtPXNlbGYuX3NpZ25hdHVyZV9hbGdvcml0aG0sCiAgICAgICAgICAgICAgICAgICAgdXNlcl9hZ2VudD1zZWxmLmdldF91c2VyX2FnZW50KCkKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgIGNvbmZpZ3VyYXRpb25fY29udGV4dCA9IHNwaV9tb2RlbHMuSW50ZXJjZXB0b3JDb250ZXh0Q29uZmlndXJhdGlvbigKICAgICAgICAgICAgICAgICAgICByZWdpb25faWQ9c2VsZi5fcmVnaW9uX2lkLAogICAgICAgICAgICAgICAgICAgIGVuZHBvaW50PVV0aWxDbGllbnQuZGVmYXVsdF9zdHJpbmcocmVxdWVzdC5lbmRwb2ludF9vdmVycmlkZSwgc2VsZi5fZW5kcG9pbnQpLAogICAgICAgICAgICAgICAgICAgIGVuZHBvaW50X3J1bGU9c2VsZi5fZW5kcG9pbnRfcnVsZSwKICAgICAgICAgICAgICAgICAgICBlbmRwb2ludF9tYXA9c2VsZi5fZW5kcG9pbnRfbWFwLAogICAgICAgICAgICAgICAgICAgIGVuZHBvaW50X3R5cGU9c2VsZi5fZW5kcG9pbnRfdHlwZSwKICAgICAgICAgICAgICAgICAgICBuZXR3b3JrPXNlbGYuX25ldHdvcmssCiAgICAgICAgICAgICAgICAgICAgc3VmZml4PXNlbGYuX3N1ZmZpeAogICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgaW50ZXJjZXB0b3JfY29udGV4dCA9IHNwaV9tb2RlbHMuSW50ZXJjZXB0b3JDb250ZXh0KAogICAgICAgICAgICAgICAgICAgIHJlcXVlc3Q9cmVxdWVzdF9jb250ZXh0LAogICAgICAgICAgICAgICAgICAgIGNvbmZpZ3VyYXRpb249Y29uZmlndXJhdGlvbl9jb250ZXh0CiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICBhdHRyaWJ1dGVfbWFwID0gc3BpX21vZGVscy5BdHRyaWJ1dGVNYXAoKQogICAgICAgICAgICAgICAgIyAxLiBzcGkubW9kaWZ5Q29uZmlndXJhdGlvbihjb250ZXh0OiBTUEkuSW50ZXJjZXB0b3JDb250ZXh0LCBhdHRyaWJ1dGVNYXA6IFNQSS5BdHRyaWJ1dGVNYXApOwogICAgICAgICAgICAgICAgYXdhaXQgc2VsZi5fc3BpLm1vZGlmeV9jb25maWd1cmF0aW9uX2FzeW5jKGludGVyY2VwdG9yX2NvbnRleHQsIGF0dHJpYnV0ZV9tYXApCiAgICAgICAgICAgICAgICAjIDIuIHNwaS5tb2RpZnlSZXF1ZXN0KGNvbnRleHQ6IFNQSS5JbnRlcmNlcHRvckNvbnRleHQsIGF0dHJpYnV0ZU1hcDogU1BJLkF0dHJpYnV0ZU1hcCk7CiAgICAgICAgICAgICAgICBhd2FpdCBzZWxmLl9zcGkubW9kaWZ5X3JlcXVlc3RfYXN5bmMoaW50ZXJjZXB0b3JfY29udGV4dCwgYXR0cmlidXRlX21hcCkKICAgICAgICAgICAgICAgIF9yZXF1ZXN0LnByb3RvY29sID0gaW50ZXJjZXB0b3JfY29udGV4dC5yZXF1ZXN0LnByb3RvY29sCiAgICAgICAgICAgICAgICBfcmVxdWVzdC5tZXRob2QgPSBpbnRlcmNlcHRvcl9jb250ZXh0LnJlcXVlc3QubWV0aG9kCiAgICAgICAgICAgICAgICBfcmVxdWVzdC5wYXRobmFtZSA9IGludGVyY2VwdG9yX2NvbnRleHQucmVxdWVzdC5wYXRobmFtZQogICAgICAgICAgICAgICAgX3JlcXVlc3QucXVlcnkgPSBpbnRlcmNlcHRvcl9jb250ZXh0LnJlcXVlc3QucXVlcnkKICAgICAgICAgICAgICAgIF9yZXF1ZXN0LmJvZHkgPSBpbnRlcmNlcHRvcl9jb250ZXh0LnJlcXVlc3Quc3RyZWFtCiAgICAgICAgICAgICAgICBfcmVxdWVzdC5oZWFkZXJzID0gaW50ZXJjZXB0b3JfY29udGV4dC5yZXF1ZXN0LmhlYWRlcnMKICAgICAgICAgICAgICAgIF9sYXN0X3JlcXVlc3QgPSBfcmVxdWVzdAogICAgICAgICAgICAgICAgX3Jlc3BvbnNlID0gYXdhaXQgVGVhQ29yZS5hc3luY19kb19hY3Rpb24oX3JlcXVlc3QsIF9ydW50aW1lKQogICAgICAgICAgICAgICAgcmVzcG9uc2VfY29udGV4dCA9IHNwaV9tb2RlbHMuSW50ZXJjZXB0b3JDb250ZXh0UmVzcG9uc2UoCiAgICAgICAgICAgICAgICAgICAgc3RhdHVzX2NvZGU9X3Jlc3BvbnNlLnN0YXR1c19jb2RlLAogICAgICAgICAgICAgICAgICAgIGhlYWRlcnM9X3Jlc3BvbnNlLmhlYWRlcnMsCiAgICAgICAgICAgICAgICAgICAgYm9keT1fcmVzcG9uc2UuYm9keQogICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgaW50ZXJjZXB0b3JfY29udGV4dC5yZXNwb25zZSA9IHJlc3BvbnNlX2NvbnRleHQKICAgICAgICAgICAgICAgICMgMy4gc3BpLm1vZGlmeVJlc3BvbnNlKGNvbnRleHQ6IFNQSS5JbnRlcmNlcHRvckNvbnRleHQsIGF0dHJpYnV0ZU1hcDogU1BJLkF0dHJpYnV0ZU1hcCk7CiAgICAgICAgICAgICAgICBhd2FpdCBzZWxmLl9zcGkubW9kaWZ5X3Jlc3BvbnNlX2FzeW5jKGludGVyY2VwdG9yX2NvbnRleHQsIGF0dHJpYnV0ZV9tYXApCiAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICAgICdoZWFkZXJzJzogaW50ZXJjZXB0b3JfY29udGV4dC5yZXNwb25zZS5oZWFkZXJzLAogICAgICAgICAgICAgICAgICAgICdzdGF0dXNDb2RlJzogaW50ZXJjZXB0b3JfY29udGV4dC5yZXNwb25zZS5zdGF0dXNfY29kZSwKICAgICAgICAgICAgICAgICAgICAnYm9keSc6IGludGVyY2VwdG9yX2NvbnRleHQucmVzcG9uc2UuZGVzZXJpYWxpemVkX2JvZHkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgaWYgVGVhQ29yZS5pc19yZXRyeWFibGUoZSk6CiAgICAgICAgICAgICAgICAgICAgX2xhc3RfZXhjZXB0aW9uID0gZQogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICByYWlzZSBlCiAgICAgICAgcmFpc2UgVW5yZXRyeWFibGVFeGNlcHRpb24oX2xhc3RfcmVxdWVzdCwgX2xhc3RfZXhjZXB0aW9uKQoKICAgIGRlZiBjYWxsX2FwaSgKICAgICAgICBzZWxmLAogICAgICAgIHBhcmFtczogb3Blbl9hcGlfbW9kZWxzLlBhcmFtcywKICAgICAgICByZXF1ZXN0OiBvcGVuX2FwaV9tb2RlbHMuT3BlbkFwaVJlcXVlc3QsCiAgICAgICAgcnVudGltZTogdXRpbF9tb2RlbHMuUnVudGltZU9wdGlvbnMsCiAgICApIC0+IGRpY3Q6CiAgICAgICAgaWYgVXRpbENsaWVudC5pc191bnNldChwYXJhbXMpOgogICAgICAgICAgICByYWlzZSBUZWFFeGNlcHRpb24oewogICAgICAgICAgICAgICAgJ2NvZGUnOiAnUGFyYW1ldGVyTWlzc2luZycsCiAgICAgICAgICAgICAgICAnbWVzc2FnZSc6ICIncGFyYW1zJyBjYW4gbm90IGJlIHVuc2V0IgogICAgICAgICAgICB9KQogICAgICAgIGlmIFV0aWxDbGllbnQuaXNfdW5zZXQoc2VsZi5fc2lnbmF0dXJlX2FsZ29yaXRobSkgb3Igbm90IFV0aWxDbGllbnQuZXF1YWxfc3RyaW5nKHNlbGYuX3NpZ25hdHVyZV9hbGdvcml0aG0sICd2MicpOgogICAgICAgICAgICByZXR1cm4gc2VsZi5kb19yZXF1ZXN0KHBhcmFtcywgcmVxdWVzdCwgcnVudGltZSkKICAgICAgICBlbGlmIFV0aWxDbGllbnQuZXF1YWxfc3RyaW5nKHBhcmFtcy5zdHlsZSwgJ1JPQScpIGFuZCBVdGlsQ2xpZW50LmVxdWFsX3N0cmluZyhwYXJhbXMucmVxX2JvZHlfdHlwZSwgJ2pzb24nKToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuZG9fcm9hcmVxdWVzdChwYXJhbXMuYWN0aW9uLCBwYXJhbXMudmVyc2lvbiwgcGFyYW1zLnByb3RvY29sLCBwYXJhbXMubWV0aG9kLCBwYXJhbXMuYXV0aF90eXBlLCBwYXJhbXMucGF0aG5hbWUsIHBhcmFtcy5ib2R5X3R5cGUsIHJlcXVlc3QsIHJ1bnRpbWUpCiAgICAgICAgZWxpZiBVdGlsQ2xpZW50LmVxdWFsX3N0cmluZyhwYXJhbXMuc3R5bGUsICdST0EnKToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuZG9fcm9hcmVxdWVzdF93aXRoX2Zvcm0ocGFyYW1zLmFjdGlvbiwgcGFyYW1zLnZlcnNpb24sIHBhcmFtcy5wcm90b2NvbCwgcGFyYW1zLm1ldGhvZCwgcGFyYW1zLmF1dGhfdHlwZSwgcGFyYW1zLnBhdGhuYW1lLCBwYXJhbXMuYm9keV90eXBlLCByZXF1ZXN0LCBydW50aW1lKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLmRvX3JwY3JlcXVlc3QocGFyYW1zLmFjdGlvbiwgcGFyYW1zLnZlcnNpb24sIHBhcmFtcy5wcm90b2NvbCwgcGFyYW1zLm1ldGhvZCwgcGFyYW1zLmF1dGhfdHlwZSwgcGFyYW1zLmJvZHlfdHlwZSwgcmVxdWVzdCwgcnVudGltZSkKCiAgICBhc3luYyBkZWYgY2FsbF9hcGlfYXN5bmMoCiAgICAgICAgc2VsZiwKICAgICAgICBwYXJhbXM6IG9wZW5fYXBpX21vZGVscy5QYXJhbXMsCiAgICAgICAgcmVxdWVzdDogb3Blbl9hcGlfbW9kZWxzLk9wZW5BcGlSZXF1ZXN0LAogICAgICAgIHJ1bnRpbWU6IHV0aWxfbW9kZWxzLlJ1bnRpbWVPcHRpb25zLAogICAgKSAtPiBkaWN0OgogICAgICAgIGlmIFV0aWxDbGllbnQuaXNfdW5zZXQocGFyYW1zKToKICAgICAgICAgICAgcmFpc2UgVGVhRXhjZXB0aW9uKHsKICAgICAgICAgICAgICAgICdjb2RlJzogJ1BhcmFtZXRlck1pc3NpbmcnLAogICAgICAgICAgICAgICAgJ21lc3NhZ2UnOiAiJ3BhcmFtcycgY2FuIG5vdCBiZSB1bnNldCIKICAgICAgICAgICAgfSkKICAgICAgICBpZiBVdGlsQ2xpZW50LmlzX3Vuc2V0KHNlbGYuX3NpZ25hdHVyZV9hbGdvcml0aG0pIG9yIG5vdCBVdGlsQ2xpZW50LmVxdWFsX3N0cmluZyhzZWxmLl9zaWduYXR1cmVfYWxnb3JpdGhtLCAndjInKToKICAgICAgICAgICAgcmV0dXJuIGF3YWl0IHNlbGYuZG9fcmVxdWVzdF9hc3luYyhwYXJhbXMsIHJlcXVlc3QsIHJ1bnRpbWUpCiAgICAgICAgZWxpZiBVdGlsQ2xpZW50LmVxdWFsX3N0cmluZyhwYXJhbXMuc3R5bGUsICdST0EnKSBhbmQgVXRpbENsaWVudC5lcXVhbF9zdHJpbmcocGFyYW1zLnJlcV9ib2R5X3R5cGUsICdqc29uJyk6CiAgICAgICAgICAgIHJldHVybiBhd2FpdCBzZWxmLmRvX3JvYXJlcXVlc3RfYXN5bmMocGFyYW1zLmFjdGlvbiwgcGFyYW1zLnZlcnNpb24sIHBhcmFtcy5wcm90b2NvbCwgcGFyYW1zLm1ldGhvZCwgcGFyYW1zLmF1dGhfdHlwZSwgcGFyYW1zLnBhdGhuYW1lLCBwYXJhbXMuYm9keV90eXBlLCByZXF1ZXN0LCBydW50aW1lKQogICAgICAgIGVsaWYgVXRpbENsaWVudC5lcXVhbF9zdHJpbmcocGFyYW1zLnN0eWxlLCAnUk9BJyk6CiAgICAgICAgICAgIHJldHVybiBhd2FpdCBzZWxmLmRvX3JvYXJlcXVlc3Rfd2l0aF9mb3JtX2FzeW5jKHBhcmFtcy5hY3Rpb24sIHBhcmFtcy52ZXJzaW9uLCBwYXJhbXMucHJvdG9jb2wsIHBhcmFtcy5tZXRob2QsIHBhcmFtcy5hdXRoX3R5cGUsIHBhcmFtcy5wYXRobmFtZSwgcGFyYW1zLmJvZHlfdHlwZSwgcmVxdWVzdCwgcnVudGltZSkKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gYXdhaXQgc2VsZi5kb19ycGNyZXF1ZXN0X2FzeW5jKHBhcmFtcy5hY3Rpb24sIHBhcmFtcy52ZXJzaW9uLCBwYXJhbXMucHJvdG9jb2wsIHBhcmFtcy5tZXRob2QsIHBhcmFtcy5hdXRoX3R5cGUsIHBhcmFtcy5ib2R5X3R5cGUsIHJlcXVlc3QsIHJ1bnRpbWUpCgogICAgZGVmIGdldF91c2VyX2FnZW50KHNlbGYpIC0+IHN0cjoKICAgICAgICAiIiIKICAgICAgICBHZXQgdXNlciBhZ2VudAogICAgICAgIEByZXR1cm46IHVzZXIgYWdlbnQKICAgICAgICAiIiIKICAgICAgICB1c2VyX2FnZW50ID0gVXRpbENsaWVudC5nZXRfdXNlcl9hZ2VudChzZWxmLl91c2VyX2FnZW50KQogICAgICAgIHJldHVybiB1c2VyX2FnZW50CgogICAgZGVmIGdldF9hY2Nlc3Nfa2V5X2lkKHNlbGYpIC0+IHN0cjoKICAgICAgICAiIiIKICAgICAgICBHZXQgYWNjZXNza2V5IGlkIGJ5IHVzaW5nIGNyZWRlbnRpYWwKICAgICAgICBAcmV0dXJuOiBhY2Nlc3NrZXkgaWQKICAgICAgICAiIiIKICAgICAgICBpZiBVdGlsQ2xpZW50LmlzX3Vuc2V0KHNlbGYuX2NyZWRlbnRpYWwpOgogICAgICAgICAgICByZXR1cm4gJycKICAgICAgICBhY2Nlc3Nfa2V5X2lkID0gc2VsZi5fY3JlZGVudGlhbC5nZXRfYWNjZXNzX2tleV9pZCgpCiAgICAgICAgcmV0dXJuIGFjY2Vzc19rZXlfaWQKCiAgICBhc3luYyBkZWYgZ2V0X2FjY2Vzc19rZXlfaWRfYXN5bmMoc2VsZikgLT4gc3RyOgogICAgICAgICIiIgogICAgICAgIEdldCBhY2Nlc3NrZXkgaWQgYnkgdXNpbmcgY3JlZGVudGlhbAogICAgICAgIEByZXR1cm46IGFjY2Vzc2tleSBpZAogICAgICAgICIiIgogICAgICAgIGlmIFV0aWxDbGllbnQuaXNfdW5zZXQoc2VsZi5fY3JlZGVudGlhbCk6CiAgICAgICAgICAgIHJldHVybiAnJwogICAgICAgIGFjY2Vzc19rZXlfaWQgPSBhd2FpdCBzZWxmLl9jcmVkZW50aWFsLmdldF9hY2Nlc3Nfa2V5X2lkX2FzeW5jKCkKICAgICAgICByZXR1cm4gYWNjZXNzX2tleV9pZAoKICAgIGRlZiBnZXRfYWNjZXNzX2tleV9zZWNyZXQoc2VsZikgLT4gc3RyOgogICAgICAgICIiIgogICAgICAgIEdldCBhY2Nlc3NrZXkgc2VjcmV0IGJ5IHVzaW5nIGNyZWRlbnRpYWwKICAgICAgICBAcmV0dXJuOiBhY2Nlc3NrZXkgc2VjcmV0CiAgICAgICAgIiIiCiAgICAgICAgaWYgVXRpbENsaWVudC5pc191bnNldChzZWxmLl9jcmVkZW50aWFsKToKICAgICAgICAgICAgcmV0dXJuICcnCiAgICAgICAgc2VjcmV0ID0gc2VsZi5fY3JlZGVudGlhbC5nZXRfYWNjZXNzX2tleV9zZWNyZXQoKQogICAgICAgIHJldHVybiBzZWNyZXQKCiAgICBhc3luYyBkZWYgZ2V0X2FjY2Vzc19rZXlfc2VjcmV0X2FzeW5jKHNlbGYpIC0+IHN0cjoKICAgICAgICAiIiIKICAgICAgICBHZXQgYWNjZXNza2V5IHNlY3JldCBieSB1c2luZyBjcmVkZW50aWFsCiAgICAgICAgQHJldHVybjogYWNjZXNza2V5IHNlY3JldAogICAgICAgICIiIgogICAgICAgIGlmIFV0aWxDbGllbnQuaXNfdW5zZXQoc2VsZi5fY3JlZGVudGlhbCk6CiAgICAgICAgICAgIHJldHVybiAnJwogICAgICAgIHNlY3JldCA9IGF3YWl0IHNlbGYuX2NyZWRlbnRpYWwuZ2V0X2FjY2Vzc19rZXlfc2VjcmV0X2FzeW5jKCkKICAgICAgICByZXR1cm4gc2VjcmV0CgogICAgZGVmIGdldF9zZWN1cml0eV90b2tlbihzZWxmKSAtPiBzdHI6CiAgICAgICAgIiIiCiAgICAgICAgR2V0IHNlY3VyaXR5IHRva2VuIGJ5IHVzaW5nIGNyZWRlbnRpYWwKICAgICAgICBAcmV0dXJuOiBzZWN1cml0eSB0b2tlbgogICAgICAgICIiIgogICAgICAgIGlmIFV0aWxDbGllbnQuaXNfdW5zZXQoc2VsZi5fY3JlZGVudGlhbCk6CiAgICAgICAgICAgIHJldHVybiAnJwogICAgICAgIHRva2VuID0gc2VsZi5fY3JlZGVudGlhbC5nZXRfc2VjdXJpdHlfdG9rZW4oKQogICAgICAgIHJldHVybiB0b2tlbgoKICAgIGFzeW5jIGRlZiBnZXRfc2VjdXJpdHlfdG9rZW5fYXN5bmMoc2VsZikgLT4gc3RyOgogICAgICAgICIiIgogICAgICAgIEdldCBzZWN1cml0eSB0b2tlbiBieSB1c2luZyBjcmVkZW50aWFsCiAgICAgICAgQHJldHVybjogc2VjdXJpdHkgdG9rZW4KICAgICAgICAiIiIKICAgICAgICBpZiBVdGlsQ2xpZW50LmlzX3Vuc2V0KHNlbGYuX2NyZWRlbnRpYWwpOgogICAgICAgICAgICByZXR1cm4gJycKICAgICAgICB0b2tlbiA9IGF3YWl0IHNlbGYuX2NyZWRlbnRpYWwuZ2V0X3NlY3VyaXR5X3Rva2VuX2FzeW5jKCkKICAgICAgICByZXR1cm4gdG9rZW4KCiAgICBkZWYgZ2V0X2JlYXJlcl90b2tlbihzZWxmKSAtPiBzdHI6CiAgICAgICAgIiIiCiAgICAgICAgR2V0IGJlYXJlciB0b2tlbiBieSBjcmVkZW50aWFsCiAgICAgICAgQHJldHVybjogYmVhcmVyIHRva2VuCiAgICAgICAgIiIiCiAgICAgICAgaWYgVXRpbENsaWVudC5pc191bnNldChzZWxmLl9jcmVkZW50aWFsKToKICAgICAgICAgICAgcmV0dXJuICcnCiAgICAgICAgdG9rZW4gPSBzZWxmLl9jcmVkZW50aWFsLmdldF9iZWFyZXJfdG9rZW4oKQogICAgICAgIHJldHVybiB0b2tlbgoKICAgIGFzeW5jIGRlZiBnZXRfYmVhcmVyX3Rva2VuX2FzeW5jKHNlbGYpIC0+IHN0cjoKICAgICAgICAiIiIKICAgICAgICBHZXQgYmVhcmVyIHRva2VuIGJ5IGNyZWRlbnRpYWwKICAgICAgICBAcmV0dXJuOiBiZWFyZXIgdG9rZW4KICAgICAgICAiIiIKICAgICAgICBpZiBVdGlsQ2xpZW50LmlzX3Vuc2V0KHNlbGYuX2NyZWRlbnRpYWwpOgogICAgICAgICAgICByZXR1cm4gJycKICAgICAgICB0b2tlbiA9IHNlbGYuX2NyZWRlbnRpYWwuZ2V0X2JlYXJlcl90b2tlbigpCiAgICAgICAgcmV0dXJuIHRva2VuCgogICAgZGVmIGdldF90eXBlKHNlbGYpIC0+IHN0cjoKICAgICAgICAiIiIKICAgICAgICBHZXQgY3JlZGVudGlhbCB0eXBlIGJ5IGNyZWRlbnRpYWwKICAgICAgICBAcmV0dXJuOiBjcmVkZW50aWFsIHR5cGUgZS5nLiBhY2Nlc3Nfa2V5CiAgICAgICAgIiIiCiAgICAgICAgaWYgVXRpbENsaWVudC5pc191bnNldChzZWxmLl9jcmVkZW50aWFsKToKICAgICAgICAgICAgcmV0dXJuICcnCiAgICAgICAgYXV0aF90eXBlID0gc2VsZi5fY3JlZGVudGlhbC5nZXRfdHlwZSgpCiAgICAgICAgcmV0dXJuIGF1dGhfdHlwZQoKICAgIGFzeW5jIGRlZiBnZXRfdHlwZV9hc3luYyhzZWxmKSAtPiBzdHI6CiAgICAgICAgIiIiCiAgICAgICAgR2V0IGNyZWRlbnRpYWwgdHlwZSBieSBjcmVkZW50aWFsCiAgICAgICAgQHJldHVybjogY3JlZGVudGlhbCB0eXBlIGUuZy4gYWNjZXNzX2tleQogICAgICAgICIiIgogICAgICAgIGlmIFV0aWxDbGllbnQuaXNfdW5zZXQoc2VsZi5fY3JlZGVudGlhbCk6CiAgICAgICAgICAgIHJldHVybiAnJwogICAgICAgIGF1dGhfdHlwZSA9IHNlbGYuX2NyZWRlbnRpYWwuZ2V0X3R5cGUoKQogICAgICAgIHJldHVybiBhdXRoX3R5cGUKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgZGVmYXVsdF9hbnkoCiAgICAgICAgaW5wdXRfdmFsdWU6IEFueSwKICAgICAgICBkZWZhdWx0X3ZhbHVlOiBBbnksCiAgICApIC0+IEFueToKICAgICAgICAiIiIKICAgICAgICBJZiBpbnB1dFZhbHVlIGlzIG5vdCBudWxsLCByZXR1cm4gaXQgb3IgcmV0dXJuIGRlZmF1bHRWYWx1ZQogICAgICAgIEBwYXJhbSBpbnB1dF92YWx1ZTogIHVzZXJzIGlucHV0IHZhbHVlCiAgICAgICAgQHBhcmFtIGRlZmF1bHRfdmFsdWU6IGRlZmF1bHQgdmFsdWUKICAgICAgICBAcmV0dXJuOiB0aGUgZmluYWwgcmVzdWx0CiAgICAgICAgIiIiCiAgICAgICAgaWYgVXRpbENsaWVudC5pc191bnNldChpbnB1dF92YWx1ZSk6CiAgICAgICAgICAgIHJldHVybiBkZWZhdWx0X3ZhbHVlCiAgICAgICAgcmV0dXJuIGlucHV0X3ZhbHVlCgogICAgZGVmIGNoZWNrX2NvbmZpZygKICAgICAgICBzZWxmLAogICAgICAgIGNvbmZpZzogb3Blbl9hcGlfbW9kZWxzLkNvbmZpZywKICAgICkgLT4gTm9uZToKICAgICAgICAiIiIKICAgICAgICBJZiB0aGUgZW5kcG9pbnRSdWxlIGFuZCBjb25maWcuZW5kcG9pbnQgYXJlIGVtcHR5LCB0aHJvdyBlcnJvcgogICAgICAgIEBwYXJhbSBjb25maWc6IGNvbmZpZyBjb250YWlucyB0aGUgbmVjZXNzYXJ5IGluZm9ybWF0aW9uIHRvIGNyZWF0ZSBhIGNsaWVudAogICAgICAgICIiIgogICAgICAgIGlmIFV0aWxDbGllbnQuZW1wdHkoc2VsZi5fZW5kcG9pbnRfcnVsZSkgYW5kIFV0aWxDbGllbnQuZW1wdHkoY29uZmlnLmVuZHBvaW50KToKICAgICAgICAgICAgcmFpc2UgVGVhRXhjZXB0aW9uKHsKICAgICAgICAgICAgICAgICdjb2RlJzogJ1BhcmFtZXRlck1pc3NpbmcnLAogICAgICAgICAgICAgICAgJ21lc3NhZ2UnOiAiJ2NvbmZpZy5lbmRwb2ludCcgY2FuIG5vdCBiZSBlbXB0eSIKICAgICAgICAgICAgfSkKCiAgICBkZWYgc2V0X2dhdGV3YXlfY2xpZW50KAogICAgICAgIHNlbGYsCiAgICAgICAgc3BpOiBTUElDbGllbnQsCiAgICApIC0+IE5vbmU6CiAgICAgICAgIiIiCiAgICAgICAgc2V0IGdhdGV3YXkgY2xpZW50CiAgICAgICAgQHBhcmFtIHNwaS46CiAgICAgICAgIiIiCiAgICAgICAgc2VsZi5fc3BpID0gc3BpCgogICAgZGVmIHNldF9ycGNfaGVhZGVycygKICAgICAgICBzZWxmLAogICAgICAgIGhlYWRlcnM6IERpY3Rbc3RyLCBzdHJdLAogICAgKSAtPiBOb25lOgogICAgICAgICIiIgogICAgICAgIHNldCBSUEMgaGVhZGVyIGZvciBkZWJ1ZwogICAgICAgIEBwYXJhbSBoZWFkZXJzOiBoZWFkZXJzIGZvciBkZWJ1ZywgdGhpcyBoZWFkZXIgY2FuIGJlIHVzZWQgb25seSBvbmNlLgogICAgICAgICIiIgogICAgICAgIHNlbGYuX2hlYWRlcnMgPSBoZWFkZXJzCgogICAgZGVmIGdldF9ycGNfaGVhZGVycyhzZWxmKSAtPiBEaWN0W3N0ciwgc3RyXToKICAgICAgICAiIiIKICAgICAgICBnZXQgUlBDIGhlYWRlciBmb3IgZGVidWcKICAgICAgICAiIiIKICAgICAgICBoZWFkZXJzID0gc2VsZi5faGVhZGVycwogICAgICAgIHNlbGYuX2hlYWRlcnMgPSBOb25lCiAgICAgICAgcmV0dXJuIGhlYWRlcnMK
