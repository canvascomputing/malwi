statistics:
  total_files: 1
  skipped_files: 0.0
  processed_objects: 1
  malicious_objects: 0
details:
- path: .repo_cache/malicious_repos/pypi_malregistry/pycryptoenv/1.0.7/pycryptoenv-1.0.7/pycryptoenv-1.0.7/pycryptoenv/_mac/asymmetric.py
  contents:
  - name: PublicKey.__init__
    score: 0.0
    code: |-
      def __init__(self, sec_key_ref, asn1):
              """
              :param sec_key_ref:
                  A Security framework SecKeyRef value from loading/importing the
                  key

              :param asn1:
                  An asn1crypto.keys.PublicKeyInfo object
              """

              self.sec_key_ref = sec_key_ref
              self.asn1 = asn1
              self._lib = CoreFoundation
    tokens: resume load_fast sec_key_ref load_fast self store_attr sec_key_ref load_fast asn1 load_fast self store_attr asn1 load_global CoreFoundation load_fast self store_attr _lib return_const None
    hash: c97119f0a538ec7e0f056d59cfa4f031753aab7a6dc87b74226917489ff4f6e4
sources:
  ? .repo_cache/malicious_repos/pypi_malregistry/pycryptoenv/1.0.7/pycryptoenv-1.0.7/pycryptoenv-1.0.7/pycryptoenv/_mac/asymmetric.py
  : IyBjb2Rpbmc6IHV0Zi04CmZyb20gX19mdXR1cmVfXyBpbXBvcnQgdW5pY29kZV9saXRlcmFscywgZGl2aXNpb24sIGFic29sdXRlX2ltcG9ydCwgcHJpbnRfZnVuY3Rpb24KZnJvbSBiYXNlNjQgaW1wb3J0IGIzMmVuY29kZQppbXBvcnQgb3MKaW1wb3J0IHNodXRpbAppbXBvcnQgdGVtcGZpbGUKCmZyb20gLi5fYXNuMSBpbXBvcnQgKAogICAgQ2VydGlmaWNhdGUgYXMgQXNuMUNlcnRpZmljYXRlLAogICAgRUNEb21haW5QYXJhbWV0ZXJzLAogICAgSW50ZWdlciwKICAgIEtleUV4Y2hhbmdlQWxnb3JpdGhtLAogICAgTnVsbCwKICAgIFByaXZhdGVLZXlJbmZvLAogICAgUHVibGljS2V5QWxnb3JpdGhtLAogICAgUHVibGljS2V5SW5mbywKICAgIFJTQVB1YmxpY0tleSwKKQpmcm9tIC4uX2FzeW1tZXRyaWMgaW1wb3J0ICgKICAgIF9DZXJ0aWZpY2F0ZUJhc2UsCiAgICBfZmluZ2VycHJpbnQsCiAgICBfcGFyc2VfcGtjczEyLAogICAgX1ByaXZhdGVLZXlCYXNlLAogICAgX1B1YmxpY0tleUJhc2UsCiAgICBfdW53cmFwX3ByaXZhdGVfa2V5X2luZm8sCiAgICBwYXJzZV9jZXJ0aWZpY2F0ZSwKICAgIHBhcnNlX3ByaXZhdGUsCiAgICBwYXJzZV9wdWJsaWMsCikKZnJvbSAuLl9lcnJvcnMgaW1wb3J0IHByZXR0eV9tZXNzYWdlCmZyb20gLi5fZmZpIGltcG9ydCBuZXcsIHVud3JhcCwgYnl0ZXNfZnJvbV9idWZmZXIsIGJ1ZmZlcl9mcm9tX2J5dGVzLCBkZXJlZiwgbnVsbCwgaXNfbnVsbCwgcG9pbnRlcl9zZXQKZnJvbSAuX3NlY3VyaXR5IGltcG9ydCBTZWN1cml0eSwgU2VjdXJpdHlDb25zdCwgaGFuZGxlX3NlY19lcnJvciwgb3N4X3ZlcnNpb25faW5mbwpmcm9tIC5fY29yZV9mb3VuZGF0aW9uIGltcG9ydCBDb3JlRm91bmRhdGlvbiwgQ0ZIZWxwZXJzLCBoYW5kbGVfY2ZfZXJyb3IKZnJvbSAudXRpbCBpbXBvcnQgcmFuZF9ieXRlcwpmcm9tIC4uZXJyb3JzIGltcG9ydCBBc3ltbWV0cmljS2V5RXJyb3IsIEluY29tcGxldGVBc3ltbWV0cmljS2V5RXJyb3IsIFNpZ25hdHVyZUVycm9yCmZyb20gLi5fcGtjczEgaW1wb3J0IGFkZF9wc3NfcGFkZGluZywgdmVyaWZ5X3Bzc19wYWRkaW5nLCByZW1vdmVfcGtjczF2MTVfZW5jcnlwdGlvbl9wYWRkaW5nCmZyb20gLi5fdHlwZXMgaW1wb3J0IHR5cGVfbmFtZSwgc3RyX2NscywgYnl0ZV9jbHMsIGludF90eXBlcwoKCl9fYWxsX18gPSBbCiAgICAnQ2VydGlmaWNhdGUnLAogICAgJ2RzYV9zaWduJywKICAgICdkc2FfdmVyaWZ5JywKICAgICdlY2RzYV9zaWduJywKICAgICdlY2RzYV92ZXJpZnknLAogICAgJ2dlbmVyYXRlX3BhaXInLAogICAgJ2xvYWRfY2VydGlmaWNhdGUnLAogICAgJ2xvYWRfcGtjczEyJywKICAgICdsb2FkX3ByaXZhdGVfa2V5JywKICAgICdsb2FkX3B1YmxpY19rZXknLAogICAgJ3BhcnNlX3BrY3MxMicsCiAgICAnUHJpdmF0ZUtleScsCiAgICAnUHVibGljS2V5JywKICAgICdyc2Ffb2FlcF9kZWNyeXB0JywKICAgICdyc2Ffb2FlcF9lbmNyeXB0JywKICAgICdyc2FfcGtjczF2MTVfZGVjcnlwdCcsCiAgICAncnNhX3BrY3MxdjE1X2VuY3J5cHQnLAogICAgJ3JzYV9wa2NzMXYxNV9zaWduJywKICAgICdyc2FfcGtjczF2MTVfdmVyaWZ5JywKICAgICdyc2FfcHNzX3NpZ24nLAogICAgJ3JzYV9wc3NfdmVyaWZ5JywKXQoKCmNsYXNzIFByaXZhdGVLZXkoX1ByaXZhdGVLZXlCYXNlKToKICAgICIiIgogICAgQ29udGFpbmVyIGZvciB0aGUgT1MgY3J5cHRvIGxpYnJhcnkgcmVwcmVzZW50YXRpb24gb2YgYSBwcml2YXRlIGtleQogICAgIiIiCgogICAgc2VjX2tleV9yZWYgPSBOb25lCiAgICBfcHVibGljX2tleSA9IE5vbmUKCiAgICAjIEEgcmVmZXJlbmNlIHRvIHRoZSBsaWJyYXJ5IHVzZWQgaW4gdGhlIGRlc3RydWN0b3IgdG8gbWFrZSBzdXJlIGl0IGhhc24ndAogICAgIyBiZWVuIGdhcmJhZ2UgY29sbGVjdGVkIGJ5IHRoZSB0aW1lIHRoaXMgb2JqZWN0IGlzIGdhcmJhZ2UgY29sbGVjdGVkCiAgICBfbGliID0gTm9uZQoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBzZWNfa2V5X3JlZiwgYXNuMSk6CiAgICAgICAgIiIiCiAgICAgICAgOnBhcmFtIHNlY19rZXlfcmVmOgogICAgICAgICAgICBBIFNlY3VyaXR5IGZyYW1ld29yayBTZWNLZXlSZWYgdmFsdWUgZnJvbSBsb2FkaW5nL2ltcG9ydGluZyB0aGUKICAgICAgICAgICAga2V5CgogICAgICAgIDpwYXJhbSBhc24xOgogICAgICAgICAgICBBbiBhc24xY3J5cHRvLmtleXMuUHJpdmF0ZUtleUluZm8gb2JqZWN0CiAgICAgICAgIiIiCgogICAgICAgIHNlbGYuc2VjX2tleV9yZWYgPSBzZWNfa2V5X3JlZgogICAgICAgIHNlbGYuYXNuMSA9IGFzbjEKICAgICAgICBzZWxmLl9saWIgPSBDb3JlRm91bmRhdGlvbgoKICAgIEBwcm9wZXJ0eQogICAgZGVmIHB1YmxpY19rZXkoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgOnJldHVybjoKICAgICAgICAgICAgQSBQdWJsaWNLZXkgb2JqZWN0IGNvcnJlc3BvbmRpbmcgdG8gdGhpcyBwcml2YXRlIGtleS4KICAgICAgICAiIiIKCiAgICAgICAgaWYgc2VsZi5fcHVibGljX2tleSBpcyBOb25lOgogICAgICAgICAgICBjZl9kYXRhX3ByaXZhdGUgPSBOb25lCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICMgV2UgZXhwb3J0IGhlcmUgc28gdGhhdCBTZWN1cml0eS5mcmFtZXdvcmsgd2lsbCBmaWxsIGluIHRoZSBFQwogICAgICAgICAgICAgICAgIyBwdWJsaWMga2V5IGZvciB1cywgaW5zdGVhZCBvZiB1cyBoYXZpbmcgdG8gY29tcHV0ZSBpdAogICAgICAgICAgICAgICAgY2ZfZGF0YV9wcml2YXRlX3BvaW50ZXIgPSBuZXcoQ29yZUZvdW5kYXRpb24sICdDRkRhdGFSZWYgKicpCiAgICAgICAgICAgICAgICByZXN1bHQgPSBTZWN1cml0eS5TZWNJdGVtRXhwb3J0KHNlbGYuc2VjX2tleV9yZWYsIDAsIDAsIG51bGwoKSwgY2ZfZGF0YV9wcml2YXRlX3BvaW50ZXIpCiAgICAgICAgICAgICAgICBoYW5kbGVfc2VjX2Vycm9yKHJlc3VsdCkKICAgICAgICAgICAgICAgIGNmX2RhdGFfcHJpdmF0ZSA9IHVud3JhcChjZl9kYXRhX3ByaXZhdGVfcG9pbnRlcikKICAgICAgICAgICAgICAgIHByaXZhdGVfa2V5X2J5dGVzID0gQ0ZIZWxwZXJzLmNmX2RhdGFfdG9fYnl0ZXMoY2ZfZGF0YV9wcml2YXRlKQoKICAgICAgICAgICAgICAgIGtleSA9IHBhcnNlX3ByaXZhdGUocHJpdmF0ZV9rZXlfYnl0ZXMpCgogICAgICAgICAgICAgICAgaWYga2V5LmFsZ29yaXRobSA9PSAncnNhJzoKICAgICAgICAgICAgICAgICAgICBwdWJsaWNfYXNuMSA9IFB1YmxpY0tleUluZm8oewogICAgICAgICAgICAgICAgICAgICAgICAnYWxnb3JpdGhtJzogUHVibGljS2V5QWxnb3JpdGhtKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICdhbGdvcml0aG0nOiAncnNhJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICdwYXJhbWV0ZXJzJzogTnVsbCgpCiAgICAgICAgICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgICAgICAgICAncHVibGljX2tleSc6IFJTQVB1YmxpY0tleSh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnbW9kdWx1cyc6IGtleVsncHJpdmF0ZV9rZXknXS5wYXJzZWRbJ21vZHVsdXMnXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICdwdWJsaWNfZXhwb25lbnQnOiBrZXlbJ3ByaXZhdGVfa2V5J10ucGFyc2VkWydwdWJsaWNfZXhwb25lbnQnXSwKICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICB9KQoKICAgICAgICAgICAgICAgIGVsaWYga2V5LmFsZ29yaXRobSA9PSAnZHNhJzoKICAgICAgICAgICAgICAgICAgICBwYXJhbXMgPSBrZXlbJ3ByaXZhdGVfa2V5X2FsZ29yaXRobSddWydwYXJhbWV0ZXJzJ10KICAgICAgICAgICAgICAgICAgICBwdWJsaWNfYXNuMSA9IFB1YmxpY0tleUluZm8oewogICAgICAgICAgICAgICAgICAgICAgICAnYWxnb3JpdGhtJzogUHVibGljS2V5QWxnb3JpdGhtKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICdhbGdvcml0aG0nOiAnZHNhJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICdwYXJhbWV0ZXJzJzogcGFyYW1zLmNvcHkoKQogICAgICAgICAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgICAgICAgICAgJ3B1YmxpY19rZXknOiBJbnRlZ2VyKHBvdygKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcmFtc1snZyddLm5hdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtleVsncHJpdmF0ZV9rZXknXS5wYXJzZWQubmF0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyYW1zWydwJ10ubmF0aXZlCiAgICAgICAgICAgICAgICAgICAgICAgICkpCiAgICAgICAgICAgICAgICAgICAgfSkKCiAgICAgICAgICAgICAgICBlbGlmIGtleS5hbGdvcml0aG0gPT0gJ2VjJzoKICAgICAgICAgICAgICAgICAgICBwdWJsaWNfYXNuMSA9IFB1YmxpY0tleUluZm8oewogICAgICAgICAgICAgICAgICAgICAgICAnYWxnb3JpdGhtJzogUHVibGljS2V5QWxnb3JpdGhtKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICdhbGdvcml0aG0nOiAnZWMnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3BhcmFtZXRlcnMnOiBFQ0RvbWFpblBhcmFtZXRlcnMoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZT0nbmFtZWQnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlPXNlbGYuY3VydmUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICAgICAgICAgICdwdWJsaWNfa2V5Jzoga2V5Wydwcml2YXRlX2tleSddLnBhcnNlZFsncHVibGljX2tleSddLAogICAgICAgICAgICAgICAgICAgIH0pCgogICAgICAgICAgICBmaW5hbGx5OgogICAgICAgICAgICAgICAgaWYgY2ZfZGF0YV9wcml2YXRlOgogICAgICAgICAgICAgICAgICAgIENvcmVGb3VuZGF0aW9uLkNGUmVsZWFzZShjZl9kYXRhX3ByaXZhdGUpCgogICAgICAgICAgICBzZWxmLl9wdWJsaWNfa2V5ID0gX2xvYWRfa2V5KHB1YmxpY19hc24xKQoKICAgICAgICByZXR1cm4gc2VsZi5fcHVibGljX2tleQoKICAgIEBwcm9wZXJ0eQogICAgZGVmIGZpbmdlcnByaW50KHNlbGYpOgogICAgICAgICIiIgogICAgICAgIENyZWF0ZXMgYSBmaW5nZXJwcmludCB0aGF0IGNhbiBiZSBjb21wYXJlZCB3aXRoIGEgcHVibGljIGtleSB0byBzZWUgaWYKICAgICAgICB0aGUgdHdvIGZvcm0gYSBwYWlyLgoKICAgICAgICBUaGlzIGZpbmdlcnByaW50IGlzIG5vdCBjb21wYXRpYmxlIHdpdGggZmluZ2VycHJpbnRzIGdlbmVyYXRlZCBieSBhbnkKICAgICAgICBvdGhlciBzb2Z0d2FyZS4KCiAgICAgICAgOnJldHVybjoKICAgICAgICAgICAgQSBieXRlIHN0cmluZyB0aGF0IGlzIGEgc2hhMjU2IGhhc2ggb2Ygc2VsZWN0ZWQgY29tcG9uZW50cyAoYmFzZWQKICAgICAgICAgICAgb24gdGhlIGtleSB0eXBlKQogICAgICAgICIiIgoKICAgICAgICBpZiBzZWxmLl9maW5nZXJwcmludCBpcyBOb25lOgogICAgICAgICAgICBzZWxmLl9maW5nZXJwcmludCA9IF9maW5nZXJwcmludChzZWxmLmFzbjEsIGxvYWRfcHJpdmF0ZV9rZXkpCiAgICAgICAgcmV0dXJuIHNlbGYuX2ZpbmdlcnByaW50CgogICAgZGVmIF9fZGVsX18oc2VsZik6CiAgICAgICAgaWYgc2VsZi5zZWNfa2V5X3JlZjoKICAgICAgICAgICAgc2VsZi5fbGliLkNGUmVsZWFzZShzZWxmLnNlY19rZXlfcmVmKQogICAgICAgICAgICBzZWxmLl9saWIgPSBOb25lCiAgICAgICAgICAgIHNlbGYuc2VjX2tleV9yZWYgPSBOb25lCgoKY2xhc3MgUHVibGljS2V5KF9QdWJsaWNLZXlCYXNlKToKICAgICIiIgogICAgQ29udGFpbmVyIGZvciB0aGUgT1MgY3J5cHRvIGxpYnJhcnkgcmVwcmVzZW50YXRpb24gb2YgYSBwdWJsaWMga2V5CiAgICAiIiIKCiAgICBzZWNfa2V5X3JlZiA9IE5vbmUKCiAgICAjIEEgcmVmZXJlbmNlIHRvIHRoZSBsaWJyYXJ5IHVzZWQgaW4gdGhlIGRlc3RydWN0b3IgdG8gbWFrZSBzdXJlIGl0IGhhc24ndAogICAgIyBiZWVuIGdhcmJhZ2UgY29sbGVjdGVkIGJ5IHRoZSB0aW1lIHRoaXMgb2JqZWN0IGlzIGdhcmJhZ2UgY29sbGVjdGVkCiAgICBfbGliID0gTm9uZQoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBzZWNfa2V5X3JlZiwgYXNuMSk6CiAgICAgICAgIiIiCiAgICAgICAgOnBhcmFtIHNlY19rZXlfcmVmOgogICAgICAgICAgICBBIFNlY3VyaXR5IGZyYW1ld29yayBTZWNLZXlSZWYgdmFsdWUgZnJvbSBsb2FkaW5nL2ltcG9ydGluZyB0aGUKICAgICAgICAgICAga2V5CgogICAgICAgIDpwYXJhbSBhc24xOgogICAgICAgICAgICBBbiBhc24xY3J5cHRvLmtleXMuUHVibGljS2V5SW5mbyBvYmplY3QKICAgICAgICAiIiIKCiAgICAgICAgc2VsZi5zZWNfa2V5X3JlZiA9IHNlY19rZXlfcmVmCiAgICAgICAgc2VsZi5hc24xID0gYXNuMQogICAgICAgIHNlbGYuX2xpYiA9IENvcmVGb3VuZGF0aW9uCgogICAgZGVmIF9fZGVsX18oc2VsZik6CiAgICAgICAgaWYgc2VsZi5zZWNfa2V5X3JlZjoKICAgICAgICAgICAgc2VsZi5fbGliLkNGUmVsZWFzZShzZWxmLnNlY19rZXlfcmVmKQogICAgICAgICAgICBzZWxmLl9saWIgPSBOb25lCiAgICAgICAgICAgIHNlbGYuc2VjX2tleV9yZWYgPSBOb25lCgoKY2xhc3MgQ2VydGlmaWNhdGUoX0NlcnRpZmljYXRlQmFzZSk6CiAgICAiIiIKICAgIENvbnRhaW5lciBmb3IgdGhlIE9TIGNyeXB0byBsaWJyYXJ5IHJlcHJlc2VudGF0aW9uIG9mIGEgY2VydGlmaWNhdGUKICAgICIiIgoKICAgIHNlY19jZXJ0aWZpY2F0ZV9yZWYgPSBOb25lCiAgICBfcHVibGljX2tleSA9IE5vbmUKICAgIF9zZWxmX3NpZ25lZCA9IE5vbmUKCiAgICBkZWYgX19pbml0X18oc2VsZiwgc2VjX2NlcnRpZmljYXRlX3JlZiwgYXNuMSk6CiAgICAgICAgIiIiCiAgICAgICAgOnBhcmFtIHNlY19jZXJ0aWZpY2F0ZV9yZWY6CiAgICAgICAgICAgIEEgU2VjdXJpdHkgZnJhbWV3b3JrIFNlY0NlcnRpZmljYXRlUmVmIHZhbHVlIGZyb20gbG9hZGluZy9pbXBvcnRpbmcKICAgICAgICAgICAgdGhlIGNlcnRpZmljYXRlCgogICAgICAgIDpwYXJhbSBhc24xOgogICAgICAgICAgICBBbiBhc24xY3J5cHRvLng1MDkuQ2VydGlmaWNhdGUgb2JqZWN0CiAgICAgICAgIiIiCgogICAgICAgIHNlbGYuc2VjX2NlcnRpZmljYXRlX3JlZiA9IHNlY19jZXJ0aWZpY2F0ZV9yZWYKICAgICAgICBzZWxmLmFzbjEgPSBhc24xCgogICAgQHByb3BlcnR5CiAgICBkZWYgc2VjX2tleV9yZWYoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgOnJldHVybjoKICAgICAgICAgICAgVGhlIFNlY0tleVJlZiBvZiB0aGUgcHVibGljIGtleQogICAgICAgICIiIgoKICAgICAgICByZXR1cm4gc2VsZi5wdWJsaWNfa2V5LnNlY19rZXlfcmVmCgogICAgQHByb3BlcnR5CiAgICBkZWYgcHVibGljX2tleShzZWxmKToKICAgICAgICAiIiIKICAgICAgICA6cmV0dXJuOgogICAgICAgICAgICBUaGUgUHVibGljS2V5IG9iamVjdCBmb3IgdGhlIHB1YmxpYyBrZXkgdGhpcyBjZXJ0aWZpY2F0ZSBjb250YWlucwogICAgICAgICIiIgoKICAgICAgICBpZiBub3Qgc2VsZi5fcHVibGljX2tleSBhbmQgc2VsZi5zZWNfY2VydGlmaWNhdGVfcmVmOgogICAgICAgICAgICBpZiBzZWxmLmFzbjEuc2lnbmF0dXJlX2FsZ28gPT0gInJzYXNzYV9wc3MiOgogICAgICAgICAgICAgICAgIyBtYWNPUyBkb2Vzbid0IGxpa2UgaW1wb3J0aW5nIFJTQSBQU1MgY2VydHMsIHNvIHdlIHRyZWF0IGl0IGxpa2UgYQogICAgICAgICAgICAgICAgIyB0cmFkaXRpb25hbCBSU0EgY2VydAogICAgICAgICAgICAgICAgYXNuMSA9IHNlbGYuYXNuMS5jb3B5KCkKICAgICAgICAgICAgICAgIGFzbjFbJ3Ric19jZXJ0aWZpY2F0ZSddWydzdWJqZWN0X3B1YmxpY19rZXlfaW5mbyddWydhbGdvcml0aG0nXVsnYWxnb3JpdGhtJ10gPSAncnNhJwogICAgICAgICAgICAgICAgdGVtcF9jZXJ0ID0gX2xvYWRfeDUwOShhc24xKQogICAgICAgICAgICAgICAgc2VjX2NlcnRfcmVmID0gdGVtcF9jZXJ0LnNlY19jZXJ0aWZpY2F0ZV9yZWYKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHNlY19jZXJ0X3JlZiA9IHNlbGYuc2VjX2NlcnRpZmljYXRlX3JlZgoKICAgICAgICAgICAgc2VjX3B1YmxpY19rZXlfcmVmX3BvaW50ZXIgPSBuZXcoU2VjdXJpdHksICdTZWNLZXlSZWYgKicpCiAgICAgICAgICAgIGlmIG9zeF92ZXJzaW9uX2luZm8gPj0gKDEwLCAxNCk6CiAgICAgICAgICAgICAgICBzZWNfcHVibGljX2tleV9yZWYgPSBTZWN1cml0eS5TZWNDZXJ0aWZpY2F0ZUNvcHlLZXkoc2VjX2NlcnRfcmVmKQogICAgICAgICAgICAgICAgaWYgaXNfbnVsbChzZWNfcHVibGljX2tleV9yZWYpOgogICAgICAgICAgICAgICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoJ1VuYWJsZSB0byBleHRyYWN0IHB1YmxpYyBrZXkgZnJvbSBjZXJ0aWZpY2F0ZScpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICByZXMgPSBTZWN1cml0eS5TZWNDZXJ0aWZpY2F0ZUNvcHlQdWJsaWNLZXkoc2VjX2NlcnRfcmVmLCBzZWNfcHVibGljX2tleV9yZWZfcG9pbnRlcikKICAgICAgICAgICAgICAgIGhhbmRsZV9zZWNfZXJyb3IocmVzKQogICAgICAgICAgICAgICAgc2VjX3B1YmxpY19rZXlfcmVmID0gdW53cmFwKHNlY19wdWJsaWNfa2V5X3JlZl9wb2ludGVyKQogICAgICAgICAgICBzZWxmLl9wdWJsaWNfa2V5ID0gUHVibGljS2V5KHNlY19wdWJsaWNfa2V5X3JlZiwgc2VsZi5hc24xWyd0YnNfY2VydGlmaWNhdGUnXVsnc3ViamVjdF9wdWJsaWNfa2V5X2luZm8nXSkKCiAgICAgICAgcmV0dXJuIHNlbGYuX3B1YmxpY19rZXkKCiAgICBAcHJvcGVydHkKICAgIGRlZiBzZWxmX3NpZ25lZChzZWxmKToKICAgICAgICAiIiIKICAgICAgICA6cmV0dXJuOgogICAgICAgICAgICBBIGJvb2xlYW4gLSBpZiB0aGUgY2VydGlmaWNhdGUgaXMgc2VsZi1zaWduZWQKICAgICAgICAiIiIKCiAgICAgICAgaWYgc2VsZi5fc2VsZl9zaWduZWQgaXMgTm9uZToKICAgICAgICAgICAgc2VsZi5fc2VsZl9zaWduZWQgPSBGYWxzZQogICAgICAgICAgICBpZiBzZWxmLmFzbjEuc2VsZl9zaWduZWQgaW4gc2V0KFsneWVzJywgJ21heWJlJ10pOgoKICAgICAgICAgICAgICAgIHNpZ25hdHVyZV9hbGdvID0gc2VsZi5hc24xWydzaWduYXR1cmVfYWxnb3JpdGhtJ10uc2lnbmF0dXJlX2FsZ28KICAgICAgICAgICAgICAgIGhhc2hfYWxnbyA9IHNlbGYuYXNuMVsnc2lnbmF0dXJlX2FsZ29yaXRobSddLmhhc2hfYWxnbwoKICAgICAgICAgICAgICAgIGlmIHNpZ25hdHVyZV9hbGdvID09ICdyc2Fzc2FfcGtjczF2MTUnOgogICAgICAgICAgICAgICAgICAgIHZlcmlmeV9mdW5jID0gcnNhX3BrY3MxdjE1X3ZlcmlmeQogICAgICAgICAgICAgICAgZWxpZiBzaWduYXR1cmVfYWxnbyA9PSAncnNhc3NhX3Bzcyc6CiAgICAgICAgICAgICAgICAgICAgdmVyaWZ5X2Z1bmMgPSByc2FfcHNzX3ZlcmlmeQogICAgICAgICAgICAgICAgZWxpZiBzaWduYXR1cmVfYWxnbyA9PSAnZHNhJzoKICAgICAgICAgICAgICAgICAgICB2ZXJpZnlfZnVuYyA9IGRzYV92ZXJpZnkKICAgICAgICAgICAgICAgIGVsaWYgc2lnbmF0dXJlX2FsZ28gPT0gJ2VjZHNhJzoKICAgICAgICAgICAgICAgICAgICB2ZXJpZnlfZnVuYyA9IGVjZHNhX3ZlcmlmeQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICByYWlzZSBPU0Vycm9yKHByZXR0eV9tZXNzYWdlKAogICAgICAgICAgICAgICAgICAgICAgICAnJycKICAgICAgICAgICAgICAgICAgICAgICAgVW5hYmxlIHRvIHZlcmlmeSB0aGUgc2lnbmF0dXJlIG9mIHRoZSBjZXJ0aWZpY2F0ZSBzaW5jZQogICAgICAgICAgICAgICAgICAgICAgICBpdCB1c2VzIHRoZSB1bnN1cHBvcnRlZCBhbGdvcml0aG0gJXMKICAgICAgICAgICAgICAgICAgICAgICAgJycnLAogICAgICAgICAgICAgICAgICAgICAgICBzaWduYXR1cmVfYWxnbwogICAgICAgICAgICAgICAgICAgICkpCgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIHZlcmlmeV9mdW5jKAogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnB1YmxpY19rZXksCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuYXNuMVsnc2lnbmF0dXJlX3ZhbHVlJ10ubmF0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmFzbjFbJ3Ric19jZXJ0aWZpY2F0ZSddLmR1bXAoKSwKICAgICAgICAgICAgICAgICAgICAgICAgaGFzaF9hbGdvCiAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICAgIHNlbGYuX3NlbGZfc2lnbmVkID0gVHJ1ZQogICAgICAgICAgICAgICAgZXhjZXB0IChTaWduYXR1cmVFcnJvcik6CiAgICAgICAgICAgICAgICAgICAgcGFzcwoKICAgICAgICByZXR1cm4gc2VsZi5fc2VsZl9zaWduZWQKCiAgICBkZWYgX19kZWxfXyhzZWxmKToKICAgICAgICBpZiBzZWxmLl9wdWJsaWNfa2V5OgogICAgICAgICAgICBzZWxmLl9wdWJsaWNfa2V5Ll9fZGVsX18oKQogICAgICAgICAgICBzZWxmLl9wdWJsaWNfa2V5ID0gTm9uZQoKICAgICAgICBpZiBzZWxmLnNlY19jZXJ0aWZpY2F0ZV9yZWY6CiAgICAgICAgICAgIENvcmVGb3VuZGF0aW9uLkNGUmVsZWFzZShzZWxmLnNlY19jZXJ0aWZpY2F0ZV9yZWYpCiAgICAgICAgICAgIHNlbGYuc2VjX2NlcnRpZmljYXRlX3JlZiA9IE5vbmUKCgpkZWYgZ2VuZXJhdGVfcGFpcihhbGdvcml0aG0sIGJpdF9zaXplPU5vbmUsIGN1cnZlPU5vbmUpOgogICAgIiIiCiAgICBHZW5lcmF0ZXMgYSBwdWJsaWMvcHJpdmF0ZSBrZXkgcGFpcgoKICAgIDpwYXJhbSBhbGdvcml0aG06CiAgICAgICAgVGhlIGtleSBhbGdvcml0aG0gLSAicnNhIiwgImRzYSIgb3IgImVjIgoKICAgIDpwYXJhbSBiaXRfc2l6ZToKICAgICAgICBBbiBpbnRlZ2VyIC0gdXNlZCBmb3IgInJzYSIgYW5kICJkc2EiLiBGb3IgInJzYSIgdGhlIHZhbHVlIG1heWUgYmUgMTAyNCwKICAgICAgICAyMDQ4LCAzMDcyIG9yIDQwOTYuIEZvciAiZHNhIiB0aGUgdmFsdWUgbWF5IGJlIDEwMjQuCgogICAgOnBhcmFtIGN1cnZlOgogICAgICAgIEEgdW5pY29kZSBzdHJpbmcgLSB1c2VkIGZvciAiZWMiIGtleXMuIFZhbGlkIHZhbHVlcyBpbmNsdWRlICJzZWNwMjU2cjEiLAogICAgICAgICJzZWNwMzg0cjEiIGFuZCAic2VjcDUyMXIxIi4KCiAgICA6cmFpc2VzOgogICAgICAgIFZhbHVlRXJyb3IgLSB3aGVuIGFueSBvZiB0aGUgcGFyYW1ldGVycyBjb250YWluIGFuIGludmFsaWQgdmFsdWUKICAgICAgICBUeXBlRXJyb3IgLSB3aGVuIGFueSBvZiB0aGUgcGFyYW1ldGVycyBhcmUgb2YgdGhlIHdyb25nIHR5cGUKICAgICAgICBPU0Vycm9yIC0gd2hlbiBhbiBlcnJvciBpcyByZXR1cm5lZCBieSB0aGUgT1MgY3J5cHRvIGxpYnJhcnkKCiAgICA6cmV0dXJuOgogICAgICAgIEEgMi1lbGVtZW50IHR1cGxlIG9mIChQdWJsaWNLZXksIFByaXZhdGVLZXkpLiBUaGUgY29udGVudHMgb2YgZWFjaCBrZXkKICAgICAgICBtYXkgYmUgc2F2ZWQgYnkgY2FsbGluZyAuYXNuMS5kdW1wKCkuCiAgICAiIiIKCiAgICBpZiBhbGdvcml0aG0gbm90IGluIHNldChbJ3JzYScsICdkc2EnLCAnZWMnXSk6CiAgICAgICAgcmFpc2UgVmFsdWVFcnJvcihwcmV0dHlfbWVzc2FnZSgKICAgICAgICAgICAgJycnCiAgICAgICAgICAgIGFsZ29yaXRobSBtdXN0IGJlIG9uZSBvZiAicnNhIiwgImRzYSIsICJlYyIsIG5vdCAlcwogICAgICAgICAgICAnJycsCiAgICAgICAgICAgIHJlcHIoYWxnb3JpdGhtKQogICAgICAgICkpCgogICAgaWYgYWxnb3JpdGhtID09ICdyc2EnOgogICAgICAgIGlmIGJpdF9zaXplIG5vdCBpbiBzZXQoWzEwMjQsIDIwNDgsIDMwNzIsIDQwOTZdKToKICAgICAgICAgICAgcmFpc2UgVmFsdWVFcnJvcihwcmV0dHlfbWVzc2FnZSgKICAgICAgICAgICAgICAgICcnJwogICAgICAgICAgICAgICAgYml0X3NpemUgbXVzdCBiZSBvbmUgb2YgMTAyNCwgMjA0OCwgMzA3MiwgNDA5Niwgbm90ICVzCiAgICAgICAgICAgICAgICAnJycsCiAgICAgICAgICAgICAgICByZXByKGJpdF9zaXplKQogICAgICAgICAgICApKQoKICAgIGVsaWYgYWxnb3JpdGhtID09ICdkc2EnOgogICAgICAgIGlmIGJpdF9zaXplIG5vdCBpbiBzZXQoWzEwMjRdKToKICAgICAgICAgICAgcmFpc2UgVmFsdWVFcnJvcihwcmV0dHlfbWVzc2FnZSgKICAgICAgICAgICAgICAgICcnJwogICAgICAgICAgICAgICAgYml0X3NpemUgbXVzdCBiZSAxMDI0LCBub3QgJXMKICAgICAgICAgICAgICAgICcnJywKICAgICAgICAgICAgICAgIHJlcHIoYml0X3NpemUpCiAgICAgICAgICAgICkpCgogICAgZWxpZiBhbGdvcml0aG0gPT0gJ2VjJzoKICAgICAgICBpZiBjdXJ2ZSBub3QgaW4gc2V0KFsnc2VjcDI1NnIxJywgJ3NlY3AzODRyMScsICdzZWNwNTIxcjEnXSk6CiAgICAgICAgICAgIHJhaXNlIFZhbHVlRXJyb3IocHJldHR5X21lc3NhZ2UoCiAgICAgICAgICAgICAgICAnJycKICAgICAgICAgICAgICAgIGN1cnZlIG11c3QgYmUgb25lIG9mICJzZWNwMjU2cjEiLCAic2VjcDM4NHIxIiwgInNlY3A1MjFyMSIsIG5vdCAlcwogICAgICAgICAgICAgICAgJycnLAogICAgICAgICAgICAgICAgcmVwcihjdXJ2ZSkKICAgICAgICAgICAgKSkKCiAgICBjZl9kaWN0ID0gTm9uZQogICAgcHVibGljX2tleV9yZWYgPSBOb25lCiAgICBwcml2YXRlX2tleV9yZWYgPSBOb25lCiAgICBjZl9kYXRhX3B1YmxpYyA9IE5vbmUKICAgIGNmX2RhdGFfcHJpdmF0ZSA9IE5vbmUKICAgIGNmX3N0cmluZyA9IE5vbmUKICAgIHNlY19hY2Nlc3NfcmVmID0gTm9uZQogICAgc2VjX2tleWNoYWluX3JlZiA9IE5vbmUKICAgIHRlbXBfZGlyID0gTm9uZQoKICAgIHRyeToKICAgICAgICBhbGdfaWQgPSB7CiAgICAgICAgICAgICdkc2EnOiBTZWN1cml0eUNvbnN0LkNTU01fQUxHSURfRFNBLAogICAgICAgICAgICAnZWMnOiBTZWN1cml0eUNvbnN0LkNTU01fQUxHSURfRUNEU0EsCiAgICAgICAgICAgICdyc2EnOiBTZWN1cml0eUNvbnN0LkNTU01fQUxHSURfUlNBLAogICAgICAgIH1bYWxnb3JpdGhtXQoKICAgICAgICBpZiBhbGdvcml0aG0gPT0gJ2VjJzoKICAgICAgICAgICAga2V5X3NpemUgPSB7CiAgICAgICAgICAgICAgICAnc2VjcDI1NnIxJzogMjU2LAogICAgICAgICAgICAgICAgJ3NlY3AzODRyMSc6IDM4NCwKICAgICAgICAgICAgICAgICdzZWNwNTIxcjEnOiA1MjEsCiAgICAgICAgICAgIH1bY3VydmVdCiAgICAgICAgZWxzZToKICAgICAgICAgICAga2V5X3NpemUgPSBiaXRfc2l6ZQoKICAgICAgICBwcml2YXRlX2tleV9wb2ludGVyID0gbmV3KFNlY3VyaXR5LCAnU2VjS2V5UmVmIConKQogICAgICAgIHB1YmxpY19rZXlfcG9pbnRlciA9IG5ldyhTZWN1cml0eSwgJ1NlY0tleVJlZiAqJykKCiAgICAgICAgY2Zfc3RyaW5nID0gQ0ZIZWxwZXJzLmNmX3N0cmluZ19mcm9tX3VuaWNvZGUoIlRlbXBvcmFyeSBvc2NyeXB0byBrZXkiKQoKICAgICAgICAjIFdlIHVzZWQgdG8gdXNlIFNlY0tleUdlbmVyYXRlUGFpcigpIGZvciBldmVyeXRoaW5nIGJ1dCBEU0Ega2V5cywgYnV0IGR1ZSB0byBjaGFuZ2VzCiAgICAgICAgIyBpbiBtYWNPUyBzZWN1cml0eSwgd2UgY2FuJ3QgcmVsaWFibHkgYWNjZXNzIHRoZSBkZWZhdWx0IGtleWNoYWluLCBhbmQgaW5zdGVhZAogICAgICAgICMgZ2V0IGFuICJPU0Vycm9yOiBVc2VyIGludGVyYWN0aW9uIGlzIG5vdCBhbGxvd2VkLiIgcmVzdWx0LiBCZWNhdXNlIG9mIHRoaXMgd2Ugbm93CiAgICAgICAgIyB1c2UgU2VjS2V5Q3JlYXRlUGFpcigpIGZvciBldmVyeXRoaW5nLCBidXQgd2UgZXZlbiB1c2UgYSB0aHJvdy1hd2F5IGtleWNoYWluLgogICAgICAgIHBhc3NwaHJhc2VfbGVuID0gMTYKICAgICAgICByYW5kX2RhdGEgPSByYW5kX2J5dGVzKDEwICsgcGFzc3BocmFzZV9sZW4pCiAgICAgICAgcGFzc3BocmFzZSA9IHJhbmRfZGF0YVsxMDpdCgogICAgICAgIHRlbXBfZmlsZW5hbWUgPSBiMzJlbmNvZGUocmFuZF9kYXRhWzoxMF0pLmRlY29kZSgndXRmLTgnKQogICAgICAgIHRlbXBfZGlyID0gdGVtcGZpbGUubWtkdGVtcCgpCiAgICAgICAgdGVtcF9wYXRoID0gb3MucGF0aC5qb2luKHRlbXBfZGlyLCB0ZW1wX2ZpbGVuYW1lKS5lbmNvZGUoJ3V0Zi04JykKCiAgICAgICAgc2VjX2tleWNoYWluX3JlZl9wb2ludGVyID0gbmV3KFNlY3VyaXR5LCAnU2VjS2V5Y2hhaW5SZWYgKicpCiAgICAgICAgcmVzdWx0ID0gU2VjdXJpdHkuU2VjS2V5Y2hhaW5DcmVhdGUoCiAgICAgICAgICAgIHRlbXBfcGF0aCwKICAgICAgICAgICAgcGFzc3BocmFzZV9sZW4sCiAgICAgICAgICAgIHBhc3NwaHJhc2UsCiAgICAgICAgICAgIEZhbHNlLAogICAgICAgICAgICBudWxsKCksCiAgICAgICAgICAgIHNlY19rZXljaGFpbl9yZWZfcG9pbnRlcgogICAgICAgICkKICAgICAgICBoYW5kbGVfc2VjX2Vycm9yKHJlc3VsdCkKICAgICAgICBzZWNfa2V5Y2hhaW5fcmVmID0gdW53cmFwKHNlY19rZXljaGFpbl9yZWZfcG9pbnRlcikKCiAgICAgICAgc2VjX2FjY2Vzc19yZWZfcG9pbnRlciA9IG5ldyhTZWN1cml0eSwgJ1NlY0FjY2Vzc1JlZiAqJykKICAgICAgICByZXN1bHQgPSBTZWN1cml0eS5TZWNBY2Nlc3NDcmVhdGUoY2Zfc3RyaW5nLCBudWxsKCksIHNlY19hY2Nlc3NfcmVmX3BvaW50ZXIpCiAgICAgICAgaGFuZGxlX3NlY19lcnJvcihyZXN1bHQpCiAgICAgICAgc2VjX2FjY2Vzc19yZWYgPSB1bndyYXAoc2VjX2FjY2Vzc19yZWZfcG9pbnRlcikKCiAgICAgICAgcmVzdWx0ID0gU2VjdXJpdHkuU2VjS2V5Q3JlYXRlUGFpcigKICAgICAgICAgICAgc2VjX2tleWNoYWluX3JlZiwKICAgICAgICAgICAgYWxnX2lkLAogICAgICAgICAgICBrZXlfc2l6ZSwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgU2VjdXJpdHlDb25zdC5DU1NNX0tFWVVTRV9WRVJJRlksCiAgICAgICAgICAgIFNlY3VyaXR5Q29uc3QuQ1NTTV9LRVlBVFRSX0VYVFJBQ1RBQkxFIHwgU2VjdXJpdHlDb25zdC5DU1NNX0tFWUFUVFJfUEVSTUFORU5ULAogICAgICAgICAgICBTZWN1cml0eUNvbnN0LkNTU01fS0VZVVNFX1NJR04sCiAgICAgICAgICAgIFNlY3VyaXR5Q29uc3QuQ1NTTV9LRVlBVFRSX0VYVFJBQ1RBQkxFIHwgU2VjdXJpdHlDb25zdC5DU1NNX0tFWUFUVFJfUEVSTUFORU5ULAogICAgICAgICAgICBzZWNfYWNjZXNzX3JlZiwKICAgICAgICAgICAgcHVibGljX2tleV9wb2ludGVyLAogICAgICAgICAgICBwcml2YXRlX2tleV9wb2ludGVyCiAgICAgICAgKQogICAgICAgIGhhbmRsZV9zZWNfZXJyb3IocmVzdWx0KQoKICAgICAgICBwdWJsaWNfa2V5X3JlZiA9IHVud3JhcChwdWJsaWNfa2V5X3BvaW50ZXIpCiAgICAgICAgcHJpdmF0ZV9rZXlfcmVmID0gdW53cmFwKHByaXZhdGVfa2V5X3BvaW50ZXIpCgogICAgICAgIGNmX2RhdGFfcHVibGljX3BvaW50ZXIgPSBuZXcoQ29yZUZvdW5kYXRpb24sICdDRkRhdGFSZWYgKicpCiAgICAgICAgcmVzdWx0ID0gU2VjdXJpdHkuU2VjSXRlbUV4cG9ydChwdWJsaWNfa2V5X3JlZiwgMCwgMCwgbnVsbCgpLCBjZl9kYXRhX3B1YmxpY19wb2ludGVyKQogICAgICAgIGhhbmRsZV9zZWNfZXJyb3IocmVzdWx0KQogICAgICAgIGNmX2RhdGFfcHVibGljID0gdW53cmFwKGNmX2RhdGFfcHVibGljX3BvaW50ZXIpCiAgICAgICAgcHVibGljX2tleV9ieXRlcyA9IENGSGVscGVycy5jZl9kYXRhX3RvX2J5dGVzKGNmX2RhdGFfcHVibGljKQoKICAgICAgICBjZl9kYXRhX3ByaXZhdGVfcG9pbnRlciA9IG5ldyhDb3JlRm91bmRhdGlvbiwgJ0NGRGF0YVJlZiAqJykKICAgICAgICByZXN1bHQgPSBTZWN1cml0eS5TZWNJdGVtRXhwb3J0KHByaXZhdGVfa2V5X3JlZiwgMCwgMCwgbnVsbCgpLCBjZl9kYXRhX3ByaXZhdGVfcG9pbnRlcikKICAgICAgICBoYW5kbGVfc2VjX2Vycm9yKHJlc3VsdCkKICAgICAgICBjZl9kYXRhX3ByaXZhdGUgPSB1bndyYXAoY2ZfZGF0YV9wcml2YXRlX3BvaW50ZXIpCiAgICAgICAgcHJpdmF0ZV9rZXlfYnl0ZXMgPSBDRkhlbHBlcnMuY2ZfZGF0YV90b19ieXRlcyhjZl9kYXRhX3ByaXZhdGUpCgogICAgICAgICMgQ2xlYW4gdGhlIG5ldyBrZXlzIG91dCBvZiB0aGUga2V5Y2hhaW4KICAgICAgICByZXN1bHQgPSBTZWN1cml0eS5TZWNLZXljaGFpbkl0ZW1EZWxldGUocHVibGljX2tleV9yZWYpCiAgICAgICAgaGFuZGxlX3NlY19lcnJvcihyZXN1bHQpCiAgICAgICAgcmVzdWx0ID0gU2VjdXJpdHkuU2VjS2V5Y2hhaW5JdGVtRGVsZXRlKHByaXZhdGVfa2V5X3JlZikKICAgICAgICBoYW5kbGVfc2VjX2Vycm9yKHJlc3VsdCkKCiAgICBmaW5hbGx5OgogICAgICAgIGlmIGNmX2RpY3Q6CiAgICAgICAgICAgIENvcmVGb3VuZGF0aW9uLkNGUmVsZWFzZShjZl9kaWN0KQogICAgICAgIGlmIHB1YmxpY19rZXlfcmVmOgogICAgICAgICAgICBDb3JlRm91bmRhdGlvbi5DRlJlbGVhc2UocHVibGljX2tleV9yZWYpCiAgICAgICAgaWYgcHJpdmF0ZV9rZXlfcmVmOgogICAgICAgICAgICBDb3JlRm91bmRhdGlvbi5DRlJlbGVhc2UocHJpdmF0ZV9rZXlfcmVmKQogICAgICAgIGlmIGNmX2RhdGFfcHVibGljOgogICAgICAgICAgICBDb3JlRm91bmRhdGlvbi5DRlJlbGVhc2UoY2ZfZGF0YV9wdWJsaWMpCiAgICAgICAgaWYgY2ZfZGF0YV9wcml2YXRlOgogICAgICAgICAgICBDb3JlRm91bmRhdGlvbi5DRlJlbGVhc2UoY2ZfZGF0YV9wcml2YXRlKQogICAgICAgIGlmIGNmX3N0cmluZzoKICAgICAgICAgICAgQ29yZUZvdW5kYXRpb24uQ0ZSZWxlYXNlKGNmX3N0cmluZykKICAgICAgICBpZiBzZWNfa2V5Y2hhaW5fcmVmOgogICAgICAgICAgICBTZWN1cml0eS5TZWNLZXljaGFpbkRlbGV0ZShzZWNfa2V5Y2hhaW5fcmVmKQogICAgICAgICAgICBDb3JlRm91bmRhdGlvbi5DRlJlbGVhc2Uoc2VjX2tleWNoYWluX3JlZikKICAgICAgICBpZiB0ZW1wX2RpcjoKICAgICAgICAgICAgc2h1dGlsLnJtdHJlZSh0ZW1wX2RpcikKICAgICAgICBpZiBzZWNfYWNjZXNzX3JlZjoKICAgICAgICAgICAgQ29yZUZvdW5kYXRpb24uQ0ZSZWxlYXNlKHNlY19hY2Nlc3NfcmVmKQoKICAgIHJldHVybiAobG9hZF9wdWJsaWNfa2V5KHB1YmxpY19rZXlfYnl0ZXMpLCBsb2FkX3ByaXZhdGVfa2V5KHByaXZhdGVfa2V5X2J5dGVzKSkKCgpkZWYgZ2VuZXJhdGVfZGhfcGFyYW1ldGVycyhiaXRfc2l6ZSk6CiAgICAiIiIKICAgIEdlbmVyYXRlcyBESCBwYXJhbWV0ZXJzIGZvciB1c2Ugd2l0aCBEaWZmaWUtSGVsbG1hbiBrZXkgZXhjaGFuZ2UuIFJldHVybnMKICAgIGEgc3RydWN0dXJlIGluIHRoZSBmb3JtYXQgb2YgREhQYXJhbWV0ZXIgZGVmaW5lZCBpbiBQS0NTIzMsIHdoaWNoIGlzIGFsc28KICAgIHVzZWQgYnkgdGhlIE9wZW5TU0wgZGhwYXJhbSB0b29sLgoKICAgIFRISVMgQ0FOIEJFIFZFUlkgVElNRSBDT05TVU1JTkchCgogICAgOnBhcmFtIGJpdF9zaXplOgogICAgICAgIFRoZSBpbnRlZ2VyIGJpdCBzaXplIG9mIHRoZSBwYXJhbWV0ZXJzIHRvIGdlbmVyYXRlLiBNdXN0IGJlIGJldHdlZW4gNTEyCiAgICAgICAgYW5kIDQwOTYsIGFuZCBkaXZpc2libGUgYnkgNjQuIFJlY29tbWVuZGVkIHNlY3VyZSB2YWx1ZSBhcyBvZiBlYXJseSAyMDE2CiAgICAgICAgaXMgMjA0OCwgd2l0aCBhbiBhYnNvbHV0ZSBtaW5pbXVtIG9mIDEwMjQuCgogICAgOnJhaXNlczoKICAgICAgICBWYWx1ZUVycm9yIC0gd2hlbiBhbnkgb2YgdGhlIHBhcmFtZXRlcnMgY29udGFpbiBhbiBpbnZhbGlkIHZhbHVlCiAgICAgICAgVHlwZUVycm9yIC0gd2hlbiBhbnkgb2YgdGhlIHBhcmFtZXRlcnMgYXJlIG9mIHRoZSB3cm9uZyB0eXBlCiAgICAgICAgT1NFcnJvciAtIHdoZW4gYW4gZXJyb3IgaXMgcmV0dXJuZWQgYnkgdGhlIE9TIGNyeXB0byBsaWJyYXJ5CgogICAgOnJldHVybjoKICAgICAgICBBbiBhc24xY3J5cHRvLmFsZ29zLkRIUGFyYW1ldGVycyBvYmplY3QuIFVzZQogICAgICAgIG9zY3J5cHRvLmFzeW1tZXRyaWMuZHVtcF9kaF9wYXJhbWV0ZXJzKCkgdG8gc2F2ZSB0byBkaXNrIGZvciB1c2FnZSB3aXRoCiAgICAgICAgd2ViIHNlcnZlcnMuCiAgICAiIiIKCiAgICBpZiBub3QgaXNpbnN0YW5jZShiaXRfc2l6ZSwgaW50X3R5cGVzKToKICAgICAgICByYWlzZSBUeXBlRXJyb3IocHJldHR5X21lc3NhZ2UoCiAgICAgICAgICAgICcnJwogICAgICAgICAgICBiaXRfc2l6ZSBtdXN0IGJlIGFuIGludGVnZXIsIG5vdCAlcwogICAgICAgICAgICAnJycsCiAgICAgICAgICAgIHR5cGVfbmFtZShiaXRfc2l6ZSkKICAgICAgICApKQoKICAgIGlmIGJpdF9zaXplIDwgNTEyOgogICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoJ2JpdF9zaXplIG11c3QgYmUgZ3JlYXRlciB0aGFuIG9yIGVxdWFsIHRvIDUxMicpCgogICAgaWYgYml0X3NpemUgPiA0MDk2OgogICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoJ2JpdF9zaXplIG11c3QgYmUgbGVzcyB0aGFuIG9yIGVxdWFsIHRvIDQwOTYnKQoKICAgIGlmIGJpdF9zaXplICUgNjQgIT0gMDoKICAgICAgICByYWlzZSBWYWx1ZUVycm9yKCdiaXRfc2l6ZSBtdXN0IGJlIGEgbXVsdGlwbGUgb2YgNjQnKQoKICAgIHB1YmxpY19rZXlfcmVmID0gTm9uZQogICAgcHJpdmF0ZV9rZXlfcmVmID0gTm9uZQogICAgY2ZfZGF0YV9wdWJsaWMgPSBOb25lCiAgICBjZl9kYXRhX3ByaXZhdGUgPSBOb25lCiAgICBjZl9zdHJpbmcgPSBOb25lCiAgICBzZWNfa2V5Y2hhaW5fcmVmID0gTm9uZQogICAgc2VjX2FjY2Vzc19yZWYgPSBOb25lCiAgICB0ZW1wX2RpciA9IE5vbmUKCiAgICB0cnk6CiAgICAgICAgcHVibGljX2tleV9wb2ludGVyID0gbmV3KFNlY3VyaXR5LCAnU2VjS2V5UmVmIConKQogICAgICAgIHByaXZhdGVfa2V5X3BvaW50ZXIgPSBuZXcoU2VjdXJpdHksICdTZWNLZXlSZWYgKicpCgogICAgICAgIGNmX3N0cmluZyA9IENGSGVscGVycy5jZl9zdHJpbmdfZnJvbV91bmljb2RlKCJUZW1wb3Jhcnkgb3NjcnlwdG8ga2V5IikKCiAgICAgICAgcGFzc3BocmFzZV9sZW4gPSAxNgogICAgICAgIHJhbmRfZGF0YSA9IHJhbmRfYnl0ZXMoMTAgKyBwYXNzcGhyYXNlX2xlbikKICAgICAgICBwYXNzcGhyYXNlID0gcmFuZF9kYXRhWzEwOl0KCiAgICAgICAgdGVtcF9maWxlbmFtZSA9IGIzMmVuY29kZShyYW5kX2RhdGFbOjEwXSkuZGVjb2RlKCd1dGYtOCcpCiAgICAgICAgdGVtcF9kaXIgPSB0ZW1wZmlsZS5ta2R0ZW1wKCkKICAgICAgICB0ZW1wX3BhdGggPSBvcy5wYXRoLmpvaW4odGVtcF9kaXIsIHRlbXBfZmlsZW5hbWUpLmVuY29kZSgndXRmLTgnKQoKICAgICAgICBzZWNfa2V5Y2hhaW5fcmVmX3BvaW50ZXIgPSBuZXcoU2VjdXJpdHksICdTZWNLZXljaGFpblJlZiAqJykKICAgICAgICByZXN1bHQgPSBTZWN1cml0eS5TZWNLZXljaGFpbkNyZWF0ZSgKICAgICAgICAgICAgdGVtcF9wYXRoLAogICAgICAgICAgICBwYXNzcGhyYXNlX2xlbiwKICAgICAgICAgICAgcGFzc3BocmFzZSwKICAgICAgICAgICAgRmFsc2UsCiAgICAgICAgICAgIG51bGwoKSwKICAgICAgICAgICAgc2VjX2tleWNoYWluX3JlZl9wb2ludGVyCiAgICAgICAgKQogICAgICAgIGhhbmRsZV9zZWNfZXJyb3IocmVzdWx0KQogICAgICAgIHNlY19rZXljaGFpbl9yZWYgPSB1bndyYXAoc2VjX2tleWNoYWluX3JlZl9wb2ludGVyKQoKICAgICAgICBzZWNfYWNjZXNzX3JlZl9wb2ludGVyID0gbmV3KFNlY3VyaXR5LCAnU2VjQWNjZXNzUmVmIConKQogICAgICAgIHJlc3VsdCA9IFNlY3VyaXR5LlNlY0FjY2Vzc0NyZWF0ZShjZl9zdHJpbmcsIG51bGwoKSwgc2VjX2FjY2Vzc19yZWZfcG9pbnRlcikKICAgICAgICBoYW5kbGVfc2VjX2Vycm9yKHJlc3VsdCkKICAgICAgICBzZWNfYWNjZXNzX3JlZiA9IHVud3JhcChzZWNfYWNjZXNzX3JlZl9wb2ludGVyKQoKICAgICAgICByZXN1bHQgPSBTZWN1cml0eS5TZWNLZXlDcmVhdGVQYWlyKAogICAgICAgICAgICBzZWNfa2V5Y2hhaW5fcmVmLAogICAgICAgICAgICBTZWN1cml0eUNvbnN0LkNTU01fQUxHSURfREgsCiAgICAgICAgICAgIGJpdF9zaXplLAogICAgICAgICAgICAwLAogICAgICAgICAgICAwLAogICAgICAgICAgICBTZWN1cml0eUNvbnN0LkNTU01fS0VZQVRUUl9FWFRSQUNUQUJMRSB8IFNlY3VyaXR5Q29uc3QuQ1NTTV9LRVlBVFRSX1BFUk1BTkVOVCwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgU2VjdXJpdHlDb25zdC5DU1NNX0tFWUFUVFJfRVhUUkFDVEFCTEUgfCBTZWN1cml0eUNvbnN0LkNTU01fS0VZQVRUUl9QRVJNQU5FTlQsCiAgICAgICAgICAgIHNlY19hY2Nlc3NfcmVmLAogICAgICAgICAgICBwdWJsaWNfa2V5X3BvaW50ZXIsCiAgICAgICAgICAgIHByaXZhdGVfa2V5X3BvaW50ZXIKICAgICAgICApCiAgICAgICAgaGFuZGxlX3NlY19lcnJvcihyZXN1bHQpCgogICAgICAgIHB1YmxpY19rZXlfcmVmID0gdW53cmFwKHB1YmxpY19rZXlfcG9pbnRlcikKICAgICAgICBwcml2YXRlX2tleV9yZWYgPSB1bndyYXAocHJpdmF0ZV9rZXlfcG9pbnRlcikKCiAgICAgICAgY2ZfZGF0YV9wcml2YXRlX3BvaW50ZXIgPSBuZXcoQ29yZUZvdW5kYXRpb24sICdDRkRhdGFSZWYgKicpCiAgICAgICAgcmVzdWx0ID0gU2VjdXJpdHkuU2VjSXRlbUV4cG9ydChwcml2YXRlX2tleV9yZWYsIDAsIDAsIG51bGwoKSwgY2ZfZGF0YV9wcml2YXRlX3BvaW50ZXIpCiAgICAgICAgaGFuZGxlX3NlY19lcnJvcihyZXN1bHQpCiAgICAgICAgY2ZfZGF0YV9wcml2YXRlID0gdW53cmFwKGNmX2RhdGFfcHJpdmF0ZV9wb2ludGVyKQogICAgICAgIHByaXZhdGVfa2V5X2J5dGVzID0gQ0ZIZWxwZXJzLmNmX2RhdGFfdG9fYnl0ZXMoY2ZfZGF0YV9wcml2YXRlKQoKICAgICAgICAjIENsZWFuIHRoZSBuZXcga2V5cyBvdXQgb2YgdGhlIGtleWNoYWluCiAgICAgICAgcmVzdWx0ID0gU2VjdXJpdHkuU2VjS2V5Y2hhaW5JdGVtRGVsZXRlKHB1YmxpY19rZXlfcmVmKQogICAgICAgIGhhbmRsZV9zZWNfZXJyb3IocmVzdWx0KQoKICAgICAgICByZXN1bHQgPSBTZWN1cml0eS5TZWNLZXljaGFpbkl0ZW1EZWxldGUocHJpdmF0ZV9rZXlfcmVmKQogICAgICAgIGhhbmRsZV9zZWNfZXJyb3IocmVzdWx0KQoKICAgICAgICByZXR1cm4gS2V5RXhjaGFuZ2VBbGdvcml0aG0ubG9hZChwcml2YXRlX2tleV9ieXRlcylbJ3BhcmFtZXRlcnMnXQoKICAgIGZpbmFsbHk6CiAgICAgICAgaWYgcHVibGljX2tleV9yZWY6CiAgICAgICAgICAgIENvcmVGb3VuZGF0aW9uLkNGUmVsZWFzZShwdWJsaWNfa2V5X3JlZikKICAgICAgICBpZiBwcml2YXRlX2tleV9yZWY6CiAgICAgICAgICAgIENvcmVGb3VuZGF0aW9uLkNGUmVsZWFzZShwcml2YXRlX2tleV9yZWYpCiAgICAgICAgaWYgY2ZfZGF0YV9wdWJsaWM6CiAgICAgICAgICAgIENvcmVGb3VuZGF0aW9uLkNGUmVsZWFzZShjZl9kYXRhX3B1YmxpYykKICAgICAgICBpZiBjZl9kYXRhX3ByaXZhdGU6CiAgICAgICAgICAgIENvcmVGb3VuZGF0aW9uLkNGUmVsZWFzZShjZl9kYXRhX3ByaXZhdGUpCiAgICAgICAgaWYgY2Zfc3RyaW5nOgogICAgICAgICAgICBDb3JlRm91bmRhdGlvbi5DRlJlbGVhc2UoY2Zfc3RyaW5nKQogICAgICAgIGlmIHNlY19rZXljaGFpbl9yZWY6CiAgICAgICAgICAgIFNlY3VyaXR5LlNlY0tleWNoYWluRGVsZXRlKHNlY19rZXljaGFpbl9yZWYpCiAgICAgICAgICAgIENvcmVGb3VuZGF0aW9uLkNGUmVsZWFzZShzZWNfa2V5Y2hhaW5fcmVmKQogICAgICAgIGlmIHRlbXBfZGlyOgogICAgICAgICAgICBzaHV0aWwucm10cmVlKHRlbXBfZGlyKQogICAgICAgIGlmIHNlY19hY2Nlc3NfcmVmOgogICAgICAgICAgICBDb3JlRm91bmRhdGlvbi5DRlJlbGVhc2Uoc2VjX2FjY2Vzc19yZWYpCgoKZGVmIGxvYWRfY2VydGlmaWNhdGUoc291cmNlKToKICAgICIiIgogICAgTG9hZHMgYW4geDUwOSBjZXJ0aWZpY2F0ZSBpbnRvIGEgQ2VydGlmaWNhdGUgb2JqZWN0CgogICAgOnBhcmFtIHNvdXJjZToKICAgICAgICBBIGJ5dGUgc3RyaW5nIG9mIGZpbGUgY29udGVudHMsIGEgdW5pY29kZSBzdHJpbmcgZmlsZW5hbWUgb3IgYW4KICAgICAgICBhc24xY3J5cHRvLng1MDkuQ2VydGlmaWNhdGUgb2JqZWN0CgogICAgOnJhaXNlczoKICAgICAgICBWYWx1ZUVycm9yIC0gd2hlbiBhbnkgb2YgdGhlIHBhcmFtZXRlcnMgY29udGFpbiBhbiBpbnZhbGlkIHZhbHVlCiAgICAgICAgVHlwZUVycm9yIC0gd2hlbiBhbnkgb2YgdGhlIHBhcmFtZXRlcnMgYXJlIG9mIHRoZSB3cm9uZyB0eXBlCiAgICAgICAgT1NFcnJvciAtIHdoZW4gYW4gZXJyb3IgaXMgcmV0dXJuZWQgYnkgdGhlIE9TIGNyeXB0byBsaWJyYXJ5CgogICAgOnJldHVybjoKICAgICAgICBBIENlcnRpZmljYXRlIG9iamVjdAogICAgIiIiCgogICAgaWYgaXNpbnN0YW5jZShzb3VyY2UsIEFzbjFDZXJ0aWZpY2F0ZSk6CiAgICAgICAgY2VydGlmaWNhdGUgPSBzb3VyY2UKCiAgICBlbGlmIGlzaW5zdGFuY2Uoc291cmNlLCBieXRlX2Nscyk6CiAgICAgICAgY2VydGlmaWNhdGUgPSBwYXJzZV9jZXJ0aWZpY2F0ZShzb3VyY2UpCgogICAgZWxpZiBpc2luc3RhbmNlKHNvdXJjZSwgc3RyX2Nscyk6CiAgICAgICAgd2l0aCBvcGVuKHNvdXJjZSwgJ3JiJykgYXMgZjoKICAgICAgICAgICAgY2VydGlmaWNhdGUgPSBwYXJzZV9jZXJ0aWZpY2F0ZShmLnJlYWQoKSkKCiAgICBlbHNlOgogICAgICAgIHJhaXNlIFR5cGVFcnJvcihwcmV0dHlfbWVzc2FnZSgKICAgICAgICAgICAgJycnCiAgICAgICAgICAgIHNvdXJjZSBtdXN0IGJlIGEgYnl0ZSBzdHJpbmcsIHVuaWNvZGUgc3RyaW5nIG9yCiAgICAgICAgICAgIGFzbjFjcnlwdG8ueDUwOS5DZXJ0aWZpY2F0ZSBvYmplY3QsIG5vdCAlcwogICAgICAgICAgICAnJycsCiAgICAgICAgICAgIHR5cGVfbmFtZShzb3VyY2UpCiAgICAgICAgKSkKCiAgICByZXR1cm4gX2xvYWRfeDUwOShjZXJ0aWZpY2F0ZSkKCgpkZWYgX2xvYWRfeDUwOShjZXJ0aWZpY2F0ZSk6CiAgICAiIiIKICAgIExvYWRzIGFuIEFTTi4xIG9iamVjdCBvZiBhbiB4NTA5IGNlcnRpZmljYXRlIGludG8gYSBDZXJ0aWZpY2F0ZSBvYmplY3QKCiAgICA6cGFyYW0gY2VydGlmaWNhdGU6CiAgICAgICAgQW4gYXNuMWNyeXB0by54NTA5LkNlcnRpZmljYXRlIG9iamVjdAoKICAgIDpyZXR1cm46CiAgICAgICAgQSBDZXJ0aWZpY2F0ZSBvYmplY3QKICAgICIiIgoKICAgIHNvdXJjZSA9IGNlcnRpZmljYXRlLmR1bXAoKQoKICAgIGNmX3NvdXJjZSA9IE5vbmUKICAgIHRyeToKICAgICAgICBjZl9zb3VyY2UgPSBDRkhlbHBlcnMuY2ZfZGF0YV9mcm9tX2J5dGVzKHNvdXJjZSkKICAgICAgICBzZWNfa2V5X3JlZiA9IFNlY3VyaXR5LlNlY0NlcnRpZmljYXRlQ3JlYXRlV2l0aERhdGEoQ29yZUZvdW5kYXRpb24ua0NGQWxsb2NhdG9yRGVmYXVsdCwgY2Zfc291cmNlKQogICAgICAgIHJldHVybiBDZXJ0aWZpY2F0ZShzZWNfa2V5X3JlZiwgY2VydGlmaWNhdGUpCgogICAgZmluYWxseToKICAgICAgICBpZiBjZl9zb3VyY2U6CiAgICAgICAgICAgIENvcmVGb3VuZGF0aW9uLkNGUmVsZWFzZShjZl9zb3VyY2UpCgoKZGVmIGxvYWRfcHJpdmF0ZV9rZXkoc291cmNlLCBwYXNzd29yZD1Ob25lKToKICAgICIiIgogICAgTG9hZHMgYSBwcml2YXRlIGtleSBpbnRvIGEgUHJpdmF0ZUtleSBvYmplY3QKCiAgICA6cGFyYW0gc291cmNlOgogICAgICAgIEEgYnl0ZSBzdHJpbmcgb2YgZmlsZSBjb250ZW50cywgYSB1bmljb2RlIHN0cmluZyBmaWxlbmFtZSBvciBhbgogICAgICAgIGFzbjFjcnlwdG8ua2V5cy5Qcml2YXRlS2V5SW5mbyBvYmplY3QKCiAgICA6cGFyYW0gcGFzc3dvcmQ6CiAgICAgICAgQSBieXRlIG9yIHVuaWNvZGUgc3RyaW5nIHRvIGRlY3J5cHQgdGhlIHByaXZhdGUga2V5IGZpbGUuIFVuaWNvZGUKICAgICAgICBzdHJpbmdzIHdpbGwgYmUgZW5jb2RlZCB1c2luZyBVVEYtOC4gTm90IHVzZWQgaXMgdGhlIHNvdXJjZSBpcyBhCiAgICAgICAgUHJpdmF0ZUtleUluZm8gb2JqZWN0LgoKICAgIDpyYWlzZXM6CiAgICAgICAgVmFsdWVFcnJvciAtIHdoZW4gYW55IG9mIHRoZSBwYXJhbWV0ZXJzIGNvbnRhaW4gYW4gaW52YWxpZCB2YWx1ZQogICAgICAgIFR5cGVFcnJvciAtIHdoZW4gYW55IG9mIHRoZSBwYXJhbWV0ZXJzIGFyZSBvZiB0aGUgd3JvbmcgdHlwZQogICAgICAgIG9zY3J5cHRvLmVycm9ycy5Bc3ltbWV0cmljS2V5RXJyb3IgLSB3aGVuIHRoZSBwcml2YXRlIGtleSBpcyBpbmNvbXBhdGlibGUgd2l0aCB0aGUgT1MgY3J5cHRvIGxpYnJhcnkKICAgICAgICBPU0Vycm9yIC0gd2hlbiBhbiBlcnJvciBpcyByZXR1cm5lZCBieSB0aGUgT1MgY3J5cHRvIGxpYnJhcnkKCiAgICA6cmV0dXJuOgogICAgICAgIEEgUHJpdmF0ZUtleSBvYmplY3QKICAgICIiIgoKICAgIGlmIGlzaW5zdGFuY2Uoc291cmNlLCBQcml2YXRlS2V5SW5mbyk6CiAgICAgICAgcHJpdmF0ZV9vYmplY3QgPSBzb3VyY2UKCiAgICBlbHNlOgogICAgICAgIGlmIHBhc3N3b3JkIGlzIG5vdCBOb25lOgogICAgICAgICAgICBpZiBpc2luc3RhbmNlKHBhc3N3b3JkLCBzdHJfY2xzKToKICAgICAgICAgICAgICAgIHBhc3N3b3JkID0gcGFzc3dvcmQuZW5jb2RlKCd1dGYtOCcpCiAgICAgICAgICAgIGlmIG5vdCBpc2luc3RhbmNlKHBhc3N3b3JkLCBieXRlX2Nscyk6CiAgICAgICAgICAgICAgICByYWlzZSBUeXBlRXJyb3IocHJldHR5X21lc3NhZ2UoCiAgICAgICAgICAgICAgICAgICAgJycnCiAgICAgICAgICAgICAgICAgICAgcGFzc3dvcmQgbXVzdCBiZSBhIGJ5dGUgc3RyaW5nLCBub3QgJXMKICAgICAgICAgICAgICAgICAgICAnJycsCiAgICAgICAgICAgICAgICAgICAgdHlwZV9uYW1lKHBhc3N3b3JkKQogICAgICAgICAgICAgICAgKSkKCiAgICAgICAgaWYgaXNpbnN0YW5jZShzb3VyY2UsIHN0cl9jbHMpOgogICAgICAgICAgICB3aXRoIG9wZW4oc291cmNlLCAncmInKSBhcyBmOgogICAgICAgICAgICAgICAgc291cmNlID0gZi5yZWFkKCkKCiAgICAgICAgZWxpZiBub3QgaXNpbnN0YW5jZShzb3VyY2UsIGJ5dGVfY2xzKToKICAgICAgICAgICAgcmFpc2UgVHlwZUVycm9yKHByZXR0eV9tZXNzYWdlKAogICAgICAgICAgICAgICAgJycnCiAgICAgICAgICAgICAgICBzb3VyY2UgbXVzdCBiZSBhIGJ5dGUgc3RyaW5nLCB1bmljb2RlIHN0cmluZyBvcgogICAgICAgICAgICAgICAgYXNuMWNyeXB0by5rZXlzLlByaXZhdGVLZXlJbmZvIG9iamVjdCwgbm90ICVzCiAgICAgICAgICAgICAgICAnJycsCiAgICAgICAgICAgICAgICB0eXBlX25hbWUoc291cmNlKQogICAgICAgICAgICApKQoKICAgICAgICBwcml2YXRlX29iamVjdCA9IHBhcnNlX3ByaXZhdGUoc291cmNlLCBwYXNzd29yZCkKCiAgICByZXR1cm4gX2xvYWRfa2V5KHByaXZhdGVfb2JqZWN0KQoKCmRlZiBsb2FkX3B1YmxpY19rZXkoc291cmNlKToKICAgICIiIgogICAgTG9hZHMgYSBwdWJsaWMga2V5IGludG8gYSBQdWJsaWNLZXkgb2JqZWN0CgogICAgOnBhcmFtIHNvdXJjZToKICAgICAgICBBIGJ5dGUgc3RyaW5nIG9mIGZpbGUgY29udGVudHMsIGEgdW5pY29kZSBzdHJpbmcgZmlsZW5hbWUgb3IgYW4KICAgICAgICBhc24xY3J5cHRvLmtleXMuUHVibGljS2V5SW5mbyBvYmplY3QKCiAgICA6cmFpc2VzOgogICAgICAgIFZhbHVlRXJyb3IgLSB3aGVuIGFueSBvZiB0aGUgcGFyYW1ldGVycyBjb250YWluIGFuIGludmFsaWQgdmFsdWUKICAgICAgICBUeXBlRXJyb3IgLSB3aGVuIGFueSBvZiB0aGUgcGFyYW1ldGVycyBhcmUgb2YgdGhlIHdyb25nIHR5cGUKICAgICAgICBvc2NyeXB0by5lcnJvcnMuQXN5bW1ldHJpY0tleUVycm9yIC0gd2hlbiB0aGUgcHVibGljIGtleSBpcyBpbmNvbXBhdGlibGUgd2l0aCB0aGUgT1MgY3J5cHRvIGxpYnJhcnkKICAgICAgICBPU0Vycm9yIC0gd2hlbiBhbiBlcnJvciBpcyByZXR1cm5lZCBieSB0aGUgT1MgY3J5cHRvIGxpYnJhcnkKCiAgICA6cmV0dXJuOgogICAgICAgIEEgUHVibGljS2V5IG9iamVjdAogICAgIiIiCgogICAgaWYgaXNpbnN0YW5jZShzb3VyY2UsIFB1YmxpY0tleUluZm8pOgogICAgICAgIHB1YmxpY19rZXkgPSBzb3VyY2UKCiAgICBlbGlmIGlzaW5zdGFuY2Uoc291cmNlLCBieXRlX2Nscyk6CiAgICAgICAgcHVibGljX2tleSA9IHBhcnNlX3B1YmxpYyhzb3VyY2UpCgogICAgZWxpZiBpc2luc3RhbmNlKHNvdXJjZSwgc3RyX2Nscyk6CiAgICAgICAgd2l0aCBvcGVuKHNvdXJjZSwgJ3JiJykgYXMgZjoKICAgICAgICAgICAgcHVibGljX2tleSA9IHBhcnNlX3B1YmxpYyhmLnJlYWQoKSkKCiAgICBlbHNlOgogICAgICAgIHJhaXNlIFR5cGVFcnJvcihwcmV0dHlfbWVzc2FnZSgKICAgICAgICAgICAgJycnCiAgICAgICAgICAgIHNvdXJjZSBtdXN0IGJlIGEgYnl0ZSBzdHJpbmcsIHVuaWNvZGUgc3RyaW5nIG9yCiAgICAgICAgICAgIGFzbjFjcnlwdG8ua2V5cy5QdWJsaWNLZXlJbmZvIG9iamVjdCwgbm90ICVzCiAgICAgICAgICAgICcnJywKICAgICAgICAgICAgdHlwZV9uYW1lKHNvdXJjZSkKICAgICAgICApKQoKICAgIHJldHVybiBfbG9hZF9rZXkocHVibGljX2tleSkKCgpkZWYgX2xvYWRfa2V5KGtleV9vYmplY3QpOgogICAgIiIiCiAgICBDb21tb24gY29kZSB0byBsb2FkIHB1YmxpYyBhbmQgcHJpdmF0ZSBrZXlzIGludG8gUHVibGljS2V5IGFuZCBQcml2YXRlS2V5CiAgICBvYmplY3RzCgogICAgOnBhcmFtIGtleV9vYmplY3Q6CiAgICAgICAgQW4gYXNuMWNyeXB0by5rZXlzLlB1YmxpY0tleUluZm8gb3IgYXNuMWNyeXB0by5rZXlzLlByaXZhdGVLZXlJbmZvCiAgICAgICAgb2JqZWN0CgogICAgOnJhaXNlczoKICAgICAgICBWYWx1ZUVycm9yIC0gd2hlbiBhbnkgb2YgdGhlIHBhcmFtZXRlcnMgY29udGFpbiBhbiBpbnZhbGlkIHZhbHVlCiAgICAgICAgVHlwZUVycm9yIC0gd2hlbiBhbnkgb2YgdGhlIHBhcmFtZXRlcnMgYXJlIG9mIHRoZSB3cm9uZyB0eXBlCiAgICAgICAgb3NjcnlwdG8uZXJyb3JzLkFzeW1tZXRyaWNLZXlFcnJvciAtIHdoZW4gdGhlIGtleSBpcyBpbmNvbXBhdGlibGUgd2l0aCB0aGUgT1MgY3J5cHRvIGxpYnJhcnkKICAgICAgICBPU0Vycm9yIC0gd2hlbiBhbiBlcnJvciBpcyByZXR1cm5lZCBieSB0aGUgT1MgY3J5cHRvIGxpYnJhcnkKCiAgICA6cmV0dXJuOgogICAgICAgIEEgUHVibGljS2V5IG9yIFByaXZhdGVLZXkgb2JqZWN0CiAgICAiIiIKCiAgICBpZiBrZXlfb2JqZWN0LmFsZ29yaXRobSA9PSAnZWMnOgogICAgICAgIGN1cnZlX3R5cGUsIGRldGFpbHMgPSBrZXlfb2JqZWN0LmN1cnZlCiAgICAgICAgaWYgY3VydmVfdHlwZSAhPSAnbmFtZWQnOgogICAgICAgICAgICByYWlzZSBBc3ltbWV0cmljS2V5RXJyb3IoJ09TIFggb25seSBzdXBwb3J0cyBFQyBrZXlzIHVzaW5nIG5hbWVkIGN1cnZlcycpCiAgICAgICAgaWYgZGV0YWlscyBub3QgaW4gc2V0KFsnc2VjcDI1NnIxJywgJ3NlY3AzODRyMScsICdzZWNwNTIxcjEnXSk6CiAgICAgICAgICAgIHJhaXNlIEFzeW1tZXRyaWNLZXlFcnJvcihwcmV0dHlfbWVzc2FnZSgKICAgICAgICAgICAgICAgICcnJwogICAgICAgICAgICAgICAgT1MgWCBvbmx5IHN1cHBvcnRzIEVDIGtleXMgdXNpbmcgdGhlIG5hbWVkIGN1cnZlcyBzZWNwMjU2cjEsCiAgICAgICAgICAgICAgICBzZWNwMzg0cjEgYW5kIHNlY3A1MjFyMQogICAgICAgICAgICAgICAgJycnCiAgICAgICAgICAgICkpCgogICAgZWxpZiBrZXlfb2JqZWN0LmFsZ29yaXRobSA9PSAnZHNhJyBhbmQga2V5X29iamVjdC5oYXNoX2FsZ28gPT0gJ3NoYTInOgogICAgICAgIHJhaXNlIEFzeW1tZXRyaWNLZXlFcnJvcihwcmV0dHlfbWVzc2FnZSgKICAgICAgICAgICAgJycnCiAgICAgICAgICAgIE9TIFggb25seSBzdXBwb3J0cyBEU0Ega2V5cyBiYXNlZCBvbiBTSEExICgyMDQ4IGJpdHMgb3IgbGVzcykgLSB0aGlzCiAgICAgICAgICAgIGtleSBpcyBiYXNlZCBvbiBTSEEyIGFuZCBpcyAlcyBiaXRzCiAgICAgICAgICAgICcnJywKICAgICAgICAgICAga2V5X29iamVjdC5iaXRfc2l6ZQogICAgICAgICkpCgogICAgZWxpZiBrZXlfb2JqZWN0LmFsZ29yaXRobSA9PSAnZHNhJyBhbmQga2V5X29iamVjdC5oYXNoX2FsZ28gaXMgTm9uZToKICAgICAgICByYWlzZSBJbmNvbXBsZXRlQXN5bW1ldHJpY0tleUVycm9yKHByZXR0eV9tZXNzYWdlKAogICAgICAgICAgICAnJycKICAgICAgICAgICAgVGhlIERTQSBrZXkgZG9lcyBub3QgY29udGFpbiB0aGUgbmVjZXNzYXJ5IHAsIHEgYW5kIGcgcGFyYW1ldGVycwogICAgICAgICAgICBhbmQgY2FuIG5vdCBiZSB1c2VkCiAgICAgICAgICAgICcnJwogICAgICAgICkpCgogICAgaWYgaXNpbnN0YW5jZShrZXlfb2JqZWN0LCBQdWJsaWNLZXlJbmZvKToKICAgICAgICBpZiBrZXlfb2JqZWN0LmFsZ29yaXRobSA9PSAncnNhc3NhX3Bzcyc6CiAgICAgICAgICAgICMgV2UgaGF2ZSB0byBtYXNxdWVyYWRlIGFuIFJTQSBQU1Mga2V5IGFzIHBsYWluIFJTQSBvciBpdCB3b24ndAogICAgICAgICAgICAjIGltcG9ydCBwcm9wZXJseQogICAgICAgICAgICB0ZW1wX2tleV9vYmplY3QgPSBrZXlfb2JqZWN0LmNvcHkoKQogICAgICAgICAgICB0ZW1wX2tleV9vYmplY3RbJ2FsZ29yaXRobSddWydhbGdvcml0aG0nXSA9ICdyc2EnCiAgICAgICAgICAgIHNvdXJjZSA9IHRlbXBfa2V5X29iamVjdC5kdW1wKCkKICAgICAgICBlbHNlOgogICAgICAgICAgICBzb3VyY2UgPSBrZXlfb2JqZWN0LmR1bXAoKQogICAgICAgIGl0ZW1fdHlwZSA9IFNlY3VyaXR5Q29uc3Qua1NlY0l0ZW1UeXBlUHVibGljS2V5CgogICAgZWxzZToKICAgICAgICBzb3VyY2UgPSBfdW53cmFwX3ByaXZhdGVfa2V5X2luZm8oa2V5X29iamVjdCkuZHVtcCgpCiAgICAgICAgaXRlbV90eXBlID0gU2VjdXJpdHlDb25zdC5rU2VjSXRlbVR5cGVQcml2YXRlS2V5CgogICAgY2Zfc291cmNlID0gTm9uZQogICAga2V5c19hcnJheSA9IE5vbmUKICAgIGF0dHJfYXJyYXkgPSBOb25lCgogICAgdHJ5OgogICAgICAgIGNmX3NvdXJjZSA9IENGSGVscGVycy5jZl9kYXRhX2Zyb21fYnl0ZXMoc291cmNlKQoKICAgICAgICBmb3JtYXRfcG9pbnRlciA9IG5ldyhTZWN1cml0eSwgJ3VpbnQzMl90IConKQogICAgICAgIHBvaW50ZXJfc2V0KGZvcm1hdF9wb2ludGVyLCBTZWN1cml0eUNvbnN0LmtTZWNGb3JtYXRPcGVuU1NMKQogICAgICAgIHR5cGVfcG9pbnRlciA9IG5ldyhTZWN1cml0eSwgJ3VpbnQzMl90IConKQogICAgICAgIHBvaW50ZXJfc2V0KHR5cGVfcG9pbnRlciwgaXRlbV90eXBlKQogICAgICAgIGtleXNfcG9pbnRlciA9IG5ldyhDb3JlRm91bmRhdGlvbiwgJ0NGQXJyYXlSZWYgKicpCgogICAgICAgIGF0dHJfYXJyYXkgPSBDRkhlbHBlcnMuY2ZfYXJyYXlfZnJvbV9saXN0KFsKICAgICAgICAgICAgU2VjdXJpdHkua1NlY0F0dHJJc0V4dHJhY3RhYmxlCiAgICAgICAgXSkKCiAgICAgICAgaW1wb3J0X2V4cG9ydF9wYXJhbXNfcG9pbnRlciA9IG5ldyhTZWN1cml0eSwgJ1NlY0l0ZW1JbXBvcnRFeHBvcnRLZXlQYXJhbWV0ZXJzIConKQogICAgICAgIGltcG9ydF9leHBvcnRfcGFyYW1zID0gdW53cmFwKGltcG9ydF9leHBvcnRfcGFyYW1zX3BvaW50ZXIpCiAgICAgICAgaW1wb3J0X2V4cG9ydF9wYXJhbXMudmVyc2lvbiA9IDAKICAgICAgICBpbXBvcnRfZXhwb3J0X3BhcmFtcy5mbGFncyA9IDAKICAgICAgICBpbXBvcnRfZXhwb3J0X3BhcmFtcy5wYXNzcGhyYXNlID0gbnVsbCgpCiAgICAgICAgaW1wb3J0X2V4cG9ydF9wYXJhbXMuYWxlcnRUaXRsZSA9IG51bGwoKQogICAgICAgIGltcG9ydF9leHBvcnRfcGFyYW1zLmFsZXJ0UHJvbXB0ID0gbnVsbCgpCiAgICAgICAgaW1wb3J0X2V4cG9ydF9wYXJhbXMuYWNjZXNzUmVmID0gbnVsbCgpCiAgICAgICAgaW1wb3J0X2V4cG9ydF9wYXJhbXMua2V5VXNhZ2UgPSBudWxsKCkKICAgICAgICBpbXBvcnRfZXhwb3J0X3BhcmFtcy5rZXlBdHRyaWJ1dGVzID0gYXR0cl9hcnJheQoKICAgICAgICByZXMgPSBTZWN1cml0eS5TZWNJdGVtSW1wb3J0KAogICAgICAgICAgICBjZl9zb3VyY2UsCiAgICAgICAgICAgIG51bGwoKSwKICAgICAgICAgICAgZm9ybWF0X3BvaW50ZXIsCiAgICAgICAgICAgIHR5cGVfcG9pbnRlciwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgaW1wb3J0X2V4cG9ydF9wYXJhbXNfcG9pbnRlciwKICAgICAgICAgICAgbnVsbCgpLAogICAgICAgICAgICBrZXlzX3BvaW50ZXIKICAgICAgICApCiAgICAgICAgaGFuZGxlX3NlY19lcnJvcihyZXMpCiAgICAgICAga2V5c19hcnJheSA9IHVud3JhcChrZXlzX3BvaW50ZXIpCgogICAgICAgIGxlbmd0aCA9IENvcmVGb3VuZGF0aW9uLkNGQXJyYXlHZXRDb3VudChrZXlzX2FycmF5KQogICAgICAgIGlmIGxlbmd0aCA+IDA6CiAgICAgICAgICAgIHNlY19rZXlfcmVmID0gQ29yZUZvdW5kYXRpb24uQ0ZBcnJheUdldFZhbHVlQXRJbmRleChrZXlzX2FycmF5LCAwKQogICAgICAgICAgICBDb3JlRm91bmRhdGlvbi5DRlJldGFpbihzZWNfa2V5X3JlZikKCiAgICAgICAgaWYgaXRlbV90eXBlID09IFNlY3VyaXR5Q29uc3Qua1NlY0l0ZW1UeXBlUHVibGljS2V5OgogICAgICAgICAgICByZXR1cm4gUHVibGljS2V5KHNlY19rZXlfcmVmLCBrZXlfb2JqZWN0KQoKICAgICAgICBpZiBpdGVtX3R5cGUgPT0gU2VjdXJpdHlDb25zdC5rU2VjSXRlbVR5cGVQcml2YXRlS2V5OgogICAgICAgICAgICByZXR1cm4gUHJpdmF0ZUtleShzZWNfa2V5X3JlZiwga2V5X29iamVjdCkKCiAgICBmaW5hbGx5OgogICAgICAgIGlmIGF0dHJfYXJyYXk6CiAgICAgICAgICAgIENvcmVGb3VuZGF0aW9uLkNGUmVsZWFzZShhdHRyX2FycmF5KQogICAgICAgIGlmIGtleXNfYXJyYXk6CiAgICAgICAgICAgIENvcmVGb3VuZGF0aW9uLkNGUmVsZWFzZShrZXlzX2FycmF5KQogICAgICAgIGlmIGNmX3NvdXJjZToKICAgICAgICAgICAgQ29yZUZvdW5kYXRpb24uQ0ZSZWxlYXNlKGNmX3NvdXJjZSkKCgpkZWYgcGFyc2VfcGtjczEyKGRhdGEsIHBhc3N3b3JkPU5vbmUpOgogICAgIiIiCiAgICBQYXJzZXMgYSBQS0NTIzEyIEFOUy4xIERFUi1lbmNvZGVkIHN0cnVjdHVyZSBhbmQgZXh0cmFjdHMgY2VydHMgYW5kIGtleXMKCiAgICA6cGFyYW0gZGF0YToKICAgICAgICBBIGJ5dGUgc3RyaW5nIG9mIGEgREVSLWVuY29kZWQgUEtDUyMxMiBmaWxlCgogICAgOnBhcmFtIHBhc3N3b3JkOgogICAgICAgIEEgYnl0ZSBzdHJpbmcgb2YgdGhlIHBhc3N3b3JkIHRvIGFueSBlbmNyeXB0ZWQgZGF0YQoKICAgIDpyYWlzZXM6CiAgICAgICAgVmFsdWVFcnJvciAtIHdoZW4gYW55IG9mIHRoZSBwYXJhbWV0ZXJzIGFyZSBvZiB0aGUgd3JvbmcgdHlwZSBvciB2YWx1ZQogICAgICAgIE9TRXJyb3IgLSB3aGVuIGFuIGVycm9yIGlzIHJldHVybmVkIGJ5IG9uZSBvZiB0aGUgT1MgZGVjcnlwdGlvbiBmdW5jdGlvbnMKCiAgICA6cmV0dXJuOgogICAgICAgIEEgdGhyZWUtZWxlbWVudCB0dXBsZSBvZjoKICAgICAgICAgMS4gQW4gYXNuMWNyeXB0by5rZXlzLlByaXZhdGVLZXlJbmZvIG9iamVjdAogICAgICAgICAyLiBBbiBhc24xY3J5cHRvLng1MDkuQ2VydGlmaWNhdGUgb2JqZWN0CiAgICAgICAgIDMuIEEgbGlzdCBvZiB6ZXJvIG9yIG1vcmUgYXNuMWNyeXB0by54NTA5LkNlcnRpZmljYXRlIG9iamVjdHMgdGhhdCBhcmUKICAgICAgICAgICAgImV4dHJhIiBjZXJ0aWZpY2F0ZXMsIHBvc3NpYmx5IGludGVybWVkaWF0ZXMgZnJvbSB0aGUgY2VydCBjaGFpbgogICAgIiIiCgogICAgcmV0dXJuIF9wYXJzZV9wa2NzMTIoZGF0YSwgcGFzc3dvcmQsIGxvYWRfcHJpdmF0ZV9rZXkpCgoKZGVmIGxvYWRfcGtjczEyKHNvdXJjZSwgcGFzc3dvcmQ9Tm9uZSk6CiAgICAiIiIKICAgIExvYWRzIGEgLnAxMiBvciAucGZ4IGZpbGUgaW50byBhIFByaXZhdGVLZXkgb2JqZWN0IGFuZCBvbmUgb3IgbW9yZQogICAgQ2VydGlmaWNhdGVzIG9iamVjdHMKCiAgICA6cGFyYW0gc291cmNlOgogICAgICAgIEEgYnl0ZSBzdHJpbmcgb2YgZmlsZSBjb250ZW50cyBvciBhIHVuaWNvZGUgc3RyaW5nIGZpbGVuYW1lCgogICAgOnBhcmFtIHBhc3N3b3JkOgogICAgICAgIEEgYnl0ZSBvciB1bmljb2RlIHN0cmluZyB0byBkZWNyeXB0IHRoZSBQS0NTMTIgZmlsZS4gVW5pY29kZSBzdHJpbmdzCiAgICAgICAgd2lsbCBiZSBlbmNvZGVkIHVzaW5nIFVURi04LgoKICAgIDpyYWlzZXM6CiAgICAgICAgVmFsdWVFcnJvciAtIHdoZW4gYW55IG9mIHRoZSBwYXJhbWV0ZXJzIGNvbnRhaW4gYW4gaW52YWxpZCB2YWx1ZQogICAgICAgIFR5cGVFcnJvciAtIHdoZW4gYW55IG9mIHRoZSBwYXJhbWV0ZXJzIGFyZSBvZiB0aGUgd3JvbmcgdHlwZQogICAgICAgIG9zY3J5cHRvLmVycm9ycy5Bc3ltbWV0cmljS2V5RXJyb3IgLSB3aGVuIGEgY29udGFpbmVkIGtleSBpcyBpbmNvbXBhdGlibGUgd2l0aCB0aGUgT1MgY3J5cHRvIGxpYnJhcnkKICAgICAgICBPU0Vycm9yIC0gd2hlbiBhbiBlcnJvciBpcyByZXR1cm5lZCBieSB0aGUgT1MgY3J5cHRvIGxpYnJhcnkKCiAgICA6cmV0dXJuOgogICAgICAgIEEgdGhyZWUtZWxlbWVudCB0dXBsZSBjb250YWluaW5nIChQcml2YXRlS2V5LCBDZXJ0aWZpY2F0ZSwgW0NlcnRpZmljYXRlLCAuLi5dKQogICAgIiIiCgogICAgaWYgcGFzc3dvcmQgaXMgbm90IE5vbmU6CiAgICAgICAgaWYgaXNpbnN0YW5jZShwYXNzd29yZCwgc3RyX2Nscyk6CiAgICAgICAgICAgIHBhc3N3b3JkID0gcGFzc3dvcmQuZW5jb2RlKCd1dGYtOCcpCiAgICAgICAgaWYgbm90IGlzaW5zdGFuY2UocGFzc3dvcmQsIGJ5dGVfY2xzKToKICAgICAgICAgICAgcmFpc2UgVHlwZUVycm9yKHByZXR0eV9tZXNzYWdlKAogICAgICAgICAgICAgICAgJycnCiAgICAgICAgICAgICAgICBwYXNzd29yZCBtdXN0IGJlIGEgYnl0ZSBzdHJpbmcsIG5vdCAlcwogICAgICAgICAgICAgICAgJycnLAogICAgICAgICAgICAgICAgdHlwZV9uYW1lKHBhc3N3b3JkKQogICAgICAgICAgICApKQoKICAgIGlmIGlzaW5zdGFuY2Uoc291cmNlLCBzdHJfY2xzKToKICAgICAgICB3aXRoIG9wZW4oc291cmNlLCAncmInKSBhcyBmOgogICAgICAgICAgICBzb3VyY2UgPSBmLnJlYWQoKQoKICAgIGVsaWYgbm90IGlzaW5zdGFuY2Uoc291cmNlLCBieXRlX2Nscyk6CiAgICAgICAgcmFpc2UgVHlwZUVycm9yKHByZXR0eV9tZXNzYWdlKAogICAgICAgICAgICAnJycKICAgICAgICAgICAgc291cmNlIG11c3QgYmUgYSBieXRlIHN0cmluZyBvciBhIHVuaWNvZGUgc3RyaW5nLCBub3QgJXMKICAgICAgICAgICAgJycnLAogICAgICAgICAgICB0eXBlX25hbWUoc291cmNlKQogICAgICAgICkpCgogICAga2V5X2luZm8sIGNlcnRfaW5mbywgZXh0cmFfY2VydHNfaW5mbyA9IHBhcnNlX3BrY3MxMihzb3VyY2UsIHBhc3N3b3JkKQoKICAgIGtleSA9IE5vbmUKICAgIGNlcnQgPSBOb25lCgogICAgaWYga2V5X2luZm86CiAgICAgICAga2V5ID0gX2xvYWRfa2V5KGtleV9pbmZvKQoKICAgIGlmIGNlcnRfaW5mbzoKICAgICAgICBjZXJ0ID0gX2xvYWRfeDUwOShjZXJ0X2luZm8pCgogICAgZXh0cmFfY2VydHMgPSBbX2xvYWRfeDUwOShpbmZvKSBmb3IgaW5mbyBpbiBleHRyYV9jZXJ0c19pbmZvXQoKICAgIHJldHVybiAoa2V5LCBjZXJ0LCBleHRyYV9jZXJ0cykKCgpkZWYgcnNhX3BrY3MxdjE1X2VuY3J5cHQoY2VydGlmaWNhdGVfb3JfcHVibGljX2tleSwgZGF0YSk6CiAgICAiIiIKICAgIEVuY3J5cHRzIGEgYnl0ZSBzdHJpbmcgdXNpbmcgYW4gUlNBIHB1YmxpYyBrZXkgb3IgY2VydGlmaWNhdGUuIFVzZXMgUEtDUyMxCiAgICB2MS41IHBhZGRpbmcuCgogICAgOnBhcmFtIGNlcnRpZmljYXRlX29yX3B1YmxpY19rZXk6CiAgICAgICAgQSBQdWJsaWNLZXkgb3IgQ2VydGlmaWNhdGUgb2JqZWN0CgogICAgOnBhcmFtIGRhdGE6CiAgICAgICAgQSBieXRlIHN0cmluZywgd2l0aCBhIG1heGltdW0gbGVuZ3RoIDExIGJ5dGVzIGxlc3MgdGhhbiB0aGUga2V5IGxlbmd0aAogICAgICAgIChpbiBieXRlcykKCiAgICA6cmFpc2VzOgogICAgICAgIFZhbHVlRXJyb3IgLSB3aGVuIGFueSBvZiB0aGUgcGFyYW1ldGVycyBjb250YWluIGFuIGludmFsaWQgdmFsdWUKICAgICAgICBUeXBlRXJyb3IgLSB3aGVuIGFueSBvZiB0aGUgcGFyYW1ldGVycyBhcmUgb2YgdGhlIHdyb25nIHR5cGUKICAgICAgICBPU0Vycm9yIC0gd2hlbiBhbiBlcnJvciBpcyByZXR1cm5lZCBieSB0aGUgT1MgY3J5cHRvIGxpYnJhcnkKCiAgICA6cmV0dXJuOgogICAgICAgIEEgYnl0ZSBzdHJpbmcgb2YgdGhlIGVuY3J5cHRlZCBkYXRhCiAgICAiIiIKCiAgICBpZiBub3QgaXNpbnN0YW5jZShjZXJ0aWZpY2F0ZV9vcl9wdWJsaWNfa2V5LCAoQ2VydGlmaWNhdGUsIFB1YmxpY0tleSkpOgogICAgICAgIHJhaXNlIFR5cGVFcnJvcihwcmV0dHlfbWVzc2FnZSgKICAgICAgICAgICAgJycnCiAgICAgICAgICAgIGNlcnRpZmljYXRlX29yX3B1YmxpY19rZXkgbXVzdCBiZSBhbiBpbnN0YW5jZSBvZiB0aGUgQ2VydGlmaWNhdGUgb3IKICAgICAgICAgICAgUHVibGljS2V5IGNsYXNzLCBub3QgJXMKICAgICAgICAgICAgJycnLAogICAgICAgICAgICB0eXBlX25hbWUoY2VydGlmaWNhdGVfb3JfcHVibGljX2tleSkKICAgICAgICApKQoKICAgIGlmIG5vdCBpc2luc3RhbmNlKGRhdGEsIGJ5dGVfY2xzKToKICAgICAgICByYWlzZSBUeXBlRXJyb3IocHJldHR5X21lc3NhZ2UoCiAgICAgICAgICAgICcnJwogICAgICAgICAgICBkYXRhIG11c3QgYmUgYSBieXRlIHN0cmluZywgbm90ICVzCiAgICAgICAgICAgICcnJywKICAgICAgICAgICAgdHlwZV9uYW1lKGRhdGEpCiAgICAgICAgKSkKCiAgICBrZXlfbGVuZ3RoID0gY2VydGlmaWNhdGVfb3JfcHVibGljX2tleS5ieXRlX3NpemUKICAgIGJ1ZmZlciA9IGJ1ZmZlcl9mcm9tX2J5dGVzKGtleV9sZW5ndGgpCiAgICBvdXRwdXRfbGVuZ3RoID0gbmV3KFNlY3VyaXR5LCAnc2l6ZV90IConLCBrZXlfbGVuZ3RoKQogICAgcmVzdWx0ID0gU2VjdXJpdHkuU2VjS2V5RW5jcnlwdCgKICAgICAgICBjZXJ0aWZpY2F0ZV9vcl9wdWJsaWNfa2V5LnNlY19rZXlfcmVmLAogICAgICAgIFNlY3VyaXR5Q29uc3Qua1NlY1BhZGRpbmdQS0NTMSwKICAgICAgICBkYXRhLAogICAgICAgIGxlbihkYXRhKSwKICAgICAgICBidWZmZXIsCiAgICAgICAgb3V0cHV0X2xlbmd0aAogICAgKQogICAgaGFuZGxlX3NlY19lcnJvcihyZXN1bHQpCgogICAgcmV0dXJuIGJ5dGVzX2Zyb21fYnVmZmVyKGJ1ZmZlciwgZGVyZWYob3V0cHV0X2xlbmd0aCkpCgoKZGVmIHJzYV9wa2NzMXYxNV9kZWNyeXB0KHByaXZhdGVfa2V5LCBjaXBoZXJ0ZXh0KToKICAgICIiIgogICAgRGVjcnlwdHMgYSBieXRlIHN0cmluZyB1c2luZyBhbiBSU0EgcHJpdmF0ZSBrZXkuIFVzZXMgUEtDUyMxIHYxLjUgcGFkZGluZy4KCiAgICA6cGFyYW0gcHJpdmF0ZV9rZXk6CiAgICAgICAgQSBQcml2YXRlS2V5IG9iamVjdAoKICAgIDpwYXJhbSBjaXBoZXJ0ZXh0OgogICAgICAgIEEgYnl0ZSBzdHJpbmcgb2YgdGhlIGVuY3J5cHRlZCBkYXRhCgogICAgOnJhaXNlczoKICAgICAgICBWYWx1ZUVycm9yIC0gd2hlbiBhbnkgb2YgdGhlIHBhcmFtZXRlcnMgY29udGFpbiBhbiBpbnZhbGlkIHZhbHVlCiAgICAgICAgVHlwZUVycm9yIC0gd2hlbiBhbnkgb2YgdGhlIHBhcmFtZXRlcnMgYXJlIG9mIHRoZSB3cm9uZyB0eXBlCiAgICAgICAgT1NFcnJvciAtIHdoZW4gYW4gZXJyb3IgaXMgcmV0dXJuZWQgYnkgdGhlIE9TIGNyeXB0byBsaWJyYXJ5CgogICAgOnJldHVybjoKICAgICAgICBBIGJ5dGUgc3RyaW5nIG9mIHRoZSBvcmlnaW5hbCBwbGFpbnRleHQKICAgICIiIgoKICAgIGlmIG5vdCBpc2luc3RhbmNlKHByaXZhdGVfa2V5LCBQcml2YXRlS2V5KToKICAgICAgICByYWlzZSBUeXBlRXJyb3IocHJldHR5X21lc3NhZ2UoCiAgICAgICAgICAgICcnJwogICAgICAgICAgICBwcml2YXRlX2tleSBtdXN0IGFuIGluc3RhbmNlIG9mIHRoZSBQcml2YXRlS2V5IGNsYXNzLCBub3QgJXMKICAgICAgICAgICAgJycnLAogICAgICAgICAgICB0eXBlX25hbWUocHJpdmF0ZV9rZXkpCiAgICAgICAgKSkKCiAgICBpZiBub3QgaXNpbnN0YW5jZShjaXBoZXJ0ZXh0LCBieXRlX2Nscyk6CiAgICAgICAgcmFpc2UgVHlwZUVycm9yKHByZXR0eV9tZXNzYWdlKAogICAgICAgICAgICAnJycKICAgICAgICAgICAgZGF0YSBtdXN0IGJlIGEgYnl0ZSBzdHJpbmcsIG5vdCAlcwogICAgICAgICAgICAnJycsCiAgICAgICAgICAgIHR5cGVfbmFtZShjaXBoZXJ0ZXh0KQogICAgICAgICkpCgogICAga2V5X2xlbmd0aCA9IHByaXZhdGVfa2V5LmJ5dGVfc2l6ZQogICAgYnVmZmVyID0gYnVmZmVyX2Zyb21fYnl0ZXMoa2V5X2xlbmd0aCkKICAgIG91dHB1dF9sZW5ndGggPSBuZXcoU2VjdXJpdHksICdzaXplX3QgKicsIGtleV9sZW5ndGgpCgogICAgaWYgb3N4X3ZlcnNpb25faW5mbyA8ICgxMCwgOCk6CiAgICAgICAgcGFkZGluZyA9IFNlY3VyaXR5Q29uc3Qua1NlY1BhZGRpbmdOb25lCiAgICBlbHNlOgogICAgICAgIHBhZGRpbmcgPSBTZWN1cml0eUNvbnN0LmtTZWNQYWRkaW5nUEtDUzEKCiAgICByZXN1bHQgPSBTZWN1cml0eS5TZWNLZXlEZWNyeXB0KAogICAgICAgIHByaXZhdGVfa2V5LnNlY19rZXlfcmVmLAogICAgICAgIHBhZGRpbmcsCiAgICAgICAgY2lwaGVydGV4dCwKICAgICAgICBsZW4oY2lwaGVydGV4dCksCiAgICAgICAgYnVmZmVyLAogICAgICAgIG91dHB1dF9sZW5ndGgKICAgICkKICAgIGhhbmRsZV9zZWNfZXJyb3IocmVzdWx0KQoKICAgIG91dHB1dCA9IGJ5dGVzX2Zyb21fYnVmZmVyKGJ1ZmZlciwgZGVyZWYob3V0cHV0X2xlbmd0aCkpCgogICAgaWYgb3N4X3ZlcnNpb25faW5mbyA8ICgxMCwgOCk6CiAgICAgICAgb3V0cHV0ID0gcmVtb3ZlX3BrY3MxdjE1X2VuY3J5cHRpb25fcGFkZGluZyhrZXlfbGVuZ3RoLCBvdXRwdXQpCgogICAgcmV0dXJuIG91dHB1dAoKCmRlZiByc2Ffb2FlcF9lbmNyeXB0KGNlcnRpZmljYXRlX29yX3B1YmxpY19rZXksIGRhdGEpOgogICAgIiIiCiAgICBFbmNyeXB0cyBhIGJ5dGUgc3RyaW5nIHVzaW5nIGFuIFJTQSBwdWJsaWMga2V5IG9yIGNlcnRpZmljYXRlLiBVc2VzIFBLQ1MjMQogICAgT0FFUCBwYWRkaW5nIHdpdGggU0hBMS4KCiAgICA6cGFyYW0gY2VydGlmaWNhdGVfb3JfcHVibGljX2tleToKICAgICAgICBBIFB1YmxpY0tleSBvciBDZXJ0aWZpY2F0ZSBvYmplY3QKCiAgICA6cGFyYW0gZGF0YToKICAgICAgICBBIGJ5dGUgc3RyaW5nLCB3aXRoIGEgbWF4aW11bSBsZW5ndGggNDEgYnl0ZXMgKG9yIG1vcmUpIGxlc3MgdGhhbiB0aGUKICAgICAgICBrZXkgbGVuZ3RoIChpbiBieXRlcykKCiAgICA6cmFpc2VzOgogICAgICAgIFZhbHVlRXJyb3IgLSB3aGVuIGFueSBvZiB0aGUgcGFyYW1ldGVycyBjb250YWluIGFuIGludmFsaWQgdmFsdWUKICAgICAgICBUeXBlRXJyb3IgLSB3aGVuIGFueSBvZiB0aGUgcGFyYW1ldGVycyBhcmUgb2YgdGhlIHdyb25nIHR5cGUKICAgICAgICBPU0Vycm9yIC0gd2hlbiBhbiBlcnJvciBpcyByZXR1cm5lZCBieSB0aGUgT1MgY3J5cHRvIGxpYnJhcnkKCiAgICA6cmV0dXJuOgogICAgICAgIEEgYnl0ZSBzdHJpbmcgb2YgdGhlIGVuY3J5cHRlZCBkYXRhCiAgICAiIiIKCiAgICByZXR1cm4gX2VuY3J5cHQoY2VydGlmaWNhdGVfb3JfcHVibGljX2tleSwgZGF0YSwgU2VjdXJpdHkua1NlY1BhZGRpbmdPQUVQS2V5KQoKCmRlZiByc2Ffb2FlcF9kZWNyeXB0KHByaXZhdGVfa2V5LCBjaXBoZXJ0ZXh0KToKICAgICIiIgogICAgRGVjcnlwdHMgYSBieXRlIHN0cmluZyB1c2luZyBhbiBSU0EgcHJpdmF0ZSBrZXkuIFVzZXMgUEtDUyMxIE9BRVAgcGFkZGluZwogICAgd2l0aCBTSEExLgoKICAgIDpwYXJhbSBwcml2YXRlX2tleToKICAgICAgICBBIFByaXZhdGVLZXkgb2JqZWN0CgogICAgOnBhcmFtIGNpcGhlcnRleHQ6CiAgICAgICAgQSBieXRlIHN0cmluZyBvZiB0aGUgZW5jcnlwdGVkIGRhdGEKCiAgICA6cmFpc2VzOgogICAgICAgIFZhbHVlRXJyb3IgLSB3aGVuIGFueSBvZiB0aGUgcGFyYW1ldGVycyBjb250YWluIGFuIGludmFsaWQgdmFsdWUKICAgICAgICBUeXBlRXJyb3IgLSB3aGVuIGFueSBvZiB0aGUgcGFyYW1ldGVycyBhcmUgb2YgdGhlIHdyb25nIHR5cGUKICAgICAgICBPU0Vycm9yIC0gd2hlbiBhbiBlcnJvciBpcyByZXR1cm5lZCBieSB0aGUgT1MgY3J5cHRvIGxpYnJhcnkKCiAgICA6cmV0dXJuOgogICAgICAgIEEgYnl0ZSBzdHJpbmcgb2YgdGhlIG9yaWdpbmFsIHBsYWludGV4dAogICAgIiIiCgogICAgcmV0dXJuIF9kZWNyeXB0KHByaXZhdGVfa2V5LCBjaXBoZXJ0ZXh0LCBTZWN1cml0eS5rU2VjUGFkZGluZ09BRVBLZXkpCgoKZGVmIF9lbmNyeXB0KGNlcnRpZmljYXRlX29yX3B1YmxpY19rZXksIGRhdGEsIHBhZGRpbmcpOgogICAgIiIiCiAgICBFbmNyeXB0cyBwbGFpbnRleHQgdXNpbmcgYW4gUlNBIHB1YmxpYyBrZXkgb3IgY2VydGlmaWNhdGUKCiAgICA6cGFyYW0gY2VydGlmaWNhdGVfb3JfcHVibGljX2tleToKICAgICAgICBBIENlcnRpZmljYXRlIG9yIFB1YmxpY0tleSBvYmplY3QKCiAgICA6cGFyYW0gZGF0YToKICAgICAgICBUaGUgcGxhaW50ZXh0IC0gYSBieXRlIHN0cmluZwoKICAgIDpwYXJhbSBwYWRkaW5nOgogICAgICAgIFRoZSBwYWRkaW5nIG1vZGUgdG8gdXNlLCBzcGVjaWZpZWQgYXMgYSBrU2VjUGFkZGluZypLZXkgdmFsdWUKCiAgICA6cmFpc2VzOgogICAgICAgIFZhbHVlRXJyb3IgLSB3aGVuIGFueSBvZiB0aGUgcGFyYW1ldGVycyBjb250YWluIGFuIGludmFsaWQgdmFsdWUKICAgICAgICBUeXBlRXJyb3IgLSB3aGVuIGFueSBvZiB0aGUgcGFyYW1ldGVycyBhcmUgb2YgdGhlIHdyb25nIHR5cGUKICAgICAgICBPU0Vycm9yIC0gd2hlbiBhbiBlcnJvciBpcyByZXR1cm5lZCBieSB0aGUgT1MgY3J5cHRvIGxpYnJhcnkKCiAgICA6cmV0dXJuOgogICAgICAgIEEgYnl0ZSBzdHJpbmcgb2YgdGhlIGNpcGhlcnRleHQKICAgICIiIgoKICAgIGlmIG5vdCBpc2luc3RhbmNlKGNlcnRpZmljYXRlX29yX3B1YmxpY19rZXksIChDZXJ0aWZpY2F0ZSwgUHVibGljS2V5KSk6CiAgICAgICAgcmFpc2UgVHlwZUVycm9yKHByZXR0eV9tZXNzYWdlKAogICAgICAgICAgICAnJycKICAgICAgICAgICAgY2VydGlmaWNhdGVfb3JfcHVibGljX2tleSBtdXN0IGJlIGFuIGluc3RhbmNlIG9mIHRoZSBDZXJ0aWZpY2F0ZSBvcgogICAgICAgICAgICBQdWJsaWNLZXkgY2xhc3MsIG5vdCAlcwogICAgICAgICAgICAnJycsCiAgICAgICAgICAgIHR5cGVfbmFtZShjZXJ0aWZpY2F0ZV9vcl9wdWJsaWNfa2V5KQogICAgICAgICkpCgogICAgaWYgbm90IGlzaW5zdGFuY2UoZGF0YSwgYnl0ZV9jbHMpOgogICAgICAgIHJhaXNlIFR5cGVFcnJvcihwcmV0dHlfbWVzc2FnZSgKICAgICAgICAgICAgJycnCiAgICAgICAgICAgIGRhdGEgbXVzdCBiZSBhIGJ5dGUgc3RyaW5nLCBub3QgJXMKICAgICAgICAgICAgJycnLAogICAgICAgICAgICB0eXBlX25hbWUoZGF0YSkKICAgICAgICApKQoKICAgIGlmIG5vdCBwYWRkaW5nOgogICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoJ3BhZGRpbmcgbXVzdCBiZSBzcGVjaWZpZWQnKQoKICAgIGNmX2RhdGEgPSBOb25lCiAgICBzZWNfdHJhbnNmb3JtID0gTm9uZQoKICAgIHRyeToKICAgICAgICBjZl9kYXRhID0gQ0ZIZWxwZXJzLmNmX2RhdGFfZnJvbV9ieXRlcyhkYXRhKQoKICAgICAgICBlcnJvcl9wb2ludGVyID0gbmV3KENvcmVGb3VuZGF0aW9uLCAnQ0ZFcnJvclJlZiAqJykKICAgICAgICBzZWNfdHJhbnNmb3JtID0gU2VjdXJpdHkuU2VjRW5jcnlwdFRyYW5zZm9ybUNyZWF0ZSgKICAgICAgICAgICAgY2VydGlmaWNhdGVfb3JfcHVibGljX2tleS5zZWNfa2V5X3JlZiwKICAgICAgICAgICAgZXJyb3JfcG9pbnRlcgogICAgICAgICkKICAgICAgICBoYW5kbGVfY2ZfZXJyb3IoZXJyb3JfcG9pbnRlcikKCiAgICAgICAgaWYgcGFkZGluZzoKICAgICAgICAgICAgU2VjdXJpdHkuU2VjVHJhbnNmb3JtU2V0QXR0cmlidXRlKAogICAgICAgICAgICAgICAgc2VjX3RyYW5zZm9ybSwKICAgICAgICAgICAgICAgIFNlY3VyaXR5LmtTZWNQYWRkaW5nS2V5LAogICAgICAgICAgICAgICAgcGFkZGluZywKICAgICAgICAgICAgICAgIGVycm9yX3BvaW50ZXIKICAgICAgICAgICAgKQogICAgICAgICAgICBoYW5kbGVfY2ZfZXJyb3IoZXJyb3JfcG9pbnRlcikKCiAgICAgICAgU2VjdXJpdHkuU2VjVHJhbnNmb3JtU2V0QXR0cmlidXRlKAogICAgICAgICAgICBzZWNfdHJhbnNmb3JtLAogICAgICAgICAgICBTZWN1cml0eS5rU2VjVHJhbnNmb3JtSW5wdXRBdHRyaWJ1dGVOYW1lLAogICAgICAgICAgICBjZl9kYXRhLAogICAgICAgICAgICBlcnJvcl9wb2ludGVyCiAgICAgICAgKQogICAgICAgIGhhbmRsZV9jZl9lcnJvcihlcnJvcl9wb2ludGVyKQoKICAgICAgICBjaXBoZXJ0ZXh0ID0gU2VjdXJpdHkuU2VjVHJhbnNmb3JtRXhlY3V0ZShzZWNfdHJhbnNmb3JtLCBlcnJvcl9wb2ludGVyKQogICAgICAgIGhhbmRsZV9jZl9lcnJvcihlcnJvcl9wb2ludGVyKQoKICAgICAgICByZXR1cm4gQ0ZIZWxwZXJzLmNmX2RhdGFfdG9fYnl0ZXMoY2lwaGVydGV4dCkKCiAgICBmaW5hbGx5OgogICAgICAgIGlmIGNmX2RhdGE6CiAgICAgICAgICAgIENvcmVGb3VuZGF0aW9uLkNGUmVsZWFzZShjZl9kYXRhKQogICAgICAgIGlmIHNlY190cmFuc2Zvcm06CiAgICAgICAgICAgIENvcmVGb3VuZGF0aW9uLkNGUmVsZWFzZShzZWNfdHJhbnNmb3JtKQoKCmRlZiBfZGVjcnlwdChwcml2YXRlX2tleSwgY2lwaGVydGV4dCwgcGFkZGluZyk6CiAgICAiIiIKICAgIERlY3J5cHRzIFJTQSBjaXBoZXJ0ZXh0IHVzaW5nIGEgcHJpdmF0ZSBrZXkKCiAgICA6cGFyYW0gcHJpdmF0ZV9rZXk6CiAgICAgICAgQSBQcml2YXRlS2V5IG9iamVjdAoKICAgIDpwYXJhbSBjaXBoZXJ0ZXh0OgogICAgICAgIFRoZSBjaXBoZXJ0ZXh0IC0gYSBieXRlIHN0cmluZwoKICAgIDpwYXJhbSBwYWRkaW5nOgogICAgICAgIFRoZSBwYWRkaW5nIG1vZGUgdG8gdXNlLCBzcGVjaWZpZWQgYXMgYSBrU2VjUGFkZGluZypLZXkgdmFsdWUKCiAgICA6cmFpc2VzOgogICAgICAgIFZhbHVlRXJyb3IgLSB3aGVuIGFueSBvZiB0aGUgcGFyYW1ldGVycyBjb250YWluIGFuIGludmFsaWQgdmFsdWUKICAgICAgICBUeXBlRXJyb3IgLSB3aGVuIGFueSBvZiB0aGUgcGFyYW1ldGVycyBhcmUgb2YgdGhlIHdyb25nIHR5cGUKICAgICAgICBPU0Vycm9yIC0gd2hlbiBhbiBlcnJvciBpcyByZXR1cm5lZCBieSB0aGUgT1MgY3J5cHRvIGxpYnJhcnkKCiAgICA6cmV0dXJuOgogICAgICAgIEEgYnl0ZSBzdHJpbmcgb2YgdGhlIHBsYWludGV4dAogICAgIiIiCgogICAgaWYgbm90IGlzaW5zdGFuY2UocHJpdmF0ZV9rZXksIFByaXZhdGVLZXkpOgogICAgICAgIHJhaXNlIFR5cGVFcnJvcihwcmV0dHlfbWVzc2FnZSgKICAgICAgICAgICAgJycnCiAgICAgICAgICAgIHByaXZhdGVfa2V5IG11c3QgYmUgYW4gaW5zdGFuY2Ugb2YgdGhlIFByaXZhdGVLZXkgY2xhc3MsIG5vdCAlcwogICAgICAgICAgICAnJycsCiAgICAgICAgICAgIHR5cGVfbmFtZShwcml2YXRlX2tleSkKICAgICAgICApKQoKICAgIGlmIG5vdCBpc2luc3RhbmNlKGNpcGhlcnRleHQsIGJ5dGVfY2xzKToKICAgICAgICByYWlzZSBUeXBlRXJyb3IocHJldHR5X21lc3NhZ2UoCiAgICAgICAgICAgICcnJwogICAgICAgICAgICBjaXBoZXJ0ZXh0IG11c3QgYmUgYSBieXRlIHN0cmluZywgbm90ICVzCiAgICAgICAgICAgICcnJywKICAgICAgICAgICAgdHlwZV9uYW1lKGNpcGhlcnRleHQpCiAgICAgICAgKSkKCiAgICBpZiBub3QgcGFkZGluZzoKICAgICAgICByYWlzZSBWYWx1ZUVycm9yKCdwYWRkaW5nIG11c3QgYmUgc3BlY2lmaWVkJykKCiAgICBjZl9kYXRhID0gTm9uZQogICAgc2VjX3RyYW5zZm9ybSA9IE5vbmUKCiAgICB0cnk6CiAgICAgICAgY2ZfZGF0YSA9IENGSGVscGVycy5jZl9kYXRhX2Zyb21fYnl0ZXMoY2lwaGVydGV4dCkKCiAgICAgICAgZXJyb3JfcG9pbnRlciA9IG5ldyhDb3JlRm91bmRhdGlvbiwgJ0NGRXJyb3JSZWYgKicpCiAgICAgICAgc2VjX3RyYW5zZm9ybSA9IFNlY3VyaXR5LlNlY0RlY3J5cHRUcmFuc2Zvcm1DcmVhdGUoCiAgICAgICAgICAgIHByaXZhdGVfa2V5LnNlY19rZXlfcmVmLAogICAgICAgICAgICBlcnJvcl9wb2ludGVyCiAgICAgICAgKQogICAgICAgIGhhbmRsZV9jZl9lcnJvcihlcnJvcl9wb2ludGVyKQoKICAgICAgICBTZWN1cml0eS5TZWNUcmFuc2Zvcm1TZXRBdHRyaWJ1dGUoCiAgICAgICAgICAgIHNlY190cmFuc2Zvcm0sCiAgICAgICAgICAgIFNlY3VyaXR5LmtTZWNQYWRkaW5nS2V5LAogICAgICAgICAgICBwYWRkaW5nLAogICAgICAgICAgICBlcnJvcl9wb2ludGVyCiAgICAgICAgKQogICAgICAgIGhhbmRsZV9jZl9lcnJvcihlcnJvcl9wb2ludGVyKQoKICAgICAgICBTZWN1cml0eS5TZWNUcmFuc2Zvcm1TZXRBdHRyaWJ1dGUoCiAgICAgICAgICAgIHNlY190cmFuc2Zvcm0sCiAgICAgICAgICAgIFNlY3VyaXR5LmtTZWNUcmFuc2Zvcm1JbnB1dEF0dHJpYnV0ZU5hbWUsCiAgICAgICAgICAgIGNmX2RhdGEsCiAgICAgICAgICAgIGVycm9yX3BvaW50ZXIKICAgICAgICApCiAgICAgICAgaGFuZGxlX2NmX2Vycm9yKGVycm9yX3BvaW50ZXIpCgogICAgICAgIHBsYWludGV4dCA9IFNlY3VyaXR5LlNlY1RyYW5zZm9ybUV4ZWN1dGUoc2VjX3RyYW5zZm9ybSwgZXJyb3JfcG9pbnRlcikKICAgICAgICBoYW5kbGVfY2ZfZXJyb3IoZXJyb3JfcG9pbnRlcikKCiAgICAgICAgcmV0dXJuIENGSGVscGVycy5jZl9kYXRhX3RvX2J5dGVzKHBsYWludGV4dCkKCiAgICBmaW5hbGx5OgogICAgICAgIGlmIGNmX2RhdGE6CiAgICAgICAgICAgIENvcmVGb3VuZGF0aW9uLkNGUmVsZWFzZShjZl9kYXRhKQogICAgICAgIGlmIHNlY190cmFuc2Zvcm06CiAgICAgICAgICAgIENvcmVGb3VuZGF0aW9uLkNGUmVsZWFzZShzZWNfdHJhbnNmb3JtKQoKCmRlZiByc2FfcGtjczF2MTVfdmVyaWZ5KGNlcnRpZmljYXRlX29yX3B1YmxpY19rZXksIHNpZ25hdHVyZSwgZGF0YSwgaGFzaF9hbGdvcml0aG0pOgogICAgIiIiCiAgICBWZXJpZmllcyBhbiBSU0FTU0EtUEtDUy12MS41IHNpZ25hdHVyZS4KCiAgICBXaGVuIHRoZSBoYXNoX2FsZ29yaXRobSBpcyAicmF3IiwgdGhlIG9wZXJhdGlvbiBpcyBpZGVudGljYWwgdG8gUlNBCiAgICBwdWJsaWMga2V5IGRlY3J5cHRpb24uIFRoYXQgaXM6IHRoZSBkYXRhIGlzIG5vdCBoYXNoZWQgYW5kIG5vIEFTTi4xCiAgICBzdHJ1Y3R1cmUgd2l0aCBhbiBhbGdvcml0aG0gaWRlbnRpZmllciBvZiB0aGUgaGFzaCBhbGdvcml0aG0gaXMgcGxhY2VkIGluCiAgICB0aGUgZW5jcnlwdGVkIGJ5dGUgc3RyaW5nLgoKICAgIDpwYXJhbSBjZXJ0aWZpY2F0ZV9vcl9wdWJsaWNfa2V5OgogICAgICAgIEEgQ2VydGlmaWNhdGUgb3IgUHVibGljS2V5IGluc3RhbmNlIHRvIHZlcmlmeSB0aGUgc2lnbmF0dXJlIHdpdGgKCiAgICA6cGFyYW0gc2lnbmF0dXJlOgogICAgICAgIEEgYnl0ZSBzdHJpbmcgb2YgdGhlIHNpZ25hdHVyZSB0byB2ZXJpZnkKCiAgICA6cGFyYW0gZGF0YToKICAgICAgICBBIGJ5dGUgc3RyaW5nIG9mIHRoZSBkYXRhIHRoZSBzaWduYXR1cmUgaXMgZm9yCgogICAgOnBhcmFtIGhhc2hfYWxnb3JpdGhtOgogICAgICAgIEEgdW5pY29kZSBzdHJpbmcgb2YgIm1kNSIsICJzaGExIiwgInNoYTIyNCIsICJzaGEyNTYiLCAic2hhMzg0IiwgInNoYTUxMiIgb3IgInJhdyIKCiAgICA6cmFpc2VzOgogICAgICAgIG9zY3J5cHRvLmVycm9ycy5TaWduYXR1cmVFcnJvciAtIHdoZW4gdGhlIHNpZ25hdHVyZSBpcyBkZXRlcm1pbmVkIHRvIGJlIGludmFsaWQKICAgICAgICBWYWx1ZUVycm9yIC0gd2hlbiBhbnkgb2YgdGhlIHBhcmFtZXRlcnMgY29udGFpbiBhbiBpbnZhbGlkIHZhbHVlCiAgICAgICAgVHlwZUVycm9yIC0gd2hlbiBhbnkgb2YgdGhlIHBhcmFtZXRlcnMgYXJlIG9mIHRoZSB3cm9uZyB0eXBlCiAgICAgICAgT1NFcnJvciAtIHdoZW4gYW4gZXJyb3IgaXMgcmV0dXJuZWQgYnkgdGhlIE9TIGNyeXB0byBsaWJyYXJ5CiAgICAiIiIKCiAgICBpZiBjZXJ0aWZpY2F0ZV9vcl9wdWJsaWNfa2V5LmFsZ29yaXRobSAhPSAncnNhJzoKICAgICAgICByYWlzZSBWYWx1ZUVycm9yKCdUaGUga2V5IHNwZWNpZmllZCBpcyBub3QgYW4gUlNBIHB1YmxpYyBrZXknKQoKICAgIHJldHVybiBfdmVyaWZ5KGNlcnRpZmljYXRlX29yX3B1YmxpY19rZXksIHNpZ25hdHVyZSwgZGF0YSwgaGFzaF9hbGdvcml0aG0pCgoKZGVmIHJzYV9wc3NfdmVyaWZ5KGNlcnRpZmljYXRlX29yX3B1YmxpY19rZXksIHNpZ25hdHVyZSwgZGF0YSwgaGFzaF9hbGdvcml0aG0pOgogICAgIiIiCiAgICBWZXJpZmllcyBhbiBSU0FTU0EtUFNTIHNpZ25hdHVyZS4gRm9yIHRoZSBQU1MgcGFkZGluZyB0aGUgbWFzayBnZW4gYWxnb3JpdGhtCiAgICB3aWxsIGJlIG1nZjEgdXNpbmcgdGhlIHNhbWUgaGFzaCBhbGdvcml0aG0gYXMgdGhlIHNpZ25hdHVyZS4gVGhlIHNhbHQgbGVuZ3RoCiAgICB3aXRoIGJlIHRoZSBsZW5ndGggb2YgdGhlIGhhc2ggYWxnb3JpdGhtLCBhbmQgdGhlIHRyYWlsZXIgZmllbGQgd2l0aCBiZSB0aGUKICAgIHN0YW5kYXJkIDB4QkMgYnl0ZS4KCiAgICA6cGFyYW0gY2VydGlmaWNhdGVfb3JfcHVibGljX2tleToKICAgICAgICBBIENlcnRpZmljYXRlIG9yIFB1YmxpY0tleSBpbnN0YW5jZSB0byB2ZXJpZnkgdGhlIHNpZ25hdHVyZSB3aXRoCgogICAgOnBhcmFtIHNpZ25hdHVyZToKICAgICAgICBBIGJ5dGUgc3RyaW5nIG9mIHRoZSBzaWduYXR1cmUgdG8gdmVyaWZ5CgogICAgOnBhcmFtIGRhdGE6CiAgICAgICAgQSBieXRlIHN0cmluZyBvZiB0aGUgZGF0YSB0aGUgc2lnbmF0dXJlIGlzIGZvcgoKICAgIDpwYXJhbSBoYXNoX2FsZ29yaXRobToKICAgICAgICBBIHVuaWNvZGUgc3RyaW5nIG9mICJtZDUiLCAic2hhMSIsICJzaGEyMjQiLCAic2hhMjU2IiwgInNoYTM4NCIgb3IgInNoYTUxMiIKCiAgICA6cmFpc2VzOgogICAgICAgIG9zY3J5cHRvLmVycm9ycy5TaWduYXR1cmVFcnJvciAtIHdoZW4gdGhlIHNpZ25hdHVyZSBpcyBkZXRlcm1pbmVkIHRvIGJlIGludmFsaWQKICAgICAgICBWYWx1ZUVycm9yIC0gd2hlbiBhbnkgb2YgdGhlIHBhcmFtZXRlcnMgY29udGFpbiBhbiBpbnZhbGlkIHZhbHVlCiAgICAgICAgVHlwZUVycm9yIC0gd2hlbiBhbnkgb2YgdGhlIHBhcmFtZXRlcnMgYXJlIG9mIHRoZSB3cm9uZyB0eXBlCiAgICAgICAgT1NFcnJvciAtIHdoZW4gYW4gZXJyb3IgaXMgcmV0dXJuZWQgYnkgdGhlIE9TIGNyeXB0byBsaWJyYXJ5CiAgICAiIiIKCiAgICBpZiBub3QgaXNpbnN0YW5jZShjZXJ0aWZpY2F0ZV9vcl9wdWJsaWNfa2V5LCAoQ2VydGlmaWNhdGUsIFB1YmxpY0tleSkpOgogICAgICAgIHJhaXNlIFR5cGVFcnJvcihwcmV0dHlfbWVzc2FnZSgKICAgICAgICAgICAgJycnCiAgICAgICAgICAgIGNlcnRpZmljYXRlX29yX3B1YmxpY19rZXkgbXVzdCBiZSBhbiBpbnN0YW5jZSBvZiB0aGUgQ2VydGlmaWNhdGUgb3IKICAgICAgICAgICAgUHVibGljS2V5IGNsYXNzLCBub3QgJXMKICAgICAgICAgICAgJycnLAogICAgICAgICAgICB0eXBlX25hbWUoY2VydGlmaWNhdGVfb3JfcHVibGljX2tleSkKICAgICAgICApKQoKICAgIGlmIG5vdCBpc2luc3RhbmNlKGRhdGEsIGJ5dGVfY2xzKToKICAgICAgICByYWlzZSBUeXBlRXJyb3IocHJldHR5X21lc3NhZ2UoCiAgICAgICAgICAgICcnJwogICAgICAgICAgICBkYXRhIG11c3QgYmUgYSBieXRlIHN0cmluZywgbm90ICVzCiAgICAgICAgICAgICcnJywKICAgICAgICAgICAgdHlwZV9uYW1lKGRhdGEpCiAgICAgICAgKSkKCiAgICBjcF9hbGdvID0gY2VydGlmaWNhdGVfb3JfcHVibGljX2tleS5hbGdvcml0aG0KICAgIGlmIGNwX2FsZ28gIT0gJ3JzYScgYW5kIGNwX2FsZ28gIT0gJ3JzYXNzYV9wc3MnOgogICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoJ1RoZSBrZXkgc3BlY2lmaWVkIGlzIG5vdCBhbiBSU0EgcHVibGljIGtleScpCgogICAgaGFzaF9sZW5ndGggPSB7CiAgICAgICAgJ3NoYTEnOiAyMCwKICAgICAgICAnc2hhMjI0JzogMjgsCiAgICAgICAgJ3NoYTI1Nic6IDMyLAogICAgICAgICdzaGEzODQnOiA0OCwKICAgICAgICAnc2hhNTEyJzogNjQKICAgIH0uZ2V0KGhhc2hfYWxnb3JpdGhtLCAwKQoKICAgIGtleV9sZW5ndGggPSBjZXJ0aWZpY2F0ZV9vcl9wdWJsaWNfa2V5LmJ5dGVfc2l6ZQogICAgYnVmZmVyID0gYnVmZmVyX2Zyb21fYnl0ZXMoa2V5X2xlbmd0aCkKICAgIG91dHB1dF9sZW5ndGggPSBuZXcoU2VjdXJpdHksICdzaXplX3QgKicsIGtleV9sZW5ndGgpCiAgICByZXN1bHQgPSBTZWN1cml0eS5TZWNLZXlFbmNyeXB0KAogICAgICAgIGNlcnRpZmljYXRlX29yX3B1YmxpY19rZXkuc2VjX2tleV9yZWYsCiAgICAgICAgU2VjdXJpdHlDb25zdC5rU2VjUGFkZGluZ05vbmUsCiAgICAgICAgc2lnbmF0dXJlLAogICAgICAgIGxlbihzaWduYXR1cmUpLAogICAgICAgIGJ1ZmZlciwKICAgICAgICBvdXRwdXRfbGVuZ3RoCiAgICApCiAgICBoYW5kbGVfc2VjX2Vycm9yKHJlc3VsdCkKCiAgICBwbGFpbnRleHQgPSBieXRlc19mcm9tX2J1ZmZlcihidWZmZXIsIGRlcmVmKG91dHB1dF9sZW5ndGgpKQogICAgaWYgbm90IHZlcmlmeV9wc3NfcGFkZGluZyhoYXNoX2FsZ29yaXRobSwgaGFzaF9sZW5ndGgsIGNlcnRpZmljYXRlX29yX3B1YmxpY19rZXkuYml0X3NpemUsIGRhdGEsIHBsYWludGV4dCk6CiAgICAgICAgcmFpc2UgU2lnbmF0dXJlRXJyb3IoJ1NpZ25hdHVyZSBpcyBpbnZhbGlkJykKCgpkZWYgZHNhX3ZlcmlmeShjZXJ0aWZpY2F0ZV9vcl9wdWJsaWNfa2V5LCBzaWduYXR1cmUsIGRhdGEsIGhhc2hfYWxnb3JpdGhtKToKICAgICIiIgogICAgVmVyaWZpZXMgYSBEU0Egc2lnbmF0dXJlCgogICAgOnBhcmFtIGNlcnRpZmljYXRlX29yX3B1YmxpY19rZXk6CiAgICAgICAgQSBDZXJ0aWZpY2F0ZSBvciBQdWJsaWNLZXkgaW5zdGFuY2UgdG8gdmVyaWZ5IHRoZSBzaWduYXR1cmUgd2l0aAoKICAgIDpwYXJhbSBzaWduYXR1cmU6CiAgICAgICAgQSBieXRlIHN0cmluZyBvZiB0aGUgc2lnbmF0dXJlIHRvIHZlcmlmeQoKICAgIDpwYXJhbSBkYXRhOgogICAgICAgIEEgYnl0ZSBzdHJpbmcgb2YgdGhlIGRhdGEgdGhlIHNpZ25hdHVyZSBpcyBmb3IKCiAgICA6cGFyYW0gaGFzaF9hbGdvcml0aG06CiAgICAgICAgQSB1bmljb2RlIHN0cmluZyBvZiAibWQ1IiwgInNoYTEiLCAic2hhMjI0IiwgInNoYTI1NiIsICJzaGEzODQiIG9yICJzaGE1MTIiCgogICAgOnJhaXNlczoKICAgICAgICBvc2NyeXB0by5lcnJvcnMuU2lnbmF0dXJlRXJyb3IgLSB3aGVuIHRoZSBzaWduYXR1cmUgaXMgZGV0ZXJtaW5lZCB0byBiZSBpbnZhbGlkCiAgICAgICAgVmFsdWVFcnJvciAtIHdoZW4gYW55IG9mIHRoZSBwYXJhbWV0ZXJzIGNvbnRhaW4gYW4gaW52YWxpZCB2YWx1ZQogICAgICAgIFR5cGVFcnJvciAtIHdoZW4gYW55IG9mIHRoZSBwYXJhbWV0ZXJzIGFyZSBvZiB0aGUgd3JvbmcgdHlwZQogICAgICAgIE9TRXJyb3IgLSB3aGVuIGFuIGVycm9yIGlzIHJldHVybmVkIGJ5IHRoZSBPUyBjcnlwdG8gbGlicmFyeQogICAgIiIiCgogICAgaWYgY2VydGlmaWNhdGVfb3JfcHVibGljX2tleS5hbGdvcml0aG0gIT0gJ2RzYSc6CiAgICAgICAgcmFpc2UgVmFsdWVFcnJvcignVGhlIGtleSBzcGVjaWZpZWQgaXMgbm90IGEgRFNBIHB1YmxpYyBrZXknKQoKICAgIHJldHVybiBfdmVyaWZ5KGNlcnRpZmljYXRlX29yX3B1YmxpY19rZXksIHNpZ25hdHVyZSwgZGF0YSwgaGFzaF9hbGdvcml0aG0pCgoKZGVmIGVjZHNhX3ZlcmlmeShjZXJ0aWZpY2F0ZV9vcl9wdWJsaWNfa2V5LCBzaWduYXR1cmUsIGRhdGEsIGhhc2hfYWxnb3JpdGhtKToKICAgICIiIgogICAgVmVyaWZpZXMgYW4gRUNEU0Egc2lnbmF0dXJlCgogICAgOnBhcmFtIGNlcnRpZmljYXRlX29yX3B1YmxpY19rZXk6CiAgICAgICAgQSBDZXJ0aWZpY2F0ZSBvciBQdWJsaWNLZXkgaW5zdGFuY2UgdG8gdmVyaWZ5IHRoZSBzaWduYXR1cmUgd2l0aAoKICAgIDpwYXJhbSBzaWduYXR1cmU6CiAgICAgICAgQSBieXRlIHN0cmluZyBvZiB0aGUgc2lnbmF0dXJlIHRvIHZlcmlmeQoKICAgIDpwYXJhbSBkYXRhOgogICAgICAgIEEgYnl0ZSBzdHJpbmcgb2YgdGhlIGRhdGEgdGhlIHNpZ25hdHVyZSBpcyBmb3IKCiAgICA6cGFyYW0gaGFzaF9hbGdvcml0aG06CiAgICAgICAgQSB1bmljb2RlIHN0cmluZyBvZiAibWQ1IiwgInNoYTEiLCAic2hhMjI0IiwgInNoYTI1NiIsICJzaGEzODQiIG9yICJzaGE1MTIiCgogICAgOnJhaXNlczoKICAgICAgICBvc2NyeXB0by5lcnJvcnMuU2lnbmF0dXJlRXJyb3IgLSB3aGVuIHRoZSBzaWduYXR1cmUgaXMgZGV0ZXJtaW5lZCB0byBiZSBpbnZhbGlkCiAgICAgICAgVmFsdWVFcnJvciAtIHdoZW4gYW55IG9mIHRoZSBwYXJhbWV0ZXJzIGNvbnRhaW4gYW4gaW52YWxpZCB2YWx1ZQogICAgICAgIFR5cGVFcnJvciAtIHdoZW4gYW55IG9mIHRoZSBwYXJhbWV0ZXJzIGFyZSBvZiB0aGUgd3JvbmcgdHlwZQogICAgICAgIE9TRXJyb3IgLSB3aGVuIGFuIGVycm9yIGlzIHJldHVybmVkIGJ5IHRoZSBPUyBjcnlwdG8gbGlicmFyeQogICAgIiIiCgogICAgaWYgY2VydGlmaWNhdGVfb3JfcHVibGljX2tleS5hbGdvcml0aG0gIT0gJ2VjJzoKICAgICAgICByYWlzZSBWYWx1ZUVycm9yKCdUaGUga2V5IHNwZWNpZmllZCBpcyBub3QgYW4gRUMgcHVibGljIGtleScpCgogICAgcmV0dXJuIF92ZXJpZnkoY2VydGlmaWNhdGVfb3JfcHVibGljX2tleSwgc2lnbmF0dXJlLCBkYXRhLCBoYXNoX2FsZ29yaXRobSkKCgpkZWYgX3ZlcmlmeShjZXJ0aWZpY2F0ZV9vcl9wdWJsaWNfa2V5LCBzaWduYXR1cmUsIGRhdGEsIGhhc2hfYWxnb3JpdGhtKToKICAgICIiIgogICAgVmVyaWZpZXMgYW4gUlNBLCBEU0Egb3IgRUNEU0Egc2lnbmF0dXJlCgogICAgOnBhcmFtIGNlcnRpZmljYXRlX29yX3B1YmxpY19rZXk6CiAgICAgICAgQSBDZXJ0aWZpY2F0ZSBvciBQdWJsaWNLZXkgaW5zdGFuY2UgdG8gdmVyaWZ5IHRoZSBzaWduYXR1cmUgd2l0aAoKICAgIDpwYXJhbSBzaWduYXR1cmU6CiAgICAgICAgQSBieXRlIHN0cmluZyBvZiB0aGUgc2lnbmF0dXJlIHRvIHZlcmlmeQoKICAgIDpwYXJhbSBkYXRhOgogICAgICAgIEEgYnl0ZSBzdHJpbmcgb2YgdGhlIGRhdGEgdGhlIHNpZ25hdHVyZSBpcyBmb3IKCiAgICA6cGFyYW0gaGFzaF9hbGdvcml0aG06CiAgICAgICAgQSB1bmljb2RlIHN0cmluZyBvZiAibWQ1IiwgInNoYTEiLCAic2hhMjI0IiwgInNoYTI1NiIsICJzaGEzODQiIG9yICJzaGE1MTIiCgogICAgOnJhaXNlczoKICAgICAgICBvc2NyeXB0by5lcnJvcnMuU2lnbmF0dXJlRXJyb3IgLSB3aGVuIHRoZSBzaWduYXR1cmUgaXMgZGV0ZXJtaW5lZCB0byBiZSBpbnZhbGlkCiAgICAgICAgVmFsdWVFcnJvciAtIHdoZW4gYW55IG9mIHRoZSBwYXJhbWV0ZXJzIGNvbnRhaW4gYW4gaW52YWxpZCB2YWx1ZQogICAgICAgIFR5cGVFcnJvciAtIHdoZW4gYW55IG9mIHRoZSBwYXJhbWV0ZXJzIGFyZSBvZiB0aGUgd3JvbmcgdHlwZQogICAgICAgIE9TRXJyb3IgLSB3aGVuIGFuIGVycm9yIGlzIHJldHVybmVkIGJ5IHRoZSBPUyBjcnlwdG8gbGlicmFyeQogICAgIiIiCgogICAgaWYgbm90IGlzaW5zdGFuY2UoY2VydGlmaWNhdGVfb3JfcHVibGljX2tleSwgKENlcnRpZmljYXRlLCBQdWJsaWNLZXkpKToKICAgICAgICByYWlzZSBUeXBlRXJyb3IocHJldHR5X21lc3NhZ2UoCiAgICAgICAgICAgICcnJwogICAgICAgICAgICBjZXJ0aWZpY2F0ZV9vcl9wdWJsaWNfa2V5IG11c3QgYmUgYW4gaW5zdGFuY2Ugb2YgdGhlIENlcnRpZmljYXRlIG9yCiAgICAgICAgICAgIFB1YmxpY0tleSBjbGFzcywgbm90ICVzCiAgICAgICAgICAgICcnJywKICAgICAgICAgICAgdHlwZV9uYW1lKGNlcnRpZmljYXRlX29yX3B1YmxpY19rZXkpCiAgICAgICAgKSkKCiAgICBpZiBub3QgaXNpbnN0YW5jZShzaWduYXR1cmUsIGJ5dGVfY2xzKToKICAgICAgICByYWlzZSBUeXBlRXJyb3IocHJldHR5X21lc3NhZ2UoCiAgICAgICAgICAgICcnJwogICAgICAgICAgICBzaWduYXR1cmUgbXVzdCBiZSBhIGJ5dGUgc3RyaW5nLCBub3QgJXMKICAgICAgICAgICAgJycnLAogICAgICAgICAgICB0eXBlX25hbWUoc2lnbmF0dXJlKQogICAgICAgICkpCgogICAgaWYgbm90IGlzaW5zdGFuY2UoZGF0YSwgYnl0ZV9jbHMpOgogICAgICAgIHJhaXNlIFR5cGVFcnJvcihwcmV0dHlfbWVzc2FnZSgKICAgICAgICAgICAgJycnCiAgICAgICAgICAgIGRhdGEgbXVzdCBiZSBhIGJ5dGUgc3RyaW5nLCBub3QgJXMKICAgICAgICAgICAgJycnLAogICAgICAgICAgICB0eXBlX25hbWUoZGF0YSkKICAgICAgICApKQoKICAgIHZhbGlkX2hhc2hfYWxnb3JpdGhtcyA9IHNldChbJ21kNScsICdzaGExJywgJ3NoYTIyNCcsICdzaGEyNTYnLCAnc2hhMzg0JywgJ3NoYTUxMiddKQogICAgaWYgY2VydGlmaWNhdGVfb3JfcHVibGljX2tleS5hbGdvcml0aG0gPT0gJ3JzYSc6CiAgICAgICAgdmFsaWRfaGFzaF9hbGdvcml0aG1zIHw9IHNldChbJ3JhdyddKQoKICAgIGlmIGhhc2hfYWxnb3JpdGhtIG5vdCBpbiB2YWxpZF9oYXNoX2FsZ29yaXRobXM6CiAgICAgICAgdmFsaWRfaGFzaF9hbGdvcml0aG1zX2Vycm9yID0gJyJtZDUiLCAic2hhMSIsICJzaGEyMjQiLCAic2hhMjU2IiwgInNoYTM4NCIsICJzaGE1MTIiJwogICAgICAgIGlmIGNlcnRpZmljYXRlX29yX3B1YmxpY19rZXkuYWxnb3JpdGhtID09ICdyc2EnOgogICAgICAgICAgICB2YWxpZF9oYXNoX2FsZ29yaXRobXNfZXJyb3IgKz0gJywgInJhdyInCiAgICAgICAgcmFpc2UgVmFsdWVFcnJvcihwcmV0dHlfbWVzc2FnZSgKICAgICAgICAgICAgJycnCiAgICAgICAgICAgIGhhc2hfYWxnb3JpdGhtIG11c3QgYmUgb25lIG9mICVzLCBub3QgJXMKICAgICAgICAgICAgJycnLAogICAgICAgICAgICB2YWxpZF9oYXNoX2FsZ29yaXRobXNfZXJyb3IsCiAgICAgICAgICAgIHJlcHIoaGFzaF9hbGdvcml0aG0pCiAgICAgICAgKSkKCiAgICBpZiBjZXJ0aWZpY2F0ZV9vcl9wdWJsaWNfa2V5LmFsZ29yaXRobSA9PSAncnNhJyBhbmQgaGFzaF9hbGdvcml0aG0gPT0gJ3Jhdyc6CiAgICAgICAgaWYgbGVuKGRhdGEpID4gY2VydGlmaWNhdGVfb3JfcHVibGljX2tleS5ieXRlX3NpemUgLSAxMToKICAgICAgICAgICAgcmFpc2UgVmFsdWVFcnJvcihwcmV0dHlfbWVzc2FnZSgKICAgICAgICAgICAgICAgICcnJwogICAgICAgICAgICAgICAgZGF0YSBtdXN0IGJlIDExIGJ5dGVzIHNob3J0ZXIgdGhhbiB0aGUga2V5IHNpemUgd2hlbgogICAgICAgICAgICAgICAgaGFzaF9hbGdvcml0aG0gaXMgInJhdyIgLSBrZXkgc2l6ZSBpcyAlcyBieXRlcywgYnV0IGRhdGEKICAgICAgICAgICAgICAgIGlzICVzIGJ5dGVzIGxvbmcKICAgICAgICAgICAgICAgICcnJywKICAgICAgICAgICAgICAgIGNlcnRpZmljYXRlX29yX3B1YmxpY19rZXkuYnl0ZV9zaXplLAogICAgICAgICAgICAgICAgbGVuKGRhdGEpCiAgICAgICAgICAgICkpCgogICAgICAgIHJlc3VsdCA9IFNlY3VyaXR5LlNlY0tleVJhd1ZlcmlmeSgKICAgICAgICAgICAgY2VydGlmaWNhdGVfb3JfcHVibGljX2tleS5zZWNfa2V5X3JlZiwKICAgICAgICAgICAgU2VjdXJpdHlDb25zdC5rU2VjUGFkZGluZ1BLQ1MxLAogICAgICAgICAgICBkYXRhLAogICAgICAgICAgICBsZW4oZGF0YSksCiAgICAgICAgICAgIHNpZ25hdHVyZSwKICAgICAgICAgICAgbGVuKHNpZ25hdHVyZSkKICAgICAgICApCiAgICAgICAgIyBlcnJTU0xDcnlwdG8gaXMgcmV0dXJuZWQgaW4gc29tZSBzaXR1YXRpb25zIG9uIG1hY09TIDEwLjEyCiAgICAgICAgaWYgcmVzdWx0ID09IFNlY3VyaXR5Q29uc3QuZXJyU2VjVmVyaWZ5RmFpbGVkIG9yIHJlc3VsdCA9PSBTZWN1cml0eUNvbnN0LmVyclNTTENyeXB0bzoKICAgICAgICAgICAgcmFpc2UgU2lnbmF0dXJlRXJyb3IoJ1NpZ25hdHVyZSBpcyBpbnZhbGlkJykKICAgICAgICBoYW5kbGVfc2VjX2Vycm9yKHJlc3VsdCkKICAgICAgICByZXR1cm4KCiAgICBjZl9zaWduYXR1cmUgPSBOb25lCiAgICBjZl9kYXRhID0gTm9uZQogICAgY2ZfaGFzaF9sZW5ndGggPSBOb25lCiAgICBzZWNfdHJhbnNmb3JtID0gTm9uZQoKICAgIHRyeToKICAgICAgICBlcnJvcl9wb2ludGVyID0gbmV3KENvcmVGb3VuZGF0aW9uLCAnQ0ZFcnJvclJlZiAqJykKICAgICAgICBjZl9zaWduYXR1cmUgPSBDRkhlbHBlcnMuY2ZfZGF0YV9mcm9tX2J5dGVzKHNpZ25hdHVyZSkKICAgICAgICBzZWNfdHJhbnNmb3JtID0gU2VjdXJpdHkuU2VjVmVyaWZ5VHJhbnNmb3JtQ3JlYXRlKAogICAgICAgICAgICBjZXJ0aWZpY2F0ZV9vcl9wdWJsaWNfa2V5LnNlY19rZXlfcmVmLAogICAgICAgICAgICBjZl9zaWduYXR1cmUsCiAgICAgICAgICAgIGVycm9yX3BvaW50ZXIKICAgICAgICApCiAgICAgICAgaGFuZGxlX2NmX2Vycm9yKGVycm9yX3BvaW50ZXIpCgogICAgICAgIGhhc2hfY29uc3RhbnQgPSB7CiAgICAgICAgICAgICdtZDUnOiBTZWN1cml0eS5rU2VjRGlnZXN0TUQ1LAogICAgICAgICAgICAnc2hhMSc6IFNlY3VyaXR5LmtTZWNEaWdlc3RTSEExLAogICAgICAgICAgICAnc2hhMjI0JzogU2VjdXJpdHkua1NlY0RpZ2VzdFNIQTIsCiAgICAgICAgICAgICdzaGEyNTYnOiBTZWN1cml0eS5rU2VjRGlnZXN0U0hBMiwKICAgICAgICAgICAgJ3NoYTM4NCc6IFNlY3VyaXR5LmtTZWNEaWdlc3RTSEEyLAogICAgICAgICAgICAnc2hhNTEyJzogU2VjdXJpdHkua1NlY0RpZ2VzdFNIQTIKICAgICAgICB9W2hhc2hfYWxnb3JpdGhtXQoKICAgICAgICBTZWN1cml0eS5TZWNUcmFuc2Zvcm1TZXRBdHRyaWJ1dGUoCiAgICAgICAgICAgIHNlY190cmFuc2Zvcm0sCiAgICAgICAgICAgIFNlY3VyaXR5LmtTZWNEaWdlc3RUeXBlQXR0cmlidXRlLAogICAgICAgICAgICBoYXNoX2NvbnN0YW50LAogICAgICAgICAgICBlcnJvcl9wb2ludGVyCiAgICAgICAgKQogICAgICAgIGhhbmRsZV9jZl9lcnJvcihlcnJvcl9wb2ludGVyKQoKICAgICAgICBpZiBoYXNoX2FsZ29yaXRobSBpbiBzZXQoWydzaGEyMjQnLCAnc2hhMjU2JywgJ3NoYTM4NCcsICdzaGE1MTInXSk6CiAgICAgICAgICAgIGhhc2hfbGVuZ3RoID0gewogICAgICAgICAgICAgICAgJ3NoYTIyNCc6IDIyNCwKICAgICAgICAgICAgICAgICdzaGEyNTYnOiAyNTYsCiAgICAgICAgICAgICAgICAnc2hhMzg0JzogMzg0LAogICAgICAgICAgICAgICAgJ3NoYTUxMic6IDUxMgogICAgICAgICAgICB9W2hhc2hfYWxnb3JpdGhtXQoKICAgICAgICAgICAgY2ZfaGFzaF9sZW5ndGggPSBDRkhlbHBlcnMuY2ZfbnVtYmVyX2Zyb21faW50ZWdlcihoYXNoX2xlbmd0aCkKCiAgICAgICAgICAgIFNlY3VyaXR5LlNlY1RyYW5zZm9ybVNldEF0dHJpYnV0ZSgKICAgICAgICAgICAgICAgIHNlY190cmFuc2Zvcm0sCiAgICAgICAgICAgICAgICBTZWN1cml0eS5rU2VjRGlnZXN0TGVuZ3RoQXR0cmlidXRlLAogICAgICAgICAgICAgICAgY2ZfaGFzaF9sZW5ndGgsCiAgICAgICAgICAgICAgICBlcnJvcl9wb2ludGVyCiAgICAgICAgICAgICkKICAgICAgICAgICAgaGFuZGxlX2NmX2Vycm9yKGVycm9yX3BvaW50ZXIpCgogICAgICAgIGlmIGNlcnRpZmljYXRlX29yX3B1YmxpY19rZXkuYWxnb3JpdGhtID09ICdyc2EnOgogICAgICAgICAgICBTZWN1cml0eS5TZWNUcmFuc2Zvcm1TZXRBdHRyaWJ1dGUoCiAgICAgICAgICAgICAgICBzZWNfdHJhbnNmb3JtLAogICAgICAgICAgICAgICAgU2VjdXJpdHkua1NlY1BhZGRpbmdLZXksCiAgICAgICAgICAgICAgICBTZWN1cml0eS5rU2VjUGFkZGluZ1BLQ1MxS2V5LAogICAgICAgICAgICAgICAgZXJyb3JfcG9pbnRlcgogICAgICAgICAgICApCiAgICAgICAgICAgIGhhbmRsZV9jZl9lcnJvcihlcnJvcl9wb2ludGVyKQoKICAgICAgICBjZl9kYXRhID0gQ0ZIZWxwZXJzLmNmX2RhdGFfZnJvbV9ieXRlcyhkYXRhKQogICAgICAgIFNlY3VyaXR5LlNlY1RyYW5zZm9ybVNldEF0dHJpYnV0ZSgKICAgICAgICAgICAgc2VjX3RyYW5zZm9ybSwKICAgICAgICAgICAgU2VjdXJpdHkua1NlY1RyYW5zZm9ybUlucHV0QXR0cmlidXRlTmFtZSwKICAgICAgICAgICAgY2ZfZGF0YSwKICAgICAgICAgICAgZXJyb3JfcG9pbnRlcgogICAgICAgICkKICAgICAgICBoYW5kbGVfY2ZfZXJyb3IoZXJyb3JfcG9pbnRlcikKCiAgICAgICAgcmVzID0gU2VjdXJpdHkuU2VjVHJhbnNmb3JtRXhlY3V0ZShzZWNfdHJhbnNmb3JtLCBlcnJvcl9wb2ludGVyKQogICAgICAgIGlmIG5vdCBpc19udWxsKGVycm9yX3BvaW50ZXIpOgogICAgICAgICAgICBlcnJvciA9IHVud3JhcChlcnJvcl9wb2ludGVyKQogICAgICAgICAgICBpZiBub3QgaXNfbnVsbChlcnJvcik6CiAgICAgICAgICAgICAgICByYWlzZSBTaWduYXR1cmVFcnJvcignU2lnbmF0dXJlIGlzIGludmFsaWQnKQoKICAgICAgICByZXMgPSBib29sKENvcmVGb3VuZGF0aW9uLkNGQm9vbGVhbkdldFZhbHVlKHJlcykpCgogICAgICAgIGlmIG5vdCByZXM6CiAgICAgICAgICAgIHJhaXNlIFNpZ25hdHVyZUVycm9yKCdTaWduYXR1cmUgaXMgaW52YWxpZCcpCgogICAgZmluYWxseToKICAgICAgICBpZiBzZWNfdHJhbnNmb3JtOgogICAgICAgICAgICBDb3JlRm91bmRhdGlvbi5DRlJlbGVhc2Uoc2VjX3RyYW5zZm9ybSkKICAgICAgICBpZiBjZl9zaWduYXR1cmU6CiAgICAgICAgICAgIENvcmVGb3VuZGF0aW9uLkNGUmVsZWFzZShjZl9zaWduYXR1cmUpCiAgICAgICAgaWYgY2ZfZGF0YToKICAgICAgICAgICAgQ29yZUZvdW5kYXRpb24uQ0ZSZWxlYXNlKGNmX2RhdGEpCiAgICAgICAgaWYgY2ZfaGFzaF9sZW5ndGg6CiAgICAgICAgICAgIENvcmVGb3VuZGF0aW9uLkNGUmVsZWFzZShjZl9oYXNoX2xlbmd0aCkKCgpkZWYgcnNhX3BrY3MxdjE1X3NpZ24ocHJpdmF0ZV9rZXksIGRhdGEsIGhhc2hfYWxnb3JpdGhtKToKICAgICIiIgogICAgR2VuZXJhdGVzIGFuIFJTQVNTQS1QS0NTLXYxLjUgc2lnbmF0dXJlLgoKICAgIFdoZW4gdGhlIGhhc2hfYWxnb3JpdGhtIGlzICJyYXciLCB0aGUgb3BlcmF0aW9uIGlzIGlkZW50aWNhbCB0byBSU0EKICAgIHByaXZhdGUga2V5IGVuY3J5cHRpb24uIFRoYXQgaXM6IHRoZSBkYXRhIGlzIG5vdCBoYXNoZWQgYW5kIG5vIEFTTi4xCiAgICBzdHJ1Y3R1cmUgd2l0aCBhbiBhbGdvcml0aG0gaWRlbnRpZmllciBvZiB0aGUgaGFzaCBhbGdvcml0aG0gaXMgcGxhY2VkIGluCiAgICB0aGUgZW5jcnlwdGVkIGJ5dGUgc3RyaW5nLgoKICAgIDpwYXJhbSBwcml2YXRlX2tleToKICAgICAgICBUaGUgUHJpdmF0ZUtleSB0byBnZW5lcmF0ZSB0aGUgc2lnbmF0dXJlIHdpdGgKCiAgICA6cGFyYW0gZGF0YToKICAgICAgICBBIGJ5dGUgc3RyaW5nIG9mIHRoZSBkYXRhIHRoZSBzaWduYXR1cmUgaXMgZm9yCgogICAgOnBhcmFtIGhhc2hfYWxnb3JpdGhtOgogICAgICAgIEEgdW5pY29kZSBzdHJpbmcgb2YgIm1kNSIsICJzaGExIiwgInNoYTIyNCIsICJzaGEyNTYiLCAic2hhMzg0IiwKICAgICAgICAic2hhNTEyIiBvciAicmF3IgoKICAgIDpyYWlzZXM6CiAgICAgICAgVmFsdWVFcnJvciAtIHdoZW4gYW55IG9mIHRoZSBwYXJhbWV0ZXJzIGNvbnRhaW4gYW4gaW52YWxpZCB2YWx1ZQogICAgICAgIFR5cGVFcnJvciAtIHdoZW4gYW55IG9mIHRoZSBwYXJhbWV0ZXJzIGFyZSBvZiB0aGUgd3JvbmcgdHlwZQogICAgICAgIE9TRXJyb3IgLSB3aGVuIGFuIGVycm9yIGlzIHJldHVybmVkIGJ5IHRoZSBPUyBjcnlwdG8gbGlicmFyeQoKICAgIDpyZXR1cm46CiAgICAgICAgQSBieXRlIHN0cmluZyBvZiB0aGUgc2lnbmF0dXJlCiAgICAiIiIKCiAgICBpZiBwcml2YXRlX2tleS5hbGdvcml0aG0gIT0gJ3JzYSc6CiAgICAgICAgcmFpc2UgVmFsdWVFcnJvcignVGhlIGtleSBzcGVjaWZpZWQgaXMgbm90IGFuIFJTQSBwcml2YXRlIGtleScpCgogICAgcmV0dXJuIF9zaWduKHByaXZhdGVfa2V5LCBkYXRhLCBoYXNoX2FsZ29yaXRobSkKCgpkZWYgcnNhX3Bzc19zaWduKHByaXZhdGVfa2V5LCBkYXRhLCBoYXNoX2FsZ29yaXRobSk6CiAgICAiIiIKICAgIEdlbmVyYXRlcyBhbiBSU0FTU0EtUFNTIHNpZ25hdHVyZS4gRm9yIHRoZSBQU1MgcGFkZGluZyB0aGUgbWFzayBnZW4KICAgIGFsZ29yaXRobSB3aWxsIGJlIG1nZjEgdXNpbmcgdGhlIHNhbWUgaGFzaCBhbGdvcml0aG0gYXMgdGhlIHNpZ25hdHVyZS4gVGhlCiAgICBzYWx0IGxlbmd0aCB3aXRoIGJlIHRoZSBsZW5ndGggb2YgdGhlIGhhc2ggYWxnb3JpdGhtLCBhbmQgdGhlIHRyYWlsZXIgZmllbGQKICAgIHdpdGggYmUgdGhlIHN0YW5kYXJkIDB4QkMgYnl0ZS4KCiAgICA6cGFyYW0gcHJpdmF0ZV9rZXk6CiAgICAgICAgVGhlIFByaXZhdGVLZXkgdG8gZ2VuZXJhdGUgdGhlIHNpZ25hdHVyZSB3aXRoCgogICAgOnBhcmFtIGRhdGE6CiAgICAgICAgQSBieXRlIHN0cmluZyBvZiB0aGUgZGF0YSB0aGUgc2lnbmF0dXJlIGlzIGZvcgoKICAgIDpwYXJhbSBoYXNoX2FsZ29yaXRobToKICAgICAgICBBIHVuaWNvZGUgc3RyaW5nIG9mICJtZDUiLCAic2hhMSIsICJzaGEyMjQiLCAic2hhMjU2IiwgInNoYTM4NCIgb3IKICAgICAgICAic2hhNTEyIgoKICAgIDpyYWlzZXM6CiAgICAgICAgVmFsdWVFcnJvciAtIHdoZW4gYW55IG9mIHRoZSBwYXJhbWV0ZXJzIGNvbnRhaW4gYW4gaW52YWxpZCB2YWx1ZQogICAgICAgIFR5cGVFcnJvciAtIHdoZW4gYW55IG9mIHRoZSBwYXJhbWV0ZXJzIGFyZSBvZiB0aGUgd3JvbmcgdHlwZQogICAgICAgIE9TRXJyb3IgLSB3aGVuIGFuIGVycm9yIGlzIHJldHVybmVkIGJ5IHRoZSBPUyBjcnlwdG8gbGlicmFyeQoKICAgIDpyZXR1cm46CiAgICAgICAgQSBieXRlIHN0cmluZyBvZiB0aGUgc2lnbmF0dXJlCiAgICAiIiIKCiAgICBpZiBub3QgaXNpbnN0YW5jZShwcml2YXRlX2tleSwgUHJpdmF0ZUtleSk6CiAgICAgICAgcmFpc2UgVHlwZUVycm9yKHByZXR0eV9tZXNzYWdlKAogICAgICAgICAgICAnJycKICAgICAgICAgICAgcHJpdmF0ZV9rZXkgbXVzdCBiZSBhbiBpbnN0YW5jZSBvZiB0aGUgUHJpdmF0ZUtleSBjbGFzcywgbm90ICVzCiAgICAgICAgICAgICcnJywKICAgICAgICAgICAgdHlwZV9uYW1lKHByaXZhdGVfa2V5KQogICAgICAgICkpCgogICAgaWYgbm90IGlzaW5zdGFuY2UoZGF0YSwgYnl0ZV9jbHMpOgogICAgICAgIHJhaXNlIFR5cGVFcnJvcihwcmV0dHlfbWVzc2FnZSgKICAgICAgICAgICAgJycnCiAgICAgICAgICAgIGRhdGEgbXVzdCBiZSBhIGJ5dGUgc3RyaW5nLCBub3QgJXMKICAgICAgICAgICAgJycnLAogICAgICAgICAgICB0eXBlX25hbWUoZGF0YSkKICAgICAgICApKQoKICAgIHBrX2FsZ28gPSBwcml2YXRlX2tleS5hbGdvcml0aG0KICAgIGlmIHBrX2FsZ28gIT0gJ3JzYScgYW5kIHBrX2FsZ28gIT0gJ3JzYXNzYV9wc3MnOgogICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoJ1RoZSBrZXkgc3BlY2lmaWVkIGlzIG5vdCBhbiBSU0EgcHJpdmF0ZSBrZXknKQoKICAgIGhhc2hfbGVuZ3RoID0gewogICAgICAgICdzaGExJzogMjAsCiAgICAgICAgJ3NoYTIyNCc6IDI4LAogICAgICAgICdzaGEyNTYnOiAzMiwKICAgICAgICAnc2hhMzg0JzogNDgsCiAgICAgICAgJ3NoYTUxMic6IDY0CiAgICB9LmdldChoYXNoX2FsZ29yaXRobSwgMCkKCiAgICBlbmNvZGVkX2RhdGEgPSBhZGRfcHNzX3BhZGRpbmcoaGFzaF9hbGdvcml0aG0sIGhhc2hfbGVuZ3RoLCBwcml2YXRlX2tleS5iaXRfc2l6ZSwgZGF0YSkKCiAgICBrZXlfbGVuZ3RoID0gcHJpdmF0ZV9rZXkuYnl0ZV9zaXplCiAgICBidWZmZXIgPSBidWZmZXJfZnJvbV9ieXRlcyhrZXlfbGVuZ3RoKQogICAgb3V0cHV0X2xlbmd0aCA9IG5ldyhTZWN1cml0eSwgJ3NpemVfdCAqJywga2V5X2xlbmd0aCkKICAgIHJlc3VsdCA9IFNlY3VyaXR5LlNlY0tleURlY3J5cHQoCiAgICAgICAgcHJpdmF0ZV9rZXkuc2VjX2tleV9yZWYsCiAgICAgICAgU2VjdXJpdHlDb25zdC5rU2VjUGFkZGluZ05vbmUsCiAgICAgICAgZW5jb2RlZF9kYXRhLAogICAgICAgIGxlbihlbmNvZGVkX2RhdGEpLAogICAgICAgIGJ1ZmZlciwKICAgICAgICBvdXRwdXRfbGVuZ3RoCiAgICApCiAgICBoYW5kbGVfc2VjX2Vycm9yKHJlc3VsdCkKCiAgICByZXR1cm4gYnl0ZXNfZnJvbV9idWZmZXIoYnVmZmVyLCBkZXJlZihvdXRwdXRfbGVuZ3RoKSkKCgpkZWYgZHNhX3NpZ24ocHJpdmF0ZV9rZXksIGRhdGEsIGhhc2hfYWxnb3JpdGhtKToKICAgICIiIgogICAgR2VuZXJhdGVzIGEgRFNBIHNpZ25hdHVyZQoKICAgIDpwYXJhbSBwcml2YXRlX2tleToKICAgICAgICBUaGUgUHJpdmF0ZUtleSB0byBnZW5lcmF0ZSB0aGUgc2lnbmF0dXJlIHdpdGgKCiAgICA6cGFyYW0gZGF0YToKICAgICAgICBBIGJ5dGUgc3RyaW5nIG9mIHRoZSBkYXRhIHRoZSBzaWduYXR1cmUgaXMgZm9yCgogICAgOnBhcmFtIGhhc2hfYWxnb3JpdGhtOgogICAgICAgIEEgdW5pY29kZSBzdHJpbmcgb2YgIm1kNSIsICJzaGExIiwgInNoYTIyNCIsICJzaGEyNTYiLCAic2hhMzg0IiBvcgogICAgICAgICJzaGE1MTIiCgogICAgOnJhaXNlczoKICAgICAgICBWYWx1ZUVycm9yIC0gd2hlbiBhbnkgb2YgdGhlIHBhcmFtZXRlcnMgY29udGFpbiBhbiBpbnZhbGlkIHZhbHVlCiAgICAgICAgVHlwZUVycm9yIC0gd2hlbiBhbnkgb2YgdGhlIHBhcmFtZXRlcnMgYXJlIG9mIHRoZSB3cm9uZyB0eXBlCiAgICAgICAgT1NFcnJvciAtIHdoZW4gYW4gZXJyb3IgaXMgcmV0dXJuZWQgYnkgdGhlIE9TIGNyeXB0byBsaWJyYXJ5CgogICAgOnJldHVybjoKICAgICAgICBBIGJ5dGUgc3RyaW5nIG9mIHRoZSBzaWduYXR1cmUKICAgICIiIgoKICAgIGlmIHByaXZhdGVfa2V5LmFsZ29yaXRobSAhPSAnZHNhJzoKICAgICAgICByYWlzZSBWYWx1ZUVycm9yKCdUaGUga2V5IHNwZWNpZmllZCBpcyBub3QgYSBEU0EgcHJpdmF0ZSBrZXknKQoKICAgIHJldHVybiBfc2lnbihwcml2YXRlX2tleSwgZGF0YSwgaGFzaF9hbGdvcml0aG0pCgoKZGVmIGVjZHNhX3NpZ24ocHJpdmF0ZV9rZXksIGRhdGEsIGhhc2hfYWxnb3JpdGhtKToKICAgICIiIgogICAgR2VuZXJhdGVzIGFuIEVDRFNBIHNpZ25hdHVyZQoKICAgIDpwYXJhbSBwcml2YXRlX2tleToKICAgICAgICBUaGUgUHJpdmF0ZUtleSB0byBnZW5lcmF0ZSB0aGUgc2lnbmF0dXJlIHdpdGgKCiAgICA6cGFyYW0gZGF0YToKICAgICAgICBBIGJ5dGUgc3RyaW5nIG9mIHRoZSBkYXRhIHRoZSBzaWduYXR1cmUgaXMgZm9yCgogICAgOnBhcmFtIGhhc2hfYWxnb3JpdGhtOgogICAgICAgIEEgdW5pY29kZSBzdHJpbmcgb2YgIm1kNSIsICJzaGExIiwgInNoYTIyNCIsICJzaGEyNTYiLCAic2hhMzg0IiBvcgogICAgICAgICJzaGE1MTIiCgogICAgOnJhaXNlczoKICAgICAgICBWYWx1ZUVycm9yIC0gd2hlbiBhbnkgb2YgdGhlIHBhcmFtZXRlcnMgY29udGFpbiBhbiBpbnZhbGlkIHZhbHVlCiAgICAgICAgVHlwZUVycm9yIC0gd2hlbiBhbnkgb2YgdGhlIHBhcmFtZXRlcnMgYXJlIG9mIHRoZSB3cm9uZyB0eXBlCiAgICAgICAgT1NFcnJvciAtIHdoZW4gYW4gZXJyb3IgaXMgcmV0dXJuZWQgYnkgdGhlIE9TIGNyeXB0byBsaWJyYXJ5CgogICAgOnJldHVybjoKICAgICAgICBBIGJ5dGUgc3RyaW5nIG9mIHRoZSBzaWduYXR1cmUKICAgICIiIgoKICAgIGlmIHByaXZhdGVfa2V5LmFsZ29yaXRobSAhPSAnZWMnOgogICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoJ1RoZSBrZXkgc3BlY2lmaWVkIGlzIG5vdCBhbiBFQyBwcml2YXRlIGtleScpCgogICAgcmV0dXJuIF9zaWduKHByaXZhdGVfa2V5LCBkYXRhLCBoYXNoX2FsZ29yaXRobSkKCgpkZWYgX3NpZ24ocHJpdmF0ZV9rZXksIGRhdGEsIGhhc2hfYWxnb3JpdGhtKToKICAgICIiIgogICAgR2VuZXJhdGVzIGFuIFJTQSwgRFNBIG9yIEVDRFNBIHNpZ25hdHVyZQoKICAgIDpwYXJhbSBwcml2YXRlX2tleToKICAgICAgICBUaGUgUHJpdmF0ZUtleSB0byBnZW5lcmF0ZSB0aGUgc2lnbmF0dXJlIHdpdGgKCiAgICA6cGFyYW0gZGF0YToKICAgICAgICBBIGJ5dGUgc3RyaW5nIG9mIHRoZSBkYXRhIHRoZSBzaWduYXR1cmUgaXMgZm9yCgogICAgOnBhcmFtIGhhc2hfYWxnb3JpdGhtOgogICAgICAgIEEgdW5pY29kZSBzdHJpbmcgb2YgIm1kNSIsICJzaGExIiwgInNoYTIyNCIsICJzaGEyNTYiLCAic2hhMzg0IiBvcgogICAgICAgICJzaGE1MTIiCgogICAgOnJhaXNlczoKICAgICAgICBWYWx1ZUVycm9yIC0gd2hlbiBhbnkgb2YgdGhlIHBhcmFtZXRlcnMgY29udGFpbiBhbiBpbnZhbGlkIHZhbHVlCiAgICAgICAgVHlwZUVycm9yIC0gd2hlbiBhbnkgb2YgdGhlIHBhcmFtZXRlcnMgYXJlIG9mIHRoZSB3cm9uZyB0eXBlCiAgICAgICAgT1NFcnJvciAtIHdoZW4gYW4gZXJyb3IgaXMgcmV0dXJuZWQgYnkgdGhlIE9TIGNyeXB0byBsaWJyYXJ5CgogICAgOnJldHVybjoKICAgICAgICBBIGJ5dGUgc3RyaW5nIG9mIHRoZSBzaWduYXR1cmUKICAgICIiIgoKICAgIGlmIG5vdCBpc2luc3RhbmNlKHByaXZhdGVfa2V5LCBQcml2YXRlS2V5KToKICAgICAgICByYWlzZSBUeXBlRXJyb3IocHJldHR5X21lc3NhZ2UoCiAgICAgICAgICAgICcnJwogICAgICAgICAgICBwcml2YXRlX2tleSBtdXN0IGJlIGFuIGluc3RhbmNlIG9mIFByaXZhdGVLZXksIG5vdCAlcwogICAgICAgICAgICAnJycsCiAgICAgICAgICAgIHR5cGVfbmFtZShwcml2YXRlX2tleSkKICAgICAgICApKQoKICAgIGlmIG5vdCBpc2luc3RhbmNlKGRhdGEsIGJ5dGVfY2xzKToKICAgICAgICByYWlzZSBUeXBlRXJyb3IocHJldHR5X21lc3NhZ2UoCiAgICAgICAgICAgICcnJwogICAgICAgICAgICBkYXRhIG11c3QgYmUgYSBieXRlIHN0cmluZywgbm90ICVzCiAgICAgICAgICAgICcnJywKICAgICAgICAgICAgdHlwZV9uYW1lKGRhdGEpCiAgICAgICAgKSkKCiAgICB2YWxpZF9oYXNoX2FsZ29yaXRobXMgPSBzZXQoWydtZDUnLCAnc2hhMScsICdzaGEyMjQnLCAnc2hhMjU2JywgJ3NoYTM4NCcsICdzaGE1MTInXSkKICAgIGlmIHByaXZhdGVfa2V5LmFsZ29yaXRobSA9PSAncnNhJzoKICAgICAgICB2YWxpZF9oYXNoX2FsZ29yaXRobXMgfD0gc2V0KFsncmF3J10pCgogICAgaWYgaGFzaF9hbGdvcml0aG0gbm90IGluIHZhbGlkX2hhc2hfYWxnb3JpdGhtczoKICAgICAgICB2YWxpZF9oYXNoX2FsZ29yaXRobXNfZXJyb3IgPSAnIm1kNSIsICJzaGExIiwgInNoYTIyNCIsICJzaGEyNTYiLCAic2hhMzg0IiwgInNoYTUxMiInCiAgICAgICAgaWYgcHJpdmF0ZV9rZXkuYWxnb3JpdGhtID09ICdyc2EnOgogICAgICAgICAgICB2YWxpZF9oYXNoX2FsZ29yaXRobXNfZXJyb3IgKz0gJywgInJhdyInCiAgICAgICAgcmFpc2UgVmFsdWVFcnJvcihwcmV0dHlfbWVzc2FnZSgKICAgICAgICAgICAgJycnCiAgICAgICAgICAgIGhhc2hfYWxnb3JpdGhtIG11c3QgYmUgb25lIG9mICVzLCBub3QgJXMKICAgICAgICAgICAgJycnLAogICAgICAgICAgICB2YWxpZF9oYXNoX2FsZ29yaXRobXNfZXJyb3IsCiAgICAgICAgICAgIHJlcHIoaGFzaF9hbGdvcml0aG0pCiAgICAgICAgKSkKCiAgICBpZiBwcml2YXRlX2tleS5hbGdvcml0aG0gPT0gJ3JzYScgYW5kIGhhc2hfYWxnb3JpdGhtID09ICdyYXcnOgogICAgICAgIGlmIGxlbihkYXRhKSA+IHByaXZhdGVfa2V5LmJ5dGVfc2l6ZSAtIDExOgogICAgICAgICAgICByYWlzZSBWYWx1ZUVycm9yKHByZXR0eV9tZXNzYWdlKAogICAgICAgICAgICAgICAgJycnCiAgICAgICAgICAgICAgICBkYXRhIG11c3QgYmUgMTEgYnl0ZXMgc2hvcnRlciB0aGFuIHRoZSBrZXkgc2l6ZSB3aGVuCiAgICAgICAgICAgICAgICBoYXNoX2FsZ29yaXRobSBpcyAicmF3IiAtIGtleSBzaXplIGlzICVzIGJ5dGVzLCBidXQKICAgICAgICAgICAgICAgIGRhdGEgaXMgJXMgYnl0ZXMgbG9uZwogICAgICAgICAgICAgICAgJycnLAogICAgICAgICAgICAgICAgcHJpdmF0ZV9rZXkuYnl0ZV9zaXplLAogICAgICAgICAgICAgICAgbGVuKGRhdGEpCiAgICAgICAgICAgICkpCgogICAgICAgIGtleV9sZW5ndGggPSBwcml2YXRlX2tleS5ieXRlX3NpemUKICAgICAgICBidWZmZXIgPSBidWZmZXJfZnJvbV9ieXRlcyhrZXlfbGVuZ3RoKQogICAgICAgIG91dHB1dF9sZW5ndGggPSBuZXcoU2VjdXJpdHksICdzaXplX3QgKicsIGtleV9sZW5ndGgpCiAgICAgICAgcmVzdWx0ID0gU2VjdXJpdHkuU2VjS2V5UmF3U2lnbigKICAgICAgICAgICAgcHJpdmF0ZV9rZXkuc2VjX2tleV9yZWYsCiAgICAgICAgICAgIFNlY3VyaXR5Q29uc3Qua1NlY1BhZGRpbmdQS0NTMSwKICAgICAgICAgICAgZGF0YSwKICAgICAgICAgICAgbGVuKGRhdGEpLAogICAgICAgICAgICBidWZmZXIsCiAgICAgICAgICAgIG91dHB1dF9sZW5ndGgKICAgICAgICApCiAgICAgICAgaGFuZGxlX3NlY19lcnJvcihyZXN1bHQpCgogICAgICAgIHJldHVybiBieXRlc19mcm9tX2J1ZmZlcihidWZmZXIsIGRlcmVmKG91dHB1dF9sZW5ndGgpKQoKICAgIGNmX3NpZ25hdHVyZSA9IE5vbmUKICAgIGNmX2RhdGEgPSBOb25lCiAgICBjZl9oYXNoX2xlbmd0aCA9IE5vbmUKICAgIHNlY190cmFuc2Zvcm0gPSBOb25lCgogICAgdHJ5OgogICAgICAgIGVycm9yX3BvaW50ZXIgPSBuZXcoQ29yZUZvdW5kYXRpb24sICdDRkVycm9yUmVmIConKQogICAgICAgIHNlY190cmFuc2Zvcm0gPSBTZWN1cml0eS5TZWNTaWduVHJhbnNmb3JtQ3JlYXRlKHByaXZhdGVfa2V5LnNlY19rZXlfcmVmLCBlcnJvcl9wb2ludGVyKQogICAgICAgIGhhbmRsZV9jZl9lcnJvcihlcnJvcl9wb2ludGVyKQoKICAgICAgICBoYXNoX2NvbnN0YW50ID0gewogICAgICAgICAgICAnbWQ1JzogU2VjdXJpdHkua1NlY0RpZ2VzdE1ENSwKICAgICAgICAgICAgJ3NoYTEnOiBTZWN1cml0eS5rU2VjRGlnZXN0U0hBMSwKICAgICAgICAgICAgJ3NoYTIyNCc6IFNlY3VyaXR5LmtTZWNEaWdlc3RTSEEyLAogICAgICAgICAgICAnc2hhMjU2JzogU2VjdXJpdHkua1NlY0RpZ2VzdFNIQTIsCiAgICAgICAgICAgICdzaGEzODQnOiBTZWN1cml0eS5rU2VjRGlnZXN0U0hBMiwKICAgICAgICAgICAgJ3NoYTUxMic6IFNlY3VyaXR5LmtTZWNEaWdlc3RTSEEyCiAgICAgICAgfVtoYXNoX2FsZ29yaXRobV0KCiAgICAgICAgU2VjdXJpdHkuU2VjVHJhbnNmb3JtU2V0QXR0cmlidXRlKAogICAgICAgICAgICBzZWNfdHJhbnNmb3JtLAogICAgICAgICAgICBTZWN1cml0eS5rU2VjRGlnZXN0VHlwZUF0dHJpYnV0ZSwKICAgICAgICAgICAgaGFzaF9jb25zdGFudCwKICAgICAgICAgICAgZXJyb3JfcG9pbnRlcgogICAgICAgICkKICAgICAgICBoYW5kbGVfY2ZfZXJyb3IoZXJyb3JfcG9pbnRlcikKCiAgICAgICAgaWYgaGFzaF9hbGdvcml0aG0gaW4gc2V0KFsnc2hhMjI0JywgJ3NoYTI1NicsICdzaGEzODQnLCAnc2hhNTEyJ10pOgogICAgICAgICAgICBoYXNoX2xlbmd0aCA9IHsKICAgICAgICAgICAgICAgICdzaGEyMjQnOiAyMjQsCiAgICAgICAgICAgICAgICAnc2hhMjU2JzogMjU2LAogICAgICAgICAgICAgICAgJ3NoYTM4NCc6IDM4NCwKICAgICAgICAgICAgICAgICdzaGE1MTInOiA1MTIKICAgICAgICAgICAgfVtoYXNoX2FsZ29yaXRobV0KCiAgICAgICAgICAgIGNmX2hhc2hfbGVuZ3RoID0gQ0ZIZWxwZXJzLmNmX251bWJlcl9mcm9tX2ludGVnZXIoaGFzaF9sZW5ndGgpCgogICAgICAgICAgICBTZWN1cml0eS5TZWNUcmFuc2Zvcm1TZXRBdHRyaWJ1dGUoCiAgICAgICAgICAgICAgICBzZWNfdHJhbnNmb3JtLAogICAgICAgICAgICAgICAgU2VjdXJpdHkua1NlY0RpZ2VzdExlbmd0aEF0dHJpYnV0ZSwKICAgICAgICAgICAgICAgIGNmX2hhc2hfbGVuZ3RoLAogICAgICAgICAgICAgICAgZXJyb3JfcG9pbnRlcgogICAgICAgICAgICApCiAgICAgICAgICAgIGhhbmRsZV9jZl9lcnJvcihlcnJvcl9wb2ludGVyKQoKICAgICAgICBpZiBwcml2YXRlX2tleS5hbGdvcml0aG0gPT0gJ3JzYSc6CiAgICAgICAgICAgIFNlY3VyaXR5LlNlY1RyYW5zZm9ybVNldEF0dHJpYnV0ZSgKICAgICAgICAgICAgICAgIHNlY190cmFuc2Zvcm0sCiAgICAgICAgICAgICAgICBTZWN1cml0eS5rU2VjUGFkZGluZ0tleSwKICAgICAgICAgICAgICAgIFNlY3VyaXR5LmtTZWNQYWRkaW5nUEtDUzFLZXksCiAgICAgICAgICAgICAgICBlcnJvcl9wb2ludGVyCiAgICAgICAgICAgICkKICAgICAgICAgICAgaGFuZGxlX2NmX2Vycm9yKGVycm9yX3BvaW50ZXIpCgogICAgICAgIGNmX2RhdGEgPSBDRkhlbHBlcnMuY2ZfZGF0YV9mcm9tX2J5dGVzKGRhdGEpCiAgICAgICAgU2VjdXJpdHkuU2VjVHJhbnNmb3JtU2V0QXR0cmlidXRlKAogICAgICAgICAgICBzZWNfdHJhbnNmb3JtLAogICAgICAgICAgICBTZWN1cml0eS5rU2VjVHJhbnNmb3JtSW5wdXRBdHRyaWJ1dGVOYW1lLAogICAgICAgICAgICBjZl9kYXRhLAogICAgICAgICAgICBlcnJvcl9wb2ludGVyCiAgICAgICAgKQogICAgICAgIGhhbmRsZV9jZl9lcnJvcihlcnJvcl9wb2ludGVyKQoKICAgICAgICBjZl9zaWduYXR1cmUgPSBTZWN1cml0eS5TZWNUcmFuc2Zvcm1FeGVjdXRlKHNlY190cmFuc2Zvcm0sIGVycm9yX3BvaW50ZXIpCiAgICAgICAgaGFuZGxlX2NmX2Vycm9yKGVycm9yX3BvaW50ZXIpCgogICAgICAgIHJldHVybiBDRkhlbHBlcnMuY2ZfZGF0YV90b19ieXRlcyhjZl9zaWduYXR1cmUpCgogICAgZmluYWxseToKICAgICAgICBpZiBzZWNfdHJhbnNmb3JtOgogICAgICAgICAgICBDb3JlRm91bmRhdGlvbi5DRlJlbGVhc2Uoc2VjX3RyYW5zZm9ybSkKICAgICAgICBpZiBjZl9zaWduYXR1cmU6CiAgICAgICAgICAgIENvcmVGb3VuZGF0aW9uLkNGUmVsZWFzZShjZl9zaWduYXR1cmUpCiAgICAgICAgaWYgY2ZfZGF0YToKICAgICAgICAgICAgQ29yZUZvdW5kYXRpb24uQ0ZSZWxlYXNlKGNmX2RhdGEpCiAgICAgICAgaWYgY2ZfaGFzaF9sZW5ndGg6CiAgICAgICAgICAgIENvcmVGb3VuZGF0aW9uLkNGUmVsZWFzZShjZl9oYXNoX2xlbmd0aCkK
