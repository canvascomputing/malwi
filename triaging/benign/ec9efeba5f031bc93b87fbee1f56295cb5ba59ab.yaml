statistics:
  total_files: 1
  skipped_files: 0.0
  processed_objects: 1
  malicious_objects: 0
details:
- path: .repo_cache/malicious_repos/pypi_malregistry/pycryptoenv/1.0.7/pycryptoenv-1.0.7/pycryptoenv-1.0.7/pycryptoenv/_pkcs1.py
  contents:
  - name: remove_pkcs1v15_signature_padding
    score: 0.0
    code: |-
      def remove_pkcs1v15_signature_padding(key_length, data):
          """
          Removes PKCS#1 v1.5 padding from a signed message using constant time
          operations

          :param key_length:
              An integer of the number of bytes in the key

          :param data:
              A byte string to unpad

          :return:
              The unpadded data as a byte string
          """

          if _backend != 'winlegacy':
              raise SystemError(pretty_message(
                  '''
                  Pure-python RSA PKCSv1.5 signature padding removal code is only for
                  Windows XP/2003
                  '''
              ))

          return _remove_pkcs1v15_padding(key_length, data, 'verifying')
    tokens: resume load_global _backend load_const winlegacy compare_op != pop_jump_if_false TO_NUMBER load_global SystemError load_global pretty_message load_const STRING_FILE_PATH call call raise_varargs load_global STRING_LEN_S_ENT_HIGH load_fast key_length load_fast data load_const verifying call return_value
    hash: 350583dfff4e216cd9fbd28ef3e2e0f80d794e3e65641100ce57ece24098caf4
sources:
  .repo_cache/malicious_repos/pypi_malregistry/pycryptoenv/1.0.7/pycryptoenv-1.0.7/pycryptoenv-1.0.7/pycryptoenv/_pkcs1.py: IyBjb2Rpbmc6IHV0Zi04CmZyb20gX19mdXR1cmVfXyBpbXBvcnQgdW5pY29kZV9saXRlcmFscywgZGl2aXNpb24sIGFic29sdXRlX2ltcG9ydCwgcHJpbnRfZnVuY3Rpb24KCmltcG9ydCBzeXMKaW1wb3J0IGhhc2hsaWIKaW1wb3J0IG1hdGgKaW1wb3J0IHBsYXRmb3JtCmltcG9ydCBzdHJ1Y3QKaW1wb3J0IG9zCgpmcm9tIC4gaW1wb3J0IGJhY2tlbmQKZnJvbSAudXRpbCBpbXBvcnQgY29uc3RhbnRfY29tcGFyZSwgcmFuZF9ieXRlcwpmcm9tIC5fYXNuMSBpbXBvcnQgKAogICAgQ2VydGlmaWNhdGUsCiAgICBpbnRfZnJvbV9ieXRlcywKICAgIGludF90b19ieXRlcywKICAgIFByaXZhdGVLZXlJbmZvLAogICAgUHVibGljS2V5SW5mbywKKQpmcm9tIC5fZXJyb3JzIGltcG9ydCBwcmV0dHlfbWVzc2FnZQpmcm9tIC5faW50IGltcG9ydCBmaWxsX3dpZHRoCmZyb20gLl90eXBlcyBpbXBvcnQgdHlwZV9uYW1lLCBieXRlX2NscywgaW50X3R5cGVzCgppZiBzeXMudmVyc2lvbl9pbmZvIDwgKDMsKToKICAgIGNocl9jbHMgPSBjaHIKICAgIHJhbmdlID0geHJhbmdlICAjIG5vcWEKCmVsc2U6CiAgICBkZWYgY2hyX2NscyhudW0pOgogICAgICAgIHJldHVybiBieXRlcyhbbnVtXSkKCgpfYmFja2VuZCA9IGJhY2tlbmQoKQoKCl9fYWxsX18gPSBbCiAgICAnYWRkX3Bzc19wYWRkaW5nJywKICAgICdhZGRfcGtjczF2MTVfc2lnbmF0dXJlX3BhZGRpbmcnLAogICAgJ3Jhd19yc2FfcHJpdmF0ZV9jcnlwdCcsCiAgICAncmF3X3JzYV9wdWJsaWNfY3J5cHQnLAogICAgJ3JlbW92ZV9wa2NzMXYxNV9lbmNyeXB0aW9uX3BhZGRpbmcnLAogICAgJ3JlbW92ZV9wa2NzMXYxNV9zaWduYXR1cmVfcGFkZGluZycsCiAgICAndmVyaWZ5X3Bzc19wYWRkaW5nJywKXQoKCmRlZiBfaXNfb3N4XzEwNygpOgogICAgIiIiCiAgICA6cmV0dXJuOgogICAgICAgIEEgYm9vbCBpZiB0aGUgY3VycmVudCBtYWNoaW5lIGlzIHJ1bm5pbmcgT1MgWCAxMC43CiAgICAiIiIKCiAgICBpZiBzeXMucGxhdGZvcm0gIT0gJ2Rhcndpbic6CiAgICAgICAgcmV0dXJuIEZhbHNlCiAgICB2ZXJzaW9uID0gcGxhdGZvcm0ubWFjX3ZlcigpWzBdCiAgICByZXR1cm4gdHVwbGUobWFwKGludCwgdmVyc2lvbi5zcGxpdCgnLicpKSlbMDoyXSA9PSAoMTAsIDcpCgoKZGVmIGFkZF9wc3NfcGFkZGluZyhoYXNoX2FsZ29yaXRobSwgc2FsdF9sZW5ndGgsIGtleV9sZW5ndGgsIG1lc3NhZ2UpOgogICAgIiIiCiAgICBQYWRzIGEgYnl0ZSBzdHJpbmcgdXNpbmcgdGhlIEVNU0EtUFNTLUVuY29kZSBvcGVyYXRpb24gZGVzY3JpYmVkIGluIFBLQ1MjMQogICAgdjIuMi4KCiAgICA6cGFyYW0gaGFzaF9hbGdvcml0aG06CiAgICAgICAgVGhlIHN0cmluZyBuYW1lIG9mIHRoZSBoYXNoIGFsZ29yaXRobSB0byB1c2U6ICJzaGExIiwgInNoYTIyNCIsCiAgICAgICAgInNoYTI1NiIsICJzaGEzODQiLCAic2hhNTEyIgoKICAgIDpwYXJhbSBzYWx0X2xlbmd0aDoKICAgICAgICBUaGUgbGVuZ3RoIG9mIHRoZSBzYWx0IGFzIGFuIGludGVnZXIgLSB0eXBpY2FsbHkgdGhlIHNhbWUgYXMgdGhlIGxlbmd0aAogICAgICAgIG9mIHRoZSBvdXRwdXQgZnJvbSB0aGUgaGFzaF9hbGdvcml0aG0KCiAgICA6cGFyYW0ga2V5X2xlbmd0aDoKICAgICAgICBUaGUgbGVuZ3RoIG9mIHRoZSBSU0Ega2V5LCBpbiBiaXRzCgogICAgOnBhcmFtIG1lc3NhZ2U6CiAgICAgICAgQSBieXRlIHN0cmluZyBvZiB0aGUgbWVzc2FnZSB0byBwYWQKCiAgICA6cmV0dXJuOgogICAgICAgIFRoZSBlbmNvZGVkIChwYXNzZWQpIG1lc3NhZ2UKICAgICIiIgoKICAgIGlmIF9iYWNrZW5kICE9ICd3aW5sZWdhY3knIGFuZCBzeXMucGxhdGZvcm0gIT0gJ2Rhcndpbic6CiAgICAgICAgcmFpc2UgU3lzdGVtRXJyb3IocHJldHR5X21lc3NhZ2UoCiAgICAgICAgICAgICcnJwogICAgICAgICAgICBQdXJlLXB5dGhvbiBSU0EgUFNTIHNpZ25hdHVyZSBwYWRkaW5nIGFkZGl0aW9uIGNvZGUgaXMgb25seSBmb3IKICAgICAgICAgICAgV2luZG93cyBYUC8yMDAzIGFuZCBPUyBYCiAgICAgICAgICAgICcnJwogICAgICAgICkpCgogICAgaWYgbm90IGlzaW5zdGFuY2UobWVzc2FnZSwgYnl0ZV9jbHMpOgogICAgICAgIHJhaXNlIFR5cGVFcnJvcihwcmV0dHlfbWVzc2FnZSgKICAgICAgICAgICAgJycnCiAgICAgICAgICAgIG1lc3NhZ2UgbXVzdCBiZSBhIGJ5dGUgc3RyaW5nLCBub3QgJXMKICAgICAgICAgICAgJycnLAogICAgICAgICAgICB0eXBlX25hbWUobWVzc2FnZSkKICAgICAgICApKQoKICAgIGlmIG5vdCBpc2luc3RhbmNlKHNhbHRfbGVuZ3RoLCBpbnRfdHlwZXMpOgogICAgICAgIHJhaXNlIFR5cGVFcnJvcihwcmV0dHlfbWVzc2FnZSgKICAgICAgICAgICAgJycnCiAgICAgICAgICAgIHNhbHRfbGVuZ3RoIG11c3QgYmUgYW4gaW50ZWdlciwgbm90ICVzCiAgICAgICAgICAgICcnJywKICAgICAgICAgICAgdHlwZV9uYW1lKHNhbHRfbGVuZ3RoKQogICAgICAgICkpCgogICAgaWYgc2FsdF9sZW5ndGggPCAwOgogICAgICAgIHJhaXNlIFZhbHVlRXJyb3IocHJldHR5X21lc3NhZ2UoCiAgICAgICAgICAgICcnJwogICAgICAgICAgICBzYWx0X2xlbmd0aCBtdXN0IGJlIDAgb3IgbW9yZSAtIGlzICVzCiAgICAgICAgICAgICcnJywKICAgICAgICAgICAgcmVwcihzYWx0X2xlbmd0aCkKICAgICAgICApKQoKICAgIGlmIG5vdCBpc2luc3RhbmNlKGtleV9sZW5ndGgsIGludF90eXBlcyk6CiAgICAgICAgcmFpc2UgVHlwZUVycm9yKHByZXR0eV9tZXNzYWdlKAogICAgICAgICAgICAnJycKICAgICAgICAgICAga2V5X2xlbmd0aCBtdXN0IGJlIGFuIGludGVnZXIsIG5vdCAlcwogICAgICAgICAgICAnJycsCiAgICAgICAgICAgIHR5cGVfbmFtZShrZXlfbGVuZ3RoKQogICAgICAgICkpCgogICAgaWYga2V5X2xlbmd0aCA8IDUxMjoKICAgICAgICByYWlzZSBWYWx1ZUVycm9yKHByZXR0eV9tZXNzYWdlKAogICAgICAgICAgICAnJycKICAgICAgICAgICAga2V5X2xlbmd0aCBtdXN0IGJlIDUxMiBvciBtb3JlIC0gaXMgJXMKICAgICAgICAgICAgJycnLAogICAgICAgICAgICByZXByKGtleV9sZW5ndGgpCiAgICAgICAgKSkKCiAgICBpZiBoYXNoX2FsZ29yaXRobSBub3QgaW4gc2V0KFsnc2hhMScsICdzaGEyMjQnLCAnc2hhMjU2JywgJ3NoYTM4NCcsICdzaGE1MTInXSk6CiAgICAgICAgcmFpc2UgVmFsdWVFcnJvcihwcmV0dHlfbWVzc2FnZSgKICAgICAgICAgICAgJycnCiAgICAgICAgICAgIGhhc2hfYWxnb3JpdGhtIG11c3QgYmUgb25lIG9mICJzaGExIiwgInNoYTIyNCIsICJzaGEyNTYiLCAic2hhMzg0IiwKICAgICAgICAgICAgInNoYTUxMiIsIG5vdCAlcwogICAgICAgICAgICAnJycsCiAgICAgICAgICAgIHJlcHIoaGFzaF9hbGdvcml0aG0pCiAgICAgICAgKSkKCiAgICBoYXNoX2Z1bmMgPSBnZXRhdHRyKGhhc2hsaWIsIGhhc2hfYWxnb3JpdGhtKQoKICAgICMgVGhlIG1heGltYWwgYml0IHNpemUgb2YgYSBub24tbmVnYXRpdmUgaW50ZWdlciBpcyBvbmUgbGVzcyB0aGFuIHRoZSBiaXQKICAgICMgc2l6ZSBvZiB0aGUga2V5IHNpbmNlIHRoZSBmaXJzdCBiaXQgaXMgdXNlZCB0byBzdG9yZSBzaWduCiAgICBlbV9iaXRzID0ga2V5X2xlbmd0aCAtIDEKICAgIGVtX2xlbiA9IGludChtYXRoLmNlaWwoZW1fYml0cyAvIDgpKQoKICAgIG1lc3NhZ2VfZGlnZXN0ID0gaGFzaF9mdW5jKG1lc3NhZ2UpLmRpZ2VzdCgpCiAgICBoYXNoX2xlbmd0aCA9IGxlbihtZXNzYWdlX2RpZ2VzdCkKCiAgICBpZiBlbV9sZW4gPCBoYXNoX2xlbmd0aCArIHNhbHRfbGVuZ3RoICsgMjoKICAgICAgICByYWlzZSBWYWx1ZUVycm9yKHByZXR0eV9tZXNzYWdlKAogICAgICAgICAgICAnJycKICAgICAgICAgICAgS2V5IGlzIG5vdCBsb25nIGVub3VnaCB0byB1c2Ugd2l0aCBzcGVjaWZpZWQgaGFzaF9hbGdvcml0aG0gYW5kCiAgICAgICAgICAgIHNhbHRfbGVuZ3RoCiAgICAgICAgICAgICcnJwogICAgICAgICkpCgogICAgaWYgc2FsdF9sZW5ndGggPiAwOgogICAgICAgIHNhbHQgPSBvcy51cmFuZG9tKHNhbHRfbGVuZ3RoKQogICAgZWxzZToKICAgICAgICBzYWx0ID0gYicnCgogICAgbV9wcmltZSA9IChiJ1x4MDAnICogOCkgKyBtZXNzYWdlX2RpZ2VzdCArIHNhbHQKCiAgICBtX3ByaW1lX2RpZ2VzdCA9IGhhc2hfZnVuYyhtX3ByaW1lKS5kaWdlc3QoKQoKICAgIHBhZGRpbmcgPSBiJ1x4MDAnICogKGVtX2xlbiAtIHNhbHRfbGVuZ3RoIC0gaGFzaF9sZW5ndGggLSAyKQoKICAgIGRiID0gcGFkZGluZyArIGInXHgwMScgKyBzYWx0CgogICAgZGJfbWFzayA9IF9tZ2YxKGhhc2hfYWxnb3JpdGhtLCBtX3ByaW1lX2RpZ2VzdCwgZW1fbGVuIC0gaGFzaF9sZW5ndGggLSAxKQoKICAgIG1hc2tlZF9kYiA9IGludF90b19ieXRlcyhpbnRfZnJvbV9ieXRlcyhkYikgXiBpbnRfZnJvbV9ieXRlcyhkYl9tYXNrKSkKICAgIG1hc2tlZF9kYiA9IGZpbGxfd2lkdGgobWFza2VkX2RiLCBsZW4oZGJfbWFzaykpCgogICAgemVyb19iaXRzID0gKDggKiBlbV9sZW4pIC0gZW1fYml0cwogICAgbGVmdF9iaXRfbWFzayA9ICgnMCcgKiB6ZXJvX2JpdHMpICsgKCcxJyAqICg4IC0gemVyb19iaXRzKSkKICAgIGxlZnRfaW50X21hc2sgPSBpbnQobGVmdF9iaXRfbWFzaywgMikKCiAgICBpZiBsZWZ0X2ludF9tYXNrICE9IDI1NToKICAgICAgICBtYXNrZWRfZGIgPSBjaHJfY2xzKGxlZnRfaW50X21hc2sgJiBvcmQobWFza2VkX2RiWzA6MV0pKSArIG1hc2tlZF9kYlsxOl0KCiAgICByZXR1cm4gbWFza2VkX2RiICsgbV9wcmltZV9kaWdlc3QgKyBiJ1x4QkMnCgoKZGVmIHZlcmlmeV9wc3NfcGFkZGluZyhoYXNoX2FsZ29yaXRobSwgc2FsdF9sZW5ndGgsIGtleV9sZW5ndGgsIG1lc3NhZ2UsIHNpZ25hdHVyZSk6CiAgICAiIiIKICAgIFZlcmlmaWVzIHRoZSBQU1MgcGFkZGluZyBvbiBhbiBlbmNvZGVkIG1lc3NhZ2UKCiAgICA6cGFyYW0gaGFzaF9hbGdvcml0aG06CiAgICAgICAgVGhlIHN0cmluZyBuYW1lIG9mIHRoZSBoYXNoIGFsZ29yaXRobSB0byB1c2U6ICJzaGExIiwgInNoYTIyNCIsCiAgICAgICAgInNoYTI1NiIsICJzaGEzODQiLCAic2hhNTEyIgoKICAgIDpwYXJhbSBzYWx0X2xlbmd0aDoKICAgICAgICBUaGUgbGVuZ3RoIG9mIHRoZSBzYWx0IGFzIGFuIGludGVnZXIgLSB0eXBpY2FsbHkgdGhlIHNhbWUgYXMgdGhlIGxlbmd0aAogICAgICAgIG9mIHRoZSBvdXRwdXQgZnJvbSB0aGUgaGFzaF9hbGdvcml0aG0KCiAgICA6cGFyYW0ga2V5X2xlbmd0aDoKICAgICAgICBUaGUgbGVuZ3RoIG9mIHRoZSBSU0Ega2V5LCBpbiBiaXRzCgogICAgOnBhcmFtIG1lc3NhZ2U6CiAgICAgICAgQSBieXRlIHN0cmluZyBvZiB0aGUgbWVzc2FnZSB0byBwYWQKCiAgICA6cGFyYW0gc2lnbmF0dXJlOgogICAgICAgIFRoZSBzaWduYXR1cmUgdG8gdmVyaWZ5CgogICAgOnJldHVybjoKICAgICAgICBBIGJvb2xlYW4gaW5kaWNhdGluZyBpZiB0aGUgc2lnbmF0dXJlIGlzIGludmFsaWQKICAgICIiIgoKICAgIGlmIF9iYWNrZW5kICE9ICd3aW5sZWdhY3knIGFuZCBzeXMucGxhdGZvcm0gIT0gJ2Rhcndpbic6CiAgICAgICAgcmFpc2UgU3lzdGVtRXJyb3IocHJldHR5X21lc3NhZ2UoCiAgICAgICAgICAgICcnJwogICAgICAgICAgICBQdXJlLXB5dGhvbiBSU0EgUFNTIHNpZ25hdHVyZSBwYWRkaW5nIHZlcmlmaWNhdGlvbiBjb2RlIGlzIG9ubHkgZm9yCiAgICAgICAgICAgIFdpbmRvd3MgWFAvMjAwMyBhbmQgT1MgWAogICAgICAgICAgICAnJycKICAgICAgICApKQoKICAgIGlmIG5vdCBpc2luc3RhbmNlKG1lc3NhZ2UsIGJ5dGVfY2xzKToKICAgICAgICByYWlzZSBUeXBlRXJyb3IocHJldHR5X21lc3NhZ2UoCiAgICAgICAgICAgICcnJwogICAgICAgICAgICBtZXNzYWdlIG11c3QgYmUgYSBieXRlIHN0cmluZywgbm90ICVzCiAgICAgICAgICAgICcnJywKICAgICAgICAgICAgdHlwZV9uYW1lKG1lc3NhZ2UpCiAgICAgICAgKSkKCiAgICBpZiBub3QgaXNpbnN0YW5jZShzaWduYXR1cmUsIGJ5dGVfY2xzKToKICAgICAgICByYWlzZSBUeXBlRXJyb3IocHJldHR5X21lc3NhZ2UoCiAgICAgICAgICAgICcnJwogICAgICAgICAgICBzaWduYXR1cmUgbXVzdCBiZSBhIGJ5dGUgc3RyaW5nLCBub3QgJXMKICAgICAgICAgICAgJycnLAogICAgICAgICAgICB0eXBlX25hbWUoc2lnbmF0dXJlKQogICAgICAgICkpCgogICAgaWYgbm90IGlzaW5zdGFuY2Uoc2FsdF9sZW5ndGgsIGludF90eXBlcyk6CiAgICAgICAgcmFpc2UgVHlwZUVycm9yKHByZXR0eV9tZXNzYWdlKAogICAgICAgICAgICAnJycKICAgICAgICAgICAgc2FsdF9sZW5ndGggbXVzdCBiZSBhbiBpbnRlZ2VyLCBub3QgJXMKICAgICAgICAgICAgJycnLAogICAgICAgICAgICB0eXBlX25hbWUoc2FsdF9sZW5ndGgpCiAgICAgICAgKSkKCiAgICBpZiBzYWx0X2xlbmd0aCA8IDA6CiAgICAgICAgcmFpc2UgVmFsdWVFcnJvcihwcmV0dHlfbWVzc2FnZSgKICAgICAgICAgICAgJycnCiAgICAgICAgICAgIHNhbHRfbGVuZ3RoIG11c3QgYmUgMCBvciBtb3JlIC0gaXMgJXMKICAgICAgICAgICAgJycnLAogICAgICAgICAgICByZXByKHNhbHRfbGVuZ3RoKQogICAgICAgICkpCgogICAgaWYgaGFzaF9hbGdvcml0aG0gbm90IGluIHNldChbJ3NoYTEnLCAnc2hhMjI0JywgJ3NoYTI1NicsICdzaGEzODQnLCAnc2hhNTEyJ10pOgogICAgICAgIHJhaXNlIFZhbHVlRXJyb3IocHJldHR5X21lc3NhZ2UoCiAgICAgICAgICAgICcnJwogICAgICAgICAgICBoYXNoX2FsZ29yaXRobSBtdXN0IGJlIG9uZSBvZiAic2hhMSIsICJzaGEyMjQiLCAic2hhMjU2IiwgInNoYTM4NCIsCiAgICAgICAgICAgICJzaGE1MTIiLCBub3QgJXMKICAgICAgICAgICAgJycnLAogICAgICAgICAgICByZXByKGhhc2hfYWxnb3JpdGhtKQogICAgICAgICkpCgogICAgaGFzaF9mdW5jID0gZ2V0YXR0cihoYXNobGliLCBoYXNoX2FsZ29yaXRobSkKCiAgICBlbV9iaXRzID0ga2V5X2xlbmd0aCAtIDEKICAgIGVtX2xlbiA9IGludChtYXRoLmNlaWwoZW1fYml0cyAvIDgpKQoKICAgIG1lc3NhZ2VfZGlnZXN0ID0gaGFzaF9mdW5jKG1lc3NhZ2UpLmRpZ2VzdCgpCiAgICBoYXNoX2xlbmd0aCA9IGxlbihtZXNzYWdlX2RpZ2VzdCkKCiAgICBpZiBlbV9sZW4gPCBoYXNoX2xlbmd0aCArIHNhbHRfbGVuZ3RoICsgMjoKICAgICAgICByZXR1cm4gRmFsc2UKCiAgICBpZiBzaWduYXR1cmVbLTE6XSAhPSBiJ1x4QkMnOgogICAgICAgIHJldHVybiBGYWxzZQoKICAgIHplcm9fYml0cyA9ICg4ICogZW1fbGVuKSAtIGVtX2JpdHMKCiAgICBtYXNrZWRfZGJfbGVuZ3RoID0gZW1fbGVuIC0gaGFzaF9sZW5ndGggLSAxCiAgICBtYXNrZWRfZGIgPSBzaWduYXR1cmVbMDptYXNrZWRfZGJfbGVuZ3RoXQoKICAgIGZpcnN0X2J5dGUgPSBvcmQobWFza2VkX2RiWzA6MV0pCiAgICBiaXRzX3RoYXRfc2hvdWxkX2JlX3plcm8gPSBmaXJzdF9ieXRlID4+ICg4IC0gemVyb19iaXRzKQogICAgaWYgYml0c190aGF0X3Nob3VsZF9iZV96ZXJvICE9IDA6CiAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgbV9wcmltZV9kaWdlc3QgPSBzaWduYXR1cmVbbWFza2VkX2RiX2xlbmd0aDptYXNrZWRfZGJfbGVuZ3RoICsgaGFzaF9sZW5ndGhdCgogICAgZGJfbWFzayA9IF9tZ2YxKGhhc2hfYWxnb3JpdGhtLCBtX3ByaW1lX2RpZ2VzdCwgZW1fbGVuIC0gaGFzaF9sZW5ndGggLSAxKQoKICAgIGxlZnRfYml0X21hc2sgPSAoJzAnICogemVyb19iaXRzKSArICgnMScgKiAoOCAtIHplcm9fYml0cykpCiAgICBsZWZ0X2ludF9tYXNrID0gaW50KGxlZnRfYml0X21hc2ssIDIpCgogICAgaWYgbGVmdF9pbnRfbWFzayAhPSAyNTU6CiAgICAgICAgZGJfbWFzayA9IGNocl9jbHMobGVmdF9pbnRfbWFzayAmIG9yZChkYl9tYXNrWzA6MV0pKSArIGRiX21hc2tbMTpdCgogICAgZGIgPSBpbnRfdG9fYnl0ZXMoaW50X2Zyb21fYnl0ZXMobWFza2VkX2RiKSBeIGludF9mcm9tX2J5dGVzKGRiX21hc2spKQogICAgaWYgbGVuKGRiKSA8IGxlbihtYXNrZWRfZGIpOgogICAgICAgIGRiID0gKGInXHgwMCcgKiAobGVuKG1hc2tlZF9kYikgLSBsZW4oZGIpKSkgKyBkYgoKICAgIHplcm9fbGVuZ3RoID0gZW1fbGVuIC0gaGFzaF9sZW5ndGggLSBzYWx0X2xlbmd0aCAtIDIKICAgIHplcm9fc3RyaW5nID0gYidceDAwJyAqIHplcm9fbGVuZ3RoCiAgICBpZiBub3QgY29uc3RhbnRfY29tcGFyZShkYlswOnplcm9fbGVuZ3RoXSwgemVyb19zdHJpbmcpOgogICAgICAgIHJldHVybiBGYWxzZQoKICAgIGlmIGRiW3plcm9fbGVuZ3RoOnplcm9fbGVuZ3RoICsgMV0gIT0gYidceDAxJzoKICAgICAgICByZXR1cm4gRmFsc2UKCiAgICBzYWx0ID0gZGJbMCAtIHNhbHRfbGVuZ3RoOl0KCiAgICBtX3ByaW1lID0gKGInXHgwMCcgKiA4KSArIG1lc3NhZ2VfZGlnZXN0ICsgc2FsdAoKICAgIGhfcHJpbWUgPSBoYXNoX2Z1bmMobV9wcmltZSkuZGlnZXN0KCkKCiAgICByZXR1cm4gY29uc3RhbnRfY29tcGFyZShtX3ByaW1lX2RpZ2VzdCwgaF9wcmltZSkKCgpkZWYgX21nZjEoaGFzaF9hbGdvcml0aG0sIHNlZWQsIG1hc2tfbGVuZ3RoKToKICAgICIiIgogICAgVGhlIFBLQ1MjMSBNR0YxIG1hc2sgZ2VuZXJhdGlvbiBhbGdvcml0aG0KCiAgICA6cGFyYW0gaGFzaF9hbGdvcml0aG06CiAgICAgICAgVGhlIHN0cmluZyBuYW1lIG9mIHRoZSBoYXNoIGFsZ29yaXRobSB0byB1c2U6ICJzaGExIiwgInNoYTIyNCIsCiAgICAgICAgInNoYTI1NiIsICJzaGEzODQiLCAic2hhNTEyIgoKICAgIDpwYXJhbSBzZWVkOgogICAgICAgIEEgYnl0ZSBzdHJpbmcgdG8gdXNlIGFzIHRoZSBzZWVkIGZvciB0aGUgbWFzawoKICAgIDpwYXJhbSBtYXNrX2xlbmd0aDoKICAgICAgICBUaGUgZGVzaXJlZCBtYXNrIGxlbmd0aCwgYXMgYW4gaW50ZWdlcgoKICAgIDpyZXR1cm46CiAgICAgICAgQSBieXRlIHN0cmluZyBvZiB0aGUgbWFzawogICAgIiIiCgogICAgaWYgbm90IGlzaW5zdGFuY2Uoc2VlZCwgYnl0ZV9jbHMpOgogICAgICAgIHJhaXNlIFR5cGVFcnJvcihwcmV0dHlfbWVzc2FnZSgKICAgICAgICAgICAgJycnCiAgICAgICAgICAgIHNlZWQgbXVzdCBiZSBhIGJ5dGUgc3RyaW5nLCBub3QgJXMKICAgICAgICAgICAgJycnLAogICAgICAgICAgICB0eXBlX25hbWUoc2VlZCkKICAgICAgICApKQoKICAgIGlmIG5vdCBpc2luc3RhbmNlKG1hc2tfbGVuZ3RoLCBpbnRfdHlwZXMpOgogICAgICAgIHJhaXNlIFR5cGVFcnJvcihwcmV0dHlfbWVzc2FnZSgKICAgICAgICAgICAgJycnCiAgICAgICAgICAgIG1hc2tfbGVuZ3RoIG11c3QgYmUgYW4gaW50ZWdlciwgbm90ICVzCiAgICAgICAgICAgICcnJywKICAgICAgICAgICAgdHlwZV9uYW1lKG1hc2tfbGVuZ3RoKQogICAgICAgICkpCgogICAgaWYgbWFza19sZW5ndGggPCAxOgogICAgICAgIHJhaXNlIFZhbHVlRXJyb3IocHJldHR5X21lc3NhZ2UoCiAgICAgICAgICAgICcnJwogICAgICAgICAgICBtYXNrX2xlbmd0aCBtdXN0IGJlIGdyZWF0ZXIgdGhhbiAwIC0gaXMgJXMKICAgICAgICAgICAgJycnLAogICAgICAgICAgICByZXByKG1hc2tfbGVuZ3RoKQogICAgICAgICkpCgogICAgaWYgaGFzaF9hbGdvcml0aG0gbm90IGluIHNldChbJ3NoYTEnLCAnc2hhMjI0JywgJ3NoYTI1NicsICdzaGEzODQnLCAnc2hhNTEyJ10pOgogICAgICAgIHJhaXNlIFZhbHVlRXJyb3IocHJldHR5X21lc3NhZ2UoCiAgICAgICAgICAgICcnJwogICAgICAgICAgICBoYXNoX2FsZ29yaXRobSBtdXN0IGJlIG9uZSBvZiAic2hhMSIsICJzaGEyMjQiLCAic2hhMjU2IiwgInNoYTM4NCIsCiAgICAgICAgICAgICJzaGE1MTIiLCBub3QgJXMKICAgICAgICAgICAgJycnLAogICAgICAgICAgICByZXByKGhhc2hfYWxnb3JpdGhtKQogICAgICAgICkpCgogICAgb3V0cHV0ID0gYicnCgogICAgaGFzaF9sZW5ndGggPSB7CiAgICAgICAgJ3NoYTEnOiAyMCwKICAgICAgICAnc2hhMjI0JzogMjgsCiAgICAgICAgJ3NoYTI1Nic6IDMyLAogICAgICAgICdzaGEzODQnOiA0OCwKICAgICAgICAnc2hhNTEyJzogNjQKICAgIH1baGFzaF9hbGdvcml0aG1dCgogICAgaXRlcmF0aW9ucyA9IGludChtYXRoLmNlaWwobWFza19sZW5ndGggLyBoYXNoX2xlbmd0aCkpCgogICAgcGFjayA9IHN0cnVjdC5TdHJ1Y3QoYic+SScpLnBhY2sKICAgIGhhc2hfZnVuYyA9IGdldGF0dHIoaGFzaGxpYiwgaGFzaF9hbGdvcml0aG0pCgogICAgZm9yIGNvdW50ZXIgaW4gcmFuZ2UoMCwgaXRlcmF0aW9ucyk6CiAgICAgICAgYiA9IHBhY2soY291bnRlcikKICAgICAgICBvdXRwdXQgKz0gaGFzaF9mdW5jKHNlZWQgKyBiKS5kaWdlc3QoKQoKICAgIHJldHVybiBvdXRwdXRbMDptYXNrX2xlbmd0aF0KCgpkZWYgYWRkX3BrY3MxdjE1X3NpZ25hdHVyZV9wYWRkaW5nKGtleV9sZW5ndGgsIGRhdGEpOgogICAgIiIiCiAgICBBZGRzIFBLQ1MjMSB2MS41IHBhZGRpbmcgdG8gYSBtZXNzYWdlIHRvIGJlIHNpZ25lZAoKICAgIDpwYXJhbSBrZXlfbGVuZ3RoOgogICAgICAgIEFuIGludGVnZXIgb2YgdGhlIG51bWJlciBvZiBieXRlcyBpbiB0aGUga2V5CgogICAgOnBhcmFtIGRhdGE6CiAgICAgICAgQSBieXRlIHN0cmluZyB0byBwYWQKCiAgICA6cmV0dXJuOgogICAgICAgIFRoZSBwYWRkZWQgZGF0YSBhcyBhIGJ5dGUgc3RyaW5nCiAgICAiIiIKCiAgICBpZiBfYmFja2VuZCAhPSAnd2lubGVnYWN5JzoKICAgICAgICByYWlzZSBTeXN0ZW1FcnJvcihwcmV0dHlfbWVzc2FnZSgKICAgICAgICAgICAgJycnCiAgICAgICAgICAgIFB1cmUtcHl0aG9uIFJTQSBQS0NTdjEuNSBzaWduYXR1cmUgcGFkZGluZyBhZGRpdGlvbiBjb2RlIGlzIG9ubHkKICAgICAgICAgICAgZm9yIFdpbmRvd3MgWFAvMjAwMwogICAgICAgICAgICAnJycKICAgICAgICApKQoKICAgIHJldHVybiBfYWRkX3BrY3MxdjE1X3BhZGRpbmcoa2V5X2xlbmd0aCwgZGF0YSwgJ3NpZ25pbmcnKQoKCmRlZiByZW1vdmVfcGtjczF2MTVfc2lnbmF0dXJlX3BhZGRpbmcoa2V5X2xlbmd0aCwgZGF0YSk6CiAgICAiIiIKICAgIFJlbW92ZXMgUEtDUyMxIHYxLjUgcGFkZGluZyBmcm9tIGEgc2lnbmVkIG1lc3NhZ2UgdXNpbmcgY29uc3RhbnQgdGltZQogICAgb3BlcmF0aW9ucwoKICAgIDpwYXJhbSBrZXlfbGVuZ3RoOgogICAgICAgIEFuIGludGVnZXIgb2YgdGhlIG51bWJlciBvZiBieXRlcyBpbiB0aGUga2V5CgogICAgOnBhcmFtIGRhdGE6CiAgICAgICAgQSBieXRlIHN0cmluZyB0byB1bnBhZAoKICAgIDpyZXR1cm46CiAgICAgICAgVGhlIHVucGFkZGVkIGRhdGEgYXMgYSBieXRlIHN0cmluZwogICAgIiIiCgogICAgaWYgX2JhY2tlbmQgIT0gJ3dpbmxlZ2FjeSc6CiAgICAgICAgcmFpc2UgU3lzdGVtRXJyb3IocHJldHR5X21lc3NhZ2UoCiAgICAgICAgICAgICcnJwogICAgICAgICAgICBQdXJlLXB5dGhvbiBSU0EgUEtDU3YxLjUgc2lnbmF0dXJlIHBhZGRpbmcgcmVtb3ZhbCBjb2RlIGlzIG9ubHkgZm9yCiAgICAgICAgICAgIFdpbmRvd3MgWFAvMjAwMwogICAgICAgICAgICAnJycKICAgICAgICApKQoKICAgIHJldHVybiBfcmVtb3ZlX3BrY3MxdjE1X3BhZGRpbmcoa2V5X2xlbmd0aCwgZGF0YSwgJ3ZlcmlmeWluZycpCgoKZGVmIHJlbW92ZV9wa2NzMXYxNV9lbmNyeXB0aW9uX3BhZGRpbmcoa2V5X2xlbmd0aCwgZGF0YSk6CiAgICAiIiIKICAgIFJlbW92ZXMgUEtDUyMxIHYxLjUgcGFkZGluZyBmcm9tIGEgZGVjcnlwdGVkIG1lc3NhZ2UgdXNpbmcgY29uc3RhbnQgdGltZQogICAgb3BlcmF0aW9ucwoKICAgIDpwYXJhbSBrZXlfbGVuZ3RoOgogICAgICAgIEFuIGludGVnZXIgb2YgdGhlIG51bWJlciBvZiBieXRlcyBpbiB0aGUga2V5CgogICAgOnBhcmFtIGRhdGE6CiAgICAgICAgQSBieXRlIHN0cmluZyB0byB1bnBhZAoKICAgIDpyZXR1cm46CiAgICAgICAgVGhlIHVucGFkZGVkIGRhdGEgYXMgYSBieXRlIHN0cmluZwogICAgIiIiCgogICAgaWYgbm90IF9pc19vc3hfMTA3KCk6CiAgICAgICAgcmFpc2UgU3lzdGVtRXJyb3IocHJldHR5X21lc3NhZ2UoCiAgICAgICAgICAgICcnJwogICAgICAgICAgICBQdXJlLXB5dGhvbiBSU0EgUEtDU3YxLjUgZW5jcnlwdGlvbiBwYWRkaW5nIHJlbW92YWwgY29kZSBpcyBvbmx5CiAgICAgICAgICAgIGZvciBPUyBYIDEwLjcKICAgICAgICAgICAgJycnCiAgICAgICAgKSkKCiAgICByZXR1cm4gX3JlbW92ZV9wa2NzMXYxNV9wYWRkaW5nKGtleV9sZW5ndGgsIGRhdGEsICdkZWNyeXB0aW5nJykKCgpkZWYgX2FkZF9wa2NzMXYxNV9wYWRkaW5nKGtleV9sZW5ndGgsIGRhdGEsIG9wZXJhdGlvbik6CiAgICAiIiIKICAgIEFkZHMgUEtDUyMxIHYxLjUgcGFkZGluZyB0byBhIG1lc3NhZ2UKCiAgICA6cGFyYW0ga2V5X2xlbmd0aDoKICAgICAgICBBbiBpbnRlZ2VyIG9mIHRoZSBudW1iZXIgb2YgYnl0ZXMgaW4gdGhlIGtleQoKICAgIDpwYXJhbSBkYXRhOgogICAgICAgIEEgYnl0ZSBzdHJpbmcgdG8gdW5wYWQKCiAgICA6cGFyYW0gb3BlcmF0aW9uOgogICAgICAgIEEgdW5pY29kZSBzdHJpbmcgb2YgImVuY3J5cHRpbmciIG9yICJzaWduaW5nIgoKICAgIDpyZXR1cm46CiAgICAgICAgVGhlIHBhZGRlZCBkYXRhIGFzIGEgYnl0ZSBzdHJpbmcKICAgICIiIgoKICAgIGlmIG9wZXJhdGlvbiA9PSAnZW5jcnlwdGluZyc6CiAgICAgICAgc2Vjb25kX2J5dGUgPSBiJ1x4MDInCiAgICBlbHNlOgogICAgICAgIHNlY29uZF9ieXRlID0gYidceDAxJwoKICAgIGlmIG5vdCBpc2luc3RhbmNlKGRhdGEsIGJ5dGVfY2xzKToKICAgICAgICByYWlzZSBUeXBlRXJyb3IocHJldHR5X21lc3NhZ2UoCiAgICAgICAgICAgICcnJwogICAgICAgICAgICBkYXRhIG11c3QgYmUgYSBieXRlIHN0cmluZywgbm90ICVzCiAgICAgICAgICAgICcnJywKICAgICAgICAgICAgdHlwZV9uYW1lKGRhdGEpCiAgICAgICAgKSkKCiAgICBpZiBub3QgaXNpbnN0YW5jZShrZXlfbGVuZ3RoLCBpbnRfdHlwZXMpOgogICAgICAgIHJhaXNlIFR5cGVFcnJvcihwcmV0dHlfbWVzc2FnZSgKICAgICAgICAgICAgJycnCiAgICAgICAgICAgIGtleV9sZW5ndGggbXVzdCBiZSBhbiBpbnRlZ2VyLCBub3QgJXMKICAgICAgICAgICAgJycnLAogICAgICAgICAgICB0eXBlX25hbWUoa2V5X2xlbmd0aCkKICAgICAgICApKQoKICAgIGlmIGtleV9sZW5ndGggPCA2NDoKICAgICAgICByYWlzZSBWYWx1ZUVycm9yKHByZXR0eV9tZXNzYWdlKAogICAgICAgICAgICAnJycKICAgICAgICAgICAga2V5X2xlbmd0aCBtdXN0IGJlIDY0IG9yIG1vcmUgLSBpcyAlcwogICAgICAgICAgICAnJycsCiAgICAgICAgICAgIHJlcHIoa2V5X2xlbmd0aCkKICAgICAgICApKQoKICAgIGlmIGxlbihkYXRhKSA+IGtleV9sZW5ndGggLSAxMToKICAgICAgICByYWlzZSBWYWx1ZUVycm9yKHByZXR0eV9tZXNzYWdlKAogICAgICAgICAgICAnJycKICAgICAgICAgICAgZGF0YSBtdXN0IGJlIGJldHdlZW4gMSBhbmQgJXMgYnl0ZXMgbG9uZyAtIGlzICVzCiAgICAgICAgICAgICcnJywKICAgICAgICAgICAga2V5X2xlbmd0aCAtIDExLAogICAgICAgICAgICBsZW4oZGF0YSkKICAgICAgICApKQoKICAgIHJlcXVpcmVkX2J5dGVzID0ga2V5X2xlbmd0aCAtIDMgLSBsZW4oZGF0YSkKICAgIHBhZGRpbmcgPSBiJycKICAgIHdoaWxlIHJlcXVpcmVkX2J5dGVzID4gMDoKICAgICAgICB0ZW1wX3BhZGRpbmcgPSByYW5kX2J5dGVzKHJlcXVpcmVkX2J5dGVzKQogICAgICAgICMgUmVtb3ZlIG51bGwgYnl0ZXMgc2luY2UgdGhleSBhcmUgbWFya2VycyBpbiBQS0NTIzEgdjEuNQogICAgICAgIHRlbXBfcGFkZGluZyA9IGInJy5qb2luKHRlbXBfcGFkZGluZy5zcGxpdChiJ1x4MDAnKSkKICAgICAgICBwYWRkaW5nICs9IHRlbXBfcGFkZGluZwogICAgICAgIHJlcXVpcmVkX2J5dGVzIC09IGxlbih0ZW1wX3BhZGRpbmcpCgogICAgcmV0dXJuIGInXHgwMCcgKyBzZWNvbmRfYnl0ZSArIHBhZGRpbmcgKyBiJ1x4MDAnICsgZGF0YQoKCmRlZiBfcmVtb3ZlX3BrY3MxdjE1X3BhZGRpbmcoa2V5X2xlbmd0aCwgZGF0YSwgb3BlcmF0aW9uKToKICAgICIiIgogICAgUmVtb3ZlcyBQS0NTIzEgdjEuNSBwYWRkaW5nIGZyb20gYSBtZXNzYWdlIHVzaW5nIGNvbnN0YW50IHRpbWUgb3BlcmF0aW9ucwoKICAgIDpwYXJhbSBrZXlfbGVuZ3RoOgogICAgICAgIEFuIGludGVnZXIgb2YgdGhlIG51bWJlciBvZiBieXRlcyBpbiB0aGUga2V5CgogICAgOnBhcmFtIGRhdGE6CiAgICAgICAgQSBieXRlIHN0cmluZyB0byB1bnBhZAoKICAgIDpwYXJhbSBvcGVyYXRpb246CiAgICAgICAgQSB1bmljb2RlIHN0cmluZyBvZiAiZGVjcnlwdGluZyIgb3IgInZlcmlmeWluZyIKCiAgICA6cmV0dXJuOgogICAgICAgIFRoZSB1bnBhZGRlZCBkYXRhIGFzIGEgYnl0ZSBzdHJpbmcKICAgICIiIgoKICAgIGlmIG9wZXJhdGlvbiA9PSAnZGVjcnlwdGluZyc6CiAgICAgICAgc2Vjb25kX2J5dGUgPSAyCiAgICBlbHNlOgogICAgICAgIHNlY29uZF9ieXRlID0gMQoKICAgIGlmIG5vdCBpc2luc3RhbmNlKGRhdGEsIGJ5dGVfY2xzKToKICAgICAgICByYWlzZSBUeXBlRXJyb3IocHJldHR5X21lc3NhZ2UoCiAgICAgICAgICAgICcnJwogICAgICAgICAgICBkYXRhIG11c3QgYmUgYSBieXRlIHN0cmluZywgbm90ICVzCiAgICAgICAgICAgICcnJywKICAgICAgICAgICAgdHlwZV9uYW1lKGRhdGEpCiAgICAgICAgKSkKCiAgICBpZiBub3QgaXNpbnN0YW5jZShrZXlfbGVuZ3RoLCBpbnRfdHlwZXMpOgogICAgICAgIHJhaXNlIFR5cGVFcnJvcihwcmV0dHlfbWVzc2FnZSgKICAgICAgICAgICAgJycnCiAgICAgICAgICAgIGtleV9sZW5ndGggbXVzdCBiZSBhbiBpbnRlZ2VyLCBub3QgJXMKICAgICAgICAgICAgJycnLAogICAgICAgICAgICB0eXBlX25hbWUoa2V5X2xlbmd0aCkKICAgICAgICApKQoKICAgIGlmIGtleV9sZW5ndGggPCA2NDoKICAgICAgICByYWlzZSBWYWx1ZUVycm9yKHByZXR0eV9tZXNzYWdlKAogICAgICAgICAgICAnJycKICAgICAgICAgICAga2V5X2xlbmd0aCBtdXN0IGJlIDY0IG9yIG1vcmUgLSBpcyAlcwogICAgICAgICAgICAnJycsCiAgICAgICAgICAgIHJlcHIoa2V5X2xlbmd0aCkKICAgICAgICApKQoKICAgIGlmIGxlbihkYXRhKSAhPSBrZXlfbGVuZ3RoOgogICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoJ0Vycm9yICVzJyAlIG9wZXJhdGlvbikKCiAgICBlcnJvciA9IDAKICAgIHRyYXNoID0gMAogICAgcGFkZGluZ19lbmQgPSAwCgogICAgIyBVc2VzIGJpdHdpc2Ugb3BlcmF0aW9ucyBvbiBhbiBlcnJvciB2YXJpYWJsZSBhbmQgYW5vdGhlciB0cmFzaCB2YXJpYWJsZQogICAgIyB0byBwZXJmb3JtIGNvbnN0YW50IHRpbWUgZXJyb3IgY2hlY2tpbmcvdG9rZW4gc2Nhbm5pbmcgb24gdGhlIGRhdGEKICAgIGZvciBpIGluIHJhbmdlKDAsIGxlbihkYXRhKSk6CiAgICAgICAgYnl0ZSA9IGRhdGFbaTppICsgMV0KICAgICAgICBieXRlX251bSA9IG9yZChieXRlKQoKICAgICAgICAjIEZpcnN0IGJ5dGUgc2hvdWxkIGJlIFx4MDAKICAgICAgICBpZiBpID09IDA6CiAgICAgICAgICAgIGVycm9yIHw9IGJ5dGVfbnVtCgogICAgICAgICMgU2Vjb25kIGJ5dGUgc2hvdWxkIGJlIFx4MDIgZm9yIGRlY3J5cHRpb24sIFx4MDEgZm9yIHZlcmlmaWNhdGlvbgogICAgICAgIGVsaWYgaSA9PSAxOgogICAgICAgICAgICBlcnJvciB8PSBpbnQoKGJ5dGVfbnVtIHwgc2Vjb25kX2J5dGUpICE9IHNlY29uZF9ieXRlKQoKICAgICAgICAjIEJ5dGVzIDMtMTAgc2hvdWxkIG5vdCBiZSBceDAwCiAgICAgICAgZWxpZiBpIDwgMTA6CiAgICAgICAgICAgIGVycm9yIHw9IGludCgoYnl0ZV9udW0gXiAwKSA9PSAwKQoKICAgICAgICAjIEJ5dGUgMTEgb3IgYWZ0ZXIgdGhhdCBpcyB6ZXJvIGlzIGVuZCBvZiBwYWRkaW5nCiAgICAgICAgZWxzZToKICAgICAgICAgICAgbm9uX3plcm8gPSBieXRlX251bSB8IDAKICAgICAgICAgICAgaWYgcGFkZGluZ19lbmQgPT0gMDoKICAgICAgICAgICAgICAgIGlmIG5vbl96ZXJvOgogICAgICAgICAgICAgICAgICAgIHRyYXNoIHw9IGkKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgcGFkZGluZ19lbmQgfD0gaQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgaWYgbm9uX3plcm86CiAgICAgICAgICAgICAgICAgICAgdHJhc2ggfD0gaQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICB0cmFzaCB8PSBpCgogICAgaWYgZXJyb3IgIT0gMDoKICAgICAgICByYWlzZSBWYWx1ZUVycm9yKCdFcnJvciAlcycgJSBvcGVyYXRpb24pCgogICAgcmV0dXJuIGRhdGFbcGFkZGluZ19lbmQgKyAxOl0KCgpkZWYgcmF3X3JzYV9wcml2YXRlX2NyeXB0KHByaXZhdGVfa2V5LCBkYXRhKToKICAgICIiIgogICAgUGVyZm9ybXMgYSByYXcgUlNBIGFsZ29yaXRobSBpbiBhIGJ5dGUgc3RyaW5nIHVzaW5nIGEgcHJpdmF0ZSBrZXkuCiAgICBUaGlzIGlzIGEgbG93LWxldmVsIHByaW1pdGl2ZSBhbmQgaXMgcHJvbmUgdG8gZGlzYXN0cm91cyByZXN1bHRzIGlmIHVzZWQKICAgIGluY29ycmVjdGx5LgoKICAgIDpwYXJhbSBwcml2YXRlX2tleToKICAgICAgICBBbiBvc2NyeXB0by5hc3ltbWV0cmljLlByaXZhdGVLZXkgb2JqZWN0CgogICAgOnBhcmFtIGRhdGE6CiAgICAgICAgQSBieXRlIHN0cmluZyBvZiB0aGUgcGxhaW50ZXh0IHRvIGJlIHNpZ25lZCBvciBjaXBoZXJ0ZXh0IHRvIGJlCiAgICAgICAgZGVjcnlwdGVkLiBNdXN0IGJlIGxlc3MgdGhhbiBvciBlcXVhbCB0byB0aGUgbGVuZ3RoIG9mIHRoZSBwcml2YXRlIGtleS4KICAgICAgICBJbiB0aGUgY2FzZSBvZiBzaWduaW5nLCBwYWRkaW5nIG11c3QgYWxyZWFkeSBiZSBhcHBsaWVkLiBJbiB0aGUgY2FzZSBvZgogICAgICAgIGRlY3J5cHRpb24sIHBhZGRpbmcgbXVzdCBiZSByZW1vdmVkIGFmdGVyd2FyZC4KCiAgICA6cmV0dXJuOgogICAgICAgIEEgYnl0ZSBzdHJpbmcgb2YgdGhlIHRyYW5zZm9ybWVkIGRhdGEKICAgICIiIgoKICAgIGlmIF9iYWNrZW5kICE9ICd3aW5sZWdhY3knOgogICAgICAgIHJhaXNlIFN5c3RlbUVycm9yKCdQdXJlLXB5dGhvbiBSU0EgY3J5cHQgaXMgb25seSBmb3IgV2luZG93cyBYUC8yMDAzJykKCiAgICBpZiBub3QgaGFzYXR0cihwcml2YXRlX2tleSwgJ2FzbjEnKSBvciBub3QgaXNpbnN0YW5jZShwcml2YXRlX2tleS5hc24xLCBQcml2YXRlS2V5SW5mbyk6CiAgICAgICAgcmFpc2UgVHlwZUVycm9yKHByZXR0eV9tZXNzYWdlKAogICAgICAgICAgICAnJycKICAgICAgICAgICAgcHJpdmF0ZV9rZXkgbXVzdCBiZSBhbiBpbnN0YW5jZSBvZiB0aGUKICAgICAgICAgICAgb3NjcnlwdG8uYXN5bW1ldHJpYy5Qcml2YXRlS2V5IGNsYXNzLCBub3QgJXMKICAgICAgICAgICAgJycnLAogICAgICAgICAgICB0eXBlX25hbWUocHJpdmF0ZV9rZXkpCiAgICAgICAgKSkKCiAgICBhbGdvID0gcHJpdmF0ZV9rZXkuYXNuMVsncHJpdmF0ZV9rZXlfYWxnb3JpdGhtJ11bJ2FsZ29yaXRobSddLm5hdGl2ZQogICAgaWYgYWxnbyAhPSAncnNhJyBhbmQgYWxnbyAhPSAncnNhc3NhX3Bzcyc6CiAgICAgICAgcmFpc2UgVmFsdWVFcnJvcihwcmV0dHlfbWVzc2FnZSgKICAgICAgICAgICAgJycnCiAgICAgICAgICAgIHByaXZhdGVfa2V5IG11c3QgYmUgYW4gUlNBIGtleSwgbm90ICVzCiAgICAgICAgICAgICcnJywKICAgICAgICAgICAgYWxnby51cHBlcigpCiAgICAgICAgKSkKCiAgICBpZiBub3QgaXNpbnN0YW5jZShkYXRhLCBieXRlX2Nscyk6CiAgICAgICAgcmFpc2UgVHlwZUVycm9yKHByZXR0eV9tZXNzYWdlKAogICAgICAgICAgICAnJycKICAgICAgICAgICAgZGF0YSBtdXN0IGJlIGEgYnl0ZSBzdHJpbmcsIG5vdCAlcwogICAgICAgICAgICAnJycsCiAgICAgICAgICAgIHR5cGVfbmFtZShkYXRhKQogICAgICAgICkpCgogICAgcnNhX3ByaXZhdGVfa2V5ID0gcHJpdmF0ZV9rZXkuYXNuMVsncHJpdmF0ZV9rZXknXS5wYXJzZWQKICAgIHRyYW5zZm9ybWVkX2ludCA9IHBvdygKICAgICAgICBpbnRfZnJvbV9ieXRlcyhkYXRhKSwKICAgICAgICByc2FfcHJpdmF0ZV9rZXlbJ3ByaXZhdGVfZXhwb25lbnQnXS5uYXRpdmUsCiAgICAgICAgcnNhX3ByaXZhdGVfa2V5Wydtb2R1bHVzJ10ubmF0aXZlCiAgICApCiAgICByZXR1cm4gaW50X3RvX2J5dGVzKHRyYW5zZm9ybWVkX2ludCwgd2lkdGg9cHJpdmF0ZV9rZXkuYXNuMS5ieXRlX3NpemUpCgoKZGVmIHJhd19yc2FfcHVibGljX2NyeXB0KGNlcnRpZmljYXRlX29yX3B1YmxpY19rZXksIGRhdGEpOgogICAgIiIiCiAgICBQZXJmb3JtcyBhIHJhdyBSU0EgYWxnb3JpdGhtIGluIGEgYnl0ZSBzdHJpbmcgdXNpbmcgYSBjZXJ0aWZpY2F0ZSBvcgogICAgcHVibGljIGtleS4gVGhpcyBpcyBhIGxvdy1sZXZlbCBwcmltaXRpdmUgYW5kIGlzIHByb25lIHRvIGRpc2FzdHJvdXMgcmVzdWx0cwogICAgaWYgdXNlZCBpbmNvcnJlY3RseS4KCiAgICA6cGFyYW0gY2VydGlmaWNhdGVfb3JfcHVibGljX2tleToKICAgICAgICBBbiBvc2NyeXB0by5hc3ltbWV0cmljLlB1YmxpY0tleSBvciBvc2NyeXB0by5hc3ltbWV0cmljLkNlcnRpZmljYXRlCiAgICAgICAgb2JqZWN0CgogICAgOnBhcmFtIGRhdGE6CiAgICAgICAgQSBieXRlIHN0cmluZyBvZiB0aGUgc2lnbmF0dXJlIHdoZW4gdmVyaWZ5aW5nLCBvciBwYWRkZWQgcGxhaW50ZXh0IHdoZW4KICAgICAgICBlbmNyeXB0aW5nLiBNdXN0IGJlIGxlc3MgdGhhbiBvciBlcXVhbCB0byB0aGUgbGVuZ3RoIG9mIHRoZSBwdWJsaWMga2V5LgogICAgICAgIFdoZW4gdmVyaWZ5aW5nLCBwYWRkaW5nIHdpbGwgbmVlZCB0byBiZSByZW1vdmVkIGFmdGVyd2FyZHMuIFdoZW4KICAgICAgICBlbmNyeXB0aW5nLCBwYWRkaW5nIG11c3QgYmUgYXBwbGllZCBiZWZvcmUuCgogICAgOnJldHVybjoKICAgICAgICBBIGJ5dGUgc3RyaW5nIG9mIHRoZSB0cmFuc2Zvcm1lZCBkYXRhCiAgICAiIiIKCiAgICBpZiBfYmFja2VuZCAhPSAnd2lubGVnYWN5JzoKICAgICAgICByYWlzZSBTeXN0ZW1FcnJvcignUHVyZS1weXRob24gUlNBIGNyeXB0IGlzIG9ubHkgZm9yIFdpbmRvd3MgWFAvMjAwMycpCgogICAgaGFzX2FzbjEgPSBoYXNhdHRyKGNlcnRpZmljYXRlX29yX3B1YmxpY19rZXksICdhc24xJykKICAgIHZhbGlkX3R5cGVzID0gKFB1YmxpY0tleUluZm8sIENlcnRpZmljYXRlKQogICAgaWYgbm90IGhhc19hc24xIG9yIG5vdCBpc2luc3RhbmNlKGNlcnRpZmljYXRlX29yX3B1YmxpY19rZXkuYXNuMSwgdmFsaWRfdHlwZXMpOgogICAgICAgIHJhaXNlIFR5cGVFcnJvcihwcmV0dHlfbWVzc2FnZSgKICAgICAgICAgICAgJycnCiAgICAgICAgICAgIGNlcnRpZmljYXRlX29yX3B1YmxpY19rZXkgbXVzdCBiZSBhbiBpbnN0YW5jZSBvZiB0aGUKICAgICAgICAgICAgb3NjcnlwdG8uYXN5bW1ldHJpYy5QdWJsaWNLZXkgb3Igb3NjcnlwdG8uYXN5bW1ldHJpYy5DZXJ0aWZpY2F0ZQogICAgICAgICAgICBjbGFzc2VzLCBub3QgJXMKICAgICAgICAgICAgJycnLAogICAgICAgICAgICB0eXBlX25hbWUoY2VydGlmaWNhdGVfb3JfcHVibGljX2tleSkKICAgICAgICApKQoKICAgIGFsZ28gPSBjZXJ0aWZpY2F0ZV9vcl9wdWJsaWNfa2V5LmFzbjFbJ2FsZ29yaXRobSddWydhbGdvcml0aG0nXS5uYXRpdmUKICAgIGlmIGFsZ28gIT0gJ3JzYScgYW5kIGFsZ28gIT0gJ3JzYXNzYV9wc3MnOgogICAgICAgIHJhaXNlIFZhbHVlRXJyb3IocHJldHR5X21lc3NhZ2UoCiAgICAgICAgICAgICcnJwogICAgICAgICAgICBjZXJ0aWZpY2F0ZV9vcl9wdWJsaWNfa2V5IG11c3QgYmUgYW4gUlNBIGtleSwgbm90ICVzCiAgICAgICAgICAgICcnJywKICAgICAgICAgICAgYWxnby51cHBlcigpCiAgICAgICAgKSkKCiAgICBpZiBub3QgaXNpbnN0YW5jZShkYXRhLCBieXRlX2Nscyk6CiAgICAgICAgcmFpc2UgVHlwZUVycm9yKHByZXR0eV9tZXNzYWdlKAogICAgICAgICAgICAnJycKICAgICAgICAgICAgZGF0YSBtdXN0IGJlIGEgYnl0ZSBzdHJpbmcsIG5vdCAlcwogICAgICAgICAgICAnJycsCiAgICAgICAgICAgIHR5cGVfbmFtZShkYXRhKQogICAgICAgICkpCgogICAgcnNhX3B1YmxpY19rZXkgPSBjZXJ0aWZpY2F0ZV9vcl9wdWJsaWNfa2V5LmFzbjFbJ3B1YmxpY19rZXknXS5wYXJzZWQKICAgIHRyYW5zZm9ybWVkX2ludCA9IHBvdygKICAgICAgICBpbnRfZnJvbV9ieXRlcyhkYXRhKSwKICAgICAgICByc2FfcHVibGljX2tleVsncHVibGljX2V4cG9uZW50J10ubmF0aXZlLAogICAgICAgIHJzYV9wdWJsaWNfa2V5Wydtb2R1bHVzJ10ubmF0aXZlCiAgICApCiAgICByZXR1cm4gaW50X3RvX2J5dGVzKAogICAgICAgIHRyYW5zZm9ybWVkX2ludCwKICAgICAgICB3aWR0aD1jZXJ0aWZpY2F0ZV9vcl9wdWJsaWNfa2V5LmFzbjEuYnl0ZV9zaXplCiAgICApCg==
