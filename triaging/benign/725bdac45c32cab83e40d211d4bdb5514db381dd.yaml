statistics:
  total_files: 1
  skipped_files: 0.0
  processed_objects: 1
  malicious_objects: 0
details:
- path: .repo_cache/malicious_repos/pypi_malregistry/pycryptoenv/1.0.7/pycryptoenv-1.0.7/pycryptoenv-1.0.7/pycryptoenv/_openssl/asymmetric.py
  contents:
  - name: Certificate.__init__
    score: 0.0
    code: |-
      def __init__(self, x509, asn1):
              """
              :param x509:
                  An OpenSSL X509 value from loading/importing the certificate

              :param asn1:
                  An asn1crypto.x509.Certificate object
              """

              self.x509 = x509
              self.asn1 = asn1
              self._lib = libcrypto
    tokens: resume load_fast x509 load_fast self store_attr x509 load_fast asn1 load_fast self store_attr asn1 load_global libcrypto load_fast self store_attr _lib return_const None
    hash: 88a1f263830047f009bff2af0a2446c80be524a8e6bf64970db69af0a7ee0be4
sources:
  ? .repo_cache/malicious_repos/pypi_malregistry/pycryptoenv/1.0.7/pycryptoenv-1.0.7/pycryptoenv-1.0.7/pycryptoenv/_openssl/asymmetric.py
  : IyBjb2Rpbmc6IHV0Zi04CmZyb20gX19mdXR1cmVfXyBpbXBvcnQgdW5pY29kZV9saXRlcmFscywgZGl2aXNpb24sIGFic29sdXRlX2ltcG9ydCwgcHJpbnRfZnVuY3Rpb24KCmltcG9ydCBoYXNobGliCgpmcm9tIC4uX2FzbjEgaW1wb3J0ICgKICAgIENlcnRpZmljYXRlIGFzIEFzbjFDZXJ0aWZpY2F0ZSwKICAgIERIUGFyYW1ldGVycywKICAgIEVDRG9tYWluUGFyYW1ldGVycywKICAgIFByaXZhdGVLZXlJbmZvLAogICAgUHVibGljS2V5QWxnb3JpdGhtLAogICAgUHVibGljS2V5SW5mbywKKQpmcm9tIC4uX2FzeW1tZXRyaWMgaW1wb3J0ICgKICAgIF9DZXJ0aWZpY2F0ZUJhc2UsCiAgICBfZmluZ2VycHJpbnQsCiAgICBfcGFyc2VfcGtjczEyLAogICAgX1ByaXZhdGVLZXlCYXNlLAogICAgX1B1YmxpY0tleUJhc2UsCiAgICBfdW53cmFwX3ByaXZhdGVfa2V5X2luZm8sCiAgICBwYXJzZV9jZXJ0aWZpY2F0ZSwKICAgIHBhcnNlX3ByaXZhdGUsCiAgICBwYXJzZV9wdWJsaWMsCikKZnJvbSAuLl9lcnJvcnMgaW1wb3J0IHByZXR0eV9tZXNzYWdlCmZyb20gLi5fZmZpIGltcG9ydCAoCiAgICBidWZmZXJfZnJvbV9ieXRlcywKICAgIGJ1ZmZlcl9wb2ludGVyLAogICAgYnl0ZXNfZnJvbV9idWZmZXIsCiAgICBkZXJlZiwKICAgIGlzX251bGwsCiAgICBuZXcsCiAgICBudWxsLAogICAgdW53cmFwLAogICAgd3JpdGVfdG9fYnVmZmVyLAopCmZyb20gLl9saWJjcnlwdG8gaW1wb3J0IGxpYmNyeXB0bywgTGliY3J5cHRvQ29uc3QsIGxpYmNyeXB0b192ZXJzaW9uX2luZm8sIGhhbmRsZV9vcGVuc3NsX2Vycm9yCmZyb20gLi5lcnJvcnMgaW1wb3J0IEFzeW1tZXRyaWNLZXlFcnJvciwgSW5jb21wbGV0ZUFzeW1tZXRyaWNLZXlFcnJvciwgU2lnbmF0dXJlRXJyb3IKZnJvbSAuLl90eXBlcyBpbXBvcnQgdHlwZV9uYW1lLCBzdHJfY2xzLCBieXRlX2NscywgaW50X3R5cGVzCmZyb20gLi51dGlsIGltcG9ydCBjb25zdGFudF9jb21wYXJlCgoKX19hbGxfXyA9IFsKICAgICdDZXJ0aWZpY2F0ZScsCiAgICAnZHNhX3NpZ24nLAogICAgJ2RzYV92ZXJpZnknLAogICAgJ2VjZHNhX3NpZ24nLAogICAgJ2VjZHNhX3ZlcmlmeScsCiAgICAnZ2VuZXJhdGVfcGFpcicsCiAgICAnbG9hZF9jZXJ0aWZpY2F0ZScsCiAgICAnbG9hZF9wa2NzMTInLAogICAgJ2xvYWRfcHJpdmF0ZV9rZXknLAogICAgJ2xvYWRfcHVibGljX2tleScsCiAgICAncGFyc2VfcGtjczEyJywKICAgICdQcml2YXRlS2V5JywKICAgICdQdWJsaWNLZXknLAogICAgJ3JzYV9vYWVwX2RlY3J5cHQnLAogICAgJ3JzYV9vYWVwX2VuY3J5cHQnLAogICAgJ3JzYV9wa2NzMXYxNV9kZWNyeXB0JywKICAgICdyc2FfcGtjczF2MTVfZW5jcnlwdCcsCiAgICAncnNhX3BrY3MxdjE1X3NpZ24nLAogICAgJ3JzYV9wa2NzMXYxNV92ZXJpZnknLAogICAgJ3JzYV9wc3Nfc2lnbicsCiAgICAncnNhX3Bzc192ZXJpZnknLApdCgoKY2xhc3MgUHJpdmF0ZUtleShfUHJpdmF0ZUtleUJhc2UpOgogICAgIiIiCiAgICBDb250YWluZXIgZm9yIHRoZSBPcGVuU1NMIHJlcHJlc2VudGF0aW9uIG9mIGEgcHJpdmF0ZSBrZXkKICAgICIiIgoKICAgIGV2cF9wa2V5ID0gTm9uZQogICAgX3B1YmxpY19rZXkgPSBOb25lCgogICAgIyBBIHJlZmVyZW5jZSB0byB0aGUgbGlicmFyeSB1c2VkIGluIHRoZSBkZXN0cnVjdG9yIHRvIG1ha2Ugc3VyZSBpdCBoYXNuJ3QKICAgICMgYmVlbiBnYXJiYWdlIGNvbGxlY3RlZCBieSB0aGUgdGltZSB0aGlzIG9iamVjdCBpcyBnYXJiYWdlIGNvbGxlY3RlZAogICAgX2xpYiA9IE5vbmUKCiAgICBkZWYgX19pbml0X18oc2VsZiwgZXZwX3BrZXksIGFzbjEpOgogICAgICAgICIiIgogICAgICAgIDpwYXJhbSBldnBfcGtleToKICAgICAgICAgICAgQW4gT3BlblNTTCBFVlBfUEtFWSB2YWx1ZSBmcm9tIGxvYWRpbmcvaW1wb3J0aW5nIHRoZSBrZXkKCiAgICAgICAgOnBhcmFtIGFzbjE6CiAgICAgICAgICAgIEFuIGFzbjFjcnlwdG8ua2V5cy5Qcml2YXRlS2V5SW5mbyBvYmplY3QKICAgICAgICAiIiIKCiAgICAgICAgc2VsZi5ldnBfcGtleSA9IGV2cF9wa2V5CiAgICAgICAgc2VsZi5hc24xID0gYXNuMQogICAgICAgIHNlbGYuX2xpYiA9IGxpYmNyeXB0bwoKICAgIEBwcm9wZXJ0eQogICAgZGVmIHB1YmxpY19rZXkoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgOnJldHVybjoKICAgICAgICAgICAgQSBQdWJsaWNLZXkgb2JqZWN0IGNvcnJlc3BvbmRpbmcgdG8gdGhpcyBwcml2YXRlIGtleS4KICAgICAgICAiIiIKCiAgICAgICAgaWYgc2VsZi5fcHVibGljX2tleSBpcyBOb25lOgogICAgICAgICAgICBidWZmZXJfc2l6ZSA9IGxpYmNyeXB0by5pMmRfUFVCS0VZKHNlbGYuZXZwX3BrZXksIG51bGwoKSkKICAgICAgICAgICAgcHVia2V5X2J1ZmZlciA9IGJ1ZmZlcl9mcm9tX2J5dGVzKGJ1ZmZlcl9zaXplKQogICAgICAgICAgICBwdWJrZXlfcG9pbnRlciA9IGJ1ZmZlcl9wb2ludGVyKHB1YmtleV9idWZmZXIpCiAgICAgICAgICAgIHB1YmtleV9sZW5ndGggPSBsaWJjcnlwdG8uaTJkX1BVQktFWShzZWxmLmV2cF9wa2V5LCBwdWJrZXlfcG9pbnRlcikKICAgICAgICAgICAgaGFuZGxlX29wZW5zc2xfZXJyb3IocHVia2V5X2xlbmd0aCkKICAgICAgICAgICAgcHVia2V5X2RhdGEgPSBieXRlc19mcm9tX2J1ZmZlcihwdWJrZXlfYnVmZmVyLCBwdWJrZXlfbGVuZ3RoKQoKICAgICAgICAgICAgYXNuMSA9IFB1YmxpY0tleUluZm8ubG9hZChwdWJrZXlfZGF0YSkKCiAgICAgICAgICAgICMgT3BlblNTTCAxLnggc3VmZmVycyBmcm9tIGlzc3VlcyB0cnlpbmcgdG8gdXNlIFJTQVNTQS1QU1Mga2V5cywgc28gd2UKICAgICAgICAgICAgIyBtYXNxdWVyYWRlIGl0IGFzIGEgbm9ybWFsIFJTQSBrZXkgc28gdGhlIE9JRCBjaGVja3Mgd29yawogICAgICAgICAgICBpZiBsaWJjcnlwdG9fdmVyc2lvbl9pbmZvIDwgKDMsKSBhbmQgYXNuMS5hbGdvcml0aG0gPT0gJ3JzYXNzYV9wc3MnOgogICAgICAgICAgICAgICAgdGVtcF9hc24xID0gYXNuMS5jb3B5KCkKICAgICAgICAgICAgICAgIHRlbXBfYXNuMVsnYWxnb3JpdGhtJ11bJ2FsZ29yaXRobSddID0gJ3JzYScKICAgICAgICAgICAgICAgIHRlbXBfZGF0YSA9IHRlbXBfYXNuMS5kdW1wKCkKICAgICAgICAgICAgICAgIHdyaXRlX3RvX2J1ZmZlcihwdWJrZXlfYnVmZmVyLCB0ZW1wX2RhdGEpCiAgICAgICAgICAgICAgICBwdWJrZXlfbGVuZ3RoID0gbGVuKHRlbXBfZGF0YSkKCiAgICAgICAgICAgIHB1Yl9ldnBfcGtleSA9IGxpYmNyeXB0by5kMmlfUFVCS0VZKG51bGwoKSwgYnVmZmVyX3BvaW50ZXIocHVia2V5X2J1ZmZlciksIHB1YmtleV9sZW5ndGgpCiAgICAgICAgICAgIGlmIGlzX251bGwocHViX2V2cF9wa2V5KToKICAgICAgICAgICAgICAgIGhhbmRsZV9vcGVuc3NsX2Vycm9yKDApCgogICAgICAgICAgICBzZWxmLl9wdWJsaWNfa2V5ID0gUHVibGljS2V5KHB1Yl9ldnBfcGtleSwgYXNuMSkKCiAgICAgICAgcmV0dXJuIHNlbGYuX3B1YmxpY19rZXkKCiAgICBAcHJvcGVydHkKICAgIGRlZiBmaW5nZXJwcmludChzZWxmKToKICAgICAgICAiIiIKICAgICAgICBDcmVhdGVzIGEgZmluZ2VycHJpbnQgdGhhdCBjYW4gYmUgY29tcGFyZWQgd2l0aCBhIHB1YmxpYyBrZXkgdG8gc2VlIGlmCiAgICAgICAgdGhlIHR3byBmb3JtIGEgcGFpci4KCiAgICAgICAgVGhpcyBmaW5nZXJwcmludCBpcyBub3QgY29tcGF0aWJsZSB3aXRoIGZpbmdlcnByaW50cyBnZW5lcmF0ZWQgYnkgYW55CiAgICAgICAgb3RoZXIgc29mdHdhcmUuCgogICAgICAgIDpyZXR1cm46CiAgICAgICAgICAgIEEgYnl0ZSBzdHJpbmcgdGhhdCBpcyBhIHNoYTI1NiBoYXNoIG9mIHNlbGVjdGVkIGNvbXBvbmVudHMgKGJhc2VkCiAgICAgICAgICAgIG9uIHRoZSBrZXkgdHlwZSkKICAgICAgICAiIiIKCiAgICAgICAgaWYgc2VsZi5fZmluZ2VycHJpbnQgaXMgTm9uZToKICAgICAgICAgICAgc2VsZi5fZmluZ2VycHJpbnQgPSBfZmluZ2VycHJpbnQoc2VsZi5hc24xLCBsb2FkX3ByaXZhdGVfa2V5KQogICAgICAgIHJldHVybiBzZWxmLl9maW5nZXJwcmludAoKICAgIGRlZiBfX2RlbF9fKHNlbGYpOgogICAgICAgIGlmIHNlbGYuZXZwX3BrZXk6CiAgICAgICAgICAgIHNlbGYuX2xpYi5FVlBfUEtFWV9mcmVlKHNlbGYuZXZwX3BrZXkpCiAgICAgICAgICAgIHNlbGYuX2xpYiA9IE5vbmUKICAgICAgICAgICAgc2VsZi5ldnBfcGtleSA9IE5vbmUKCgpjbGFzcyBQdWJsaWNLZXkoX1B1YmxpY0tleUJhc2UpOgogICAgIiIiCiAgICBDb250YWluZXIgZm9yIHRoZSBPcGVuU1NMIHJlcHJlc2VudGF0aW9uIG9mIGEgcHVibGljIGtleQogICAgIiIiCgogICAgZXZwX3BrZXkgPSBOb25lCgogICAgIyBBIHJlZmVyZW5jZSB0byB0aGUgbGlicmFyeSB1c2VkIGluIHRoZSBkZXN0cnVjdG9yIHRvIG1ha2Ugc3VyZSBpdCBoYXNuJ3QKICAgICMgYmVlbiBnYXJiYWdlIGNvbGxlY3RlZCBieSB0aGUgdGltZSB0aGlzIG9iamVjdCBpcyBnYXJiYWdlIGNvbGxlY3RlZAogICAgX2xpYiA9IE5vbmUKCiAgICBkZWYgX19pbml0X18oc2VsZiwgZXZwX3BrZXksIGFzbjEpOgogICAgICAgICIiIgogICAgICAgIDpwYXJhbSBldnBfcGtleToKICAgICAgICAgICAgQW4gT3BlblNTTCBFVlBfUEtFWSB2YWx1ZSBmcm9tIGxvYWRpbmcvaW1wb3J0aW5nIHRoZSBrZXkKCiAgICAgICAgOnBhcmFtIGFzbjE6CiAgICAgICAgICAgIEFuIGFzbjFjcnlwdG8ua2V5cy5QdWJsaWNLZXlJbmZvIG9iamVjdAogICAgICAgICIiIgoKICAgICAgICBzZWxmLmV2cF9wa2V5ID0gZXZwX3BrZXkKICAgICAgICBzZWxmLmFzbjEgPSBhc24xCiAgICAgICAgc2VsZi5fbGliID0gbGliY3J5cHRvCgogICAgZGVmIF9fZGVsX18oc2VsZik6CiAgICAgICAgaWYgc2VsZi5ldnBfcGtleToKICAgICAgICAgICAgc2VsZi5fbGliLkVWUF9QS0VZX2ZyZWUoc2VsZi5ldnBfcGtleSkKICAgICAgICAgICAgc2VsZi5fbGliID0gTm9uZQogICAgICAgICAgICBzZWxmLmV2cF9wa2V5ID0gTm9uZQoKCmNsYXNzIENlcnRpZmljYXRlKF9DZXJ0aWZpY2F0ZUJhc2UpOgogICAgIiIiCiAgICBDb250YWluZXIgZm9yIHRoZSBPcGVuU1NMIHJlcHJlc2VudGF0aW9uIG9mIGEgY2VydGlmaWNhdGUKICAgICIiIgoKICAgIHg1MDkgPSBOb25lCiAgICBfcHVibGljX2tleSA9IE5vbmUKICAgIF9zZWxmX3NpZ25lZCA9IE5vbmUKCiAgICAjIEEgcmVmZXJlbmNlIHRvIHRoZSBsaWJyYXJ5IHVzZWQgaW4gdGhlIGRlc3RydWN0b3IgdG8gbWFrZSBzdXJlIGl0IGhhc24ndAogICAgIyBiZWVuIGdhcmJhZ2UgY29sbGVjdGVkIGJ5IHRoZSB0aW1lIHRoaXMgb2JqZWN0IGlzIGdhcmJhZ2UgY29sbGVjdGVkCiAgICBfbGliID0gTm9uZQoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCB4NTA5LCBhc24xKToKICAgICAgICAiIiIKICAgICAgICA6cGFyYW0geDUwOToKICAgICAgICAgICAgQW4gT3BlblNTTCBYNTA5IHZhbHVlIGZyb20gbG9hZGluZy9pbXBvcnRpbmcgdGhlIGNlcnRpZmljYXRlCgogICAgICAgIDpwYXJhbSBhc24xOgogICAgICAgICAgICBBbiBhc24xY3J5cHRvLng1MDkuQ2VydGlmaWNhdGUgb2JqZWN0CiAgICAgICAgIiIiCgogICAgICAgIHNlbGYueDUwOSA9IHg1MDkKICAgICAgICBzZWxmLmFzbjEgPSBhc24xCiAgICAgICAgc2VsZi5fbGliID0gbGliY3J5cHRvCgogICAgQHByb3BlcnR5CiAgICBkZWYgZXZwX3BrZXkoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgOnJldHVybjoKICAgICAgICAgICAgVGhlIEVWUF9QS0VZIG9mIHRoZSBwdWJsaWMga2V5IHRoaXMgY2VydGlmaWNhdGUgY29udGFpbnMKICAgICAgICAiIiIKCiAgICAgICAgcmV0dXJuIHNlbGYucHVibGljX2tleS5ldnBfcGtleQoKICAgIEBwcm9wZXJ0eQogICAgZGVmIHB1YmxpY19rZXkoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgOnJldHVybjoKICAgICAgICAgICAgVGhlIFB1YmxpY0tleSBvYmplY3QgZm9yIHRoZSBwdWJsaWMga2V5IHRoaXMgY2VydGlmaWNhdGUgY29udGFpbnMKICAgICAgICAiIiIKCiAgICAgICAgaWYgbm90IHNlbGYuX3B1YmxpY19rZXkgYW5kIHNlbGYueDUwOToKICAgICAgICAgICAgIyBPcGVuU1NMIDEueCBzdWZmZXJzIGZyb20gaXNzdWVzIHRyeWluZyB0byB1c2UgUlNBU1NBLVBTUyBrZXlzLCBzbyB3ZQogICAgICAgICAgICAjIG1hc3F1ZXJhZGUgaXQgYXMgYSBub3JtYWwgUlNBIGtleSBzbyB0aGUgT0lEIGNoZWNrcyB3b3JrCiAgICAgICAgICAgIGlmIGxpYmNyeXB0b192ZXJzaW9uX2luZm8gPCAoMywpIGFuZCBzZWxmLmFzbjEucHVibGljX2tleS5hbGdvcml0aG0gPT0gJ3JzYXNzYV9wc3MnOgogICAgICAgICAgICAgICAgc2VsZi5fcHVibGljX2tleSA9IGxvYWRfcHVibGljX2tleShzZWxmLmFzbjEucHVibGljX2tleSkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGV2cF9wa2V5ID0gbGliY3J5cHRvLlg1MDlfZ2V0X3B1YmtleShzZWxmLng1MDkpCiAgICAgICAgICAgICAgICBzZWxmLl9wdWJsaWNfa2V5ID0gUHVibGljS2V5KGV2cF9wa2V5LCBzZWxmLmFzbjEucHVibGljX2tleSkKCiAgICAgICAgcmV0dXJuIHNlbGYuX3B1YmxpY19rZXkKCiAgICBAcHJvcGVydHkKICAgIGRlZiBzZWxmX3NpZ25lZChzZWxmKToKICAgICAgICAiIiIKICAgICAgICA6cmV0dXJuOgogICAgICAgICAgICBBIGJvb2xlYW4gLSBpZiB0aGUgY2VydGlmaWNhdGUgaXMgc2VsZi1zaWduZWQKICAgICAgICAiIiIKCiAgICAgICAgaWYgc2VsZi5fc2VsZl9zaWduZWQgaXMgTm9uZToKICAgICAgICAgICAgc2VsZi5fc2VsZl9zaWduZWQgPSBGYWxzZQogICAgICAgICAgICBpZiBzZWxmLmFzbjEuc2VsZl9zaWduZWQgaW4gc2V0KFsneWVzJywgJ21heWJlJ10pOgoKICAgICAgICAgICAgICAgIHNpZ25hdHVyZV9hbGdvID0gc2VsZi5hc24xWydzaWduYXR1cmVfYWxnb3JpdGhtJ10uc2lnbmF0dXJlX2FsZ28KICAgICAgICAgICAgICAgIGhhc2hfYWxnbyA9IHNlbGYuYXNuMVsnc2lnbmF0dXJlX2FsZ29yaXRobSddLmhhc2hfYWxnbwoKICAgICAgICAgICAgICAgIGlmIHNpZ25hdHVyZV9hbGdvID09ICdyc2Fzc2FfcGtjczF2MTUnOgogICAgICAgICAgICAgICAgICAgIHZlcmlmeV9mdW5jID0gcnNhX3BrY3MxdjE1X3ZlcmlmeQogICAgICAgICAgICAgICAgZWxpZiBzaWduYXR1cmVfYWxnbyA9PSAncnNhc3NhX3Bzcyc6CiAgICAgICAgICAgICAgICAgICAgdmVyaWZ5X2Z1bmMgPSByc2FfcHNzX3ZlcmlmeQogICAgICAgICAgICAgICAgZWxpZiBzaWduYXR1cmVfYWxnbyA9PSAnZHNhJzoKICAgICAgICAgICAgICAgICAgICB2ZXJpZnlfZnVuYyA9IGRzYV92ZXJpZnkKICAgICAgICAgICAgICAgIGVsaWYgc2lnbmF0dXJlX2FsZ28gPT0gJ2VjZHNhJzoKICAgICAgICAgICAgICAgICAgICB2ZXJpZnlfZnVuYyA9IGVjZHNhX3ZlcmlmeQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICByYWlzZSBPU0Vycm9yKHByZXR0eV9tZXNzYWdlKAogICAgICAgICAgICAgICAgICAgICAgICAnJycKICAgICAgICAgICAgICAgICAgICAgICAgVW5hYmxlIHRvIHZlcmlmeSB0aGUgc2lnbmF0dXJlIG9mIHRoZSBjZXJ0aWZpY2F0ZSBzaW5jZQogICAgICAgICAgICAgICAgICAgICAgICBpdCB1c2VzIHRoZSB1bnN1cHBvcnRlZCBhbGdvcml0aG0gJXMKICAgICAgICAgICAgICAgICAgICAgICAgJycnLAogICAgICAgICAgICAgICAgICAgICAgICBzaWduYXR1cmVfYWxnbwogICAgICAgICAgICAgICAgICAgICkpCgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIHZlcmlmeV9mdW5jKAogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnB1YmxpY19rZXksCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuYXNuMVsnc2lnbmF0dXJlX3ZhbHVlJ10ubmF0aXZlLAogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmFzbjFbJ3Ric19jZXJ0aWZpY2F0ZSddLmR1bXAoKSwKICAgICAgICAgICAgICAgICAgICAgICAgaGFzaF9hbGdvCiAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICAgIHNlbGYuX3NlbGZfc2lnbmVkID0gVHJ1ZQogICAgICAgICAgICAgICAgZXhjZXB0IChTaWduYXR1cmVFcnJvcik6CiAgICAgICAgICAgICAgICAgICAgcGFzcwoKICAgICAgICByZXR1cm4gc2VsZi5fc2VsZl9zaWduZWQKCiAgICBkZWYgX19kZWxfXyhzZWxmKToKICAgICAgICBpZiBzZWxmLl9wdWJsaWNfa2V5OgogICAgICAgICAgICBzZWxmLl9wdWJsaWNfa2V5Ll9fZGVsX18oKQogICAgICAgICAgICBzZWxmLl9wdWJsaWNfa2V5ID0gTm9uZQoKICAgICAgICBpZiBzZWxmLng1MDk6CiAgICAgICAgICAgIHNlbGYuX2xpYi5YNTA5X2ZyZWUoc2VsZi54NTA5KQogICAgICAgICAgICBzZWxmLl9saWIgPSBOb25lCiAgICAgICAgICAgIHNlbGYueDUwOSA9IE5vbmUKCgpkZWYgZ2VuZXJhdGVfcGFpcihhbGdvcml0aG0sIGJpdF9zaXplPU5vbmUsIGN1cnZlPU5vbmUpOgogICAgIiIiCiAgICBHZW5lcmF0ZXMgYSBwdWJsaWMvcHJpdmF0ZSBrZXkgcGFpcgoKICAgIDpwYXJhbSBhbGdvcml0aG06CiAgICAgICAgVGhlIGtleSBhbGdvcml0aG0gLSAicnNhIiwgImRzYSIgb3IgImVjIgoKICAgIDpwYXJhbSBiaXRfc2l6ZToKICAgICAgICBBbiBpbnRlZ2VyIC0gdXNlZCBmb3IgInJzYSIgYW5kICJkc2EiLiBGb3IgInJzYSIgdGhlIHZhbHVlIG1heWUgYmUgMTAyNCwKICAgICAgICAyMDQ4LCAzMDcyIG9yIDQwOTYuIEZvciAiZHNhIiB0aGUgdmFsdWUgbWF5IGJlIDEwMjQsIHBsdXMgMjA0OCBvciAzMDcyCiAgICAgICAgaWYgT3BlblNTTCAxLjAuMCBvciBuZXdlciBpcyBhdmFpbGFibGUuCgogICAgOnBhcmFtIGN1cnZlOgogICAgICAgIEEgdW5pY29kZSBzdHJpbmcgLSB1c2VkIGZvciAiZWMiIGtleXMuIFZhbGlkIHZhbHVlcyBpbmNsdWRlICJzZWNwMjU2cjEiLAogICAgICAgICJzZWNwMzg0cjEiIGFuZCAic2VjcDUyMXIxIi4KCiAgICA6cmFpc2VzOgogICAgICAgIFZhbHVlRXJyb3IgLSB3aGVuIGFueSBvZiB0aGUgcGFyYW1ldGVycyBjb250YWluIGFuIGludmFsaWQgdmFsdWUKICAgICAgICBUeXBlRXJyb3IgLSB3aGVuIGFueSBvZiB0aGUgcGFyYW1ldGVycyBhcmUgb2YgdGhlIHdyb25nIHR5cGUKICAgICAgICBPU0Vycm9yIC0gd2hlbiBhbiBlcnJvciBpcyByZXR1cm5lZCBieSB0aGUgT1MgY3J5cHRvIGxpYnJhcnkKCiAgICA6cmV0dXJuOgogICAgICAgIEEgMi1lbGVtZW50IHR1cGxlIG9mIChQdWJsaWNLZXksIFByaXZhdGVLZXkpLiBUaGUgY29udGVudHMgb2YgZWFjaCBrZXkKICAgICAgICBtYXkgYmUgc2F2ZWQgYnkgY2FsbGluZyAuYXNuMS5kdW1wKCkuCiAgICAiIiIKCiAgICBpZiBhbGdvcml0aG0gbm90IGluIHNldChbJ3JzYScsICdkc2EnLCAnZWMnXSk6CiAgICAgICAgcmFpc2UgVmFsdWVFcnJvcihwcmV0dHlfbWVzc2FnZSgKICAgICAgICAgICAgJycnCiAgICAgICAgICAgIGFsZ29yaXRobSBtdXN0IGJlIG9uZSBvZiAicnNhIiwgImRzYSIsICJlYyIsIG5vdCAlcwogICAgICAgICAgICAnJycsCiAgICAgICAgICAgIHJlcHIoYWxnb3JpdGhtKQogICAgICAgICkpCgogICAgaWYgYWxnb3JpdGhtID09ICdyc2EnOgogICAgICAgIGlmIGJpdF9zaXplIG5vdCBpbiBzZXQoWzEwMjQsIDIwNDgsIDMwNzIsIDQwOTZdKToKICAgICAgICAgICAgcmFpc2UgVmFsdWVFcnJvcihwcmV0dHlfbWVzc2FnZSgKICAgICAgICAgICAgICAgICcnJwogICAgICAgICAgICAgICAgYml0X3NpemUgbXVzdCBiZSBvbmUgb2YgMTAyNCwgMjA0OCwgMzA3MiwgNDA5Niwgbm90ICVzCiAgICAgICAgICAgICAgICAnJycsCiAgICAgICAgICAgICAgICByZXByKGJpdF9zaXplKQogICAgICAgICAgICApKQoKICAgIGVsaWYgYWxnb3JpdGhtID09ICdkc2EnOgogICAgICAgIGlmIGxpYmNyeXB0b192ZXJzaW9uX2luZm8gPCAoMSwpOgogICAgICAgICAgICBpZiBiaXRfc2l6ZSAhPSAxMDI0OgogICAgICAgICAgICAgICAgcmFpc2UgVmFsdWVFcnJvcihwcmV0dHlfbWVzc2FnZSgKICAgICAgICAgICAgICAgICAgICAnJycKICAgICAgICAgICAgICAgICAgICBiaXRfc2l6ZSBtdXN0IGJlIDEwMjQsIG5vdCAlcwogICAgICAgICAgICAgICAgICAgICcnJywKICAgICAgICAgICAgICAgICAgICByZXByKGJpdF9zaXplKQogICAgICAgICAgICAgICAgKSkKICAgICAgICBlbHNlOgogICAgICAgICAgICBpZiBiaXRfc2l6ZSBub3QgaW4gc2V0KFsxMDI0LCAyMDQ4LCAzMDcyXSk6CiAgICAgICAgICAgICAgICByYWlzZSBWYWx1ZUVycm9yKHByZXR0eV9tZXNzYWdlKAogICAgICAgICAgICAgICAgICAgICcnJwogICAgICAgICAgICAgICAgICAgIGJpdF9zaXplIG11c3QgYmUgb25lIG9mIDEwMjQsIDIwNDgsIDMwNzIsIG5vdCAlcwogICAgICAgICAgICAgICAgICAgICcnJywKICAgICAgICAgICAgICAgICAgICByZXByKGJpdF9zaXplKQogICAgICAgICAgICAgICAgKSkKCiAgICBlbGlmIGFsZ29yaXRobSA9PSAnZWMnOgogICAgICAgIGlmIGN1cnZlIG5vdCBpbiBzZXQoWydzZWNwMjU2cjEnLCAnc2VjcDM4NHIxJywgJ3NlY3A1MjFyMSddKToKICAgICAgICAgICAgcmFpc2UgVmFsdWVFcnJvcihwcmV0dHlfbWVzc2FnZSgKICAgICAgICAgICAgICAgICcnJwogICAgICAgICAgICAgICAgY3VydmUgbXVzdCBiZSBvbmUgb2YgInNlY3AyNTZyMSIsICJzZWNwMzg0cjEiLCAic2VjcDUyMXIxIiwKICAgICAgICAgICAgICAgIG5vdCAlcwogICAgICAgICAgICAgICAgJycnLAogICAgICAgICAgICAgICAgcmVwcihjdXJ2ZSkKICAgICAgICAgICAgKSkKCiAgICBpZiBhbGdvcml0aG0gPT0gJ3JzYSc6CiAgICAgICAgcnNhID0gTm9uZQogICAgICAgIGV4cG9uZW50ID0gTm9uZQoKICAgICAgICB0cnk6CiAgICAgICAgICAgIHJzYSA9IGxpYmNyeXB0by5SU0FfbmV3KCkKICAgICAgICAgICAgaWYgaXNfbnVsbChyc2EpOgogICAgICAgICAgICAgICAgaGFuZGxlX29wZW5zc2xfZXJyb3IoMCkKCiAgICAgICAgICAgIGV4cG9uZW50X3BvaW50ZXIgPSBuZXcobGliY3J5cHRvLCAnQklHTlVNICoqJykKICAgICAgICAgICAgcmVzdWx0ID0gbGliY3J5cHRvLkJOX2RlYzJibihleHBvbmVudF9wb2ludGVyLCBiJzY1NTM3JykKICAgICAgICAgICAgaGFuZGxlX29wZW5zc2xfZXJyb3IocmVzdWx0KQogICAgICAgICAgICBleHBvbmVudCA9IHVud3JhcChleHBvbmVudF9wb2ludGVyKQoKICAgICAgICAgICAgcmVzdWx0ID0gbGliY3J5cHRvLlJTQV9nZW5lcmF0ZV9rZXlfZXgocnNhLCBiaXRfc2l6ZSwgZXhwb25lbnQsIG51bGwoKSkKICAgICAgICAgICAgaGFuZGxlX29wZW5zc2xfZXJyb3IocmVzdWx0KQoKICAgICAgICAgICAgYnVmZmVyX2xlbmd0aCA9IGxpYmNyeXB0by5pMmRfUlNBUHVibGljS2V5KHJzYSwgbnVsbCgpKQogICAgICAgICAgICBpZiBidWZmZXJfbGVuZ3RoIDwgMDoKICAgICAgICAgICAgICAgIGhhbmRsZV9vcGVuc3NsX2Vycm9yKGJ1ZmZlcl9sZW5ndGgpCiAgICAgICAgICAgIGJ1ZmZlciA9IGJ1ZmZlcl9mcm9tX2J5dGVzKGJ1ZmZlcl9sZW5ndGgpCiAgICAgICAgICAgIHJlc3VsdCA9IGxpYmNyeXB0by5pMmRfUlNBUHVibGljS2V5KHJzYSwgYnVmZmVyX3BvaW50ZXIoYnVmZmVyKSkKICAgICAgICAgICAgaWYgcmVzdWx0IDwgMDoKICAgICAgICAgICAgICAgIGhhbmRsZV9vcGVuc3NsX2Vycm9yKHJlc3VsdCkKICAgICAgICAgICAgcHVibGljX2tleV9ieXRlcyA9IGJ5dGVzX2Zyb21fYnVmZmVyKGJ1ZmZlciwgYnVmZmVyX2xlbmd0aCkKCiAgICAgICAgICAgIGJ1ZmZlcl9sZW5ndGggPSBsaWJjcnlwdG8uaTJkX1JTQVByaXZhdGVLZXkocnNhLCBudWxsKCkpCiAgICAgICAgICAgIGlmIGJ1ZmZlcl9sZW5ndGggPCAwOgogICAgICAgICAgICAgICAgaGFuZGxlX29wZW5zc2xfZXJyb3IoYnVmZmVyX2xlbmd0aCkKICAgICAgICAgICAgYnVmZmVyID0gYnVmZmVyX2Zyb21fYnl0ZXMoYnVmZmVyX2xlbmd0aCkKICAgICAgICAgICAgcmVzdWx0ID0gbGliY3J5cHRvLmkyZF9SU0FQcml2YXRlS2V5KHJzYSwgYnVmZmVyX3BvaW50ZXIoYnVmZmVyKSkKICAgICAgICAgICAgaWYgcmVzdWx0IDwgMDoKICAgICAgICAgICAgICAgIGhhbmRsZV9vcGVuc3NsX2Vycm9yKHJlc3VsdCkKICAgICAgICAgICAgcHJpdmF0ZV9rZXlfYnl0ZXMgPSBieXRlc19mcm9tX2J1ZmZlcihidWZmZXIsIGJ1ZmZlcl9sZW5ndGgpCgogICAgICAgIGZpbmFsbHk6CiAgICAgICAgICAgIGlmIHJzYToKICAgICAgICAgICAgICAgIGxpYmNyeXB0by5SU0FfZnJlZShyc2EpCiAgICAgICAgICAgIGlmIGV4cG9uZW50OgogICAgICAgICAgICAgICAgbGliY3J5cHRvLkJOX2ZyZWUoZXhwb25lbnQpCgogICAgZWxpZiBhbGdvcml0aG0gPT0gJ2RzYSc6CiAgICAgICAgZHNhID0gTm9uZQoKICAgICAgICB0cnk6CiAgICAgICAgICAgIGRzYSA9IGxpYmNyeXB0by5EU0FfbmV3KCkKICAgICAgICAgICAgaWYgaXNfbnVsbChkc2EpOgogICAgICAgICAgICAgICAgaGFuZGxlX29wZW5zc2xfZXJyb3IoMCkKCiAgICAgICAgICAgIHJlc3VsdCA9IGxpYmNyeXB0by5EU0FfZ2VuZXJhdGVfcGFyYW1ldGVyc19leChkc2EsIGJpdF9zaXplLCBudWxsKCksIDAsIG51bGwoKSwgbnVsbCgpLCBudWxsKCkpCiAgICAgICAgICAgIGhhbmRsZV9vcGVuc3NsX2Vycm9yKHJlc3VsdCkKCiAgICAgICAgICAgIHJlc3VsdCA9IGxpYmNyeXB0by5EU0FfZ2VuZXJhdGVfa2V5KGRzYSkKICAgICAgICAgICAgaGFuZGxlX29wZW5zc2xfZXJyb3IocmVzdWx0KQoKICAgICAgICAgICAgYnVmZmVyX2xlbmd0aCA9IGxpYmNyeXB0by5pMmRfRFNBX1BVQktFWShkc2EsIG51bGwoKSkKICAgICAgICAgICAgaWYgYnVmZmVyX2xlbmd0aCA8IDA6CiAgICAgICAgICAgICAgICBoYW5kbGVfb3BlbnNzbF9lcnJvcihidWZmZXJfbGVuZ3RoKQogICAgICAgICAgICBidWZmZXIgPSBidWZmZXJfZnJvbV9ieXRlcyhidWZmZXJfbGVuZ3RoKQogICAgICAgICAgICByZXN1bHQgPSBsaWJjcnlwdG8uaTJkX0RTQV9QVUJLRVkoZHNhLCBidWZmZXJfcG9pbnRlcihidWZmZXIpKQogICAgICAgICAgICBpZiByZXN1bHQgPCAwOgogICAgICAgICAgICAgICAgaGFuZGxlX29wZW5zc2xfZXJyb3IocmVzdWx0KQogICAgICAgICAgICBwdWJsaWNfa2V5X2J5dGVzID0gYnl0ZXNfZnJvbV9idWZmZXIoYnVmZmVyLCBidWZmZXJfbGVuZ3RoKQoKICAgICAgICAgICAgYnVmZmVyX2xlbmd0aCA9IGxpYmNyeXB0by5pMmRfRFNBUHJpdmF0ZUtleShkc2EsIG51bGwoKSkKICAgICAgICAgICAgaWYgYnVmZmVyX2xlbmd0aCA8IDA6CiAgICAgICAgICAgICAgICBoYW5kbGVfb3BlbnNzbF9lcnJvcihidWZmZXJfbGVuZ3RoKQogICAgICAgICAgICBidWZmZXIgPSBidWZmZXJfZnJvbV9ieXRlcyhidWZmZXJfbGVuZ3RoKQogICAgICAgICAgICByZXN1bHQgPSBsaWJjcnlwdG8uaTJkX0RTQVByaXZhdGVLZXkoZHNhLCBidWZmZXJfcG9pbnRlcihidWZmZXIpKQogICAgICAgICAgICBpZiByZXN1bHQgPCAwOgogICAgICAgICAgICAgICAgaGFuZGxlX29wZW5zc2xfZXJyb3IocmVzdWx0KQogICAgICAgICAgICBwcml2YXRlX2tleV9ieXRlcyA9IGJ5dGVzX2Zyb21fYnVmZmVyKGJ1ZmZlciwgYnVmZmVyX2xlbmd0aCkKCiAgICAgICAgZmluYWxseToKICAgICAgICAgICAgaWYgZHNhOgogICAgICAgICAgICAgICAgbGliY3J5cHRvLkRTQV9mcmVlKGRzYSkKCiAgICBlbGlmIGFsZ29yaXRobSA9PSAnZWMnOgogICAgICAgIGVjX2tleSA9IE5vbmUKCiAgICAgICAgdHJ5OgogICAgICAgICAgICBjdXJ2ZV9pZCA9IHsKICAgICAgICAgICAgICAgICdzZWNwMjU2cjEnOiBMaWJjcnlwdG9Db25zdC5OSURfWDlfNjJfcHJpbWUyNTZ2MSwKICAgICAgICAgICAgICAgICdzZWNwMzg0cjEnOiBMaWJjcnlwdG9Db25zdC5OSURfc2VjcDM4NHIxLAogICAgICAgICAgICAgICAgJ3NlY3A1MjFyMSc6IExpYmNyeXB0b0NvbnN0Lk5JRF9zZWNwNTIxcjEsCiAgICAgICAgICAgIH1bY3VydmVdCgogICAgICAgICAgICBlY19rZXkgPSBsaWJjcnlwdG8uRUNfS0VZX25ld19ieV9jdXJ2ZV9uYW1lKGN1cnZlX2lkKQogICAgICAgICAgICBpZiBpc19udWxsKGVjX2tleSk6CiAgICAgICAgICAgICAgICBoYW5kbGVfb3BlbnNzbF9lcnJvcigwKQoKICAgICAgICAgICAgcmVzdWx0ID0gbGliY3J5cHRvLkVDX0tFWV9nZW5lcmF0ZV9rZXkoZWNfa2V5KQogICAgICAgICAgICBoYW5kbGVfb3BlbnNzbF9lcnJvcihyZXN1bHQpCgogICAgICAgICAgICBsaWJjcnlwdG8uRUNfS0VZX3NldF9hc24xX2ZsYWcoZWNfa2V5LCBMaWJjcnlwdG9Db25zdC5PUEVOU1NMX0VDX05BTUVEX0NVUlZFKQoKICAgICAgICAgICAgYnVmZmVyX2xlbmd0aCA9IGxpYmNyeXB0by5pMm9fRUNQdWJsaWNLZXkoZWNfa2V5LCBudWxsKCkpCiAgICAgICAgICAgIGlmIGJ1ZmZlcl9sZW5ndGggPCAwOgogICAgICAgICAgICAgICAgaGFuZGxlX29wZW5zc2xfZXJyb3IoYnVmZmVyX2xlbmd0aCkKICAgICAgICAgICAgYnVmZmVyID0gYnVmZmVyX2Zyb21fYnl0ZXMoYnVmZmVyX2xlbmd0aCkKICAgICAgICAgICAgcmVzdWx0ID0gbGliY3J5cHRvLmkyb19FQ1B1YmxpY0tleShlY19rZXksIGJ1ZmZlcl9wb2ludGVyKGJ1ZmZlcikpCiAgICAgICAgICAgIGlmIHJlc3VsdCA8IDA6CiAgICAgICAgICAgICAgICBoYW5kbGVfb3BlbnNzbF9lcnJvcihyZXN1bHQpCiAgICAgICAgICAgIHB1YmxpY19rZXlfcG9pbnRfYnl0ZXMgPSBieXRlc19mcm9tX2J1ZmZlcihidWZmZXIsIGJ1ZmZlcl9sZW5ndGgpCgogICAgICAgICAgICAjIGkyb19FQ1B1YmxpY0tleSBvbmx5IHJldHVybnMgdGhlIEVDUG9pbnQgYnl0ZXMsIHNvIHdlIGhhdmUgdG8KICAgICAgICAgICAgIyBtYW51YWxseSB3cmFwIGl0IGluIGEgUHVibGljS2V5SW5mbyBzdHJ1Y3R1cmUgdG8gZ2V0IGl0IHRvIHBhcnNlCiAgICAgICAgICAgIHB1YmxpY19rZXkgPSBQdWJsaWNLZXlJbmZvKHsKICAgICAgICAgICAgICAgICdhbGdvcml0aG0nOiBQdWJsaWNLZXlBbGdvcml0aG0oewogICAgICAgICAgICAgICAgICAgICdhbGdvcml0aG0nOiAnZWMnLAogICAgICAgICAgICAgICAgICAgICdwYXJhbWV0ZXJzJzogRUNEb21haW5QYXJhbWV0ZXJzKAogICAgICAgICAgICAgICAgICAgICAgICBuYW1lPSduYW1lZCcsCiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlPWN1cnZlCiAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICAncHVibGljX2tleSc6IHB1YmxpY19rZXlfcG9pbnRfYnl0ZXMKICAgICAgICAgICAgfSkKICAgICAgICAgICAgcHVibGljX2tleV9ieXRlcyA9IHB1YmxpY19rZXkuZHVtcCgpCgogICAgICAgICAgICBidWZmZXJfbGVuZ3RoID0gbGliY3J5cHRvLmkyZF9FQ1ByaXZhdGVLZXkoZWNfa2V5LCBudWxsKCkpCiAgICAgICAgICAgIGlmIGJ1ZmZlcl9sZW5ndGggPCAwOgogICAgICAgICAgICAgICAgaGFuZGxlX29wZW5zc2xfZXJyb3IoYnVmZmVyX2xlbmd0aCkKICAgICAgICAgICAgYnVmZmVyID0gYnVmZmVyX2Zyb21fYnl0ZXMoYnVmZmVyX2xlbmd0aCkKICAgICAgICAgICAgcmVzdWx0ID0gbGliY3J5cHRvLmkyZF9FQ1ByaXZhdGVLZXkoZWNfa2V5LCBidWZmZXJfcG9pbnRlcihidWZmZXIpKQogICAgICAgICAgICBpZiByZXN1bHQgPCAwOgogICAgICAgICAgICAgICAgaGFuZGxlX29wZW5zc2xfZXJyb3IocmVzdWx0KQogICAgICAgICAgICBwcml2YXRlX2tleV9ieXRlcyA9IGJ5dGVzX2Zyb21fYnVmZmVyKGJ1ZmZlciwgYnVmZmVyX2xlbmd0aCkKCiAgICAgICAgZmluYWxseToKICAgICAgICAgICAgaWYgZWNfa2V5OgogICAgICAgICAgICAgICAgbGliY3J5cHRvLkVDX0tFWV9mcmVlKGVjX2tleSkKCiAgICByZXR1cm4gKGxvYWRfcHVibGljX2tleShwdWJsaWNfa2V5X2J5dGVzKSwgbG9hZF9wcml2YXRlX2tleShwcml2YXRlX2tleV9ieXRlcykpCgoKZGVmIGdlbmVyYXRlX2RoX3BhcmFtZXRlcnMoYml0X3NpemUpOgogICAgIiIiCiAgICBHZW5lcmF0ZXMgREggcGFyYW1ldGVycyBmb3IgdXNlIHdpdGggRGlmZmllLUhlbGxtYW4ga2V5IGV4Y2hhbmdlLiBSZXR1cm5zCiAgICBhIHN0cnVjdHVyZSBpbiB0aGUgZm9ybWF0IG9mIERIUGFyYW1ldGVyIGRlZmluZWQgaW4gUEtDUyMzLCB3aGljaCBpcyBhbHNvCiAgICB1c2VkIGJ5IHRoZSBPcGVuU1NMIGRocGFyYW0gdG9vbC4KCiAgICBUSElTIENBTiBCRSBWRVJZIFRJTUUgQ09OU1VNSU5HIQoKICAgIDpwYXJhbSBiaXRfc2l6ZToKICAgICAgICBUaGUgaW50ZWdlciBiaXQgc2l6ZSBvZiB0aGUgcGFyYW1ldGVycyB0byBnZW5lcmF0ZS4gTXVzdCBiZSBiZXR3ZWVuIDUxMgogICAgICAgIGFuZCA0MDk2LCBhbmQgZGl2aXNpYmxlIGJ5IDY0LiBSZWNvbW1lbmRlZCBzZWN1cmUgdmFsdWUgYXMgb2YgZWFybHkgMjAxNgogICAgICAgIGlzIDIwNDgsIHdpdGggYW4gYWJzb2x1dGUgbWluaW11bSBvZiAxMDI0LgoKICAgIDpyYWlzZXM6CiAgICAgICAgVmFsdWVFcnJvciAtIHdoZW4gYW55IG9mIHRoZSBwYXJhbWV0ZXJzIGNvbnRhaW4gYW4gaW52YWxpZCB2YWx1ZQogICAgICAgIFR5cGVFcnJvciAtIHdoZW4gYW55IG9mIHRoZSBwYXJhbWV0ZXJzIGFyZSBvZiB0aGUgd3JvbmcgdHlwZQogICAgICAgIE9TRXJyb3IgLSB3aGVuIGFuIGVycm9yIGlzIHJldHVybmVkIGJ5IHRoZSBPUyBjcnlwdG8gbGlicmFyeQoKICAgIDpyZXR1cm46CiAgICAgICAgQW4gYXNuMWNyeXB0by5hbGdvcy5ESFBhcmFtZXRlcnMgb2JqZWN0LiBVc2UKICAgICAgICBvc2NyeXB0by5hc3ltbWV0cmljLmR1bXBfZGhfcGFyYW1ldGVycygpIHRvIHNhdmUgdG8gZGlzayBmb3IgdXNhZ2Ugd2l0aAogICAgICAgIHdlYiBzZXJ2ZXJzLgogICAgIiIiCgogICAgaWYgbm90IGlzaW5zdGFuY2UoYml0X3NpemUsIGludF90eXBlcyk6CiAgICAgICAgcmFpc2UgVHlwZUVycm9yKHByZXR0eV9tZXNzYWdlKAogICAgICAgICAgICAnJycKICAgICAgICAgICAgYml0X3NpemUgbXVzdCBiZSBhbiBpbnRlZ2VyLCBub3QgJXMKICAgICAgICAgICAgJycnLAogICAgICAgICAgICB0eXBlX25hbWUoYml0X3NpemUpCiAgICAgICAgKSkKCiAgICBpZiBiaXRfc2l6ZSA8IDUxMjoKICAgICAgICByYWlzZSBWYWx1ZUVycm9yKCdiaXRfc2l6ZSBtdXN0IGJlIGdyZWF0ZXIgdGhhbiBvciBlcXVhbCB0byA1MTInKQoKICAgIGlmIGJpdF9zaXplID4gNDA5NjoKICAgICAgICByYWlzZSBWYWx1ZUVycm9yKCdiaXRfc2l6ZSBtdXN0IGJlIGxlc3MgdGhhbiBvciBlcXVhbCB0byA0MDk2JykKCiAgICBpZiBiaXRfc2l6ZSAlIDY0ICE9IDA6CiAgICAgICAgcmFpc2UgVmFsdWVFcnJvcignYml0X3NpemUgbXVzdCBiZSBhIG11bHRpcGxlIG9mIDY0JykKCiAgICBkaCA9IE5vbmUKCiAgICB0cnk6CiAgICAgICAgZGggPSBsaWJjcnlwdG8uREhfbmV3KCkKICAgICAgICBpZiBpc19udWxsKGRoKToKICAgICAgICAgICAgaGFuZGxlX29wZW5zc2xfZXJyb3IoMCkKCiAgICAgICAgcmVzdWx0ID0gbGliY3J5cHRvLkRIX2dlbmVyYXRlX3BhcmFtZXRlcnNfZXgoZGgsIGJpdF9zaXplLCBMaWJjcnlwdG9Db25zdC5ESF9HRU5FUkFUT1JfMiwgbnVsbCgpKQogICAgICAgIGhhbmRsZV9vcGVuc3NsX2Vycm9yKHJlc3VsdCkKCiAgICAgICAgYnVmZmVyX2xlbmd0aCA9IGxpYmNyeXB0by5pMmRfREhwYXJhbXMoZGgsIG51bGwoKSkKICAgICAgICBpZiBidWZmZXJfbGVuZ3RoIDwgMDoKICAgICAgICAgICAgaGFuZGxlX29wZW5zc2xfZXJyb3IoYnVmZmVyX2xlbmd0aCkKICAgICAgICBidWZmZXIgPSBidWZmZXJfZnJvbV9ieXRlcyhidWZmZXJfbGVuZ3RoKQogICAgICAgIHJlc3VsdCA9IGxpYmNyeXB0by5pMmRfREhwYXJhbXMoZGgsIGJ1ZmZlcl9wb2ludGVyKGJ1ZmZlcikpCiAgICAgICAgaWYgcmVzdWx0IDwgMDoKICAgICAgICAgICAgaGFuZGxlX29wZW5zc2xfZXJyb3IocmVzdWx0KQogICAgICAgIGRoX3BhcmFtc19ieXRlcyA9IGJ5dGVzX2Zyb21fYnVmZmVyKGJ1ZmZlciwgYnVmZmVyX2xlbmd0aCkKCiAgICAgICAgcmV0dXJuIERIUGFyYW1ldGVycy5sb2FkKGRoX3BhcmFtc19ieXRlcykKCiAgICBmaW5hbGx5OgogICAgICAgIGlmIGRoOgogICAgICAgICAgICBsaWJjcnlwdG8uREhfZnJlZShkaCkKCgpkZWYgbG9hZF9jZXJ0aWZpY2F0ZShzb3VyY2UpOgogICAgIiIiCiAgICBMb2FkcyBhbiB4NTA5IGNlcnRpZmljYXRlIGludG8gYSBDZXJ0aWZpY2F0ZSBvYmplY3QKCiAgICA6cGFyYW0gc291cmNlOgogICAgICAgIEEgYnl0ZSBzdHJpbmcgb2YgZmlsZSBjb250ZW50cywgYSB1bmljb2RlIHN0cmluZyBmaWxlbmFtZSBvciBhbgogICAgICAgIGFzbjFjcnlwdG8ueDUwOS5DZXJ0aWZpY2F0ZSBvYmplY3QKCiAgICA6cmFpc2VzOgogICAgICAgIFZhbHVlRXJyb3IgLSB3aGVuIGFueSBvZiB0aGUgcGFyYW1ldGVycyBjb250YWluIGFuIGludmFsaWQgdmFsdWUKICAgICAgICBUeXBlRXJyb3IgLSB3aGVuIGFueSBvZiB0aGUgcGFyYW1ldGVycyBhcmUgb2YgdGhlIHdyb25nIHR5cGUKICAgICAgICBPU0Vycm9yIC0gd2hlbiBhbiBlcnJvciBpcyByZXR1cm5lZCBieSB0aGUgT1MgY3J5cHRvIGxpYnJhcnkKCiAgICA6cmV0dXJuOgogICAgICAgIEEgQ2VydGlmaWNhdGUgb2JqZWN0CiAgICAiIiIKCiAgICBpZiBpc2luc3RhbmNlKHNvdXJjZSwgQXNuMUNlcnRpZmljYXRlKToKICAgICAgICBjZXJ0aWZpY2F0ZSA9IHNvdXJjZQoKICAgIGVsaWYgaXNpbnN0YW5jZShzb3VyY2UsIGJ5dGVfY2xzKToKICAgICAgICBjZXJ0aWZpY2F0ZSA9IHBhcnNlX2NlcnRpZmljYXRlKHNvdXJjZSkKCiAgICBlbGlmIGlzaW5zdGFuY2Uoc291cmNlLCBzdHJfY2xzKToKICAgICAgICB3aXRoIG9wZW4oc291cmNlLCAncmInKSBhcyBmOgogICAgICAgICAgICBjZXJ0aWZpY2F0ZSA9IHBhcnNlX2NlcnRpZmljYXRlKGYucmVhZCgpKQoKICAgIGVsc2U6CiAgICAgICAgcmFpc2UgVHlwZUVycm9yKHByZXR0eV9tZXNzYWdlKAogICAgICAgICAgICAnJycKICAgICAgICAgICAgc291cmNlIG11c3QgYmUgYSBieXRlIHN0cmluZywgdW5pY29kZSBzdHJpbmcgb3IKICAgICAgICAgICAgYXNuMWNyeXB0by54NTA5LkNlcnRpZmljYXRlIG9iamVjdCwgbm90ICVzCiAgICAgICAgICAgICcnJywKICAgICAgICAgICAgdHlwZV9uYW1lKHNvdXJjZSkKICAgICAgICApKQoKICAgIHJldHVybiBfbG9hZF94NTA5KGNlcnRpZmljYXRlKQoKCmRlZiBfbG9hZF94NTA5KGNlcnRpZmljYXRlKToKICAgICIiIgogICAgTG9hZHMgYW4gQVNOLjEgb2JqZWN0IG9mIGFuIHg1MDkgY2VydGlmaWNhdGUgaW50byBhIENlcnRpZmljYXRlIG9iamVjdAoKICAgIDpwYXJhbSBjZXJ0aWZpY2F0ZToKICAgICAgICBBbiBhc24xY3J5cHRvLng1MDkuQ2VydGlmaWNhdGUgb2JqZWN0CgogICAgOnJldHVybjoKICAgICAgICBBIENlcnRpZmljYXRlIG9iamVjdAogICAgIiIiCgogICAgc291cmNlID0gY2VydGlmaWNhdGUuZHVtcCgpCgogICAgYnVmZmVyID0gYnVmZmVyX2Zyb21fYnl0ZXMoc291cmNlKQogICAgZXZwX3BrZXkgPSBsaWJjcnlwdG8uZDJpX1g1MDkobnVsbCgpLCBidWZmZXJfcG9pbnRlcihidWZmZXIpLCBsZW4oc291cmNlKSkKICAgIGlmIGlzX251bGwoZXZwX3BrZXkpOgogICAgICAgIGhhbmRsZV9vcGVuc3NsX2Vycm9yKDApCiAgICByZXR1cm4gQ2VydGlmaWNhdGUoZXZwX3BrZXksIGNlcnRpZmljYXRlKQoKCmRlZiBsb2FkX3ByaXZhdGVfa2V5KHNvdXJjZSwgcGFzc3dvcmQ9Tm9uZSk6CiAgICAiIiIKICAgIExvYWRzIGEgcHJpdmF0ZSBrZXkgaW50byBhIFByaXZhdGVLZXkgb2JqZWN0CgogICAgOnBhcmFtIHNvdXJjZToKICAgICAgICBBIGJ5dGUgc3RyaW5nIG9mIGZpbGUgY29udGVudHMsIGEgdW5pY29kZSBzdHJpbmcgZmlsZW5hbWUgb3IgYW4KICAgICAgICBhc24xY3J5cHRvLmtleXMuUHJpdmF0ZUtleUluZm8gb2JqZWN0CgogICAgOnBhcmFtIHBhc3N3b3JkOgogICAgICAgIEEgYnl0ZSBvciB1bmljb2RlIHN0cmluZyB0byBkZWNyeXB0IHRoZSBwcml2YXRlIGtleSBmaWxlLiBVbmljb2RlCiAgICAgICAgc3RyaW5ncyB3aWxsIGJlIGVuY29kZWQgdXNpbmcgVVRGLTguIE5vdCB1c2VkIGlzIHRoZSBzb3VyY2UgaXMgYQogICAgICAgIFByaXZhdGVLZXlJbmZvIG9iamVjdC4KCiAgICA6cmFpc2VzOgogICAgICAgIFZhbHVlRXJyb3IgLSB3aGVuIGFueSBvZiB0aGUgcGFyYW1ldGVycyBjb250YWluIGFuIGludmFsaWQgdmFsdWUKICAgICAgICBUeXBlRXJyb3IgLSB3aGVuIGFueSBvZiB0aGUgcGFyYW1ldGVycyBhcmUgb2YgdGhlIHdyb25nIHR5cGUKICAgICAgICBvc2NyeXB0by5lcnJvcnMuQXN5bW1ldHJpY0tleUVycm9yIC0gd2hlbiB0aGUgcHJpdmF0ZSBrZXkgaXMgaW5jb21wYXRpYmxlIHdpdGggdGhlIE9TIGNyeXB0byBsaWJyYXJ5CiAgICAgICAgT1NFcnJvciAtIHdoZW4gYW4gZXJyb3IgaXMgcmV0dXJuZWQgYnkgdGhlIE9TIGNyeXB0byBsaWJyYXJ5CgogICAgOnJldHVybjoKICAgICAgICBBIFByaXZhdGVLZXkgb2JqZWN0CiAgICAiIiIKCiAgICBpZiBpc2luc3RhbmNlKHNvdXJjZSwgUHJpdmF0ZUtleUluZm8pOgogICAgICAgIHByaXZhdGVfb2JqZWN0ID0gc291cmNlCgogICAgZWxzZToKICAgICAgICBpZiBwYXNzd29yZCBpcyBub3QgTm9uZToKICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShwYXNzd29yZCwgc3RyX2Nscyk6CiAgICAgICAgICAgICAgICBwYXNzd29yZCA9IHBhc3N3b3JkLmVuY29kZSgndXRmLTgnKQogICAgICAgICAgICBpZiBub3QgaXNpbnN0YW5jZShwYXNzd29yZCwgYnl0ZV9jbHMpOgogICAgICAgICAgICAgICAgcmFpc2UgVHlwZUVycm9yKHByZXR0eV9tZXNzYWdlKAogICAgICAgICAgICAgICAgICAgICcnJwogICAgICAgICAgICAgICAgICAgIHBhc3N3b3JkIG11c3QgYmUgYSBieXRlIHN0cmluZywgbm90ICVzCiAgICAgICAgICAgICAgICAgICAgJycnLAogICAgICAgICAgICAgICAgICAgIHR5cGVfbmFtZShwYXNzd29yZCkKICAgICAgICAgICAgICAgICkpCgogICAgICAgIGlmIGlzaW5zdGFuY2Uoc291cmNlLCBzdHJfY2xzKToKICAgICAgICAgICAgd2l0aCBvcGVuKHNvdXJjZSwgJ3JiJykgYXMgZjoKICAgICAgICAgICAgICAgIHNvdXJjZSA9IGYucmVhZCgpCgogICAgICAgIGVsaWYgbm90IGlzaW5zdGFuY2Uoc291cmNlLCBieXRlX2Nscyk6CiAgICAgICAgICAgIHJhaXNlIFR5cGVFcnJvcihwcmV0dHlfbWVzc2FnZSgKICAgICAgICAgICAgICAgICcnJwogICAgICAgICAgICAgICAgc291cmNlIG11c3QgYmUgYSBieXRlIHN0cmluZywgdW5pY29kZSBzdHJpbmcgb3IKICAgICAgICAgICAgICAgIGFzbjFjcnlwdG8ua2V5cy5Qcml2YXRlS2V5SW5mbyBvYmplY3QsIG5vdCAlcwogICAgICAgICAgICAgICAgJycnLAogICAgICAgICAgICAgICAgdHlwZV9uYW1lKHNvdXJjZSkKICAgICAgICAgICAgKSkKCiAgICAgICAgcHJpdmF0ZV9vYmplY3QgPSBwYXJzZV9wcml2YXRlKHNvdXJjZSwgcGFzc3dvcmQpCgogICAgcmV0dXJuIF9sb2FkX2tleShwcml2YXRlX29iamVjdCkKCgpkZWYgbG9hZF9wdWJsaWNfa2V5KHNvdXJjZSk6CiAgICAiIiIKICAgIExvYWRzIGEgcHVibGljIGtleSBpbnRvIGEgUHVibGljS2V5IG9iamVjdAoKICAgIDpwYXJhbSBzb3VyY2U6CiAgICAgICAgQSBieXRlIHN0cmluZyBvZiBmaWxlIGNvbnRlbnRzLCBhIHVuaWNvZGUgc3RyaW5nIGZpbGVuYW1lIG9yIGFuCiAgICAgICAgYXNuMWNyeXB0by5rZXlzLlB1YmxpY0tleUluZm8gb2JqZWN0CgogICAgOnJhaXNlczoKICAgICAgICBWYWx1ZUVycm9yIC0gd2hlbiBhbnkgb2YgdGhlIHBhcmFtZXRlcnMgY29udGFpbiBhbiBpbnZhbGlkIHZhbHVlCiAgICAgICAgVHlwZUVycm9yIC0gd2hlbiBhbnkgb2YgdGhlIHBhcmFtZXRlcnMgYXJlIG9mIHRoZSB3cm9uZyB0eXBlCiAgICAgICAgb3NjcnlwdG8uZXJyb3JzLkFzeW1tZXRyaWNLZXlFcnJvciAtIHdoZW4gdGhlIHB1YmxpYyBrZXkgaXMgaW5jb21wYXRpYmxlIHdpdGggdGhlIE9TIGNyeXB0byBsaWJyYXJ5CiAgICAgICAgT1NFcnJvciAtIHdoZW4gYW4gZXJyb3IgaXMgcmV0dXJuZWQgYnkgdGhlIE9TIGNyeXB0byBsaWJyYXJ5CgogICAgOnJldHVybjoKICAgICAgICBBIFB1YmxpY0tleSBvYmplY3QKICAgICIiIgoKICAgIGlmIGlzaW5zdGFuY2Uoc291cmNlLCBQdWJsaWNLZXlJbmZvKToKICAgICAgICBwdWJsaWNfa2V5ID0gc291cmNlCgogICAgZWxpZiBpc2luc3RhbmNlKHNvdXJjZSwgYnl0ZV9jbHMpOgogICAgICAgIHB1YmxpY19rZXkgPSBwYXJzZV9wdWJsaWMoc291cmNlKQoKICAgIGVsaWYgaXNpbnN0YW5jZShzb3VyY2UsIHN0cl9jbHMpOgogICAgICAgIHdpdGggb3Blbihzb3VyY2UsICdyYicpIGFzIGY6CiAgICAgICAgICAgIHB1YmxpY19rZXkgPSBwYXJzZV9wdWJsaWMoZi5yZWFkKCkpCgogICAgZWxzZToKICAgICAgICByYWlzZSBUeXBlRXJyb3IocHJldHR5X21lc3NhZ2UoCiAgICAgICAgICAgICcnJwogICAgICAgICAgICBzb3VyY2UgbXVzdCBiZSBhIGJ5dGUgc3RyaW5nLCB1bmljb2RlIHN0cmluZyBvcgogICAgICAgICAgICBhc24xY3J5cHRvLmtleXMuUHVibGljS2V5SW5mbyBvYmplY3QsIG5vdCAlcwogICAgICAgICAgICAnJycsCiAgICAgICAgICAgIHR5cGVfbmFtZShzb3VyY2UpCiAgICAgICAgKSkKCiAgICBpZiBwdWJsaWNfa2V5LmFsZ29yaXRobSA9PSAnZHNhJzoKICAgICAgICBpZiBsaWJjcnlwdG9fdmVyc2lvbl9pbmZvIDwgKDEsKSBhbmQgcHVibGljX2tleS5oYXNoX2FsZ28gPT0gJ3NoYTInOgogICAgICAgICAgICByYWlzZSBBc3ltbWV0cmljS2V5RXJyb3IocHJldHR5X21lc3NhZ2UoCiAgICAgICAgICAgICAgICAnJycKICAgICAgICAgICAgICAgIE9wZW5TU0wgMC45Ljggb25seSBzdXBwb3J0cyBEU0Ega2V5cyBiYXNlZCBvbiBTSEExICgyMDQ4IGJpdHMgb3IKICAgICAgICAgICAgICAgIGxlc3MpIC0gdGhpcyBrZXkgaXMgYmFzZWQgb24gU0hBMiBhbmQgaXMgJXMgYml0cwogICAgICAgICAgICAgICAgJycnLAogICAgICAgICAgICAgICAgcHVibGljX2tleS5iaXRfc2l6ZQogICAgICAgICAgICApKQogICAgICAgIGVsaWYgcHVibGljX2tleS5oYXNoX2FsZ28gaXMgTm9uZToKICAgICAgICAgICAgcmFpc2UgSW5jb21wbGV0ZUFzeW1tZXRyaWNLZXlFcnJvcihwcmV0dHlfbWVzc2FnZSgKICAgICAgICAgICAgICAgICcnJwogICAgICAgICAgICAgICAgVGhlIERTQSBrZXkgZG9lcyBub3QgY29udGFpbiB0aGUgbmVjZXNzYXJ5IHAsIHEgYW5kIGcKICAgICAgICAgICAgICAgIHBhcmFtZXRlcnMgYW5kIGNhbiBub3QgYmUgdXNlZAogICAgICAgICAgICAgICAgJycnCiAgICAgICAgICAgICkpCgogICAgIyBPcGVuU1NMIDEueCBzdWZmZXJzIGZyb20gaXNzdWVzIHRyeWluZyB0byB1c2UgUlNBU1NBLVBTUyBrZXlzLCBzbyB3ZQogICAgIyBtYXNxdWVyYWRlIGl0IGFzIGEgbm9ybWFsIFJTQSBrZXkgc28gdGhlIE9JRCBjaGVja3Mgd29yawogICAgaWYgbGliY3J5cHRvX3ZlcnNpb25faW5mbyA8ICgzLCkgYW5kIHB1YmxpY19rZXkuYWxnb3JpdGhtID09ICdyc2Fzc2FfcHNzJzoKICAgICAgICB0ZW1wX2tleSA9IHB1YmxpY19rZXkuY29weSgpCiAgICAgICAgdGVtcF9rZXlbJ2FsZ29yaXRobSddWydhbGdvcml0aG0nXSA9ICdyc2EnCiAgICAgICAgZGF0YSA9IHRlbXBfa2V5LmR1bXAoKQogICAgZWxzZToKICAgICAgICBkYXRhID0gcHVibGljX2tleS5kdW1wKCkKCiAgICBidWZmZXIgPSBidWZmZXJfZnJvbV9ieXRlcyhkYXRhKQogICAgZXZwX3BrZXkgPSBsaWJjcnlwdG8uZDJpX1BVQktFWShudWxsKCksIGJ1ZmZlcl9wb2ludGVyKGJ1ZmZlciksIGxlbihkYXRhKSkKICAgIGlmIGlzX251bGwoZXZwX3BrZXkpOgogICAgICAgIGhhbmRsZV9vcGVuc3NsX2Vycm9yKDApCiAgICByZXR1cm4gUHVibGljS2V5KGV2cF9wa2V5LCBwdWJsaWNfa2V5KQoKCmRlZiBfbG9hZF9rZXkocHJpdmF0ZV9vYmplY3QpOgogICAgIiIiCiAgICBMb2FkcyBhIHByaXZhdGUga2V5IGludG8gYSBQcml2YXRlS2V5IG9iamVjdAoKICAgIDpwYXJhbSBwcml2YXRlX29iamVjdDoKICAgICAgICBBbiBhc24xY3J5cHRvLmtleXMuUHJpdmF0ZUtleUluZm8gb2JqZWN0CgogICAgOnJldHVybjoKICAgICAgICBBIFByaXZhdGVLZXkgb2JqZWN0CiAgICAiIiIKCiAgICBpZiBsaWJjcnlwdG9fdmVyc2lvbl9pbmZvIDwgKDEsKSBhbmQgcHJpdmF0ZV9vYmplY3QuYWxnb3JpdGhtID09ICdkc2EnIGFuZCBwcml2YXRlX29iamVjdC5oYXNoX2FsZ28gPT0gJ3NoYTInOgogICAgICAgIHJhaXNlIEFzeW1tZXRyaWNLZXlFcnJvcihwcmV0dHlfbWVzc2FnZSgKICAgICAgICAgICAgJycnCiAgICAgICAgICAgIE9wZW5TU0wgMC45Ljggb25seSBzdXBwb3J0cyBEU0Ega2V5cyBiYXNlZCBvbiBTSEExICgyMDQ4IGJpdHMgb3IKICAgICAgICAgICAgbGVzcykgLSB0aGlzIGtleSBpcyBiYXNlZCBvbiBTSEEyIGFuZCBpcyAlcyBiaXRzCiAgICAgICAgICAgICcnJywKICAgICAgICAgICAgcHJpdmF0ZV9vYmplY3QuYml0X3NpemUKICAgICAgICApKQoKICAgIHNvdXJjZSA9IF91bndyYXBfcHJpdmF0ZV9rZXlfaW5mbyhwcml2YXRlX29iamVjdCkuZHVtcCgpCgogICAgYnVmZmVyID0gYnVmZmVyX2Zyb21fYnl0ZXMoc291cmNlKQogICAgZXZwX3BrZXkgPSBsaWJjcnlwdG8uZDJpX0F1dG9Qcml2YXRlS2V5KG51bGwoKSwgYnVmZmVyX3BvaW50ZXIoYnVmZmVyKSwgbGVuKHNvdXJjZSkpCiAgICBpZiBpc19udWxsKGV2cF9wa2V5KToKICAgICAgICBoYW5kbGVfb3BlbnNzbF9lcnJvcigwKQogICAgcmV0dXJuIFByaXZhdGVLZXkoZXZwX3BrZXksIHByaXZhdGVfb2JqZWN0KQoKCmRlZiBwYXJzZV9wa2NzMTIoZGF0YSwgcGFzc3dvcmQ9Tm9uZSk6CiAgICAiIiIKICAgIFBhcnNlcyBhIFBLQ1MjMTIgQU5TLjEgREVSLWVuY29kZWQgc3RydWN0dXJlIGFuZCBleHRyYWN0cyBjZXJ0cyBhbmQga2V5cwoKICAgIDpwYXJhbSBkYXRhOgogICAgICAgIEEgYnl0ZSBzdHJpbmcgb2YgYSBERVItZW5jb2RlZCBQS0NTIzEyIGZpbGUKCiAgICA6cGFyYW0gcGFzc3dvcmQ6CiAgICAgICAgQSBieXRlIHN0cmluZyBvZiB0aGUgcGFzc3dvcmQgdG8gYW55IGVuY3J5cHRlZCBkYXRhCgogICAgOnJhaXNlczoKICAgICAgICBWYWx1ZUVycm9yIC0gd2hlbiBhbnkgb2YgdGhlIHBhcmFtZXRlcnMgYXJlIG9mIHRoZSB3cm9uZyB0eXBlIG9yIHZhbHVlCiAgICAgICAgT1NFcnJvciAtIHdoZW4gYW4gZXJyb3IgaXMgcmV0dXJuZWQgYnkgb25lIG9mIHRoZSBPUyBkZWNyeXB0aW9uIGZ1bmN0aW9ucwoKICAgIDpyZXR1cm46CiAgICAgICAgQSB0aHJlZS1lbGVtZW50IHR1cGxlIG9mOgogICAgICAgICAxLiBBbiBhc24xY3J5cHRvLmtleXMuUHJpdmF0ZUtleUluZm8gb2JqZWN0CiAgICAgICAgIDIuIEFuIGFzbjFjcnlwdG8ueDUwOS5DZXJ0aWZpY2F0ZSBvYmplY3QKICAgICAgICAgMy4gQSBsaXN0IG9mIHplcm8gb3IgbW9yZSBhc24xY3J5cHRvLng1MDkuQ2VydGlmaWNhdGUgb2JqZWN0cyB0aGF0IGFyZQogICAgICAgICAgICAiZXh0cmEiIGNlcnRpZmljYXRlcywgcG9zc2libHkgaW50ZXJtZWRpYXRlcyBmcm9tIHRoZSBjZXJ0IGNoYWluCiAgICAiIiIKCiAgICByZXR1cm4gX3BhcnNlX3BrY3MxMihkYXRhLCBwYXNzd29yZCwgbG9hZF9wcml2YXRlX2tleSkKCgpkZWYgbG9hZF9wa2NzMTIoc291cmNlLCBwYXNzd29yZD1Ob25lKToKICAgICIiIgogICAgTG9hZHMgYSAucDEyIG9yIC5wZnggZmlsZSBpbnRvIGEgUHJpdmF0ZUtleSBvYmplY3QgYW5kIG9uZSBvciBtb3JlCiAgICBDZXJ0aWZpY2F0ZXMgb2JqZWN0cwoKICAgIDpwYXJhbSBzb3VyY2U6CiAgICAgICAgQSBieXRlIHN0cmluZyBvZiBmaWxlIGNvbnRlbnRzIG9yIGEgdW5pY29kZSBzdHJpbmcgZmlsZW5hbWUKCiAgICA6cGFyYW0gcGFzc3dvcmQ6CiAgICAgICAgQSBieXRlIG9yIHVuaWNvZGUgc3RyaW5nIHRvIGRlY3J5cHQgdGhlIFBLQ1MxMiBmaWxlLiBVbmljb2RlIHN0cmluZ3MKICAgICAgICB3aWxsIGJlIGVuY29kZWQgdXNpbmcgVVRGLTguCgogICAgOnJhaXNlczoKICAgICAgICBWYWx1ZUVycm9yIC0gd2hlbiBhbnkgb2YgdGhlIHBhcmFtZXRlcnMgY29udGFpbiBhbiBpbnZhbGlkIHZhbHVlCiAgICAgICAgVHlwZUVycm9yIC0gd2hlbiBhbnkgb2YgdGhlIHBhcmFtZXRlcnMgYXJlIG9mIHRoZSB3cm9uZyB0eXBlCiAgICAgICAgb3NjcnlwdG8uZXJyb3JzLkFzeW1tZXRyaWNLZXlFcnJvciAtIHdoZW4gYSBjb250YWluZWQga2V5IGlzIGluY29tcGF0aWJsZSB3aXRoIHRoZSBPUyBjcnlwdG8gbGlicmFyeQogICAgICAgIE9TRXJyb3IgLSB3aGVuIGFuIGVycm9yIGlzIHJldHVybmVkIGJ5IHRoZSBPUyBjcnlwdG8gbGlicmFyeQoKICAgIDpyZXR1cm46CiAgICAgICAgQSB0aHJlZS1lbGVtZW50IHR1cGxlIGNvbnRhaW5pbmcgKFByaXZhdGVLZXksIENlcnRpZmljYXRlLCBbQ2VydGlmaWNhdGUsIC4uLl0pCiAgICAiIiIKCiAgICBpZiBwYXNzd29yZCBpcyBub3QgTm9uZToKICAgICAgICBpZiBpc2luc3RhbmNlKHBhc3N3b3JkLCBzdHJfY2xzKToKICAgICAgICAgICAgcGFzc3dvcmQgPSBwYXNzd29yZC5lbmNvZGUoJ3V0Zi04JykKICAgICAgICBpZiBub3QgaXNpbnN0YW5jZShwYXNzd29yZCwgYnl0ZV9jbHMpOgogICAgICAgICAgICByYWlzZSBUeXBlRXJyb3IocHJldHR5X21lc3NhZ2UoCiAgICAgICAgICAgICAgICAnJycKICAgICAgICAgICAgICAgIHBhc3N3b3JkIG11c3QgYmUgYSBieXRlIHN0cmluZywgbm90ICVzCiAgICAgICAgICAgICAgICAnJycsCiAgICAgICAgICAgICAgICB0eXBlX25hbWUocGFzc3dvcmQpCiAgICAgICAgICAgICkpCgogICAgaWYgaXNpbnN0YW5jZShzb3VyY2UsIHN0cl9jbHMpOgogICAgICAgIHdpdGggb3Blbihzb3VyY2UsICdyYicpIGFzIGY6CiAgICAgICAgICAgIHNvdXJjZSA9IGYucmVhZCgpCgogICAgZWxpZiBub3QgaXNpbnN0YW5jZShzb3VyY2UsIGJ5dGVfY2xzKToKICAgICAgICByYWlzZSBUeXBlRXJyb3IocHJldHR5X21lc3NhZ2UoCiAgICAgICAgICAgICcnJwogICAgICAgICAgICBzb3VyY2UgbXVzdCBiZSBhIGJ5dGUgc3RyaW5nIG9yIGEgdW5pY29kZSBzdHJpbmcsIG5vdCAlcwogICAgICAgICAgICAnJycsCiAgICAgICAgICAgIHR5cGVfbmFtZShzb3VyY2UpCiAgICAgICAgKSkKCiAgICBrZXlfaW5mbywgY2VydF9pbmZvLCBleHRyYV9jZXJ0c19pbmZvID0gcGFyc2VfcGtjczEyKHNvdXJjZSwgcGFzc3dvcmQpCgogICAga2V5ID0gTm9uZQogICAgY2VydCA9IE5vbmUKCiAgICBpZiBrZXlfaW5mbzoKICAgICAgICBrZXkgPSBfbG9hZF9rZXkoa2V5X2luZm8pCgogICAgaWYgY2VydF9pbmZvOgogICAgICAgIGNlcnQgPSBfbG9hZF94NTA5KGNlcnRfaW5mbykKCiAgICBleHRyYV9jZXJ0cyA9IFtfbG9hZF94NTA5KGluZm8pIGZvciBpbmZvIGluIGV4dHJhX2NlcnRzX2luZm9dCgogICAgcmV0dXJuIChrZXksIGNlcnQsIGV4dHJhX2NlcnRzKQoKCmRlZiByc2FfcGtjczF2MTVfZW5jcnlwdChjZXJ0aWZpY2F0ZV9vcl9wdWJsaWNfa2V5LCBkYXRhKToKICAgICIiIgogICAgRW5jcnlwdHMgYSBieXRlIHN0cmluZyB1c2luZyBhbiBSU0EgcHVibGljIGtleSBvciBjZXJ0aWZpY2F0ZS4gVXNlcyBQS0NTIzEKICAgIHYxLjUgcGFkZGluZy4KCiAgICA6cGFyYW0gY2VydGlmaWNhdGVfb3JfcHVibGljX2tleToKICAgICAgICBBIFB1YmxpY0tleSBvciBDZXJ0aWZpY2F0ZSBvYmplY3QKCiAgICA6cGFyYW0gZGF0YToKICAgICAgICBBIGJ5dGUgc3RyaW5nLCB3aXRoIGEgbWF4aW11bSBsZW5ndGggMTEgYnl0ZXMgbGVzcyB0aGFuIHRoZSBrZXkgbGVuZ3RoCiAgICAgICAgKGluIGJ5dGVzKQoKICAgIDpyYWlzZXM6CiAgICAgICAgVmFsdWVFcnJvciAtIHdoZW4gYW55IG9mIHRoZSBwYXJhbWV0ZXJzIGNvbnRhaW4gYW4gaW52YWxpZCB2YWx1ZQogICAgICAgIFR5cGVFcnJvciAtIHdoZW4gYW55IG9mIHRoZSBwYXJhbWV0ZXJzIGFyZSBvZiB0aGUgd3JvbmcgdHlwZQogICAgICAgIE9TRXJyb3IgLSB3aGVuIGFuIGVycm9yIGlzIHJldHVybmVkIGJ5IHRoZSBPUyBjcnlwdG8gbGlicmFyeQoKICAgIDpyZXR1cm46CiAgICAgICAgQSBieXRlIHN0cmluZyBvZiB0aGUgZW5jcnlwdGVkIGRhdGEKICAgICIiIgoKICAgIHJldHVybiBfZW5jcnlwdChjZXJ0aWZpY2F0ZV9vcl9wdWJsaWNfa2V5LCBkYXRhLCBMaWJjcnlwdG9Db25zdC5SU0FfUEtDUzFfUEFERElORykKCgpkZWYgcnNhX3BrY3MxdjE1X2RlY3J5cHQocHJpdmF0ZV9rZXksIGNpcGhlcnRleHQpOgogICAgIiIiCiAgICBEZWNyeXB0cyBhIGJ5dGUgc3RyaW5nIHVzaW5nIGFuIFJTQSBwcml2YXRlIGtleS4gVXNlcyBQS0NTIzEgdjEuNSBwYWRkaW5nLgoKICAgIDpwYXJhbSBwcml2YXRlX2tleToKICAgICAgICBBIFByaXZhdGVLZXkgb2JqZWN0CgogICAgOnBhcmFtIGNpcGhlcnRleHQ6CiAgICAgICAgQSBieXRlIHN0cmluZyBvZiB0aGUgZW5jcnlwdGVkIGRhdGEKCiAgICA6cmFpc2VzOgogICAgICAgIFZhbHVlRXJyb3IgLSB3aGVuIGFueSBvZiB0aGUgcGFyYW1ldGVycyBjb250YWluIGFuIGludmFsaWQgdmFsdWUKICAgICAgICBUeXBlRXJyb3IgLSB3aGVuIGFueSBvZiB0aGUgcGFyYW1ldGVycyBhcmUgb2YgdGhlIHdyb25nIHR5cGUKICAgICAgICBPU0Vycm9yIC0gd2hlbiBhbiBlcnJvciBpcyByZXR1cm5lZCBieSB0aGUgT1MgY3J5cHRvIGxpYnJhcnkKCiAgICA6cmV0dXJuOgogICAgICAgIEEgYnl0ZSBzdHJpbmcgb2YgdGhlIG9yaWdpbmFsIHBsYWludGV4dAogICAgIiIiCgogICAgcmV0dXJuIF9kZWNyeXB0KHByaXZhdGVfa2V5LCBjaXBoZXJ0ZXh0LCBMaWJjcnlwdG9Db25zdC5SU0FfUEtDUzFfUEFERElORykKCgpkZWYgcnNhX29hZXBfZW5jcnlwdChjZXJ0aWZpY2F0ZV9vcl9wdWJsaWNfa2V5LCBkYXRhKToKICAgICIiIgogICAgRW5jcnlwdHMgYSBieXRlIHN0cmluZyB1c2luZyBhbiBSU0EgcHVibGljIGtleSBvciBjZXJ0aWZpY2F0ZS4gVXNlcyBQS0NTIzEKICAgIE9BRVAgcGFkZGluZyB3aXRoIFNIQTEuCgogICAgOnBhcmFtIGNlcnRpZmljYXRlX29yX3B1YmxpY19rZXk6CiAgICAgICAgQSBQdWJsaWNLZXkgb3IgQ2VydGlmaWNhdGUgb2JqZWN0CgogICAgOnBhcmFtIGRhdGE6CiAgICAgICAgQSBieXRlIHN0cmluZywgd2l0aCBhIG1heGltdW0gbGVuZ3RoIDQxIGJ5dGVzIChvciBtb3JlKSBsZXNzIHRoYW4gdGhlCiAgICAgICAga2V5IGxlbmd0aCAoaW4gYnl0ZXMpCgogICAgOnJhaXNlczoKICAgICAgICBWYWx1ZUVycm9yIC0gd2hlbiBhbnkgb2YgdGhlIHBhcmFtZXRlcnMgY29udGFpbiBhbiBpbnZhbGlkIHZhbHVlCiAgICAgICAgVHlwZUVycm9yIC0gd2hlbiBhbnkgb2YgdGhlIHBhcmFtZXRlcnMgYXJlIG9mIHRoZSB3cm9uZyB0eXBlCiAgICAgICAgT1NFcnJvciAtIHdoZW4gYW4gZXJyb3IgaXMgcmV0dXJuZWQgYnkgdGhlIE9TIGNyeXB0byBsaWJyYXJ5CgogICAgOnJldHVybjoKICAgICAgICBBIGJ5dGUgc3RyaW5nIG9mIHRoZSBlbmNyeXB0ZWQgZGF0YQogICAgIiIiCgogICAgcmV0dXJuIF9lbmNyeXB0KGNlcnRpZmljYXRlX29yX3B1YmxpY19rZXksIGRhdGEsIExpYmNyeXB0b0NvbnN0LlJTQV9QS0NTMV9PQUVQX1BBRERJTkcpCgoKZGVmIHJzYV9vYWVwX2RlY3J5cHQocHJpdmF0ZV9rZXksIGNpcGhlcnRleHQpOgogICAgIiIiCiAgICBEZWNyeXB0cyBhIGJ5dGUgc3RyaW5nIHVzaW5nIGFuIFJTQSBwcml2YXRlIGtleS4gVXNlcyBQS0NTIzEgT0FFUCBwYWRkaW5nCiAgICB3aXRoIFNIQTEuCgogICAgOnBhcmFtIHByaXZhdGVfa2V5OgogICAgICAgIEEgUHJpdmF0ZUtleSBvYmplY3QKCiAgICA6cGFyYW0gY2lwaGVydGV4dDoKICAgICAgICBBIGJ5dGUgc3RyaW5nIG9mIHRoZSBlbmNyeXB0ZWQgZGF0YQoKICAgIDpyYWlzZXM6CiAgICAgICAgVmFsdWVFcnJvciAtIHdoZW4gYW55IG9mIHRoZSBwYXJhbWV0ZXJzIGNvbnRhaW4gYW4gaW52YWxpZCB2YWx1ZQogICAgICAgIFR5cGVFcnJvciAtIHdoZW4gYW55IG9mIHRoZSBwYXJhbWV0ZXJzIGFyZSBvZiB0aGUgd3JvbmcgdHlwZQogICAgICAgIE9TRXJyb3IgLSB3aGVuIGFuIGVycm9yIGlzIHJldHVybmVkIGJ5IHRoZSBPUyBjcnlwdG8gbGlicmFyeQoKICAgIDpyZXR1cm46CiAgICAgICAgQSBieXRlIHN0cmluZyBvZiB0aGUgb3JpZ2luYWwgcGxhaW50ZXh0CiAgICAiIiIKCiAgICByZXR1cm4gX2RlY3J5cHQocHJpdmF0ZV9rZXksIGNpcGhlcnRleHQsIExpYmNyeXB0b0NvbnN0LlJTQV9QS0NTMV9PQUVQX1BBRERJTkcpCgoKZGVmIF9ldnBfcGtleV9nZXRfc2l6ZShldnBfcGtleSk6CiAgICAiIiIKICAgIEhhbmRsZXMgdGhlIGZ1bmN0aW9uIG5hbWUgY2hhbmdlIGZyb20gT3BlblNTTCAxLjEgLT4gMy4wCgogICAgOnBhcmFtIGV2cF9wa2V5OgogICAgICAgIFRoZSBFVlBfUEtFWSBvZiB0aGUgQ2VydGlmaWN0ZSBvciBQdWJsaWNLZXkgdG8gZ2V0IHRoZSBzaXplIG9mCgogICAgOnJldHVybjoKICAgICAgICBBbiBpbnQgb2YgdGhlIG51bWJlciBvZiBieXRlcyBuZWNlc3NhcnkgZm9yIHRoZSBrZXkKICAgICIiIgoKICAgIGlmIGxpYmNyeXB0b192ZXJzaW9uX2luZm8gPCAoMywgKToKICAgICAgICByZXR1cm4gbGliY3J5cHRvLkVWUF9QS0VZX3NpemUoZXZwX3BrZXkpCiAgICByZXR1cm4gbGliY3J5cHRvLkVWUF9QS0VZX2dldF9zaXplKGV2cF9wa2V5KQoKCmRlZiBfZW5jcnlwdChjZXJ0aWZpY2F0ZV9vcl9wdWJsaWNfa2V5LCBkYXRhLCBwYWRkaW5nKToKICAgICIiIgogICAgRW5jcnlwdHMgcGxhaW50ZXh0IHVzaW5nIGFuIFJTQSBwdWJsaWMga2V5IG9yIGNlcnRpZmljYXRlCgogICAgOnBhcmFtIGNlcnRpZmljYXRlX29yX3B1YmxpY19rZXk6CiAgICAgICAgQSBQdWJsaWNLZXksIENlcnRpZmljYXRlIG9yIFByaXZhdGVLZXkgb2JqZWN0CgogICAgOnBhcmFtIGRhdGE6CiAgICAgICAgVGhlIGJ5dGUgc3RyaW5nIHRvIGVuY3J5cHQKCiAgICA6cGFyYW0gcGFkZGluZzoKICAgICAgICBUaGUgcGFkZGluZyBtb2RlIHRvIHVzZQoKICAgIDpyYWlzZXM6CiAgICAgICAgVmFsdWVFcnJvciAtIHdoZW4gYW55IG9mIHRoZSBwYXJhbWV0ZXJzIGNvbnRhaW4gYW4gaW52YWxpZCB2YWx1ZQogICAgICAgIFR5cGVFcnJvciAtIHdoZW4gYW55IG9mIHRoZSBwYXJhbWV0ZXJzIGFyZSBvZiB0aGUgd3JvbmcgdHlwZQogICAgICAgIE9TRXJyb3IgLSB3aGVuIGFuIGVycm9yIGlzIHJldHVybmVkIGJ5IHRoZSBPUyBjcnlwdG8gbGlicmFyeQoKICAgIDpyZXR1cm46CiAgICAgICAgQSBieXRlIHN0cmluZyBvZiB0aGUgZW5jcnlwdGVkIGRhdGEKICAgICIiIgoKICAgIGlmIG5vdCBpc2luc3RhbmNlKGNlcnRpZmljYXRlX29yX3B1YmxpY19rZXksIChDZXJ0aWZpY2F0ZSwgUHVibGljS2V5KSk6CiAgICAgICAgcmFpc2UgVHlwZUVycm9yKHByZXR0eV9tZXNzYWdlKAogICAgICAgICAgICAnJycKICAgICAgICAgICAgY2VydGlmaWNhdGVfb3JfcHVibGljX2tleSBtdXN0IGJlIGFuIGluc3RhbmNlIG9mIHRoZSBDZXJ0aWZpY2F0ZSBvcgogICAgICAgICAgICBQdWJsaWNLZXkgY2xhc3MsIG5vdCAlcwogICAgICAgICAgICAnJycsCiAgICAgICAgICAgIHR5cGVfbmFtZShjZXJ0aWZpY2F0ZV9vcl9wdWJsaWNfa2V5KQogICAgICAgICkpCgogICAgaWYgbm90IGlzaW5zdGFuY2UoZGF0YSwgYnl0ZV9jbHMpOgogICAgICAgIHJhaXNlIFR5cGVFcnJvcihwcmV0dHlfbWVzc2FnZSgKICAgICAgICAgICAgJycnCiAgICAgICAgICAgIGRhdGEgbXVzdCBiZSBhIGJ5dGUgc3RyaW5nLCBub3QgJXMKICAgICAgICAgICAgJycnLAogICAgICAgICAgICB0eXBlX25hbWUoZGF0YSkKICAgICAgICApKQoKICAgIHJzYSA9IE5vbmUKCiAgICB0cnk6CiAgICAgICAgYnVmZmVyX3NpemUgPSBfZXZwX3BrZXlfZ2V0X3NpemUoY2VydGlmaWNhdGVfb3JfcHVibGljX2tleS5ldnBfcGtleSkKICAgICAgICBidWZmZXIgPSBidWZmZXJfZnJvbV9ieXRlcyhidWZmZXJfc2l6ZSkKCiAgICAgICAgcnNhID0gbGliY3J5cHRvLkVWUF9QS0VZX2dldDFfUlNBKGNlcnRpZmljYXRlX29yX3B1YmxpY19rZXkuZXZwX3BrZXkpCiAgICAgICAgcmVzID0gbGliY3J5cHRvLlJTQV9wdWJsaWNfZW5jcnlwdChsZW4oZGF0YSksIGRhdGEsIGJ1ZmZlciwgcnNhLCBwYWRkaW5nKQogICAgICAgIGhhbmRsZV9vcGVuc3NsX2Vycm9yKHJlcykKCiAgICAgICAgcmV0dXJuIGJ5dGVzX2Zyb21fYnVmZmVyKGJ1ZmZlciwgcmVzKQoKICAgIGZpbmFsbHk6CiAgICAgICAgaWYgcnNhOgogICAgICAgICAgICBsaWJjcnlwdG8uUlNBX2ZyZWUocnNhKQoKCmRlZiBfZGVjcnlwdChwcml2YXRlX2tleSwgY2lwaGVydGV4dCwgcGFkZGluZyk6CiAgICAiIiIKICAgIERlY3J5cHRzIFJTQSBjaXBoZXJ0ZXh0IHVzaW5nIGEgcHJpdmF0ZSBrZXkKCiAgICA6cGFyYW0gcHJpdmF0ZV9rZXk6CiAgICAgICAgQSBQcml2YXRlS2V5IG9iamVjdAoKICAgIDpwYXJhbSBjaXBoZXJ0ZXh0OgogICAgICAgIFRoZSBjaXBoZXJ0ZXh0IC0gYSBieXRlIHN0cmluZwoKICAgIDpwYXJhbSBwYWRkaW5nOgogICAgICAgIFRoZSBwYWRkaW5nIG1vZGUgdG8gdXNlCgogICAgOnJhaXNlczoKICAgICAgICBWYWx1ZUVycm9yIC0gd2hlbiBhbnkgb2YgdGhlIHBhcmFtZXRlcnMgY29udGFpbiBhbiBpbnZhbGlkIHZhbHVlCiAgICAgICAgVHlwZUVycm9yIC0gd2hlbiBhbnkgb2YgdGhlIHBhcmFtZXRlcnMgYXJlIG9mIHRoZSB3cm9uZyB0eXBlCiAgICAgICAgT1NFcnJvciAtIHdoZW4gYW4gZXJyb3IgaXMgcmV0dXJuZWQgYnkgdGhlIE9TIGNyeXB0byBsaWJyYXJ5CgogICAgOnJldHVybjoKICAgICAgICBBIGJ5dGUgc3RyaW5nIG9mIHRoZSBwbGFpbnRleHQKICAgICIiIgoKICAgIGlmIG5vdCBpc2luc3RhbmNlKHByaXZhdGVfa2V5LCBQcml2YXRlS2V5KToKICAgICAgICByYWlzZSBUeXBlRXJyb3IocHJldHR5X21lc3NhZ2UoCiAgICAgICAgICAgICcnJwogICAgICAgICAgICBwcml2YXRlX2tleSBtdXN0IGJlIGFuIGluc3RhbmNlIG9mIHRoZSBQcml2YXRlS2V5IGNsYXNzLCBub3QgJXMKICAgICAgICAgICAgJycnLAogICAgICAgICAgICB0eXBlX25hbWUocHJpdmF0ZV9rZXkpCiAgICAgICAgKSkKCiAgICBpZiBub3QgaXNpbnN0YW5jZShjaXBoZXJ0ZXh0LCBieXRlX2Nscyk6CiAgICAgICAgcmFpc2UgVHlwZUVycm9yKHByZXR0eV9tZXNzYWdlKAogICAgICAgICAgICAnJycKICAgICAgICAgICAgY2lwaGVydGV4dCBtdXN0IGJlIGEgYnl0ZSBzdHJpbmcsIG5vdCAlcwogICAgICAgICAgICAnJycsCiAgICAgICAgICAgIHR5cGVfbmFtZShjaXBoZXJ0ZXh0KQogICAgICAgICkpCgogICAgcnNhID0gTm9uZQoKICAgIHRyeToKICAgICAgICBidWZmZXJfc2l6ZSA9IF9ldnBfcGtleV9nZXRfc2l6ZShwcml2YXRlX2tleS5ldnBfcGtleSkKICAgICAgICBidWZmZXIgPSBidWZmZXJfZnJvbV9ieXRlcyhidWZmZXJfc2l6ZSkKCiAgICAgICAgcnNhID0gbGliY3J5cHRvLkVWUF9QS0VZX2dldDFfUlNBKHByaXZhdGVfa2V5LmV2cF9wa2V5KQogICAgICAgIHJlcyA9IGxpYmNyeXB0by5SU0FfcHJpdmF0ZV9kZWNyeXB0KGxlbihjaXBoZXJ0ZXh0KSwgY2lwaGVydGV4dCwgYnVmZmVyLCByc2EsIHBhZGRpbmcpCiAgICAgICAgaGFuZGxlX29wZW5zc2xfZXJyb3IocmVzKQoKICAgICAgICByZXR1cm4gYnl0ZXNfZnJvbV9idWZmZXIoYnVmZmVyLCByZXMpCgogICAgZmluYWxseToKICAgICAgICBpZiByc2E6CiAgICAgICAgICAgIGxpYmNyeXB0by5SU0FfZnJlZShyc2EpCgoKZGVmIHJzYV9wa2NzMXYxNV92ZXJpZnkoY2VydGlmaWNhdGVfb3JfcHVibGljX2tleSwgc2lnbmF0dXJlLCBkYXRhLCBoYXNoX2FsZ29yaXRobSk6CiAgICAiIiIKICAgIFZlcmlmaWVzIGFuIFJTQVNTQS1QS0NTLXYxLjUgc2lnbmF0dXJlLgoKICAgIFdoZW4gdGhlIGhhc2hfYWxnb3JpdGhtIGlzICJyYXciLCB0aGUgb3BlcmF0aW9uIGlzIGlkZW50aWNhbCB0byBSU0EKICAgIHB1YmxpYyBrZXkgZGVjcnlwdGlvbi4gVGhhdCBpczogdGhlIGRhdGEgaXMgbm90IGhhc2hlZCBhbmQgbm8gQVNOLjEKICAgIHN0cnVjdHVyZSB3aXRoIGFuIGFsZ29yaXRobSBpZGVudGlmaWVyIG9mIHRoZSBoYXNoIGFsZ29yaXRobSBpcyBwbGFjZWQgaW4KICAgIHRoZSBlbmNyeXB0ZWQgYnl0ZSBzdHJpbmcuCgogICAgOnBhcmFtIGNlcnRpZmljYXRlX29yX3B1YmxpY19rZXk6CiAgICAgICAgQSBDZXJ0aWZpY2F0ZSBvciBQdWJsaWNLZXkgaW5zdGFuY2UgdG8gdmVyaWZ5IHRoZSBzaWduYXR1cmUgd2l0aAoKICAgIDpwYXJhbSBzaWduYXR1cmU6CiAgICAgICAgQSBieXRlIHN0cmluZyBvZiB0aGUgc2lnbmF0dXJlIHRvIHZlcmlmeQoKICAgIDpwYXJhbSBkYXRhOgogICAgICAgIEEgYnl0ZSBzdHJpbmcgb2YgdGhlIGRhdGEgdGhlIHNpZ25hdHVyZSBpcyBmb3IKCiAgICA6cGFyYW0gaGFzaF9hbGdvcml0aG06CiAgICAgICAgQSB1bmljb2RlIHN0cmluZyBvZiAibWQ1IiwgInNoYTEiLCAic2hhMjI0IiwgInNoYTI1NiIsICJzaGEzODQiLAogICAgICAgICJzaGE1MTIiIG9yICJyYXciCgogICAgOnJhaXNlczoKICAgICAgICBvc2NyeXB0by5lcnJvcnMuU2lnbmF0dXJlRXJyb3IgLSB3aGVuIHRoZSBzaWduYXR1cmUgaXMgZGV0ZXJtaW5lZCB0byBiZSBpbnZhbGlkCiAgICAgICAgVmFsdWVFcnJvciAtIHdoZW4gYW55IG9mIHRoZSBwYXJhbWV0ZXJzIGNvbnRhaW4gYW4gaW52YWxpZCB2YWx1ZQogICAgICAgIFR5cGVFcnJvciAtIHdoZW4gYW55IG9mIHRoZSBwYXJhbWV0ZXJzIGFyZSBvZiB0aGUgd3JvbmcgdHlwZQogICAgICAgIE9TRXJyb3IgLSB3aGVuIGFuIGVycm9yIGlzIHJldHVybmVkIGJ5IHRoZSBPUyBjcnlwdG8gbGlicmFyeQogICAgIiIiCgogICAgaWYgY2VydGlmaWNhdGVfb3JfcHVibGljX2tleS5hbGdvcml0aG0gIT0gJ3JzYSc6CiAgICAgICAgcmFpc2UgVmFsdWVFcnJvcihwcmV0dHlfbWVzc2FnZSgKICAgICAgICAgICAgJycnCiAgICAgICAgICAgIFRoZSBrZXkgc3BlY2lmaWVkIGlzIG5vdCBhbiBSU0EgcHVibGljIGtleSwgYnV0ICVzCiAgICAgICAgICAgICcnJywKICAgICAgICAgICAgY2VydGlmaWNhdGVfb3JfcHVibGljX2tleS5hbGdvcml0aG0udXBwZXIoKQogICAgICAgICkpCgogICAgcmV0dXJuIF92ZXJpZnkoY2VydGlmaWNhdGVfb3JfcHVibGljX2tleSwgc2lnbmF0dXJlLCBkYXRhLCBoYXNoX2FsZ29yaXRobSkKCgpkZWYgcnNhX3Bzc192ZXJpZnkoY2VydGlmaWNhdGVfb3JfcHVibGljX2tleSwgc2lnbmF0dXJlLCBkYXRhLCBoYXNoX2FsZ29yaXRobSk6CiAgICAiIiIKICAgIFZlcmlmaWVzIGFuIFJTQVNTQS1QU1Mgc2lnbmF0dXJlLiBGb3IgdGhlIFBTUyBwYWRkaW5nIHRoZSBtYXNrIGdlbiBhbGdvcml0aG0KICAgIHdpbGwgYmUgbWdmMSB1c2luZyB0aGUgc2FtZSBoYXNoIGFsZ29yaXRobSBhcyB0aGUgc2lnbmF0dXJlLiBUaGUgc2FsdCBsZW5ndGgKICAgIHdpdGggYmUgdGhlIGxlbmd0aCBvZiB0aGUgaGFzaCBhbGdvcml0aG0sIGFuZCB0aGUgdHJhaWxlciBmaWVsZCB3aXRoIGJlIHRoZQogICAgc3RhbmRhcmQgMHhCQyBieXRlLgoKICAgIDpwYXJhbSBjZXJ0aWZpY2F0ZV9vcl9wdWJsaWNfa2V5OgogICAgICAgIEEgQ2VydGlmaWNhdGUgb3IgUHVibGljS2V5IGluc3RhbmNlIHRvIHZlcmlmeSB0aGUgc2lnbmF0dXJlIHdpdGgKCiAgICA6cGFyYW0gc2lnbmF0dXJlOgogICAgICAgIEEgYnl0ZSBzdHJpbmcgb2YgdGhlIHNpZ25hdHVyZSB0byB2ZXJpZnkKCiAgICA6cGFyYW0gZGF0YToKICAgICAgICBBIGJ5dGUgc3RyaW5nIG9mIHRoZSBkYXRhIHRoZSBzaWduYXR1cmUgaXMgZm9yCgogICAgOnBhcmFtIGhhc2hfYWxnb3JpdGhtOgogICAgICAgIEEgdW5pY29kZSBzdHJpbmcgb2YgIm1kNSIsICJzaGExIiwgInNoYTIyNCIsICJzaGEyNTYiLCAic2hhMzg0IiBvciAic2hhNTEyIgoKICAgIDpyYWlzZXM6CiAgICAgICAgb3NjcnlwdG8uZXJyb3JzLlNpZ25hdHVyZUVycm9yIC0gd2hlbiB0aGUgc2lnbmF0dXJlIGlzIGRldGVybWluZWQgdG8gYmUgaW52YWxpZAogICAgICAgIFZhbHVlRXJyb3IgLSB3aGVuIGFueSBvZiB0aGUgcGFyYW1ldGVycyBjb250YWluIGFuIGludmFsaWQgdmFsdWUKICAgICAgICBUeXBlRXJyb3IgLSB3aGVuIGFueSBvZiB0aGUgcGFyYW1ldGVycyBhcmUgb2YgdGhlIHdyb25nIHR5cGUKICAgICAgICBPU0Vycm9yIC0gd2hlbiBhbiBlcnJvciBpcyByZXR1cm5lZCBieSB0aGUgT1MgY3J5cHRvIGxpYnJhcnkKICAgICIiIgoKICAgIGNwX2FsZyA9IGNlcnRpZmljYXRlX29yX3B1YmxpY19rZXkuYWxnb3JpdGhtCgogICAgaWYgY3BfYWxnICE9ICdyc2EnIGFuZCBjcF9hbGcgIT0gJ3JzYXNzYV9wc3MnOgogICAgICAgIHJhaXNlIFZhbHVlRXJyb3IocHJldHR5X21lc3NhZ2UoCiAgICAgICAgICAgICcnJwogICAgICAgICAgICBUaGUga2V5IHNwZWNpZmllZCBpcyBub3QgYW4gUlNBIHB1YmxpYyBrZXksIGJ1dCAlcwogICAgICAgICAgICAnJycsCiAgICAgICAgICAgIGNlcnRpZmljYXRlX29yX3B1YmxpY19rZXkuYWxnb3JpdGhtLnVwcGVyKCkKICAgICAgICApKQoKICAgIHJldHVybiBfdmVyaWZ5KGNlcnRpZmljYXRlX29yX3B1YmxpY19rZXksIHNpZ25hdHVyZSwgZGF0YSwgaGFzaF9hbGdvcml0aG0sIHJzYV9wc3NfcGFkZGluZz1UcnVlKQoKCmRlZiBkc2FfdmVyaWZ5KGNlcnRpZmljYXRlX29yX3B1YmxpY19rZXksIHNpZ25hdHVyZSwgZGF0YSwgaGFzaF9hbGdvcml0aG0pOgogICAgIiIiCiAgICBWZXJpZmllcyBhIERTQSBzaWduYXR1cmUKCiAgICA6cGFyYW0gY2VydGlmaWNhdGVfb3JfcHVibGljX2tleToKICAgICAgICBBIENlcnRpZmljYXRlIG9yIFB1YmxpY0tleSBpbnN0YW5jZSB0byB2ZXJpZnkgdGhlIHNpZ25hdHVyZSB3aXRoCgogICAgOnBhcmFtIHNpZ25hdHVyZToKICAgICAgICBBIGJ5dGUgc3RyaW5nIG9mIHRoZSBzaWduYXR1cmUgdG8gdmVyaWZ5CgogICAgOnBhcmFtIGRhdGE6CiAgICAgICAgQSBieXRlIHN0cmluZyBvZiB0aGUgZGF0YSB0aGUgc2lnbmF0dXJlIGlzIGZvcgoKICAgIDpwYXJhbSBoYXNoX2FsZ29yaXRobToKICAgICAgICBBIHVuaWNvZGUgc3RyaW5nIG9mICJtZDUiLCAic2hhMSIsICJzaGEyMjQiLCAic2hhMjU2IiwgInNoYTM4NCIgb3IgInNoYTUxMiIKCiAgICA6cmFpc2VzOgogICAgICAgIG9zY3J5cHRvLmVycm9ycy5TaWduYXR1cmVFcnJvciAtIHdoZW4gdGhlIHNpZ25hdHVyZSBpcyBkZXRlcm1pbmVkIHRvIGJlIGludmFsaWQKICAgICAgICBWYWx1ZUVycm9yIC0gd2hlbiBhbnkgb2YgdGhlIHBhcmFtZXRlcnMgY29udGFpbiBhbiBpbnZhbGlkIHZhbHVlCiAgICAgICAgVHlwZUVycm9yIC0gd2hlbiBhbnkgb2YgdGhlIHBhcmFtZXRlcnMgYXJlIG9mIHRoZSB3cm9uZyB0eXBlCiAgICAgICAgT1NFcnJvciAtIHdoZW4gYW4gZXJyb3IgaXMgcmV0dXJuZWQgYnkgdGhlIE9TIGNyeXB0byBsaWJyYXJ5CiAgICAiIiIKCiAgICBpZiBjZXJ0aWZpY2F0ZV9vcl9wdWJsaWNfa2V5LmFsZ29yaXRobSAhPSAnZHNhJzoKICAgICAgICByYWlzZSBWYWx1ZUVycm9yKHByZXR0eV9tZXNzYWdlKAogICAgICAgICAgICAnJycKICAgICAgICAgICAgVGhlIGtleSBzcGVjaWZpZWQgaXMgbm90IGEgRFNBIHB1YmxpYyBrZXksIGJ1dCAlcwogICAgICAgICAgICAnJycsCiAgICAgICAgICAgIGNlcnRpZmljYXRlX29yX3B1YmxpY19rZXkuYWxnb3JpdGhtLnVwcGVyKCkKICAgICAgICApKQoKICAgIHJldHVybiBfdmVyaWZ5KGNlcnRpZmljYXRlX29yX3B1YmxpY19rZXksIHNpZ25hdHVyZSwgZGF0YSwgaGFzaF9hbGdvcml0aG0pCgoKZGVmIGVjZHNhX3ZlcmlmeShjZXJ0aWZpY2F0ZV9vcl9wdWJsaWNfa2V5LCBzaWduYXR1cmUsIGRhdGEsIGhhc2hfYWxnb3JpdGhtKToKICAgICIiIgogICAgVmVyaWZpZXMgYW4gRUNEU0Egc2lnbmF0dXJlCgogICAgOnBhcmFtIGNlcnRpZmljYXRlX29yX3B1YmxpY19rZXk6CiAgICAgICAgQSBDZXJ0aWZpY2F0ZSBvciBQdWJsaWNLZXkgaW5zdGFuY2UgdG8gdmVyaWZ5IHRoZSBzaWduYXR1cmUgd2l0aAoKICAgIDpwYXJhbSBzaWduYXR1cmU6CiAgICAgICAgQSBieXRlIHN0cmluZyBvZiB0aGUgc2lnbmF0dXJlIHRvIHZlcmlmeQoKICAgIDpwYXJhbSBkYXRhOgogICAgICAgIEEgYnl0ZSBzdHJpbmcgb2YgdGhlIGRhdGEgdGhlIHNpZ25hdHVyZSBpcyBmb3IKCiAgICA6cGFyYW0gaGFzaF9hbGdvcml0aG06CiAgICAgICAgQSB1bmljb2RlIHN0cmluZyBvZiAibWQ1IiwgInNoYTEiLCAic2hhMjI0IiwgInNoYTI1NiIsICJzaGEzODQiIG9yICJzaGE1MTIiCgogICAgOnJhaXNlczoKICAgICAgICBvc2NyeXB0by5lcnJvcnMuU2lnbmF0dXJlRXJyb3IgLSB3aGVuIHRoZSBzaWduYXR1cmUgaXMgZGV0ZXJtaW5lZCB0byBiZSBpbnZhbGlkCiAgICAgICAgVmFsdWVFcnJvciAtIHdoZW4gYW55IG9mIHRoZSBwYXJhbWV0ZXJzIGNvbnRhaW4gYW4gaW52YWxpZCB2YWx1ZQogICAgICAgIFR5cGVFcnJvciAtIHdoZW4gYW55IG9mIHRoZSBwYXJhbWV0ZXJzIGFyZSBvZiB0aGUgd3JvbmcgdHlwZQogICAgICAgIE9TRXJyb3IgLSB3aGVuIGFuIGVycm9yIGlzIHJldHVybmVkIGJ5IHRoZSBPUyBjcnlwdG8gbGlicmFyeQogICAgIiIiCgogICAgaWYgY2VydGlmaWNhdGVfb3JfcHVibGljX2tleS5hbGdvcml0aG0gIT0gJ2VjJzoKICAgICAgICByYWlzZSBWYWx1ZUVycm9yKHByZXR0eV9tZXNzYWdlKAogICAgICAgICAgICAnJycKICAgICAgICAgICAgVGhlIGtleSBzcGVjaWZpZWQgaXMgbm90IGFuIEVDIHB1YmxpYyBrZXksIGJ1dCAlcwogICAgICAgICAgICAnJycsCiAgICAgICAgICAgIGNlcnRpZmljYXRlX29yX3B1YmxpY19rZXkuYWxnb3JpdGhtLnVwcGVyKCkKICAgICAgICApKQoKICAgIHJldHVybiBfdmVyaWZ5KGNlcnRpZmljYXRlX29yX3B1YmxpY19rZXksIHNpZ25hdHVyZSwgZGF0YSwgaGFzaF9hbGdvcml0aG0pCgoKZGVmIF92ZXJpZnkoY2VydGlmaWNhdGVfb3JfcHVibGljX2tleSwgc2lnbmF0dXJlLCBkYXRhLCBoYXNoX2FsZ29yaXRobSwgcnNhX3Bzc19wYWRkaW5nPUZhbHNlKToKICAgICIiIgogICAgVmVyaWZpZXMgYW4gUlNBLCBEU0Egb3IgRUNEU0Egc2lnbmF0dXJlCgogICAgOnBhcmFtIGNlcnRpZmljYXRlX29yX3B1YmxpY19rZXk6CiAgICAgICAgQSBDZXJ0aWZpY2F0ZSBvciBQdWJsaWNLZXkgaW5zdGFuY2UgdG8gdmVyaWZ5IHRoZSBzaWduYXR1cmUgd2l0aAoKICAgIDpwYXJhbSBzaWduYXR1cmU6CiAgICAgICAgQSBieXRlIHN0cmluZyBvZiB0aGUgc2lnbmF0dXJlIHRvIHZlcmlmeQoKICAgIDpwYXJhbSBkYXRhOgogICAgICAgIEEgYnl0ZSBzdHJpbmcgb2YgdGhlIGRhdGEgdGhlIHNpZ25hdHVyZSBpcyBmb3IKCiAgICA6cGFyYW0gaGFzaF9hbGdvcml0aG06CiAgICAgICAgQSB1bmljb2RlIHN0cmluZyBvZiAibWQ1IiwgInNoYTEiLCAic2hhMjI0IiwgInNoYTI1NiIsICJzaGEzODQiIG9yICJzaGE1MTIiCgogICAgOnBhcmFtIHJzYV9wc3NfcGFkZGluZzoKICAgICAgICBJZiB0aGUgY2VydGlmaWNhdGVfb3JfcHVibGljX2tleSBpcyBhbiBSU0Ega2V5LCB0aGlzIGVuYWJsZXMgUFNTIHBhZGRpbmcKCiAgICA6cmFpc2VzOgogICAgICAgIG9zY3J5cHRvLmVycm9ycy5TaWduYXR1cmVFcnJvciAtIHdoZW4gdGhlIHNpZ25hdHVyZSBpcyBkZXRlcm1pbmVkIHRvIGJlIGludmFsaWQKICAgICAgICBWYWx1ZUVycm9yIC0gd2hlbiBhbnkgb2YgdGhlIHBhcmFtZXRlcnMgY29udGFpbiBhbiBpbnZhbGlkIHZhbHVlCiAgICAgICAgVHlwZUVycm9yIC0gd2hlbiBhbnkgb2YgdGhlIHBhcmFtZXRlcnMgYXJlIG9mIHRoZSB3cm9uZyB0eXBlCiAgICAgICAgT1NFcnJvciAtIHdoZW4gYW4gZXJyb3IgaXMgcmV0dXJuZWQgYnkgdGhlIE9TIGNyeXB0byBsaWJyYXJ5CiAgICAiIiIKCiAgICBpZiBub3QgaXNpbnN0YW5jZShjZXJ0aWZpY2F0ZV9vcl9wdWJsaWNfa2V5LCAoQ2VydGlmaWNhdGUsIFB1YmxpY0tleSkpOgogICAgICAgIHJhaXNlIFR5cGVFcnJvcihwcmV0dHlfbWVzc2FnZSgKICAgICAgICAgICAgJycnCiAgICAgICAgICAgIGNlcnRpZmljYXRlX29yX3B1YmxpY19rZXkgbXVzdCBiZSBhbiBpbnN0YW5jZSBvZiB0aGUgQ2VydGlmaWNhdGUgb3IKICAgICAgICAgICAgUHVibGljS2V5IGNsYXNzLCBub3QgJXMKICAgICAgICAgICAgJycnLAogICAgICAgICAgICB0eXBlX25hbWUoY2VydGlmaWNhdGVfb3JfcHVibGljX2tleSkKICAgICAgICApKQoKICAgIGlmIG5vdCBpc2luc3RhbmNlKHNpZ25hdHVyZSwgYnl0ZV9jbHMpOgogICAgICAgIHJhaXNlIFR5cGVFcnJvcihwcmV0dHlfbWVzc2FnZSgKICAgICAgICAgICAgJycnCiAgICAgICAgICAgIHNpZ25hdHVyZSBtdXN0IGJlIGEgYnl0ZSBzdHJpbmcsIG5vdCAlcwogICAgICAgICAgICAnJycsCiAgICAgICAgICAgIHR5cGVfbmFtZShzaWduYXR1cmUpCiAgICAgICAgKSkKCiAgICBpZiBub3QgaXNpbnN0YW5jZShkYXRhLCBieXRlX2Nscyk6CiAgICAgICAgcmFpc2UgVHlwZUVycm9yKHByZXR0eV9tZXNzYWdlKAogICAgICAgICAgICAnJycKICAgICAgICAgICAgZGF0YSBtdXN0IGJlIGEgYnl0ZSBzdHJpbmcsIG5vdCAlcwogICAgICAgICAgICAnJycsCiAgICAgICAgICAgIHR5cGVfbmFtZShkYXRhKQogICAgICAgICkpCgogICAgY3BfYWxnID0gY2VydGlmaWNhdGVfb3JfcHVibGljX2tleS5hbGdvcml0aG0KICAgIGNwX2lzX3JzYSA9IGNwX2FsZyA9PSAncnNhJyBvciBjcF9hbGcgPT0gJ3JzYXNzYV9wc3MnCgogICAgdmFsaWRfaGFzaF9hbGdvcml0aG1zID0gc2V0KFsnbWQ1JywgJ3NoYTEnLCAnc2hhMjI0JywgJ3NoYTI1NicsICdzaGEzODQnLCAnc2hhNTEyJ10pCiAgICBpZiBjcF9pc19yc2EgYW5kIG5vdCByc2FfcHNzX3BhZGRpbmc6CiAgICAgICAgdmFsaWRfaGFzaF9hbGdvcml0aG1zIHw9IHNldChbJ3JhdyddKQoKICAgIGlmIGhhc2hfYWxnb3JpdGhtIG5vdCBpbiB2YWxpZF9oYXNoX2FsZ29yaXRobXM6CiAgICAgICAgdmFsaWRfaGFzaF9hbGdvcml0aG1zX2Vycm9yID0gJyJtZDUiLCAic2hhMSIsICJzaGEyMjQiLCAic2hhMjU2IiwgInNoYTM4NCIsICJzaGE1MTIiJwogICAgICAgIGlmIGNwX2lzX3JzYSBhbmQgbm90IHJzYV9wc3NfcGFkZGluZzoKICAgICAgICAgICAgdmFsaWRfaGFzaF9hbGdvcml0aG1zX2Vycm9yICs9ICcsICJyYXciJwogICAgICAgIHJhaXNlIFZhbHVlRXJyb3IocHJldHR5X21lc3NhZ2UoCiAgICAgICAgICAgICcnJwogICAgICAgICAgICBoYXNoX2FsZ29yaXRobSBtdXN0IGJlIG9uZSBvZiAlcywgbm90ICVzCiAgICAgICAgICAgICcnJywKICAgICAgICAgICAgdmFsaWRfaGFzaF9hbGdvcml0aG1zX2Vycm9yLAogICAgICAgICAgICByZXByKGhhc2hfYWxnb3JpdGhtKQogICAgICAgICkpCgogICAgaWYgbm90IGNwX2lzX3JzYSBhbmQgcnNhX3Bzc19wYWRkaW5nOgogICAgICAgIHJhaXNlIFZhbHVlRXJyb3IocHJldHR5X21lc3NhZ2UoCiAgICAgICAgICAgICcnJwogICAgICAgICAgICBQU1MgcGFkZGluZyBjYW4gb25seSBiZSB1c2VkIHdpdGggUlNBIGtleXMgLSB0aGUga2V5IHByb3ZpZGVkIGlzIGEKICAgICAgICAgICAgJXMga2V5CiAgICAgICAgICAgICcnJywKICAgICAgICAgICAgY3BfYWxnLnVwcGVyKCkKICAgICAgICApKQoKICAgIGlmIGNwX2lzX3JzYSBhbmQgaGFzaF9hbGdvcml0aG0gPT0gJ3Jhdyc6CiAgICAgICAgaWYgbGVuKGRhdGEpID4gY2VydGlmaWNhdGVfb3JfcHVibGljX2tleS5ieXRlX3NpemUgLSAxMToKICAgICAgICAgICAgcmFpc2UgVmFsdWVFcnJvcihwcmV0dHlfbWVzc2FnZSgKICAgICAgICAgICAgICAgICcnJwogICAgICAgICAgICAgICAgZGF0YSBtdXN0IGJlIDExIGJ5dGVzIHNob3J0ZXIgdGhhbiB0aGUga2V5IHNpemUgd2hlbgogICAgICAgICAgICAgICAgaGFzaF9hbGdvcml0aG0gaXMgInJhdyIgLSBrZXkgc2l6ZSBpcyAlcyBieXRlcywgYnV0IGRhdGEgaXMKICAgICAgICAgICAgICAgICVzIGJ5dGVzIGxvbmcKICAgICAgICAgICAgICAgICcnJywKICAgICAgICAgICAgICAgIGNlcnRpZmljYXRlX29yX3B1YmxpY19rZXkuYnl0ZV9zaXplLAogICAgICAgICAgICAgICAgbGVuKGRhdGEpCiAgICAgICAgICAgICkpCgogICAgICAgIHJzYSA9IE5vbmUKCiAgICAgICAgdHJ5OgogICAgICAgICAgICByc2EgPSBsaWJjcnlwdG8uRVZQX1BLRVlfZ2V0MV9SU0EoY2VydGlmaWNhdGVfb3JfcHVibGljX2tleS5ldnBfcGtleSkKICAgICAgICAgICAgaWYgaXNfbnVsbChyc2EpOgogICAgICAgICAgICAgICAgaGFuZGxlX29wZW5zc2xfZXJyb3IoMCkKCiAgICAgICAgICAgIGJ1ZmZlcl9zaXplID0gX2V2cF9wa2V5X2dldF9zaXplKGNlcnRpZmljYXRlX29yX3B1YmxpY19rZXkuZXZwX3BrZXkpCiAgICAgICAgICAgIGRlY3J5cHRlZF9idWZmZXIgPSBidWZmZXJfZnJvbV9ieXRlcyhidWZmZXJfc2l6ZSkKICAgICAgICAgICAgZGVjcnlwdGVkX2xlbmd0aCA9IGxpYmNyeXB0by5SU0FfcHVibGljX2RlY3J5cHQoCiAgICAgICAgICAgICAgICBsZW4oc2lnbmF0dXJlKSwKICAgICAgICAgICAgICAgIHNpZ25hdHVyZSwKICAgICAgICAgICAgICAgIGRlY3J5cHRlZF9idWZmZXIsCiAgICAgICAgICAgICAgICByc2EsCiAgICAgICAgICAgICAgICBMaWJjcnlwdG9Db25zdC5SU0FfUEtDUzFfUEFERElORwogICAgICAgICAgICApCiAgICAgICAgICAgIGhhbmRsZV9vcGVuc3NsX2Vycm9yKGRlY3J5cHRlZF9sZW5ndGgpCgogICAgICAgICAgICBkZWNyeXB0ZWRfYnl0ZXMgPSBieXRlc19mcm9tX2J1ZmZlcihkZWNyeXB0ZWRfYnVmZmVyLCBkZWNyeXB0ZWRfbGVuZ3RoKQoKICAgICAgICAgICAgaWYgbm90IGNvbnN0YW50X2NvbXBhcmUoZGF0YSwgZGVjcnlwdGVkX2J5dGVzKToKICAgICAgICAgICAgICAgIHJhaXNlIFNpZ25hdHVyZUVycm9yKCdTaWduYXR1cmUgaXMgaW52YWxpZCcpCiAgICAgICAgICAgIHJldHVybgoKICAgICAgICBmaW5hbGx5OgogICAgICAgICAgICBpZiByc2E6CiAgICAgICAgICAgICAgICBsaWJjcnlwdG8uUlNBX2ZyZWUocnNhKQoKICAgIGV2cF9tZF9jdHggPSBOb25lCiAgICByc2EgPSBOb25lCiAgICBkc2EgPSBOb25lCiAgICBkc2Ffc2lnID0gTm9uZQogICAgZWNfa2V5ID0gTm9uZQogICAgZWNkc2Ffc2lnID0gTm9uZQoKICAgIHRyeToKICAgICAgICBpZiBsaWJjcnlwdG9fdmVyc2lvbl9pbmZvIDwgKDEsIDEpOgogICAgICAgICAgICBldnBfbWRfY3R4ID0gbGliY3J5cHRvLkVWUF9NRF9DVFhfY3JlYXRlKCkKICAgICAgICBlbHNlOgogICAgICAgICAgICBldnBfbWRfY3R4ID0gbGliY3J5cHRvLkVWUF9NRF9DVFhfbmV3KCkKCiAgICAgICAgZXZwX21kID0gewogICAgICAgICAgICAnbWQ1JzogbGliY3J5cHRvLkVWUF9tZDUsCiAgICAgICAgICAgICdzaGExJzogbGliY3J5cHRvLkVWUF9zaGExLAogICAgICAgICAgICAnc2hhMjI0JzogbGliY3J5cHRvLkVWUF9zaGEyMjQsCiAgICAgICAgICAgICdzaGEyNTYnOiBsaWJjcnlwdG8uRVZQX3NoYTI1NiwKICAgICAgICAgICAgJ3NoYTM4NCc6IGxpYmNyeXB0by5FVlBfc2hhMzg0LAogICAgICAgICAgICAnc2hhNTEyJzogbGliY3J5cHRvLkVWUF9zaGE1MTIKICAgICAgICB9W2hhc2hfYWxnb3JpdGhtXSgpCgogICAgICAgIGlmIGxpYmNyeXB0b192ZXJzaW9uX2luZm8gPCAoMSwpOgogICAgICAgICAgICBpZiBjcF9pc19yc2EgYW5kIHJzYV9wc3NfcGFkZGluZzoKICAgICAgICAgICAgICAgIGRpZ2VzdCA9IGdldGF0dHIoaGFzaGxpYiwgaGFzaF9hbGdvcml0aG0pKGRhdGEpLmRpZ2VzdCgpCgogICAgICAgICAgICAgICAgcnNhID0gbGliY3J5cHRvLkVWUF9QS0VZX2dldDFfUlNBKGNlcnRpZmljYXRlX29yX3B1YmxpY19rZXkuZXZwX3BrZXkpCiAgICAgICAgICAgICAgICBpZiBpc19udWxsKHJzYSk6CiAgICAgICAgICAgICAgICAgICAgaGFuZGxlX29wZW5zc2xfZXJyb3IoMCkKCiAgICAgICAgICAgICAgICBidWZmZXJfc2l6ZSA9IF9ldnBfcGtleV9nZXRfc2l6ZShjZXJ0aWZpY2F0ZV9vcl9wdWJsaWNfa2V5LmV2cF9wa2V5KQogICAgICAgICAgICAgICAgZGVjb2RlZF9idWZmZXIgPSBidWZmZXJfZnJvbV9ieXRlcyhidWZmZXJfc2l6ZSkKICAgICAgICAgICAgICAgIGRlY29kZWRfbGVuZ3RoID0gbGliY3J5cHRvLlJTQV9wdWJsaWNfZGVjcnlwdCgKICAgICAgICAgICAgICAgICAgICBsZW4oc2lnbmF0dXJlKSwKICAgICAgICAgICAgICAgICAgICBzaWduYXR1cmUsCiAgICAgICAgICAgICAgICAgICAgZGVjb2RlZF9idWZmZXIsCiAgICAgICAgICAgICAgICAgICAgcnNhLAogICAgICAgICAgICAgICAgICAgIExpYmNyeXB0b0NvbnN0LlJTQV9OT19QQURESU5HCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICBoYW5kbGVfb3BlbnNzbF9lcnJvcihkZWNvZGVkX2xlbmd0aCkKCiAgICAgICAgICAgICAgICByZXMgPSBsaWJjcnlwdG8uUlNBX3ZlcmlmeV9QS0NTMV9QU1MoCiAgICAgICAgICAgICAgICAgICAgcnNhLAogICAgICAgICAgICAgICAgICAgIGRpZ2VzdCwKICAgICAgICAgICAgICAgICAgICBldnBfbWQsCiAgICAgICAgICAgICAgICAgICAgZGVjb2RlZF9idWZmZXIsCiAgICAgICAgICAgICAgICAgICAgTGliY3J5cHRvQ29uc3QuRVZQX01EX0NUWF9GTEFHX1BTU19NRExFTgogICAgICAgICAgICAgICAgKQoKICAgICAgICAgICAgZWxpZiBjcF9pc19yc2E6CiAgICAgICAgICAgICAgICByZXMgPSBsaWJjcnlwdG8uRVZQX0RpZ2VzdEluaXRfZXgoZXZwX21kX2N0eCwgZXZwX21kLCBudWxsKCkpCiAgICAgICAgICAgICAgICBoYW5kbGVfb3BlbnNzbF9lcnJvcihyZXMpCgogICAgICAgICAgICAgICAgcmVzID0gbGliY3J5cHRvLkVWUF9EaWdlc3RVcGRhdGUoZXZwX21kX2N0eCwgZGF0YSwgbGVuKGRhdGEpKQogICAgICAgICAgICAgICAgaGFuZGxlX29wZW5zc2xfZXJyb3IocmVzKQoKICAgICAgICAgICAgICAgIHJlcyA9IGxpYmNyeXB0by5FVlBfVmVyaWZ5RmluYWwoCiAgICAgICAgICAgICAgICAgICAgZXZwX21kX2N0eCwKICAgICAgICAgICAgICAgICAgICBzaWduYXR1cmUsCiAgICAgICAgICAgICAgICAgICAgbGVuKHNpZ25hdHVyZSksCiAgICAgICAgICAgICAgICAgICAgY2VydGlmaWNhdGVfb3JfcHVibGljX2tleS5ldnBfcGtleQogICAgICAgICAgICAgICAgKQoKICAgICAgICAgICAgZWxpZiBjcF9hbGcgPT0gJ2RzYSc6CiAgICAgICAgICAgICAgICBkaWdlc3QgPSBnZXRhdHRyKGhhc2hsaWIsIGhhc2hfYWxnb3JpdGhtKShkYXRhKS5kaWdlc3QoKQoKICAgICAgICAgICAgICAgIHNpZ25hdHVyZV9idWZmZXIgPSBidWZmZXJfZnJvbV9ieXRlcyhzaWduYXR1cmUpCiAgICAgICAgICAgICAgICBzaWduYXR1cmVfcG9pbnRlciA9IGJ1ZmZlcl9wb2ludGVyKHNpZ25hdHVyZV9idWZmZXIpCiAgICAgICAgICAgICAgICBkc2Ffc2lnID0gbGliY3J5cHRvLmQyaV9EU0FfU0lHKG51bGwoKSwgc2lnbmF0dXJlX3BvaW50ZXIsIGxlbihzaWduYXR1cmUpKQogICAgICAgICAgICAgICAgaWYgaXNfbnVsbChkc2Ffc2lnKToKICAgICAgICAgICAgICAgICAgICByYWlzZSBTaWduYXR1cmVFcnJvcignU2lnbmF0dXJlIGlzIGludmFsaWQnKQoKICAgICAgICAgICAgICAgIGRzYSA9IGxpYmNyeXB0by5FVlBfUEtFWV9nZXQxX0RTQShjZXJ0aWZpY2F0ZV9vcl9wdWJsaWNfa2V5LmV2cF9wa2V5KQogICAgICAgICAgICAgICAgaWYgaXNfbnVsbChkc2EpOgogICAgICAgICAgICAgICAgICAgIGhhbmRsZV9vcGVuc3NsX2Vycm9yKDApCgogICAgICAgICAgICAgICAgcmVzID0gbGliY3J5cHRvLkRTQV9kb192ZXJpZnkoZGlnZXN0LCBsZW4oZGlnZXN0KSwgZHNhX3NpZywgZHNhKQoKICAgICAgICAgICAgZWxpZiBjcF9hbGcgPT0gJ2VjJzoKICAgICAgICAgICAgICAgIGRpZ2VzdCA9IGdldGF0dHIoaGFzaGxpYiwgaGFzaF9hbGdvcml0aG0pKGRhdGEpLmRpZ2VzdCgpCgogICAgICAgICAgICAgICAgc2lnbmF0dXJlX2J1ZmZlciA9IGJ1ZmZlcl9mcm9tX2J5dGVzKHNpZ25hdHVyZSkKICAgICAgICAgICAgICAgIHNpZ25hdHVyZV9wb2ludGVyID0gYnVmZmVyX3BvaW50ZXIoc2lnbmF0dXJlX2J1ZmZlcikKICAgICAgICAgICAgICAgIGVjZHNhX3NpZyA9IGxpYmNyeXB0by5kMmlfRUNEU0FfU0lHKG51bGwoKSwgc2lnbmF0dXJlX3BvaW50ZXIsIGxlbihzaWduYXR1cmUpKQogICAgICAgICAgICAgICAgaWYgaXNfbnVsbChlY2RzYV9zaWcpOgogICAgICAgICAgICAgICAgICAgIHJhaXNlIFNpZ25hdHVyZUVycm9yKCdTaWduYXR1cmUgaXMgaW52YWxpZCcpCgogICAgICAgICAgICAgICAgZWNfa2V5ID0gbGliY3J5cHRvLkVWUF9QS0VZX2dldDFfRUNfS0VZKGNlcnRpZmljYXRlX29yX3B1YmxpY19rZXkuZXZwX3BrZXkpCiAgICAgICAgICAgICAgICBpZiBpc19udWxsKGVjX2tleSk6CiAgICAgICAgICAgICAgICAgICAgaGFuZGxlX29wZW5zc2xfZXJyb3IoMCkKCiAgICAgICAgICAgICAgICByZXMgPSBsaWJjcnlwdG8uRUNEU0FfZG9fdmVyaWZ5KGRpZ2VzdCwgbGVuKGRpZ2VzdCksIGVjZHNhX3NpZywgZWNfa2V5KQoKICAgICAgICBlbHNlOgogICAgICAgICAgICBldnBfcGtleV9jdHhfcG9pbnRlcl9wb2ludGVyID0gbmV3KGxpYmNyeXB0bywgJ0VWUF9QS0VZX0NUWCAqKicpCiAgICAgICAgICAgIHJlcyA9IGxpYmNyeXB0by5FVlBfRGlnZXN0VmVyaWZ5SW5pdCgKICAgICAgICAgICAgICAgIGV2cF9tZF9jdHgsCiAgICAgICAgICAgICAgICBldnBfcGtleV9jdHhfcG9pbnRlcl9wb2ludGVyLAogICAgICAgICAgICAgICAgZXZwX21kLAogICAgICAgICAgICAgICAgbnVsbCgpLAogICAgICAgICAgICAgICAgY2VydGlmaWNhdGVfb3JfcHVibGljX2tleS5ldnBfcGtleQogICAgICAgICAgICApCiAgICAgICAgICAgIGhhbmRsZV9vcGVuc3NsX2Vycm9yKHJlcykKICAgICAgICAgICAgZXZwX3BrZXlfY3R4X3BvaW50ZXIgPSB1bndyYXAoZXZwX3BrZXlfY3R4X3BvaW50ZXJfcG9pbnRlcikKCiAgICAgICAgICAgIGlmIHJzYV9wc3NfcGFkZGluZzoKICAgICAgICAgICAgICAgICMgRW5hYmxlIFBTUyBwYWRkaW5nCiAgICAgICAgICAgICAgICByZXMgPSBsaWJjcnlwdG8uRVZQX1BLRVlfQ1RYX2N0cmwoCiAgICAgICAgICAgICAgICAgICAgZXZwX3BrZXlfY3R4X3BvaW50ZXIsCiAgICAgICAgICAgICAgICAgICAgTGliY3J5cHRvQ29uc3QuRVZQX1BLRVlfUlNBLAogICAgICAgICAgICAgICAgICAgIC0xLCAgIyBBbGwgb3BlcmF0aW9ucwogICAgICAgICAgICAgICAgICAgIExpYmNyeXB0b0NvbnN0LkVWUF9QS0VZX0NUUkxfUlNBX1BBRERJTkcsCiAgICAgICAgICAgICAgICAgICAgTGliY3J5cHRvQ29uc3QuUlNBX1BLQ1MxX1BTU19QQURESU5HLAogICAgICAgICAgICAgICAgICAgIG51bGwoKQogICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgaGFuZGxlX29wZW5zc2xfZXJyb3IocmVzKQoKICAgICAgICAgICAgICAgICMgVXNlIHRoZSBoYXNoIGFsZ29yaXRobSBvdXRwdXQgbGVuZ3RoIGFzIHRoZSBzYWx0IGxlbmd0aAogICAgICAgICAgICAgICAgaWYgbGliY3J5cHRvX3ZlcnNpb25faW5mbyA8ICgzLCAwKToKICAgICAgICAgICAgICAgICAgICByZXMgPSBsaWJjcnlwdG8uRVZQX1BLRVlfQ1RYX2N0cmwoCiAgICAgICAgICAgICAgICAgICAgICAgIGV2cF9wa2V5X2N0eF9wb2ludGVyLAogICAgICAgICAgICAgICAgICAgICAgICBMaWJjcnlwdG9Db25zdC5FVlBfUEtFWV9SU0EsCiAgICAgICAgICAgICAgICAgICAgICAgIExpYmNyeXB0b0NvbnN0LkVWUF9QS0VZX09QX1NJR04gfCBMaWJjcnlwdG9Db25zdC5FVlBfUEtFWV9PUF9WRVJJRlksCiAgICAgICAgICAgICAgICAgICAgICAgIExpYmNyeXB0b0NvbnN0LkVWUF9QS0VZX0NUUkxfUlNBX1BTU19TQUxUTEVOLAogICAgICAgICAgICAgICAgICAgICAgICAtMSwKICAgICAgICAgICAgICAgICAgICAgICAgbnVsbCgpCiAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICAgIGhhbmRsZV9vcGVuc3NsX2Vycm9yKHJlcykKCiAgICAgICAgICAgIHJlcyA9IGxpYmNyeXB0by5FVlBfRGlnZXN0VXBkYXRlKGV2cF9tZF9jdHgsIGRhdGEsIGxlbihkYXRhKSkKICAgICAgICAgICAgaGFuZGxlX29wZW5zc2xfZXJyb3IocmVzKQoKICAgICAgICAgICAgcmVzID0gbGliY3J5cHRvLkVWUF9EaWdlc3RWZXJpZnlGaW5hbChldnBfbWRfY3R4LCBzaWduYXR1cmUsIGxlbihzaWduYXR1cmUpKQoKICAgICAgICBpZiByZXMgPCAxOgogICAgICAgICAgICByYWlzZSBTaWduYXR1cmVFcnJvcignU2lnbmF0dXJlIGlzIGludmFsaWQnKQogICAgICAgIGhhbmRsZV9vcGVuc3NsX2Vycm9yKHJlcykKCiAgICBmaW5hbGx5OgogICAgICAgIGlmIGV2cF9tZF9jdHg6CiAgICAgICAgICAgIGlmIGxpYmNyeXB0b192ZXJzaW9uX2luZm8gPCAoMSwgMSk6CiAgICAgICAgICAgICAgICBsaWJjcnlwdG8uRVZQX01EX0NUWF9kZXN0cm95KGV2cF9tZF9jdHgpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBsaWJjcnlwdG8uRVZQX01EX0NUWF9mcmVlKGV2cF9tZF9jdHgpCiAgICAgICAgaWYgcnNhOgogICAgICAgICAgICBsaWJjcnlwdG8uUlNBX2ZyZWUocnNhKQogICAgICAgIGlmIGRzYToKICAgICAgICAgICAgbGliY3J5cHRvLkRTQV9mcmVlKGRzYSkKICAgICAgICBpZiBkc2Ffc2lnOgogICAgICAgICAgICBsaWJjcnlwdG8uRFNBX1NJR19mcmVlKGRzYV9zaWcpCiAgICAgICAgaWYgZWNfa2V5OgogICAgICAgICAgICBsaWJjcnlwdG8uRUNfS0VZX2ZyZWUoZWNfa2V5KQogICAgICAgIGlmIGVjZHNhX3NpZzoKICAgICAgICAgICAgbGliY3J5cHRvLkVDRFNBX1NJR19mcmVlKGVjZHNhX3NpZykKCgpkZWYgcnNhX3BrY3MxdjE1X3NpZ24ocHJpdmF0ZV9rZXksIGRhdGEsIGhhc2hfYWxnb3JpdGhtKToKICAgICIiIgogICAgR2VuZXJhdGVzIGFuIFJTQVNTQS1QS0NTLXYxLjUgc2lnbmF0dXJlLgoKICAgIFdoZW4gdGhlIGhhc2hfYWxnb3JpdGhtIGlzICJyYXciLCB0aGUgb3BlcmF0aW9uIGlzIGlkZW50aWNhbCB0byBSU0EKICAgIHByaXZhdGUga2V5IGVuY3J5cHRpb24uIFRoYXQgaXM6IHRoZSBkYXRhIGlzIG5vdCBoYXNoZWQgYW5kIG5vIEFTTi4xCiAgICBzdHJ1Y3R1cmUgd2l0aCBhbiBhbGdvcml0aG0gaWRlbnRpZmllciBvZiB0aGUgaGFzaCBhbGdvcml0aG0gaXMgcGxhY2VkIGluCiAgICB0aGUgZW5jcnlwdGVkIGJ5dGUgc3RyaW5nLgoKICAgIDpwYXJhbSBwcml2YXRlX2tleToKICAgICAgICBUaGUgUHJpdmF0ZUtleSB0byBnZW5lcmF0ZSB0aGUgc2lnbmF0dXJlIHdpdGgKCiAgICA6cGFyYW0gZGF0YToKICAgICAgICBBIGJ5dGUgc3RyaW5nIG9mIHRoZSBkYXRhIHRoZSBzaWduYXR1cmUgaXMgZm9yCgogICAgOnBhcmFtIGhhc2hfYWxnb3JpdGhtOgogICAgICAgIEEgdW5pY29kZSBzdHJpbmcgb2YgIm1kNSIsICJzaGExIiwgInNoYTIyNCIsICJzaGEyNTYiLCAic2hhMzg0IiwKICAgICAgICAic2hhNTEyIiBvciAicmF3IgoKICAgIDpyYWlzZXM6CiAgICAgICAgVmFsdWVFcnJvciAtIHdoZW4gYW55IG9mIHRoZSBwYXJhbWV0ZXJzIGNvbnRhaW4gYW4gaW52YWxpZCB2YWx1ZQogICAgICAgIFR5cGVFcnJvciAtIHdoZW4gYW55IG9mIHRoZSBwYXJhbWV0ZXJzIGFyZSBvZiB0aGUgd3JvbmcgdHlwZQogICAgICAgIE9TRXJyb3IgLSB3aGVuIGFuIGVycm9yIGlzIHJldHVybmVkIGJ5IHRoZSBPUyBjcnlwdG8gbGlicmFyeQoKICAgIDpyZXR1cm46CiAgICAgICAgQSBieXRlIHN0cmluZyBvZiB0aGUgc2lnbmF0dXJlCiAgICAiIiIKCiAgICBpZiBwcml2YXRlX2tleS5hbGdvcml0aG0gIT0gJ3JzYSc6CiAgICAgICAgcmFpc2UgVmFsdWVFcnJvcihwcmV0dHlfbWVzc2FnZSgKICAgICAgICAgICAgJycnCiAgICAgICAgICAgIFRoZSBrZXkgc3BlY2lmaWVkIGlzIG5vdCBhbiBSU0EgcHJpdmF0ZSBrZXksIGJ1dCAlcwogICAgICAgICAgICAnJycsCiAgICAgICAgICAgIHByaXZhdGVfa2V5LmFsZ29yaXRobS51cHBlcigpCiAgICAgICAgKSkKCiAgICByZXR1cm4gX3NpZ24ocHJpdmF0ZV9rZXksIGRhdGEsIGhhc2hfYWxnb3JpdGhtKQoKCmRlZiByc2FfcHNzX3NpZ24ocHJpdmF0ZV9rZXksIGRhdGEsIGhhc2hfYWxnb3JpdGhtKToKICAgICIiIgogICAgR2VuZXJhdGVzIGFuIFJTQVNTQS1QU1Mgc2lnbmF0dXJlLiBGb3IgdGhlIFBTUyBwYWRkaW5nIHRoZSBtYXNrIGdlbgogICAgYWxnb3JpdGhtIHdpbGwgYmUgbWdmMSB1c2luZyB0aGUgc2FtZSBoYXNoIGFsZ29yaXRobSBhcyB0aGUgc2lnbmF0dXJlLiBUaGUKICAgIHNhbHQgbGVuZ3RoIHdpdGggYmUgdGhlIGxlbmd0aCBvZiB0aGUgaGFzaCBhbGdvcml0aG0sIGFuZCB0aGUgdHJhaWxlciBmaWVsZAogICAgd2l0aCBiZSB0aGUgc3RhbmRhcmQgMHhCQyBieXRlLgoKICAgIDpwYXJhbSBwcml2YXRlX2tleToKICAgICAgICBUaGUgUHJpdmF0ZUtleSB0byBnZW5lcmF0ZSB0aGUgc2lnbmF0dXJlIHdpdGgKCiAgICA6cGFyYW0gZGF0YToKICAgICAgICBBIGJ5dGUgc3RyaW5nIG9mIHRoZSBkYXRhIHRoZSBzaWduYXR1cmUgaXMgZm9yCgogICAgOnBhcmFtIGhhc2hfYWxnb3JpdGhtOgogICAgICAgIEEgdW5pY29kZSBzdHJpbmcgb2YgIm1kNSIsICJzaGExIiwgInNoYTIyNCIsICJzaGEyNTYiLCAic2hhMzg0IiBvciAic2hhNTEyIgoKICAgIDpyYWlzZXM6CiAgICAgICAgVmFsdWVFcnJvciAtIHdoZW4gYW55IG9mIHRoZSBwYXJhbWV0ZXJzIGNvbnRhaW4gYW4gaW52YWxpZCB2YWx1ZQogICAgICAgIFR5cGVFcnJvciAtIHdoZW4gYW55IG9mIHRoZSBwYXJhbWV0ZXJzIGFyZSBvZiB0aGUgd3JvbmcgdHlwZQogICAgICAgIE9TRXJyb3IgLSB3aGVuIGFuIGVycm9yIGlzIHJldHVybmVkIGJ5IHRoZSBPUyBjcnlwdG8gbGlicmFyeQoKICAgIDpyZXR1cm46CiAgICAgICAgQSBieXRlIHN0cmluZyBvZiB0aGUgc2lnbmF0dXJlCiAgICAiIiIKCiAgICBwa2V5X2FsZyA9IHByaXZhdGVfa2V5LmFsZ29yaXRobQoKICAgIGlmIHBrZXlfYWxnICE9ICdyc2EnIGFuZCBwa2V5X2FsZyAhPSAncnNhc3NhX3Bzcyc6CiAgICAgICAgcmFpc2UgVmFsdWVFcnJvcihwcmV0dHlfbWVzc2FnZSgKICAgICAgICAgICAgJycnCiAgICAgICAgICAgIFRoZSBrZXkgc3BlY2lmaWVkIGlzIG5vdCBhbiBSU0EgcHJpdmF0ZSBrZXksIGJ1dCAlcwogICAgICAgICAgICAnJycsCiAgICAgICAgICAgIHBrZXlfYWxnLnVwcGVyKCkKICAgICAgICApKQoKICAgIHJldHVybiBfc2lnbihwcml2YXRlX2tleSwgZGF0YSwgaGFzaF9hbGdvcml0aG0sIHJzYV9wc3NfcGFkZGluZz1UcnVlKQoKCmRlZiBkc2Ffc2lnbihwcml2YXRlX2tleSwgZGF0YSwgaGFzaF9hbGdvcml0aG0pOgogICAgIiIiCiAgICBHZW5lcmF0ZXMgYSBEU0Egc2lnbmF0dXJlCgogICAgOnBhcmFtIHByaXZhdGVfa2V5OgogICAgICAgIFRoZSBQcml2YXRlS2V5IHRvIGdlbmVyYXRlIHRoZSBzaWduYXR1cmUgd2l0aAoKICAgIDpwYXJhbSBkYXRhOgogICAgICAgIEEgYnl0ZSBzdHJpbmcgb2YgdGhlIGRhdGEgdGhlIHNpZ25hdHVyZSBpcyBmb3IKCiAgICA6cGFyYW0gaGFzaF9hbGdvcml0aG06CiAgICAgICAgQSB1bmljb2RlIHN0cmluZyBvZiAibWQ1IiwgInNoYTEiLCAic2hhMjI0IiwgInNoYTI1NiIsICJzaGEzODQiIG9yICJzaGE1MTIiCgogICAgOnJhaXNlczoKICAgICAgICBWYWx1ZUVycm9yIC0gd2hlbiBhbnkgb2YgdGhlIHBhcmFtZXRlcnMgY29udGFpbiBhbiBpbnZhbGlkIHZhbHVlCiAgICAgICAgVHlwZUVycm9yIC0gd2hlbiBhbnkgb2YgdGhlIHBhcmFtZXRlcnMgYXJlIG9mIHRoZSB3cm9uZyB0eXBlCiAgICAgICAgT1NFcnJvciAtIHdoZW4gYW4gZXJyb3IgaXMgcmV0dXJuZWQgYnkgdGhlIE9TIGNyeXB0byBsaWJyYXJ5CgogICAgOnJldHVybjoKICAgICAgICBBIGJ5dGUgc3RyaW5nIG9mIHRoZSBzaWduYXR1cmUKICAgICIiIgoKICAgIGlmIHByaXZhdGVfa2V5LmFsZ29yaXRobSAhPSAnZHNhJzoKICAgICAgICByYWlzZSBWYWx1ZUVycm9yKHByZXR0eV9tZXNzYWdlKAogICAgICAgICAgICAnJycKICAgICAgICAgICAgVGhlIGtleSBzcGVjaWZpZWQgaXMgbm90IGEgRFNBIHByaXZhdGUga2V5LCBidXQgJXMKICAgICAgICAgICAgJycnLAogICAgICAgICAgICBwcml2YXRlX2tleS5hbGdvcml0aG0udXBwZXIoKQogICAgICAgICkpCgogICAgcmV0dXJuIF9zaWduKHByaXZhdGVfa2V5LCBkYXRhLCBoYXNoX2FsZ29yaXRobSkKCgpkZWYgZWNkc2Ffc2lnbihwcml2YXRlX2tleSwgZGF0YSwgaGFzaF9hbGdvcml0aG0pOgogICAgIiIiCiAgICBHZW5lcmF0ZXMgYW4gRUNEU0Egc2lnbmF0dXJlCgogICAgOnBhcmFtIHByaXZhdGVfa2V5OgogICAgICAgIFRoZSBQcml2YXRlS2V5IHRvIGdlbmVyYXRlIHRoZSBzaWduYXR1cmUgd2l0aAoKICAgIDpwYXJhbSBkYXRhOgogICAgICAgIEEgYnl0ZSBzdHJpbmcgb2YgdGhlIGRhdGEgdGhlIHNpZ25hdHVyZSBpcyBmb3IKCiAgICA6cGFyYW0gaGFzaF9hbGdvcml0aG06CiAgICAgICAgQSB1bmljb2RlIHN0cmluZyBvZiAibWQ1IiwgInNoYTEiLCAic2hhMjI0IiwgInNoYTI1NiIsICJzaGEzODQiIG9yICJzaGE1MTIiCgogICAgOnJhaXNlczoKICAgICAgICBWYWx1ZUVycm9yIC0gd2hlbiBhbnkgb2YgdGhlIHBhcmFtZXRlcnMgY29udGFpbiBhbiBpbnZhbGlkIHZhbHVlCiAgICAgICAgVHlwZUVycm9yIC0gd2hlbiBhbnkgb2YgdGhlIHBhcmFtZXRlcnMgYXJlIG9mIHRoZSB3cm9uZyB0eXBlCiAgICAgICAgT1NFcnJvciAtIHdoZW4gYW4gZXJyb3IgaXMgcmV0dXJuZWQgYnkgdGhlIE9TIGNyeXB0byBsaWJyYXJ5CgogICAgOnJldHVybjoKICAgICAgICBBIGJ5dGUgc3RyaW5nIG9mIHRoZSBzaWduYXR1cmUKICAgICIiIgoKICAgIGlmIHByaXZhdGVfa2V5LmFsZ29yaXRobSAhPSAnZWMnOgogICAgICAgIHJhaXNlIFZhbHVlRXJyb3IocHJldHR5X21lc3NhZ2UoCiAgICAgICAgICAgICcnJwogICAgICAgICAgICBUaGUga2V5IHNwZWNpZmllZCBpcyBub3QgYW4gRUMgcHJpdmF0ZSBrZXksIGJ1dCAlcwogICAgICAgICAgICAnJycsCiAgICAgICAgICAgIHByaXZhdGVfa2V5LmFsZ29yaXRobS51cHBlcigpCiAgICAgICAgKSkKCiAgICByZXR1cm4gX3NpZ24ocHJpdmF0ZV9rZXksIGRhdGEsIGhhc2hfYWxnb3JpdGhtKQoKCmRlZiBfc2lnbihwcml2YXRlX2tleSwgZGF0YSwgaGFzaF9hbGdvcml0aG0sIHJzYV9wc3NfcGFkZGluZz1GYWxzZSk6CiAgICAiIiIKICAgIEdlbmVyYXRlcyBhbiBSU0EsIERTQSBvciBFQ0RTQSBzaWduYXR1cmUKCiAgICA6cGFyYW0gcHJpdmF0ZV9rZXk6CiAgICAgICAgVGhlIFByaXZhdGVLZXkgdG8gZ2VuZXJhdGUgdGhlIHNpZ25hdHVyZSB3aXRoCgogICAgOnBhcmFtIGRhdGE6CiAgICAgICAgQSBieXRlIHN0cmluZyBvZiB0aGUgZGF0YSB0aGUgc2lnbmF0dXJlIGlzIGZvcgoKICAgIDpwYXJhbSBoYXNoX2FsZ29yaXRobToKICAgICAgICBBIHVuaWNvZGUgc3RyaW5nIG9mICJtZDUiLCAic2hhMSIsICJzaGEyMjQiLCAic2hhMjU2IiwgInNoYTM4NCIgb3IgInNoYTUxMiIKCiAgICA6cGFyYW0gcnNhX3Bzc19wYWRkaW5nOgogICAgICAgIElmIHRoZSBwcml2YXRlX2tleSBpcyBhbiBSU0Ega2V5LCB0aGlzIGVuYWJsZXMgUFNTIHBhZGRpbmcKCiAgICA6cmFpc2VzOgogICAgICAgIFZhbHVlRXJyb3IgLSB3aGVuIGFueSBvZiB0aGUgcGFyYW1ldGVycyBjb250YWluIGFuIGludmFsaWQgdmFsdWUKICAgICAgICBUeXBlRXJyb3IgLSB3aGVuIGFueSBvZiB0aGUgcGFyYW1ldGVycyBhcmUgb2YgdGhlIHdyb25nIHR5cGUKICAgICAgICBPU0Vycm9yIC0gd2hlbiBhbiBlcnJvciBpcyByZXR1cm5lZCBieSB0aGUgT1MgY3J5cHRvIGxpYnJhcnkKCiAgICA6cmV0dXJuOgogICAgICAgIEEgYnl0ZSBzdHJpbmcgb2YgdGhlIHNpZ25hdHVyZQogICAgIiIiCgogICAgaWYgbm90IGlzaW5zdGFuY2UocHJpdmF0ZV9rZXksIFByaXZhdGVLZXkpOgogICAgICAgIHJhaXNlIFR5cGVFcnJvcihwcmV0dHlfbWVzc2FnZSgKICAgICAgICAgICAgJycnCiAgICAgICAgICAgIHByaXZhdGVfa2V5IG11c3QgYmUgYW4gaW5zdGFuY2Ugb2YgUHJpdmF0ZUtleSwgbm90ICVzCiAgICAgICAgICAgICcnJywKICAgICAgICAgICAgdHlwZV9uYW1lKHByaXZhdGVfa2V5KQogICAgICAgICkpCgogICAgaWYgbm90IGlzaW5zdGFuY2UoZGF0YSwgYnl0ZV9jbHMpOgogICAgICAgIHJhaXNlIFR5cGVFcnJvcihwcmV0dHlfbWVzc2FnZSgKICAgICAgICAgICAgJycnCiAgICAgICAgICAgIGRhdGEgbXVzdCBiZSBhIGJ5dGUgc3RyaW5nLCBub3QgJXMKICAgICAgICAgICAgJycnLAogICAgICAgICAgICB0eXBlX25hbWUoZGF0YSkKICAgICAgICApKQoKICAgIHBrZXlfYWxnID0gcHJpdmF0ZV9rZXkuYWxnb3JpdGhtCiAgICBwa2V5X2lzX3JzYSA9IHBrZXlfYWxnID09ICdyc2EnIG9yIHBrZXlfYWxnID09ICdyc2Fzc2FfcHNzJwoKICAgIHZhbGlkX2hhc2hfYWxnb3JpdGhtcyA9IHNldChbJ21kNScsICdzaGExJywgJ3NoYTIyNCcsICdzaGEyNTYnLCAnc2hhMzg0JywgJ3NoYTUxMiddKQogICAgaWYgcGtleV9hbGcgPT0gJ3JzYScgYW5kIG5vdCByc2FfcHNzX3BhZGRpbmc6CiAgICAgICAgdmFsaWRfaGFzaF9hbGdvcml0aG1zIHw9IHNldChbJ3JhdyddKQoKICAgIGlmIGhhc2hfYWxnb3JpdGhtIG5vdCBpbiB2YWxpZF9oYXNoX2FsZ29yaXRobXM6CiAgICAgICAgdmFsaWRfaGFzaF9hbGdvcml0aG1zX2Vycm9yID0gJyJtZDUiLCAic2hhMSIsICJzaGEyMjQiLCAic2hhMjU2IiwgInNoYTM4NCIsICJzaGE1MTIiJwogICAgICAgIGlmIHBrZXlfaXNfcnNhIGFuZCBub3QgcnNhX3Bzc19wYWRkaW5nOgogICAgICAgICAgICB2YWxpZF9oYXNoX2FsZ29yaXRobXNfZXJyb3IgKz0gJywgInJhdyInCiAgICAgICAgcmFpc2UgVmFsdWVFcnJvcihwcmV0dHlfbWVzc2FnZSgKICAgICAgICAgICAgJycnCiAgICAgICAgICAgIGhhc2hfYWxnb3JpdGhtIG11c3QgYmUgb25lIG9mICVzLCBub3QgJXMKICAgICAgICAgICAgJycnLAogICAgICAgICAgICB2YWxpZF9oYXNoX2FsZ29yaXRobXNfZXJyb3IsCiAgICAgICAgICAgIHJlcHIoaGFzaF9hbGdvcml0aG0pCiAgICAgICAgKSkKCiAgICBpZiBub3QgcGtleV9pc19yc2EgYW5kIHJzYV9wc3NfcGFkZGluZzoKICAgICAgICByYWlzZSBWYWx1ZUVycm9yKHByZXR0eV9tZXNzYWdlKAogICAgICAgICAgICAnJycKICAgICAgICAgICAgUFNTIHBhZGRpbmcgY2FuIG9ubHkgYmUgdXNlZCB3aXRoIFJTQSBrZXlzIC0gdGhlIGtleSBwcm92aWRlZCBpcyBhCiAgICAgICAgICAgICVzIGtleQogICAgICAgICAgICAnJycsCiAgICAgICAgICAgIHBrZXlfYWxnLnVwcGVyKCkKICAgICAgICApKQoKICAgIGlmIHBrZXlfaXNfcnNhIGFuZCBoYXNoX2FsZ29yaXRobSA9PSAncmF3JzoKICAgICAgICBpZiBsZW4oZGF0YSkgPiBwcml2YXRlX2tleS5ieXRlX3NpemUgLSAxMToKICAgICAgICAgICAgcmFpc2UgVmFsdWVFcnJvcihwcmV0dHlfbWVzc2FnZSgKICAgICAgICAgICAgICAgICcnJwogICAgICAgICAgICAgICAgZGF0YSBtdXN0IGJlIDExIGJ5dGVzIHNob3J0ZXIgdGhhbiB0aGUga2V5IHNpemUgd2hlbgogICAgICAgICAgICAgICAgaGFzaF9hbGdvcml0aG0gaXMgInJhdyIgLSBrZXkgc2l6ZSBpcyAlcyBieXRlcywgYnV0IGRhdGEgaXMKICAgICAgICAgICAgICAgICVzIGJ5dGVzIGxvbmcKICAgICAgICAgICAgICAgICcnJywKICAgICAgICAgICAgICAgIHByaXZhdGVfa2V5LmJ5dGVfc2l6ZSwKICAgICAgICAgICAgICAgIGxlbihkYXRhKQogICAgICAgICAgICApKQoKICAgICAgICByc2EgPSBOb25lCgogICAgICAgIHRyeToKICAgICAgICAgICAgcnNhID0gbGliY3J5cHRvLkVWUF9QS0VZX2dldDFfUlNBKHByaXZhdGVfa2V5LmV2cF9wa2V5KQogICAgICAgICAgICBpZiBpc19udWxsKHJzYSk6CiAgICAgICAgICAgICAgICBoYW5kbGVfb3BlbnNzbF9lcnJvcigwKQoKICAgICAgICAgICAgYnVmZmVyX3NpemUgPSBfZXZwX3BrZXlfZ2V0X3NpemUocHJpdmF0ZV9rZXkuZXZwX3BrZXkpCgogICAgICAgICAgICBzaWduYXR1cmVfYnVmZmVyID0gYnVmZmVyX2Zyb21fYnl0ZXMoYnVmZmVyX3NpemUpCiAgICAgICAgICAgIHNpZ25hdHVyZV9sZW5ndGggPSBsaWJjcnlwdG8uUlNBX3ByaXZhdGVfZW5jcnlwdCgKICAgICAgICAgICAgICAgIGxlbihkYXRhKSwKICAgICAgICAgICAgICAgIGRhdGEsCiAgICAgICAgICAgICAgICBzaWduYXR1cmVfYnVmZmVyLAogICAgICAgICAgICAgICAgcnNhLAogICAgICAgICAgICAgICAgTGliY3J5cHRvQ29uc3QuUlNBX1BLQ1MxX1BBRERJTkcKICAgICAgICAgICAgKQogICAgICAgICAgICBoYW5kbGVfb3BlbnNzbF9lcnJvcihzaWduYXR1cmVfbGVuZ3RoKQoKICAgICAgICAgICAgcmV0dXJuIGJ5dGVzX2Zyb21fYnVmZmVyKHNpZ25hdHVyZV9idWZmZXIsIHNpZ25hdHVyZV9sZW5ndGgpCgogICAgICAgIGZpbmFsbHk6CiAgICAgICAgICAgIGlmIHJzYToKICAgICAgICAgICAgICAgIGxpYmNyeXB0by5SU0FfZnJlZShyc2EpCgogICAgZXZwX21kX2N0eCA9IE5vbmUKICAgIHJzYSA9IE5vbmUKICAgIGRzYSA9IE5vbmUKICAgIGRzYV9zaWcgPSBOb25lCiAgICBlY19rZXkgPSBOb25lCiAgICBlY2RzYV9zaWcgPSBOb25lCgogICAgdHJ5OgogICAgICAgIGlmIGxpYmNyeXB0b192ZXJzaW9uX2luZm8gPCAoMSwgMSk6CiAgICAgICAgICAgIGV2cF9tZF9jdHggPSBsaWJjcnlwdG8uRVZQX01EX0NUWF9jcmVhdGUoKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGV2cF9tZF9jdHggPSBsaWJjcnlwdG8uRVZQX01EX0NUWF9uZXcoKQoKICAgICAgICBldnBfbWQgPSB7CiAgICAgICAgICAgICdtZDUnOiBsaWJjcnlwdG8uRVZQX21kNSwKICAgICAgICAgICAgJ3NoYTEnOiBsaWJjcnlwdG8uRVZQX3NoYTEsCiAgICAgICAgICAgICdzaGEyMjQnOiBsaWJjcnlwdG8uRVZQX3NoYTIyNCwKICAgICAgICAgICAgJ3NoYTI1Nic6IGxpYmNyeXB0by5FVlBfc2hhMjU2LAogICAgICAgICAgICAnc2hhMzg0JzogbGliY3J5cHRvLkVWUF9zaGEzODQsCiAgICAgICAgICAgICdzaGE1MTInOiBsaWJjcnlwdG8uRVZQX3NoYTUxMgogICAgICAgIH1baGFzaF9hbGdvcml0aG1dKCkKCiAgICAgICAgaWYgbGliY3J5cHRvX3ZlcnNpb25faW5mbyA8ICgxLCk6CiAgICAgICAgICAgIGlmIHBrZXlfaXNfcnNhIGFuZCByc2FfcHNzX3BhZGRpbmc6CiAgICAgICAgICAgICAgICBkaWdlc3QgPSBnZXRhdHRyKGhhc2hsaWIsIGhhc2hfYWxnb3JpdGhtKShkYXRhKS5kaWdlc3QoKQoKICAgICAgICAgICAgICAgIHJzYSA9IGxpYmNyeXB0by5FVlBfUEtFWV9nZXQxX1JTQShwcml2YXRlX2tleS5ldnBfcGtleSkKICAgICAgICAgICAgICAgIGlmIGlzX251bGwocnNhKToKICAgICAgICAgICAgICAgICAgICBoYW5kbGVfb3BlbnNzbF9lcnJvcigwKQoKICAgICAgICAgICAgICAgIGJ1ZmZlcl9zaXplID0gX2V2cF9wa2V5X2dldF9zaXplKHByaXZhdGVfa2V5LmV2cF9wa2V5KQogICAgICAgICAgICAgICAgZW1fYnVmZmVyID0gYnVmZmVyX2Zyb21fYnl0ZXMoYnVmZmVyX3NpemUpCiAgICAgICAgICAgICAgICByZXMgPSBsaWJjcnlwdG8uUlNBX3BhZGRpbmdfYWRkX1BLQ1MxX1BTUygKICAgICAgICAgICAgICAgICAgICByc2EsCiAgICAgICAgICAgICAgICAgICAgZW1fYnVmZmVyLAogICAgICAgICAgICAgICAgICAgIGRpZ2VzdCwKICAgICAgICAgICAgICAgICAgICBldnBfbWQsCiAgICAgICAgICAgICAgICAgICAgTGliY3J5cHRvQ29uc3QuRVZQX01EX0NUWF9GTEFHX1BTU19NRExFTgogICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgaGFuZGxlX29wZW5zc2xfZXJyb3IocmVzKQoKICAgICAgICAgICAgICAgIHNpZ25hdHVyZV9idWZmZXIgPSBidWZmZXJfZnJvbV9ieXRlcyhidWZmZXJfc2l6ZSkKICAgICAgICAgICAgICAgIHNpZ25hdHVyZV9sZW5ndGggPSBsaWJjcnlwdG8uUlNBX3ByaXZhdGVfZW5jcnlwdCgKICAgICAgICAgICAgICAgICAgICBidWZmZXJfc2l6ZSwKICAgICAgICAgICAgICAgICAgICBlbV9idWZmZXIsCiAgICAgICAgICAgICAgICAgICAgc2lnbmF0dXJlX2J1ZmZlciwKICAgICAgICAgICAgICAgICAgICByc2EsCiAgICAgICAgICAgICAgICAgICAgTGliY3J5cHRvQ29uc3QuUlNBX05PX1BBRERJTkcKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgIGhhbmRsZV9vcGVuc3NsX2Vycm9yKHNpZ25hdHVyZV9sZW5ndGgpCgogICAgICAgICAgICBlbGlmIHBrZXlfaXNfcnNhOgogICAgICAgICAgICAgICAgYnVmZmVyX3NpemUgPSBfZXZwX3BrZXlfZ2V0X3NpemUocHJpdmF0ZV9rZXkuZXZwX3BrZXkpCiAgICAgICAgICAgICAgICBzaWduYXR1cmVfYnVmZmVyID0gYnVmZmVyX2Zyb21fYnl0ZXMoYnVmZmVyX3NpemUpCiAgICAgICAgICAgICAgICBzaWduYXR1cmVfbGVuZ3RoID0gbmV3KGxpYmNyeXB0bywgJ3Vuc2lnbmVkIGludCAqJykKCiAgICAgICAgICAgICAgICByZXMgPSBsaWJjcnlwdG8uRVZQX0RpZ2VzdEluaXRfZXgoZXZwX21kX2N0eCwgZXZwX21kLCBudWxsKCkpCiAgICAgICAgICAgICAgICBoYW5kbGVfb3BlbnNzbF9lcnJvcihyZXMpCgogICAgICAgICAgICAgICAgcmVzID0gbGliY3J5cHRvLkVWUF9EaWdlc3RVcGRhdGUoZXZwX21kX2N0eCwgZGF0YSwgbGVuKGRhdGEpKQogICAgICAgICAgICAgICAgaGFuZGxlX29wZW5zc2xfZXJyb3IocmVzKQoKICAgICAgICAgICAgICAgIHJlcyA9IGxpYmNyeXB0by5FVlBfU2lnbkZpbmFsKAogICAgICAgICAgICAgICAgICAgIGV2cF9tZF9jdHgsCiAgICAgICAgICAgICAgICAgICAgc2lnbmF0dXJlX2J1ZmZlciwKICAgICAgICAgICAgICAgICAgICBzaWduYXR1cmVfbGVuZ3RoLAogICAgICAgICAgICAgICAgICAgIHByaXZhdGVfa2V5LmV2cF9wa2V5CiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICBoYW5kbGVfb3BlbnNzbF9lcnJvcihyZXMpCgogICAgICAgICAgICAgICAgc2lnbmF0dXJlX2xlbmd0aCA9IGRlcmVmKHNpZ25hdHVyZV9sZW5ndGgpCgogICAgICAgICAgICBlbGlmIHBrZXlfYWxnID09ICdkc2EnOgogICAgICAgICAgICAgICAgZGlnZXN0ID0gZ2V0YXR0cihoYXNobGliLCBoYXNoX2FsZ29yaXRobSkoZGF0YSkuZGlnZXN0KCkKCiAgICAgICAgICAgICAgICBkc2EgPSBsaWJjcnlwdG8uRVZQX1BLRVlfZ2V0MV9EU0EocHJpdmF0ZV9rZXkuZXZwX3BrZXkpCiAgICAgICAgICAgICAgICBpZiBpc19udWxsKGRzYSk6CiAgICAgICAgICAgICAgICAgICAgaGFuZGxlX29wZW5zc2xfZXJyb3IoMCkKCiAgICAgICAgICAgICAgICBkc2Ffc2lnID0gbGliY3J5cHRvLkRTQV9kb19zaWduKGRpZ2VzdCwgbGVuKGRpZ2VzdCksIGRzYSkKICAgICAgICAgICAgICAgIGlmIGlzX251bGwoZHNhX3NpZyk6CiAgICAgICAgICAgICAgICAgICAgaGFuZGxlX29wZW5zc2xfZXJyb3IoMCkKCiAgICAgICAgICAgICAgICBidWZmZXJfc2l6ZSA9IGxpYmNyeXB0by5pMmRfRFNBX1NJRyhkc2Ffc2lnLCBudWxsKCkpCiAgICAgICAgICAgICAgICBzaWduYXR1cmVfYnVmZmVyID0gYnVmZmVyX2Zyb21fYnl0ZXMoYnVmZmVyX3NpemUpCiAgICAgICAgICAgICAgICBzaWduYXR1cmVfcG9pbnRlciA9IGJ1ZmZlcl9wb2ludGVyKHNpZ25hdHVyZV9idWZmZXIpCiAgICAgICAgICAgICAgICBzaWduYXR1cmVfbGVuZ3RoID0gbGliY3J5cHRvLmkyZF9EU0FfU0lHKGRzYV9zaWcsIHNpZ25hdHVyZV9wb2ludGVyKQogICAgICAgICAgICAgICAgaGFuZGxlX29wZW5zc2xfZXJyb3Ioc2lnbmF0dXJlX2xlbmd0aCkKCiAgICAgICAgICAgIGVsaWYgcGtleV9hbGcgPT0gJ2VjJzoKICAgICAgICAgICAgICAgIGRpZ2VzdCA9IGdldGF0dHIoaGFzaGxpYiwgaGFzaF9hbGdvcml0aG0pKGRhdGEpLmRpZ2VzdCgpCgogICAgICAgICAgICAgICAgZWNfa2V5ID0gbGliY3J5cHRvLkVWUF9QS0VZX2dldDFfRUNfS0VZKHByaXZhdGVfa2V5LmV2cF9wa2V5KQogICAgICAgICAgICAgICAgaWYgaXNfbnVsbChlY19rZXkpOgogICAgICAgICAgICAgICAgICAgIGhhbmRsZV9vcGVuc3NsX2Vycm9yKDApCgogICAgICAgICAgICAgICAgZWNkc2Ffc2lnID0gbGliY3J5cHRvLkVDRFNBX2RvX3NpZ24oZGlnZXN0LCBsZW4oZGlnZXN0KSwgZWNfa2V5KQogICAgICAgICAgICAgICAgaWYgaXNfbnVsbChlY2RzYV9zaWcpOgogICAgICAgICAgICAgICAgICAgIGhhbmRsZV9vcGVuc3NsX2Vycm9yKDApCgogICAgICAgICAgICAgICAgYnVmZmVyX3NpemUgPSBsaWJjcnlwdG8uaTJkX0VDRFNBX1NJRyhlY2RzYV9zaWcsIG51bGwoKSkKICAgICAgICAgICAgICAgIHNpZ25hdHVyZV9idWZmZXIgPSBidWZmZXJfZnJvbV9ieXRlcyhidWZmZXJfc2l6ZSkKICAgICAgICAgICAgICAgIHNpZ25hdHVyZV9wb2ludGVyID0gYnVmZmVyX3BvaW50ZXIoc2lnbmF0dXJlX2J1ZmZlcikKICAgICAgICAgICAgICAgIHNpZ25hdHVyZV9sZW5ndGggPSBsaWJjcnlwdG8uaTJkX0VDRFNBX1NJRyhlY2RzYV9zaWcsIHNpZ25hdHVyZV9wb2ludGVyKQogICAgICAgICAgICAgICAgaGFuZGxlX29wZW5zc2xfZXJyb3Ioc2lnbmF0dXJlX2xlbmd0aCkKCiAgICAgICAgZWxzZToKICAgICAgICAgICAgYnVmZmVyX3NpemUgPSBfZXZwX3BrZXlfZ2V0X3NpemUocHJpdmF0ZV9rZXkuZXZwX3BrZXkpCiAgICAgICAgICAgIHNpZ25hdHVyZV9idWZmZXIgPSBidWZmZXJfZnJvbV9ieXRlcyhidWZmZXJfc2l6ZSkKICAgICAgICAgICAgc2lnbmF0dXJlX2xlbmd0aCA9IG5ldyhsaWJjcnlwdG8sICdzaXplX3QgKicsIGJ1ZmZlcl9zaXplKQoKICAgICAgICAgICAgZXZwX3BrZXlfY3R4X3BvaW50ZXJfcG9pbnRlciA9IG5ldyhsaWJjcnlwdG8sICdFVlBfUEtFWV9DVFggKionKQogICAgICAgICAgICByZXMgPSBsaWJjcnlwdG8uRVZQX0RpZ2VzdFNpZ25Jbml0KAogICAgICAgICAgICAgICAgZXZwX21kX2N0eCwKICAgICAgICAgICAgICAgIGV2cF9wa2V5X2N0eF9wb2ludGVyX3BvaW50ZXIsCiAgICAgICAgICAgICAgICBldnBfbWQsCiAgICAgICAgICAgICAgICBudWxsKCksCiAgICAgICAgICAgICAgICBwcml2YXRlX2tleS5ldnBfcGtleQogICAgICAgICAgICApCiAgICAgICAgICAgIGhhbmRsZV9vcGVuc3NsX2Vycm9yKHJlcykKICAgICAgICAgICAgZXZwX3BrZXlfY3R4X3BvaW50ZXIgPSB1bndyYXAoZXZwX3BrZXlfY3R4X3BvaW50ZXJfcG9pbnRlcikKCiAgICAgICAgICAgIGlmIHJzYV9wc3NfcGFkZGluZzoKICAgICAgICAgICAgICAgICMgRW5hYmxlIFBTUyBwYWRkaW5nCiAgICAgICAgICAgICAgICByZXMgPSBsaWJjcnlwdG8uRVZQX1BLRVlfQ1RYX2N0cmwoCiAgICAgICAgICAgICAgICAgICAgZXZwX3BrZXlfY3R4X3BvaW50ZXIsCiAgICAgICAgICAgICAgICAgICAgTGliY3J5cHRvQ29uc3QuRVZQX1BLRVlfUlNBLAogICAgICAgICAgICAgICAgICAgIC0xLCAgIyBBbGwgb3BlcmF0aW9ucwogICAgICAgICAgICAgICAgICAgIExpYmNyeXB0b0NvbnN0LkVWUF9QS0VZX0NUUkxfUlNBX1BBRERJTkcsCiAgICAgICAgICAgICAgICAgICAgTGliY3J5cHRvQ29uc3QuUlNBX1BLQ1MxX1BTU19QQURESU5HLAogICAgICAgICAgICAgICAgICAgIG51bGwoKQogICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgaGFuZGxlX29wZW5zc2xfZXJyb3IocmVzKQoKICAgICAgICAgICAgICAgICMgVXNlIHRoZSBoYXNoIGFsZ29yaXRobSBvdXRwdXQgbGVuZ3RoIGFzIHRoZSBzYWx0IGxlbmd0aAogICAgICAgICAgICAgICAgaWYgbGliY3J5cHRvX3ZlcnNpb25faW5mbyA8ICgzLCAwKToKICAgICAgICAgICAgICAgICAgICByZXMgPSBsaWJjcnlwdG8uRVZQX1BLRVlfQ1RYX2N0cmwoCiAgICAgICAgICAgICAgICAgICAgICAgIGV2cF9wa2V5X2N0eF9wb2ludGVyLAogICAgICAgICAgICAgICAgICAgICAgICBMaWJjcnlwdG9Db25zdC5FVlBfUEtFWV9SU0EsCiAgICAgICAgICAgICAgICAgICAgICAgIExpYmNyeXB0b0NvbnN0LkVWUF9QS0VZX09QX1NJR04gfCBMaWJjcnlwdG9Db25zdC5FVlBfUEtFWV9PUF9WRVJJRlksCiAgICAgICAgICAgICAgICAgICAgICAgIExpYmNyeXB0b0NvbnN0LkVWUF9QS0VZX0NUUkxfUlNBX1BTU19TQUxUTEVOLAogICAgICAgICAgICAgICAgICAgICAgICAtMSwKICAgICAgICAgICAgICAgICAgICAgICAgbnVsbCgpCiAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICAgIGhhbmRsZV9vcGVuc3NsX2Vycm9yKHJlcykKCiAgICAgICAgICAgIHJlcyA9IGxpYmNyeXB0by5FVlBfRGlnZXN0VXBkYXRlKGV2cF9tZF9jdHgsIGRhdGEsIGxlbihkYXRhKSkKICAgICAgICAgICAgaGFuZGxlX29wZW5zc2xfZXJyb3IocmVzKQoKICAgICAgICAgICAgcmVzID0gbGliY3J5cHRvLkVWUF9EaWdlc3RTaWduRmluYWwoZXZwX21kX2N0eCwgc2lnbmF0dXJlX2J1ZmZlciwgc2lnbmF0dXJlX2xlbmd0aCkKICAgICAgICAgICAgaGFuZGxlX29wZW5zc2xfZXJyb3IocmVzKQoKICAgICAgICAgICAgc2lnbmF0dXJlX2xlbmd0aCA9IGRlcmVmKHNpZ25hdHVyZV9sZW5ndGgpCgogICAgICAgIHJldHVybiBieXRlc19mcm9tX2J1ZmZlcihzaWduYXR1cmVfYnVmZmVyLCBzaWduYXR1cmVfbGVuZ3RoKQoKICAgIGZpbmFsbHk6CiAgICAgICAgaWYgZXZwX21kX2N0eDoKICAgICAgICAgICAgaWYgbGliY3J5cHRvX3ZlcnNpb25faW5mbyA8ICgxLCAxKToKICAgICAgICAgICAgICAgIGxpYmNyeXB0by5FVlBfTURfQ1RYX2Rlc3Ryb3koZXZwX21kX2N0eCkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGxpYmNyeXB0by5FVlBfTURfQ1RYX2ZyZWUoZXZwX21kX2N0eCkKICAgICAgICBpZiByc2E6CiAgICAgICAgICAgIGxpYmNyeXB0by5SU0FfZnJlZShyc2EpCiAgICAgICAgaWYgZHNhOgogICAgICAgICAgICBsaWJjcnlwdG8uRFNBX2ZyZWUoZHNhKQogICAgICAgIGlmIGRzYV9zaWc6CiAgICAgICAgICAgIGxpYmNyeXB0by5EU0FfU0lHX2ZyZWUoZHNhX3NpZykKICAgICAgICBpZiBlY19rZXk6CiAgICAgICAgICAgIGxpYmNyeXB0by5FQ19LRVlfZnJlZShlY19rZXkpCiAgICAgICAgaWYgZWNkc2Ffc2lnOgogICAgICAgICAgICBsaWJjcnlwdG8uRUNEU0FfU0lHX2ZyZWUoZWNkc2Ffc2lnKQo=
