statistics:
  total_files: 1
  skipped_files: 0.0
  processed_objects: 1
  malicious_objects: 0
details:
- path: .repo_cache/malicious_repos/pypi_malregistry/discord-py-v13/1.3/discord_py_v13-1.3-py3-none-any/discord-py-v13/shard.py
  contents:
  - name: AutoShardedClient.launch_shard
    score: 0.0
    code: |-
      async def launch_shard(self, gateway, shard_id, *, initial=False):
              try:
                  coro = DiscordWebSocket.from_client(self, initial=initial, gateway=gateway, shard_id=shard_id)
                  ws = await asyncio.wait_for(coro, timeout=180.0)
              except Exception:
                  log.exception('Failed to connect for shard_id: %s. Retrying...', shard_id)
                  await asyncio.sleep(5.0)
                  return await self.launch_shard(gateway, shard_id)

              # keep reading the shard while others connect
              self.__shards[shard_id] = ret = Shard(ws, self, self.__queue.put_nowait)
              ret.launch()
    tokens: return_generator pop_top resume nop load_global STRING_BASE64_LEN_S_ENT_HIGH load_attr from_client load_fast self load_fast initial load_fast gateway load_fast shard_id kw_names gateway initial shard_id call store_fast coro load_global asyncio load_attr wait_for load_fast coro load_const FLOAT kw_names timeout call get_awaitable load_const send TO_NUMBER yield_value resume jump_backward_no_interrupt TO_NUMBER end_send store_fast ws load_global Shard load_fast ws load_fast self load_fast self load_attr STRING_LEN_S_ENT_HIGH load_attr put_nowait call copy load_fast self load_attr STRING_LEN_S_ENT_HIGH load_fast shard_id store_subscr store_fast ret load_fast ret load_attr launch call pop_top return_const None cleanup_throw jump_backward TO_NUMBER push_exc_info load_global Exception check_exc_match pop_jump_if_false TO_NUMBER pop_top load_global log load_attr exception load_const STRING_LEN_S_ENT_HIGH load_fast shard_id call pop_top load_global asyncio load_attr sleep load_const FLOAT call get_awaitable load_const send TO_NUMBER yield_value resume jump_backward_no_interrupt TO_NUMBER cleanup_throw end_send pop_top load_fast self load_attr launch_shard load_fast gateway load_fast shard_id call get_awaitable load_const send TO_NUMBER yield_value resume jump_backward_no_interrupt TO_NUMBER cleanup_throw end_send swap pop_except return_value reraise copy pop_except reraise call_intrinsic_1 INTRINSIC_STOPITERATION_ERROR reraise
    hash: 4132613d51dab40c5154a6bc30dae3e87325a57032970e5b5bb4646c567415cf
sources:
  .repo_cache/malicious_repos/pypi_malregistry/discord-py-v13/1.3/discord_py_v13-1.3-py3-none-any/discord-py-v13/shard.py: IyAtKi0gY29kaW5nOiB1dGYtOCAtKi0KCiIiIgpUaGUgTUlUIExpY2Vuc2UgKE1JVCkKCkNvcHlyaWdodCAoYykgMjAxNS1wcmVzZW50IFJhcHB0egoKUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEKY29weSBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZSAiU29mdHdhcmUiKSwKdG8gZGVhbCBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbgp0aGUgcmlnaHRzIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwKYW5kL29yIHNlbGwgY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlClNvZnR3YXJlIGlzIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6CgpUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbgphbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KClRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTCk9SIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLApGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEUKQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUgpMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORwpGUk9NLCBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSCkRFQUxJTkdTIElOIFRIRSBTT0ZUV0FSRS4KIiIiCgppbXBvcnQgYXN5bmNpbwppbXBvcnQgaXRlcnRvb2xzCmltcG9ydCBsb2dnaW5nCgppbXBvcnQgYWlvaHR0cAoKZnJvbSAuc3RhdGUgaW1wb3J0IEF1dG9TaGFyZGVkQ29ubmVjdGlvblN0YXRlCmZyb20gLmNsaWVudCBpbXBvcnQgQ2xpZW50CmZyb20gLmJhY2tvZmYgaW1wb3J0IEV4cG9uZW50aWFsQmFja29mZgpmcm9tIC5nYXRld2F5IGltcG9ydCAqCmZyb20gLmVycm9ycyBpbXBvcnQgKAogICAgQ2xpZW50RXhjZXB0aW9uLAogICAgSW52YWxpZEFyZ3VtZW50LAogICAgSFRUUEV4Y2VwdGlvbiwKICAgIEdhdGV3YXlOb3RGb3VuZCwKICAgIENvbm5lY3Rpb25DbG9zZWQsCiAgICBQcml2aWxlZ2VkSW50ZW50c1JlcXVpcmVkLAopCgpmcm9tIC4gaW1wb3J0IHV0aWxzCmZyb20gLmVudW1zIGltcG9ydCBTdGF0dXMKCmxvZyA9IGxvZ2dpbmcuZ2V0TG9nZ2VyKF9fbmFtZV9fKQoKY2xhc3MgRXZlbnRUeXBlOgogICAgY2xvc2UgPSAwCiAgICByZWNvbm5lY3QgPSAxCiAgICByZXN1bWUgPSAyCiAgICBpZGVudGlmeSA9IDMKICAgIHRlcm1pbmF0ZSA9IDQKICAgIGNsZWFuX2Nsb3NlID0gNQoKY2xhc3MgRXZlbnRJdGVtOgogICAgX19zbG90c19fID0gKCd0eXBlJywgJ3NoYXJkJywgJ2Vycm9yJykKCiAgICBkZWYgX19pbml0X18oc2VsZiwgZXR5cGUsIHNoYXJkLCBlcnJvcik6CiAgICAgICAgc2VsZi50eXBlID0gZXR5cGUKICAgICAgICBzZWxmLnNoYXJkID0gc2hhcmQKICAgICAgICBzZWxmLmVycm9yID0gZXJyb3IKCiAgICBkZWYgX19sdF9fKHNlbGYsIG90aGVyKToKICAgICAgICBpZiBub3QgaXNpbnN0YW5jZShvdGhlciwgRXZlbnRJdGVtKToKICAgICAgICAgICAgcmV0dXJuIE5vdEltcGxlbWVudGVkCiAgICAgICAgcmV0dXJuIHNlbGYudHlwZSA8IG90aGVyLnR5cGUKCiAgICBkZWYgX19lcV9fKHNlbGYsIG90aGVyKToKICAgICAgICBpZiBub3QgaXNpbnN0YW5jZShvdGhlciwgRXZlbnRJdGVtKToKICAgICAgICAgICAgcmV0dXJuIE5vdEltcGxlbWVudGVkCiAgICAgICAgcmV0dXJuIHNlbGYudHlwZSA9PSBvdGhlci50eXBlCgogICAgZGVmIF9faGFzaF9fKHNlbGYpOgogICAgICAgIHJldHVybiBoYXNoKHNlbGYudHlwZSkKCmNsYXNzIFNoYXJkOgogICAgZGVmIF9faW5pdF9fKHNlbGYsIHdzLCBjbGllbnQsIHF1ZXVlX3B1dCk6CiAgICAgICAgc2VsZi53cyA9IHdzCiAgICAgICAgc2VsZi5fY2xpZW50ID0gY2xpZW50CiAgICAgICAgc2VsZi5fZGlzcGF0Y2ggPSBjbGllbnQuZGlzcGF0Y2gKICAgICAgICBzZWxmLl9xdWV1ZV9wdXQgPSBxdWV1ZV9wdXQKICAgICAgICBzZWxmLmxvb3AgPSBzZWxmLl9jbGllbnQubG9vcAogICAgICAgIHNlbGYuX2Rpc2Nvbm5lY3QgPSBGYWxzZQogICAgICAgIHNlbGYuX3JlY29ubmVjdCA9IGNsaWVudC5fcmVjb25uZWN0CiAgICAgICAgc2VsZi5fYmFja29mZiA9IEV4cG9uZW50aWFsQmFja29mZigpCiAgICAgICAgc2VsZi5fdGFzayA9IE5vbmUKICAgICAgICBzZWxmLl9oYW5kbGVkX2V4Y2VwdGlvbnMgPSAoCiAgICAgICAgICAgIE9TRXJyb3IsCiAgICAgICAgICAgIEhUVFBFeGNlcHRpb24sCiAgICAgICAgICAgIEdhdGV3YXlOb3RGb3VuZCwKICAgICAgICAgICAgQ29ubmVjdGlvbkNsb3NlZCwKICAgICAgICAgICAgYWlvaHR0cC5DbGllbnRFcnJvciwKICAgICAgICAgICAgYXN5bmNpby5UaW1lb3V0RXJyb3IsCiAgICAgICAgKQoKICAgIEBwcm9wZXJ0eQogICAgZGVmIGlkKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLndzLnNoYXJkX2lkCgogICAgZGVmIGxhdW5jaChzZWxmKToKICAgICAgICBzZWxmLl90YXNrID0gc2VsZi5sb29wLmNyZWF0ZV90YXNrKHNlbGYud29ya2VyKCkpCgogICAgZGVmIF9jYW5jZWxfdGFzayhzZWxmKToKICAgICAgICBpZiBzZWxmLl90YXNrIGlzIG5vdCBOb25lIGFuZCBub3Qgc2VsZi5fdGFzay5kb25lKCk6CiAgICAgICAgICAgIHNlbGYuX3Rhc2suY2FuY2VsKCkKCiAgICBhc3luYyBkZWYgY2xvc2Uoc2VsZik6CiAgICAgICAgc2VsZi5fY2FuY2VsX3Rhc2soKQogICAgICAgIGF3YWl0IHNlbGYud3MuY2xvc2UoY29kZT0xMDAwKQoKICAgIGFzeW5jIGRlZiBkaXNjb25uZWN0KHNlbGYpOgogICAgICAgIGF3YWl0IHNlbGYuY2xvc2UoKQogICAgICAgIHNlbGYuX2Rpc3BhdGNoKCdzaGFyZF9kaXNjb25uZWN0Jywgc2VsZi5pZCkKCiAgICBhc3luYyBkZWYgX2hhbmRsZV9kaXNjb25uZWN0KHNlbGYsIGUpOgogICAgICAgIHNlbGYuX2Rpc3BhdGNoKCdkaXNjb25uZWN0JykKICAgICAgICBzZWxmLl9kaXNwYXRjaCgnc2hhcmRfZGlzY29ubmVjdCcsIHNlbGYuaWQpCiAgICAgICAgaWYgbm90IHNlbGYuX3JlY29ubmVjdDoKICAgICAgICAgICAgc2VsZi5fcXVldWVfcHV0KEV2ZW50SXRlbShFdmVudFR5cGUuY2xvc2UsIHNlbGYsIGUpKQogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgaWYgc2VsZi5fY2xpZW50LmlzX2Nsb3NlZCgpOgogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgaWYgaXNpbnN0YW5jZShlLCBPU0Vycm9yKSBhbmQgZS5lcnJubyBpbiAoNTQsIDEwMDU0KToKICAgICAgICAgICAgIyBJZiB3ZSBnZXQgQ29ubmVjdGlvbiByZXNldCBieSBwZWVyIHRoZW4gYWx3YXlzIHRyeSB0byBSRVNVTUUgdGhlIGNvbm5lY3Rpb24uCiAgICAgICAgICAgIGV4YyA9IFJlY29ubmVjdFdlYlNvY2tldChzZWxmLmlkLCByZXN1bWU9VHJ1ZSkKICAgICAgICAgICAgc2VsZi5fcXVldWVfcHV0KEV2ZW50SXRlbShFdmVudFR5cGUucmVzdW1lLCBzZWxmLCBleGMpKQogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgaWYgaXNpbnN0YW5jZShlLCBDb25uZWN0aW9uQ2xvc2VkKToKICAgICAgICAgICAgaWYgZS5jb2RlID09IDQwMTQ6CiAgICAgICAgICAgICAgICBzZWxmLl9xdWV1ZV9wdXQoRXZlbnRJdGVtKEV2ZW50VHlwZS50ZXJtaW5hdGUsIHNlbGYsIFByaXZpbGVnZWRJbnRlbnRzUmVxdWlyZWQoc2VsZi5pZCkpKQogICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgIGlmIGUuY29kZSAhPSAxMDAwOgogICAgICAgICAgICAgICAgc2VsZi5fcXVldWVfcHV0KEV2ZW50SXRlbShFdmVudFR5cGUuY2xvc2UsIHNlbGYsIGUpKQogICAgICAgICAgICAgICAgcmV0dXJuCgogICAgICAgIHJldHJ5ID0gc2VsZi5fYmFja29mZi5kZWxheSgpCiAgICAgICAgbG9nLmVycm9yKCdBdHRlbXB0aW5nIGEgcmVjb25uZWN0IGZvciBzaGFyZCBJRCAlcyBpbiAlLjJmcycsIHNlbGYuaWQsIHJldHJ5LCBleGNfaW5mbz1lKQogICAgICAgIGF3YWl0IGFzeW5jaW8uc2xlZXAocmV0cnkpCiAgICAgICAgc2VsZi5fcXVldWVfcHV0KEV2ZW50SXRlbShFdmVudFR5cGUucmVjb25uZWN0LCBzZWxmLCBlKSkKCiAgICBhc3luYyBkZWYgd29ya2VyKHNlbGYpOgogICAgICAgIHdoaWxlIG5vdCBzZWxmLl9jbGllbnQuaXNfY2xvc2VkKCk6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGF3YWl0IHNlbGYud3MucG9sbF9ldmVudCgpCiAgICAgICAgICAgIGV4Y2VwdCBSZWNvbm5lY3RXZWJTb2NrZXQgYXMgZToKICAgICAgICAgICAgICAgIGV0eXBlID0gRXZlbnRUeXBlLnJlc3VtZSBpZiBlLnJlc3VtZSBlbHNlIEV2ZW50VHlwZS5pZGVudGlmeQogICAgICAgICAgICAgICAgc2VsZi5fcXVldWVfcHV0KEV2ZW50SXRlbShldHlwZSwgc2VsZiwgZSkpCiAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICBleGNlcHQgc2VsZi5faGFuZGxlZF9leGNlcHRpb25zIGFzIGU6CiAgICAgICAgICAgICAgICBhd2FpdCBzZWxmLl9oYW5kbGVfZGlzY29ubmVjdChlKQogICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgZXhjZXB0IGFzeW5jaW8uQ2FuY2VsbGVkRXJyb3I6CiAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICBzZWxmLl9xdWV1ZV9wdXQoRXZlbnRJdGVtKEV2ZW50VHlwZS50ZXJtaW5hdGUsIHNlbGYsIGUpKQogICAgICAgICAgICAgICAgYnJlYWsKCiAgICBhc3luYyBkZWYgcmVpZGVudGlmeShzZWxmLCBleGMpOgogICAgICAgIHNlbGYuX2NhbmNlbF90YXNrKCkKICAgICAgICBzZWxmLl9kaXNwYXRjaCgnZGlzY29ubmVjdCcpCiAgICAgICAgc2VsZi5fZGlzcGF0Y2goJ3NoYXJkX2Rpc2Nvbm5lY3QnLCBzZWxmLmlkKQogICAgICAgIGxvZy5pbmZvKCdHb3QgYSByZXF1ZXN0IHRvICVzIHRoZSB3ZWJzb2NrZXQgYXQgU2hhcmQgSUQgJXMuJywgZXhjLm9wLCBzZWxmLmlkKQogICAgICAgIHRyeToKICAgICAgICAgICAgY29ybyA9IERpc2NvcmRXZWJTb2NrZXQuZnJvbV9jbGllbnQoc2VsZi5fY2xpZW50LCByZXN1bWU9ZXhjLnJlc3VtZSwgc2hhcmRfaWQ9c2VsZi5pZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2Vzc2lvbj1zZWxmLndzLnNlc3Npb25faWQsIHNlcXVlbmNlPXNlbGYud3Muc2VxdWVuY2UpCiAgICAgICAgICAgIHNlbGYud3MgPSBhd2FpdCBhc3luY2lvLndhaXRfZm9yKGNvcm8sIHRpbWVvdXQ9NjAuMCkKICAgICAgICBleGNlcHQgc2VsZi5faGFuZGxlZF9leGNlcHRpb25zIGFzIGU6CiAgICAgICAgICAgIGF3YWl0IHNlbGYuX2hhbmRsZV9kaXNjb25uZWN0KGUpCiAgICAgICAgZXhjZXB0IGFzeW5jaW8uQ2FuY2VsbGVkRXJyb3I6CiAgICAgICAgICAgIHJldHVybgogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgc2VsZi5fcXVldWVfcHV0KEV2ZW50SXRlbShFdmVudFR5cGUudGVybWluYXRlLCBzZWxmLCBlKSkKICAgICAgICBlbHNlOgogICAgICAgICAgICBzZWxmLmxhdW5jaCgpCgogICAgYXN5bmMgZGVmIHJlY29ubmVjdChzZWxmKToKICAgICAgICBzZWxmLl9jYW5jZWxfdGFzaygpCiAgICAgICAgdHJ5OgogICAgICAgICAgICBjb3JvID0gRGlzY29yZFdlYlNvY2tldC5mcm9tX2NsaWVudChzZWxmLl9jbGllbnQsIHNoYXJkX2lkPXNlbGYuaWQpCiAgICAgICAgICAgIHNlbGYud3MgPSBhd2FpdCBhc3luY2lvLndhaXRfZm9yKGNvcm8sIHRpbWVvdXQ9NjAuMCkKICAgICAgICBleGNlcHQgc2VsZi5faGFuZGxlZF9leGNlcHRpb25zIGFzIGU6CiAgICAgICAgICAgIGF3YWl0IHNlbGYuX2hhbmRsZV9kaXNjb25uZWN0KGUpCiAgICAgICAgZXhjZXB0IGFzeW5jaW8uQ2FuY2VsbGVkRXJyb3I6CiAgICAgICAgICAgIHJldHVybgogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgc2VsZi5fcXVldWVfcHV0KEV2ZW50SXRlbShFdmVudFR5cGUudGVybWluYXRlLCBzZWxmLCBlKSkKICAgICAgICBlbHNlOgogICAgICAgICAgICBzZWxmLmxhdW5jaCgpCgpjbGFzcyBTaGFyZEluZm86CiAgICAiIiJBIGNsYXNzIHRoYXQgZ2l2ZXMgaW5mb3JtYXRpb24gYW5kIGNvbnRyb2wgb3ZlciBhIHNwZWNpZmljIHNoYXJkLgoKICAgIFlvdSBjYW4gcmV0cmlldmUgdGhpcyBvYmplY3QgdmlhIDptZXRoOmBBdXRvU2hhcmRlZENsaWVudC5nZXRfc2hhcmRgCiAgICBvciA6YXR0cjpgQXV0b1NoYXJkZWRDbGllbnQuc2hhcmRzYC4KCiAgICAuLiB2ZXJzaW9uYWRkZWQ6OiAxLjQKCiAgICBBdHRyaWJ1dGVzCiAgICAtLS0tLS0tLS0tLS0KICAgIGlkOiA6Y2xhc3M6YGludGAKICAgICAgICBUaGUgc2hhcmQgSUQgZm9yIHRoaXMgc2hhcmQuCiAgICBzaGFyZF9jb3VudDogT3B0aW9uYWxbOmNsYXNzOmBpbnRgXQogICAgICAgIFRoZSBzaGFyZCBjb3VudCBmb3IgdGhpcyBjbHVzdGVyLiBJZiB0aGlzIGlzIGBgTm9uZWBgIHRoZW4gdGhlIGJvdCBoYXMgbm90IHN0YXJ0ZWQgeWV0LgogICAgIiIiCgogICAgX19zbG90c19fID0gKCdfcGFyZW50JywgJ2lkJywgJ3NoYXJkX2NvdW50JykKCiAgICBkZWYgX19pbml0X18oc2VsZiwgcGFyZW50LCBzaGFyZF9jb3VudCk6CiAgICAgICAgc2VsZi5fcGFyZW50ID0gcGFyZW50CiAgICAgICAgc2VsZi5pZCA9IHBhcmVudC5pZAogICAgICAgIHNlbGYuc2hhcmRfY291bnQgPSBzaGFyZF9jb3VudAoKICAgIGRlZiBpc19jbG9zZWQoc2VsZik6CiAgICAgICAgIiIiOmNsYXNzOmBib29sYDogV2hldGhlciB0aGUgc2hhcmQgY29ubmVjdGlvbiBpcyBjdXJyZW50bHkgY2xvc2VkLiIiIgogICAgICAgIHJldHVybiBub3Qgc2VsZi5fcGFyZW50LndzLm9wZW4KCiAgICBhc3luYyBkZWYgZGlzY29ubmVjdChzZWxmKToKICAgICAgICAiIiJ8Y29yb3wKCiAgICAgICAgRGlzY29ubmVjdHMgYSBzaGFyZC4gV2hlbiB0aGlzIGlzIGNhbGxlZCwgdGhlIHNoYXJkIGNvbm5lY3Rpb24gd2lsbCBubwogICAgICAgIGxvbmdlciBiZSBvcGVuLgoKICAgICAgICBJZiB0aGUgc2hhcmQgaXMgYWxyZWFkeSBkaXNjb25uZWN0ZWQgdGhpcyBkb2VzIG5vdGhpbmcuCiAgICAgICAgIiIiCiAgICAgICAgaWYgc2VsZi5pc19jbG9zZWQoKToKICAgICAgICAgICAgcmV0dXJuCgogICAgICAgIGF3YWl0IHNlbGYuX3BhcmVudC5kaXNjb25uZWN0KCkKCiAgICBhc3luYyBkZWYgcmVjb25uZWN0KHNlbGYpOgogICAgICAgICIiInxjb3JvfAoKICAgICAgICBEaXNjb25uZWN0cyBhbmQgdGhlbiBjb25uZWN0cyB0aGUgc2hhcmQgYWdhaW4uCiAgICAgICAgIiIiCiAgICAgICAgaWYgbm90IHNlbGYuaXNfY2xvc2VkKCk6CiAgICAgICAgICAgIGF3YWl0IHNlbGYuX3BhcmVudC5kaXNjb25uZWN0KCkKICAgICAgICBhd2FpdCBzZWxmLl9wYXJlbnQucmVjb25uZWN0KCkKCiAgICBhc3luYyBkZWYgY29ubmVjdChzZWxmKToKICAgICAgICAiIiJ8Y29yb3wKCiAgICAgICAgQ29ubmVjdHMgYSBzaGFyZC4gSWYgdGhlIHNoYXJkIGlzIGFscmVhZHkgY29ubmVjdGVkIHRoaXMgZG9lcyBub3RoaW5nLgogICAgICAgICIiIgogICAgICAgIGlmIG5vdCBzZWxmLmlzX2Nsb3NlZCgpOgogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgYXdhaXQgc2VsZi5fcGFyZW50LnJlY29ubmVjdCgpCgogICAgQHByb3BlcnR5CiAgICBkZWYgbGF0ZW5jeShzZWxmKToKICAgICAgICAiIiI6Y2xhc3M6YGZsb2F0YDogTWVhc3VyZXMgbGF0ZW5jeSBiZXR3ZWVuIGEgSEVBUlRCRUFUIGFuZCBhIEhFQVJUQkVBVF9BQ0sgaW4gc2Vjb25kcyBmb3IgdGhpcyBzaGFyZC4iIiIKICAgICAgICByZXR1cm4gc2VsZi5fcGFyZW50LndzLmxhdGVuY3kKCiAgICBkZWYgaXNfd3NfcmF0ZWxpbWl0ZWQoc2VsZik6CiAgICAgICAgIiIiOmNsYXNzOmBib29sYDogV2hldGhlciB0aGUgd2Vic29ja2V0IGlzIGN1cnJlbnRseSByYXRlIGxpbWl0ZWQuCgogICAgICAgIFRoaXMgY2FuIGJlIHVzZWZ1bCB0byBrbm93IHdoZW4gZGVjaWRpbmcgd2hldGhlciB5b3Ugc2hvdWxkIHF1ZXJ5IG1lbWJlcnMKICAgICAgICB1c2luZyBIVFRQIG9yIHZpYSB0aGUgZ2F0ZXdheS4KCiAgICAgICAgLi4gdmVyc2lvbmFkZGVkOjogMS42CiAgICAgICAgIiIiCiAgICAgICAgcmV0dXJuIHNlbGYuX3BhcmVudC53cy5pc19yYXRlbGltaXRlZCgpCgpjbGFzcyBBdXRvU2hhcmRlZENsaWVudChDbGllbnQpOgogICAgIiIiQSBjbGllbnQgc2ltaWxhciB0byA6Y2xhc3M6YENsaWVudGAgZXhjZXB0IGl0IGhhbmRsZXMgdGhlIGNvbXBsaWNhdGlvbnMKICAgIG9mIHNoYXJkaW5nIGZvciB0aGUgdXNlciBpbnRvIGEgbW9yZSBtYW5hZ2VhYmxlIGFuZCB0cmFuc3BhcmVudCBzaW5nbGUKICAgIHByb2Nlc3MgYm90LgoKICAgIFdoZW4gdXNpbmcgdGhpcyBjbGllbnQsIHlvdSB3aWxsIGJlIGFibGUgdG8gdXNlIGl0IGFzLWlmIGl0IHdhcyBhIHJlZ3VsYXIKICAgIDpjbGFzczpgQ2xpZW50YCB3aXRoIGEgc2luZ2xlIHNoYXJkIHdoZW4gaW1wbGVtZW50YXRpb24gd2lzZSBpbnRlcm5hbGx5IGl0CiAgICBpcyBzcGxpdCB1cCBpbnRvIG11bHRpcGxlIHNoYXJkcy4gVGhpcyBhbGxvd3MgeW91IHRvIG5vdCBoYXZlIHRvIGRlYWwgd2l0aAogICAgSVBDIG9yIG90aGVyIGNvbXBsaWNhdGVkIGluZnJhc3RydWN0dXJlLgoKICAgIEl0IGlzIHJlY29tbWVuZGVkIHRvIHVzZSB0aGlzIGNsaWVudCBvbmx5IGlmIHlvdSBoYXZlIHN1cnBhc3NlZCBhdCBsZWFzdAogICAgMTAwMCBndWlsZHMuCgogICAgSWYgbm8gOmF0dHI6YC5zaGFyZF9jb3VudGAgaXMgcHJvdmlkZWQsIHRoZW4gdGhlIGxpYnJhcnkgd2lsbCB1c2UgdGhlCiAgICBCb3QgR2F0ZXdheSBlbmRwb2ludCBjYWxsIHRvIGZpZ3VyZSBvdXQgaG93IG1hbnkgc2hhcmRzIHRvIHVzZS4KCiAgICBJZiBhIGBgc2hhcmRfaWRzYGAgcGFyYW1ldGVyIGlzIGdpdmVuLCB0aGVuIHRob3NlIHNoYXJkIElEcyB3aWxsIGJlIHVzZWQKICAgIHRvIGxhdW5jaCB0aGUgaW50ZXJuYWwgc2hhcmRzLiBOb3RlIHRoYXQgOmF0dHI6YC5zaGFyZF9jb3VudGAgbXVzdCBiZSBwcm92aWRlZAogICAgaWYgdGhpcyBpcyB1c2VkLiBCeSBkZWZhdWx0LCB3aGVuIG9taXR0ZWQsIHRoZSBjbGllbnQgd2lsbCBsYXVuY2ggc2hhcmRzIGZyb20KICAgIDAgdG8gYGBzaGFyZF9jb3VudCAtIDFgYC4KCiAgICBBdHRyaWJ1dGVzCiAgICAtLS0tLS0tLS0tLS0KICAgIHNoYXJkX2lkczogT3B0aW9uYWxbTGlzdFs6Y2xhc3M6YGludGBdXQogICAgICAgIEFuIG9wdGlvbmFsIGxpc3Qgb2Ygc2hhcmRfaWRzIHRvIGxhdW5jaCB0aGUgc2hhcmRzIHdpdGguCiAgICAiIiIKICAgIGRlZiBfX2luaXRfXyhzZWxmLCAqYXJncywgbG9vcD1Ob25lLCAqKmt3YXJncyk6CiAgICAgICAga3dhcmdzLnBvcCgnc2hhcmRfaWQnLCBOb25lKQogICAgICAgIHNlbGYuc2hhcmRfaWRzID0ga3dhcmdzLnBvcCgnc2hhcmRfaWRzJywgTm9uZSkKICAgICAgICBzdXBlcigpLl9faW5pdF9fKCphcmdzLCBsb29wPWxvb3AsICoqa3dhcmdzKQoKICAgICAgICBpZiBzZWxmLnNoYXJkX2lkcyBpcyBub3QgTm9uZToKICAgICAgICAgICAgaWYgc2VsZi5zaGFyZF9jb3VudCBpcyBOb25lOgogICAgICAgICAgICAgICAgcmFpc2UgQ2xpZW50RXhjZXB0aW9uKCdXaGVuIHBhc3NpbmcgbWFudWFsIHNoYXJkX2lkcywgeW91IG11c3QgcHJvdmlkZSBhIHNoYXJkX2NvdW50LicpCiAgICAgICAgICAgIGVsaWYgbm90IGlzaW5zdGFuY2Uoc2VsZi5zaGFyZF9pZHMsIChsaXN0LCB0dXBsZSkpOgogICAgICAgICAgICAgICAgcmFpc2UgQ2xpZW50RXhjZXB0aW9uKCdzaGFyZF9pZHMgcGFyYW1ldGVyIG11c3QgYmUgYSBsaXN0IG9yIGEgdHVwbGUuJykKCiAgICAgICAgIyBpbnN0ZWFkIG9mIGEgc2luZ2xlIHdlYnNvY2tldCwgd2UgaGF2ZSBtdWx0aXBsZQogICAgICAgICMgdGhlIGtleSBpcyB0aGUgc2hhcmRfaWQKICAgICAgICBzZWxmLl9fc2hhcmRzID0ge30KICAgICAgICBzZWxmLl9jb25uZWN0aW9uLl9nZXRfd2Vic29ja2V0ID0gc2VsZi5fZ2V0X3dlYnNvY2tldAogICAgICAgIHNlbGYuX2Nvbm5lY3Rpb24uX2dldF9jbGllbnQgPSBsYW1iZGE6IHNlbGYKICAgICAgICBzZWxmLl9fcXVldWUgPSBhc3luY2lvLlByaW9yaXR5UXVldWUoKQoKICAgIGRlZiBfZ2V0X3dlYnNvY2tldChzZWxmLCBndWlsZF9pZD1Ob25lLCAqLCBzaGFyZF9pZD1Ob25lKToKICAgICAgICBpZiBzaGFyZF9pZCBpcyBOb25lOgogICAgICAgICAgICBzaGFyZF9pZCA9IChndWlsZF9pZCA+PiAyMikgJSBzZWxmLnNoYXJkX2NvdW50CiAgICAgICAgcmV0dXJuIHNlbGYuX19zaGFyZHNbc2hhcmRfaWRdLndzCgogICAgZGVmIF9nZXRfc3RhdGUoc2VsZiwgKipvcHRpb25zKToKICAgICAgICByZXR1cm4gQXV0b1NoYXJkZWRDb25uZWN0aW9uU3RhdGUoZGlzcGF0Y2g9c2VsZi5kaXNwYXRjaCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaGFuZGxlcnM9c2VsZi5faGFuZGxlcnMsIHN5bmNlcj1zZWxmLl9zeW5jZXIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhvb2tzPXNlbGYuX2hvb2tzLCBodHRwPXNlbGYuaHR0cCwgbG9vcD1zZWxmLmxvb3AsICoqb3B0aW9ucykKCiAgICBAcHJvcGVydHkKICAgIGRlZiBsYXRlbmN5KHNlbGYpOgogICAgICAgICIiIjpjbGFzczpgZmxvYXRgOiBNZWFzdXJlcyBsYXRlbmN5IGJldHdlZW4gYSBIRUFSVEJFQVQgYW5kIGEgSEVBUlRCRUFUX0FDSyBpbiBzZWNvbmRzLgoKICAgICAgICBUaGlzIG9wZXJhdGVzIHNpbWlsYXJseSB0byA6bWV0aDpgQ2xpZW50LmxhdGVuY3lgIGV4Y2VwdCBpdCB1c2VzIHRoZSBhdmVyYWdlCiAgICAgICAgbGF0ZW5jeSBvZiBldmVyeSBzaGFyZCdzIGxhdGVuY3kuIFRvIGdldCBhIGxpc3Qgb2Ygc2hhcmQgbGF0ZW5jeSwgY2hlY2sgdGhlCiAgICAgICAgOmF0dHI6YGxhdGVuY2llc2AgcHJvcGVydHkuIFJldHVybnMgYGBuYW5gYCBpZiB0aGVyZSBhcmUgbm8gc2hhcmRzIHJlYWR5LgogICAgICAgICIiIgogICAgICAgIGlmIG5vdCBzZWxmLl9fc2hhcmRzOgogICAgICAgICAgICByZXR1cm4gZmxvYXQoJ25hbicpCiAgICAgICAgcmV0dXJuIHN1bShsYXRlbmN5IGZvciBfLCBsYXRlbmN5IGluIHNlbGYubGF0ZW5jaWVzKSAvIGxlbihzZWxmLl9fc2hhcmRzKQoKICAgIEBwcm9wZXJ0eQogICAgZGVmIGxhdGVuY2llcyhzZWxmKToKICAgICAgICAiIiJMaXN0W1R1cGxlWzpjbGFzczpgaW50YCwgOmNsYXNzOmBmbG9hdGBdXTogQSBsaXN0IG9mIGxhdGVuY2llcyBiZXR3ZWVuIGEgSEVBUlRCRUFUIGFuZCBhIEhFQVJUQkVBVF9BQ0sgaW4gc2Vjb25kcy4KCiAgICAgICAgVGhpcyByZXR1cm5zIGEgbGlzdCBvZiB0dXBsZXMgd2l0aCBlbGVtZW50cyBgYChzaGFyZF9pZCwgbGF0ZW5jeSlgYC4KICAgICAgICAiIiIKICAgICAgICByZXR1cm4gWyhzaGFyZF9pZCwgc2hhcmQud3MubGF0ZW5jeSkgZm9yIHNoYXJkX2lkLCBzaGFyZCBpbiBzZWxmLl9fc2hhcmRzLml0ZW1zKCldCgogICAgZGVmIGdldF9zaGFyZChzZWxmLCBzaGFyZF9pZCk6CiAgICAgICAgIiIiT3B0aW9uYWxbOmNsYXNzOmBTaGFyZEluZm9gXTogR2V0cyB0aGUgc2hhcmQgaW5mb3JtYXRpb24gYXQgYSBnaXZlbiBzaGFyZCBJRCBvciBgYE5vbmVgYCBpZiBub3QgZm91bmQuIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBwYXJlbnQgPSBzZWxmLl9fc2hhcmRzW3NoYXJkX2lkXQogICAgICAgIGV4Y2VwdCBLZXlFcnJvcjoKICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gU2hhcmRJbmZvKHBhcmVudCwgc2VsZi5zaGFyZF9jb3VudCkKCiAgICBAcHJvcGVydHkKICAgIGRlZiBzaGFyZHMoc2VsZik6CiAgICAgICAgIiIiTWFwcGluZ1tpbnQsIDpjbGFzczpgU2hhcmRJbmZvYF06IFJldHVybnMgYSBtYXBwaW5nIG9mIHNoYXJkIElEcyB0byB0aGVpciByZXNwZWN0aXZlIGluZm8gb2JqZWN0LiIiIgogICAgICAgIHJldHVybiB7IHNoYXJkX2lkOiBTaGFyZEluZm8ocGFyZW50LCBzZWxmLnNoYXJkX2NvdW50KSBmb3Igc2hhcmRfaWQsIHBhcmVudCBpbiBzZWxmLl9fc2hhcmRzLml0ZW1zKCkgfQoKICAgIEB1dGlscy5kZXByZWNhdGVkKCdHdWlsZC5jaHVuaycpCiAgICBhc3luYyBkZWYgcmVxdWVzdF9vZmZsaW5lX21lbWJlcnMoc2VsZiwgKmd1aWxkcyk6CiAgICAgICAgciIiInxjb3JvfAoKICAgICAgICBSZXF1ZXN0cyBwcmV2aW91c2x5IG9mZmxpbmUgbWVtYmVycyBmcm9tIHRoZSBndWlsZCB0byBiZSBmaWxsZWQgdXAKICAgICAgICBpbnRvIHRoZSA6YXR0cjpgR3VpbGQubWVtYmVyc2AgY2FjaGUuIFRoaXMgZnVuY3Rpb24gaXMgdXN1YWxseSBub3QKICAgICAgICBjYWxsZWQuIEl0IHNob3VsZCBvbmx5IGJlIHVzZWQgaWYgeW91IGhhdmUgdGhlIGBgZmV0Y2hfb2ZmbGluZV9tZW1iZXJzYGAKICAgICAgICBwYXJhbWV0ZXIgc2V0IHRvIGBgRmFsc2VgYC4KCiAgICAgICAgV2hlbiB0aGUgY2xpZW50IGxvZ3Mgb24gYW5kIGNvbm5lY3RzIHRvIHRoZSB3ZWJzb2NrZXQsIERpc2NvcmQgZG9lcwogICAgICAgIG5vdCBwcm92aWRlIHRoZSBsaWJyYXJ5IHdpdGggb2ZmbGluZSBtZW1iZXJzIGlmIHRoZSBudW1iZXIgb2YgbWVtYmVycwogICAgICAgIGluIHRoZSBndWlsZCBpcyBsYXJnZXIgdGhhbiAyNTAuIFlvdSBjYW4gY2hlY2sgaWYgYSBndWlsZCBpcyBsYXJnZQogICAgICAgIGlmIDphdHRyOmBHdWlsZC5sYXJnZWAgaXMgYGBUcnVlYGAuCgogICAgICAgIC4uIHdhcm5pbmc6OgoKICAgICAgICAgICAgVGhpcyBtZXRob2QgaXMgZGVwcmVjYXRlZC4gVXNlIDptZXRoOmBHdWlsZC5jaHVua2AgaW5zdGVhZC4KCiAgICAgICAgUGFyYW1ldGVycwogICAgICAgIC0tLS0tLS0tLS0tCiAgICAgICAgXCpndWlsZHM6IDpjbGFzczpgR3VpbGRgCiAgICAgICAgICAgIEFuIGFyZ3VtZW50IGxpc3Qgb2YgZ3VpbGRzIHRvIHJlcXVlc3Qgb2ZmbGluZSBtZW1iZXJzIGZvci4KCiAgICAgICAgUmFpc2VzCiAgICAgICAgLS0tLS0tLQogICAgICAgIEludmFsaWRBcmd1bWVudAogICAgICAgICAgICBJZiBhbnkgZ3VpbGQgaXMgdW5hdmFpbGFibGUgaW4gdGhlIGNvbGxlY3Rpb24uCiAgICAgICAgIiIiCiAgICAgICAgaWYgYW55KGcudW5hdmFpbGFibGUgZm9yIGcgaW4gZ3VpbGRzKToKICAgICAgICAgICAgcmFpc2UgSW52YWxpZEFyZ3VtZW50KCdBbiB1bmF2YWlsYWJsZSBvciBub24tbGFyZ2UgZ3VpbGQgd2FzIHBhc3NlZC4nKQoKICAgICAgICBfZ3VpbGRzID0gc29ydGVkKGd1aWxkcywga2V5PWxhbWJkYSBnOiBnLnNoYXJkX2lkKQogICAgICAgIGZvciBzaGFyZF9pZCwgc3ViX2d1aWxkcyBpbiBpdGVydG9vbHMuZ3JvdXBieShfZ3VpbGRzLCBrZXk9bGFtYmRhIGc6IGcuc2hhcmRfaWQpOgogICAgICAgICAgICBmb3IgZ3VpbGQgaW4gc3ViX2d1aWxkczoKICAgICAgICAgICAgICAgIGF3YWl0IHNlbGYuX2Nvbm5lY3Rpb24uY2h1bmtfZ3VpbGQoZ3VpbGQpCgogICAgYXN5bmMgZGVmIGxhdW5jaF9zaGFyZChzZWxmLCBnYXRld2F5LCBzaGFyZF9pZCwgKiwgaW5pdGlhbD1GYWxzZSk6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBjb3JvID0gRGlzY29yZFdlYlNvY2tldC5mcm9tX2NsaWVudChzZWxmLCBpbml0aWFsPWluaXRpYWwsIGdhdGV3YXk9Z2F0ZXdheSwgc2hhcmRfaWQ9c2hhcmRfaWQpCiAgICAgICAgICAgIHdzID0gYXdhaXQgYXN5bmNpby53YWl0X2Zvcihjb3JvLCB0aW1lb3V0PTE4MC4wKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIGxvZy5leGNlcHRpb24oJ0ZhaWxlZCB0byBjb25uZWN0IGZvciBzaGFyZF9pZDogJXMuIFJldHJ5aW5nLi4uJywgc2hhcmRfaWQpCiAgICAgICAgICAgIGF3YWl0IGFzeW5jaW8uc2xlZXAoNS4wKQogICAgICAgICAgICByZXR1cm4gYXdhaXQgc2VsZi5sYXVuY2hfc2hhcmQoZ2F0ZXdheSwgc2hhcmRfaWQpCgogICAgICAgICMga2VlcCByZWFkaW5nIHRoZSBzaGFyZCB3aGlsZSBvdGhlcnMgY29ubmVjdAogICAgICAgIHNlbGYuX19zaGFyZHNbc2hhcmRfaWRdID0gcmV0ID0gU2hhcmQod3MsIHNlbGYsIHNlbGYuX19xdWV1ZS5wdXRfbm93YWl0KQogICAgICAgIHJldC5sYXVuY2goKQoKICAgIGFzeW5jIGRlZiBsYXVuY2hfc2hhcmRzKHNlbGYpOgogICAgICAgIGlmIHNlbGYuc2hhcmRfY291bnQgaXMgTm9uZToKICAgICAgICAgICAgc2VsZi5zaGFyZF9jb3VudCwgZ2F0ZXdheSA9IGF3YWl0IHNlbGYuaHR0cC5nZXRfYm90X2dhdGV3YXkoKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGdhdGV3YXkgPSBhd2FpdCBzZWxmLmh0dHAuZ2V0X2dhdGV3YXkoKQoKICAgICAgICBzZWxmLl9jb25uZWN0aW9uLnNoYXJkX2NvdW50ID0gc2VsZi5zaGFyZF9jb3VudAoKICAgICAgICBzaGFyZF9pZHMgPSBzZWxmLnNoYXJkX2lkcyBvciByYW5nZShzZWxmLnNoYXJkX2NvdW50KQogICAgICAgIHNlbGYuX2Nvbm5lY3Rpb24uc2hhcmRfaWRzID0gc2hhcmRfaWRzCgogICAgICAgIGZvciBzaGFyZF9pZCBpbiBzaGFyZF9pZHM6CiAgICAgICAgICAgIGluaXRpYWwgPSBzaGFyZF9pZCA9PSBzaGFyZF9pZHNbMF0KICAgICAgICAgICAgYXdhaXQgc2VsZi5sYXVuY2hfc2hhcmQoZ2F0ZXdheSwgc2hhcmRfaWQsIGluaXRpYWw9aW5pdGlhbCkKCiAgICAgICAgc2VsZi5fY29ubmVjdGlvbi5zaGFyZHNfbGF1bmNoZWQuc2V0KCkKCiAgICBhc3luYyBkZWYgY29ubmVjdChzZWxmLCAqLCByZWNvbm5lY3Q9VHJ1ZSk6CiAgICAgICAgc2VsZi5fcmVjb25uZWN0ID0gcmVjb25uZWN0CiAgICAgICAgYXdhaXQgc2VsZi5sYXVuY2hfc2hhcmRzKCkKCiAgICAgICAgd2hpbGUgbm90IHNlbGYuaXNfY2xvc2VkKCk6CiAgICAgICAgICAgIGl0ZW0gPSBhd2FpdCBzZWxmLl9fcXVldWUuZ2V0KCkKICAgICAgICAgICAgaWYgaXRlbS50eXBlID09IEV2ZW50VHlwZS5jbG9zZToKICAgICAgICAgICAgICAgIGF3YWl0IHNlbGYuY2xvc2UoKQogICAgICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShpdGVtLmVycm9yLCBDb25uZWN0aW9uQ2xvc2VkKToKICAgICAgICAgICAgICAgICAgICBpZiBpdGVtLmVycm9yLmNvZGUgIT0gMTAwMDoKICAgICAgICAgICAgICAgICAgICAgICAgcmFpc2UgaXRlbS5lcnJvcgogICAgICAgICAgICAgICAgICAgIGlmIGl0ZW0uZXJyb3IuY29kZSA9PSA0MDE0OgogICAgICAgICAgICAgICAgICAgICAgICByYWlzZSBQcml2aWxlZ2VkSW50ZW50c1JlcXVpcmVkKGl0ZW0uc2hhcmQuaWQpIGZyb20gTm9uZQogICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgIGVsaWYgaXRlbS50eXBlIGluIChFdmVudFR5cGUuaWRlbnRpZnksIEV2ZW50VHlwZS5yZXN1bWUpOgogICAgICAgICAgICAgICAgYXdhaXQgaXRlbS5zaGFyZC5yZWlkZW50aWZ5KGl0ZW0uZXJyb3IpCiAgICAgICAgICAgIGVsaWYgaXRlbS50eXBlID09IEV2ZW50VHlwZS5yZWNvbm5lY3Q6CiAgICAgICAgICAgICAgICBhd2FpdCBpdGVtLnNoYXJkLnJlY29ubmVjdCgpCiAgICAgICAgICAgIGVsaWYgaXRlbS50eXBlID09IEV2ZW50VHlwZS50ZXJtaW5hdGU6CiAgICAgICAgICAgICAgICBhd2FpdCBzZWxmLmNsb3NlKCkKICAgICAgICAgICAgICAgIHJhaXNlIGl0ZW0uZXJyb3IKICAgICAgICAgICAgZWxpZiBpdGVtLnR5cGUgPT0gRXZlbnRUeXBlLmNsZWFuX2Nsb3NlOgogICAgICAgICAgICAgICAgcmV0dXJuCgogICAgYXN5bmMgZGVmIGNsb3NlKHNlbGYpOgogICAgICAgICIiInxjb3JvfAoKICAgICAgICBDbG9zZXMgdGhlIGNvbm5lY3Rpb24gdG8gRGlzY29yZC4KICAgICAgICAiIiIKICAgICAgICBpZiBzZWxmLmlzX2Nsb3NlZCgpOgogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgc2VsZi5fY2xvc2VkID0gVHJ1ZQoKICAgICAgICBmb3IgdmMgaW4gc2VsZi52b2ljZV9jbGllbnRzOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBhd2FpdCB2Yy5kaXNjb25uZWN0KCkKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgIHBhc3MKCiAgICAgICAgdG9fY2xvc2UgPSBbYXN5bmNpby5lbnN1cmVfZnV0dXJlKHNoYXJkLmNsb3NlKCksIGxvb3A9c2VsZi5sb29wKSBmb3Igc2hhcmQgaW4gc2VsZi5fX3NoYXJkcy52YWx1ZXMoKV0KICAgICAgICBpZiB0b19jbG9zZToKICAgICAgICAgICAgYXdhaXQgYXN5bmNpby53YWl0KHRvX2Nsb3NlKQoKICAgICAgICBhd2FpdCBzZWxmLmh0dHAuY2xvc2UoKQogICAgICAgIHNlbGYuX19xdWV1ZS5wdXRfbm93YWl0KEV2ZW50SXRlbShFdmVudFR5cGUuY2xlYW5fY2xvc2UsIE5vbmUsIE5vbmUpKQoKICAgIGFzeW5jIGRlZiBjaGFuZ2VfcHJlc2VuY2Uoc2VsZiwgKiwgYWN0aXZpdHk9Tm9uZSwgc3RhdHVzPU5vbmUsIGFmaz1GYWxzZSwgc2hhcmRfaWQ9Tm9uZSk6CiAgICAgICAgIiIifGNvcm98CgogICAgICAgIENoYW5nZXMgdGhlIGNsaWVudCdzIHByZXNlbmNlLgoKICAgICAgICBFeGFtcGxlOiA6OgoKICAgICAgICAgICAgZ2FtZSA9IGRpc2NvcmQuR2FtZSgid2l0aCB0aGUgQVBJIikKICAgICAgICAgICAgYXdhaXQgY2xpZW50LmNoYW5nZV9wcmVzZW5jZShzdGF0dXM9ZGlzY29yZC5TdGF0dXMuaWRsZSwgYWN0aXZpdHk9Z2FtZSkKCiAgICAgICAgUGFyYW1ldGVycwogICAgICAgIC0tLS0tLS0tLS0KICAgICAgICBhY3Rpdml0eTogT3B0aW9uYWxbOmNsYXNzOmBCYXNlQWN0aXZpdHlgXQogICAgICAgICAgICBUaGUgYWN0aXZpdHkgYmVpbmcgZG9uZS4gYGBOb25lYGAgaWYgbm8gY3VycmVudGx5IGFjdGl2ZSBhY3Rpdml0eSBpcyBkb25lLgogICAgICAgIHN0YXR1czogT3B0aW9uYWxbOmNsYXNzOmBTdGF0dXNgXQogICAgICAgICAgICBJbmRpY2F0ZXMgd2hhdCBzdGF0dXMgdG8gY2hhbmdlIHRvLiBJZiBgYE5vbmVgYCwgdGhlbgogICAgICAgICAgICA6YXR0cjpgU3RhdHVzLm9ubGluZWAgaXMgdXNlZC4KICAgICAgICBhZms6IDpjbGFzczpgYm9vbGAKICAgICAgICAgICAgSW5kaWNhdGVzIGlmIHlvdSBhcmUgZ29pbmcgQUZLLiBUaGlzIGFsbG93cyB0aGUgZGlzY29yZAogICAgICAgICAgICBjbGllbnQgdG8ga25vdyBob3cgdG8gaGFuZGxlIHB1c2ggbm90aWZpY2F0aW9ucyBiZXR0ZXIKICAgICAgICAgICAgZm9yIHlvdSBpbiBjYXNlIHlvdSBhcmUgYWN0dWFsbHkgaWRsZSBhbmQgbm90IGx5aW5nLgogICAgICAgIHNoYXJkX2lkOiBPcHRpb25hbFs6Y2xhc3M6YGludGBdCiAgICAgICAgICAgIFRoZSBzaGFyZF9pZCB0byBjaGFuZ2UgdGhlIHByZXNlbmNlIHRvLiBJZiBub3Qgc3BlY2lmaWVkCiAgICAgICAgICAgIG9yIGBgTm9uZWBgLCB0aGVuIGl0IHdpbGwgY2hhbmdlIHRoZSBwcmVzZW5jZSBvZiBldmVyeQogICAgICAgICAgICBzaGFyZCB0aGUgYm90IGNhbiBzZWUuCgogICAgICAgIFJhaXNlcwogICAgICAgIC0tLS0tLQogICAgICAgIEludmFsaWRBcmd1bWVudAogICAgICAgICAgICBJZiB0aGUgYGBhY3Rpdml0eWBgIHBhcmFtZXRlciBpcyBub3Qgb2YgcHJvcGVyIHR5cGUuCiAgICAgICAgIiIiCgogICAgICAgIGlmIHN0YXR1cyBpcyBOb25lOgogICAgICAgICAgICBzdGF0dXMgPSAnb25saW5lJwogICAgICAgICAgICBzdGF0dXNfZW51bSA9IFN0YXR1cy5vbmxpbmUKICAgICAgICBlbGlmIHN0YXR1cyBpcyBTdGF0dXMub2ZmbGluZToKICAgICAgICAgICAgc3RhdHVzID0gJ2ludmlzaWJsZScKICAgICAgICAgICAgc3RhdHVzX2VudW0gPSBTdGF0dXMub2ZmbGluZQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHN0YXR1c19lbnVtID0gc3RhdHVzCiAgICAgICAgICAgIHN0YXR1cyA9IHN0cihzdGF0dXMpCgogICAgICAgIGlmIHNoYXJkX2lkIGlzIE5vbmU6CiAgICAgICAgICAgIGZvciBzaGFyZCBpbiBzZWxmLl9fc2hhcmRzLnZhbHVlcygpOgogICAgICAgICAgICAgICAgYXdhaXQgc2hhcmQud3MuY2hhbmdlX3ByZXNlbmNlKGFjdGl2aXR5PWFjdGl2aXR5LCBzdGF0dXM9c3RhdHVzLCBhZms9YWZrKQoKICAgICAgICAgICAgZ3VpbGRzID0gc2VsZi5fY29ubmVjdGlvbi5ndWlsZHMKICAgICAgICBlbHNlOgogICAgICAgICAgICBzaGFyZCA9IHNlbGYuX19zaGFyZHNbc2hhcmRfaWRdCiAgICAgICAgICAgIGF3YWl0IHNoYXJkLndzLmNoYW5nZV9wcmVzZW5jZShhY3Rpdml0eT1hY3Rpdml0eSwgc3RhdHVzPXN0YXR1cywgYWZrPWFmaykKICAgICAgICAgICAgZ3VpbGRzID0gW2cgZm9yIGcgaW4gc2VsZi5fY29ubmVjdGlvbi5ndWlsZHMgaWYgZy5zaGFyZF9pZCA9PSBzaGFyZF9pZF0KCiAgICAgICAgYWN0aXZpdGllcyA9ICgpIGlmIGFjdGl2aXR5IGlzIE5vbmUgZWxzZSAoYWN0aXZpdHksKQogICAgICAgIGZvciBndWlsZCBpbiBndWlsZHM6CiAgICAgICAgICAgIG1lID0gZ3VpbGQubWUKICAgICAgICAgICAgaWYgbWUgaXMgTm9uZToKICAgICAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgICAgICBtZS5hY3Rpdml0aWVzID0gYWN0aXZpdGllcwogICAgICAgICAgICBtZS5zdGF0dXMgPSBzdGF0dXNfZW51bQoKICAgIGRlZiBpc193c19yYXRlbGltaXRlZChzZWxmKToKICAgICAgICAiIiI6Y2xhc3M6YGJvb2xgOiBXaGV0aGVyIHRoZSB3ZWJzb2NrZXQgaXMgY3VycmVudGx5IHJhdGUgbGltaXRlZC4KCiAgICAgICAgVGhpcyBjYW4gYmUgdXNlZnVsIHRvIGtub3cgd2hlbiBkZWNpZGluZyB3aGV0aGVyIHlvdSBzaG91bGQgcXVlcnkgbWVtYmVycwogICAgICAgIHVzaW5nIEhUVFAgb3IgdmlhIHRoZSBnYXRld2F5LgoKICAgICAgICBUaGlzIGltcGxlbWVudGF0aW9uIGNoZWNrcyBpZiBhbnkgb2YgdGhlIHNoYXJkcyBhcmUgcmF0ZSBsaW1pdGVkLgogICAgICAgIEZvciBtb3JlIGdyYW51bGFyIGNvbnRyb2wsIGNvbnNpZGVyIDptZXRoOmBTaGFyZEluZm8uaXNfd3NfcmF0ZWxpbWl0ZWRgLgoKICAgICAgICAuLiB2ZXJzaW9uYWRkZWQ6OiAxLjYKICAgICAgICAiIiIKICAgICAgICByZXR1cm4gYW55KHNoYXJkLndzLmlzX3JhdGVsaW1pdGVkKCkgZm9yIHNoYXJkIGluIHNlbGYuX19zaGFyZHMudmFsdWVzKCkpCg==
