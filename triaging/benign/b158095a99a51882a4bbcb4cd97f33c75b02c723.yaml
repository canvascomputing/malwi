statistics:
  total_files: 1
  skipped_files: 0.0
  processed_objects: 1
  malicious_objects: 0
details:
- path: .repo_cache/malicious_repos/pypi_malregistry/discord-py-v13/1.3/discord_py_v13-1.3-py3-none-any/discord-py-v13/abc.py
  contents:
  - name: Messageable.fetch_message
    score: 0.0
    code: |-
      async def fetch_message(self, id):
              """|coro|

              Retrieves a single :class:`~discord.Message` from the destination.

              This can only be used by bot accounts.

              Parameters
              ------------
              id: :class:`int`
                  The message ID to look for.

              Raises
              --------
              ~discord.NotFound
                  The specified message was not found.
              ~discord.Forbidden
                  You do not have the permissions required to get a message.
              ~discord.HTTPException
                  Retrieving the message failed.

              Returns
              --------
              :class:`~discord.Message`
                  The message asked for.
              """

              channel = await self._get_channel()
              data = await self._state.http.get_message(channel.id, id)
              return self._state.create_message(channel=channel, data=data)
    tokens: return_generator pop_top resume load_fast self load_attr _get_channel call get_awaitable load_const send TO_NUMBER yield_value resume jump_backward_no_interrupt TO_NUMBER end_send store_fast channel load_fast self load_attr _state load_attr http load_attr get_message load_fast channel load_attr id load_fast id call get_awaitable load_const send TO_NUMBER yield_value resume jump_backward_no_interrupt TO_NUMBER end_send store_fast data load_fast self load_attr _state load_attr create_message load_fast channel load_fast data kw_names channel data call return_value cleanup_throw jump_backward TO_NUMBER cleanup_throw jump_backward TO_NUMBER call_intrinsic_1 INTRINSIC_STOPITERATION_ERROR reraise
    hash: edd2f71db57ff8980adab4336bfb35821a02f461d9174c126e1f2197af75d0cb
sources:
  .repo_cache/malicious_repos/pypi_malregistry/discord-py-v13/1.3/discord_py_v13-1.3-py3-none-any/discord-py-v13/abc.py: IyAtKi0gY29kaW5nOiB1dGYtOCAtKi0KCiIiIgpUaGUgTUlUIExpY2Vuc2UgKE1JVCkKCkNvcHlyaWdodCAoYykgMjAxNS1wcmVzZW50IFJhcHB0egoKUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEKY29weSBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZSAiU29mdHdhcmUiKSwKdG8gZGVhbCBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbgp0aGUgcmlnaHRzIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwKYW5kL29yIHNlbGwgY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlClNvZnR3YXJlIGlzIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6CgpUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbgphbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KClRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTCk9SIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLApGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEUKQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUgpMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORwpGUk9NLCBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSCkRFQUxJTkdTIElOIFRIRSBTT0ZUV0FSRS4KIiIiCgppbXBvcnQgYWJjCmltcG9ydCBzeXMKaW1wb3J0IGNvcHkKaW1wb3J0IGFzeW5jaW8KCmZyb20gLml0ZXJhdG9ycyBpbXBvcnQgSGlzdG9yeUl0ZXJhdG9yCmZyb20gLmNvbnRleHRfbWFuYWdlcnMgaW1wb3J0IFR5cGluZwpmcm9tIC5lbnVtcyBpbXBvcnQgQ2hhbm5lbFR5cGUKZnJvbSAuZXJyb3JzIGltcG9ydCBJbnZhbGlkQXJndW1lbnQsIENsaWVudEV4Y2VwdGlvbgpmcm9tIC5tZW50aW9ucyBpbXBvcnQgQWxsb3dlZE1lbnRpb25zCmZyb20gLnBlcm1pc3Npb25zIGltcG9ydCBQZXJtaXNzaW9uT3ZlcndyaXRlLCBQZXJtaXNzaW9ucwpmcm9tIC5yb2xlIGltcG9ydCBSb2xlCmZyb20gLmludml0ZSBpbXBvcnQgSW52aXRlCmZyb20gLmZpbGUgaW1wb3J0IEZpbGUKZnJvbSAudm9pY2VfY2xpZW50IGltcG9ydCBWb2ljZUNsaWVudCwgVm9pY2VQcm90b2NvbApmcm9tIC4gaW1wb3J0IHV0aWxzCgpjbGFzcyBfVW5kZWZpbmVkOgogICAgZGVmIF9fcmVwcl9fKHNlbGYpOgogICAgICAgIHJldHVybiAnc2VlLWJlbG93JwoKX3VuZGVmaW5lZCA9IF9VbmRlZmluZWQoKQoKY2xhc3MgU25vd2ZsYWtlKG1ldGFjbGFzcz1hYmMuQUJDTWV0YSk6CiAgICAiIiJBbiBBQkMgdGhhdCBkZXRhaWxzIHRoZSBjb21tb24gb3BlcmF0aW9ucyBvbiBhIERpc2NvcmQgbW9kZWwuCgogICAgQWxtb3N0IGFsbCA6cmVmOmBEaXNjb3JkIG1vZGVscyA8ZGlzY29yZF9hcGlfbW9kZWxzPmAgbWVldCB0aGlzCiAgICBhYnN0cmFjdCBiYXNlIGNsYXNzLgoKICAgIElmIHlvdSB3YW50IHRvIGNyZWF0ZSBhIHNub3dmbGFrZSBvbiB5b3VyIG93biwgY29uc2lkZXIgdXNpbmcKICAgIDpjbGFzczpgLk9iamVjdGAuCgogICAgQXR0cmlidXRlcwogICAgLS0tLS0tLS0tLS0KICAgIGlkOiA6Y2xhc3M6YGludGAKICAgICAgICBUaGUgbW9kZWwncyB1bmlxdWUgSUQuCiAgICAiIiIKICAgIF9fc2xvdHNfXyA9ICgpCgogICAgQHByb3BlcnR5CiAgICBAYWJjLmFic3RyYWN0bWV0aG9kCiAgICBkZWYgY3JlYXRlZF9hdChzZWxmKToKICAgICAgICAiIiI6Y2xhc3M6YGRhdGV0aW1lLmRhdGV0aW1lYDogUmV0dXJucyB0aGUgbW9kZWwncyBjcmVhdGlvbiB0aW1lIGFzIGEgbmFpdmUgZGF0ZXRpbWUgaW4gVVRDLiIiIgogICAgICAgIHJhaXNlIE5vdEltcGxlbWVudGVkRXJyb3IKCiAgICBAY2xhc3NtZXRob2QKICAgIGRlZiBfX3N1YmNsYXNzaG9va19fKGNscywgQyk6CiAgICAgICAgaWYgY2xzIGlzIFNub3dmbGFrZToKICAgICAgICAgICAgbXJvID0gQy5fX21yb19fCiAgICAgICAgICAgIGZvciBhdHRyIGluICgnY3JlYXRlZF9hdCcsICdpZCcpOgogICAgICAgICAgICAgICAgZm9yIGJhc2UgaW4gbXJvOgogICAgICAgICAgICAgICAgICAgIGlmIGF0dHIgaW4gYmFzZS5fX2RpY3RfXzoKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIE5vdEltcGxlbWVudGVkCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgcmV0dXJuIE5vdEltcGxlbWVudGVkCgpjbGFzcyBVc2VyKG1ldGFjbGFzcz1hYmMuQUJDTWV0YSk6CiAgICAiIiJBbiBBQkMgdGhhdCBkZXRhaWxzIHRoZSBjb21tb24gb3BlcmF0aW9ucyBvbiBhIERpc2NvcmQgdXNlci4KCiAgICBUaGUgZm9sbG93aW5nIGltcGxlbWVudCB0aGlzIEFCQzoKCiAgICAtIDpjbGFzczpgfmRpc2NvcmQuVXNlcmAKICAgIC0gOmNsYXNzOmB+ZGlzY29yZC5DbGllbnRVc2VyYAogICAgLSA6Y2xhc3M6YH5kaXNjb3JkLk1lbWJlcmAKCiAgICBUaGlzIEFCQyBtdXN0IGFsc28gaW1wbGVtZW50IDpjbGFzczpgfmRpc2NvcmQuYWJjLlNub3dmbGFrZWAuCgogICAgQXR0cmlidXRlcwogICAgLS0tLS0tLS0tLS0KICAgIG5hbWU6IDpjbGFzczpgc3RyYAogICAgICAgIFRoZSB1c2VyJ3MgdXNlcm5hbWUuCiAgICBkaXNjcmltaW5hdG9yOiA6Y2xhc3M6YHN0cmAKICAgICAgICBUaGUgdXNlcidzIGRpc2NyaW1pbmF0b3IuCiAgICBhdmF0YXI6IE9wdGlvbmFsWzpjbGFzczpgc3RyYF0KICAgICAgICBUaGUgYXZhdGFyIGhhc2ggdGhlIHVzZXIgaGFzLgogICAgYm90OiA6Y2xhc3M6YGJvb2xgCiAgICAgICAgSWYgdGhlIHVzZXIgaXMgYSBib3QgYWNjb3VudC4KICAgICIiIgogICAgX19zbG90c19fID0gKCkKCiAgICBAcHJvcGVydHkKICAgIEBhYmMuYWJzdHJhY3RtZXRob2QKICAgIGRlZiBkaXNwbGF5X25hbWUoc2VsZik6CiAgICAgICAgIiIiOmNsYXNzOmBzdHJgOiBSZXR1cm5zIHRoZSB1c2VyJ3MgZGlzcGxheSBuYW1lLiIiIgogICAgICAgIHJhaXNlIE5vdEltcGxlbWVudGVkRXJyb3IKCiAgICBAcHJvcGVydHkKICAgIEBhYmMuYWJzdHJhY3RtZXRob2QKICAgIGRlZiBtZW50aW9uKHNlbGYpOgogICAgICAgICIiIjpjbGFzczpgc3RyYDogUmV0dXJucyBhIHN0cmluZyB0aGF0IGFsbG93cyB5b3UgdG8gbWVudGlvbiB0aGUgZ2l2ZW4gdXNlci4iIiIKICAgICAgICByYWlzZSBOb3RJbXBsZW1lbnRlZEVycm9yCgogICAgQGNsYXNzbWV0aG9kCiAgICBkZWYgX19zdWJjbGFzc2hvb2tfXyhjbHMsIEMpOgogICAgICAgIGlmIGNscyBpcyBVc2VyOgogICAgICAgICAgICBpZiBTbm93Zmxha2UuX19zdWJjbGFzc2hvb2tfXyhDKSBpcyBOb3RJbXBsZW1lbnRlZDoKICAgICAgICAgICAgICAgIHJldHVybiBOb3RJbXBsZW1lbnRlZAoKICAgICAgICAgICAgbXJvID0gQy5fX21yb19fCiAgICAgICAgICAgIGZvciBhdHRyIGluICgnZGlzcGxheV9uYW1lJywgJ21lbnRpb24nLCAnbmFtZScsICdhdmF0YXInLCAnZGlzY3JpbWluYXRvcicsICdib3QnKToKICAgICAgICAgICAgICAgIGZvciBiYXNlIGluIG1ybzoKICAgICAgICAgICAgICAgICAgICBpZiBhdHRyIGluIGJhc2UuX19kaWN0X186CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBOb3RJbXBsZW1lbnRlZAogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIHJldHVybiBOb3RJbXBsZW1lbnRlZAoKY2xhc3MgUHJpdmF0ZUNoYW5uZWwobWV0YWNsYXNzPWFiYy5BQkNNZXRhKToKICAgICIiIkFuIEFCQyB0aGF0IGRldGFpbHMgdGhlIGNvbW1vbiBvcGVyYXRpb25zIG9uIGEgcHJpdmF0ZSBEaXNjb3JkIGNoYW5uZWwuCgogICAgVGhlIGZvbGxvd2luZyBpbXBsZW1lbnQgdGhpcyBBQkM6CgogICAgLSA6Y2xhc3M6YH5kaXNjb3JkLkRNQ2hhbm5lbGAKICAgIC0gOmNsYXNzOmB+ZGlzY29yZC5Hcm91cENoYW5uZWxgCgogICAgVGhpcyBBQkMgbXVzdCBhbHNvIGltcGxlbWVudCA6Y2xhc3M6YH5kaXNjb3JkLmFiYy5Tbm93Zmxha2VgLgoKICAgIEF0dHJpYnV0ZXMKICAgIC0tLS0tLS0tLS0tCiAgICBtZTogOmNsYXNzOmB+ZGlzY29yZC5DbGllbnRVc2VyYAogICAgICAgIFRoZSB1c2VyIHByZXNlbnRpbmcgeW91cnNlbGYuCiAgICAiIiIKICAgIF9fc2xvdHNfXyA9ICgpCgogICAgQGNsYXNzbWV0aG9kCiAgICBkZWYgX19zdWJjbGFzc2hvb2tfXyhjbHMsIEMpOgogICAgICAgIGlmIGNscyBpcyBQcml2YXRlQ2hhbm5lbDoKICAgICAgICAgICAgaWYgU25vd2ZsYWtlLl9fc3ViY2xhc3Nob29rX18oQykgaXMgTm90SW1wbGVtZW50ZWQ6CiAgICAgICAgICAgICAgICByZXR1cm4gTm90SW1wbGVtZW50ZWQKCiAgICAgICAgICAgIG1ybyA9IEMuX19tcm9fXwogICAgICAgICAgICBmb3IgYmFzZSBpbiBtcm86CiAgICAgICAgICAgICAgICBpZiAnbWUnIGluIGJhc2UuX19kaWN0X186CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgcmV0dXJuIE5vdEltcGxlbWVudGVkCiAgICAgICAgcmV0dXJuIE5vdEltcGxlbWVudGVkCgpjbGFzcyBfT3ZlcndyaXRlczoKICAgIF9fc2xvdHNfXyA9ICgnaWQnLCAnYWxsb3cnLCAnZGVueScsICd0eXBlJykKCiAgICBkZWYgX19pbml0X18oc2VsZiwgKiprd2FyZ3MpOgogICAgICAgIHNlbGYuaWQgPSBrd2FyZ3MucG9wKCdpZCcpCiAgICAgICAgc2VsZi5hbGxvdyA9IGludChrd2FyZ3MucG9wKCdhbGxvd19uZXcnLCAwKSkKICAgICAgICBzZWxmLmRlbnkgPSBpbnQoa3dhcmdzLnBvcCgnZGVueV9uZXcnLCAwKSkKICAgICAgICBzZWxmLnR5cGUgPSBzeXMuaW50ZXJuKGt3YXJncy5wb3AoJ3R5cGUnKSkKCiAgICBkZWYgX2FzZGljdChzZWxmKToKICAgICAgICByZXR1cm4gewogICAgICAgICAgICAnaWQnOiBzZWxmLmlkLAogICAgICAgICAgICAnYWxsb3cnOiBzdHIoc2VsZi5hbGxvdyksCiAgICAgICAgICAgICdkZW55Jzogc3RyKHNlbGYuZGVueSksCiAgICAgICAgICAgICd0eXBlJzogc2VsZi50eXBlLAogICAgICAgIH0KCmNsYXNzIEd1aWxkQ2hhbm5lbDoKICAgICIiIkFuIEFCQyB0aGF0IGRldGFpbHMgdGhlIGNvbW1vbiBvcGVyYXRpb25zIG9uIGEgRGlzY29yZCBndWlsZCBjaGFubmVsLgoKICAgIFRoZSBmb2xsb3dpbmcgaW1wbGVtZW50IHRoaXMgQUJDOgoKICAgIC0gOmNsYXNzOmB+ZGlzY29yZC5UZXh0Q2hhbm5lbGAKICAgIC0gOmNsYXNzOmB+ZGlzY29yZC5Wb2ljZUNoYW5uZWxgCiAgICAtIDpjbGFzczpgfmRpc2NvcmQuQ2F0ZWdvcnlDaGFubmVsYAogICAgLSA6Y2xhc3M6YH5kaXNjb3JkLlN0YWdlQ2hhbm5lbGAKCiAgICBUaGlzIEFCQyBtdXN0IGFsc28gaW1wbGVtZW50IDpjbGFzczpgfmRpc2NvcmQuYWJjLlNub3dmbGFrZWAuCgogICAgQXR0cmlidXRlcwogICAgLS0tLS0tLS0tLS0KICAgIG5hbWU6IDpjbGFzczpgc3RyYAogICAgICAgIFRoZSBjaGFubmVsIG5hbWUuCiAgICBndWlsZDogOmNsYXNzOmB+ZGlzY29yZC5HdWlsZGAKICAgICAgICBUaGUgZ3VpbGQgdGhlIGNoYW5uZWwgYmVsb25ncyB0by4KICAgIHBvc2l0aW9uOiA6Y2xhc3M6YGludGAKICAgICAgICBUaGUgcG9zaXRpb24gaW4gdGhlIGNoYW5uZWwgbGlzdC4gVGhpcyBpcyBhIG51bWJlciB0aGF0IHN0YXJ0cyBhdCAwLgogICAgICAgIGUuZy4gdGhlIHRvcCBjaGFubmVsIGlzIHBvc2l0aW9uIDAuCiAgICAiIiIKICAgIF9fc2xvdHNfXyA9ICgpCgogICAgZGVmIF9fc3RyX18oc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYubmFtZQoKICAgIEBwcm9wZXJ0eQogICAgZGVmIF9zb3J0aW5nX2J1Y2tldChzZWxmKToKICAgICAgICByYWlzZSBOb3RJbXBsZW1lbnRlZEVycm9yCgogICAgYXN5bmMgZGVmIF9tb3ZlKHNlbGYsIHBvc2l0aW9uLCBwYXJlbnRfaWQ9Tm9uZSwgbG9ja19wZXJtaXNzaW9ucz1GYWxzZSwgKiwgcmVhc29uKToKICAgICAgICBpZiBwb3NpdGlvbiA8IDA6CiAgICAgICAgICAgIHJhaXNlIEludmFsaWRBcmd1bWVudCgnQ2hhbm5lbCBwb3NpdGlvbiBjYW5ub3QgYmUgbGVzcyB0aGFuIDAuJykKCiAgICAgICAgaHR0cCA9IHNlbGYuX3N0YXRlLmh0dHAKICAgICAgICBidWNrZXQgPSBzZWxmLl9zb3J0aW5nX2J1Y2tldAogICAgICAgIGNoYW5uZWxzID0gW2MgZm9yIGMgaW4gc2VsZi5ndWlsZC5jaGFubmVscyBpZiBjLl9zb3J0aW5nX2J1Y2tldCA9PSBidWNrZXRdCgogICAgICAgIGNoYW5uZWxzLnNvcnQoa2V5PWxhbWJkYSBjOiBjLnBvc2l0aW9uKQoKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgcmVtb3ZlIG91cnNlbHZlcyBmcm9tIHRoZSBjaGFubmVsIGxpc3QKICAgICAgICAgICAgY2hhbm5lbHMucmVtb3ZlKHNlbGYpCiAgICAgICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAgICAgICMgbm90IHRoZXJlIHNvbWVob3cgbG9sCiAgICAgICAgICAgIHJldHVybgogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGluZGV4ID0gbmV4dCgoaSBmb3IgaSwgYyBpbiBlbnVtZXJhdGUoY2hhbm5lbHMpIGlmIGMucG9zaXRpb24gPj0gcG9zaXRpb24pLCBsZW4oY2hhbm5lbHMpKQogICAgICAgICAgICAjIGFkZCBvdXJzZWx2ZXMgYXQgb3VyIGRlc2lnbmF0ZWQgcG9zaXRpb24KICAgICAgICAgICAgY2hhbm5lbHMuaW5zZXJ0KGluZGV4LCBzZWxmKQoKICAgICAgICBwYXlsb2FkID0gW10KICAgICAgICBmb3IgaW5kZXgsIGMgaW4gZW51bWVyYXRlKGNoYW5uZWxzKToKICAgICAgICAgICAgZCA9IHsnaWQnOiBjLmlkLCAncG9zaXRpb24nOiBpbmRleH0KICAgICAgICAgICAgaWYgcGFyZW50X2lkIGlzIG5vdCBfdW5kZWZpbmVkIGFuZCBjLmlkID09IHNlbGYuaWQ6CiAgICAgICAgICAgICAgICBkLnVwZGF0ZShwYXJlbnRfaWQ9cGFyZW50X2lkLCBsb2NrX3Blcm1pc3Npb25zPWxvY2tfcGVybWlzc2lvbnMpCiAgICAgICAgICAgIHBheWxvYWQuYXBwZW5kKGQpCgogICAgICAgIGF3YWl0IGh0dHAuYnVsa19jaGFubmVsX3VwZGF0ZShzZWxmLmd1aWxkLmlkLCBwYXlsb2FkLCByZWFzb249cmVhc29uKQogICAgICAgIHNlbGYucG9zaXRpb24gPSBwb3NpdGlvbgogICAgICAgIGlmIHBhcmVudF9pZCBpcyBub3QgX3VuZGVmaW5lZDoKICAgICAgICAgICAgc2VsZi5jYXRlZ29yeV9pZCA9IGludChwYXJlbnRfaWQpIGlmIHBhcmVudF9pZCBlbHNlIE5vbmUKCiAgICBhc3luYyBkZWYgX2VkaXQoc2VsZiwgb3B0aW9ucywgcmVhc29uKToKICAgICAgICB0cnk6CiAgICAgICAgICAgIHBhcmVudCA9IG9wdGlvbnMucG9wKCdjYXRlZ29yeScpCiAgICAgICAgZXhjZXB0IEtleUVycm9yOgogICAgICAgICAgICBwYXJlbnRfaWQgPSBfdW5kZWZpbmVkCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcGFyZW50X2lkID0gcGFyZW50IGFuZCBwYXJlbnQuaWQKCiAgICAgICAgdHJ5OgogICAgICAgICAgICBvcHRpb25zWydyYXRlX2xpbWl0X3Blcl91c2VyJ10gPSBvcHRpb25zLnBvcCgnc2xvd21vZGVfZGVsYXknKQogICAgICAgIGV4Y2VwdCBLZXlFcnJvcjoKICAgICAgICAgICAgcGFzcwoKICAgICAgICB0cnk6CiAgICAgICAgICAgIHJ0Y19yZWdpb24gPSBvcHRpb25zLnBvcCgncnRjX3JlZ2lvbicpCiAgICAgICAgZXhjZXB0IEtleUVycm9yOgogICAgICAgICAgICBwYXNzCiAgICAgICAgZWxzZToKICAgICAgICAgICAgb3B0aW9uc1sncnRjX3JlZ2lvbiddID0gTm9uZSBpZiBydGNfcmVnaW9uIGlzIE5vbmUgZWxzZSBzdHIocnRjX3JlZ2lvbikKCiAgICAgICAgbG9ja19wZXJtaXNzaW9ucyA9IG9wdGlvbnMucG9wKCdzeW5jX3Blcm1pc3Npb25zJywgRmFsc2UpCgogICAgICAgIHRyeToKICAgICAgICAgICAgcG9zaXRpb24gPSBvcHRpb25zLnBvcCgncG9zaXRpb24nKQogICAgICAgIGV4Y2VwdCBLZXlFcnJvcjoKICAgICAgICAgICAgaWYgcGFyZW50X2lkIGlzIG5vdCBfdW5kZWZpbmVkOgogICAgICAgICAgICAgICAgaWYgbG9ja19wZXJtaXNzaW9uczoKICAgICAgICAgICAgICAgICAgICBjYXRlZ29yeSA9IHNlbGYuZ3VpbGQuZ2V0X2NoYW5uZWwocGFyZW50X2lkKQogICAgICAgICAgICAgICAgICAgIG9wdGlvbnNbJ3Blcm1pc3Npb25fb3ZlcndyaXRlcyddID0gW2MuX2FzZGljdCgpIGZvciBjIGluIGNhdGVnb3J5Ll9vdmVyd3JpdGVzXQogICAgICAgICAgICAgICAgb3B0aW9uc1sncGFyZW50X2lkJ10gPSBwYXJlbnRfaWQKICAgICAgICAgICAgZWxpZiBsb2NrX3Blcm1pc3Npb25zIGFuZCBzZWxmLmNhdGVnb3J5X2lkIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgIyBpZiB3ZSdyZSBzeW5jaW5nIHBlcm1pc3Npb25zIG9uIGEgcHJlLWV4aXN0aW5nIGNoYW5uZWwgY2F0ZWdvcnkgd2l0aG91dCBjaGFuZ2luZyBpdAogICAgICAgICAgICAgICAgIyB3ZSBuZWVkIHRvIHVwZGF0ZSB0aGUgcGVybWlzc2lvbnMgdG8gcG9pbnQgdG8gdGhlIHByZS1leGlzdGluZyBjYXRlZ29yeQogICAgICAgICAgICAgICAgY2F0ZWdvcnkgPSBzZWxmLmd1aWxkLmdldF9jaGFubmVsKHNlbGYuY2F0ZWdvcnlfaWQpCiAgICAgICAgICAgICAgICBvcHRpb25zWydwZXJtaXNzaW9uX292ZXJ3cml0ZXMnXSA9IFtjLl9hc2RpY3QoKSBmb3IgYyBpbiBjYXRlZ29yeS5fb3ZlcndyaXRlc10KICAgICAgICBlbHNlOgogICAgICAgICAgICBhd2FpdCBzZWxmLl9tb3ZlKHBvc2l0aW9uLCBwYXJlbnRfaWQ9cGFyZW50X2lkLCBsb2NrX3Blcm1pc3Npb25zPWxvY2tfcGVybWlzc2lvbnMsIHJlYXNvbj1yZWFzb24pCgogICAgICAgIG92ZXJ3cml0ZXMgPSBvcHRpb25zLmdldCgnb3ZlcndyaXRlcycsIE5vbmUpCiAgICAgICAgaWYgb3ZlcndyaXRlcyBpcyBub3QgTm9uZToKICAgICAgICAgICAgcGVybXMgPSBbXQogICAgICAgICAgICBmb3IgdGFyZ2V0LCBwZXJtIGluIG92ZXJ3cml0ZXMuaXRlbXMoKToKICAgICAgICAgICAgICAgIGlmIG5vdCBpc2luc3RhbmNlKHBlcm0sIFBlcm1pc3Npb25PdmVyd3JpdGUpOgogICAgICAgICAgICAgICAgICAgIHJhaXNlIEludmFsaWRBcmd1bWVudCgnRXhwZWN0ZWQgUGVybWlzc2lvbk92ZXJ3cml0ZSByZWNlaXZlZCB7MC5fX25hbWVfX30nLmZvcm1hdCh0eXBlKHBlcm0pKSkKCiAgICAgICAgICAgICAgICBhbGxvdywgZGVueSA9IHBlcm0ucGFpcigpCiAgICAgICAgICAgICAgICBwYXlsb2FkID0gewogICAgICAgICAgICAgICAgICAgICdhbGxvdyc6IGFsbG93LnZhbHVlLAogICAgICAgICAgICAgICAgICAgICdkZW55JzogZGVueS52YWx1ZSwKICAgICAgICAgICAgICAgICAgICAnaWQnOiB0YXJnZXQuaWQKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiBpc2luc3RhbmNlKHRhcmdldCwgUm9sZSk6CiAgICAgICAgICAgICAgICAgICAgcGF5bG9hZFsndHlwZSddID0gJ3JvbGUnCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIHBheWxvYWRbJ3R5cGUnXSA9ICdtZW1iZXInCgogICAgICAgICAgICAgICAgcGVybXMuYXBwZW5kKHBheWxvYWQpCiAgICAgICAgICAgIG9wdGlvbnNbJ3Blcm1pc3Npb25fb3ZlcndyaXRlcyddID0gcGVybXMKCiAgICAgICAgdHJ5OgogICAgICAgICAgICBjaF90eXBlID0gb3B0aW9uc1sndHlwZSddCiAgICAgICAgZXhjZXB0IEtleUVycm9yOgogICAgICAgICAgICBwYXNzCiAgICAgICAgZWxzZToKICAgICAgICAgICAgaWYgbm90IGlzaW5zdGFuY2UoY2hfdHlwZSwgQ2hhbm5lbFR5cGUpOgogICAgICAgICAgICAgICAgcmFpc2UgSW52YWxpZEFyZ3VtZW50KCd0eXBlIGZpZWxkIG11c3QgYmUgb2YgdHlwZSBDaGFubmVsVHlwZScpCiAgICAgICAgICAgIG9wdGlvbnNbJ3R5cGUnXSA9IGNoX3R5cGUudmFsdWUKCiAgICAgICAgaWYgb3B0aW9uczoKICAgICAgICAgICAgZGF0YSA9IGF3YWl0IHNlbGYuX3N0YXRlLmh0dHAuZWRpdF9jaGFubmVsKHNlbGYuaWQsIHJlYXNvbj1yZWFzb24sICoqb3B0aW9ucykKICAgICAgICAgICAgc2VsZi5fdXBkYXRlKHNlbGYuZ3VpbGQsIGRhdGEpCgogICAgZGVmIF9maWxsX292ZXJ3cml0ZXMoc2VsZiwgZGF0YSk6CiAgICAgICAgc2VsZi5fb3ZlcndyaXRlcyA9IFtdCiAgICAgICAgZXZlcnlvbmVfaW5kZXggPSAwCiAgICAgICAgZXZlcnlvbmVfaWQgPSBzZWxmLmd1aWxkLmlkCgogICAgICAgIGZvciBpbmRleCwgb3ZlcnJpZGRlbiBpbiBlbnVtZXJhdGUoZGF0YS5nZXQoJ3Blcm1pc3Npb25fb3ZlcndyaXRlcycsIFtdKSk6CiAgICAgICAgICAgIG92ZXJyaWRkZW5faWQgPSBpbnQob3ZlcnJpZGRlbi5wb3AoJ2lkJykpCiAgICAgICAgICAgIHNlbGYuX292ZXJ3cml0ZXMuYXBwZW5kKF9PdmVyd3JpdGVzKGlkPW92ZXJyaWRkZW5faWQsICoqb3ZlcnJpZGRlbikpCgogICAgICAgICAgICBpZiBvdmVycmlkZGVuWyd0eXBlJ10gPT0gJ21lbWJlcic6CiAgICAgICAgICAgICAgICBjb250aW51ZQoKICAgICAgICAgICAgaWYgb3ZlcnJpZGRlbl9pZCA9PSBldmVyeW9uZV9pZDoKICAgICAgICAgICAgICAgICMgdGhlIEBldmVyeW9uZSByb2xlIGlzIG5vdCBndWFyYW50ZWVkIHRvIGJlIHRoZSBmaXJzdCBvbmUKICAgICAgICAgICAgICAgICMgaW4gdGhlIGxpc3Qgb2YgcGVybWlzc2lvbiBvdmVyd3JpdGVzLCBob3dldmVyIHRoZSBwZXJtaXNzaW9uCiAgICAgICAgICAgICAgICAjIHJlc29sdXRpb24gY29kZSBraW5kIG9mIHJlcXVpcmVzIHRoYXQgaXQgaXMgdGhlIGZpcnN0IG9uZSBpbgogICAgICAgICAgICAgICAgIyB0aGUgbGlzdCBzaW5jZSBpdCBpcyBzcGVjaWFsLiBTbyB3ZSBuZWVkIHRoZSBpbmRleCBzbyB3ZSBjYW4KICAgICAgICAgICAgICAgICMgc3dhcCBpdCB0byBiZSB0aGUgZmlyc3Qgb25lLgogICAgICAgICAgICAgICAgZXZlcnlvbmVfaW5kZXggPSBpbmRleAoKICAgICAgICAjIGRvIHRoZSBzd2FwCiAgICAgICAgdG1wID0gc2VsZi5fb3ZlcndyaXRlcwogICAgICAgIGlmIHRtcDoKICAgICAgICAgICAgdG1wW2V2ZXJ5b25lX2luZGV4XSwgdG1wWzBdID0gdG1wWzBdLCB0bXBbZXZlcnlvbmVfaW5kZXhdCgogICAgQHByb3BlcnR5CiAgICBkZWYgY2hhbmdlZF9yb2xlcyhzZWxmKToKICAgICAgICAiIiJMaXN0WzpjbGFzczpgfmRpc2NvcmQuUm9sZWBdOiBSZXR1cm5zIGEgbGlzdCBvZiByb2xlcyB0aGF0IGhhdmUgYmVlbiBvdmVycmlkZGVuIGZyb20KICAgICAgICB0aGVpciBkZWZhdWx0IHZhbHVlcyBpbiB0aGUgOmF0dHI6YH5kaXNjb3JkLkd1aWxkLnJvbGVzYCBhdHRyaWJ1dGUuIiIiCiAgICAgICAgcmV0ID0gW10KICAgICAgICBnID0gc2VsZi5ndWlsZAogICAgICAgIGZvciBvdmVyd3JpdGUgaW4gZmlsdGVyKGxhbWJkYSBvOiBvLnR5cGUgPT0gJ3JvbGUnLCBzZWxmLl9vdmVyd3JpdGVzKToKICAgICAgICAgICAgcm9sZSA9IGcuZ2V0X3JvbGUob3ZlcndyaXRlLmlkKQogICAgICAgICAgICBpZiByb2xlIGlzIE5vbmU6CiAgICAgICAgICAgICAgICBjb250aW51ZQoKICAgICAgICAgICAgcm9sZSA9IGNvcHkuY29weShyb2xlKQogICAgICAgICAgICByb2xlLnBlcm1pc3Npb25zLmhhbmRsZV9vdmVyd3JpdGUob3ZlcndyaXRlLmFsbG93LCBvdmVyd3JpdGUuZGVueSkKICAgICAgICAgICAgcmV0LmFwcGVuZChyb2xlKQogICAgICAgIHJldHVybiByZXQKCiAgICBAcHJvcGVydHkKICAgIGRlZiBtZW50aW9uKHNlbGYpOgogICAgICAgICIiIjpjbGFzczpgc3RyYDogVGhlIHN0cmluZyB0aGF0IGFsbG93cyB5b3UgdG8gbWVudGlvbiB0aGUgY2hhbm5lbC4iIiIKICAgICAgICByZXR1cm4gJzwjJXM+JyAlIHNlbGYuaWQKCiAgICBAcHJvcGVydHkKICAgIGRlZiBjcmVhdGVkX2F0KHNlbGYpOgogICAgICAgICIiIjpjbGFzczpgZGF0ZXRpbWUuZGF0ZXRpbWVgOiBSZXR1cm5zIHRoZSBjaGFubmVsJ3MgY3JlYXRpb24gdGltZSBpbiBVVEMuIiIiCiAgICAgICAgcmV0dXJuIHV0aWxzLnNub3dmbGFrZV90aW1lKHNlbGYuaWQpCgogICAgZGVmIG92ZXJ3cml0ZXNfZm9yKHNlbGYsIG9iaik6CiAgICAgICAgIiIiUmV0dXJucyB0aGUgY2hhbm5lbC1zcGVjaWZpYyBvdmVyd3JpdGVzIGZvciBhIG1lbWJlciBvciBhIHJvbGUuCgogICAgICAgIFBhcmFtZXRlcnMKICAgICAgICAtLS0tLS0tLS0tLQogICAgICAgIG9iajogVW5pb25bOmNsYXNzOmB+ZGlzY29yZC5Sb2xlYCwgOmNsYXNzOmB+ZGlzY29yZC5hYmMuVXNlcmBdCiAgICAgICAgICAgIFRoZSByb2xlIG9yIHVzZXIgZGVub3RpbmcKICAgICAgICAgICAgd2hvc2Ugb3ZlcndyaXRlIHRvIGdldC4KCiAgICAgICAgUmV0dXJucwogICAgICAgIC0tLS0tLS0tLQogICAgICAgIDpjbGFzczpgfmRpc2NvcmQuUGVybWlzc2lvbk92ZXJ3cml0ZWAKICAgICAgICAgICAgVGhlIHBlcm1pc3Npb24gb3ZlcndyaXRlcyBmb3IgdGhpcyBvYmplY3QuCiAgICAgICAgIiIiCgogICAgICAgIGlmIGlzaW5zdGFuY2Uob2JqLCBVc2VyKToKICAgICAgICAgICAgcHJlZGljYXRlID0gbGFtYmRhIHA6IHAudHlwZSA9PSAnbWVtYmVyJwogICAgICAgIGVsaWYgaXNpbnN0YW5jZShvYmosIFJvbGUpOgogICAgICAgICAgICBwcmVkaWNhdGUgPSBsYW1iZGEgcDogcC50eXBlID09ICdyb2xlJwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHByZWRpY2F0ZSA9IGxhbWJkYSBwOiBUcnVlCgogICAgICAgIGZvciBvdmVyd3JpdGUgaW4gZmlsdGVyKHByZWRpY2F0ZSwgc2VsZi5fb3ZlcndyaXRlcyk6CiAgICAgICAgICAgIGlmIG92ZXJ3cml0ZS5pZCA9PSBvYmouaWQ6CiAgICAgICAgICAgICAgICBhbGxvdyA9IFBlcm1pc3Npb25zKG92ZXJ3cml0ZS5hbGxvdykKICAgICAgICAgICAgICAgIGRlbnkgPSBQZXJtaXNzaW9ucyhvdmVyd3JpdGUuZGVueSkKICAgICAgICAgICAgICAgIHJldHVybiBQZXJtaXNzaW9uT3ZlcndyaXRlLmZyb21fcGFpcihhbGxvdywgZGVueSkKCiAgICAgICAgcmV0dXJuIFBlcm1pc3Npb25PdmVyd3JpdGUoKQoKICAgIEBwcm9wZXJ0eQogICAgZGVmIG92ZXJ3cml0ZXMoc2VsZik6CiAgICAgICAgIiIiUmV0dXJucyBhbGwgb2YgdGhlIGNoYW5uZWwncyBvdmVyd3JpdGVzLgoKICAgICAgICBUaGlzIGlzIHJldHVybmVkIGFzIGEgZGljdGlvbmFyeSB3aGVyZSB0aGUga2V5IGNvbnRhaW5zIHRoZSB0YXJnZXQgd2hpY2gKICAgICAgICBjYW4gYmUgZWl0aGVyIGEgOmNsYXNzOmB+ZGlzY29yZC5Sb2xlYCBvciBhIDpjbGFzczpgfmRpc2NvcmQuTWVtYmVyYCBhbmQgdGhlIHZhbHVlIGlzIHRoZQogICAgICAgIG92ZXJ3cml0ZSBhcyBhIDpjbGFzczpgfmRpc2NvcmQuUGVybWlzc2lvbk92ZXJ3cml0ZWAuCgogICAgICAgIFJldHVybnMKICAgICAgICAtLS0tLS0tLQogICAgICAgIE1hcHBpbmdbVW5pb25bOmNsYXNzOmB+ZGlzY29yZC5Sb2xlYCwgOmNsYXNzOmB+ZGlzY29yZC5NZW1iZXJgXSwgOmNsYXNzOmB+ZGlzY29yZC5QZXJtaXNzaW9uT3ZlcndyaXRlYF0KICAgICAgICAgICAgVGhlIGNoYW5uZWwncyBwZXJtaXNzaW9uIG92ZXJ3cml0ZXMuCiAgICAgICAgIiIiCiAgICAgICAgcmV0ID0ge30KICAgICAgICBmb3Igb3cgaW4gc2VsZi5fb3ZlcndyaXRlczoKICAgICAgICAgICAgYWxsb3cgPSBQZXJtaXNzaW9ucyhvdy5hbGxvdykKICAgICAgICAgICAgZGVueSA9IFBlcm1pc3Npb25zKG93LmRlbnkpCiAgICAgICAgICAgIG92ZXJ3cml0ZSA9IFBlcm1pc3Npb25PdmVyd3JpdGUuZnJvbV9wYWlyKGFsbG93LCBkZW55KQoKICAgICAgICAgICAgaWYgb3cudHlwZSA9PSAncm9sZSc6CiAgICAgICAgICAgICAgICB0YXJnZXQgPSBzZWxmLmd1aWxkLmdldF9yb2xlKG93LmlkKQogICAgICAgICAgICBlbGlmIG93LnR5cGUgPT0gJ21lbWJlcic6CiAgICAgICAgICAgICAgICB0YXJnZXQgPSBzZWxmLmd1aWxkLmdldF9tZW1iZXIob3cuaWQpCgogICAgICAgICAgICAjIFRPRE86IFRoZXJlIGlzIHBvdGVudGlhbCBkYXRhIGxvc3MgaGVyZSBpbiB0aGUgbm9uLWNodW5rZWQKICAgICAgICAgICAgIyBjYXNlLCBpLmUuIHRhcmdldCBpcyBOb25lIGJlY2F1c2UgZ2V0X21lbWJlciByZXR1cm5lZCBub3RoaW5nLgogICAgICAgICAgICAjIFRoaXMgY2FuIGJlIGZpeGVkIHdpdGggYSBzbGlnaHQgYnJlYWtpbmcgY2hhbmdlIHRvIHRoZSByZXR1cm4gdHlwZSwKICAgICAgICAgICAgIyBpLmUuIGFkZGluZyBkaXNjb3JkLk9iamVjdCB0byB0aGUgbGlzdCBvZiBpdAogICAgICAgICAgICAjIEhvd2V2ZXIsIGZvciBub3cgdGhpcyBpcyBhbiBhY2NlcHRhYmxlIGNvbXByb21pc2UuCiAgICAgICAgICAgIGlmIHRhcmdldCBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgIHJldFt0YXJnZXRdID0gb3ZlcndyaXRlCiAgICAgICAgcmV0dXJuIHJldAoKICAgIEBwcm9wZXJ0eQogICAgZGVmIGNhdGVnb3J5KHNlbGYpOgogICAgICAgICIiIk9wdGlvbmFsWzpjbGFzczpgfmRpc2NvcmQuQ2F0ZWdvcnlDaGFubmVsYF06IFRoZSBjYXRlZ29yeSB0aGlzIGNoYW5uZWwgYmVsb25ncyB0by4KCiAgICAgICAgSWYgdGhlcmUgaXMgbm8gY2F0ZWdvcnkgdGhlbiB0aGlzIGlzIGBgTm9uZWBgLgogICAgICAgICIiIgogICAgICAgIHJldHVybiBzZWxmLmd1aWxkLmdldF9jaGFubmVsKHNlbGYuY2F0ZWdvcnlfaWQpCgogICAgQHByb3BlcnR5CiAgICBkZWYgcGVybWlzc2lvbnNfc3luY2VkKHNlbGYpOgogICAgICAgICIiIjpjbGFzczpgYm9vbGA6IFdoZXRoZXIgb3Igbm90IHRoZSBwZXJtaXNzaW9ucyBmb3IgdGhpcyBjaGFubmVsIGFyZSBzeW5jZWQgd2l0aCB0aGUKICAgICAgICBjYXRlZ29yeSBpdCBiZWxvbmdzIHRvLgoKICAgICAgICBJZiB0aGVyZSBpcyBubyBjYXRlZ29yeSB0aGVuIHRoaXMgaXMgYGBGYWxzZWBgLgoKICAgICAgICAuLiB2ZXJzaW9uYWRkZWQ6OiAxLjMKICAgICAgICAiIiIKICAgICAgICBjYXRlZ29yeSA9IHNlbGYuZ3VpbGQuZ2V0X2NoYW5uZWwoc2VsZi5jYXRlZ29yeV9pZCkKICAgICAgICByZXR1cm4gYm9vbChjYXRlZ29yeSBhbmQgY2F0ZWdvcnkub3ZlcndyaXRlcyA9PSBzZWxmLm92ZXJ3cml0ZXMpCgogICAgZGVmIHBlcm1pc3Npb25zX2ZvcihzZWxmLCBtZW1iZXIpOgogICAgICAgICIiIkhhbmRsZXMgcGVybWlzc2lvbiByZXNvbHV0aW9uIGZvciB0aGUgY3VycmVudCA6Y2xhc3M6YH5kaXNjb3JkLk1lbWJlcmAuCgogICAgICAgIFRoaXMgZnVuY3Rpb24gdGFrZXMgaW50byBjb25zaWRlcmF0aW9uIHRoZSBmb2xsb3dpbmcgY2FzZXM6CgogICAgICAgIC0gR3VpbGQgb3duZXIKICAgICAgICAtIEd1aWxkIHJvbGVzCiAgICAgICAgLSBDaGFubmVsIG92ZXJyaWRlcwogICAgICAgIC0gTWVtYmVyIG92ZXJyaWRlcwoKICAgICAgICBQYXJhbWV0ZXJzCiAgICAgICAgLS0tLS0tLS0tLQogICAgICAgIG1lbWJlcjogOmNsYXNzOmB+ZGlzY29yZC5NZW1iZXJgCiAgICAgICAgICAgIFRoZSBtZW1iZXIgdG8gcmVzb2x2ZSBwZXJtaXNzaW9ucyBmb3IuCgogICAgICAgIFJldHVybnMKICAgICAgICAtLS0tLS0tCiAgICAgICAgOmNsYXNzOmB+ZGlzY29yZC5QZXJtaXNzaW9uc2AKICAgICAgICAgICAgVGhlIHJlc29sdmVkIHBlcm1pc3Npb25zIGZvciB0aGUgbWVtYmVyLgogICAgICAgICIiIgoKICAgICAgICAjIFRoZSBjdXJyZW50IGNhc2VzIGNhbiBiZSBleHBsYWluZWQgYXM6CiAgICAgICAgIyBHdWlsZCBvd25lciBnZXQgYWxsIHBlcm1pc3Npb25zIC0tIG5vIHF1ZXN0aW9ucyBhc2tlZC4gT3RoZXJ3aXNlLi4uCiAgICAgICAgIyBUaGUgQGV2ZXJ5b25lIHJvbGUgZ2V0cyB0aGUgZmlyc3QgYXBwbGljYXRpb24uCiAgICAgICAgIyBBZnRlciB0aGF0LCB0aGUgYXBwbGllZCByb2xlcyB0aGF0IHRoZSB1c2VyIGhhcyBpbiB0aGUgY2hhbm5lbAogICAgICAgICMgKG9yIG90aGVyd2lzZSkgYXJlIHRoZW4gT1InZCB0b2dldGhlci4KICAgICAgICAjIEFmdGVyIHRoZSByb2xlIHBlcm1pc3Npb25zIGFyZSByZXNvbHZlZCwgdGhlIG1lbWJlciBwZXJtaXNzaW9ucwogICAgICAgICMgaGF2ZSB0byB0YWtlIGludG8gZWZmZWN0LgogICAgICAgICMgQWZ0ZXIgYWxsIHRoYXQgaXMgZG9uZS4uIHlvdSBoYXZlIHRvIGRvIHRoZSBmb2xsb3dpbmc6CgogICAgICAgICMgSWYgbWFuYWdlIHBlcm1pc3Npb25zIGlzIFRydWUsIHRoZW4gYWxsIHBlcm1pc3Npb25zIGFyZSBzZXQgdG8gVHJ1ZS4KCiAgICAgICAgIyBUaGUgb3BlcmF0aW9uIGZpcnN0IHRha2VzIGludG8gY29uc2lkZXJhdGlvbiB0aGUgZGVuaWVkCiAgICAgICAgIyBhbmQgdGhlbiB0aGUgYWxsb3dlZC4KCiAgICAgICAgaWYgc2VsZi5ndWlsZC5vd25lcl9pZCA9PSBtZW1iZXIuaWQ6CiAgICAgICAgICAgIHJldHVybiBQZXJtaXNzaW9ucy5hbGwoKQoKICAgICAgICBkZWZhdWx0ID0gc2VsZi5ndWlsZC5kZWZhdWx0X3JvbGUKICAgICAgICBiYXNlID0gUGVybWlzc2lvbnMoZGVmYXVsdC5wZXJtaXNzaW9ucy52YWx1ZSkKICAgICAgICByb2xlcyA9IG1lbWJlci5fcm9sZXMKICAgICAgICBnZXRfcm9sZSA9IHNlbGYuZ3VpbGQuZ2V0X3JvbGUKCiAgICAgICAgIyBBcHBseSBndWlsZCByb2xlcyB0aGF0IHRoZSBtZW1iZXIgaGFzLgogICAgICAgIGZvciByb2xlX2lkIGluIHJvbGVzOgogICAgICAgICAgICByb2xlID0gZ2V0X3JvbGUocm9sZV9pZCkKICAgICAgICAgICAgaWYgcm9sZSBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgIGJhc2UudmFsdWUgfD0gcm9sZS5fcGVybWlzc2lvbnMKCiAgICAgICAgIyBHdWlsZC13aWRlIEFkbWluaXN0cmF0b3IgLT4gVHJ1ZSBmb3IgZXZlcnl0aGluZwogICAgICAgICMgQnlwYXNzIGFsbCBjaGFubmVsLXNwZWNpZmljIG92ZXJyaWRlcwogICAgICAgIGlmIGJhc2UuYWRtaW5pc3RyYXRvcjoKICAgICAgICAgICAgcmV0dXJuIFBlcm1pc3Npb25zLmFsbCgpCgogICAgICAgICMgQXBwbHkgQGV2ZXJ5b25lIGFsbG93L2RlbnkgZmlyc3Qgc2luY2UgaXQncyBzcGVjaWFsCiAgICAgICAgdHJ5OgogICAgICAgICAgICBtYXliZV9ldmVyeW9uZSA9IHNlbGYuX292ZXJ3cml0ZXNbMF0KICAgICAgICAgICAgaWYgbWF5YmVfZXZlcnlvbmUuaWQgPT0gc2VsZi5ndWlsZC5pZDoKICAgICAgICAgICAgICAgIGJhc2UuaGFuZGxlX292ZXJ3cml0ZShhbGxvdz1tYXliZV9ldmVyeW9uZS5hbGxvdywgZGVueT1tYXliZV9ldmVyeW9uZS5kZW55KQogICAgICAgICAgICAgICAgcmVtYWluaW5nX292ZXJ3cml0ZXMgPSBzZWxmLl9vdmVyd3JpdGVzWzE6XQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgcmVtYWluaW5nX292ZXJ3cml0ZXMgPSBzZWxmLl9vdmVyd3JpdGVzCiAgICAgICAgZXhjZXB0IEluZGV4RXJyb3I6CiAgICAgICAgICAgIHJlbWFpbmluZ19vdmVyd3JpdGVzID0gc2VsZi5fb3ZlcndyaXRlcwoKICAgICAgICBkZW5pZXMgPSAwCiAgICAgICAgYWxsb3dzID0gMAoKICAgICAgICAjIEFwcGx5IGNoYW5uZWwgc3BlY2lmaWMgcm9sZSBwZXJtaXNzaW9uIG92ZXJ3cml0ZXMKICAgICAgICBmb3Igb3ZlcndyaXRlIGluIHJlbWFpbmluZ19vdmVyd3JpdGVzOgogICAgICAgICAgICBpZiBvdmVyd3JpdGUudHlwZSA9PSAncm9sZScgYW5kIHJvbGVzLmhhcyhvdmVyd3JpdGUuaWQpOgogICAgICAgICAgICAgICAgZGVuaWVzIHw9IG92ZXJ3cml0ZS5kZW55CiAgICAgICAgICAgICAgICBhbGxvd3MgfD0gb3ZlcndyaXRlLmFsbG93CgogICAgICAgIGJhc2UuaGFuZGxlX292ZXJ3cml0ZShhbGxvdz1hbGxvd3MsIGRlbnk9ZGVuaWVzKQoKICAgICAgICAjIEFwcGx5IG1lbWJlciBzcGVjaWZpYyBwZXJtaXNzaW9uIG92ZXJ3cml0ZXMKICAgICAgICBmb3Igb3ZlcndyaXRlIGluIHJlbWFpbmluZ19vdmVyd3JpdGVzOgogICAgICAgICAgICBpZiBvdmVyd3JpdGUudHlwZSA9PSAnbWVtYmVyJyBhbmQgb3ZlcndyaXRlLmlkID09IG1lbWJlci5pZDoKICAgICAgICAgICAgICAgIGJhc2UuaGFuZGxlX292ZXJ3cml0ZShhbGxvdz1vdmVyd3JpdGUuYWxsb3csIGRlbnk9b3ZlcndyaXRlLmRlbnkpCiAgICAgICAgICAgICAgICBicmVhawoKICAgICAgICAjIGlmIHlvdSBjYW4ndCBzZW5kIGEgbWVzc2FnZSBpbiBhIGNoYW5uZWwgdGhlbiB5b3UgY2FuJ3QgaGF2ZSBjZXJ0YWluCiAgICAgICAgIyBwZXJtaXNzaW9ucyBhcyB3ZWxsCiAgICAgICAgaWYgbm90IGJhc2Uuc2VuZF9tZXNzYWdlczoKICAgICAgICAgICAgYmFzZS5zZW5kX3R0c19tZXNzYWdlcyA9IEZhbHNlCiAgICAgICAgICAgIGJhc2UubWVudGlvbl9ldmVyeW9uZSA9IEZhbHNlCiAgICAgICAgICAgIGJhc2UuZW1iZWRfbGlua3MgPSBGYWxzZQogICAgICAgICAgICBiYXNlLmF0dGFjaF9maWxlcyA9IEZhbHNlCgogICAgICAgICMgaWYgeW91IGNhbid0IHJlYWQgYSBjaGFubmVsIHRoZW4geW91IGhhdmUgbm8gcGVybWlzc2lvbnMgdGhlcmUKICAgICAgICBpZiBub3QgYmFzZS5yZWFkX21lc3NhZ2VzOgogICAgICAgICAgICBkZW5pZWQgPSBQZXJtaXNzaW9ucy5hbGxfY2hhbm5lbCgpCiAgICAgICAgICAgIGJhc2UudmFsdWUgJj0gfmRlbmllZC52YWx1ZQoKICAgICAgICByZXR1cm4gYmFzZQoKICAgIGFzeW5jIGRlZiBkZWxldGUoc2VsZiwgKiwgcmVhc29uPU5vbmUpOgogICAgICAgICIiInxjb3JvfAoKICAgICAgICBEZWxldGVzIHRoZSBjaGFubmVsLgoKICAgICAgICBZb3UgbXVzdCBoYXZlIDphdHRyOmB+UGVybWlzc2lvbnMubWFuYWdlX2NoYW5uZWxzYCBwZXJtaXNzaW9uIHRvIHVzZSB0aGlzLgoKICAgICAgICBQYXJhbWV0ZXJzCiAgICAgICAgLS0tLS0tLS0tLS0KICAgICAgICByZWFzb246IE9wdGlvbmFsWzpjbGFzczpgc3RyYF0KICAgICAgICAgICAgVGhlIHJlYXNvbiBmb3IgZGVsZXRpbmcgdGhpcyBjaGFubmVsLgogICAgICAgICAgICBTaG93cyB1cCBvbiB0aGUgYXVkaXQgbG9nLgoKICAgICAgICBSYWlzZXMKICAgICAgICAtLS0tLS0tCiAgICAgICAgfmRpc2NvcmQuRm9yYmlkZGVuCiAgICAgICAgICAgIFlvdSBkbyBub3QgaGF2ZSBwcm9wZXIgcGVybWlzc2lvbnMgdG8gZGVsZXRlIHRoZSBjaGFubmVsLgogICAgICAgIH5kaXNjb3JkLk5vdEZvdW5kCiAgICAgICAgICAgIFRoZSBjaGFubmVsIHdhcyBub3QgZm91bmQgb3Igd2FzIGFscmVhZHkgZGVsZXRlZC4KICAgICAgICB+ZGlzY29yZC5IVFRQRXhjZXB0aW9uCiAgICAgICAgICAgIERlbGV0aW5nIHRoZSBjaGFubmVsIGZhaWxlZC4KICAgICAgICAiIiIKICAgICAgICBhd2FpdCBzZWxmLl9zdGF0ZS5odHRwLmRlbGV0ZV9jaGFubmVsKHNlbGYuaWQsIHJlYXNvbj1yZWFzb24pCgogICAgYXN5bmMgZGVmIHNldF9wZXJtaXNzaW9ucyhzZWxmLCB0YXJnZXQsICosIG92ZXJ3cml0ZT1fdW5kZWZpbmVkLCByZWFzb249Tm9uZSwgKipwZXJtaXNzaW9ucyk6CiAgICAgICAgciIiInxjb3JvfAoKICAgICAgICBTZXRzIHRoZSBjaGFubmVsIHNwZWNpZmljIHBlcm1pc3Npb24gb3ZlcndyaXRlcyBmb3IgYSB0YXJnZXQgaW4gdGhlCiAgICAgICAgY2hhbm5lbC4KCiAgICAgICAgVGhlIGBgdGFyZ2V0YGAgcGFyYW1ldGVyIHNob3VsZCBlaXRoZXIgYmUgYSA6Y2xhc3M6YH5kaXNjb3JkLk1lbWJlcmAgb3IgYQogICAgICAgIDpjbGFzczpgfmRpc2NvcmQuUm9sZWAgdGhhdCBiZWxvbmdzIHRvIGd1aWxkLgoKICAgICAgICBUaGUgYGBvdmVyd3JpdGVgYCBwYXJhbWV0ZXIsIGlmIGdpdmVuLCBtdXN0IGVpdGhlciBiZSBgYE5vbmVgYCBvcgogICAgICAgIDpjbGFzczpgfmRpc2NvcmQuUGVybWlzc2lvbk92ZXJ3cml0ZWAuIEZvciBjb252ZW5pZW5jZSwgeW91IGNhbiBwYXNzIGluCiAgICAgICAga2V5d29yZCBhcmd1bWVudHMgZGVub3RpbmcgOmNsYXNzOmB+ZGlzY29yZC5QZXJtaXNzaW9uc2AgYXR0cmlidXRlcy4gSWYgdGhpcyBpcwogICAgICAgIGRvbmUsIHRoZW4geW91IGNhbm5vdCBtaXggdGhlIGtleXdvcmQgYXJndW1lbnRzIHdpdGggdGhlIGBgb3ZlcndyaXRlYGAKICAgICAgICBwYXJhbWV0ZXIuCgogICAgICAgIElmIHRoZSBgYG92ZXJ3cml0ZWBgIHBhcmFtZXRlciBpcyBgYE5vbmVgYCwgdGhlbiB0aGUgcGVybWlzc2lvbgogICAgICAgIG92ZXJ3cml0ZXMgYXJlIGRlbGV0ZWQuCgogICAgICAgIFlvdSBtdXN0IGhhdmUgdGhlIDphdHRyOmB+UGVybWlzc2lvbnMubWFuYWdlX3JvbGVzYCBwZXJtaXNzaW9uIHRvIHVzZSB0aGlzLgoKICAgICAgICBFeGFtcGxlcwogICAgICAgIC0tLS0tLS0tLS0KCiAgICAgICAgU2V0dGluZyBhbGxvdyBhbmQgZGVueTogOjoKCiAgICAgICAgICAgIGF3YWl0IG1lc3NhZ2UuY2hhbm5lbC5zZXRfcGVybWlzc2lvbnMobWVzc2FnZS5hdXRob3IsIHJlYWRfbWVzc2FnZXM9VHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VuZF9tZXNzYWdlcz1GYWxzZSkKCiAgICAgICAgRGVsZXRpbmcgb3ZlcndyaXRlcyA6OgoKICAgICAgICAgICAgYXdhaXQgY2hhbm5lbC5zZXRfcGVybWlzc2lvbnMobWVtYmVyLCBvdmVyd3JpdGU9Tm9uZSkKCiAgICAgICAgVXNpbmcgOmNsYXNzOmB+ZGlzY29yZC5QZXJtaXNzaW9uT3ZlcndyaXRlYCA6OgoKICAgICAgICAgICAgb3ZlcndyaXRlID0gZGlzY29yZC5QZXJtaXNzaW9uT3ZlcndyaXRlKCkKICAgICAgICAgICAgb3ZlcndyaXRlLnNlbmRfbWVzc2FnZXMgPSBGYWxzZQogICAgICAgICAgICBvdmVyd3JpdGUucmVhZF9tZXNzYWdlcyA9IFRydWUKICAgICAgICAgICAgYXdhaXQgY2hhbm5lbC5zZXRfcGVybWlzc2lvbnMobWVtYmVyLCBvdmVyd3JpdGU9b3ZlcndyaXRlKQoKICAgICAgICBQYXJhbWV0ZXJzCiAgICAgICAgLS0tLS0tLS0tLS0KICAgICAgICB0YXJnZXQ6IFVuaW9uWzpjbGFzczpgfmRpc2NvcmQuTWVtYmVyYCwgOmNsYXNzOmB+ZGlzY29yZC5Sb2xlYF0KICAgICAgICAgICAgVGhlIG1lbWJlciBvciByb2xlIHRvIG92ZXJ3cml0ZSBwZXJtaXNzaW9ucyBmb3IuCiAgICAgICAgb3ZlcndyaXRlOiBPcHRpb25hbFs6Y2xhc3M6YH5kaXNjb3JkLlBlcm1pc3Npb25PdmVyd3JpdGVgXQogICAgICAgICAgICBUaGUgcGVybWlzc2lvbnMgdG8gYWxsb3cgYW5kIGRlbnkgdG8gdGhlIHRhcmdldCwgb3IgYGBOb25lYGAgdG8KICAgICAgICAgICAgZGVsZXRlIHRoZSBvdmVyd3JpdGUuCiAgICAgICAgXCpcKnBlcm1pc3Npb25zCiAgICAgICAgICAgIEEga2V5d29yZCBhcmd1bWVudCBsaXN0IG9mIHBlcm1pc3Npb25zIHRvIHNldCBmb3IgZWFzZSBvZiB1c2UuCiAgICAgICAgICAgIENhbm5vdCBiZSBtaXhlZCB3aXRoIGBgb3ZlcndyaXRlYGAuCiAgICAgICAgcmVhc29uOiBPcHRpb25hbFs6Y2xhc3M6YHN0cmBdCiAgICAgICAgICAgIFRoZSByZWFzb24gZm9yIGRvaW5nIHRoaXMgYWN0aW9uLiBTaG93cyB1cCBvbiB0aGUgYXVkaXQgbG9nLgoKICAgICAgICBSYWlzZXMKICAgICAgICAtLS0tLS0tCiAgICAgICAgfmRpc2NvcmQuRm9yYmlkZGVuCiAgICAgICAgICAgIFlvdSBkbyBub3QgaGF2ZSBwZXJtaXNzaW9ucyB0byBlZGl0IGNoYW5uZWwgc3BlY2lmaWMgcGVybWlzc2lvbnMuCiAgICAgICAgfmRpc2NvcmQuSFRUUEV4Y2VwdGlvbgogICAgICAgICAgICBFZGl0aW5nIGNoYW5uZWwgc3BlY2lmaWMgcGVybWlzc2lvbnMgZmFpbGVkLgogICAgICAgIH5kaXNjb3JkLk5vdEZvdW5kCiAgICAgICAgICAgIFRoZSByb2xlIG9yIG1lbWJlciBiZWluZyBlZGl0ZWQgaXMgbm90IHBhcnQgb2YgdGhlIGd1aWxkLgogICAgICAgIH5kaXNjb3JkLkludmFsaWRBcmd1bWVudAogICAgICAgICAgICBUaGUgb3ZlcndyaXRlIHBhcmFtZXRlciBpbnZhbGlkIG9yIHRoZSB0YXJnZXQgdHlwZSB3YXMgbm90CiAgICAgICAgICAgIDpjbGFzczpgfmRpc2NvcmQuUm9sZWAgb3IgOmNsYXNzOmB+ZGlzY29yZC5NZW1iZXJgLgogICAgICAgICIiIgoKICAgICAgICBodHRwID0gc2VsZi5fc3RhdGUuaHR0cAoKICAgICAgICBpZiBpc2luc3RhbmNlKHRhcmdldCwgVXNlcik6CiAgICAgICAgICAgIHBlcm1fdHlwZSA9ICdtZW1iZXInCiAgICAgICAgZWxpZiBpc2luc3RhbmNlKHRhcmdldCwgUm9sZSk6CiAgICAgICAgICAgIHBlcm1fdHlwZSA9ICdyb2xlJwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJhaXNlIEludmFsaWRBcmd1bWVudCgndGFyZ2V0IHBhcmFtZXRlciBtdXN0IGJlIGVpdGhlciBNZW1iZXIgb3IgUm9sZScpCgogICAgICAgIGlmIGlzaW5zdGFuY2Uob3ZlcndyaXRlLCBfVW5kZWZpbmVkKToKICAgICAgICAgICAgaWYgbGVuKHBlcm1pc3Npb25zKSA9PSAwOgogICAgICAgICAgICAgICAgcmFpc2UgSW52YWxpZEFyZ3VtZW50KCdObyBvdmVyd3JpdGUgcHJvdmlkZWQuJykKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgb3ZlcndyaXRlID0gUGVybWlzc2lvbk92ZXJ3cml0ZSgqKnBlcm1pc3Npb25zKQogICAgICAgICAgICBleGNlcHQgKFZhbHVlRXJyb3IsIFR5cGVFcnJvcik6CiAgICAgICAgICAgICAgICByYWlzZSBJbnZhbGlkQXJndW1lbnQoJ0ludmFsaWQgcGVybWlzc2lvbnMgZ2l2ZW4gdG8ga2V5d29yZCBhcmd1bWVudHMuJykKICAgICAgICBlbHNlOgogICAgICAgICAgICBpZiBsZW4ocGVybWlzc2lvbnMpID4gMDoKICAgICAgICAgICAgICAgIHJhaXNlIEludmFsaWRBcmd1bWVudCgnQ2Fubm90IG1peCBvdmVyd3JpdGUgYW5kIGtleXdvcmQgYXJndW1lbnRzLicpCgogICAgICAgICMgVE9ETzogd2FpdCBmb3IgZXZlbnQKCiAgICAgICAgaWYgb3ZlcndyaXRlIGlzIE5vbmU6CiAgICAgICAgICAgIGF3YWl0IGh0dHAuZGVsZXRlX2NoYW5uZWxfcGVybWlzc2lvbnMoc2VsZi5pZCwgdGFyZ2V0LmlkLCByZWFzb249cmVhc29uKQogICAgICAgIGVsaWYgaXNpbnN0YW5jZShvdmVyd3JpdGUsIFBlcm1pc3Npb25PdmVyd3JpdGUpOgogICAgICAgICAgICAoYWxsb3csIGRlbnkpID0gb3ZlcndyaXRlLnBhaXIoKQogICAgICAgICAgICBhd2FpdCBodHRwLmVkaXRfY2hhbm5lbF9wZXJtaXNzaW9ucyhzZWxmLmlkLCB0YXJnZXQuaWQsIGFsbG93LnZhbHVlLCBkZW55LnZhbHVlLCBwZXJtX3R5cGUsIHJlYXNvbj1yZWFzb24pCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmFpc2UgSW52YWxpZEFyZ3VtZW50KCdJbnZhbGlkIG92ZXJ3cml0ZSB0eXBlIHByb3ZpZGVkLicpCgogICAgYXN5bmMgZGVmIF9jbG9uZV9pbXBsKHNlbGYsIGJhc2VfYXR0cnMsICosIG5hbWU9Tm9uZSwgcmVhc29uPU5vbmUpOgogICAgICAgIGJhc2VfYXR0cnNbJ3Blcm1pc3Npb25fb3ZlcndyaXRlcyddID0gWwogICAgICAgICAgICB4Ll9hc2RpY3QoKSBmb3IgeCBpbiBzZWxmLl9vdmVyd3JpdGVzCiAgICAgICAgXQogICAgICAgIGJhc2VfYXR0cnNbJ3BhcmVudF9pZCddID0gc2VsZi5jYXRlZ29yeV9pZAogICAgICAgIGJhc2VfYXR0cnNbJ25hbWUnXSA9IG5hbWUgb3Igc2VsZi5uYW1lCiAgICAgICAgZ3VpbGRfaWQgPSBzZWxmLmd1aWxkLmlkCiAgICAgICAgY2xzID0gc2VsZi5fX2NsYXNzX18KICAgICAgICBkYXRhID0gYXdhaXQgc2VsZi5fc3RhdGUuaHR0cC5jcmVhdGVfY2hhbm5lbChndWlsZF9pZCwgc2VsZi50eXBlLnZhbHVlLCByZWFzb249cmVhc29uLCAqKmJhc2VfYXR0cnMpCiAgICAgICAgb2JqID0gY2xzKHN0YXRlPXNlbGYuX3N0YXRlLCBndWlsZD1zZWxmLmd1aWxkLCBkYXRhPWRhdGEpCgogICAgICAgICMgdGVtcG9yYXJpbHkgYWRkIGl0IHRvIHRoZSBjYWNoZQogICAgICAgIHNlbGYuZ3VpbGQuX2NoYW5uZWxzW29iai5pZF0gPSBvYmoKICAgICAgICByZXR1cm4gb2JqCgogICAgYXN5bmMgZGVmIGNsb25lKHNlbGYsICosIG5hbWU9Tm9uZSwgcmVhc29uPU5vbmUpOgogICAgICAgICIiInxjb3JvfAoKICAgICAgICBDbG9uZXMgdGhpcyBjaGFubmVsLiBUaGlzIGNyZWF0ZXMgYSBjaGFubmVsIHdpdGggdGhlIHNhbWUgcHJvcGVydGllcwogICAgICAgIGFzIHRoaXMgY2hhbm5lbC4KCiAgICAgICAgWW91IG11c3QgaGF2ZSB0aGUgOmF0dHI6YH5kaXNjb3JkLlBlcm1pc3Npb25zLm1hbmFnZV9jaGFubmVsc2AgcGVybWlzc2lvbiB0bwogICAgICAgIGRvIHRoaXMuCgogICAgICAgIC4uIHZlcnNpb25hZGRlZDo6IDEuMQoKICAgICAgICBQYXJhbWV0ZXJzCiAgICAgICAgLS0tLS0tLS0tLS0tCiAgICAgICAgbmFtZTogT3B0aW9uYWxbOmNsYXNzOmBzdHJgXQogICAgICAgICAgICBUaGUgbmFtZSBvZiB0aGUgbmV3IGNoYW5uZWwuIElmIG5vdCBwcm92aWRlZCwgZGVmYXVsdHMgdG8gdGhpcwogICAgICAgICAgICBjaGFubmVsIG5hbWUuCiAgICAgICAgcmVhc29uOiBPcHRpb25hbFs6Y2xhc3M6YHN0cmBdCiAgICAgICAgICAgIFRoZSByZWFzb24gZm9yIGNsb25pbmcgdGhpcyBjaGFubmVsLiBTaG93cyB1cCBvbiB0aGUgYXVkaXQgbG9nLgoKICAgICAgICBSYWlzZXMKICAgICAgICAtLS0tLS0tCiAgICAgICAgfmRpc2NvcmQuRm9yYmlkZGVuCiAgICAgICAgICAgIFlvdSBkbyBub3QgaGF2ZSB0aGUgcHJvcGVyIHBlcm1pc3Npb25zIHRvIGNyZWF0ZSB0aGlzIGNoYW5uZWwuCiAgICAgICAgfmRpc2NvcmQuSFRUUEV4Y2VwdGlvbgogICAgICAgICAgICBDcmVhdGluZyB0aGUgY2hhbm5lbCBmYWlsZWQuCgogICAgICAgIFJldHVybnMKICAgICAgICAtLS0tLS0tLQogICAgICAgIDpjbGFzczpgLmFiYy5HdWlsZENoYW5uZWxgCiAgICAgICAgICAgIFRoZSBjaGFubmVsIHRoYXQgd2FzIGNyZWF0ZWQuCiAgICAgICAgIiIiCiAgICAgICAgcmFpc2UgTm90SW1wbGVtZW50ZWRFcnJvcgoKICAgIGFzeW5jIGRlZiBtb3ZlKHNlbGYsICoqa3dhcmdzKToKICAgICAgICAiIiJ8Y29yb3wKCiAgICAgICAgQSByaWNoIGludGVyZmFjZSB0byBoZWxwIG1vdmUgYSBjaGFubmVsIHJlbGF0aXZlIHRvIG90aGVyIGNoYW5uZWxzLgoKICAgICAgICBJZiBleGFjdCBwb3NpdGlvbiBtb3ZlbWVudCBpcyByZXF1aXJlZCwgOm1ldGg6YGVkaXRgIHNob3VsZCBiZSB1c2VkIGluc3RlYWQuCgogICAgICAgIFlvdSBtdXN0IGhhdmUgdGhlIDphdHRyOmB+ZGlzY29yZC5QZXJtaXNzaW9ucy5tYW5hZ2VfY2hhbm5lbHNgIHBlcm1pc3Npb24gdG8KICAgICAgICBkbyB0aGlzLgoKICAgICAgICAuLiBub3RlOjoKCiAgICAgICAgICAgIFZvaWNlIGNoYW5uZWxzIHdpbGwgYWx3YXlzIGJlIHNvcnRlZCBiZWxvdyB0ZXh0IGNoYW5uZWxzLgogICAgICAgICAgICBUaGlzIGlzIGEgRGlzY29yZCBsaW1pdGF0aW9uLgoKICAgICAgICAuLiB2ZXJzaW9uYWRkZWQ6OiAxLjcKCiAgICAgICAgUGFyYW1ldGVycwogICAgICAgIC0tLS0tLS0tLS0tLQogICAgICAgIGJlZ2lubmluZzogOmNsYXNzOmBib29sYAogICAgICAgICAgICBXaGV0aGVyIHRvIG1vdmUgdGhlIGNoYW5uZWwgdG8gdGhlIGJlZ2lubmluZyBvZiB0aGUKICAgICAgICAgICAgY2hhbm5lbCBsaXN0IChvciBjYXRlZ29yeSBpZiBnaXZlbikuCiAgICAgICAgICAgIFRoaXMgaXMgbXV0dWFsbHkgZXhjbHVzaXZlIHdpdGggYGBlbmRgYCwgYGBiZWZvcmVgYCwgYW5kIGBgYWZ0ZXJgYC4KICAgICAgICBlbmQ6IDpjbGFzczpgYm9vbGAKICAgICAgICAgICAgV2hldGhlciB0byBtb3ZlIHRoZSBjaGFubmVsIHRvIHRoZSBlbmQgb2YgdGhlCiAgICAgICAgICAgIGNoYW5uZWwgbGlzdCAob3IgY2F0ZWdvcnkgaWYgZ2l2ZW4pLgogICAgICAgICAgICBUaGlzIGlzIG11dHVhbGx5IGV4Y2x1c2l2ZSB3aXRoIGBgYmVnaW5uaW5nYGAsIGBgYmVmb3JlYGAsIGFuZCBgYGFmdGVyYGAuCiAgICAgICAgYmVmb3JlOiA6Y2xhc3M6YH5kaXNjb3JkLmFiYy5Tbm93Zmxha2VgCiAgICAgICAgICAgIFRoZSBjaGFubmVsIHRoYXQgc2hvdWxkIGJlIGJlZm9yZSBvdXIgY3VycmVudCBjaGFubmVsLgogICAgICAgICAgICBUaGlzIGlzIG11dHVhbGx5IGV4Y2x1c2l2ZSB3aXRoIGBgYmVnaW5uaW5nYGAsIGBgZW5kYGAsIGFuZCBgYGFmdGVyYGAuCiAgICAgICAgYWZ0ZXI6IDpjbGFzczpgfmRpc2NvcmQuYWJjLlNub3dmbGFrZWAKICAgICAgICAgICAgVGhlIGNoYW5uZWwgdGhhdCBzaG91bGQgYmUgYWZ0ZXIgb3VyIGN1cnJlbnQgY2hhbm5lbC4KICAgICAgICAgICAgVGhpcyBpcyBtdXR1YWxseSBleGNsdXNpdmUgd2l0aCBgYGJlZ2lubmluZ2BgLCBgYGVuZGBgLCBhbmQgYGBiZWZvcmVgYC4KICAgICAgICBvZmZzZXQ6IDpjbGFzczpgaW50YAogICAgICAgICAgICBUaGUgbnVtYmVyIG9mIGNoYW5uZWxzIHRvIG9mZnNldCB0aGUgbW92ZSBieS4gRm9yIGV4YW1wbGUsCiAgICAgICAgICAgIGFuIG9mZnNldCBvZiBgYDJgYCB3aXRoIGBgYmVnaW5uaW5nPVRydWVgYCB3b3VsZCBtb3ZlCiAgICAgICAgICAgIGl0IDIgYWZ0ZXIgdGhlIGJlZ2lubmluZy4gQSBwb3NpdGl2ZSBudW1iZXIgbW92ZXMgaXQgYmVsb3cKICAgICAgICAgICAgd2hpbGUgYSBuZWdhdGl2ZSBudW1iZXIgbW92ZXMgaXQgYWJvdmUuIE5vdGUgdGhhdCB0aGlzCiAgICAgICAgICAgIG51bWJlciBpcyByZWxhdGl2ZSBhbmQgY29tcHV0ZWQgYWZ0ZXIgdGhlIGBgYmVnaW5uaW5nYGAsCiAgICAgICAgICAgIGBgZW5kYGAsIGBgYmVmb3JlYGAsIGFuZCBgYGFmdGVyYGAgcGFyYW1ldGVycy4KICAgICAgICBjYXRlZ29yeTogT3B0aW9uYWxbOmNsYXNzOmB+ZGlzY29yZC5hYmMuU25vd2ZsYWtlYF0KICAgICAgICAgICAgVGhlIGNhdGVnb3J5IHRvIG1vdmUgdGhpcyBjaGFubmVsIHVuZGVyLgogICAgICAgICAgICBJZiBgYE5vbmVgYCBpcyBnaXZlbiB0aGVuIGl0IG1vdmVzIGl0IG91dCBvZiB0aGUgY2F0ZWdvcnkuCiAgICAgICAgICAgIFRoaXMgcGFyYW1ldGVyIGlzIGlnbm9yZWQgaWYgbW92aW5nIGEgY2F0ZWdvcnkgY2hhbm5lbC4KICAgICAgICBzeW5jX3Blcm1pc3Npb25zOiA6Y2xhc3M6YGJvb2xgCiAgICAgICAgICAgIFdoZXRoZXIgdG8gc3luYyB0aGUgcGVybWlzc2lvbnMgd2l0aCB0aGUgY2F0ZWdvcnkgKGlmIGdpdmVuKS4KICAgICAgICByZWFzb246IDpjbGFzczpgc3RyYAogICAgICAgICAgICBUaGUgcmVhc29uIGZvciB0aGUgbW92ZS4KCiAgICAgICAgUmFpc2VzCiAgICAgICAgLS0tLS0tLQogICAgICAgIEludmFsaWRBcmd1bWVudAogICAgICAgICAgICBBbiBpbnZhbGlkIHBvc2l0aW9uIHdhcyBnaXZlbiBvciBhIGJhZCBtaXggb2YgYXJndW1lbnRzIHdlcmUgcGFzc2VkLgogICAgICAgIEZvcmJpZGRlbgogICAgICAgICAgICBZb3UgZG8gbm90IGhhdmUgcGVybWlzc2lvbnMgdG8gbW92ZSB0aGUgY2hhbm5lbC4KICAgICAgICBIVFRQRXhjZXB0aW9uCiAgICAgICAgICAgIE1vdmluZyB0aGUgY2hhbm5lbCBmYWlsZWQuCiAgICAgICAgIiIiCgogICAgICAgIGlmIG5vdCBrd2FyZ3M6CiAgICAgICAgICAgIHJldHVybgoKICAgICAgICBiZWdpbm5pbmcsIGVuZCA9IGt3YXJncy5nZXQoJ2JlZ2lubmluZycpLCBrd2FyZ3MuZ2V0KCdlbmQnKQogICAgICAgIGJlZm9yZSwgYWZ0ZXIgPSBrd2FyZ3MuZ2V0KCdiZWZvcmUnKSwga3dhcmdzLmdldCgnYWZ0ZXInKQogICAgICAgIG9mZnNldCA9IGt3YXJncy5nZXQoJ29mZnNldCcsIDApCiAgICAgICAgaWYgc3VtKGJvb2woYSkgZm9yIGEgaW4gKGJlZ2lubmluZywgZW5kLCBiZWZvcmUsIGFmdGVyKSkgPiAxOgogICAgICAgICAgICByYWlzZSBJbnZhbGlkQXJndW1lbnQoJ09ubHkgb25lIG9mIFtiZWZvcmUsIGFmdGVyLCBlbmQsIGJlZ2lubmluZ10gY2FuIGJlIHVzZWQuJykKCiAgICAgICAgYnVja2V0ID0gc2VsZi5fc29ydGluZ19idWNrZXQKICAgICAgICBwYXJlbnRfaWQgPSBrd2FyZ3MuZ2V0KCdjYXRlZ29yeScsIC4uLikKICAgICAgICBpZiBwYXJlbnRfaWQgbm90IGluICguLi4sIE5vbmUpOgogICAgICAgICAgICBwYXJlbnRfaWQgPSBwYXJlbnRfaWQuaWQKICAgICAgICAgICAgY2hhbm5lbHMgPSBbCiAgICAgICAgICAgICAgICBjaAogICAgICAgICAgICAgICAgZm9yIGNoIGluIHNlbGYuZ3VpbGQuY2hhbm5lbHMKICAgICAgICAgICAgICAgIGlmIGNoLl9zb3J0aW5nX2J1Y2tldCA9PSBidWNrZXQKICAgICAgICAgICAgICAgIGFuZCBjaC5jYXRlZ29yeV9pZCA9PSBwYXJlbnRfaWQKICAgICAgICAgICAgXQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGNoYW5uZWxzID0gWwogICAgICAgICAgICAgICAgY2gKICAgICAgICAgICAgICAgIGZvciBjaCBpbiBzZWxmLmd1aWxkLmNoYW5uZWxzCiAgICAgICAgICAgICAgICBpZiBjaC5fc29ydGluZ19idWNrZXQgPT0gYnVja2V0CiAgICAgICAgICAgICAgICBhbmQgY2guY2F0ZWdvcnlfaWQgPT0gc2VsZi5jYXRlZ29yeV9pZAogICAgICAgICAgICBdCgogICAgICAgIGNoYW5uZWxzLnNvcnQoa2V5PWxhbWJkYSBjOiAoYy5wb3NpdGlvbiwgYy5pZCkpCgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBUcnkgdG8gcmVtb3ZlIG91cnNlbHZlcyBmcm9tIHRoZSBjaGFubmVsIGxpc3QKICAgICAgICAgICAgY2hhbm5lbHMucmVtb3ZlKHNlbGYpCiAgICAgICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAgICAgICMgSWYgd2UncmUgbm90IHRoZXJlIHRoZW4gaXQncyBwcm9iYWJseSBkdWUgdG8gbm90IGJlaW5nIGluIHRoZSBjYXRlZ29yeQogICAgICAgICAgICBwYXNzCgogICAgICAgIGluZGV4ID0gTm9uZQogICAgICAgIGlmIGJlZ2lubmluZzoKICAgICAgICAgICAgaW5kZXggPSAwCiAgICAgICAgZWxpZiBlbmQ6CiAgICAgICAgICAgIGluZGV4ID0gbGVuKGNoYW5uZWxzKQogICAgICAgIGVsaWYgYmVmb3JlOgogICAgICAgICAgICBpbmRleCA9IG5leHQoKGkgZm9yIGksIGMgaW4gZW51bWVyYXRlKGNoYW5uZWxzKSBpZiBjLmlkID09IGJlZm9yZS5pZCksIE5vbmUpCiAgICAgICAgZWxpZiBhZnRlcjoKICAgICAgICAgICAgaW5kZXggPSBuZXh0KChpICsgMSBmb3IgaSwgYyBpbiBlbnVtZXJhdGUoY2hhbm5lbHMpIGlmIGMuaWQgPT0gYWZ0ZXIuaWQpLCBOb25lKQoKICAgICAgICBpZiBpbmRleCBpcyBOb25lOgogICAgICAgICAgICByYWlzZSBJbnZhbGlkQXJndW1lbnQoJ0NvdWxkIG5vdCByZXNvbHZlIGFwcHJvcHJpYXRlIG1vdmUgcG9zaXRpb24nKQoKICAgICAgICBjaGFubmVscy5pbnNlcnQobWF4KChpbmRleCArIG9mZnNldCksIDApLCBzZWxmKQogICAgICAgIHBheWxvYWQgPSBbXQogICAgICAgIGxvY2tfcGVybWlzc2lvbnMgPSBrd2FyZ3MuZ2V0KCdzeW5jX3Blcm1pc3Npb25zJywgRmFsc2UpCiAgICAgICAgcmVhc29uID0ga3dhcmdzLmdldCgncmVhc29uJykKICAgICAgICBmb3IgaW5kZXgsIGNoYW5uZWwgaW4gZW51bWVyYXRlKGNoYW5uZWxzKToKICAgICAgICAgICAgZCA9IHsgJ2lkJzogY2hhbm5lbC5pZCwgJ3Bvc2l0aW9uJzogaW5kZXggfQogICAgICAgICAgICBpZiBwYXJlbnRfaWQgaXMgbm90IC4uLiBhbmQgY2hhbm5lbC5pZCA9PSBzZWxmLmlkOgogICAgICAgICAgICAgICAgZC51cGRhdGUocGFyZW50X2lkPXBhcmVudF9pZCwgbG9ja19wZXJtaXNzaW9ucz1sb2NrX3Blcm1pc3Npb25zKQogICAgICAgICAgICBwYXlsb2FkLmFwcGVuZChkKQoKICAgICAgICBhd2FpdCBzZWxmLl9zdGF0ZS5odHRwLmJ1bGtfY2hhbm5lbF91cGRhdGUoc2VsZi5ndWlsZC5pZCwgcGF5bG9hZCwgcmVhc29uPXJlYXNvbikKCgogICAgYXN5bmMgZGVmIGNyZWF0ZV9pbnZpdGUoc2VsZiwgKiwgcmVhc29uPU5vbmUsICoqZmllbGRzKToKICAgICAgICAiIiJ8Y29yb3wKCiAgICAgICAgQ3JlYXRlcyBhbiBpbnN0YW50IGludml0ZSBmcm9tIGEgdGV4dCBvciB2b2ljZSBjaGFubmVsLgoKICAgICAgICBZb3UgbXVzdCBoYXZlIHRoZSA6YXR0cjpgflBlcm1pc3Npb25zLmNyZWF0ZV9pbnN0YW50X2ludml0ZWAgcGVybWlzc2lvbiB0bwogICAgICAgIGRvIHRoaXMuCgogICAgICAgIFBhcmFtZXRlcnMKICAgICAgICAtLS0tLS0tLS0tLS0KICAgICAgICBtYXhfYWdlOiA6Y2xhc3M6YGludGAKICAgICAgICAgICAgSG93IGxvbmcgdGhlIGludml0ZSBzaG91bGQgbGFzdCBpbiBzZWNvbmRzLiBJZiBpdCdzIDAgdGhlbiB0aGUgaW52aXRlCiAgICAgICAgICAgIGRvZXNuJ3QgZXhwaXJlLiBEZWZhdWx0cyB0byBgYDBgYC4KICAgICAgICBtYXhfdXNlczogOmNsYXNzOmBpbnRgCiAgICAgICAgICAgIEhvdyBtYW55IHVzZXMgdGhlIGludml0ZSBjb3VsZCBiZSB1c2VkIGZvci4gSWYgaXQncyAwIHRoZW4gdGhlcmUKICAgICAgICAgICAgYXJlIHVubGltaXRlZCB1c2VzLiBEZWZhdWx0cyB0byBgYDBgYC4KICAgICAgICB0ZW1wb3Jhcnk6IDpjbGFzczpgYm9vbGAKICAgICAgICAgICAgRGVub3RlcyB0aGF0IHRoZSBpbnZpdGUgZ3JhbnRzIHRlbXBvcmFyeSBtZW1iZXJzaGlwCiAgICAgICAgICAgIChpLmUuIHRoZXkgZ2V0IGtpY2tlZCBhZnRlciB0aGV5IGRpc2Nvbm5lY3QpLiBEZWZhdWx0cyB0byBgYEZhbHNlYGAuCiAgICAgICAgdW5pcXVlOiA6Y2xhc3M6YGJvb2xgCiAgICAgICAgICAgIEluZGljYXRlcyBpZiBhIHVuaXF1ZSBpbnZpdGUgVVJMIHNob3VsZCBiZSBjcmVhdGVkLiBEZWZhdWx0cyB0byBUcnVlLgogICAgICAgICAgICBJZiB0aGlzIGlzIHNldCB0byBgYEZhbHNlYGAgdGhlbiBpdCB3aWxsIHJldHVybiBhIHByZXZpb3VzbHkgY3JlYXRlZAogICAgICAgICAgICBpbnZpdGUuCiAgICAgICAgcmVhc29uOiBPcHRpb25hbFs6Y2xhc3M6YHN0cmBdCiAgICAgICAgICAgIFRoZSByZWFzb24gZm9yIGNyZWF0aW5nIHRoaXMgaW52aXRlLiBTaG93cyB1cCBvbiB0aGUgYXVkaXQgbG9nLgoKICAgICAgICBSYWlzZXMKICAgICAgICAtLS0tLS0tCiAgICAgICAgfmRpc2NvcmQuSFRUUEV4Y2VwdGlvbgogICAgICAgICAgICBJbnZpdGUgY3JlYXRpb24gZmFpbGVkLgoKICAgICAgICB+ZGlzY29yZC5Ob3RGb3VuZAogICAgICAgICAgICBUaGUgY2hhbm5lbCB0aGF0IHdhcyBwYXNzZWQgaXMgYSBjYXRlZ29yeSBvciBhbiBpbnZhbGlkIGNoYW5uZWwuCgogICAgICAgIFJldHVybnMKICAgICAgICAtLS0tLS0tLQogICAgICAgIDpjbGFzczpgfmRpc2NvcmQuSW52aXRlYAogICAgICAgICAgICBUaGUgaW52aXRlIHRoYXQgd2FzIGNyZWF0ZWQuCiAgICAgICAgIiIiCgogICAgICAgIGRhdGEgPSBhd2FpdCBzZWxmLl9zdGF0ZS5odHRwLmNyZWF0ZV9pbnZpdGUoc2VsZi5pZCwgcmVhc29uPXJlYXNvbiwgKipmaWVsZHMpCiAgICAgICAgcmV0dXJuIEludml0ZS5mcm9tX2luY29tcGxldGUoZGF0YT1kYXRhLCBzdGF0ZT1zZWxmLl9zdGF0ZSkKCiAgICBhc3luYyBkZWYgaW52aXRlcyhzZWxmKToKICAgICAgICAiIiJ8Y29yb3wKCiAgICAgICAgUmV0dXJucyBhIGxpc3Qgb2YgYWxsIGFjdGl2ZSBpbnN0YW50IGludml0ZXMgZnJvbSB0aGlzIGNoYW5uZWwuCgogICAgICAgIFlvdSBtdXN0IGhhdmUgOmF0dHI6YH5QZXJtaXNzaW9ucy5tYW5hZ2VfY2hhbm5lbHNgIHRvIGdldCB0aGlzIGluZm9ybWF0aW9uLgoKICAgICAgICBSYWlzZXMKICAgICAgICAtLS0tLS0tCiAgICAgICAgfmRpc2NvcmQuRm9yYmlkZGVuCiAgICAgICAgICAgIFlvdSBkbyBub3QgaGF2ZSBwcm9wZXIgcGVybWlzc2lvbnMgdG8gZ2V0IHRoZSBpbmZvcm1hdGlvbi4KICAgICAgICB+ZGlzY29yZC5IVFRQRXhjZXB0aW9uCiAgICAgICAgICAgIEFuIGVycm9yIG9jY3VycmVkIHdoaWxlIGZldGNoaW5nIHRoZSBpbmZvcm1hdGlvbi4KCiAgICAgICAgUmV0dXJucwogICAgICAgIC0tLS0tLS0KICAgICAgICBMaXN0WzpjbGFzczpgfmRpc2NvcmQuSW52aXRlYF0KICAgICAgICAgICAgVGhlIGxpc3Qgb2YgaW52aXRlcyB0aGF0IGFyZSBjdXJyZW50bHkgYWN0aXZlLgogICAgICAgICIiIgoKICAgICAgICBzdGF0ZSA9IHNlbGYuX3N0YXRlCiAgICAgICAgZGF0YSA9IGF3YWl0IHN0YXRlLmh0dHAuaW52aXRlc19mcm9tX2NoYW5uZWwoc2VsZi5pZCkKICAgICAgICByZXN1bHQgPSBbXQoKICAgICAgICBmb3IgaW52aXRlIGluIGRhdGE6CiAgICAgICAgICAgIGludml0ZVsnY2hhbm5lbCddID0gc2VsZgogICAgICAgICAgICBpbnZpdGVbJ2d1aWxkJ10gPSBzZWxmLmd1aWxkCiAgICAgICAgICAgIHJlc3VsdC5hcHBlbmQoSW52aXRlKHN0YXRlPXN0YXRlLCBkYXRhPWludml0ZSkpCgogICAgICAgIHJldHVybiByZXN1bHQKCmNsYXNzIE1lc3NhZ2VhYmxlKG1ldGFjbGFzcz1hYmMuQUJDTWV0YSk6CiAgICAiIiJBbiBBQkMgdGhhdCBkZXRhaWxzIHRoZSBjb21tb24gb3BlcmF0aW9ucyBvbiBhIG1vZGVsIHRoYXQgY2FuIHNlbmQgbWVzc2FnZXMuCgogICAgVGhlIGZvbGxvd2luZyBpbXBsZW1lbnQgdGhpcyBBQkM6CgogICAgLSA6Y2xhc3M6YH5kaXNjb3JkLlRleHRDaGFubmVsYAogICAgLSA6Y2xhc3M6YH5kaXNjb3JkLkRNQ2hhbm5lbGAKICAgIC0gOmNsYXNzOmB+ZGlzY29yZC5Hcm91cENoYW5uZWxgCiAgICAtIDpjbGFzczpgfmRpc2NvcmQuVXNlcmAKICAgIC0gOmNsYXNzOmB+ZGlzY29yZC5NZW1iZXJgCiAgICAtIDpjbGFzczpgfmRpc2NvcmQuZXh0LmNvbW1hbmRzLkNvbnRleHRgCiAgICAiIiIKCiAgICBfX3Nsb3RzX18gPSAoKQoKICAgIEBhYmMuYWJzdHJhY3RtZXRob2QKICAgIGFzeW5jIGRlZiBfZ2V0X2NoYW5uZWwoc2VsZik6CiAgICAgICAgcmFpc2UgTm90SW1wbGVtZW50ZWRFcnJvcgoKICAgIGFzeW5jIGRlZiBzZW5kKHNlbGYsIGNvbnRlbnQ9Tm9uZSwgKiwgdHRzPUZhbHNlLCBlbWJlZD1Ob25lLCBmaWxlPU5vbmUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbGVzPU5vbmUsIGRlbGV0ZV9hZnRlcj1Ob25lLCBub25jZT1Ob25lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbGxvd2VkX21lbnRpb25zPU5vbmUsIHJlZmVyZW5jZT1Ob25lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZW50aW9uX2F1dGhvcj1Ob25lKToKICAgICAgICAiIiJ8Y29yb3wKCiAgICAgICAgU2VuZHMgYSBtZXNzYWdlIHRvIHRoZSBkZXN0aW5hdGlvbiB3aXRoIHRoZSBjb250ZW50IGdpdmVuLgoKICAgICAgICBUaGUgY29udGVudCBtdXN0IGJlIGEgdHlwZSB0aGF0IGNhbiBjb252ZXJ0IHRvIGEgc3RyaW5nIHRocm91Z2ggYGBzdHIoY29udGVudClgYC4KICAgICAgICBJZiB0aGUgY29udGVudCBpcyBzZXQgdG8gYGBOb25lYGAgKHRoZSBkZWZhdWx0KSwgdGhlbiB0aGUgYGBlbWJlZGBgIHBhcmFtZXRlciBtdXN0CiAgICAgICAgYmUgcHJvdmlkZWQuCgogICAgICAgIFRvIHVwbG9hZCBhIHNpbmdsZSBmaWxlLCB0aGUgYGBmaWxlYGAgcGFyYW1ldGVyIHNob3VsZCBiZSB1c2VkIHdpdGggYQogICAgICAgIHNpbmdsZSA6Y2xhc3M6YH5kaXNjb3JkLkZpbGVgIG9iamVjdC4gVG8gdXBsb2FkIG11bHRpcGxlIGZpbGVzLCB0aGUgYGBmaWxlc2BgCiAgICAgICAgcGFyYW1ldGVyIHNob3VsZCBiZSB1c2VkIHdpdGggYSA6Y2xhc3M6YGxpc3RgIG9mIDpjbGFzczpgfmRpc2NvcmQuRmlsZWAgb2JqZWN0cy4KICAgICAgICAqKlNwZWNpZnlpbmcgYm90aCBwYXJhbWV0ZXJzIHdpbGwgbGVhZCB0byBhbiBleGNlcHRpb24qKi4KCiAgICAgICAgSWYgdGhlIGBgZW1iZWRgYCBwYXJhbWV0ZXIgaXMgcHJvdmlkZWQsIGl0IG11c3QgYmUgb2YgdHlwZSA6Y2xhc3M6YH5kaXNjb3JkLkVtYmVkYCBhbmQKICAgICAgICBpdCBtdXN0IGJlIGEgcmljaCBlbWJlZCB0eXBlLgoKICAgICAgICBQYXJhbWV0ZXJzCiAgICAgICAgLS0tLS0tLS0tLS0tCiAgICAgICAgY29udGVudDogOmNsYXNzOmBzdHJgCiAgICAgICAgICAgIFRoZSBjb250ZW50IG9mIHRoZSBtZXNzYWdlIHRvIHNlbmQuCiAgICAgICAgdHRzOiA6Y2xhc3M6YGJvb2xgCiAgICAgICAgICAgIEluZGljYXRlcyBpZiB0aGUgbWVzc2FnZSBzaG91bGQgYmUgc2VudCB1c2luZyB0ZXh0LXRvLXNwZWVjaC4KICAgICAgICBlbWJlZDogOmNsYXNzOmB+ZGlzY29yZC5FbWJlZGAKICAgICAgICAgICAgVGhlIHJpY2ggZW1iZWQgZm9yIHRoZSBjb250ZW50LgogICAgICAgIGZpbGU6IDpjbGFzczpgfmRpc2NvcmQuRmlsZWAKICAgICAgICAgICAgVGhlIGZpbGUgdG8gdXBsb2FkLgogICAgICAgIGZpbGVzOiBMaXN0WzpjbGFzczpgfmRpc2NvcmQuRmlsZWBdCiAgICAgICAgICAgIEEgbGlzdCBvZiBmaWxlcyB0byB1cGxvYWQuIE11c3QgYmUgYSBtYXhpbXVtIG9mIDEwLgogICAgICAgIG5vbmNlOiA6Y2xhc3M6YGludGAKICAgICAgICAgICAgVGhlIG5vbmNlIHRvIHVzZSBmb3Igc2VuZGluZyB0aGlzIG1lc3NhZ2UuIElmIHRoZSBtZXNzYWdlIHdhcyBzdWNjZXNzZnVsbHkgc2VudCwKICAgICAgICAgICAgdGhlbiB0aGUgbWVzc2FnZSB3aWxsIGhhdmUgYSBub25jZSB3aXRoIHRoaXMgdmFsdWUuCiAgICAgICAgZGVsZXRlX2FmdGVyOiA6Y2xhc3M6YGZsb2F0YAogICAgICAgICAgICBJZiBwcm92aWRlZCwgdGhlIG51bWJlciBvZiBzZWNvbmRzIHRvIHdhaXQgaW4gdGhlIGJhY2tncm91bmQKICAgICAgICAgICAgYmVmb3JlIGRlbGV0aW5nIHRoZSBtZXNzYWdlIHdlIGp1c3Qgc2VudC4gSWYgdGhlIGRlbGV0aW9uIGZhaWxzLAogICAgICAgICAgICB0aGVuIGl0IGlzIHNpbGVudGx5IGlnbm9yZWQuCiAgICAgICAgYWxsb3dlZF9tZW50aW9uczogOmNsYXNzOmB+ZGlzY29yZC5BbGxvd2VkTWVudGlvbnNgCiAgICAgICAgICAgIENvbnRyb2xzIHRoZSBtZW50aW9ucyBiZWluZyBwcm9jZXNzZWQgaW4gdGhpcyBtZXNzYWdlLiBJZiB0aGlzIGlzCiAgICAgICAgICAgIHBhc3NlZCwgdGhlbiB0aGUgb2JqZWN0IGlzIG1lcmdlZCB3aXRoIDphdHRyOmB+ZGlzY29yZC5DbGllbnQuYWxsb3dlZF9tZW50aW9uc2AuCiAgICAgICAgICAgIFRoZSBtZXJnaW5nIGJlaGF2aW91ciBvbmx5IG92ZXJyaWRlcyBhdHRyaWJ1dGVzIHRoYXQgaGF2ZSBiZWVuIGV4cGxpY2l0bHkgcGFzc2VkCiAgICAgICAgICAgIHRvIHRoZSBvYmplY3QsIG90aGVyd2lzZSBpdCB1c2VzIHRoZSBhdHRyaWJ1dGVzIHNldCBpbiA6YXR0cjpgfmRpc2NvcmQuQ2xpZW50LmFsbG93ZWRfbWVudGlvbnNgLgogICAgICAgICAgICBJZiBubyBvYmplY3QgaXMgcGFzc2VkIGF0IGFsbCB0aGVuIHRoZSBkZWZhdWx0cyBnaXZlbiBieSA6YXR0cjpgfmRpc2NvcmQuQ2xpZW50LmFsbG93ZWRfbWVudGlvbnNgCiAgICAgICAgICAgIGFyZSB1c2VkIGluc3RlYWQuCgogICAgICAgICAgICAuLiB2ZXJzaW9uYWRkZWQ6OiAxLjQKCiAgICAgICAgcmVmZXJlbmNlOiBVbmlvbls6Y2xhc3M6YH5kaXNjb3JkLk1lc3NhZ2VgLCA6Y2xhc3M6YH5kaXNjb3JkLk1lc3NhZ2VSZWZlcmVuY2VgXQogICAgICAgICAgICBBIHJlZmVyZW5jZSB0byB0aGUgOmNsYXNzOmB+ZGlzY29yZC5NZXNzYWdlYCB0byB3aGljaCB5b3UgYXJlIHJlcGx5aW5nLCB0aGlzIGNhbiBiZSBjcmVhdGVkIHVzaW5nCiAgICAgICAgICAgIDptZXRoOmB+ZGlzY29yZC5NZXNzYWdlLnRvX3JlZmVyZW5jZWAgb3IgcGFzc2VkIGRpcmVjdGx5IGFzIGEgOmNsYXNzOmB+ZGlzY29yZC5NZXNzYWdlYC4gWW91IGNhbiBjb250cm9sCiAgICAgICAgICAgIHdoZXRoZXIgdGhpcyBtZW50aW9ucyB0aGUgYXV0aG9yIG9mIHRoZSByZWZlcmVuY2VkIG1lc3NhZ2UgdXNpbmcgdGhlIDphdHRyOmB+ZGlzY29yZC5BbGxvd2VkTWVudGlvbnMucmVwbGllZF91c2VyYAogICAgICAgICAgICBhdHRyaWJ1dGUgb2YgYGBhbGxvd2VkX21lbnRpb25zYGAgb3IgYnkgc2V0dGluZyBgYG1lbnRpb25fYXV0aG9yYGAuCgogICAgICAgICAgICAuLiB2ZXJzaW9uYWRkZWQ6OiAxLjYKCiAgICAgICAgbWVudGlvbl9hdXRob3I6IE9wdGlvbmFsWzpjbGFzczpgYm9vbGBdCiAgICAgICAgICAgIElmIHNldCwgb3ZlcnJpZGVzIHRoZSA6YXR0cjpgfmRpc2NvcmQuQWxsb3dlZE1lbnRpb25zLnJlcGxpZWRfdXNlcmAgYXR0cmlidXRlIG9mIGBgYWxsb3dlZF9tZW50aW9uc2BgLgoKICAgICAgICAgICAgLi4gdmVyc2lvbmFkZGVkOjogMS42CgogICAgICAgIFJhaXNlcwogICAgICAgIC0tLS0tLS0tCiAgICAgICAgfmRpc2NvcmQuSFRUUEV4Y2VwdGlvbgogICAgICAgICAgICBTZW5kaW5nIHRoZSBtZXNzYWdlIGZhaWxlZC4KICAgICAgICB+ZGlzY29yZC5Gb3JiaWRkZW4KICAgICAgICAgICAgWW91IGRvIG5vdCBoYXZlIHRoZSBwcm9wZXIgcGVybWlzc2lvbnMgdG8gc2VuZCB0aGUgbWVzc2FnZS4KICAgICAgICB+ZGlzY29yZC5JbnZhbGlkQXJndW1lbnQKICAgICAgICAgICAgVGhlIGBgZmlsZXNgYCBsaXN0IGlzIG5vdCBvZiB0aGUgYXBwcm9wcmlhdGUgc2l6ZSwKICAgICAgICAgICAgeW91IHNwZWNpZmllZCBib3RoIGBgZmlsZWBgIGFuZCBgYGZpbGVzYGAsCiAgICAgICAgICAgIG9yIHRoZSBgYHJlZmVyZW5jZWBgIG9iamVjdCBpcyBub3QgYSA6Y2xhc3M6YH5kaXNjb3JkLk1lc3NhZ2VgCiAgICAgICAgICAgIG9yIDpjbGFzczpgfmRpc2NvcmQuTWVzc2FnZVJlZmVyZW5jZWAuCgogICAgICAgIFJldHVybnMKICAgICAgICAtLS0tLS0tLS0KICAgICAgICA6Y2xhc3M6YH5kaXNjb3JkLk1lc3NhZ2VgCiAgICAgICAgICAgIFRoZSBtZXNzYWdlIHRoYXQgd2FzIHNlbnQuCiAgICAgICAgIiIiCgogICAgICAgIGNoYW5uZWwgPSBhd2FpdCBzZWxmLl9nZXRfY2hhbm5lbCgpCiAgICAgICAgc3RhdGUgPSBzZWxmLl9zdGF0ZQogICAgICAgIGNvbnRlbnQgPSBzdHIoY29udGVudCkgaWYgY29udGVudCBpcyBub3QgTm9uZSBlbHNlIE5vbmUKICAgICAgICBpZiBlbWJlZCBpcyBub3QgTm9uZToKICAgICAgICAgICAgZW1iZWQgPSBlbWJlZC50b19kaWN0KCkKCiAgICAgICAgaWYgYWxsb3dlZF9tZW50aW9ucyBpcyBub3QgTm9uZToKICAgICAgICAgICAgaWYgc3RhdGUuYWxsb3dlZF9tZW50aW9ucyBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgIGFsbG93ZWRfbWVudGlvbnMgPSBzdGF0ZS5hbGxvd2VkX21lbnRpb25zLm1lcmdlKGFsbG93ZWRfbWVudGlvbnMpLnRvX2RpY3QoKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgYWxsb3dlZF9tZW50aW9ucyA9IGFsbG93ZWRfbWVudGlvbnMudG9fZGljdCgpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgYWxsb3dlZF9tZW50aW9ucyA9IHN0YXRlLmFsbG93ZWRfbWVudGlvbnMgYW5kIHN0YXRlLmFsbG93ZWRfbWVudGlvbnMudG9fZGljdCgpCgogICAgICAgIGlmIG1lbnRpb25fYXV0aG9yIGlzIG5vdCBOb25lOgogICAgICAgICAgICBhbGxvd2VkX21lbnRpb25zID0gYWxsb3dlZF9tZW50aW9ucyBvciBBbGxvd2VkTWVudGlvbnMoKS50b19kaWN0KCkKICAgICAgICAgICAgYWxsb3dlZF9tZW50aW9uc1sncmVwbGllZF91c2VyJ10gPSBib29sKG1lbnRpb25fYXV0aG9yKQoKICAgICAgICBpZiByZWZlcmVuY2UgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHJlZmVyZW5jZSA9IHJlZmVyZW5jZS50b19tZXNzYWdlX3JlZmVyZW5jZV9kaWN0KCkKICAgICAgICAgICAgZXhjZXB0IEF0dHJpYnV0ZUVycm9yOgogICAgICAgICAgICAgICAgcmFpc2UgSW52YWxpZEFyZ3VtZW50KCdyZWZlcmVuY2UgcGFyYW1ldGVyIG11c3QgYmUgTWVzc2FnZSBvciBNZXNzYWdlUmVmZXJlbmNlJykgZnJvbSBOb25lCgogICAgICAgIGlmIGZpbGUgaXMgbm90IE5vbmUgYW5kIGZpbGVzIGlzIG5vdCBOb25lOgogICAgICAgICAgICByYWlzZSBJbnZhbGlkQXJndW1lbnQoJ2Nhbm5vdCBwYXNzIGJvdGggZmlsZSBhbmQgZmlsZXMgcGFyYW1ldGVyIHRvIHNlbmQoKScpCgogICAgICAgIGlmIGZpbGUgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIGlmIG5vdCBpc2luc3RhbmNlKGZpbGUsIEZpbGUpOgogICAgICAgICAgICAgICAgcmFpc2UgSW52YWxpZEFyZ3VtZW50KCdmaWxlIHBhcmFtZXRlciBtdXN0IGJlIEZpbGUnKQoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgZGF0YSA9IGF3YWl0IHN0YXRlLmh0dHAuc2VuZF9maWxlcyhjaGFubmVsLmlkLCBmaWxlcz1bZmlsZV0sIGFsbG93ZWRfbWVudGlvbnM9YWxsb3dlZF9tZW50aW9ucywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGVudD1jb250ZW50LCB0dHM9dHRzLCBlbWJlZD1lbWJlZCwgbm9uY2U9bm9uY2UsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2VfcmVmZXJlbmNlPXJlZmVyZW5jZSkKICAgICAgICAgICAgZmluYWxseToKICAgICAgICAgICAgICAgIGZpbGUuY2xvc2UoKQoKICAgICAgICBlbGlmIGZpbGVzIGlzIG5vdCBOb25lOgogICAgICAgICAgICBpZiBsZW4oZmlsZXMpID4gMTA6CiAgICAgICAgICAgICAgICByYWlzZSBJbnZhbGlkQXJndW1lbnQoJ2ZpbGVzIHBhcmFtZXRlciBtdXN0IGJlIGEgbGlzdCBvZiB1cCB0byAxMCBlbGVtZW50cycpCiAgICAgICAgICAgIGVsaWYgbm90IGFsbChpc2luc3RhbmNlKGZpbGUsIEZpbGUpIGZvciBmaWxlIGluIGZpbGVzKToKICAgICAgICAgICAgICAgIHJhaXNlIEludmFsaWRBcmd1bWVudCgnZmlsZXMgcGFyYW1ldGVyIG11c3QgYmUgYSBsaXN0IG9mIEZpbGUnKQoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgZGF0YSA9IGF3YWl0IHN0YXRlLmh0dHAuc2VuZF9maWxlcyhjaGFubmVsLmlkLCBmaWxlcz1maWxlcywgY29udGVudD1jb250ZW50LCB0dHM9dHRzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbWJlZD1lbWJlZCwgbm9uY2U9bm9uY2UsIGFsbG93ZWRfbWVudGlvbnM9YWxsb3dlZF9tZW50aW9ucywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZV9yZWZlcmVuY2U9cmVmZXJlbmNlKQogICAgICAgICAgICBmaW5hbGx5OgogICAgICAgICAgICAgICAgZm9yIGYgaW4gZmlsZXM6CiAgICAgICAgICAgICAgICAgICAgZi5jbG9zZSgpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgZGF0YSA9IGF3YWl0IHN0YXRlLmh0dHAuc2VuZF9tZXNzYWdlKGNoYW5uZWwuaWQsIGNvbnRlbnQsIHR0cz10dHMsIGVtYmVkPWVtYmVkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9uY2U9bm9uY2UsIGFsbG93ZWRfbWVudGlvbnM9YWxsb3dlZF9tZW50aW9ucywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2VfcmVmZXJlbmNlPXJlZmVyZW5jZSkKCiAgICAgICAgcmV0ID0gc3RhdGUuY3JlYXRlX21lc3NhZ2UoY2hhbm5lbD1jaGFubmVsLCBkYXRhPWRhdGEpCiAgICAgICAgaWYgZGVsZXRlX2FmdGVyIGlzIG5vdCBOb25lOgogICAgICAgICAgICBhd2FpdCByZXQuZGVsZXRlKGRlbGF5PWRlbGV0ZV9hZnRlcikKICAgICAgICByZXR1cm4gcmV0CgogICAgYXN5bmMgZGVmIHRyaWdnZXJfdHlwaW5nKHNlbGYpOgogICAgICAgICIiInxjb3JvfAoKICAgICAgICBUcmlnZ2VycyBhICp0eXBpbmcqIGluZGljYXRvciB0byB0aGUgZGVzdGluYXRpb24uCgogICAgICAgICpUeXBpbmcqIGluZGljYXRvciB3aWxsIGdvIGF3YXkgYWZ0ZXIgMTAgc2Vjb25kcywgb3IgYWZ0ZXIgYSBtZXNzYWdlIGlzIHNlbnQuCiAgICAgICAgIiIiCgogICAgICAgIGNoYW5uZWwgPSBhd2FpdCBzZWxmLl9nZXRfY2hhbm5lbCgpCiAgICAgICAgYXdhaXQgc2VsZi5fc3RhdGUuaHR0cC5zZW5kX3R5cGluZyhjaGFubmVsLmlkKQoKICAgIGRlZiB0eXBpbmcoc2VsZik6CiAgICAgICAgIiIiUmV0dXJucyBhIGNvbnRleHQgbWFuYWdlciB0aGF0IGFsbG93cyB5b3UgdG8gdHlwZSBmb3IgYW4gaW5kZWZpbml0ZSBwZXJpb2Qgb2YgdGltZS4KCiAgICAgICAgVGhpcyBpcyB1c2VmdWwgZm9yIGRlbm90aW5nIGxvbmcgY29tcHV0YXRpb25zIGluIHlvdXIgYm90LgoKICAgICAgICAuLiBub3RlOjoKCiAgICAgICAgICAgIFRoaXMgaXMgYm90aCBhIHJlZ3VsYXIgY29udGV4dCBtYW5hZ2VyIGFuZCBhbiBhc3luYyBjb250ZXh0IG1hbmFnZXIuCiAgICAgICAgICAgIFRoaXMgbWVhbnMgdGhhdCBib3RoIGBgd2l0aGBgIGFuZCBgYGFzeW5jIHdpdGhgYCB3b3JrIHdpdGggdGhpcy4KCiAgICAgICAgRXhhbXBsZSBVc2FnZTogOjoKCiAgICAgICAgICAgIGFzeW5jIHdpdGggY2hhbm5lbC50eXBpbmcoKToKICAgICAgICAgICAgICAgICMgZG8gZXhwZW5zaXZlIHN0dWZmIGhlcmUKICAgICAgICAgICAgICAgIGF3YWl0IGNoYW5uZWwuc2VuZCgnZG9uZSEnKQoKICAgICAgICAiIiIKICAgICAgICByZXR1cm4gVHlwaW5nKHNlbGYpCgogICAgYXN5bmMgZGVmIGZldGNoX21lc3NhZ2Uoc2VsZiwgaWQpOgogICAgICAgICIiInxjb3JvfAoKICAgICAgICBSZXRyaWV2ZXMgYSBzaW5nbGUgOmNsYXNzOmB+ZGlzY29yZC5NZXNzYWdlYCBmcm9tIHRoZSBkZXN0aW5hdGlvbi4KCiAgICAgICAgVGhpcyBjYW4gb25seSBiZSB1c2VkIGJ5IGJvdCBhY2NvdW50cy4KCiAgICAgICAgUGFyYW1ldGVycwogICAgICAgIC0tLS0tLS0tLS0tLQogICAgICAgIGlkOiA6Y2xhc3M6YGludGAKICAgICAgICAgICAgVGhlIG1lc3NhZ2UgSUQgdG8gbG9vayBmb3IuCgogICAgICAgIFJhaXNlcwogICAgICAgIC0tLS0tLS0tCiAgICAgICAgfmRpc2NvcmQuTm90Rm91bmQKICAgICAgICAgICAgVGhlIHNwZWNpZmllZCBtZXNzYWdlIHdhcyBub3QgZm91bmQuCiAgICAgICAgfmRpc2NvcmQuRm9yYmlkZGVuCiAgICAgICAgICAgIFlvdSBkbyBub3QgaGF2ZSB0aGUgcGVybWlzc2lvbnMgcmVxdWlyZWQgdG8gZ2V0IGEgbWVzc2FnZS4KICAgICAgICB+ZGlzY29yZC5IVFRQRXhjZXB0aW9uCiAgICAgICAgICAgIFJldHJpZXZpbmcgdGhlIG1lc3NhZ2UgZmFpbGVkLgoKICAgICAgICBSZXR1cm5zCiAgICAgICAgLS0tLS0tLS0KICAgICAgICA6Y2xhc3M6YH5kaXNjb3JkLk1lc3NhZ2VgCiAgICAgICAgICAgIFRoZSBtZXNzYWdlIGFza2VkIGZvci4KICAgICAgICAiIiIKCiAgICAgICAgY2hhbm5lbCA9IGF3YWl0IHNlbGYuX2dldF9jaGFubmVsKCkKICAgICAgICBkYXRhID0gYXdhaXQgc2VsZi5fc3RhdGUuaHR0cC5nZXRfbWVzc2FnZShjaGFubmVsLmlkLCBpZCkKICAgICAgICByZXR1cm4gc2VsZi5fc3RhdGUuY3JlYXRlX21lc3NhZ2UoY2hhbm5lbD1jaGFubmVsLCBkYXRhPWRhdGEpCgogICAgYXN5bmMgZGVmIHBpbnMoc2VsZik6CiAgICAgICAgIiIifGNvcm98CgogICAgICAgIFJldHJpZXZlcyBhbGwgbWVzc2FnZXMgdGhhdCBhcmUgY3VycmVudGx5IHBpbm5lZCBpbiB0aGUgY2hhbm5lbC4KCiAgICAgICAgLi4gbm90ZTo6CgogICAgICAgICAgICBEdWUgdG8gYSBsaW1pdGF0aW9uIHdpdGggdGhlIERpc2NvcmQgQVBJLCB0aGUgOmNsYXNzOmAuTWVzc2FnZWAKICAgICAgICAgICAgb2JqZWN0cyByZXR1cm5lZCBieSB0aGlzIG1ldGhvZCBkbyBub3QgY29udGFpbiBjb21wbGV0ZQogICAgICAgICAgICA6YXR0cjpgLk1lc3NhZ2UucmVhY3Rpb25zYCBkYXRhLgoKICAgICAgICBSYWlzZXMKICAgICAgICAtLS0tLS0tCiAgICAgICAgfmRpc2NvcmQuSFRUUEV4Y2VwdGlvbgogICAgICAgICAgICBSZXRyaWV2aW5nIHRoZSBwaW5uZWQgbWVzc2FnZXMgZmFpbGVkLgoKICAgICAgICBSZXR1cm5zCiAgICAgICAgLS0tLS0tLS0KICAgICAgICBMaXN0WzpjbGFzczpgfmRpc2NvcmQuTWVzc2FnZWBdCiAgICAgICAgICAgIFRoZSBtZXNzYWdlcyB0aGF0IGFyZSBjdXJyZW50bHkgcGlubmVkLgogICAgICAgICIiIgoKICAgICAgICBjaGFubmVsID0gYXdhaXQgc2VsZi5fZ2V0X2NoYW5uZWwoKQogICAgICAgIHN0YXRlID0gc2VsZi5fc3RhdGUKICAgICAgICBkYXRhID0gYXdhaXQgc3RhdGUuaHR0cC5waW5zX2Zyb20oY2hhbm5lbC5pZCkKICAgICAgICByZXR1cm4gW3N0YXRlLmNyZWF0ZV9tZXNzYWdlKGNoYW5uZWw9Y2hhbm5lbCwgZGF0YT1tKSBmb3IgbSBpbiBkYXRhXQoKICAgIGRlZiBoaXN0b3J5KHNlbGYsICosIGxpbWl0PTEwMCwgYmVmb3JlPU5vbmUsIGFmdGVyPU5vbmUsIGFyb3VuZD1Ob25lLCBvbGRlc3RfZmlyc3Q9Tm9uZSk6CiAgICAgICAgIiIiUmV0dXJucyBhbiA6Y2xhc3M6YH5kaXNjb3JkLkFzeW5jSXRlcmF0b3JgIHRoYXQgZW5hYmxlcyByZWNlaXZpbmcgdGhlIGRlc3RpbmF0aW9uJ3MgbWVzc2FnZSBoaXN0b3J5LgoKICAgICAgICBZb3UgbXVzdCBoYXZlIDphdHRyOmB+UGVybWlzc2lvbnMucmVhZF9tZXNzYWdlX2hpc3RvcnlgIHBlcm1pc3Npb25zIHRvIHVzZSB0aGlzLgoKICAgICAgICBFeGFtcGxlcwogICAgICAgIC0tLS0tLS0tLQoKICAgICAgICBVc2FnZSA6OgoKICAgICAgICAgICAgY291bnRlciA9IDAKICAgICAgICAgICAgYXN5bmMgZm9yIG1lc3NhZ2UgaW4gY2hhbm5lbC5oaXN0b3J5KGxpbWl0PTIwMCk6CiAgICAgICAgICAgICAgICBpZiBtZXNzYWdlLmF1dGhvciA9PSBjbGllbnQudXNlcjoKICAgICAgICAgICAgICAgICAgICBjb3VudGVyICs9IDEKCiAgICAgICAgRmxhdHRlbmluZyBpbnRvIGEgbGlzdDogOjoKCiAgICAgICAgICAgIG1lc3NhZ2VzID0gYXdhaXQgY2hhbm5lbC5oaXN0b3J5KGxpbWl0PTEyMykuZmxhdHRlbigpCiAgICAgICAgICAgICMgbWVzc2FnZXMgaXMgbm93IGEgbGlzdCBvZiBNZXNzYWdlLi4uCgogICAgICAgIEFsbCBwYXJhbWV0ZXJzIGFyZSBvcHRpb25hbC4KCiAgICAgICAgUGFyYW1ldGVycwogICAgICAgIC0tLS0tLS0tLS0tCiAgICAgICAgbGltaXQ6IE9wdGlvbmFsWzpjbGFzczpgaW50YF0KICAgICAgICAgICAgVGhlIG51bWJlciBvZiBtZXNzYWdlcyB0byByZXRyaWV2ZS4KICAgICAgICAgICAgSWYgYGBOb25lYGAsIHJldHJpZXZlcyBldmVyeSBtZXNzYWdlIGluIHRoZSBjaGFubmVsLiBOb3RlLCBob3dldmVyLAogICAgICAgICAgICB0aGF0IHRoaXMgd291bGQgbWFrZSBpdCBhIHNsb3cgb3BlcmF0aW9uLgogICAgICAgIGJlZm9yZTogT3B0aW9uYWxbVW5pb25bOmNsYXNzOmB+ZGlzY29yZC5hYmMuU25vd2ZsYWtlYCwgOmNsYXNzOmBkYXRldGltZS5kYXRldGltZWBdXQogICAgICAgICAgICBSZXRyaWV2ZSBtZXNzYWdlcyBiZWZvcmUgdGhpcyBkYXRlIG9yIG1lc3NhZ2UuCiAgICAgICAgICAgIElmIGEgZGF0ZSBpcyBwcm92aWRlZCBpdCBtdXN0IGJlIGEgdGltZXpvbmUtbmFpdmUgZGF0ZXRpbWUgcmVwcmVzZW50aW5nIFVUQyB0aW1lLgogICAgICAgIGFmdGVyOiBPcHRpb25hbFtVbmlvbls6Y2xhc3M6YH5kaXNjb3JkLmFiYy5Tbm93Zmxha2VgLCA6Y2xhc3M6YGRhdGV0aW1lLmRhdGV0aW1lYF1dCiAgICAgICAgICAgIFJldHJpZXZlIG1lc3NhZ2VzIGFmdGVyIHRoaXMgZGF0ZSBvciBtZXNzYWdlLgogICAgICAgICAgICBJZiBhIGRhdGUgaXMgcHJvdmlkZWQgaXQgbXVzdCBiZSBhIHRpbWV6b25lLW5haXZlIGRhdGV0aW1lIHJlcHJlc2VudGluZyBVVEMgdGltZS4KICAgICAgICBhcm91bmQ6IE9wdGlvbmFsW1VuaW9uWzpjbGFzczpgfmRpc2NvcmQuYWJjLlNub3dmbGFrZWAsIDpjbGFzczpgZGF0ZXRpbWUuZGF0ZXRpbWVgXV0KICAgICAgICAgICAgUmV0cmlldmUgbWVzc2FnZXMgYXJvdW5kIHRoaXMgZGF0ZSBvciBtZXNzYWdlLgogICAgICAgICAgICBJZiBhIGRhdGUgaXMgcHJvdmlkZWQgaXQgbXVzdCBiZSBhIHRpbWV6b25lLW5haXZlIGRhdGV0aW1lIHJlcHJlc2VudGluZyBVVEMgdGltZS4KICAgICAgICAgICAgV2hlbiB1c2luZyB0aGlzIGFyZ3VtZW50LCB0aGUgbWF4aW11bSBsaW1pdCBpcyAxMDEuIE5vdGUgdGhhdCBpZiB0aGUgbGltaXQgaXMgYW4KICAgICAgICAgICAgZXZlbiBudW1iZXIgdGhlbiB0aGlzIHdpbGwgcmV0dXJuIGF0IG1vc3QgbGltaXQgKyAxIG1lc3NhZ2VzLgogICAgICAgIG9sZGVzdF9maXJzdDogT3B0aW9uYWxbOmNsYXNzOmBib29sYF0KICAgICAgICAgICAgSWYgc2V0IHRvIGBgVHJ1ZWBgLCByZXR1cm4gbWVzc2FnZXMgaW4gb2xkZXN0LT5uZXdlc3Qgb3JkZXIuIERlZmF1bHRzIHRvIGBgVHJ1ZWBgIGlmCiAgICAgICAgICAgIGBgYWZ0ZXJgYCBpcyBzcGVjaWZpZWQsIG90aGVyd2lzZSBgYEZhbHNlYGAuCgogICAgICAgIFJhaXNlcwogICAgICAgIC0tLS0tLQogICAgICAgIH5kaXNjb3JkLkZvcmJpZGRlbgogICAgICAgICAgICBZb3UgZG8gbm90IGhhdmUgcGVybWlzc2lvbnMgdG8gZ2V0IGNoYW5uZWwgbWVzc2FnZSBoaXN0b3J5LgogICAgICAgIH5kaXNjb3JkLkhUVFBFeGNlcHRpb24KICAgICAgICAgICAgVGhlIHJlcXVlc3QgdG8gZ2V0IG1lc3NhZ2UgaGlzdG9yeSBmYWlsZWQuCgogICAgICAgIFlpZWxkcwogICAgICAgIC0tLS0tLS0KICAgICAgICA6Y2xhc3M6YH5kaXNjb3JkLk1lc3NhZ2VgCiAgICAgICAgICAgIFRoZSBtZXNzYWdlIHdpdGggdGhlIG1lc3NhZ2UgZGF0YSBwYXJzZWQuCiAgICAgICAgIiIiCiAgICAgICAgcmV0dXJuIEhpc3RvcnlJdGVyYXRvcihzZWxmLCBsaW1pdD1saW1pdCwgYmVmb3JlPWJlZm9yZSwgYWZ0ZXI9YWZ0ZXIsIGFyb3VuZD1hcm91bmQsIG9sZGVzdF9maXJzdD1vbGRlc3RfZmlyc3QpCgpjbGFzcyBDb25uZWN0YWJsZShtZXRhY2xhc3M9YWJjLkFCQ01ldGEpOgogICAgIiIiQW4gQUJDIHRoYXQgZGV0YWlscyB0aGUgY29tbW9uIG9wZXJhdGlvbnMgb24gYSBjaGFubmVsIHRoYXQgY2FuCiAgICBjb25uZWN0IHRvIGEgdm9pY2Ugc2VydmVyLgoKICAgIFRoZSBmb2xsb3dpbmcgaW1wbGVtZW50IHRoaXMgQUJDOgoKICAgIC0gOmNsYXNzOmB+ZGlzY29yZC5Wb2ljZUNoYW5uZWxgCiAgICAiIiIKICAgIF9fc2xvdHNfXyA9ICgpCgogICAgQGFiYy5hYnN0cmFjdG1ldGhvZAogICAgZGVmIF9nZXRfdm9pY2VfY2xpZW50X2tleShzZWxmKToKICAgICAgICByYWlzZSBOb3RJbXBsZW1lbnRlZEVycm9yCgogICAgQGFiYy5hYnN0cmFjdG1ldGhvZAogICAgZGVmIF9nZXRfdm9pY2Vfc3RhdGVfcGFpcihzZWxmKToKICAgICAgICByYWlzZSBOb3RJbXBsZW1lbnRlZEVycm9yCgogICAgYXN5bmMgZGVmIGNvbm5lY3Qoc2VsZiwgKiwgdGltZW91dD02MC4wLCByZWNvbm5lY3Q9VHJ1ZSwgY2xzPVZvaWNlQ2xpZW50KToKICAgICAgICAiIiJ8Y29yb3wKCiAgICAgICAgQ29ubmVjdHMgdG8gdm9pY2UgYW5kIGNyZWF0ZXMgYSA6Y2xhc3M6YFZvaWNlQ2xpZW50YCB0byBlc3RhYmxpc2gKICAgICAgICB5b3VyIGNvbm5lY3Rpb24gdG8gdGhlIHZvaWNlIHNlcnZlci4KCiAgICAgICAgUGFyYW1ldGVycwogICAgICAgIC0tLS0tLS0tLS0tCiAgICAgICAgdGltZW91dDogOmNsYXNzOmBmbG9hdGAKICAgICAgICAgICAgVGhlIHRpbWVvdXQgaW4gc2Vjb25kcyB0byB3YWl0IGZvciB0aGUgdm9pY2UgZW5kcG9pbnQuCiAgICAgICAgcmVjb25uZWN0OiA6Y2xhc3M6YGJvb2xgCiAgICAgICAgICAgIFdoZXRoZXIgdGhlIGJvdCBzaG91bGQgYXV0b21hdGljYWxseSBhdHRlbXB0CiAgICAgICAgICAgIGEgcmVjb25uZWN0IGlmIGEgcGFydCBvZiB0aGUgaGFuZHNoYWtlIGZhaWxzCiAgICAgICAgICAgIG9yIHRoZSBnYXRld2F5IGdvZXMgZG93bi4KICAgICAgICBjbHM6IFR5cGVbOmNsYXNzOmBWb2ljZVByb3RvY29sYF0KICAgICAgICAgICAgQSB0eXBlIHRoYXQgc3ViY2xhc3NlcyA6Y2xhc3M6YH5kaXNjb3JkLlZvaWNlUHJvdG9jb2xgIHRvIGNvbm5lY3Qgd2l0aC4KICAgICAgICAgICAgRGVmYXVsdHMgdG8gOmNsYXNzOmB+ZGlzY29yZC5Wb2ljZUNsaWVudGAuCgogICAgICAgIFJhaXNlcwogICAgICAgIC0tLS0tLS0KICAgICAgICBhc3luY2lvLlRpbWVvdXRFcnJvcgogICAgICAgICAgICBDb3VsZCBub3QgY29ubmVjdCB0byB0aGUgdm9pY2UgY2hhbm5lbCBpbiB0aW1lLgogICAgICAgIH5kaXNjb3JkLkNsaWVudEV4Y2VwdGlvbgogICAgICAgICAgICBZb3UgYXJlIGFscmVhZHkgY29ubmVjdGVkIHRvIGEgdm9pY2UgY2hhbm5lbC4KICAgICAgICB+ZGlzY29yZC5vcHVzLk9wdXNOb3RMb2FkZWQKICAgICAgICAgICAgVGhlIG9wdXMgbGlicmFyeSBoYXMgbm90IGJlZW4gbG9hZGVkLgoKICAgICAgICBSZXR1cm5zCiAgICAgICAgLS0tLS0tLS0KICAgICAgICA6Y2xhc3M6YH5kaXNjb3JkLlZvaWNlUHJvdG9jb2xgCiAgICAgICAgICAgIEEgdm9pY2UgY2xpZW50IHRoYXQgaXMgZnVsbHkgY29ubmVjdGVkIHRvIHRoZSB2b2ljZSBzZXJ2ZXIuCiAgICAgICAgIiIiCgogICAgICAgIGtleV9pZCwgXyA9IHNlbGYuX2dldF92b2ljZV9jbGllbnRfa2V5KCkKICAgICAgICBzdGF0ZSA9IHNlbGYuX3N0YXRlCgogICAgICAgIGlmIHN0YXRlLl9nZXRfdm9pY2VfY2xpZW50KGtleV9pZCk6CiAgICAgICAgICAgIHJhaXNlIENsaWVudEV4Y2VwdGlvbignQWxyZWFkeSBjb25uZWN0ZWQgdG8gYSB2b2ljZSBjaGFubmVsLicpCgogICAgICAgIGNsaWVudCA9IHN0YXRlLl9nZXRfY2xpZW50KCkKICAgICAgICB2b2ljZSA9IGNscyhjbGllbnQsIHNlbGYpCgogICAgICAgIGlmIG5vdCBpc2luc3RhbmNlKHZvaWNlLCBWb2ljZVByb3RvY29sKToKICAgICAgICAgICAgcmFpc2UgVHlwZUVycm9yKCdUeXBlIG11c3QgbWVldCBWb2ljZVByb3RvY29sIGFic3RyYWN0IGJhc2UgY2xhc3MuJykKCiAgICAgICAgc3RhdGUuX2FkZF92b2ljZV9jbGllbnQoa2V5X2lkLCB2b2ljZSkKCiAgICAgICAgdHJ5OgogICAgICAgICAgICBhd2FpdCB2b2ljZS5jb25uZWN0KHRpbWVvdXQ9dGltZW91dCwgcmVjb25uZWN0PXJlY29ubmVjdCkKICAgICAgICBleGNlcHQgYXN5bmNpby5UaW1lb3V0RXJyb3I6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGF3YWl0IHZvaWNlLmRpc2Nvbm5lY3QoZm9yY2U9VHJ1ZSkKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgICMgd2UgZG9uJ3QgY2FyZSBpZiBkaXNjb25uZWN0IGZhaWxlZCBiZWNhdXNlIGNvbm5lY3Rpb24gZmFpbGVkCiAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgIHJhaXNlICMgcmUtcmFpc2UKCiAgICAgICAgcmV0dXJuIHZvaWNlCg==
