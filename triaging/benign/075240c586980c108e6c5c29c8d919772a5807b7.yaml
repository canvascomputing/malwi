statistics:
  total_files: 1
  skipped_files: 0.0
  processed_objects: 1
  malicious_objects: 0
details:
- path: .repo_cache/malicious_repos/pypi_malregistry/urlib3/1.21.1/urlib3-1.21.1/urlib3-1.21.1/test/with_dummyserver/test_socketlevel.py
  contents:
  - name: TestSocketClosing.test_https_connection_read_timeout
    score: 0.0
    code: |-
      def test_https_connection_read_timeout(self):
              """ Handshake timeouts should fail with a Timeout"""
              timed_out = Event()

              def socket_handler(listener):
                  sock = listener.accept()[0]
                  while not sock.recv(65536):
                      pass

                  timed_out.wait()
                  sock.close()

              self._start_server(socket_handler)
              pool = HTTPSConnectionPool(self.host, self.port, timeout=0.001, retries=False)
              self.addCleanup(pool.close)
              try:
                  self.assertRaises(ReadTimeoutError, pool.request, 'GET', '/')
              finally:
                  timed_out.set()
    tokens: make_cell timed_out resume load_global Event call store_deref timed_out load_closure timed_out build_tuple load_const OBJECT make_function closure store_fast socket_handler load_fast self load_attr _start_server load_fast socket_handler call pop_top load_global STRING_LEN_S_ENT_HIGH load_fast self load_attr host load_fast self load_attr port load_const FLOAT load_const INTEGER kw_names retries timeout call store_fast pool load_fast self load_attr addCleanup load_fast pool load_attr close call pop_top nop load_fast self load_attr assertRaises load_global STRING_BASE64_LEN_S_ENT_HIGH load_fast pool load_attr request load_const GET load_const / call pop_top load_deref timed_out load_attr set call pop_top return_const None push_exc_info load_deref timed_out load_attr set call pop_top reraise copy pop_except reraise
    hash: 3c6482cd306ebc4eabbb3dbee0df5fa68cfc65dc2f34761fc844dcfdbc27ff94
sources:
  ? .repo_cache/malicious_repos/pypi_malregistry/urlib3/1.21.1/urlib3-1.21.1/urlib3-1.21.1/test/with_dummyserver/test_socketlevel.py
  : IyBUT0RPOiBCcmVhayB0aGlzIG1vZHVsZSB1cCBpbnRvIHBpZWNlcy4gTWF5YmUgZ3JvdXAgYnkgZnVuY3Rpb25hbGl0eSB0ZXN0ZWQKIyByYXRoZXIgdGhhbiB0aGUgc29ja2V0IGxldmVsLW5lc3Mgb2YgaXQuCgpmcm9tIHVybGxpYjMgaW1wb3J0IEhUVFBDb25uZWN0aW9uUG9vbCwgSFRUUFNDb25uZWN0aW9uUG9vbApmcm9tIHVybGxpYjMucG9vbG1hbmFnZXIgaW1wb3J0IHByb3h5X2Zyb21fdXJsCmZyb20gdXJsbGliMy5leGNlcHRpb25zIGltcG9ydCAoCiAgICAgICAgTWF4UmV0cnlFcnJvciwKICAgICAgICBQcm94eUVycm9yLAogICAgICAgIFJlYWRUaW1lb3V0RXJyb3IsCiAgICAgICAgU1NMRXJyb3IsCiAgICAgICAgUHJvdG9jb2xFcnJvciwKKQpmcm9tIHVybGxpYjMucmVzcG9uc2UgaW1wb3J0IGh0dHBsaWIKZnJvbSB1cmxsaWIzLnV0aWwuc3NsXyBpbXBvcnQgSEFTX1NOSQpmcm9tIHVybGxpYjMudXRpbC50aW1lb3V0IGltcG9ydCBUaW1lb3V0CmZyb20gdXJsbGliMy51dGlsLnJldHJ5IGltcG9ydCBSZXRyeQpmcm9tIHVybGxpYjMuX2NvbGxlY3Rpb25zIGltcG9ydCBIVFRQSGVhZGVyRGljdCwgT3JkZXJlZERpY3QKCmZyb20gZHVtbXlzZXJ2ZXIudGVzdGNhc2UgaW1wb3J0IFNvY2tldER1bW15U2VydmVyVGVzdENhc2UsIGNvbnN1bWVfc29ja2V0CmZyb20gZHVtbXlzZXJ2ZXIuc2VydmVyIGltcG9ydCAoCiAgICBERUZBVUxUX0NFUlRTLCBERUZBVUxUX0NBLCBDT01CSU5FRF9DRVJUX0FORF9LRVksIGdldF91bnJlYWNoYWJsZV9hZGRyZXNzKQoKZnJvbSAuLiBpbXBvcnQgb25seVB5MywgTG9nUmVjb3JkZXIKCmZyb20gbm9zZS5wbHVnaW5zLnNraXAgaW1wb3J0IFNraXBUZXN0CnRyeToKICAgIGZyb20gbWltZXRvb2xzIGltcG9ydCBNZXNzYWdlIGFzIE1pbWVUb29sTWVzc2FnZQpleGNlcHQgSW1wb3J0RXJyb3I6CiAgICBjbGFzcyBNaW1lVG9vbE1lc3NhZ2Uob2JqZWN0KToKICAgICAgICBwYXNzCmZyb20gdGhyZWFkaW5nIGltcG9ydCBFdmVudAppbXBvcnQgc2VsZWN0CmltcG9ydCBzb2NrZXQKaW1wb3J0IHNzbAoKCmNsYXNzIFRlc3RDb29raWVzKFNvY2tldER1bW15U2VydmVyVGVzdENhc2UpOgoKICAgIGRlZiB0ZXN0X211bHRpX3NldGNvb2tpZShzZWxmKToKICAgICAgICBkZWYgbXVsdGljb29raWVfcmVzcG9uc2VfaGFuZGxlcihsaXN0ZW5lcik6CiAgICAgICAgICAgIHNvY2sgPSBsaXN0ZW5lci5hY2NlcHQoKVswXQoKICAgICAgICAgICAgYnVmID0gYicnCiAgICAgICAgICAgIHdoaWxlIG5vdCBidWYuZW5kc3dpdGgoYidcclxuXHJcbicpOgogICAgICAgICAgICAgICAgYnVmICs9IHNvY2sucmVjdig2NTUzNikKCiAgICAgICAgICAgIHNvY2suc2VuZChiJ0hUVFAvMS4xIDIwMCBPS1xyXG4nCiAgICAgICAgICAgICAgICAgICAgICBiJ1NldC1Db29raWU6IGZvbz0xXHJcbicKICAgICAgICAgICAgICAgICAgICAgIGInU2V0LUNvb2tpZTogYmFyPTFcclxuJwogICAgICAgICAgICAgICAgICAgICAgYidcclxuJykKICAgICAgICAgICAgc29jay5jbG9zZSgpCgogICAgICAgIHNlbGYuX3N0YXJ0X3NlcnZlcihtdWx0aWNvb2tpZV9yZXNwb25zZV9oYW5kbGVyKQogICAgICAgIHBvb2wgPSBIVFRQQ29ubmVjdGlvblBvb2woc2VsZi5ob3N0LCBzZWxmLnBvcnQpCiAgICAgICAgc2VsZi5hZGRDbGVhbnVwKHBvb2wuY2xvc2UpCiAgICAgICAgciA9IHBvb2wucmVxdWVzdCgnR0VUJywgJy8nLCByZXRyaWVzPTApCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChyLmhlYWRlcnMsIHsnc2V0LWNvb2tpZSc6ICdmb289MSwgYmFyPTEnfSkKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKHIuaGVhZGVycy5nZXRsaXN0KCdzZXQtY29va2llJyksIFsnZm9vPTEnLCAnYmFyPTEnXSkKCgpjbGFzcyBUZXN0U05JKFNvY2tldER1bW15U2VydmVyVGVzdENhc2UpOgoKICAgIGRlZiB0ZXN0X2hvc3RuYW1lX2luX2ZpcnN0X3JlcXVlc3RfcGFja2V0KHNlbGYpOgogICAgICAgIGlmIG5vdCBIQVNfU05JOgogICAgICAgICAgICByYWlzZSBTa2lwVGVzdCgnU05JLXN1cHBvcnQgbm90IGF2YWlsYWJsZScpCgogICAgICAgIGRvbmVfcmVjZWl2aW5nID0gRXZlbnQoKQogICAgICAgIHNlbGYuYnVmID0gYicnCgogICAgICAgIGRlZiBzb2NrZXRfaGFuZGxlcihsaXN0ZW5lcik6CiAgICAgICAgICAgIHNvY2sgPSBsaXN0ZW5lci5hY2NlcHQoKVswXQoKICAgICAgICAgICAgc2VsZi5idWYgPSBzb2NrLnJlY3YoNjU1MzYpICAjIFdlIG9ubHkgYWNjZXB0IG9uZSBwYWNrZXQKICAgICAgICAgICAgZG9uZV9yZWNlaXZpbmcuc2V0KCkgICMgbGV0IHRoZSB0ZXN0IGtub3cgaXQgY2FuIHByb2NlZWQKICAgICAgICAgICAgc29jay5jbG9zZSgpCgogICAgICAgIHNlbGYuX3N0YXJ0X3NlcnZlcihzb2NrZXRfaGFuZGxlcikKICAgICAgICBwb29sID0gSFRUUFNDb25uZWN0aW9uUG9vbChzZWxmLmhvc3QsIHNlbGYucG9ydCkKICAgICAgICBzZWxmLmFkZENsZWFudXAocG9vbC5jbG9zZSkKICAgICAgICB0cnk6CiAgICAgICAgICAgIHBvb2wucmVxdWVzdCgnR0VUJywgJy8nLCByZXRyaWVzPTApCiAgICAgICAgZXhjZXB0IFNTTEVycm9yOiAgIyBXZSBhcmUgdmlvbGF0aW5nIHRoZSBwcm90b2NvbAogICAgICAgICAgICBwYXNzCiAgICAgICAgZG9uZV9yZWNlaXZpbmcud2FpdCgpCiAgICAgICAgc2VsZi5hc3NlcnRUcnVlKHNlbGYuaG9zdC5lbmNvZGUoJ2FzY2lpJykgaW4gc2VsZi5idWYsCiAgICAgICAgICAgICAgICAgICAgICAgICJtaXNzaW5nIGhvc3RuYW1lIGluIFNTTCBoYW5kc2hha2UiKQoKCmNsYXNzIFRlc3RDbGllbnRDZXJ0cyhTb2NrZXREdW1teVNlcnZlclRlc3RDYXNlKToKICAgICIiIgogICAgVGVzdHMgZm9yIGNsaWVudCBjZXJ0aWZpY2F0ZSBzdXBwb3J0LgogICAgIiIiCiAgICBkZWYgX3dyYXBfaW5fc3NsKHNlbGYsIHNvY2spOgogICAgICAgICIiIgogICAgICAgIEdpdmVuIGEgc2luZ2xlIHNvY2tldCwgd3JhcHMgaXQgaW4gVExTLgogICAgICAgICIiIgogICAgICAgIHJldHVybiBzc2wud3JhcF9zb2NrZXQoCiAgICAgICAgICAgIHNvY2ssCiAgICAgICAgICAgIHNzbF92ZXJzaW9uPXNzbC5QUk9UT0NPTF9TU0x2MjMsCiAgICAgICAgICAgIGNlcnRfcmVxcz1zc2wuQ0VSVF9SRVFVSVJFRCwKICAgICAgICAgICAgY2FfY2VydHM9REVGQVVMVF9DQSwKICAgICAgICAgICAgY2VydGZpbGU9REVGQVVMVF9DRVJUU1snY2VydGZpbGUnXSwKICAgICAgICAgICAga2V5ZmlsZT1ERUZBVUxUX0NFUlRTWydrZXlmaWxlJ10sCiAgICAgICAgICAgIHNlcnZlcl9zaWRlPVRydWUKICAgICAgICApCgogICAgZGVmIHRlc3RfY2xpZW50X2NlcnRzX3R3b19maWxlcyhzZWxmKToKICAgICAgICAiIiIKICAgICAgICBIYXZpbmcgYSBjbGllbnQgY2VydCBpbiBhIHNlcGFyYXRlIGZpbGUgdG8gaXRzIGFzc29jaWF0ZWQga2V5IHdvcmtzCiAgICAgICAgcHJvcGVybHkuCiAgICAgICAgIiIiCiAgICAgICAgZG9uZV9yZWNlaXZpbmcgPSBFdmVudCgpCiAgICAgICAgY2xpZW50X2NlcnRzID0gW10KCiAgICAgICAgZGVmIHNvY2tldF9oYW5kbGVyKGxpc3RlbmVyKToKICAgICAgICAgICAgc29jayA9IGxpc3RlbmVyLmFjY2VwdCgpWzBdCiAgICAgICAgICAgIHNvY2sgPSBzZWxmLl93cmFwX2luX3NzbChzb2NrKQoKICAgICAgICAgICAgY2xpZW50X2NlcnRzLmFwcGVuZChzb2NrLmdldHBlZXJjZXJ0KCkpCgogICAgICAgICAgICBkYXRhID0gYicnCiAgICAgICAgICAgIHdoaWxlIG5vdCBkYXRhLmVuZHN3aXRoKGInXHJcblxyXG4nKToKICAgICAgICAgICAgICAgIGRhdGEgKz0gc29jay5yZWN2KDgxOTIpCgogICAgICAgICAgICBzb2NrLnNlbmRhbGwoCiAgICAgICAgICAgICAgICBiJ0hUVFAvMS4xIDIwMCBPS1xyXG4nCiAgICAgICAgICAgICAgICBiJ1NlcnZlcjogdGVzdHNvY2tldFxyXG4nCiAgICAgICAgICAgICAgICBiJ0Nvbm5lY3Rpb246IGNsb3NlXHJcbicKICAgICAgICAgICAgICAgIGInQ29udGVudC1MZW5ndGg6IDZcclxuJwogICAgICAgICAgICAgICAgYidcclxuJwogICAgICAgICAgICAgICAgYidWYWxpZCEnCiAgICAgICAgICAgICkKCiAgICAgICAgICAgIGRvbmVfcmVjZWl2aW5nLndhaXQoNSkKICAgICAgICAgICAgc29jay5jbG9zZSgpCgogICAgICAgIHNlbGYuX3N0YXJ0X3NlcnZlcihzb2NrZXRfaGFuZGxlcikKICAgICAgICBwb29sID0gSFRUUFNDb25uZWN0aW9uUG9vbCgKICAgICAgICAgICAgc2VsZi5ob3N0LAogICAgICAgICAgICBzZWxmLnBvcnQsCiAgICAgICAgICAgIGNlcnRfZmlsZT1ERUZBVUxUX0NFUlRTWydjZXJ0ZmlsZSddLAogICAgICAgICAgICBrZXlfZmlsZT1ERUZBVUxUX0NFUlRTWydrZXlmaWxlJ10sCiAgICAgICAgICAgIGNlcnRfcmVxcz0nUkVRVUlSRUQnLAogICAgICAgICAgICBjYV9jZXJ0cz1ERUZBVUxUX0NBLAogICAgICAgICkKICAgICAgICBzZWxmLmFkZENsZWFudXAocG9vbC5jbG9zZSkKICAgICAgICBwb29sLnJlcXVlc3QoJ0dFVCcsICcvJywgcmV0cmllcz0wKQogICAgICAgIGRvbmVfcmVjZWl2aW5nLnNldCgpCgogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwobGVuKGNsaWVudF9jZXJ0cyksIDEpCgogICAgZGVmIHRlc3RfY2xpZW50X2NlcnRzX29uZV9maWxlKHNlbGYpOgogICAgICAgICIiIgogICAgICAgIEhhdmluZyBhIGNsaWVudCBjZXJ0IGFuZCBpdHMgYXNzb2NpYXRlZCBwcml2YXRlIGtleSBpbiBqdXN0IG9uZSBmaWxlCiAgICAgICAgd29ya3MgcHJvcGVybHkuCiAgICAgICAgIiIiCiAgICAgICAgZG9uZV9yZWNlaXZpbmcgPSBFdmVudCgpCiAgICAgICAgY2xpZW50X2NlcnRzID0gW10KCiAgICAgICAgZGVmIHNvY2tldF9oYW5kbGVyKGxpc3RlbmVyKToKICAgICAgICAgICAgc29jayA9IGxpc3RlbmVyLmFjY2VwdCgpWzBdCiAgICAgICAgICAgIHNvY2sgPSBzZWxmLl93cmFwX2luX3NzbChzb2NrKQoKICAgICAgICAgICAgY2xpZW50X2NlcnRzLmFwcGVuZChzb2NrLmdldHBlZXJjZXJ0KCkpCgogICAgICAgICAgICBkYXRhID0gYicnCiAgICAgICAgICAgIHdoaWxlIG5vdCBkYXRhLmVuZHN3aXRoKGInXHJcblxyXG4nKToKICAgICAgICAgICAgICAgIGRhdGEgKz0gc29jay5yZWN2KDgxOTIpCgogICAgICAgICAgICBzb2NrLnNlbmRhbGwoCiAgICAgICAgICAgICAgICBiJ0hUVFAvMS4xIDIwMCBPS1xyXG4nCiAgICAgICAgICAgICAgICBiJ1NlcnZlcjogdGVzdHNvY2tldFxyXG4nCiAgICAgICAgICAgICAgICBiJ0Nvbm5lY3Rpb246IGNsb3NlXHJcbicKICAgICAgICAgICAgICAgIGInQ29udGVudC1MZW5ndGg6IDZcclxuJwogICAgICAgICAgICAgICAgYidcclxuJwogICAgICAgICAgICAgICAgYidWYWxpZCEnCiAgICAgICAgICAgICkKCiAgICAgICAgICAgIGRvbmVfcmVjZWl2aW5nLndhaXQoNSkKICAgICAgICAgICAgc29jay5jbG9zZSgpCgogICAgICAgIHNlbGYuX3N0YXJ0X3NlcnZlcihzb2NrZXRfaGFuZGxlcikKICAgICAgICBwb29sID0gSFRUUFNDb25uZWN0aW9uUG9vbCgKICAgICAgICAgICAgc2VsZi5ob3N0LAogICAgICAgICAgICBzZWxmLnBvcnQsCiAgICAgICAgICAgIGNlcnRfZmlsZT1DT01CSU5FRF9DRVJUX0FORF9LRVksCiAgICAgICAgICAgIGNlcnRfcmVxcz0nUkVRVUlSRUQnLAogICAgICAgICAgICBjYV9jZXJ0cz1ERUZBVUxUX0NBLAogICAgICAgICkKICAgICAgICBzZWxmLmFkZENsZWFudXAocG9vbC5jbG9zZSkKICAgICAgICBwb29sLnJlcXVlc3QoJ0dFVCcsICcvJywgcmV0cmllcz0wKQogICAgICAgIGRvbmVfcmVjZWl2aW5nLnNldCgpCgogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwobGVuKGNsaWVudF9jZXJ0cyksIDEpCgogICAgZGVmIHRlc3RfbWlzc2luZ19jbGllbnRfY2VydHNfcmFpc2VzX2Vycm9yKHNlbGYpOgogICAgICAgICIiIgogICAgICAgIEhhdmluZyBjbGllbnQgY2VydHMgbm90IGJlIHByZXNlbnQgY2F1c2VzIGFuIGVycm9yLgogICAgICAgICIiIgogICAgICAgIGRvbmVfcmVjZWl2aW5nID0gRXZlbnQoKQoKICAgICAgICBkZWYgc29ja2V0X2hhbmRsZXIobGlzdGVuZXIpOgogICAgICAgICAgICBzb2NrID0gbGlzdGVuZXIuYWNjZXB0KClbMF0KCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHNlbGYuX3dyYXBfaW5fc3NsKHNvY2spCiAgICAgICAgICAgIGV4Y2VwdCBzc2wuU1NMRXJyb3I6CiAgICAgICAgICAgICAgICBwYXNzCgogICAgICAgICAgICBkb25lX3JlY2VpdmluZy53YWl0KDUpCiAgICAgICAgICAgIHNvY2suY2xvc2UoKQoKICAgICAgICBzZWxmLl9zdGFydF9zZXJ2ZXIoc29ja2V0X2hhbmRsZXIpCiAgICAgICAgcG9vbCA9IEhUVFBTQ29ubmVjdGlvblBvb2woCiAgICAgICAgICAgIHNlbGYuaG9zdCwKICAgICAgICAgICAgc2VsZi5wb3J0LAogICAgICAgICAgICBjZXJ0X3JlcXM9J1JFUVVJUkVEJywKICAgICAgICAgICAgY2FfY2VydHM9REVGQVVMVF9DQSwKICAgICAgICApCiAgICAgICAgc2VsZi5hZGRDbGVhbnVwKHBvb2wuY2xvc2UpCiAgICAgICAgdHJ5OgogICAgICAgICAgICBwb29sLnJlcXVlc3QoJ0dFVCcsICcvJywgcmV0cmllcz0wKQogICAgICAgIGV4Y2VwdCBTU0xFcnJvcjoKICAgICAgICAgICAgZG9uZV9yZWNlaXZpbmcuc2V0KCkKICAgICAgICBlbHNlOgogICAgICAgICAgICBkb25lX3JlY2VpdmluZy5zZXQoKQogICAgICAgICAgICBzZWxmLmZhaWwoCiAgICAgICAgICAgICAgICAiRXhwZWN0ZWQgc2VydmVyIHRvIHJlamVjdCBjb25uZWN0aW9uIGR1ZSB0byBtaXNzaW5nIGNsaWVudCAiCiAgICAgICAgICAgICAgICAiY2VydGlmaWNhdGVzIgogICAgICAgICAgICApCgoKY2xhc3MgVGVzdFNvY2tldENsb3NpbmcoU29ja2V0RHVtbXlTZXJ2ZXJUZXN0Q2FzZSk6CgogICAgZGVmIHRlc3RfcmVjb3Zlcnlfd2hlbl9zZXJ2ZXJfY2xvc2VzX2Nvbm5lY3Rpb24oc2VsZik6CiAgICAgICAgIyBEb2VzIHRoZSBwb29sIHdvcmsgc2VhbWxlc3NseSBpZiBhbiBvcGVuIGNvbm5lY3Rpb24gaW4gdGhlCiAgICAgICAgIyBjb25uZWN0aW9uIHBvb2wgZ2V0cyBodW5nIHVwIG9uIGJ5IHRoZSBzZXJ2ZXIsIHRoZW4gcmVhY2hlcwogICAgICAgICMgdGhlIGZyb250IG9mIHRoZSBxdWV1ZSBhZ2Fpbj8KCiAgICAgICAgZG9uZV9jbG9zaW5nID0gRXZlbnQoKQoKICAgICAgICBkZWYgc29ja2V0X2hhbmRsZXIobGlzdGVuZXIpOgogICAgICAgICAgICBmb3IgaSBpbiAwLCAxOgogICAgICAgICAgICAgICAgc29jayA9IGxpc3RlbmVyLmFjY2VwdCgpWzBdCgogICAgICAgICAgICAgICAgYnVmID0gYicnCiAgICAgICAgICAgICAgICB3aGlsZSBub3QgYnVmLmVuZHN3aXRoKGInXHJcblxyXG4nKToKICAgICAgICAgICAgICAgICAgICBidWYgPSBzb2NrLnJlY3YoNjU1MzYpCgogICAgICAgICAgICAgICAgYm9keSA9ICdSZXNwb25zZSAlZCcgJSBpCiAgICAgICAgICAgICAgICBzb2NrLnNlbmQoKCdIVFRQLzEuMSAyMDAgT0tcclxuJwogICAgICAgICAgICAgICAgICAgICAgICAgICAnQ29udGVudC1UeXBlOiB0ZXh0L3BsYWluXHJcbicKICAgICAgICAgICAgICAgICAgICAgICAgICAgJ0NvbnRlbnQtTGVuZ3RoOiAlZFxyXG4nCiAgICAgICAgICAgICAgICAgICAgICAgICAgICdcclxuJwogICAgICAgICAgICAgICAgICAgICAgICAgICAnJXMnICUgKGxlbihib2R5KSwgYm9keSkpLmVuY29kZSgndXRmLTgnKSkKCiAgICAgICAgICAgICAgICBzb2NrLmNsb3NlKCkgICMgc2ltdWxhdGUgYSBzZXJ2ZXIgdGltaW5nIG91dCwgY2xvc2luZyBzb2NrZXQKICAgICAgICAgICAgICAgIGRvbmVfY2xvc2luZy5zZXQoKSAgIyBsZXQgdGhlIHRlc3Qga25vdyBpdCBjYW4gcHJvY2VlZAoKICAgICAgICBzZWxmLl9zdGFydF9zZXJ2ZXIoc29ja2V0X2hhbmRsZXIpCiAgICAgICAgcG9vbCA9IEhUVFBDb25uZWN0aW9uUG9vbChzZWxmLmhvc3QsIHNlbGYucG9ydCkKICAgICAgICBzZWxmLmFkZENsZWFudXAocG9vbC5jbG9zZSkKCiAgICAgICAgcmVzcG9uc2UgPSBwb29sLnJlcXVlc3QoJ0dFVCcsICcvJywgcmV0cmllcz0wKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwocmVzcG9uc2Uuc3RhdHVzLCAyMDApCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChyZXNwb25zZS5kYXRhLCBiJ1Jlc3BvbnNlIDAnKQoKICAgICAgICBkb25lX2Nsb3Npbmcud2FpdCgpICAjIHdhaXQgdW50aWwgdGhlIHNvY2tldCBpbiBvdXIgcG9vbCBnZXRzIGNsb3NlZAoKICAgICAgICByZXNwb25zZSA9IHBvb2wucmVxdWVzdCgnR0VUJywgJy8nLCByZXRyaWVzPTApCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChyZXNwb25zZS5zdGF0dXMsIDIwMCkKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKHJlc3BvbnNlLmRhdGEsIGInUmVzcG9uc2UgMScpCgogICAgZGVmIHRlc3RfY29ubmVjdGlvbl9yZWZ1c2VkKHNlbGYpOgogICAgICAgICMgRG9lcyB0aGUgcG9vbCByZXRyeSBpZiB0aGVyZSBpcyBubyBsaXN0ZW5lciBvbiB0aGUgcG9ydD8KICAgICAgICBob3N0LCBwb3J0ID0gZ2V0X3VucmVhY2hhYmxlX2FkZHJlc3MoKQogICAgICAgIGh0dHAgPSBIVFRQQ29ubmVjdGlvblBvb2woaG9zdCwgcG9ydCwgbWF4c2l6ZT0zLCBibG9jaz1UcnVlKQogICAgICAgIHNlbGYuYWRkQ2xlYW51cChodHRwLmNsb3NlKQogICAgICAgIHNlbGYuYXNzZXJ0UmFpc2VzKE1heFJldHJ5RXJyb3IsIGh0dHAucmVxdWVzdCwgJ0dFVCcsICcvJywgcmV0cmllcz0wLCByZWxlYXNlX2Nvbm49RmFsc2UpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChodHRwLnBvb2wucXNpemUoKSwgaHR0cC5wb29sLm1heHNpemUpCgogICAgZGVmIHRlc3RfY29ubmVjdGlvbl9yZWFkX3RpbWVvdXQoc2VsZik6CiAgICAgICAgdGltZWRfb3V0ID0gRXZlbnQoKQoKICAgICAgICBkZWYgc29ja2V0X2hhbmRsZXIobGlzdGVuZXIpOgogICAgICAgICAgICBzb2NrID0gbGlzdGVuZXIuYWNjZXB0KClbMF0KICAgICAgICAgICAgd2hpbGUgbm90IHNvY2sucmVjdig2NTUzNikuZW5kc3dpdGgoYidcclxuXHJcbicpOgogICAgICAgICAgICAgICAgcGFzcwoKICAgICAgICAgICAgdGltZWRfb3V0LndhaXQoKQogICAgICAgICAgICBzb2NrLmNsb3NlKCkKCiAgICAgICAgc2VsZi5fc3RhcnRfc2VydmVyKHNvY2tldF9oYW5kbGVyKQogICAgICAgIGh0dHAgPSBIVFRQQ29ubmVjdGlvblBvb2woc2VsZi5ob3N0LCBzZWxmLnBvcnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aW1lb3V0PTAuMDAxLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0cmllcz1GYWxzZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1heHNpemU9MywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJsb2NrPVRydWUpCiAgICAgICAgc2VsZi5hZGRDbGVhbnVwKGh0dHAuY2xvc2UpCgogICAgICAgIHRyeToKICAgICAgICAgICAgc2VsZi5hc3NlcnRSYWlzZXMoUmVhZFRpbWVvdXRFcnJvciwgaHR0cC5yZXF1ZXN0LCAnR0VUJywgJy8nLCByZWxlYXNlX2Nvbm49RmFsc2UpCiAgICAgICAgZmluYWxseToKICAgICAgICAgICAgdGltZWRfb3V0LnNldCgpCgogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoaHR0cC5wb29sLnFzaXplKCksIGh0dHAucG9vbC5tYXhzaXplKQoKICAgIGRlZiB0ZXN0X3JlYWRfdGltZW91dF9kb250X3JldHJ5X21ldGhvZF9ub3RfaW5fd2hpdGVsaXN0KHNlbGYpOgogICAgICAgIHRpbWVkX291dCA9IEV2ZW50KCkKCiAgICAgICAgZGVmIHNvY2tldF9oYW5kbGVyKGxpc3RlbmVyKToKICAgICAgICAgICAgc29jayA9IGxpc3RlbmVyLmFjY2VwdCgpWzBdCiAgICAgICAgICAgIHNvY2sucmVjdig2NTUzNikKICAgICAgICAgICAgdGltZWRfb3V0LndhaXQoKQogICAgICAgICAgICBzb2NrLmNsb3NlKCkKCiAgICAgICAgc2VsZi5fc3RhcnRfc2VydmVyKHNvY2tldF9oYW5kbGVyKQogICAgICAgIHBvb2wgPSBIVFRQQ29ubmVjdGlvblBvb2woc2VsZi5ob3N0LCBzZWxmLnBvcnQsIHRpbWVvdXQ9MC4wMDEsIHJldHJpZXM9VHJ1ZSkKICAgICAgICBzZWxmLmFkZENsZWFudXAocG9vbC5jbG9zZSkKCiAgICAgICAgdHJ5OgogICAgICAgICAgICBzZWxmLmFzc2VydFJhaXNlcyhSZWFkVGltZW91dEVycm9yLCBwb29sLnJlcXVlc3QsICdQT1NUJywgJy8nKQogICAgICAgIGZpbmFsbHk6CiAgICAgICAgICAgIHRpbWVkX291dC5zZXQoKQoKICAgIGRlZiB0ZXN0X2h0dHBzX2Nvbm5lY3Rpb25fcmVhZF90aW1lb3V0KHNlbGYpOgogICAgICAgICIiIiBIYW5kc2hha2UgdGltZW91dHMgc2hvdWxkIGZhaWwgd2l0aCBhIFRpbWVvdXQiIiIKICAgICAgICB0aW1lZF9vdXQgPSBFdmVudCgpCgogICAgICAgIGRlZiBzb2NrZXRfaGFuZGxlcihsaXN0ZW5lcik6CiAgICAgICAgICAgIHNvY2sgPSBsaXN0ZW5lci5hY2NlcHQoKVswXQogICAgICAgICAgICB3aGlsZSBub3Qgc29jay5yZWN2KDY1NTM2KToKICAgICAgICAgICAgICAgIHBhc3MKCiAgICAgICAgICAgIHRpbWVkX291dC53YWl0KCkKICAgICAgICAgICAgc29jay5jbG9zZSgpCgogICAgICAgIHNlbGYuX3N0YXJ0X3NlcnZlcihzb2NrZXRfaGFuZGxlcikKICAgICAgICBwb29sID0gSFRUUFNDb25uZWN0aW9uUG9vbChzZWxmLmhvc3QsIHNlbGYucG9ydCwgdGltZW91dD0wLjAwMSwgcmV0cmllcz1GYWxzZSkKICAgICAgICBzZWxmLmFkZENsZWFudXAocG9vbC5jbG9zZSkKICAgICAgICB0cnk6CiAgICAgICAgICAgIHNlbGYuYXNzZXJ0UmFpc2VzKFJlYWRUaW1lb3V0RXJyb3IsIHBvb2wucmVxdWVzdCwgJ0dFVCcsICcvJykKICAgICAgICBmaW5hbGx5OgogICAgICAgICAgICB0aW1lZF9vdXQuc2V0KCkKCiAgICBkZWYgdGVzdF90aW1lb3V0X2Vycm9yc19jYXVzZV9yZXRyaWVzKHNlbGYpOgogICAgICAgIGRlZiBzb2NrZXRfaGFuZGxlcihsaXN0ZW5lcik6CiAgICAgICAgICAgIHNvY2tfdGltZW91dCA9IGxpc3RlbmVyLmFjY2VwdCgpWzBdCgogICAgICAgICAgICAjIFdhaXQgZm9yIGEgc2Vjb25kIHJlcXVlc3QgYmVmb3JlIGNsb3NpbmcgdGhlIGZpcnN0IHNvY2tldC4KICAgICAgICAgICAgc29jayA9IGxpc3RlbmVyLmFjY2VwdCgpWzBdCiAgICAgICAgICAgIHNvY2tfdGltZW91dC5jbG9zZSgpCgogICAgICAgICAgICAjIFNlY29uZCByZXF1ZXN0LgogICAgICAgICAgICBidWYgPSBiJycKICAgICAgICAgICAgd2hpbGUgbm90IGJ1Zi5lbmRzd2l0aChiJ1xyXG5cclxuJyk6CiAgICAgICAgICAgICAgICBidWYgKz0gc29jay5yZWN2KDY1NTM2KQoKICAgICAgICAgICAgIyBOb3cgcmVzcG9uZCBpbW1lZGlhdGVseS4KICAgICAgICAgICAgYm9keSA9ICdSZXNwb25zZSAyJwogICAgICAgICAgICBzb2NrLnNlbmQoKCdIVFRQLzEuMSAyMDAgT0tcclxuJwogICAgICAgICAgICAgICAgICAgICAgICdDb250ZW50LVR5cGU6IHRleHQvcGxhaW5cclxuJwogICAgICAgICAgICAgICAgICAgICAgICdDb250ZW50LUxlbmd0aDogJWRcclxuJwogICAgICAgICAgICAgICAgICAgICAgICdcclxuJwogICAgICAgICAgICAgICAgICAgICAgICclcycgJSAobGVuKGJvZHkpLCBib2R5KSkuZW5jb2RlKCd1dGYtOCcpKQoKICAgICAgICAgICAgc29jay5jbG9zZSgpCgogICAgICAgICMgSW4gc2l0dWF0aW9ucyB3aGVyZSB0aGUgbWFpbiB0aHJlYWQgdGhyb3dzIGFuIGV4Y2VwdGlvbiwgdGhlIHNlcnZlcgogICAgICAgICMgdGhyZWFkIGNhbiBoYW5nIG9uIGFuIGFjY2VwdCgpIGNhbGwuIFRoaXMgZW5zdXJlcyBldmVyeXRoaW5nIHRpbWVzCiAgICAgICAgIyBvdXQgd2l0aGluIDEgc2Vjb25kLiBUaGlzIHNob3VsZCBiZSBsb25nIGVub3VnaCBmb3IgYW55IHNvY2tldAogICAgICAgICMgb3BlcmF0aW9ucyBpbiB0aGUgdGVzdCBzdWl0ZSB0byBjb21wbGV0ZQogICAgICAgIGRlZmF1bHRfdGltZW91dCA9IHNvY2tldC5nZXRkZWZhdWx0dGltZW91dCgpCiAgICAgICAgc29ja2V0LnNldGRlZmF1bHR0aW1lb3V0KDEpCgogICAgICAgIHRyeToKICAgICAgICAgICAgc2VsZi5fc3RhcnRfc2VydmVyKHNvY2tldF9oYW5kbGVyKQogICAgICAgICAgICB0ID0gVGltZW91dChjb25uZWN0PTAuMDAxLCByZWFkPTAuMDAxKQogICAgICAgICAgICBwb29sID0gSFRUUENvbm5lY3Rpb25Qb29sKHNlbGYuaG9zdCwgc2VsZi5wb3J0LCB0aW1lb3V0PXQpCiAgICAgICAgICAgIHNlbGYuYWRkQ2xlYW51cChwb29sLmNsb3NlKQoKICAgICAgICAgICAgcmVzcG9uc2UgPSBwb29sLnJlcXVlc3QoJ0dFVCcsICcvJywgcmV0cmllcz0xKQogICAgICAgICAgICBzZWxmLmFzc2VydEVxdWFsKHJlc3BvbnNlLnN0YXR1cywgMjAwKQogICAgICAgICAgICBzZWxmLmFzc2VydEVxdWFsKHJlc3BvbnNlLmRhdGEsIGInUmVzcG9uc2UgMicpCiAgICAgICAgZmluYWxseToKICAgICAgICAgICAgc29ja2V0LnNldGRlZmF1bHR0aW1lb3V0KGRlZmF1bHRfdGltZW91dCkKCiAgICBkZWYgdGVzdF9kZWxheWVkX2JvZHlfcmVhZF90aW1lb3V0KHNlbGYpOgogICAgICAgIHRpbWVkX291dCA9IEV2ZW50KCkKCiAgICAgICAgZGVmIHNvY2tldF9oYW5kbGVyKGxpc3RlbmVyKToKICAgICAgICAgICAgc29jayA9IGxpc3RlbmVyLmFjY2VwdCgpWzBdCiAgICAgICAgICAgIGJ1ZiA9IGInJwogICAgICAgICAgICBib2R5ID0gJ0hpJwogICAgICAgICAgICB3aGlsZSBub3QgYnVmLmVuZHN3aXRoKGInXHJcblxyXG4nKToKICAgICAgICAgICAgICAgIGJ1ZiA9IHNvY2sucmVjdig2NTUzNikKICAgICAgICAgICAgc29jay5zZW5kKCgnSFRUUC8xLjEgMjAwIE9LXHJcbicKICAgICAgICAgICAgICAgICAgICAgICAnQ29udGVudC1UeXBlOiB0ZXh0L3BsYWluXHJcbicKICAgICAgICAgICAgICAgICAgICAgICAnQ29udGVudC1MZW5ndGg6ICVkXHJcbicKICAgICAgICAgICAgICAgICAgICAgICAnXHJcbicgJSBsZW4oYm9keSkpLmVuY29kZSgndXRmLTgnKSkKCiAgICAgICAgICAgIHRpbWVkX291dC53YWl0KCkKICAgICAgICAgICAgc29jay5zZW5kKGJvZHkuZW5jb2RlKCd1dGYtOCcpKQogICAgICAgICAgICBzb2NrLmNsb3NlKCkKCiAgICAgICAgc2VsZi5fc3RhcnRfc2VydmVyKHNvY2tldF9oYW5kbGVyKQogICAgICAgIHBvb2wgPSBIVFRQQ29ubmVjdGlvblBvb2woc2VsZi5ob3N0LCBzZWxmLnBvcnQpCiAgICAgICAgc2VsZi5hZGRDbGVhbnVwKHBvb2wuY2xvc2UpCgogICAgICAgIHJlc3BvbnNlID0gcG9vbC51cmxvcGVuKCdHRVQnLCAnLycsIHJldHJpZXM9MCwgcHJlbG9hZF9jb250ZW50PUZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVvdXQ9VGltZW91dChjb25uZWN0PTEsIHJlYWQ9MC4wMDEpKQogICAgICAgIHRyeToKICAgICAgICAgICAgc2VsZi5hc3NlcnRSYWlzZXMoUmVhZFRpbWVvdXRFcnJvciwgcmVzcG9uc2UucmVhZCkKICAgICAgICBmaW5hbGx5OgogICAgICAgICAgICB0aW1lZF9vdXQuc2V0KCkKCiAgICBkZWYgdGVzdF9kZWxheWVkX2JvZHlfcmVhZF90aW1lb3V0X3dpdGhfcHJlbG9hZChzZWxmKToKICAgICAgICB0aW1lZF9vdXQgPSBFdmVudCgpCgogICAgICAgIGRlZiBzb2NrZXRfaGFuZGxlcihsaXN0ZW5lcik6CiAgICAgICAgICAgIHNvY2sgPSBsaXN0ZW5lci5hY2NlcHQoKVswXQogICAgICAgICAgICBidWYgPSBiJycKICAgICAgICAgICAgYm9keSA9ICdIaScKICAgICAgICAgICAgd2hpbGUgbm90IGJ1Zi5lbmRzd2l0aChiJ1xyXG5cclxuJyk6CiAgICAgICAgICAgICAgICBidWYgKz0gc29jay5yZWN2KDY1NTM2KQogICAgICAgICAgICBzb2NrLnNlbmQoKCdIVFRQLzEuMSAyMDAgT0tcclxuJwogICAgICAgICAgICAgICAgICAgICAgICdDb250ZW50LVR5cGU6IHRleHQvcGxhaW5cclxuJwogICAgICAgICAgICAgICAgICAgICAgICdDb250ZW50LUxlbmd0aDogJWRcclxuJwogICAgICAgICAgICAgICAgICAgICAgICdcclxuJyAlIGxlbihib2R5KSkuZW5jb2RlKCd1dGYtOCcpKQoKICAgICAgICAgICAgdGltZWRfb3V0LndhaXQoNSkKICAgICAgICAgICAgc29jay5jbG9zZSgpCgogICAgICAgIHNlbGYuX3N0YXJ0X3NlcnZlcihzb2NrZXRfaGFuZGxlcikKICAgICAgICBwb29sID0gSFRUUENvbm5lY3Rpb25Qb29sKHNlbGYuaG9zdCwgc2VsZi5wb3J0KQogICAgICAgIHNlbGYuYWRkQ2xlYW51cChwb29sLmNsb3NlKQoKICAgICAgICB0cnk6CiAgICAgICAgICAgIHNlbGYuYXNzZXJ0UmFpc2VzKFJlYWRUaW1lb3V0RXJyb3IsIHBvb2wudXJsb3BlbiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ0dFVCcsICcvJywgcmV0cmllcz1GYWxzZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGltZW91dD1UaW1lb3V0KGNvbm5lY3Q9MSwgcmVhZD0wLjAwMSkpCiAgICAgICAgZmluYWxseToKICAgICAgICAgICAgdGltZWRfb3V0LnNldCgpCgogICAgZGVmIHRlc3RfaW5jb21wbGV0ZV9yZXNwb25zZShzZWxmKToKICAgICAgICBib2R5ID0gJ1Jlc3BvbnNlJwogICAgICAgIHBhcnRpYWxfYm9keSA9IGJvZHlbOjJdCgogICAgICAgIGRlZiBzb2NrZXRfaGFuZGxlcihsaXN0ZW5lcik6CiAgICAgICAgICAgIHNvY2sgPSBsaXN0ZW5lci5hY2NlcHQoKVswXQoKICAgICAgICAgICAgIyBDb25zdW1lIHJlcXVlc3QKICAgICAgICAgICAgYnVmID0gYicnCiAgICAgICAgICAgIHdoaWxlIG5vdCBidWYuZW5kc3dpdGgoYidcclxuXHJcbicpOgogICAgICAgICAgICAgICAgYnVmID0gc29jay5yZWN2KDY1NTM2KQoKICAgICAgICAgICAgIyBTZW5kIHBhcnRpYWwgcmVzcG9uc2UgYW5kIGNsb3NlIHNvY2tldC4KICAgICAgICAgICAgc29jay5zZW5kKCgKICAgICAgICAgICAgICAgICdIVFRQLzEuMSAyMDAgT0tcclxuJwogICAgICAgICAgICAgICAgJ0NvbnRlbnQtVHlwZTogdGV4dC9wbGFpblxyXG4nCiAgICAgICAgICAgICAgICAnQ29udGVudC1MZW5ndGg6ICVkXHJcbicKICAgICAgICAgICAgICAgICdcclxuJwogICAgICAgICAgICAgICAgJyVzJyAlIChsZW4oYm9keSksIHBhcnRpYWxfYm9keSkpLmVuY29kZSgndXRmLTgnKQogICAgICAgICAgICApCiAgICAgICAgICAgIHNvY2suY2xvc2UoKQoKICAgICAgICBzZWxmLl9zdGFydF9zZXJ2ZXIoc29ja2V0X2hhbmRsZXIpCiAgICAgICAgcG9vbCA9IEhUVFBDb25uZWN0aW9uUG9vbChzZWxmLmhvc3QsIHNlbGYucG9ydCkKICAgICAgICBzZWxmLmFkZENsZWFudXAocG9vbC5jbG9zZSkKCiAgICAgICAgcmVzcG9uc2UgPSBwb29sLnJlcXVlc3QoJ0dFVCcsICcvJywgcmV0cmllcz0wLCBwcmVsb2FkX2NvbnRlbnQ9RmFsc2UpCiAgICAgICAgc2VsZi5hc3NlcnRSYWlzZXMoUHJvdG9jb2xFcnJvciwgcmVzcG9uc2UucmVhZCkKCiAgICBkZWYgdGVzdF9yZXRyeV93ZWlyZF9odHRwX3ZlcnNpb24oc2VsZik6CiAgICAgICAgIiIiIFJldHJ5IGNsYXNzIHNob3VsZCBoYW5kbGUgaHR0cGxpYi5CYWRTdGF0dXNMaW5lIGVycm9ycyBwcm9wZXJseSAiIiIKCiAgICAgICAgZGVmIHNvY2tldF9oYW5kbGVyKGxpc3RlbmVyKToKICAgICAgICAgICAgc29jayA9IGxpc3RlbmVyLmFjY2VwdCgpWzBdCiAgICAgICAgICAgICMgRmlyc3QgcmVxdWVzdC4KICAgICAgICAgICAgIyBQYXVzZSBiZWZvcmUgcmVzcG9uZGluZyBzbyB0aGUgZmlyc3QgcmVxdWVzdCB0aW1lcyBvdXQuCiAgICAgICAgICAgIGJ1ZiA9IGInJwogICAgICAgICAgICB3aGlsZSBub3QgYnVmLmVuZHN3aXRoKGInXHJcblxyXG4nKToKICAgICAgICAgICAgICAgIGJ1ZiArPSBzb2NrLnJlY3YoNjU1MzYpCgogICAgICAgICAgICAjIHNlbmQgdW5rbm93biBodHRwIHByb3RvY29sCiAgICAgICAgICAgIGJvZHkgPSAiYmFkIGh0dHAgMC41IHJlc3BvbnNlIgogICAgICAgICAgICBzb2NrLnNlbmQoKCdIVFRQLzAuNSAyMDAgT0tcclxuJwogICAgICAgICAgICAgICAgICAgICAgICdDb250ZW50LVR5cGU6IHRleHQvcGxhaW5cclxuJwogICAgICAgICAgICAgICAgICAgICAgICdDb250ZW50LUxlbmd0aDogJWRcclxuJwogICAgICAgICAgICAgICAgICAgICAgICdcclxuJwogICAgICAgICAgICAgICAgICAgICAgICclcycgJSAobGVuKGJvZHkpLCBib2R5KSkuZW5jb2RlKCd1dGYtOCcpKQogICAgICAgICAgICBzb2NrLmNsb3NlKCkKCiAgICAgICAgICAgICMgU2Vjb25kIHJlcXVlc3QuCiAgICAgICAgICAgIHNvY2sgPSBsaXN0ZW5lci5hY2NlcHQoKVswXQogICAgICAgICAgICBidWYgPSBiJycKICAgICAgICAgICAgd2hpbGUgbm90IGJ1Zi5lbmRzd2l0aChiJ1xyXG5cclxuJyk6CiAgICAgICAgICAgICAgICBidWYgKz0gc29jay5yZWN2KDY1NTM2KQoKICAgICAgICAgICAgIyBOb3cgcmVzcG9uZCBpbW1lZGlhdGVseS4KICAgICAgICAgICAgc29jay5zZW5kKCgnSFRUUC8xLjEgMjAwIE9LXHJcbicKICAgICAgICAgICAgICAgICAgICAgICAnQ29udGVudC1UeXBlOiB0ZXh0L3BsYWluXHJcbicKICAgICAgICAgICAgICAgICAgICAgICAnQ29udGVudC1MZW5ndGg6ICVkXHJcbicKICAgICAgICAgICAgICAgICAgICAgICAnXHJcbicKICAgICAgICAgICAgICAgICAgICAgICAnZm9vJyAlIChsZW4oJ2ZvbycpKSkuZW5jb2RlKCd1dGYtOCcpKQoKICAgICAgICAgICAgc29jay5jbG9zZSgpICAjIENsb3NlIHRoZSBzb2NrZXQuCgogICAgICAgIHNlbGYuX3N0YXJ0X3NlcnZlcihzb2NrZXRfaGFuZGxlcikKICAgICAgICBwb29sID0gSFRUUENvbm5lY3Rpb25Qb29sKHNlbGYuaG9zdCwgc2VsZi5wb3J0KQogICAgICAgIHNlbGYuYWRkQ2xlYW51cChwb29sLmNsb3NlKQogICAgICAgIHJldHJ5ID0gUmV0cnkocmVhZD0xKQogICAgICAgIHJlc3BvbnNlID0gcG9vbC5yZXF1ZXN0KCdHRVQnLCAnLycsIHJldHJpZXM9cmV0cnkpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChyZXNwb25zZS5zdGF0dXMsIDIwMCkKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKHJlc3BvbnNlLmRhdGEsIGInZm9vJykKCiAgICBkZWYgdGVzdF9jb25uZWN0aW9uX2NsZWFudXBfb25fcmVhZF90aW1lb3V0KHNlbGYpOgogICAgICAgIHRpbWVkX291dCA9IEV2ZW50KCkKCiAgICAgICAgZGVmIHNvY2tldF9oYW5kbGVyKGxpc3RlbmVyKToKICAgICAgICAgICAgc29jayA9IGxpc3RlbmVyLmFjY2VwdCgpWzBdCiAgICAgICAgICAgIGJ1ZiA9IGInJwogICAgICAgICAgICBib2R5ID0gJ0hpJwogICAgICAgICAgICB3aGlsZSBub3QgYnVmLmVuZHN3aXRoKGInXHJcblxyXG4nKToKICAgICAgICAgICAgICAgIGJ1ZiA9IHNvY2sucmVjdig2NTUzNikKICAgICAgICAgICAgc29jay5zZW5kKCgnSFRUUC8xLjEgMjAwIE9LXHJcbicKICAgICAgICAgICAgICAgICAgICAgICAnQ29udGVudC1UeXBlOiB0ZXh0L3BsYWluXHJcbicKICAgICAgICAgICAgICAgICAgICAgICAnQ29udGVudC1MZW5ndGg6ICVkXHJcbicKICAgICAgICAgICAgICAgICAgICAgICAnXHJcbicgJSBsZW4oYm9keSkpLmVuY29kZSgndXRmLTgnKSkKCiAgICAgICAgICAgIHRpbWVkX291dC53YWl0KCkKICAgICAgICAgICAgc29jay5jbG9zZSgpCgogICAgICAgIHNlbGYuX3N0YXJ0X3NlcnZlcihzb2NrZXRfaGFuZGxlcikKICAgICAgICB3aXRoIEhUVFBDb25uZWN0aW9uUG9vbChzZWxmLmhvc3QsIHNlbGYucG9ydCkgYXMgcG9vbDoKICAgICAgICAgICAgcG9vbHNpemUgPSBwb29sLnBvb2wucXNpemUoKQogICAgICAgICAgICByZXNwb25zZSA9IHBvb2wudXJsb3BlbignR0VUJywgJy8nLCByZXRyaWVzPTAsIHByZWxvYWRfY29udGVudD1GYWxzZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGltZW91dD1UaW1lb3V0KGNvbm5lY3Q9MSwgcmVhZD0wLjAwMSkpCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHNlbGYuYXNzZXJ0UmFpc2VzKFJlYWRUaW1lb3V0RXJyb3IsIHJlc3BvbnNlLnJlYWQpCiAgICAgICAgICAgICAgICBzZWxmLmFzc2VydEVxdWFsKHBvb2xzaXplLCBwb29sLnBvb2wucXNpemUoKSkKICAgICAgICAgICAgZmluYWxseToKICAgICAgICAgICAgICAgIHRpbWVkX291dC5zZXQoKQoKICAgIGRlZiB0ZXN0X2Nvbm5lY3Rpb25fY2xlYW51cF9vbl9wcm90b2NvbF9lcnJvcl9kdXJpbmdfcmVhZChzZWxmKToKICAgICAgICBib2R5ID0gJ1Jlc3BvbnNlJwogICAgICAgIHBhcnRpYWxfYm9keSA9IGJvZHlbOjJdCgogICAgICAgIGRlZiBzb2NrZXRfaGFuZGxlcihsaXN0ZW5lcik6CiAgICAgICAgICAgIHNvY2sgPSBsaXN0ZW5lci5hY2NlcHQoKVswXQoKICAgICAgICAgICAgIyBDb25zdW1lIHJlcXVlc3QKICAgICAgICAgICAgYnVmID0gYicnCiAgICAgICAgICAgIHdoaWxlIG5vdCBidWYuZW5kc3dpdGgoYidcclxuXHJcbicpOgogICAgICAgICAgICAgICAgYnVmID0gc29jay5yZWN2KDY1NTM2KQoKICAgICAgICAgICAgIyBTZW5kIHBhcnRpYWwgcmVzcG9uc2UgYW5kIGNsb3NlIHNvY2tldC4KICAgICAgICAgICAgc29jay5zZW5kKCgnSFRUUC8xLjEgMjAwIE9LXHJcbicKICAgICAgICAgICAgICAgICAgICAgICAnQ29udGVudC1UeXBlOiB0ZXh0L3BsYWluXHJcbicKICAgICAgICAgICAgICAgICAgICAgICAnQ29udGVudC1MZW5ndGg6ICVkXHJcbicKICAgICAgICAgICAgICAgICAgICAgICAnXHJcbicKICAgICAgICAgICAgICAgICAgICAgICAnJXMnICUgKGxlbihib2R5KSwgcGFydGlhbF9ib2R5KSkuZW5jb2RlKCd1dGYtOCcpKQogICAgICAgICAgICBzb2NrLmNsb3NlKCkKCiAgICAgICAgc2VsZi5fc3RhcnRfc2VydmVyKHNvY2tldF9oYW5kbGVyKQogICAgICAgIHdpdGggSFRUUENvbm5lY3Rpb25Qb29sKHNlbGYuaG9zdCwgc2VsZi5wb3J0KSBhcyBwb29sOgogICAgICAgICAgICBwb29sc2l6ZSA9IHBvb2wucG9vbC5xc2l6ZSgpCiAgICAgICAgICAgIHJlc3BvbnNlID0gcG9vbC5yZXF1ZXN0KCdHRVQnLCAnLycsIHJldHJpZXM9MCwgcHJlbG9hZF9jb250ZW50PUZhbHNlKQoKICAgICAgICAgICAgc2VsZi5hc3NlcnRSYWlzZXMoUHJvdG9jb2xFcnJvciwgcmVzcG9uc2UucmVhZCkKICAgICAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChwb29sc2l6ZSwgcG9vbC5wb29sLnFzaXplKCkpCgogICAgZGVmIHRlc3RfY29ubmVjdGlvbl9jbG9zZWRfb25fcmVhZF90aW1lb3V0X3ByZWxvYWRfZmFsc2Uoc2VsZik6CiAgICAgICAgdGltZWRfb3V0ID0gRXZlbnQoKQoKICAgICAgICBkZWYgc29ja2V0X2hhbmRsZXIobGlzdGVuZXIpOgogICAgICAgICAgICBzb2NrID0gbGlzdGVuZXIuYWNjZXB0KClbMF0KCiAgICAgICAgICAgICMgQ29uc3VtZSByZXF1ZXN0CiAgICAgICAgICAgIGJ1ZiA9IGInJwogICAgICAgICAgICB3aGlsZSBub3QgYnVmLmVuZHN3aXRoKGInXHJcblxyXG4nKToKICAgICAgICAgICAgICAgIGJ1ZiA9IHNvY2sucmVjdig2NTUzNSkKCiAgICAgICAgICAgICMgU2VuZCBwYXJ0aWFsIGNodW5rZWQgcmVzcG9uc2UgYW5kIHRoZW4gaGFuZy4KICAgICAgICAgICAgc29jay5zZW5kKCgKICAgICAgICAgICAgICAgICdIVFRQLzEuMSAyMDAgT0tcclxuJwogICAgICAgICAgICAgICAgJ0NvbnRlbnQtVHlwZTogdGV4dC9wbGFpblxyXG4nCiAgICAgICAgICAgICAgICAnVHJhbnNmZXItRW5jb2Rpbmc6IGNodW5rZWRcclxuJwogICAgICAgICAgICAgICAgJ1xyXG4nCiAgICAgICAgICAgICAgICAnOFxyXG4nCiAgICAgICAgICAgICAgICAnMTIzNDU2NzhcclxuJykuZW5jb2RlKCd1dGYtOCcpCiAgICAgICAgICAgICkKICAgICAgICAgICAgdGltZWRfb3V0LndhaXQoNSkKCiAgICAgICAgICAgICMgRXhwZWN0IGEgbmV3IHJlcXVlc3QsIGJ1dCBrZWVwIGhvbGQgb2YgdGhlIG9sZCBzb2NrZXQgdG8gYXZvaWQKICAgICAgICAgICAgIyBsZWFraW5nIGl0LiBCZWNhdXNlIHdlIGRvbid0IHdhbnQgdG8gaGFuZyB0aGlzIHRocmVhZCwgd2UKICAgICAgICAgICAgIyBhY3R1YWxseSB1c2Ugc2VsZWN0LnNlbGVjdCB0byBjb25maXJtIHRoYXQgYSBuZXcgcmVxdWVzdCBpcwogICAgICAgICAgICAjIGNvbWluZyBpbjogdGhpcyBsZXRzIHVzIHRpbWUgdGhlIHRocmVhZCBvdXQuCiAgICAgICAgICAgIHJsaXN0LCBfLCBfID0gc2VsZWN0LnNlbGVjdChbbGlzdGVuZXJdLCBbXSwgW10sIDEpCiAgICAgICAgICAgIGFzc2VydCBybGlzdAogICAgICAgICAgICBuZXdfc29jayA9IGxpc3RlbmVyLmFjY2VwdCgpWzBdCgogICAgICAgICAgICAjIENvbnN1bWUgcmVxdWVzdAogICAgICAgICAgICBidWYgPSBiJycKICAgICAgICAgICAgd2hpbGUgbm90IGJ1Zi5lbmRzd2l0aChiJ1xyXG5cclxuJyk6CiAgICAgICAgICAgICAgICBidWYgPSBuZXdfc29jay5yZWN2KDY1NTM1KQoKICAgICAgICAgICAgIyBTZW5kIGNvbXBsZXRlIGNodW5rZWQgcmVzcG9uc2UuCiAgICAgICAgICAgIG5ld19zb2NrLnNlbmQoKAogICAgICAgICAgICAgICAgJ0hUVFAvMS4xIDIwMCBPS1xyXG4nCiAgICAgICAgICAgICAgICAnQ29udGVudC1UeXBlOiB0ZXh0L3BsYWluXHJcbicKICAgICAgICAgICAgICAgICdUcmFuc2Zlci1FbmNvZGluZzogY2h1bmtlZFxyXG4nCiAgICAgICAgICAgICAgICAnXHJcbicKICAgICAgICAgICAgICAgICc4XHJcbicKICAgICAgICAgICAgICAgICcxMjM0NTY3OFxyXG4nCiAgICAgICAgICAgICAgICAnMFxyXG5cclxuJykuZW5jb2RlKCd1dGYtOCcpCiAgICAgICAgICAgICkKCiAgICAgICAgICAgIG5ld19zb2NrLmNsb3NlKCkKICAgICAgICAgICAgc29jay5jbG9zZSgpCgogICAgICAgIHNlbGYuX3N0YXJ0X3NlcnZlcihzb2NrZXRfaGFuZGxlcikKICAgICAgICB3aXRoIEhUVFBDb25uZWN0aW9uUG9vbChzZWxmLmhvc3QsIHNlbGYucG9ydCkgYXMgcG9vbDoKICAgICAgICAgICAgIyBGaXJzdCByZXF1ZXN0IHNob3VsZCBmYWlsLgogICAgICAgICAgICByZXNwb25zZSA9IHBvb2wudXJsb3BlbignR0VUJywgJy8nLCByZXRyaWVzPTAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByZWxvYWRfY29udGVudD1GYWxzZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGltZW91dD1UaW1lb3V0KGNvbm5lY3Q9MSwgcmVhZD0wLjAwMSkpCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHNlbGYuYXNzZXJ0UmFpc2VzKFJlYWRUaW1lb3V0RXJyb3IsIHJlc3BvbnNlLnJlYWQpCiAgICAgICAgICAgIGZpbmFsbHk6CiAgICAgICAgICAgICAgICB0aW1lZF9vdXQuc2V0KCkKCiAgICAgICAgICAgICMgU2Vjb25kIHNob3VsZCBzdWNjZWVkLgogICAgICAgICAgICByZXNwb25zZSA9IHBvb2wudXJsb3BlbignR0VUJywgJy8nLCByZXRyaWVzPTAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByZWxvYWRfY29udGVudD1GYWxzZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGltZW91dD1UaW1lb3V0KGNvbm5lY3Q9MSwgcmVhZD0wLjEpKQogICAgICAgICAgICBzZWxmLmFzc2VydEVxdWFsKGxlbihyZXNwb25zZS5yZWFkKCkpLCA4KQoKICAgIGRlZiB0ZXN0X2Nsb3NpbmdfcmVzcG9uc2VfYWN0dWFsbHlfY2xvc2VzX2Nvbm5lY3Rpb24oc2VsZik6CiAgICAgICAgZG9uZV9jbG9zaW5nID0gRXZlbnQoKQogICAgICAgIGNvbXBsZXRlID0gRXZlbnQoKQogICAgICAgICMgVGhlIGluc2FuZSB1c2Ugb2YgdGhpcyB2YXJpYWJsZSBoZXJlIGlzIHRvIGdldCBhcm91bmQgdGhlIGZhY3QgdGhhdAogICAgICAgICMgUHl0aG9uIDIuNiBkb2VzIG5vdCBzdXBwb3J0IHJldHVybmluZyBhIHZhbHVlIGZyb20gRXZlbnQud2FpdCgpLiBUaGlzCiAgICAgICAgIyBtZWFucyB3ZSBjYW4ndCB0ZWxsIGlmIGFuIGV2ZW50IHRpbWVkIG91dCwgc28gd2UgY2FuJ3QgdXNlIHRoZSB0aW1pbmcKICAgICAgICAjIG91dCBvZiB0aGUgJ2NvbXBsZXRlJyBldmVudCB0byBkZXRlcm1pbmUgdGhlIHN1Y2Nlc3Mgb3IgZmFpbHVyZSBvZgogICAgICAgICMgdGhlIHRlc3QuIFB5dGhvbiAyIGFsc28gZG9lc24ndCBoYXZlIHRoZSBub25sb2NhbCBzdGF0ZW1lbnQsIHNvIHdlCiAgICAgICAgIyBjYW4ndCB3cml0ZSBkaXJlY3RseSB0byB0aGlzIHZhcmlhYmxlLCBvbmx5IG11dGF0ZSBpdC4gSGVuY2U6IGxpc3QuCiAgICAgICAgc3VjY2Vzc2Z1bCA9IFtdCgogICAgICAgIGRlZiBzb2NrZXRfaGFuZGxlcihsaXN0ZW5lcik6CiAgICAgICAgICAgIHNvY2sgPSBsaXN0ZW5lci5hY2NlcHQoKVswXQoKICAgICAgICAgICAgYnVmID0gYicnCiAgICAgICAgICAgIHdoaWxlIG5vdCBidWYuZW5kc3dpdGgoYidcclxuXHJcbicpOgogICAgICAgICAgICAgICAgYnVmID0gc29jay5yZWN2KDY1NTM2KQoKICAgICAgICAgICAgc29jay5zZW5kKCgnSFRUUC8xLjEgMjAwIE9LXHJcbicKICAgICAgICAgICAgICAgICAgICAgICAnQ29udGVudC1UeXBlOiB0ZXh0L3BsYWluXHJcbicKICAgICAgICAgICAgICAgICAgICAgICAnQ29udGVudC1MZW5ndGg6IDBcclxuJwogICAgICAgICAgICAgICAgICAgICAgICdcclxuJykuZW5jb2RlKCd1dGYtOCcpKQoKICAgICAgICAgICAgIyBXYWl0IGZvciB0aGUgc29ja2V0IHRvIGNsb3NlLgogICAgICAgICAgICBkb25lX2Nsb3Npbmcud2FpdCh0aW1lb3V0PTEpCgogICAgICAgICAgICAjIExvb2sgZm9yIHRoZSBlbXB0eSBzdHJpbmcgdG8gc2hvdyB0aGF0IHRoZSBjb25uZWN0aW9uIGdvdCBjbG9zZWQuCiAgICAgICAgICAgICMgRG9uJ3QgZ2V0IHN0dWNrIGluIGEgdGltZW91dC4KICAgICAgICAgICAgc29jay5zZXR0aW1lb3V0KDEpCiAgICAgICAgICAgIG5ld19kYXRhID0gc29jay5yZWN2KDY1NTM2KQogICAgICAgICAgICBzZWxmLmFzc2VydEZhbHNlKG5ld19kYXRhKQogICAgICAgICAgICBzdWNjZXNzZnVsLmFwcGVuZChUcnVlKQogICAgICAgICAgICBzb2NrLmNsb3NlKCkKICAgICAgICAgICAgY29tcGxldGUuc2V0KCkKCiAgICAgICAgc2VsZi5fc3RhcnRfc2VydmVyKHNvY2tldF9oYW5kbGVyKQogICAgICAgIHBvb2wgPSBIVFRQQ29ubmVjdGlvblBvb2woc2VsZi5ob3N0LCBzZWxmLnBvcnQpCiAgICAgICAgc2VsZi5hZGRDbGVhbnVwKHBvb2wuY2xvc2UpCgogICAgICAgIHJlc3BvbnNlID0gcG9vbC5yZXF1ZXN0KCdHRVQnLCAnLycsIHJldHJpZXM9MCwgcHJlbG9hZF9jb250ZW50PUZhbHNlKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwocmVzcG9uc2Uuc3RhdHVzLCAyMDApCiAgICAgICAgcmVzcG9uc2UuY2xvc2UoKQoKICAgICAgICBkb25lX2Nsb3Npbmcuc2V0KCkgICMgd2FpdCB1bnRpbCB0aGUgc29ja2V0IGluIG91ciBwb29sIGdldHMgY2xvc2VkCiAgICAgICAgY29tcGxldGUud2FpdCh0aW1lb3V0PTEpCiAgICAgICAgaWYgbm90IHN1Y2Nlc3NmdWw6CiAgICAgICAgICAgIHNlbGYuZmFpbCgiVGltZWQgb3V0IHdhaXRpbmcgZm9yIGNvbm5lY3Rpb24gY2xvc2UiKQoKICAgIGRlZiB0ZXN0X3JlbGVhc2VfY29ubl9wYXJhbV9pc19yZXNwZWN0ZWRfYWZ0ZXJfdGltZW91dF9yZXRyeShzZWxmKToKICAgICAgICAiIiJGb3Igc3VjY2Vzc2Z1bCBgYGB1cmxvcGVuKHJlbGVhc2VfY29ubj1GYWxzZSlgYGAsCiAgICAgICAgdGhlIGNvbm5lY3Rpb24gaXNuJ3QgcmVsZWFzZWQsIGV2ZW4gYWZ0ZXIgYSByZXRyeS4KCiAgICAgICAgVGhpcyB0ZXN0IGFsbG93cyBhIHJldHJ5OiBvbmUgcmVxdWVzdCBmYWlscywgdGhlIG5leHQgcmVxdWVzdCBzdWNjZWVkcy4KCiAgICAgICAgVGhpcyBpcyBhIHJlZ3Jlc3Npb24gdGVzdCBmb3IgaXNzdWUgIzY1MSBbMV0sIHdoZXJlIHRoZSBjb25uZWN0aW9uCiAgICAgICAgd291bGQgYmUgcmVsZWFzZWQgaWYgdGhlIGluaXRpYWwgcmVxdWVzdCBmYWlsZWQsIGV2ZW4gaWYgYSByZXRyeQogICAgICAgIHN1Y2NlZWRlZC4KCiAgICAgICAgWzFdIDxodHRwczovL2dpdGh1Yi5jb20vc2hhem93L3VybGxpYjMvaXNzdWVzLzY1MT4KICAgICAgICAiIiIKICAgICAgICBkZWYgc29ja2V0X2hhbmRsZXIobGlzdGVuZXIpOgogICAgICAgICAgICBzb2NrID0gbGlzdGVuZXIuYWNjZXB0KClbMF0KICAgICAgICAgICAgY29uc3VtZV9zb2NrZXQoc29jaykKCiAgICAgICAgICAgICMgQ2xvc2UgdGhlIGNvbm5lY3Rpb24sIHdpdGhvdXQgc2VuZGluZyBhbnkgcmVzcG9uc2UgKG5vdCBldmVuIHRoZQogICAgICAgICAgICAjIEhUVFAgc3RhdHVzIGxpbmUpLiBUaGlzIHdpbGwgdHJpZ2dlciBhIGBUaW1lb3V0YCBvbiB0aGUgY2xpZW50LAogICAgICAgICAgICAjIGluc2lkZSBgdXJsb3BlbigpYC4KICAgICAgICAgICAgc29jay5jbG9zZSgpCgogICAgICAgICAgICAjIEV4cGVjdCBhIG5ldyByZXF1ZXN0LiBCZWNhdXNlIHdlIGRvbid0IHdhbnQgdG8gaGFuZyB0aGlzIHRocmVhZCwKICAgICAgICAgICAgIyB3ZSBhY3R1YWxseSB1c2Ugc2VsZWN0LnNlbGVjdCB0byBjb25maXJtIHRoYXQgYSBuZXcgcmVxdWVzdCBpcwogICAgICAgICAgICAjIGNvbWluZyBpbjogdGhpcyBsZXRzIHVzIHRpbWUgdGhlIHRocmVhZCBvdXQuCiAgICAgICAgICAgIHJsaXN0LCBfLCBfID0gc2VsZWN0LnNlbGVjdChbbGlzdGVuZXJdLCBbXSwgW10sIDUpCiAgICAgICAgICAgIGFzc2VydCBybGlzdAogICAgICAgICAgICBzb2NrID0gbGlzdGVuZXIuYWNjZXB0KClbMF0KICAgICAgICAgICAgY29uc3VtZV9zb2NrZXQoc29jaykKCiAgICAgICAgICAgICMgU2VuZCBjb21wbGV0ZSBjaHVua2VkIHJlc3BvbnNlLgogICAgICAgICAgICBzb2NrLnNlbmQoKAogICAgICAgICAgICAgICAgJ0hUVFAvMS4xIDIwMCBPS1xyXG4nCiAgICAgICAgICAgICAgICAnQ29udGVudC1UeXBlOiB0ZXh0L3BsYWluXHJcbicKICAgICAgICAgICAgICAgICdUcmFuc2Zlci1FbmNvZGluZzogY2h1bmtlZFxyXG4nCiAgICAgICAgICAgICAgICAnXHJcbicKICAgICAgICAgICAgICAgICc4XHJcbicKICAgICAgICAgICAgICAgICcxMjM0NTY3OFxyXG4nCiAgICAgICAgICAgICAgICAnMFxyXG5cclxuJykuZW5jb2RlKCd1dGYtOCcpCiAgICAgICAgICAgICkKCiAgICAgICAgICAgIHNvY2suY2xvc2UoKQoKICAgICAgICBzZWxmLl9zdGFydF9zZXJ2ZXIoc29ja2V0X2hhbmRsZXIpCiAgICAgICAgd2l0aCBIVFRQQ29ubmVjdGlvblBvb2woc2VsZi5ob3N0LCBzZWxmLnBvcnQsIG1heHNpemU9MSkgYXMgcG9vbDoKICAgICAgICAgICAgIyBGaXJzdCByZXF1ZXN0IHNob3VsZCBmYWlsLCBidXQgdGhlIHRpbWVvdXQgYW5kIGByZXRyaWVzPTFgIHNob3VsZAogICAgICAgICAgICAjIHNhdmUgaXQuCiAgICAgICAgICAgIHJlc3BvbnNlID0gcG9vbC51cmxvcGVuKCdHRVQnLCAnLycsIHJldHJpZXM9MSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVsZWFzZV9jb25uPUZhbHNlLCBwcmVsb2FkX2NvbnRlbnQ9RmFsc2UsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVvdXQ9VGltZW91dChjb25uZWN0PTEsIHJlYWQ9MC4wMDEpKQoKICAgICAgICAgICAgIyBUaGUgY29ubmVjdGlvbiBzaG91bGQgc3RpbGwgYmUgb24gdGhlIHJlc3BvbnNlIG9iamVjdCwgYW5kIG5vbmUKICAgICAgICAgICAgIyBzaG91bGQgYmUgaW4gdGhlIHBvb2wuIFdlIG9wZW5lZCB0d28gdGhvdWdoLgogICAgICAgICAgICBzZWxmLmFzc2VydEVxdWFsKHBvb2wubnVtX2Nvbm5lY3Rpb25zLCAyKQogICAgICAgICAgICBzZWxmLmFzc2VydEVxdWFsKHBvb2wucG9vbC5xc2l6ZSgpLCAwKQogICAgICAgICAgICBzZWxmLmFzc2VydFRydWUocmVzcG9uc2UuY29ubmVjdGlvbiBpcyBub3QgTm9uZSkKCiAgICAgICAgICAgICMgQ29uc3VtZSB0aGUgZGF0YS4gVGhpcyBzaG91bGQgcHV0IHRoZSBjb25uZWN0aW9uIGJhY2suCiAgICAgICAgICAgIHJlc3BvbnNlLnJlYWQoKQogICAgICAgICAgICBzZWxmLmFzc2VydEVxdWFsKHBvb2wucG9vbC5xc2l6ZSgpLCAxKQogICAgICAgICAgICBzZWxmLmFzc2VydFRydWUocmVzcG9uc2UuY29ubmVjdGlvbiBpcyBOb25lKQoKCmNsYXNzIFRlc3RQcm94eU1hbmFnZXIoU29ja2V0RHVtbXlTZXJ2ZXJUZXN0Q2FzZSk6CgogICAgZGVmIHRlc3Rfc2ltcGxlKHNlbGYpOgogICAgICAgIGRlZiBlY2hvX3NvY2tldF9oYW5kbGVyKGxpc3RlbmVyKToKICAgICAgICAgICAgc29jayA9IGxpc3RlbmVyLmFjY2VwdCgpWzBdCgogICAgICAgICAgICBidWYgPSBiJycKICAgICAgICAgICAgd2hpbGUgbm90IGJ1Zi5lbmRzd2l0aChiJ1xyXG5cclxuJyk6CiAgICAgICAgICAgICAgICBidWYgKz0gc29jay5yZWN2KDY1NTM2KQoKICAgICAgICAgICAgc29jay5zZW5kKCgnSFRUUC8xLjEgMjAwIE9LXHJcbicKICAgICAgICAgICAgICAgICAgICAgICAnQ29udGVudC1UeXBlOiB0ZXh0L3BsYWluXHJcbicKICAgICAgICAgICAgICAgICAgICAgICAnQ29udGVudC1MZW5ndGg6ICVkXHJcbicKICAgICAgICAgICAgICAgICAgICAgICAnXHJcbicKICAgICAgICAgICAgICAgICAgICAgICAnJXMnICUgKGxlbihidWYpLCBidWYuZGVjb2RlKCd1dGYtOCcpKSkuZW5jb2RlKCd1dGYtOCcpKQogICAgICAgICAgICBzb2NrLmNsb3NlKCkKCiAgICAgICAgc2VsZi5fc3RhcnRfc2VydmVyKGVjaG9fc29ja2V0X2hhbmRsZXIpCiAgICAgICAgYmFzZV91cmwgPSAnaHR0cDovLyVzOiVkJyAlIChzZWxmLmhvc3QsIHNlbGYucG9ydCkKICAgICAgICBwcm94eSA9IHByb3h5X2Zyb21fdXJsKGJhc2VfdXJsKQogICAgICAgIHNlbGYuYWRkQ2xlYW51cChwcm94eS5jbGVhcikKCiAgICAgICAgciA9IHByb3h5LnJlcXVlc3QoJ0dFVCcsICdodHRwOi8vZ29vZ2xlLmNvbS8nKQoKICAgICAgICBzZWxmLmFzc2VydEVxdWFsKHIuc3RhdHVzLCAyMDApCiAgICAgICAgIyBGSVhNRTogVGhlIG9yZGVyIG9mIHRoZSBoZWFkZXJzIGlzIG5vdCBwcmVkaWN0YWJsZSByaWdodCBub3cuIFdlCiAgICAgICAgIyBzaG91bGQgZml4IHRoYXQgc29tZWRheSAobWF5YmUgd2hlbiB3ZSBtaWdyYXRlIHRvCiAgICAgICAgIyBPcmRlcmVkRGljdC9NdWx0aURpY3QpLgogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoc29ydGVkKHIuZGF0YS5zcGxpdChiJ1xyXG4nKSksCiAgICAgICAgICAgICAgICAgICAgICAgICBzb3J0ZWQoWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgIGInR0VUIGh0dHA6Ly9nb29nbGUuY29tLyBIVFRQLzEuMScsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYidIb3N0OiBnb29nbGUuY29tJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiJ0FjY2VwdC1FbmNvZGluZzogaWRlbnRpdHknLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIGInQWNjZXB0OiAqLyonLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIGInJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiJycsCiAgICAgICAgICAgICAgICAgICAgICAgICBdKSkKCiAgICBkZWYgdGVzdF9oZWFkZXJzKHNlbGYpOgogICAgICAgIGRlZiBlY2hvX3NvY2tldF9oYW5kbGVyKGxpc3RlbmVyKToKICAgICAgICAgICAgc29jayA9IGxpc3RlbmVyLmFjY2VwdCgpWzBdCgogICAgICAgICAgICBidWYgPSBiJycKICAgICAgICAgICAgd2hpbGUgbm90IGJ1Zi5lbmRzd2l0aChiJ1xyXG5cclxuJyk6CiAgICAgICAgICAgICAgICBidWYgKz0gc29jay5yZWN2KDY1NTM2KQoKICAgICAgICAgICAgc29jay5zZW5kKCgnSFRUUC8xLjEgMjAwIE9LXHJcbicKICAgICAgICAgICAgICAgICAgICAgICAnQ29udGVudC1UeXBlOiB0ZXh0L3BsYWluXHJcbicKICAgICAgICAgICAgICAgICAgICAgICAnQ29udGVudC1MZW5ndGg6ICVkXHJcbicKICAgICAgICAgICAgICAgICAgICAgICAnXHJcbicKICAgICAgICAgICAgICAgICAgICAgICAnJXMnICUgKGxlbihidWYpLCBidWYuZGVjb2RlKCd1dGYtOCcpKSkuZW5jb2RlKCd1dGYtOCcpKQogICAgICAgICAgICBzb2NrLmNsb3NlKCkKCiAgICAgICAgc2VsZi5fc3RhcnRfc2VydmVyKGVjaG9fc29ja2V0X2hhbmRsZXIpCiAgICAgICAgYmFzZV91cmwgPSAnaHR0cDovLyVzOiVkJyAlIChzZWxmLmhvc3QsIHNlbGYucG9ydCkKCiAgICAgICAgIyBEZWZpbmUgc29tZSBwcm94eSBoZWFkZXJzLgogICAgICAgIHByb3h5X2hlYWRlcnMgPSBIVFRQSGVhZGVyRGljdCh7J0ZvciBUaGUgUHJveHknOiAnWUVBSCEnfSkKICAgICAgICBwcm94eSA9IHByb3h5X2Zyb21fdXJsKGJhc2VfdXJsLCBwcm94eV9oZWFkZXJzPXByb3h5X2hlYWRlcnMpCiAgICAgICAgc2VsZi5hZGRDbGVhbnVwKHByb3h5LmNsZWFyKQoKICAgICAgICBjb25uID0gcHJveHkuY29ubmVjdGlvbl9mcm9tX3VybCgnaHR0cDovL3d3dy5nb29nbGUuY29tLycpCgogICAgICAgIHIgPSBjb25uLnVybG9wZW4oJ0dFVCcsICdodHRwOi8vd3d3Lmdvb2dsZS5jb20vJywgYXNzZXJ0X3NhbWVfaG9zdD1GYWxzZSkKCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChyLnN0YXR1cywgMjAwKQogICAgICAgICMgRklYTUU6IFRoZSBvcmRlciBvZiB0aGUgaGVhZGVycyBpcyBub3QgcHJlZGljdGFibGUgcmlnaHQgbm93LiBXZQogICAgICAgICMgc2hvdWxkIGZpeCB0aGF0IHNvbWVkYXkgKG1heWJlIHdoZW4gd2UgbWlncmF0ZSB0bwogICAgICAgICMgT3JkZXJlZERpY3QvTXVsdGlEaWN0KS4KICAgICAgICBzZWxmLmFzc2VydFRydWUoYidGb3IgVGhlIFByb3h5OiBZRUFIIVxyXG4nIGluIHIuZGF0YSkKCiAgICBkZWYgdGVzdF9yZXRyaWVzKHNlbGYpOgogICAgICAgIGNsb3NlX2V2ZW50ID0gRXZlbnQoKQoKICAgICAgICBkZWYgZWNob19zb2NrZXRfaGFuZGxlcihsaXN0ZW5lcik6CiAgICAgICAgICAgIHNvY2sgPSBsaXN0ZW5lci5hY2NlcHQoKVswXQogICAgICAgICAgICAjIEZpcnN0IHJlcXVlc3QsIHdoaWNoIHNob3VsZCBmYWlsCiAgICAgICAgICAgIHNvY2suY2xvc2UoKQoKICAgICAgICAgICAgIyBTZWNvbmQgcmVxdWVzdAogICAgICAgICAgICBzb2NrID0gbGlzdGVuZXIuYWNjZXB0KClbMF0KCiAgICAgICAgICAgIGJ1ZiA9IGInJwogICAgICAgICAgICB3aGlsZSBub3QgYnVmLmVuZHN3aXRoKGInXHJcblxyXG4nKToKICAgICAgICAgICAgICAgIGJ1ZiArPSBzb2NrLnJlY3YoNjU1MzYpCgogICAgICAgICAgICBzb2NrLnNlbmQoKCdIVFRQLzEuMSAyMDAgT0tcclxuJwogICAgICAgICAgICAgICAgICAgICAgICdDb250ZW50LVR5cGU6IHRleHQvcGxhaW5cclxuJwogICAgICAgICAgICAgICAgICAgICAgICdDb250ZW50LUxlbmd0aDogJWRcclxuJwogICAgICAgICAgICAgICAgICAgICAgICdcclxuJwogICAgICAgICAgICAgICAgICAgICAgICclcycgJSAobGVuKGJ1ZiksIGJ1Zi5kZWNvZGUoJ3V0Zi04JykpKS5lbmNvZGUoJ3V0Zi04JykpCiAgICAgICAgICAgIHNvY2suY2xvc2UoKQogICAgICAgICAgICBjbG9zZV9ldmVudC5zZXQoKQoKICAgICAgICBzZWxmLl9zdGFydF9zZXJ2ZXIoZWNob19zb2NrZXRfaGFuZGxlcikKICAgICAgICBiYXNlX3VybCA9ICdodHRwOi8vJXM6JWQnICUgKHNlbGYuaG9zdCwgc2VsZi5wb3J0KQoKICAgICAgICBwcm94eSA9IHByb3h5X2Zyb21fdXJsKGJhc2VfdXJsKQogICAgICAgIHNlbGYuYWRkQ2xlYW51cChwcm94eS5jbGVhcikKICAgICAgICBjb25uID0gcHJveHkuY29ubmVjdGlvbl9mcm9tX3VybCgnaHR0cDovL3d3dy5nb29nbGUuY29tJykKCiAgICAgICAgciA9IGNvbm4udXJsb3BlbignR0VUJywgJ2h0dHA6Ly93d3cuZ29vZ2xlLmNvbScsCiAgICAgICAgICAgICAgICAgICAgICAgICBhc3NlcnRfc2FtZV9ob3N0PUZhbHNlLCByZXRyaWVzPTEpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChyLnN0YXR1cywgMjAwKQoKICAgICAgICBjbG9zZV9ldmVudC53YWl0KHRpbWVvdXQ9MSkKICAgICAgICBzZWxmLmFzc2VydFJhaXNlcyhQcm94eUVycm9yLCBjb25uLnVybG9wZW4sICdHRVQnLAogICAgICAgICAgICAgICAgICAgICAgICAgICdodHRwOi8vd3d3Lmdvb2dsZS5jb20nLAogICAgICAgICAgICAgICAgICAgICAgICAgIGFzc2VydF9zYW1lX2hvc3Q9RmFsc2UsIHJldHJpZXM9RmFsc2UpCgogICAgZGVmIHRlc3RfY29ubmVjdF9yZWNvbm4oc2VsZik6CiAgICAgICAgZGVmIHByb3h5X3NzbF9vbmUobGlzdGVuZXIpOgogICAgICAgICAgICBzb2NrID0gbGlzdGVuZXIuYWNjZXB0KClbMF0KCiAgICAgICAgICAgIGJ1ZiA9IGInJwogICAgICAgICAgICB3aGlsZSBub3QgYnVmLmVuZHN3aXRoKGInXHJcblxyXG4nKToKICAgICAgICAgICAgICAgIGJ1ZiArPSBzb2NrLnJlY3YoNjU1MzYpCiAgICAgICAgICAgIHMgPSBidWYuZGVjb2RlKCd1dGYtOCcpCiAgICAgICAgICAgIGlmIG5vdCBzLnN0YXJ0c3dpdGgoJ0NPTk5FQ1QgJyk6CiAgICAgICAgICAgICAgICBzb2NrLnNlbmQoKCdIVFRQLzEuMSA0MDUgTWV0aG9kIG5vdCBhbGxvd2VkXHJcbicKICAgICAgICAgICAgICAgICAgICAgICAgICAgJ0FsbG93OiBDT05ORUNUXHJcblxyXG4nKS5lbmNvZGUoJ3V0Zi04JykpCiAgICAgICAgICAgICAgICBzb2NrLmNsb3NlKCkKICAgICAgICAgICAgICAgIHJldHVybgoKICAgICAgICAgICAgaWYgbm90IHMuc3RhcnRzd2l0aCgnQ09OTkVDVCAlczo0NDMnICUgKHNlbGYuaG9zdCwpKToKICAgICAgICAgICAgICAgIHNvY2suc2VuZCgoJ0hUVFAvMS4xIDQwMyBGb3JiaWRkZW5cclxuXHJcbicpLmVuY29kZSgndXRmLTgnKSkKICAgICAgICAgICAgICAgIHNvY2suY2xvc2UoKQogICAgICAgICAgICAgICAgcmV0dXJuCgogICAgICAgICAgICBzb2NrLnNlbmQoKCdIVFRQLzEuMSAyMDAgQ29ubmVjdGlvbiBFc3RhYmxpc2hlZFxyXG5cclxuJykuZW5jb2RlKCd1dGYtOCcpKQogICAgICAgICAgICBzc2xfc29jayA9IHNzbC53cmFwX3NvY2tldChzb2NrLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXJ2ZXJfc2lkZT1UcnVlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBrZXlmaWxlPURFRkFVTFRfQ0VSVFNbJ2tleWZpbGUnXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2VydGZpbGU9REVGQVVMVF9DRVJUU1snY2VydGZpbGUnXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FfY2VydHM9REVGQVVMVF9DQSkKCiAgICAgICAgICAgIGJ1ZiA9IGInJwogICAgICAgICAgICB3aGlsZSBub3QgYnVmLmVuZHN3aXRoKGInXHJcblxyXG4nKToKICAgICAgICAgICAgICAgIGJ1ZiArPSBzc2xfc29jay5yZWN2KDY1NTM2KQoKICAgICAgICAgICAgc3NsX3NvY2suc2VuZCgoJ0hUVFAvMS4xIDIwMCBPS1xyXG4nCiAgICAgICAgICAgICAgICAgICAgICAgICAgICdDb250ZW50LVR5cGU6IHRleHQvcGxhaW5cclxuJwogICAgICAgICAgICAgICAgICAgICAgICAgICAnQ29udGVudC1MZW5ndGg6IDJcclxuJwogICAgICAgICAgICAgICAgICAgICAgICAgICAnQ29ubmVjdGlvbjogY2xvc2VcclxuJwogICAgICAgICAgICAgICAgICAgICAgICAgICAnXHJcbicKICAgICAgICAgICAgICAgICAgICAgICAgICAgJ0hpJykuZW5jb2RlKCd1dGYtOCcpKQogICAgICAgICAgICBzc2xfc29jay5jbG9zZSgpCgogICAgICAgIGRlZiBlY2hvX3NvY2tldF9oYW5kbGVyKGxpc3RlbmVyKToKICAgICAgICAgICAgcHJveHlfc3NsX29uZShsaXN0ZW5lcikKICAgICAgICAgICAgcHJveHlfc3NsX29uZShsaXN0ZW5lcikKCiAgICAgICAgc2VsZi5fc3RhcnRfc2VydmVyKGVjaG9fc29ja2V0X2hhbmRsZXIpCiAgICAgICAgYmFzZV91cmwgPSAnaHR0cDovLyVzOiVkJyAlIChzZWxmLmhvc3QsIHNlbGYucG9ydCkKCiAgICAgICAgcHJveHkgPSBwcm94eV9mcm9tX3VybChiYXNlX3VybCkKICAgICAgICBzZWxmLmFkZENsZWFudXAocHJveHkuY2xlYXIpCgogICAgICAgIHVybCA9ICdodHRwczovL3swfScuZm9ybWF0KHNlbGYuaG9zdCkKICAgICAgICBjb25uID0gcHJveHkuY29ubmVjdGlvbl9mcm9tX3VybCh1cmwpCiAgICAgICAgciA9IGNvbm4udXJsb3BlbignR0VUJywgdXJsLCByZXRyaWVzPTApCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChyLnN0YXR1cywgMjAwKQogICAgICAgIHIgPSBjb25uLnVybG9wZW4oJ0dFVCcsIHVybCwgcmV0cmllcz0wKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoci5zdGF0dXMsIDIwMCkKCgpjbGFzcyBUZXN0U1NMKFNvY2tldER1bW15U2VydmVyVGVzdENhc2UpOgoKICAgIGRlZiB0ZXN0X3NzbF9mYWlsdXJlX21pZHdheV90aHJvdWdoX2Nvbm4oc2VsZik6CiAgICAgICAgZGVmIHNvY2tldF9oYW5kbGVyKGxpc3RlbmVyKToKICAgICAgICAgICAgc29jayA9IGxpc3RlbmVyLmFjY2VwdCgpWzBdCiAgICAgICAgICAgIHNvY2syID0gc29jay5kdXAoKQogICAgICAgICAgICBzc2xfc29jayA9IHNzbC53cmFwX3NvY2tldChzb2NrLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXJ2ZXJfc2lkZT1UcnVlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBrZXlmaWxlPURFRkFVTFRfQ0VSVFNbJ2tleWZpbGUnXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2VydGZpbGU9REVGQVVMVF9DRVJUU1snY2VydGZpbGUnXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FfY2VydHM9REVGQVVMVF9DQSkKCiAgICAgICAgICAgIGJ1ZiA9IGInJwogICAgICAgICAgICB3aGlsZSBub3QgYnVmLmVuZHN3aXRoKGInXHJcblxyXG4nKToKICAgICAgICAgICAgICAgIGJ1ZiArPSBzc2xfc29jay5yZWN2KDY1NTM2KQoKICAgICAgICAgICAgIyBEZWxpYmVyYXRlbHkgc2VuZCBmcm9tIHRoZSBub24tU1NMIHNvY2tldC4KICAgICAgICAgICAgc29jazIuc2VuZCgoCiAgICAgICAgICAgICAgICAnSFRUUC8xLjEgMjAwIE9LXHJcbicKICAgICAgICAgICAgICAgICdDb250ZW50LVR5cGU6IHRleHQvcGxhaW5cclxuJwogICAgICAgICAgICAgICAgJ0NvbnRlbnQtTGVuZ3RoOiAyXHJcbicKICAgICAgICAgICAgICAgICdcclxuJwogICAgICAgICAgICAgICAgJ0hpJykuZW5jb2RlKCd1dGYtOCcpKQogICAgICAgICAgICBzb2NrMi5jbG9zZSgpCiAgICAgICAgICAgIHNzbF9zb2NrLmNsb3NlKCkKCiAgICAgICAgc2VsZi5fc3RhcnRfc2VydmVyKHNvY2tldF9oYW5kbGVyKQogICAgICAgIHBvb2wgPSBIVFRQU0Nvbm5lY3Rpb25Qb29sKHNlbGYuaG9zdCwgc2VsZi5wb3J0KQogICAgICAgIHNlbGYuYWRkQ2xlYW51cChwb29sLmNsb3NlKQoKICAgICAgICBzZWxmLmFzc2VydFJhaXNlcyhTU0xFcnJvciwgcG9vbC5yZXF1ZXN0LCAnR0VUJywgJy8nLCByZXRyaWVzPTApCgogICAgZGVmIHRlc3Rfc3NsX3JlYWRfdGltZW91dChzZWxmKToKICAgICAgICB0aW1lZF9vdXQgPSBFdmVudCgpCgogICAgICAgIGRlZiBzb2NrZXRfaGFuZGxlcihsaXN0ZW5lcik6CiAgICAgICAgICAgIHNvY2sgPSBsaXN0ZW5lci5hY2NlcHQoKVswXQogICAgICAgICAgICBzc2xfc29jayA9IHNzbC53cmFwX3NvY2tldChzb2NrLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXJ2ZXJfc2lkZT1UcnVlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBrZXlmaWxlPURFRkFVTFRfQ0VSVFNbJ2tleWZpbGUnXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2VydGZpbGU9REVGQVVMVF9DRVJUU1snY2VydGZpbGUnXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FfY2VydHM9REVGQVVMVF9DQSkKCiAgICAgICAgICAgIGJ1ZiA9IGInJwogICAgICAgICAgICB3aGlsZSBub3QgYnVmLmVuZHN3aXRoKGInXHJcblxyXG4nKToKICAgICAgICAgICAgICAgIGJ1ZiArPSBzc2xfc29jay5yZWN2KDY1NTM2KQoKICAgICAgICAgICAgIyBTZW5kIGluY29tcGxldGUgbWVzc2FnZSAobm90ZSBDb250ZW50LUxlbmd0aCkKICAgICAgICAgICAgc3NsX3NvY2suc2VuZCgoCiAgICAgICAgICAgICAgICAnSFRUUC8xLjEgMjAwIE9LXHJcbicKICAgICAgICAgICAgICAgICdDb250ZW50LVR5cGU6IHRleHQvcGxhaW5cclxuJwogICAgICAgICAgICAgICAgJ0NvbnRlbnQtTGVuZ3RoOiAxMFxyXG4nCiAgICAgICAgICAgICAgICAnXHJcbicKICAgICAgICAgICAgICAgICdIaS0nKS5lbmNvZGUoJ3V0Zi04JykpCiAgICAgICAgICAgIHRpbWVkX291dC53YWl0KCkKCiAgICAgICAgICAgIHNvY2suY2xvc2UoKQogICAgICAgICAgICBzc2xfc29jay5jbG9zZSgpCgogICAgICAgIHNlbGYuX3N0YXJ0X3NlcnZlcihzb2NrZXRfaGFuZGxlcikKICAgICAgICBwb29sID0gSFRUUFNDb25uZWN0aW9uUG9vbChzZWxmLmhvc3QsIHNlbGYucG9ydCkKICAgICAgICBzZWxmLmFkZENsZWFudXAocG9vbC5jbG9zZSkKCiAgICAgICAgcmVzcG9uc2UgPSBwb29sLnVybG9wZW4oJ0dFVCcsICcvJywgcmV0cmllcz0wLCBwcmVsb2FkX2NvbnRlbnQ9RmFsc2UsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGltZW91dD1UaW1lb3V0KGNvbm5lY3Q9MSwgcmVhZD0wLjAwMSkpCiAgICAgICAgdHJ5OgogICAgICAgICAgICBzZWxmLmFzc2VydFJhaXNlcyhSZWFkVGltZW91dEVycm9yLCByZXNwb25zZS5yZWFkKQogICAgICAgIGZpbmFsbHk6CiAgICAgICAgICAgIHRpbWVkX291dC5zZXQoKQoKICAgIGRlZiB0ZXN0X3NzbF9mYWlsZWRfZmluZ2VycHJpbnRfdmVyaWZpY2F0aW9uKHNlbGYpOgogICAgICAgIGRlZiBzb2NrZXRfaGFuZGxlcihsaXN0ZW5lcik6CiAgICAgICAgICAgIGZvciBpIGluIHJhbmdlKDIpOgogICAgICAgICAgICAgICAgc29jayA9IGxpc3RlbmVyLmFjY2VwdCgpWzBdCiAgICAgICAgICAgICAgICBzc2xfc29jayA9IHNzbC53cmFwX3NvY2tldChzb2NrLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VydmVyX3NpZGU9VHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtleWZpbGU9REVGQVVMVF9DRVJUU1sna2V5ZmlsZSddLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2VydGZpbGU9REVGQVVMVF9DRVJUU1snY2VydGZpbGUnXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhX2NlcnRzPURFRkFVTFRfQ0EpCgogICAgICAgICAgICAgICAgc3NsX3NvY2suc2VuZChiJ0hUVFAvMS4xIDIwMCBPS1xyXG4nCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGInQ29udGVudC1UeXBlOiB0ZXh0L3BsYWluXHJcbicKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYidDb250ZW50LUxlbmd0aDogNVxyXG5cclxuJwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiJ0hlbGxvJykKCiAgICAgICAgICAgICAgICBzc2xfc29jay5jbG9zZSgpCiAgICAgICAgICAgICAgICBzb2NrLmNsb3NlKCkKCiAgICAgICAgc2VsZi5fc3RhcnRfc2VydmVyKHNvY2tldF9oYW5kbGVyKQogICAgICAgICMgR2l0SHViJ3MgZmluZ2VycHJpbnQuIFZhbGlkLCBidXQgbm90IG1hdGNoaW5nLgogICAgICAgIGZpbmdlcnByaW50ID0gKCdBMDpDNDpBNzo0NjowMDpFRDpBNzoyRDpDMDpCRTpDQicKICAgICAgICAgICAgICAgICAgICAgICAnOjlBOjhDOkI2OjA3OkNBOjU4OkVFOjc0OjVFJykKCiAgICAgICAgZGVmIHJlcXVlc3QoKToKICAgICAgICAgICAgcG9vbCA9IEhUVFBTQ29ubmVjdGlvblBvb2woc2VsZi5ob3N0LCBzZWxmLnBvcnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFzc2VydF9maW5nZXJwcmludD1maW5nZXJwcmludCkKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgcmVzcG9uc2UgPSBwb29sLnVybG9wZW4oJ0dFVCcsICcvJywgcHJlbG9hZF9jb250ZW50PUZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGltZW91dD1UaW1lb3V0KGNvbm5lY3Q9MSwgcmVhZD0wLjAwMSkpCiAgICAgICAgICAgICAgICByZXNwb25zZS5yZWFkKCkKICAgICAgICAgICAgZmluYWxseToKICAgICAgICAgICAgICAgIHBvb2wuY2xvc2UoKQoKICAgICAgICBzZWxmLmFzc2VydFJhaXNlcyhTU0xFcnJvciwgcmVxdWVzdCkKICAgICAgICAjIFNob3VsZCBub3QgaGFuZywgc2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9zaGF6b3cvdXJsbGliMy9pc3N1ZXMvNTI5CiAgICAgICAgc2VsZi5hc3NlcnRSYWlzZXMoU1NMRXJyb3IsIHJlcXVlc3QpCgoKY2xhc3MgVGVzdEVycm9yV3JhcHBpbmcoU29ja2V0RHVtbXlTZXJ2ZXJUZXN0Q2FzZSk6CgogICAgZGVmIHRlc3RfYmFkX3N0YXR1c2xpbmUoc2VsZik6CiAgICAgICAgc2VsZi5zdGFydF9yZXNwb25zZV9oYW5kbGVyKAogICAgICAgICAgIGInSFRUUC8xLjEgT21nIFdoYXQgSXMgVGhpcz9cclxuJwogICAgICAgICAgIGInQ29udGVudC1MZW5ndGg6IDBcclxuJwogICAgICAgICAgIGInXHJcbicKICAgICAgICApCiAgICAgICAgcG9vbCA9IEhUVFBDb25uZWN0aW9uUG9vbChzZWxmLmhvc3QsIHNlbGYucG9ydCwgcmV0cmllcz1GYWxzZSkKICAgICAgICBzZWxmLmFkZENsZWFudXAocG9vbC5jbG9zZSkKICAgICAgICBzZWxmLmFzc2VydFJhaXNlcyhQcm90b2NvbEVycm9yLCBwb29sLnJlcXVlc3QsICdHRVQnLCAnLycpCgogICAgZGVmIHRlc3RfdW5rbm93bl9wcm90b2NvbChzZWxmKToKICAgICAgICBzZWxmLnN0YXJ0X3Jlc3BvbnNlX2hhbmRsZXIoCiAgICAgICAgICAgYidIVFRQLzEwMDAgMjAwIE9LXHJcbicKICAgICAgICAgICBiJ0NvbnRlbnQtTGVuZ3RoOiAwXHJcbicKICAgICAgICAgICBiJ1xyXG4nCiAgICAgICAgKQogICAgICAgIHBvb2wgPSBIVFRQQ29ubmVjdGlvblBvb2woc2VsZi5ob3N0LCBzZWxmLnBvcnQsIHJldHJpZXM9RmFsc2UpCiAgICAgICAgc2VsZi5hZGRDbGVhbnVwKHBvb2wuY2xvc2UpCiAgICAgICAgc2VsZi5hc3NlcnRSYWlzZXMoUHJvdG9jb2xFcnJvciwgcG9vbC5yZXF1ZXN0LCAnR0VUJywgJy8nKQoKCmNsYXNzIFRlc3RIZWFkZXJzKFNvY2tldER1bW15U2VydmVyVGVzdENhc2UpOgogICAgQG9ubHlQeTMKICAgIGRlZiB0ZXN0X2h0dHBsaWJfaGVhZGVyc19jYXNlX2luc2Vuc2l0aXZlKHNlbGYpOgogICAgICAgIHNlbGYuc3RhcnRfcmVzcG9uc2VfaGFuZGxlcigKICAgICAgICAgICBiJ0hUVFAvMS4xIDIwMCBPS1xyXG4nCiAgICAgICAgICAgYidDb250ZW50LUxlbmd0aDogMFxyXG4nCiAgICAgICAgICAgYidDb250ZW50LXR5cGU6IHRleHQvcGxhaW5cclxuJwogICAgICAgICAgIGInXHJcbicKICAgICAgICApCiAgICAgICAgcG9vbCA9IEhUVFBDb25uZWN0aW9uUG9vbChzZWxmLmhvc3QsIHNlbGYucG9ydCwgcmV0cmllcz1GYWxzZSkKICAgICAgICBzZWxmLmFkZENsZWFudXAocG9vbC5jbG9zZSkKICAgICAgICBIRUFERVJTID0geydDb250ZW50LUxlbmd0aCc6ICcwJywgJ0NvbnRlbnQtdHlwZSc6ICd0ZXh0L3BsYWluJ30KICAgICAgICByID0gcG9vbC5yZXF1ZXN0KCdHRVQnLCAnLycpCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChIRUFERVJTLCBkaWN0KHIuaGVhZGVycy5pdGVtcygpKSkgICMgdG8gcHJlc2VydmUgY2FzZSBzZW5zaXRpdml0eQoKICAgIGRlZiB0ZXN0X2hlYWRlcnNfYXJlX3NlbnRfd2l0aF90aGVfb3JpZ2luYWxfY2FzZShzZWxmKToKICAgICAgICBoZWFkZXJzID0geydmb28nOiAnYmFyJywgJ2JBeic6ICdxdXV4J30KICAgICAgICBwYXJzZWRfaGVhZGVycyA9IHt9CgogICAgICAgIGRlZiBzb2NrZXRfaGFuZGxlcihsaXN0ZW5lcik6CiAgICAgICAgICAgIHNvY2sgPSBsaXN0ZW5lci5hY2NlcHQoKVswXQoKICAgICAgICAgICAgYnVmID0gYicnCiAgICAgICAgICAgIHdoaWxlIG5vdCBidWYuZW5kc3dpdGgoYidcclxuXHJcbicpOgogICAgICAgICAgICAgICAgYnVmICs9IHNvY2sucmVjdig2NTUzNikKCiAgICAgICAgICAgIGhlYWRlcnNfbGlzdCA9IFtoZWFkZXIgZm9yIGhlYWRlciBpbiBidWYuc3BsaXQoYidcclxuJylbMTpdIGlmIGhlYWRlcl0KCiAgICAgICAgICAgIGZvciBoZWFkZXIgaW4gaGVhZGVyc19saXN0OgogICAgICAgICAgICAgICAgKGtleSwgdmFsdWUpID0gaGVhZGVyLnNwbGl0KGInOiAnKQogICAgICAgICAgICAgICAgcGFyc2VkX2hlYWRlcnNba2V5LmRlY29kZSgnYXNjaWknKV0gPSB2YWx1ZS5kZWNvZGUoJ2FzY2lpJykKCiAgICAgICAgICAgIHNvY2suc2VuZCgoCiAgICAgICAgICAgICAgICAnSFRUUC8xLjEgMjA0IE5vIENvbnRlbnRcclxuJwogICAgICAgICAgICAgICAgJ0NvbnRlbnQtTGVuZ3RoOiAwXHJcbicKICAgICAgICAgICAgICAgICdcclxuJykuZW5jb2RlKCd1dGYtOCcpKQoKICAgICAgICAgICAgc29jay5jbG9zZSgpCgogICAgICAgIHNlbGYuX3N0YXJ0X3NlcnZlcihzb2NrZXRfaGFuZGxlcikKICAgICAgICBleHBlY3RlZF9oZWFkZXJzID0geydBY2NlcHQtRW5jb2RpbmcnOiAnaWRlbnRpdHknLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ0hvc3QnOiAnezB9OnsxfScuZm9ybWF0KHNlbGYuaG9zdCwgc2VsZi5wb3J0KX0KICAgICAgICBleHBlY3RlZF9oZWFkZXJzLnVwZGF0ZShoZWFkZXJzKQoKICAgICAgICBwb29sID0gSFRUUENvbm5lY3Rpb25Qb29sKHNlbGYuaG9zdCwgc2VsZi5wb3J0LCByZXRyaWVzPUZhbHNlKQogICAgICAgIHNlbGYuYWRkQ2xlYW51cChwb29sLmNsb3NlKQogICAgICAgIHBvb2wucmVxdWVzdCgnR0VUJywgJy8nLCBoZWFkZXJzPUhUVFBIZWFkZXJEaWN0KGhlYWRlcnMpKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoZXhwZWN0ZWRfaGVhZGVycywgcGFyc2VkX2hlYWRlcnMpCgogICAgZGVmIHRlc3RfcmVxdWVzdF9oZWFkZXJzX2FyZV9zZW50X2luX3RoZV9vcmlnaW5hbF9vcmRlcihzZWxmKToKICAgICAgICAjIE5PVEU6IFByb2JhYmlsaXR5IHRoaXMgdGVzdCBnaXZlcyBhIGZhbHNlIG5lZ2F0aXZlIGlzIDEvKEshKQogICAgICAgIEsgPSAxNgogICAgICAgICMgTk9URTogUHJvdmlkZSBoZWFkZXJzIGluIG5vbi1zb3J0ZWQgb3JkZXIgKGkuZS4gcmV2ZXJzZWQpCiAgICAgICAgIyAgICAgICBzbyB0aGF0IGlmIHRoZSBpbnRlcm5hbCBpbXBsZW1lbnRhdGlvbiB0cmllcyB0byBzb3J0IHRoZW0sCiAgICAgICAgIyAgICAgICBhIGNoYW5nZSB3aWxsIGJlIGRldGVjdGVkLgogICAgICAgIGV4cGVjdGVkX3JlcXVlc3RfaGVhZGVycyA9IFsodSdYLUhlYWRlci0lZCcgJSBpLCBzdHIoaSkpIGZvciBpIGluIHJldmVyc2VkKHJhbmdlKEspKV0KCiAgICAgICAgYWN0dWFsX3JlcXVlc3RfaGVhZGVycyA9IFtdCgogICAgICAgIGRlZiBzb2NrZXRfaGFuZGxlcihsaXN0ZW5lcik6CiAgICAgICAgICAgIHNvY2sgPSBsaXN0ZW5lci5hY2NlcHQoKVswXQoKICAgICAgICAgICAgYnVmID0gYicnCiAgICAgICAgICAgIHdoaWxlIG5vdCBidWYuZW5kc3dpdGgoYidcclxuXHJcbicpOgogICAgICAgICAgICAgICAgYnVmICs9IHNvY2sucmVjdig2NTUzNikKCiAgICAgICAgICAgIGhlYWRlcnNfbGlzdCA9IFtoZWFkZXIgZm9yIGhlYWRlciBpbiBidWYuc3BsaXQoYidcclxuJylbMTpdIGlmIGhlYWRlcl0KCiAgICAgICAgICAgIGZvciBoZWFkZXIgaW4gaGVhZGVyc19saXN0OgogICAgICAgICAgICAgICAgKGtleSwgdmFsdWUpID0gaGVhZGVyLnNwbGl0KGInOiAnKQogICAgICAgICAgICAgICAgaWYgbm90IGtleS5kZWNvZGUoJ2FzY2lpJykuc3RhcnRzd2l0aCh1J1gtSGVhZGVyLScpOgogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICBhY3R1YWxfcmVxdWVzdF9oZWFkZXJzLmFwcGVuZCgoa2V5LmRlY29kZSgnYXNjaWknKSwgdmFsdWUuZGVjb2RlKCdhc2NpaScpKSkKCiAgICAgICAgICAgIHNvY2suc2VuZCgoCiAgICAgICAgICAgICAgICB1J0hUVFAvMS4xIDIwNCBObyBDb250ZW50XHJcbicKICAgICAgICAgICAgICAgIHUnQ29udGVudC1MZW5ndGg6IDBcclxuJwogICAgICAgICAgICAgICAgdSdcclxuJykuZW5jb2RlKCdhc2NpaScpKQoKICAgICAgICAgICAgc29jay5jbG9zZSgpCgogICAgICAgIHNlbGYuX3N0YXJ0X3NlcnZlcihzb2NrZXRfaGFuZGxlcikKCiAgICAgICAgcG9vbCA9IEhUVFBDb25uZWN0aW9uUG9vbChzZWxmLmhvc3QsIHNlbGYucG9ydCwgcmV0cmllcz1GYWxzZSkKICAgICAgICBzZWxmLmFkZENsZWFudXAocG9vbC5jbG9zZSkKICAgICAgICBwb29sLnJlcXVlc3QoJ0dFVCcsICcvJywgaGVhZGVycz1PcmRlcmVkRGljdChleHBlY3RlZF9yZXF1ZXN0X2hlYWRlcnMpKQogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoZXhwZWN0ZWRfcmVxdWVzdF9oZWFkZXJzLCBhY3R1YWxfcmVxdWVzdF9oZWFkZXJzKQoKICAgIGRlZiB0ZXN0X3Jlc3BvbnNlX2hlYWRlcnNfYXJlX3JldHVybmVkX2luX3RoZV9vcmlnaW5hbF9vcmRlcihzZWxmKToKICAgICAgICAjIE5PVEU6IFByb2JhYmlsaXR5IHRoaXMgdGVzdCBnaXZlcyBhIGZhbHNlIG5lZ2F0aXZlIGlzIDEvKEshKQogICAgICAgIEsgPSAxNgogICAgICAgICMgTk9URTogUHJvdmlkZSBoZWFkZXJzIGluIG5vbi1zb3J0ZWQgb3JkZXIgKGkuZS4gcmV2ZXJzZWQpCiAgICAgICAgIyAgICAgICBzbyB0aGF0IGlmIHRoZSBpbnRlcm5hbCBpbXBsZW1lbnRhdGlvbiB0cmllcyB0byBzb3J0IHRoZW0sCiAgICAgICAgIyAgICAgICBhIGNoYW5nZSB3aWxsIGJlIGRldGVjdGVkLgogICAgICAgIGV4cGVjdGVkX3Jlc3BvbnNlX2hlYWRlcnMgPSBbKCdYLUhlYWRlci0lZCcgJSBpLCBzdHIoaSkpIGZvciBpIGluIHJldmVyc2VkKHJhbmdlKEspKV0KCiAgICAgICAgZGVmIHNvY2tldF9oYW5kbGVyKGxpc3RlbmVyKToKICAgICAgICAgICAgc29jayA9IGxpc3RlbmVyLmFjY2VwdCgpWzBdCgogICAgICAgICAgICBidWYgPSBiJycKICAgICAgICAgICAgd2hpbGUgbm90IGJ1Zi5lbmRzd2l0aChiJ1xyXG5cclxuJyk6CiAgICAgICAgICAgICAgICBidWYgKz0gc29jay5yZWN2KDY1NTM2KQoKICAgICAgICAgICAgc29jay5zZW5kKGInSFRUUC8xLjEgMjAwIE9LXHJcbicgKwogICAgICAgICAgICAgICAgICAgICAgYidcclxuJy5qb2luKFsKICAgICAgICAgICAgICAgICAgICAgICAgICAoay5lbmNvZGUoJ3V0ZjgnKSArIGInOiAnICsgdi5lbmNvZGUoJ3V0ZjgnKSkKICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGssIHYpIGluIGV4cGVjdGVkX3Jlc3BvbnNlX2hlYWRlcnMKICAgICAgICAgICAgICAgICAgICAgIF0pICsKICAgICAgICAgICAgICAgICAgICAgIGInXHJcbicpCiAgICAgICAgICAgIHNvY2suY2xvc2UoKQoKICAgICAgICBzZWxmLl9zdGFydF9zZXJ2ZXIoc29ja2V0X2hhbmRsZXIpCiAgICAgICAgcG9vbCA9IEhUVFBDb25uZWN0aW9uUG9vbChzZWxmLmhvc3QsIHNlbGYucG9ydCkKICAgICAgICBzZWxmLmFkZENsZWFudXAocG9vbC5jbG9zZSkKICAgICAgICByID0gcG9vbC5yZXF1ZXN0KCdHRVQnLCAnLycsIHJldHJpZXM9MCkKICAgICAgICBhY3R1YWxfcmVzcG9uc2VfaGVhZGVycyA9IFsKICAgICAgICAgICAgKGssIHYpIGZvciAoaywgdikgaW4gci5oZWFkZXJzLml0ZW1zKCkKICAgICAgICAgICAgaWYgay5zdGFydHN3aXRoKCdYLUhlYWRlci0nKQogICAgICAgIF0KICAgICAgICBzZWxmLmFzc2VydEVxdWFsKGV4cGVjdGVkX3Jlc3BvbnNlX2hlYWRlcnMsIGFjdHVhbF9yZXNwb25zZV9oZWFkZXJzKQoKCmNsYXNzIFRlc3RCcm9rZW5IZWFkZXJzKFNvY2tldER1bW15U2VydmVyVGVzdENhc2UpOgogICAgZGVmIHNldFVwKHNlbGYpOgogICAgICAgIGlmIGlzc3ViY2xhc3MoaHR0cGxpYi5IVFRQTWVzc2FnZSwgTWltZVRvb2xNZXNzYWdlKToKICAgICAgICAgICAgcmFpc2UgU2tpcFRlc3QoJ0hlYWRlciBwYXJzaW5nIGVycm9ycyBub3QgYXZhaWxhYmxlJykKCiAgICAgICAgc3VwZXIoVGVzdEJyb2tlbkhlYWRlcnMsIHNlbGYpLnNldFVwKCkKCiAgICBkZWYgX3Rlc3RfYnJva2VuX2hlYWRlcl9wYXJzaW5nKHNlbGYsIGhlYWRlcnMpOgogICAgICAgIHNlbGYuc3RhcnRfcmVzcG9uc2VfaGFuZGxlcigoCiAgICAgICAgICAgYidIVFRQLzEuMSAyMDAgT0tcclxuJwogICAgICAgICAgIGInQ29udGVudC1MZW5ndGg6IDBcclxuJwogICAgICAgICAgIGInQ29udGVudC10eXBlOiB0ZXh0L3BsYWluXHJcbicKICAgICAgICAgICApICsgYidcclxuJy5qb2luKGhlYWRlcnMpICsgYidcclxuJwogICAgICAgICkKCiAgICAgICAgcG9vbCA9IEhUVFBDb25uZWN0aW9uUG9vbChzZWxmLmhvc3QsIHNlbGYucG9ydCwgcmV0cmllcz1GYWxzZSkKICAgICAgICBzZWxmLmFkZENsZWFudXAocG9vbC5jbG9zZSkKCiAgICAgICAgd2l0aCBMb2dSZWNvcmRlcigpIGFzIGxvZ3M6CiAgICAgICAgICAgIHBvb2wucmVxdWVzdCgnR0VUJywgJy8nKQoKICAgICAgICBmb3IgcmVjb3JkIGluIGxvZ3M6CiAgICAgICAgICAgIGlmICdGYWlsZWQgdG8gcGFyc2UgaGVhZGVycycgaW4gcmVjb3JkLm1zZyBhbmQgXAogICAgICAgICAgICAgICAgICAgIHBvb2wuX2Fic29sdXRlX3VybCgnLycpID09IHJlY29yZC5hcmdzWzBdOgogICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgc2VsZi5mYWlsKCdNaXNzaW5nIGxvZyBhYm91dCB1bnBhcnNlZCBoZWFkZXJzJykKCiAgICBkZWYgdGVzdF9oZWFkZXJfd2l0aG91dF9uYW1lKHNlbGYpOgogICAgICAgIHNlbGYuX3Rlc3RfYnJva2VuX2hlYWRlcl9wYXJzaW5nKFsKICAgICAgICAgICAgYic6IFZhbHVlXHJcbicsCiAgICAgICAgICAgIGInQW5vdGhlcjogSGVhZGVyXHJcbicsCiAgICAgICAgXSkKCiAgICBkZWYgdGVzdF9oZWFkZXJfd2l0aG91dF9uYW1lX29yX3ZhbHVlKHNlbGYpOgogICAgICAgIHNlbGYuX3Rlc3RfYnJva2VuX2hlYWRlcl9wYXJzaW5nKFsKICAgICAgICAgICAgYic6XHJcbicsCiAgICAgICAgICAgIGInQW5vdGhlcjogSGVhZGVyXHJcbicsCiAgICAgICAgXSkKCiAgICBkZWYgdGVzdF9oZWFkZXJfd2l0aG91dF9jb2xvbl9vcl92YWx1ZShzZWxmKToKICAgICAgICBzZWxmLl90ZXN0X2Jyb2tlbl9oZWFkZXJfcGFyc2luZyhbCiAgICAgICAgICAgIGInQnJva2VuIEhlYWRlcicsCiAgICAgICAgICAgIGInQW5vdGhlcjogSGVhZGVyJywKICAgICAgICBdKQoKCmNsYXNzIFRlc3RIRUFEKFNvY2tldER1bW15U2VydmVyVGVzdENhc2UpOgogICAgZGVmIHRlc3RfY2h1bmtlZF9oZWFkX3Jlc3BvbnNlX2RvZXNfbm90X2hhbmcoc2VsZik6CiAgICAgICAgc2VsZi5zdGFydF9yZXNwb25zZV9oYW5kbGVyKAogICAgICAgICAgIGInSFRUUC8xLjEgMjAwIE9LXHJcbicKICAgICAgICAgICBiJ1RyYW5zZmVyLUVuY29kaW5nOiBjaHVua2VkXHJcbicKICAgICAgICAgICBiJ0NvbnRlbnQtdHlwZTogdGV4dC9wbGFpblxyXG4nCiAgICAgICAgICAgYidcclxuJwogICAgICAgICkKICAgICAgICBwb29sID0gSFRUUENvbm5lY3Rpb25Qb29sKHNlbGYuaG9zdCwgc2VsZi5wb3J0LCByZXRyaWVzPUZhbHNlKQogICAgICAgIHNlbGYuYWRkQ2xlYW51cChwb29sLmNsb3NlKQogICAgICAgIHIgPSBwb29sLnJlcXVlc3QoJ0hFQUQnLCAnLycsIHRpbWVvdXQ9MSwgcHJlbG9hZF9jb250ZW50PUZhbHNlKQoKICAgICAgICAjIHN0cmVhbSB3aWxsIHVzZSB0aGUgcmVhZF9jaHVua2VkIG1ldGhvZCBoZXJlLgogICAgICAgIHNlbGYuYXNzZXJ0RXF1YWwoW10sIGxpc3Qoci5zdHJlYW0oKSkpCgogICAgZGVmIHRlc3RfZW1wdHlfaGVhZF9yZXNwb25zZV9kb2VzX25vdF9oYW5nKHNlbGYpOgogICAgICAgIHNlbGYuc3RhcnRfcmVzcG9uc2VfaGFuZGxlcigKICAgICAgICAgICBiJ0hUVFAvMS4xIDIwMCBPS1xyXG4nCiAgICAgICAgICAgYidDb250ZW50LUxlbmd0aDogMjU2XHJcbicKICAgICAgICAgICBiJ0NvbnRlbnQtdHlwZTogdGV4dC9wbGFpblxyXG4nCiAgICAgICAgICAgYidcclxuJwogICAgICAgICkKICAgICAgICBwb29sID0gSFRUUENvbm5lY3Rpb25Qb29sKHNlbGYuaG9zdCwgc2VsZi5wb3J0LCByZXRyaWVzPUZhbHNlKQogICAgICAgIHNlbGYuYWRkQ2xlYW51cChwb29sLmNsb3NlKQogICAgICAgIHIgPSBwb29sLnJlcXVlc3QoJ0hFQUQnLCAnLycsIHRpbWVvdXQ9MSwgcHJlbG9hZF9jb250ZW50PUZhbHNlKQoKICAgICAgICAjIHN0cmVhbSB3aWxsIHVzZSB0aGUgcmVhZCBtZXRob2QgaGVyZS4KICAgICAgICBzZWxmLmFzc2VydEVxdWFsKFtdLCBsaXN0KHIuc3RyZWFtKCkpKQoKCmNsYXNzIFRlc3RTdHJlYW0oU29ja2V0RHVtbXlTZXJ2ZXJUZXN0Q2FzZSk6CiAgICBkZWYgdGVzdF9zdHJlYW1fbm9uZV91bmNodW5rZWRfcmVzcG9uc2VfZG9lc19ub3RfaGFuZyhzZWxmKToKICAgICAgICBkb25lX2V2ZW50ID0gRXZlbnQoKQoKICAgICAgICBkZWYgc29ja2V0X2hhbmRsZXIobGlzdGVuZXIpOgogICAgICAgICAgICBzb2NrID0gbGlzdGVuZXIuYWNjZXB0KClbMF0KCiAgICAgICAgICAgIGJ1ZiA9IGInJwogICAgICAgICAgICB3aGlsZSBub3QgYnVmLmVuZHN3aXRoKGInXHJcblxyXG4nKToKICAgICAgICAgICAgICAgIGJ1ZiArPSBzb2NrLnJlY3YoNjU1MzYpCgogICAgICAgICAgICBzb2NrLnNlbmQoCiAgICAgICAgICAgICAgICBiJ0hUVFAvMS4xIDIwMCBPS1xyXG4nCiAgICAgICAgICAgICAgICBiJ0NvbnRlbnQtTGVuZ3RoOiAxMlxyXG4nCiAgICAgICAgICAgICAgICBiJ0NvbnRlbnQtdHlwZTogdGV4dC9wbGFpblxyXG4nCiAgICAgICAgICAgICAgICBiJ1xyXG4nCiAgICAgICAgICAgICAgICBiJ2hlbGxvLCB3b3JsZCcKICAgICAgICAgICAgKQogICAgICAgICAgICBkb25lX2V2ZW50LndhaXQoNSkKICAgICAgICAgICAgc29jay5jbG9zZSgpCgogICAgICAgIHNlbGYuX3N0YXJ0X3NlcnZlcihzb2NrZXRfaGFuZGxlcikKICAgICAgICBwb29sID0gSFRUUENvbm5lY3Rpb25Qb29sKHNlbGYuaG9zdCwgc2VsZi5wb3J0LCByZXRyaWVzPUZhbHNlKQogICAgICAgIHNlbGYuYWRkQ2xlYW51cChwb29sLmNsb3NlKQogICAgICAgIHIgPSBwb29sLnJlcXVlc3QoJ0dFVCcsICcvJywgdGltZW91dD0xLCBwcmVsb2FkX2NvbnRlbnQ9RmFsc2UpCgogICAgICAgICMgU3RyZWFtIHNob3VsZCByZWFkIHRvIHRoZSBlbmQuCiAgICAgICAgc2VsZi5hc3NlcnRFcXVhbChbYidoZWxsbywgd29ybGQnXSwgbGlzdChyLnN0cmVhbShOb25lKSkpCgogICAgICAgIGRvbmVfZXZlbnQuc2V0KCkKCgpjbGFzcyBUZXN0QmFkQ29udGVudExlbmd0aChTb2NrZXREdW1teVNlcnZlclRlc3RDYXNlKToKICAgIGRlZiB0ZXN0X2VuZm9yY2VfY29udGVudF9sZW5ndGhfZ2V0KHNlbGYpOgogICAgICAgIGRvbmVfZXZlbnQgPSBFdmVudCgpCgogICAgICAgIGRlZiBzb2NrZXRfaGFuZGxlcihsaXN0ZW5lcik6CiAgICAgICAgICAgIHNvY2sgPSBsaXN0ZW5lci5hY2NlcHQoKVswXQoKICAgICAgICAgICAgYnVmID0gYicnCiAgICAgICAgICAgIHdoaWxlIG5vdCBidWYuZW5kc3dpdGgoYidcclxuXHJcbicpOgogICAgICAgICAgICAgICAgYnVmICs9IHNvY2sucmVjdig2NTUzNikKCiAgICAgICAgICAgIHNvY2suc2VuZCgKICAgICAgICAgICAgICAgIGInSFRUUC8xLjEgMjAwIE9LXHJcbicKICAgICAgICAgICAgICAgIGInQ29udGVudC1MZW5ndGg6IDIyXHJcbicKICAgICAgICAgICAgICAgIGInQ29udGVudC10eXBlOiB0ZXh0L3BsYWluXHJcbicKICAgICAgICAgICAgICAgIGInXHJcbicKICAgICAgICAgICAgICAgIGInaGVsbG8sIHdvcmxkJwogICAgICAgICAgICApCiAgICAgICAgICAgIGRvbmVfZXZlbnQud2FpdCgxKQogICAgICAgICAgICBzb2NrLmNsb3NlKCkKCiAgICAgICAgc2VsZi5fc3RhcnRfc2VydmVyKHNvY2tldF9oYW5kbGVyKQogICAgICAgIGNvbm4gPSBIVFRQQ29ubmVjdGlvblBvb2woc2VsZi5ob3N0LCBzZWxmLnBvcnQsIG1heHNpemU9MSkKICAgICAgICBzZWxmLmFkZENsZWFudXAoY29ubi5jbG9zZSkKCiAgICAgICAgIyBUZXN0IHN0cmVhbSByZWFkIHdoZW4gY29udGVudCBsZW5ndGggbGVzcyB0aGFuIGhlYWRlcnMgY2xhaW0KICAgICAgICBnZXRfcmVzcG9uc2UgPSBjb25uLnJlcXVlc3QoJ0dFVCcsIHVybD0nLycsIHByZWxvYWRfY29udGVudD1GYWxzZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZW5mb3JjZV9jb250ZW50X2xlbmd0aD1UcnVlKQogICAgICAgIGRhdGEgPSBnZXRfcmVzcG9uc2Uuc3RyZWFtKDEwMCkKICAgICAgICAjIFJlYWQgImdvb2QiIGRhdGEgYmVmb3JlIHdlIHRyeSB0byByZWFkIGFnYWluLgogICAgICAgICMgVGhpcyB3b24ndCB0cmlnZ2VyIHRpbGwgZ2VuZXJhdG9yIGlzIGV4aGF1c3RlZC4KICAgICAgICBuZXh0KGRhdGEpCiAgICAgICAgdHJ5OgogICAgICAgICAgICBuZXh0KGRhdGEpCiAgICAgICAgICAgIHNlbGYuYXNzZXJ0RmFpbCgpCiAgICAgICAgZXhjZXB0IFByb3RvY29sRXJyb3IgYXMgZToKICAgICAgICAgICAgc2VsZi5hc3NlcnRUcnVlKCcxMiBieXRlcyByZWFkLCAxMCBtb3JlIGV4cGVjdGVkJyBpbiBzdHIoZSkpCgogICAgICAgIGRvbmVfZXZlbnQuc2V0KCkKCiAgICBkZWYgdGVzdF9lbmZvcmNlX2NvbnRlbnRfbGVuZ3RoX25vX2JvZHkoc2VsZik6CiAgICAgICAgZG9uZV9ldmVudCA9IEV2ZW50KCkKCiAgICAgICAgZGVmIHNvY2tldF9oYW5kbGVyKGxpc3RlbmVyKToKICAgICAgICAgICAgc29jayA9IGxpc3RlbmVyLmFjY2VwdCgpWzBdCgogICAgICAgICAgICBidWYgPSBiJycKICAgICAgICAgICAgd2hpbGUgbm90IGJ1Zi5lbmRzd2l0aChiJ1xyXG5cclxuJyk6CiAgICAgICAgICAgICAgICBidWYgKz0gc29jay5yZWN2KDY1NTM2KQoKICAgICAgICAgICAgc29jay5zZW5kKAogICAgICAgICAgICAgICAgYidIVFRQLzEuMSAyMDAgT0tcclxuJwogICAgICAgICAgICAgICAgYidDb250ZW50LUxlbmd0aDogMjJcclxuJwogICAgICAgICAgICAgICAgYidDb250ZW50LXR5cGU6IHRleHQvcGxhaW5cclxuJwogICAgICAgICAgICAgICAgYidcclxuJwogICAgICAgICAgICApCiAgICAgICAgICAgIGRvbmVfZXZlbnQud2FpdCgxKQogICAgICAgICAgICBzb2NrLmNsb3NlKCkKCiAgICAgICAgc2VsZi5fc3RhcnRfc2VydmVyKHNvY2tldF9oYW5kbGVyKQogICAgICAgIGNvbm4gPSBIVFRQQ29ubmVjdGlvblBvb2woc2VsZi5ob3N0LCBzZWxmLnBvcnQsIG1heHNpemU9MSkKICAgICAgICBzZWxmLmFkZENsZWFudXAoY29ubi5jbG9zZSkKCiAgICAgICAgIyBUZXN0IHN0cmVhbSBvbiAwIGxlbmd0aCBib2R5CiAgICAgICAgaGVhZF9yZXNwb25zZSA9IGNvbm4ucmVxdWVzdCgnSEVBRCcsIHVybD0nLycsIHByZWxvYWRfY29udGVudD1GYWxzZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVuZm9yY2VfY29udGVudF9sZW5ndGg9VHJ1ZSkKICAgICAgICBkYXRhID0gW2NodW5rIGZvciBjaHVuayBpbiBoZWFkX3Jlc3BvbnNlLnN0cmVhbSgxKV0KICAgICAgICBzZWxmLmFzc2VydEVxdWFsKGxlbihkYXRhKSwgMCkKCiAgICAgICAgZG9uZV9ldmVudC5zZXQoKQo=
