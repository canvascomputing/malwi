statistics:
  total_files: 1
  skipped_files: 0.0
  processed_objects: 1
  malicious_objects: 0
details:
- path: .repo_cache/malicious_repos/pypi_malregistry/urlib3/1.21.1/urlib3-1.21.1/urlib3-1.21.1/urllib3/contrib/_securetransport/low_level.py
  contents:
  - name: _cert_array_from_pem
    score: 0.0
    code: |-
      def _cert_array_from_pem(pem_bundle):
          """
          Given a bundle of certs in PEM format, turns them into a CFArray of certs
          that can be used to validate a cert chain.
          """
          der_certs = [
              base64.b64decode(match.group(1))
              for match in _PEM_CERTS_RE.finditer(pem_bundle)
          ]
          if not der_certs:
              raise ssl.SSLError("No root certificates specified")

          cert_array = CoreFoundation.CFArrayCreateMutable(
              CoreFoundation.kCFAllocatorDefault,
              0,
              ctypes.byref(CoreFoundation.kCFTypeArrayCallBacks)
          )
          if not cert_array:
              raise ssl.SSLError("Unable to allocate memory!")

          try:
              for der_bytes in der_certs:
                  certdata = _cf_data_from_bytes(der_bytes)
                  if not certdata:
                      raise ssl.SSLError("Unable to allocate memory!")
                  cert = Security.SecCertificateCreateWithData(
                      CoreFoundation.kCFAllocatorDefault, certdata
                  )
                  CoreFoundation.CFRelease(certdata)
                  if not cert:
                      raise ssl.SSLError("Unable to build cert object!")

                  CoreFoundation.CFArrayAppendValue(cert_array, cert)
                  CoreFoundation.CFRelease(cert)
          except Exception:
              # We need to free the array before the exception bubbles further.
              # We only want to do that if an error occurs: otherwise, the caller
              # should free.
              CoreFoundation.CFRelease(cert_array)

          return cert_array
    tokens: resume load_global _PEM_CERTS_RE load_attr finditer load_fast pem_bundle call get_iter load_fast_and_clear match swap build_list swap for_iter TO_NUMBER store_fast match load_global base64 load_attr ENCODING_DECODING load_fast match load_attr group load_const INTEGER call call list_append jump_backward TO_NUMBER end_for store_fast der_certs store_fast match load_fast der_certs pop_jump_if_true TO_NUMBER load_global ssl load_attr SSLError load_const STRING_LEN_S_ENT_HIGH call raise_varargs load_global CoreFoundation load_attr STRING_BASE64_LEN_S_ENT_HIGH load_global CoreFoundation load_attr STRING_LEN_S_ENT_HIGH load_const INTEGER load_global ctypes load_attr byref load_global CoreFoundation load_attr STRING_LEN_S_ENT_HIGH call call store_fast cert_array load_fast cert_array pop_jump_if_true TO_NUMBER load_global ssl load_attr SSLError load_const STRING_LEN_S_ENT_HIGH call raise_varargs nop load_fast der_certs get_iter for_iter TO_NUMBER store_fast der_bytes load_global STRING_LEN_S_ENT_HIGH load_fast der_bytes call store_fast certdata load_fast certdata pop_jump_if_true TO_NUMBER load_global ssl load_attr SSLError load_const STRING_LEN_S_ENT_HIGH call raise_varargs load_global Security load_attr STRING_BASE64_LEN_S_ENT_HIGH load_global CoreFoundation load_attr STRING_LEN_S_ENT_HIGH load_fast certdata call store_fast cert load_global CoreFoundation load_attr CFRelease load_fast certdata call pop_top load_fast cert pop_jump_if_true TO_NUMBER load_global ssl load_attr SSLError load_const STRING_LEN_S_ENT_HIGH call raise_varargs load_global CoreFoundation load_attr STRING_LEN_S_ENT_HIGH load_fast cert_array load_fast cert call pop_top load_global CoreFoundation load_attr CFRelease load_fast cert call pop_top jump_backward TO_NUMBER end_for nop load_fast cert_array return_value swap pop_top swap store_fast match reraise push_exc_info load_global Exception check_exc_match pop_jump_if_false TO_NUMBER pop_top load_global CoreFoundation load_attr CFRelease load_fast cert_array call pop_top pop_except load_fast cert_array return_value reraise copy pop_except reraise
    hash: aa12fa870386b16cc535184fe9b6aaf34cf06c72df58a749be5341c392c7c313
sources:
  ? .repo_cache/malicious_repos/pypi_malregistry/urlib3/1.21.1/urlib3-1.21.1/urlib3-1.21.1/urllib3/contrib/_securetransport/low_level.py
  : IiIiCkxvdy1sZXZlbCBoZWxwZXJzIGZvciB0aGUgU2VjdXJlVHJhbnNwb3J0IGJpbmRpbmdzLgoKVGhlc2UgYXJlIFB5dGhvbiBmdW5jdGlvbnMgdGhhdCBhcmUgbm90IGRpcmVjdGx5IHJlbGF0ZWQgdG8gdGhlIGhpZ2gtbGV2ZWwgQVBJcwpidXQgYXJlIG5lY2Vzc2FyeSB0byBnZXQgdGhlbSB0byB3b3JrLiBUaGV5IGluY2x1ZGUgYSB3aG9sZSBidW5jaCBvZiBsb3ctbGV2ZWwKQ29yZUZvdW5kYXRpb24gbWVzc2luZyBhYm91dCBhbmQgbWVtb3J5IG1hbmFnZW1lbnQuIFRoZSBjb25jZXJucyBpbiB0aGlzIG1vZHVsZQphcmUgYWxtb3N0IGVudGlyZWx5IGFib3V0IHRyeWluZyB0byBhdm9pZCBtZW1vcnkgbGVha3MgYW5kIHByb3ZpZGluZwphcHByb3ByaWF0ZSBhbmQgdXNlZnVsIGFzc2lzdGFuY2UgdG8gdGhlIGhpZ2hlci1sZXZlbCBjb2RlLgoiIiIKaW1wb3J0IGJhc2U2NAppbXBvcnQgY3R5cGVzCmltcG9ydCBpdGVydG9vbHMKaW1wb3J0IHJlCmltcG9ydCBvcwppbXBvcnQgc3NsCmltcG9ydCB0ZW1wZmlsZQoKZnJvbSAuYmluZGluZ3MgaW1wb3J0IFNlY3VyaXR5LCBDb3JlRm91bmRhdGlvbiwgQ0ZDb25zdAoKCiMgVGhpcyByZWd1bGFyIGV4cHJlc3Npb24gaXMgdXNlZCB0byBncmFiIFBFTSBkYXRhIG91dCBvZiBhIFBFTSBidW5kbGUuCl9QRU1fQ0VSVFNfUkUgPSByZS5jb21waWxlKAogICAgYiItLS0tLUJFR0lOIENFUlRJRklDQVRFLS0tLS1cbiguKj8pXG4tLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tIiwgcmUuRE9UQUxMCikKCgpkZWYgX2NmX2RhdGFfZnJvbV9ieXRlcyhieXRlc3RyaW5nKToKICAgICIiIgogICAgR2l2ZW4gYSBieXRlc3RyaW5nLCBjcmVhdGUgYSBDRkRhdGEgb2JqZWN0IGZyb20gaXQuIFRoaXMgQ0ZEYXRhIG9iamVjdCBtdXN0CiAgICBiZSBDRlJlbGVhc2VkIGJ5IHRoZSBjYWxsZXIuCiAgICAiIiIKICAgIHJldHVybiBDb3JlRm91bmRhdGlvbi5DRkRhdGFDcmVhdGUoCiAgICAgICAgQ29yZUZvdW5kYXRpb24ua0NGQWxsb2NhdG9yRGVmYXVsdCwgYnl0ZXN0cmluZywgbGVuKGJ5dGVzdHJpbmcpCiAgICApCgoKZGVmIF9jZl9kaWN0aW9uYXJ5X2Zyb21fdHVwbGVzKHR1cGxlcyk6CiAgICAiIiIKICAgIEdpdmVuIGEgbGlzdCBvZiBQeXRob24gdHVwbGVzLCBjcmVhdGUgYW4gYXNzb2NpYXRlZCBDRkRpY3Rpb25hcnkuCiAgICAiIiIKICAgIGRpY3Rpb25hcnlfc2l6ZSA9IGxlbih0dXBsZXMpCgogICAgIyBXZSBuZWVkIHRvIGdldCB0aGUgZGljdGlvbmFyeSBrZXlzIGFuZCB2YWx1ZXMgb3V0IGluIHRoZSBzYW1lIG9yZGVyLgogICAga2V5cyA9ICh0WzBdIGZvciB0IGluIHR1cGxlcykKICAgIHZhbHVlcyA9ICh0WzFdIGZvciB0IGluIHR1cGxlcykKICAgIGNmX2tleXMgPSAoQ29yZUZvdW5kYXRpb24uQ0ZUeXBlUmVmICogZGljdGlvbmFyeV9zaXplKSgqa2V5cykKICAgIGNmX3ZhbHVlcyA9IChDb3JlRm91bmRhdGlvbi5DRlR5cGVSZWYgKiBkaWN0aW9uYXJ5X3NpemUpKCp2YWx1ZXMpCgogICAgcmV0dXJuIENvcmVGb3VuZGF0aW9uLkNGRGljdGlvbmFyeUNyZWF0ZSgKICAgICAgICBDb3JlRm91bmRhdGlvbi5rQ0ZBbGxvY2F0b3JEZWZhdWx0LAogICAgICAgIGNmX2tleXMsCiAgICAgICAgY2ZfdmFsdWVzLAogICAgICAgIGRpY3Rpb25hcnlfc2l6ZSwKICAgICAgICBDb3JlRm91bmRhdGlvbi5rQ0ZUeXBlRGljdGlvbmFyeUtleUNhbGxCYWNrcywKICAgICAgICBDb3JlRm91bmRhdGlvbi5rQ0ZUeXBlRGljdGlvbmFyeVZhbHVlQ2FsbEJhY2tzLAogICAgKQoKCmRlZiBfY2Zfc3RyaW5nX3RvX3VuaWNvZGUodmFsdWUpOgogICAgIiIiCiAgICBDcmVhdGVzIGEgVW5pY29kZSBzdHJpbmcgZnJvbSBhIENGU3RyaW5nIG9iamVjdC4gVXNlZCBlbnRpcmVseSBmb3IgZXJyb3IKICAgIHJlcG9ydGluZy4KCiAgICBZZXMsIGl0IGFubm95cyBtZSBxdWl0ZSBhIGxvdCB0aGF0IHRoaXMgZnVuY3Rpb24gaXMgdGhpcyBjb21wbGV4LgogICAgIiIiCiAgICB2YWx1ZV9hc192b2lkX3AgPSBjdHlwZXMuY2FzdCh2YWx1ZSwgY3R5cGVzLlBPSU5URVIoY3R5cGVzLmNfdm9pZF9wKSkKCiAgICBzdHJpbmcgPSBDb3JlRm91bmRhdGlvbi5DRlN0cmluZ0dldENTdHJpbmdQdHIoCiAgICAgICAgdmFsdWVfYXNfdm9pZF9wLAogICAgICAgIENGQ29uc3Qua0NGU3RyaW5nRW5jb2RpbmdVVEY4CiAgICApCiAgICBpZiBzdHJpbmcgaXMgTm9uZToKICAgICAgICBidWZmZXIgPSBjdHlwZXMuY3JlYXRlX3N0cmluZ19idWZmZXIoMTAyNCkKICAgICAgICByZXN1bHQgPSBDb3JlRm91bmRhdGlvbi5DRlN0cmluZ0dldENTdHJpbmcoCiAgICAgICAgICAgIHZhbHVlX2FzX3ZvaWRfcCwKICAgICAgICAgICAgYnVmZmVyLAogICAgICAgICAgICAxMDI0LAogICAgICAgICAgICBDRkNvbnN0LmtDRlN0cmluZ0VuY29kaW5nVVRGOAogICAgICAgICkKICAgICAgICBpZiBub3QgcmVzdWx0OgogICAgICAgICAgICByYWlzZSBPU0Vycm9yKCdFcnJvciBjb3B5aW5nIEMgc3RyaW5nIGZyb20gQ0ZTdHJpbmdSZWYnKQogICAgICAgIHN0cmluZyA9IGJ1ZmZlci52YWx1ZQogICAgaWYgc3RyaW5nIGlzIG5vdCBOb25lOgogICAgICAgIHN0cmluZyA9IHN0cmluZy5kZWNvZGUoJ3V0Zi04JykKICAgIHJldHVybiBzdHJpbmcKCgpkZWYgX2Fzc2VydF9ub19lcnJvcihlcnJvciwgZXhjZXB0aW9uX2NsYXNzPU5vbmUpOgogICAgIiIiCiAgICBDaGVja3MgdGhlIHJldHVybiBjb2RlIGFuZCB0aHJvd3MgYW4gZXhjZXB0aW9uIGlmIHRoZXJlIGlzIGFuIGVycm9yIHRvCiAgICByZXBvcnQKICAgICIiIgogICAgaWYgZXJyb3IgPT0gMDoKICAgICAgICByZXR1cm4KCiAgICBjZl9lcnJvcl9zdHJpbmcgPSBTZWN1cml0eS5TZWNDb3B5RXJyb3JNZXNzYWdlU3RyaW5nKGVycm9yLCBOb25lKQogICAgb3V0cHV0ID0gX2NmX3N0cmluZ190b191bmljb2RlKGNmX2Vycm9yX3N0cmluZykKICAgIENvcmVGb3VuZGF0aW9uLkNGUmVsZWFzZShjZl9lcnJvcl9zdHJpbmcpCgogICAgaWYgb3V0cHV0IGlzIE5vbmUgb3Igb3V0cHV0ID09IHUnJzoKICAgICAgICBvdXRwdXQgPSB1J09TU3RhdHVzICVzJyAlIGVycm9yCgogICAgaWYgZXhjZXB0aW9uX2NsYXNzIGlzIE5vbmU6CiAgICAgICAgZXhjZXB0aW9uX2NsYXNzID0gc3NsLlNTTEVycm9yCgogICAgcmFpc2UgZXhjZXB0aW9uX2NsYXNzKG91dHB1dCkKCgpkZWYgX2NlcnRfYXJyYXlfZnJvbV9wZW0ocGVtX2J1bmRsZSk6CiAgICAiIiIKICAgIEdpdmVuIGEgYnVuZGxlIG9mIGNlcnRzIGluIFBFTSBmb3JtYXQsIHR1cm5zIHRoZW0gaW50byBhIENGQXJyYXkgb2YgY2VydHMKICAgIHRoYXQgY2FuIGJlIHVzZWQgdG8gdmFsaWRhdGUgYSBjZXJ0IGNoYWluLgogICAgIiIiCiAgICBkZXJfY2VydHMgPSBbCiAgICAgICAgYmFzZTY0LmI2NGRlY29kZShtYXRjaC5ncm91cCgxKSkKICAgICAgICBmb3IgbWF0Y2ggaW4gX1BFTV9DRVJUU19SRS5maW5kaXRlcihwZW1fYnVuZGxlKQogICAgXQogICAgaWYgbm90IGRlcl9jZXJ0czoKICAgICAgICByYWlzZSBzc2wuU1NMRXJyb3IoIk5vIHJvb3QgY2VydGlmaWNhdGVzIHNwZWNpZmllZCIpCgogICAgY2VydF9hcnJheSA9IENvcmVGb3VuZGF0aW9uLkNGQXJyYXlDcmVhdGVNdXRhYmxlKAogICAgICAgIENvcmVGb3VuZGF0aW9uLmtDRkFsbG9jYXRvckRlZmF1bHQsCiAgICAgICAgMCwKICAgICAgICBjdHlwZXMuYnlyZWYoQ29yZUZvdW5kYXRpb24ua0NGVHlwZUFycmF5Q2FsbEJhY2tzKQogICAgKQogICAgaWYgbm90IGNlcnRfYXJyYXk6CiAgICAgICAgcmFpc2Ugc3NsLlNTTEVycm9yKCJVbmFibGUgdG8gYWxsb2NhdGUgbWVtb3J5ISIpCgogICAgdHJ5OgogICAgICAgIGZvciBkZXJfYnl0ZXMgaW4gZGVyX2NlcnRzOgogICAgICAgICAgICBjZXJ0ZGF0YSA9IF9jZl9kYXRhX2Zyb21fYnl0ZXMoZGVyX2J5dGVzKQogICAgICAgICAgICBpZiBub3QgY2VydGRhdGE6CiAgICAgICAgICAgICAgICByYWlzZSBzc2wuU1NMRXJyb3IoIlVuYWJsZSB0byBhbGxvY2F0ZSBtZW1vcnkhIikKICAgICAgICAgICAgY2VydCA9IFNlY3VyaXR5LlNlY0NlcnRpZmljYXRlQ3JlYXRlV2l0aERhdGEoCiAgICAgICAgICAgICAgICBDb3JlRm91bmRhdGlvbi5rQ0ZBbGxvY2F0b3JEZWZhdWx0LCBjZXJ0ZGF0YQogICAgICAgICAgICApCiAgICAgICAgICAgIENvcmVGb3VuZGF0aW9uLkNGUmVsZWFzZShjZXJ0ZGF0YSkKICAgICAgICAgICAgaWYgbm90IGNlcnQ6CiAgICAgICAgICAgICAgICByYWlzZSBzc2wuU1NMRXJyb3IoIlVuYWJsZSB0byBidWlsZCBjZXJ0IG9iamVjdCEiKQoKICAgICAgICAgICAgQ29yZUZvdW5kYXRpb24uQ0ZBcnJheUFwcGVuZFZhbHVlKGNlcnRfYXJyYXksIGNlcnQpCiAgICAgICAgICAgIENvcmVGb3VuZGF0aW9uLkNGUmVsZWFzZShjZXJ0KQogICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAjIFdlIG5lZWQgdG8gZnJlZSB0aGUgYXJyYXkgYmVmb3JlIHRoZSBleGNlcHRpb24gYnViYmxlcyBmdXJ0aGVyLgogICAgICAgICMgV2Ugb25seSB3YW50IHRvIGRvIHRoYXQgaWYgYW4gZXJyb3Igb2NjdXJzOiBvdGhlcndpc2UsIHRoZSBjYWxsZXIKICAgICAgICAjIHNob3VsZCBmcmVlLgogICAgICAgIENvcmVGb3VuZGF0aW9uLkNGUmVsZWFzZShjZXJ0X2FycmF5KQoKICAgIHJldHVybiBjZXJ0X2FycmF5CgoKZGVmIF9pc19jZXJ0KGl0ZW0pOgogICAgIiIiCiAgICBSZXR1cm5zIFRydWUgaWYgYSBnaXZlbiBDRlR5cGVSZWYgaXMgYSBjZXJ0aWZpY2F0ZS4KICAgICIiIgogICAgZXhwZWN0ZWQgPSBTZWN1cml0eS5TZWNDZXJ0aWZpY2F0ZUdldFR5cGVJRCgpCiAgICByZXR1cm4gQ29yZUZvdW5kYXRpb24uQ0ZHZXRUeXBlSUQoaXRlbSkgPT0gZXhwZWN0ZWQKCgpkZWYgX2lzX2lkZW50aXR5KGl0ZW0pOgogICAgIiIiCiAgICBSZXR1cm5zIFRydWUgaWYgYSBnaXZlbiBDRlR5cGVSZWYgaXMgYW4gaWRlbnRpdHkuCiAgICAiIiIKICAgIGV4cGVjdGVkID0gU2VjdXJpdHkuU2VjSWRlbnRpdHlHZXRUeXBlSUQoKQogICAgcmV0dXJuIENvcmVGb3VuZGF0aW9uLkNGR2V0VHlwZUlEKGl0ZW0pID09IGV4cGVjdGVkCgoKZGVmIF90ZW1wb3Jhcnlfa2V5Y2hhaW4oKToKICAgICIiIgogICAgVGhpcyBmdW5jdGlvbiBjcmVhdGVzIGEgdGVtcG9yYXJ5IE1hYyBrZXljaGFpbiB0aGF0IHdlIGNhbiB1c2UgdG8gd29yayB3aXRoCiAgICBjcmVkZW50aWFscy4gVGhpcyBrZXljaGFpbiB1c2VzIGEgb25lLXRpbWUgcGFzc3dvcmQgYW5kIGEgdGVtcG9yYXJ5IGZpbGUgdG8KICAgIHN0b3JlIHRoZSBkYXRhLiBXZSBleHBlY3QgdG8gaGF2ZSBvbmUga2V5Y2hhaW4gcGVyIHNvY2tldC4gVGhlIHJldHVybmVkCiAgICBTZWNLZXljaGFpblJlZiBtdXN0IGJlIGZyZWVkIGJ5IHRoZSBjYWxsZXIsIGluY2x1ZGluZyBjYWxsaW5nCiAgICBTZWNLZXljaGFpbkRlbGV0ZS4KCiAgICBSZXR1cm5zIGEgdHVwbGUgb2YgdGhlIFNlY0tleWNoYWluUmVmIGFuZCB0aGUgcGF0aCB0byB0aGUgdGVtcG9yYXJ5CiAgICBkaXJlY3RvcnkgdGhhdCBjb250YWlucyBpdC4KICAgICIiIgogICAgIyBVbmZvcnR1bmF0ZWx5LCBTZWNLZXljaGFpbkNyZWF0ZSByZXF1aXJlcyBhIHBhdGggdG8gYSBrZXljaGFpbi4gVGhpcwogICAgIyBtZWFucyB3ZSBjYW5ub3QgdXNlIG1rc3RlbXAgdG8gdXNlIGEgZ2VuZXJpYyB0ZW1wb3JhcnkgZmlsZS4gSW5zdGVhZCwKICAgICMgd2UncmUgZ29pbmcgdG8gY3JlYXRlIGEgdGVtcG9yYXJ5IGRpcmVjdG9yeSBhbmQgYSBmaWxlbmFtZSB0byB1c2UgdGhlcmUuCiAgICAjIFRoaXMgZmlsZW5hbWUgd2lsbCBiZSA4IHJhbmRvbSBieXRlcyBleHBhbmRlZCBpbnRvIGJhc2U2NC4gV2UgYWxzbyBuZWVkCiAgICAjIHNvbWUgcmFuZG9tIGJ5dGVzIHRvIHBhc3N3b3JkLXByb3RlY3QgdGhlIGtleWNoYWluIHdlJ3JlIGNyZWF0aW5nLCBzbyB3ZQogICAgIyBhc2sgZm9yIDQwIHJhbmRvbSBieXRlcy4KICAgIHJhbmRvbV9ieXRlcyA9IG9zLnVyYW5kb20oNDApCiAgICBmaWxlbmFtZSA9IGJhc2U2NC5iNjRlbmNvZGUocmFuZG9tX2J5dGVzWzo4XSkuZGVjb2RlKCd1dGYtOCcpCiAgICBwYXNzd29yZCA9IGJhc2U2NC5iNjRlbmNvZGUocmFuZG9tX2J5dGVzWzg6XSkgICMgTXVzdCBiZSB2YWxpZCBVVEYtOAogICAgdGVtcGRpcmVjdG9yeSA9IHRlbXBmaWxlLm1rZHRlbXAoKQoKICAgIGtleWNoYWluX3BhdGggPSBvcy5wYXRoLmpvaW4odGVtcGRpcmVjdG9yeSwgZmlsZW5hbWUpLmVuY29kZSgndXRmLTgnKQoKICAgICMgV2Ugbm93IHdhbnQgdG8gY3JlYXRlIHRoZSBrZXljaGFpbiBpdHNlbGYuCiAgICBrZXljaGFpbiA9IFNlY3VyaXR5LlNlY0tleWNoYWluUmVmKCkKICAgIHN0YXR1cyA9IFNlY3VyaXR5LlNlY0tleWNoYWluQ3JlYXRlKAogICAgICAgIGtleWNoYWluX3BhdGgsCiAgICAgICAgbGVuKHBhc3N3b3JkKSwKICAgICAgICBwYXNzd29yZCwKICAgICAgICBGYWxzZSwKICAgICAgICBOb25lLAogICAgICAgIGN0eXBlcy5ieXJlZihrZXljaGFpbikKICAgICkKICAgIF9hc3NlcnRfbm9fZXJyb3Ioc3RhdHVzKQoKICAgICMgSGF2aW5nIGNyZWF0ZWQgdGhlIGtleWNoYWluLCB3ZSB3YW50IHRvIHBhc3MgaXQgb2ZmIHRvIHRoZSBjYWxsZXIuCiAgICByZXR1cm4ga2V5Y2hhaW4sIHRlbXBkaXJlY3RvcnkKCgpkZWYgX2xvYWRfaXRlbXNfZnJvbV9maWxlKGtleWNoYWluLCBwYXRoKToKICAgICIiIgogICAgR2l2ZW4gYSBzaW5nbGUgZmlsZSwgbG9hZHMgYWxsIHRoZSB0cnVzdCBvYmplY3RzIGZyb20gaXQgaW50byBhcnJheXMgYW5kCiAgICB0aGUga2V5Y2hhaW4uCiAgICBSZXR1cm5zIGEgdHVwbGUgb2YgbGlzdHM6IHRoZSBmaXJzdCBsaXN0IGlzIGEgbGlzdCBvZiBpZGVudGl0aWVzLCB0aGUKICAgIHNlY29uZCBhIGxpc3Qgb2YgY2VydHMuCiAgICAiIiIKICAgIGNlcnRpZmljYXRlcyA9IFtdCiAgICBpZGVudGl0aWVzID0gW10KICAgIHJlc3VsdF9hcnJheSA9IE5vbmUKCiAgICB3aXRoIG9wZW4ocGF0aCwgJ3JiJykgYXMgZjoKICAgICAgICByYXdfZmlsZWRhdGEgPSBmLnJlYWQoKQoKICAgIHRyeToKICAgICAgICBmaWxlZGF0YSA9IENvcmVGb3VuZGF0aW9uLkNGRGF0YUNyZWF0ZSgKICAgICAgICAgICAgQ29yZUZvdW5kYXRpb24ua0NGQWxsb2NhdG9yRGVmYXVsdCwKICAgICAgICAgICAgcmF3X2ZpbGVkYXRhLAogICAgICAgICAgICBsZW4ocmF3X2ZpbGVkYXRhKQogICAgICAgICkKICAgICAgICByZXN1bHRfYXJyYXkgPSBDb3JlRm91bmRhdGlvbi5DRkFycmF5UmVmKCkKICAgICAgICByZXN1bHQgPSBTZWN1cml0eS5TZWNJdGVtSW1wb3J0KAogICAgICAgICAgICBmaWxlZGF0YSwgICMgY2VydCBkYXRhCiAgICAgICAgICAgIE5vbmUsICAjIEZpbGVuYW1lLCBsZWF2aW5nIGl0IG91dCBmb3Igbm93CiAgICAgICAgICAgIE5vbmUsICAjIFdoYXQgdGhlIHR5cGUgb2YgdGhlIGZpbGUgaXMsIHdlIGRvbid0IGNhcmUKICAgICAgICAgICAgTm9uZSwgICMgd2hhdCdzIGluIHRoZSBmaWxlLCB3ZSBkb24ndCBjYXJlCiAgICAgICAgICAgIDAsICAjIGltcG9ydCBmbGFncwogICAgICAgICAgICBOb25lLCAgIyBrZXkgcGFyYW1zLCBjYW4gaW5jbHVkZSBwYXNzcGhyYXNlIGluIHRoZSBmdXR1cmUKICAgICAgICAgICAga2V5Y2hhaW4sICAjIFRoZSBrZXljaGFpbiB0byBpbnNlcnQgaW50bwogICAgICAgICAgICBjdHlwZXMuYnlyZWYocmVzdWx0X2FycmF5KSAgIyBSZXN1bHRzCiAgICAgICAgKQogICAgICAgIF9hc3NlcnRfbm9fZXJyb3IocmVzdWx0KQoKICAgICAgICAjIEEgQ0ZBcnJheSBpcyBub3QgdmVyeSB1c2VmdWwgdG8gdXMgYXMgYW4gaW50ZXJtZWRpYXJ5CiAgICAgICAgIyByZXByZXNlbnRhdGlvbiwgc28gd2UgYXJlIGdvaW5nIHRvIGV4dHJhY3QgdGhlIG9iamVjdHMgd2Ugd2FudAogICAgICAgICMgYW5kIHRoZW4gZnJlZSB0aGUgYXJyYXkuIFdlIGRvbid0IG5lZWQgdG8ga2VlcCBob2xkIG9mIGtleXM6IHRoZQogICAgICAgICMga2V5Y2hhaW4gYWxyZWFkeSBoYXMgdGhlbSEKICAgICAgICByZXN1bHRfY291bnQgPSBDb3JlRm91bmRhdGlvbi5DRkFycmF5R2V0Q291bnQocmVzdWx0X2FycmF5KQogICAgICAgIGZvciBpbmRleCBpbiByYW5nZShyZXN1bHRfY291bnQpOgogICAgICAgICAgICBpdGVtID0gQ29yZUZvdW5kYXRpb24uQ0ZBcnJheUdldFZhbHVlQXRJbmRleCgKICAgICAgICAgICAgICAgIHJlc3VsdF9hcnJheSwgaW5kZXgKICAgICAgICAgICAgKQogICAgICAgICAgICBpdGVtID0gY3R5cGVzLmNhc3QoaXRlbSwgQ29yZUZvdW5kYXRpb24uQ0ZUeXBlUmVmKQoKICAgICAgICAgICAgaWYgX2lzX2NlcnQoaXRlbSk6CiAgICAgICAgICAgICAgICBDb3JlRm91bmRhdGlvbi5DRlJldGFpbihpdGVtKQogICAgICAgICAgICAgICAgY2VydGlmaWNhdGVzLmFwcGVuZChpdGVtKQogICAgICAgICAgICBlbGlmIF9pc19pZGVudGl0eShpdGVtKToKICAgICAgICAgICAgICAgIENvcmVGb3VuZGF0aW9uLkNGUmV0YWluKGl0ZW0pCiAgICAgICAgICAgICAgICBpZGVudGl0aWVzLmFwcGVuZChpdGVtKQogICAgZmluYWxseToKICAgICAgICBpZiByZXN1bHRfYXJyYXk6CiAgICAgICAgICAgIENvcmVGb3VuZGF0aW9uLkNGUmVsZWFzZShyZXN1bHRfYXJyYXkpCgogICAgICAgIENvcmVGb3VuZGF0aW9uLkNGUmVsZWFzZShmaWxlZGF0YSkKCiAgICByZXR1cm4gKGlkZW50aXRpZXMsIGNlcnRpZmljYXRlcykKCgpkZWYgX2xvYWRfY2xpZW50X2NlcnRfY2hhaW4oa2V5Y2hhaW4sICpwYXRocyk6CiAgICAiIiIKICAgIExvYWQgY2VydGlmaWNhdGVzIGFuZCBtYXliZSBrZXlzIGZyb20gYSBudW1iZXIgb2YgZmlsZXMuIEhhcyB0aGUgZW5kIGdvYWwKICAgIG9mIHJldHVybmluZyBhIENGQXJyYXkgY29udGFpbmluZyBvbmUgU2VjSWRlbnRpdHlSZWYsIGFuZCB0aGVuIHplcm8gb3IgbW9yZQogICAgU2VjQ2VydGlmaWNhdGVSZWYgb2JqZWN0cywgc3VpdGFibGUgZm9yIHVzZSBhcyBhIGNsaWVudCBjZXJ0aWZpY2F0ZSB0cnVzdAogICAgY2hhaW4uCiAgICAiIiIKICAgICMgT2ssIHRoZSBzdHJhdGVneS4KICAgICMKICAgICMgVGhpcyByZWxpZXMgb24ga25vd2luZyB0aGF0IG1hY09TIHdpbGwgbm90IGdpdmUgeW91IGEgU2VjSWRlbnRpdHlSZWYKICAgICMgdW5sZXNzIHlvdSBoYXZlIGltcG9ydGVkIGEga2V5IGludG8gYSBrZXljaGFpbi4gVGhpcyBpcyBhIHNvbWV3aGF0CiAgICAjIGFydGlmaWNpYWwgbGltaXRhdGlvbiBvZiBtYWNPUyAoZm9yIGV4YW1wbGUsIGl0IGRvZXNuJ3QgbmVjZXNzYXJpbHkKICAgICMgYWZmZWN0IGlPUyksIGJ1dCB0aGVyZSBpcyBub3RoaW5nIGluc2lkZSBTZWN1cml0eS5mcmFtZXdvcmsgdGhhdCBsZXRzIHlvdQogICAgIyBnZXQgYSBTZWNJZGVudGl0eVJlZiB3aXRob3V0IGhhdmluZyBhIGtleSBpbiBhIGtleWNoYWluLgogICAgIwogICAgIyBTbyB0aGUgcG9saWN5IGhlcmUgaXMgd2UgdGFrZSBhbGwgdGhlIGZpbGVzIGFuZCBpdGVyYXRlIHRoZW0gaW4gb3JkZXIuCiAgICAjIEVhY2ggb25lIHdpbGwgdXNlIFNlY0l0ZW1JbXBvcnQgdG8gaGF2ZSBvbmUgb3IgbW9yZSBvYmplY3RzIGxvYWRlZCBmcm9tCiAgICAjIGl0LiBXZSB3aWxsIGFsc28gcG9pbnQgYXQgYSBrZXljaGFpbiB0aGF0IG1hY09TIGNhbiB1c2UgdG8gd29yayB3aXRoIHRoZQogICAgIyBwcml2YXRlIGtleS4KICAgICMKICAgICMgT25jZSB3ZSBoYXZlIGFsbCB0aGUgb2JqZWN0cywgd2UnbGwgY2hlY2sgd2hhdCB3ZSBhY3R1YWxseSBoYXZlLiBJZiB3ZQogICAgIyBhbHJlYWR5IGhhdmUgYSBTZWNJZGVudGl0eVJlZiBpbiBoYW5kLCBmYWI6IHdlJ2xsIHVzZSB0aGF0LiBPdGhlcndpc2UsCiAgICAjIHdlJ2xsIHRha2UgdGhlIGZpcnN0IGNlcnRpZmljYXRlICh3aGljaCB3ZSBhc3N1bWUgdG8gYmUgb3VyIGxlYWYpIGFuZAogICAgIyBhc2sgdGhlIGtleWNoYWluIHRvIGdpdmUgdXMgYSBTZWNJZGVudGl0eVJlZiB3aXRoIHRoYXQgY2VydCdzIGFzc29jaWF0ZWQKICAgICMga2V5LgogICAgIwogICAgIyBXZSdsbCB0aGVuIHJldHVybiBhIENGQXJyYXkgY29udGFpbmluZyB0aGUgdHJ1c3QgY2hhaW46IG9uZQogICAgIyBTZWNJZGVudGl0eVJlZiBhbmQgdGhlbiB6ZXJvLW9yLW1vcmUgU2VjQ2VydGlmaWNhdGVSZWYgb2JqZWN0cy4gVGhlCiAgICAjIHJlc3BvbnNpYmlsaXR5IGZvciBmcmVlaW5nIHRoaXMgQ0ZBcnJheSB3aWxsIGJlIHdpdGggdGhlIGNhbGxlci4gVGhpcwogICAgIyBDRkFycmF5IG11c3QgcmVtYWluIGFsaXZlIGZvciB0aGUgZW50aXJlIGNvbm5lY3Rpb24sIHNvIGluIHByYWN0aWNlIGl0CiAgICAjIHdpbGwgYmUgc3RvcmVkIHdpdGggYSBzaW5nbGUgU1NMU29ja2V0LCBhbG9uZyB3aXRoIHRoZSByZWZlcmVuY2UgdG8gdGhlCiAgICAjIGtleWNoYWluLgogICAgY2VydGlmaWNhdGVzID0gW10KICAgIGlkZW50aXRpZXMgPSBbXQoKICAgICMgRmlsdGVyIG91dCBiYWQgcGF0aHMuCiAgICBwYXRocyA9IChwYXRoIGZvciBwYXRoIGluIHBhdGhzIGlmIHBhdGgpCgogICAgdHJ5OgogICAgICAgIGZvciBmaWxlX3BhdGggaW4gcGF0aHM6CiAgICAgICAgICAgIG5ld19pZGVudGl0aWVzLCBuZXdfY2VydHMgPSBfbG9hZF9pdGVtc19mcm9tX2ZpbGUoCiAgICAgICAgICAgICAgICBrZXljaGFpbiwgZmlsZV9wYXRoCiAgICAgICAgICAgICkKICAgICAgICAgICAgaWRlbnRpdGllcy5leHRlbmQobmV3X2lkZW50aXRpZXMpCiAgICAgICAgICAgIGNlcnRpZmljYXRlcy5leHRlbmQobmV3X2NlcnRzKQoKICAgICAgICAjIE9rLCB3ZSBoYXZlIGV2ZXJ5dGhpbmcuIFRoZSBxdWVzdGlvbiBpczogZG8gd2UgaGF2ZSBhbiBpZGVudGl0eT8gSWYKICAgICAgICAjIG5vdCwgd2Ugd2FudCB0byBncmFiIG9uZSBmcm9tIHRoZSBmaXJzdCBjZXJ0IHdlIGhhdmUuCiAgICAgICAgaWYgbm90IGlkZW50aXRpZXM6CiAgICAgICAgICAgIG5ld19pZGVudGl0eSA9IFNlY3VyaXR5LlNlY0lkZW50aXR5UmVmKCkKICAgICAgICAgICAgc3RhdHVzID0gU2VjdXJpdHkuU2VjSWRlbnRpdHlDcmVhdGVXaXRoQ2VydGlmaWNhdGUoCiAgICAgICAgICAgICAgICBrZXljaGFpbiwKICAgICAgICAgICAgICAgIGNlcnRpZmljYXRlc1swXSwKICAgICAgICAgICAgICAgIGN0eXBlcy5ieXJlZihuZXdfaWRlbnRpdHkpCiAgICAgICAgICAgICkKICAgICAgICAgICAgX2Fzc2VydF9ub19lcnJvcihzdGF0dXMpCiAgICAgICAgICAgIGlkZW50aXRpZXMuYXBwZW5kKG5ld19pZGVudGl0eSkKCiAgICAgICAgICAgICMgV2Ugbm93IHdhbnQgdG8gcmVsZWFzZSB0aGUgb3JpZ2luYWwgY2VydGlmaWNhdGUsIGFzIHdlIG5vIGxvbmdlcgogICAgICAgICAgICAjIG5lZWQgaXQuCiAgICAgICAgICAgIENvcmVGb3VuZGF0aW9uLkNGUmVsZWFzZShjZXJ0aWZpY2F0ZXMucG9wKDApKQoKICAgICAgICAjIFdlIG5vdyBuZWVkIHRvIGJ1aWxkIGEgbmV3IENGQXJyYXkgdGhhdCBob2xkcyB0aGUgdHJ1c3QgY2hhaW4uCiAgICAgICAgdHJ1c3RfY2hhaW4gPSBDb3JlRm91bmRhdGlvbi5DRkFycmF5Q3JlYXRlTXV0YWJsZSgKICAgICAgICAgICAgQ29yZUZvdW5kYXRpb24ua0NGQWxsb2NhdG9yRGVmYXVsdCwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgY3R5cGVzLmJ5cmVmKENvcmVGb3VuZGF0aW9uLmtDRlR5cGVBcnJheUNhbGxCYWNrcyksCiAgICAgICAgKQogICAgICAgIGZvciBpdGVtIGluIGl0ZXJ0b29scy5jaGFpbihpZGVudGl0aWVzLCBjZXJ0aWZpY2F0ZXMpOgogICAgICAgICAgICAjIEFycmF5QXBwZW5kVmFsdWUgZG9lcyBhIENGUmV0YWluIG9uIHRoZSBpdGVtLiBUaGF0J3MgZmluZSwKICAgICAgICAgICAgIyBiZWNhdXNlIHRoZSBmaW5hbGx5IGJsb2NrIHdpbGwgcmVsZWFzZSBvdXIgb3RoZXIgcmVmcyB0byB0aGVtLgogICAgICAgICAgICBDb3JlRm91bmRhdGlvbi5DRkFycmF5QXBwZW5kVmFsdWUodHJ1c3RfY2hhaW4sIGl0ZW0pCgogICAgICAgIHJldHVybiB0cnVzdF9jaGFpbgogICAgZmluYWxseToKICAgICAgICBmb3Igb2JqIGluIGl0ZXJ0b29scy5jaGFpbihpZGVudGl0aWVzLCBjZXJ0aWZpY2F0ZXMpOgogICAgICAgICAgICBDb3JlRm91bmRhdGlvbi5DRlJlbGVhc2Uob2JqKQo=
