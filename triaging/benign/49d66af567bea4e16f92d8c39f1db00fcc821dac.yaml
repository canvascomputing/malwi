statistics:
  total_files: 1
  skipped_files: 0.0
  processed_objects: 1
  malicious_objects: 0
details:
- path: .repo_cache/malicious_repos/pypi_malregistry/pycryptoenv/1.0.7/pycryptoenv-1.0.7/pycryptoenv-1.0.7/pycryptoenv/_mac/tls.py
  contents:
  - name: TLSSocket.read_until
    score: 0.0
    code: |-
      def read_until(self, marker):
              """
              Reads data from the socket until a marker is found. Data read includes
              the marker.

              :param marker:
                  A byte string or regex object from re.compile(). Used to determine
                  when to stop reading. Regex objects are more inefficient since
                  they must scan the entire byte string of read data each time data
                  is read off the socket.

              :return:
                  A byte string of the data read, including the marker
              """

              if not isinstance(marker, byte_cls) and not isinstance(marker, Pattern):
                  raise TypeError(pretty_message(
                      '''
                      marker must be a byte string or compiled regex object, not %s
                      ''',
                      type_name(marker)
                  ))

              output = b''

              is_regex = isinstance(marker, Pattern)

              while True:
                  if len(self._decrypted_bytes) > 0:
                      chunk = self._decrypted_bytes
                      self._decrypted_bytes = b''
                  else:
                      to_read = self._os_buffered_size() or 8192
                      chunk = self.read(to_read)

                  offset = len(output)
                  output += chunk

                  if is_regex:
                      match = marker.search(output)
                      if match is not None:
                          end = match.end()
                          break
                  else:
                      # If the marker was not found last time, we have to start
                      # at a position where the marker would have its final char
                      # in the newly read chunk
                      start = max(0, offset - len(marker) - 1)
                      match = output.find(marker, start)
                      if match != -1:
                          end = match + len(marker)
                          break

              self._decrypted_bytes = output[end:] + self._decrypted_bytes
              return output[0:end]
    tokens: resume load_global isinstance load_fast marker load_global byte_cls call pop_jump_if_true TO_NUMBER load_global isinstance load_fast marker load_global Pattern call pop_jump_if_true TO_NUMBER load_global TypeError load_global pretty_message load_const STRING_LEN_S_ENT_HIGH load_global type_name load_fast marker call call call raise_varargs load_const store_fast output load_global isinstance load_fast marker load_global Pattern call store_fast is_regex nop load_global len load_fast self load_attr STRING_LEN_S_ENT_HIGH call load_const INTEGER compare_op > pop_jump_if_false TO_NUMBER load_fast self load_attr STRING_LEN_S_ENT_HIGH store_fast chunk load_const load_fast self store_attr STRING_LEN_S_ENT_HIGH jump_forward TO_NUMBER load_fast self load_attr STRING_LEN_S_ENT_HIGH call copy pop_jump_if_true TO_NUMBER pop_top load_const INTEGER store_fast to_read load_fast self load_attr read load_fast to_read call store_fast chunk load_global len load_fast output call store_fast offset load_fast output load_fast chunk binary_op += store_fast output load_fast is_regex pop_jump_if_false TO_NUMBER load_fast marker load_attr search load_fast output call store_fast match load_fast match pop_jump_if_none TO_NUMBER load_fast match load_attr end call store_fast end jump_forward TO_NUMBER load_global max load_const INTEGER load_fast offset load_global len load_fast marker call binary_op - load_const INTEGER binary_op - call store_fast start load_fast output load_attr find load_fast marker load_fast start call store_fast match load_fast match load_const INTEGER compare_op != pop_jump_if_false TO_NUMBER load_fast match load_global len load_fast marker call binary_op + store_fast end jump_forward TO_NUMBER jump_backward TO_NUMBER load_fast output load_fast end load_const binary_slice load_fast self load_attr STRING_LEN_S_ENT_HIGH binary_op + load_fast self store_attr STRING_LEN_S_ENT_HIGH load_fast output load_const INTEGER load_fast end binary_slice return_value
    hash: 3586ef23c578a66ce86d2480f9332f7dfc49c084ecc317b400d561f5a0d9c532
sources:
  .repo_cache/malicious_repos/pypi_malregistry/pycryptoenv/1.0.7/pycryptoenv-1.0.7/pycryptoenv-1.0.7/pycryptoenv/_mac/tls.py: IyBjb2Rpbmc6IHV0Zi04CmZyb20gX19mdXR1cmVfXyBpbXBvcnQgdW5pY29kZV9saXRlcmFscywgZGl2aXNpb24sIGFic29sdXRlX2ltcG9ydCwgcHJpbnRfZnVuY3Rpb24KCmltcG9ydCBkYXRldGltZQppbXBvcnQgc3lzCmltcG9ydCByZQppbXBvcnQgc29ja2V0IGFzIHNvY2tldF8KaW1wb3J0IHNlbGVjdAppbXBvcnQgbnVtYmVycwppbXBvcnQgZXJybm8KaW1wb3J0IHdlYWtyZWYKCmZyb20gLl9zZWN1cml0eSBpbXBvcnQgU2VjdXJpdHksIG9zeF92ZXJzaW9uX2luZm8sIGhhbmRsZV9zZWNfZXJyb3IsIFNlY3VyaXR5Q29uc3QKZnJvbSAuX2NvcmVfZm91bmRhdGlvbiBpbXBvcnQgQ29yZUZvdW5kYXRpb24sIGhhbmRsZV9jZl9lcnJvciwgQ0ZIZWxwZXJzCmZyb20gLi5fYXNuMSBpbXBvcnQgKAogICAgQ2VydGlmaWNhdGUgYXMgQXNuMUNlcnRpZmljYXRlLAogICAgaW50X3RvX2J5dGVzLAogICAgdGltZXpvbmUsCikKZnJvbSAuLl9lcnJvcnMgaW1wb3J0IHByZXR0eV9tZXNzYWdlCmZyb20gLi5fZmZpIGltcG9ydCAoCiAgICBhcnJheV9mcm9tX3BvaW50ZXIsCiAgICBhcnJheV9zZXQsCiAgICBidWZmZXJfZnJvbV9ieXRlcywKICAgIGJ5dGVzX2Zyb21fYnVmZmVyLAogICAgY2FsbGJhY2ssCiAgICBjYXN0LAogICAgZGVyZWYsCiAgICBuZXcsCiAgICBudWxsLAogICAgcG9pbnRlcl9zZXQsCiAgICBzaXplb2YsCiAgICBzdHJ1Y3QsCiAgICBzdHJ1Y3RfYnl0ZXMsCiAgICB1bndyYXAsCiAgICB3cml0ZV90b19idWZmZXIsCikKZnJvbSAuLl90eXBlcyBpbXBvcnQgdHlwZV9uYW1lLCBzdHJfY2xzLCBieXRlX2NscywgaW50X3R5cGVzCmZyb20gLi5fY2lwaGVyX3N1aXRlcyBpbXBvcnQgQ0lQSEVSX1NVSVRFX01BUApmcm9tIC51dGlsIGltcG9ydCByYW5kX2J5dGVzCmZyb20gLi5lcnJvcnMgaW1wb3J0IFRMU0Vycm9yLCBUTFNEaXNjb25uZWN0RXJyb3IsIFRMU0dyYWNlZnVsRGlzY29ubmVjdEVycm9yCmZyb20gLi5fdGxzIGltcG9ydCAoCiAgICBkZXRlY3RfY2xpZW50X2F1dGhfcmVxdWVzdCwKICAgIGRldGVjdF9vdGhlcl9wcm90b2NvbCwKICAgIGV4dHJhY3RfY2hhaW4sCiAgICBnZXRfZGhfcGFyYW1zX2xlbmd0aCwKICAgIHBhcnNlX3Nlc3Npb25faW5mbywKICAgIHJhaXNlX2NsaWVudF9hdXRoLAogICAgcmFpc2VfZGhfcGFyYW1zLAogICAgcmFpc2VfZGlzY29ubmVjdGlvbiwKICAgIHJhaXNlX2V4cGlyZWRfbm90X3lldF92YWxpZCwKICAgIHJhaXNlX2hhbmRzaGFrZSwKICAgIHJhaXNlX2hvc3RuYW1lLAogICAgcmFpc2VfbGlmZXRpbWVfdG9vX2xvbmcsCiAgICByYWlzZV9ub19pc3N1ZXIsCiAgICByYWlzZV9wcm90b2NvbF9lcnJvciwKICAgIHJhaXNlX3Byb3RvY29sX3ZlcnNpb24sCiAgICByYWlzZV9yZXZva2VkLAogICAgcmFpc2Vfc2VsZl9zaWduZWQsCiAgICByYWlzZV92ZXJpZmljYXRpb24sCiAgICByYWlzZV93ZWFrX3NpZ25hdHVyZSwKKQpmcm9tIC5hc3ltbWV0cmljIGltcG9ydCBsb2FkX2NlcnRpZmljYXRlLCBDZXJ0aWZpY2F0ZQpmcm9tIC4ua2V5cyBpbXBvcnQgcGFyc2VfY2VydGlmaWNhdGUKCmlmIHN5cy52ZXJzaW9uX2luZm8gPCAoMywpOgogICAgcmFuZ2UgPSB4cmFuZ2UgICMgbm9xYQoKaWYgc3lzLnZlcnNpb25faW5mbyA8ICgzLCA3KToKICAgIFBhdHRlcm4gPSByZS5fcGF0dGVybl90eXBlCmVsc2U6CiAgICBQYXR0ZXJuID0gcmUuUGF0dGVybgoKCl9fYWxsX18gPSBbCiAgICAnVExTU2Vzc2lvbicsCiAgICAnVExTU29ja2V0JywKXQoKCl9QUk9UT0NPTF9TVFJJTkdfQ09OU1RfTUFQID0gewogICAgJ1NTTHYyJzogU2VjdXJpdHlDb25zdC5rU1NMUHJvdG9jb2wyLAogICAgJ1NTTHYzJzogU2VjdXJpdHlDb25zdC5rU1NMUHJvdG9jb2wzLAogICAgJ1RMU3YxJzogU2VjdXJpdHlDb25zdC5rVExTUHJvdG9jb2wxLAogICAgJ1RMU3YxLjEnOiBTZWN1cml0eUNvbnN0LmtUTFNQcm90b2NvbDExLAogICAgJ1RMU3YxLjInOiBTZWN1cml0eUNvbnN0LmtUTFNQcm90b2NvbDEyLAp9CgpfUFJPVE9DT0xfQ09OU1RfU1RSSU5HX01BUCA9IHsKICAgIFNlY3VyaXR5Q29uc3Qua1NTTFByb3RvY29sMjogJ1NTTHYyJywKICAgIFNlY3VyaXR5Q29uc3Qua1NTTFByb3RvY29sMzogJ1NTTHYzJywKICAgIFNlY3VyaXR5Q29uc3Qua1RMU1Byb3RvY29sMTogJ1RMU3YxJywKICAgIFNlY3VyaXR5Q29uc3Qua1RMU1Byb3RvY29sMTE6ICdUTFN2MS4xJywKICAgIFNlY3VyaXR5Q29uc3Qua1RMU1Byb3RvY29sMTI6ICdUTFN2MS4yJywKfQoKX2xpbmVfcmVnZXggPSByZS5jb21waWxlKGInKFxyXG58XHJ8XG4pJykKX2NpcGhlcl9ibGFja2xpc3RfcmVnZXggPSByZS5jb21waWxlKCdhbm9ufFBTS3xTRUVEfFJDNHxNRDV8TlVMTHxDQU1FTExJQXxBUklBfFNSUHxLUkI1fEVYUE9SVHwoPzwhMylERVN8SURFQScpCl9jb25uZWN0aW9uX3JlZnMgPSB3ZWFrcmVmLldlYWtWYWx1ZURpY3Rpb25hcnkoKQpfc29ja2V0X3JlZnMgPSB7fQoKCmRlZiBfcmVhZF9jYWxsYmFjayhjb25uZWN0aW9uX2lkLCBkYXRhX2J1ZmZlciwgZGF0YV9sZW5ndGhfcG9pbnRlcik6CiAgICAiIiIKICAgIENhbGxiYWNrIGNhbGxlZCBieSBTZWN1cmUgVHJhbnNwb3J0IHRvIGFjdHVhbGx5IHJlYWQgdGhlIHNvY2tldAoKICAgIDpwYXJhbSBjb25uZWN0aW9uX2lkOgogICAgICAgIEFuIGludGVnZXIgaWRlbnRpZnlpbmcgdGhlIGNvbm5lY3Rpb24KCiAgICA6cGFyYW0gZGF0YV9idWZmZXI6CiAgICAgICAgQSBjaGFyIHBvaW50ZXIgRkZJIHR5cGUgdG8gd3JpdGUgdGhlIGRhdGEgdG8KCiAgICA6cGFyYW0gZGF0YV9sZW5ndGhfcG9pbnRlcjoKICAgICAgICBBIHNpemVfdCBwb2ludGVyIEZGSSB0eXBlIG9mIHRoZSBhbW91bnQgb2YgZGF0YSB0byByZWFkLiBXaWxsIGJlCiAgICAgICAgb3ZlcndyaXR0ZW4gd2l0aCB0aGUgYW1vdW50IG9mIGRhdGEgcmVhZCBvbiByZXR1cm4uCgogICAgOnJldHVybjoKICAgICAgICBBbiBpbnRlZ2VyIHN0YXR1cyBjb2RlIG9mIHRoZSByZXN1bHQgLSAwIGZvciBzdWNjZXNzCiAgICAiIiIKCiAgICBzZWxmID0gTm9uZQogICAgdHJ5OgogICAgICAgIHNlbGYgPSBfY29ubmVjdGlvbl9yZWZzLmdldChjb25uZWN0aW9uX2lkKQogICAgICAgIGlmIG5vdCBzZWxmOgogICAgICAgICAgICBzb2NrZXQgPSBfc29ja2V0X3JlZnMuZ2V0KGNvbm5lY3Rpb25faWQpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgc29ja2V0ID0gc2VsZi5fc29ja2V0CgogICAgICAgIGlmIG5vdCBzZWxmIGFuZCBub3Qgc29ja2V0OgogICAgICAgICAgICByZXR1cm4gMAoKICAgICAgICBieXRlc19yZXF1ZXN0ZWQgPSBkZXJlZihkYXRhX2xlbmd0aF9wb2ludGVyKQoKICAgICAgICB0aW1lb3V0ID0gc29ja2V0LmdldHRpbWVvdXQoKQogICAgICAgIGVycm9yID0gTm9uZQogICAgICAgIGRhdGEgPSBiJycKICAgICAgICB0cnk6CiAgICAgICAgICAgIHdoaWxlIGxlbihkYXRhKSA8IGJ5dGVzX3JlcXVlc3RlZDoKICAgICAgICAgICAgICAgICMgUHl0aG9uIDIgb24gVHJhdmlzIENJIHNlZW1zIHRvIGhhdmUgaXNzdWVzIHdpdGggYmxvY2tpbmcgb24KICAgICAgICAgICAgICAgICMgcmVjdigpIGZvciBsb25nZXIgdGhhbiB0aGUgc29ja2V0IHRpbWVvdXQgdmFsdWUsIHNvIHdlIHNlbGVjdAogICAgICAgICAgICAgICAgaWYgdGltZW91dCBpcyBub3QgTm9uZSBhbmQgdGltZW91dCA+IDAuMDoKICAgICAgICAgICAgICAgICAgICByZWFkX3JlYWR5LCBfLCBfID0gc2VsZWN0LnNlbGVjdChbc29ja2V0XSwgW10sIFtdLCB0aW1lb3V0KQogICAgICAgICAgICAgICAgICAgIGlmIGxlbihyZWFkX3JlYWR5KSA9PSAwOgogICAgICAgICAgICAgICAgICAgICAgICByYWlzZSBzb2NrZXRfLmVycm9yKGVycm5vLkVBR0FJTiwgJ3RpbWVkIG91dCcpCiAgICAgICAgICAgICAgICBjaHVuayA9IHNvY2tldC5yZWN2KGJ5dGVzX3JlcXVlc3RlZCAtIGxlbihkYXRhKSkKICAgICAgICAgICAgICAgIGRhdGEgKz0gY2h1bmsKICAgICAgICAgICAgICAgIGlmIGNodW5rID09IGInJzoKICAgICAgICAgICAgICAgICAgICBpZiBsZW4oZGF0YSkgPT0gMDoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgdGltZW91dCBpcyBOb25lOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFNlY3VyaXR5Q29uc3QuZXJyU1NMQ2xvc2VkTm9Ob3RpZnkKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFNlY3VyaXR5Q29uc3QuZXJyU1NMQ2xvc2VkQWJvcnQKICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgIGV4Y2VwdCAoc29ja2V0Xy5lcnJvcikgYXMgZToKICAgICAgICAgICAgZXJyb3IgPSBlLmVycm5vCgogICAgICAgIGlmIGVycm9yIGlzIG5vdCBOb25lIGFuZCBlcnJvciAhPSBlcnJuby5FQUdBSU46CiAgICAgICAgICAgIGlmIGVycm9yID09IGVycm5vLkVDT05OUkVTRVQgb3IgZXJyb3IgPT0gZXJybm8uRVBJUEU6CiAgICAgICAgICAgICAgICByZXR1cm4gU2VjdXJpdHlDb25zdC5lcnJTU0xDbG9zZWROb05vdGlmeQogICAgICAgICAgICByZXR1cm4gU2VjdXJpdHlDb25zdC5lcnJTU0xDbG9zZWRBYm9ydAoKICAgICAgICBpZiBzZWxmIGFuZCBub3Qgc2VsZi5fZG9uZV9oYW5kc2hha2U6CiAgICAgICAgICAgICMgU2VjdXJlVHJhbnNwb3J0IGRvZXNuJ3QgYm90aGVyIHRvIGNoZWNrIGlmIHRoZSBUTFMgcmVjb3JkIGhlYWRlcgogICAgICAgICAgICAjIGlzIHZhbGlkIGJlZm9yZSBhc2tpbmcgdG8gcmVhZCBtb3JlIGRhdGEsIHdoaWNoIGNhbiByZXN1bHQgaW4KICAgICAgICAgICAgIyBjb25uZWN0aW9uIGhhbmdzLiBIZXJlIHdlIGRvIGJhc2ljIGNoZWNrcyB0byBnZXQgYXJvdW5kIHRoZSBpc3N1ZS4KICAgICAgICAgICAgaWYgbGVuKGRhdGEpID49IDMgYW5kIGxlbihzZWxmLl9zZXJ2ZXJfaGVsbG8pID09IDA6CiAgICAgICAgICAgICAgICAjIENoZWNrIHRvIGVuc3VyZSBpdCBpcyBhbiBhbGVydCBvciBoYW5kc2hha2UgZmlyc3QKICAgICAgICAgICAgICAgIHZhbGlkX3JlY29yZF90eXBlID0gZGF0YVswOjFdIGluIHNldChbYidceDE1JywgYidceDE2J10pCiAgICAgICAgICAgICAgICAjIENoZWNrIGlmIHRoZSBwcm90b2NvbCB2ZXJzaW9uIGlzIFNTTCAzLjAgb3IgVExTIDEuMC0xLjMKICAgICAgICAgICAgICAgIHZhbGlkX3Byb3RvY29sX3ZlcnNpb24gPSBkYXRhWzE6M10gaW4gc2V0KFsKICAgICAgICAgICAgICAgICAgICBiJ1x4MDNceDAwJywKICAgICAgICAgICAgICAgICAgICBiJ1x4MDNceDAxJywKICAgICAgICAgICAgICAgICAgICBiJ1x4MDNceDAyJywKICAgICAgICAgICAgICAgICAgICBiJ1x4MDNceDAzJywKICAgICAgICAgICAgICAgICAgICBiJ1x4MDNceDA0JwogICAgICAgICAgICAgICAgXSkKICAgICAgICAgICAgICAgIGlmIG5vdCB2YWxpZF9yZWNvcmRfdHlwZSBvciBub3QgdmFsaWRfcHJvdG9jb2xfdmVyc2lvbjoKICAgICAgICAgICAgICAgICAgICBzZWxmLl9zZXJ2ZXJfaGVsbG8gKz0gZGF0YSArIF9yZWFkX3JlbWFpbmluZyhzb2NrZXQpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFNlY3VyaXR5Q29uc3QuZXJyU1NMUHJvdG9jb2wKICAgICAgICAgICAgc2VsZi5fc2VydmVyX2hlbGxvICs9IGRhdGEKCiAgICAgICAgd3JpdGVfdG9fYnVmZmVyKGRhdGFfYnVmZmVyLCBkYXRhKQogICAgICAgIHBvaW50ZXJfc2V0KGRhdGFfbGVuZ3RoX3BvaW50ZXIsIGxlbihkYXRhKSkKCiAgICAgICAgaWYgbGVuKGRhdGEpICE9IGJ5dGVzX3JlcXVlc3RlZDoKICAgICAgICAgICAgcmV0dXJuIFNlY3VyaXR5Q29uc3QuZXJyU1NMV291bGRCbG9jawoKICAgICAgICByZXR1cm4gMAogICAgZXhjZXB0IChLZXlib2FyZEludGVycnVwdCkgYXMgZToKICAgICAgICBpZiBzZWxmOgogICAgICAgICAgICBzZWxmLl9leGNlcHRpb24gPSBlCiAgICAgICAgcmV0dXJuIFNlY3VyaXR5Q29uc3QuZXJyU1NMQ2xvc2VkQWJvcnQKCgpkZWYgX3JlYWRfcmVtYWluaW5nKHNvY2tldCk6CiAgICAiIiIKICAgIFJlYWRzIGV2ZXJ5dGhpbmcgYXZhaWxhYmxlIGZyb20gdGhlIHNvY2tldCAtIHVzZWQgZm9yIGRlYnVnZ2luZyB3aGVuIHRoZXJlCiAgICBpcyBhIHByb3RvY29sIGVycm9yCgogICAgOnBhcmFtIHNvY2tldDoKICAgICAgICBUaGUgc29ja2V0IHRvIHJlYWQgZnJvbQoKICAgIDpyZXR1cm46CiAgICAgICAgQSBieXRlIHN0cmluZyBvZiB0aGUgcmVtYWluaW5nIGRhdGEKICAgICIiIgoKICAgIG91dHB1dCA9IGInJwogICAgb2xkX3RpbWVvdXQgPSBzb2NrZXQuZ2V0dGltZW91dCgpCiAgICB0cnk6CiAgICAgICAgc29ja2V0LnNldHRpbWVvdXQoMC4wKQogICAgICAgIG91dHB1dCArPSBzb2NrZXQucmVjdig4MTkyKQogICAgZXhjZXB0IChzb2NrZXRfLmVycm9yKToKICAgICAgICBwYXNzCiAgICBmaW5hbGx5OgogICAgICAgIHNvY2tldC5zZXR0aW1lb3V0KG9sZF90aW1lb3V0KQogICAgcmV0dXJuIG91dHB1dAoKCmRlZiBfd3JpdGVfY2FsbGJhY2soY29ubmVjdGlvbl9pZCwgZGF0YV9idWZmZXIsIGRhdGFfbGVuZ3RoX3BvaW50ZXIpOgogICAgIiIiCiAgICBDYWxsYmFjayBjYWxsZWQgYnkgU2VjdXJlIFRyYW5zcG9ydCB0byBhY3R1YWxseSB3cml0ZSB0byB0aGUgc29ja2V0CgogICAgOnBhcmFtIGNvbm5lY3Rpb25faWQ6CiAgICAgICAgQW4gaW50ZWdlciBpZGVudGlmeWluZyB0aGUgY29ubmVjdGlvbgoKICAgIDpwYXJhbSBkYXRhX2J1ZmZlcjoKICAgICAgICBBIGNoYXIgcG9pbnRlciBGRkkgdHlwZSBjb250YWluaW5nIHRoZSBkYXRhIHRvIHdyaXRlCgogICAgOnBhcmFtIGRhdGFfbGVuZ3RoX3BvaW50ZXI6CiAgICAgICAgQSBzaXplX3QgcG9pbnRlciBGRkkgdHlwZSBvZiB0aGUgYW1vdW50IG9mIGRhdGEgdG8gd3JpdGUuIFdpbGwgYmUKICAgICAgICBvdmVyd3JpdHRlbiB3aXRoIHRoZSBhbW91bnQgb2YgZGF0YSBhY3R1YWxseSB3cml0dGVuIG9uIHJldHVybi4KCiAgICA6cmV0dXJuOgogICAgICAgIEFuIGludGVnZXIgc3RhdHVzIGNvZGUgb2YgdGhlIHJlc3VsdCAtIDAgZm9yIHN1Y2Nlc3MKICAgICIiIgoKICAgIHRyeToKICAgICAgICBzZWxmID0gX2Nvbm5lY3Rpb25fcmVmcy5nZXQoY29ubmVjdGlvbl9pZCkKICAgICAgICBpZiBub3Qgc2VsZjoKICAgICAgICAgICAgc29ja2V0ID0gX3NvY2tldF9yZWZzLmdldChjb25uZWN0aW9uX2lkKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHNvY2tldCA9IHNlbGYuX3NvY2tldAoKICAgICAgICBpZiBub3Qgc2VsZiBhbmQgbm90IHNvY2tldDoKICAgICAgICAgICAgcmV0dXJuIDAKCiAgICAgICAgZGF0YV9sZW5ndGggPSBkZXJlZihkYXRhX2xlbmd0aF9wb2ludGVyKQogICAgICAgIGRhdGEgPSBieXRlc19mcm9tX2J1ZmZlcihkYXRhX2J1ZmZlciwgZGF0YV9sZW5ndGgpCgogICAgICAgIGlmIHNlbGYgYW5kIG5vdCBzZWxmLl9kb25lX2hhbmRzaGFrZToKICAgICAgICAgICAgc2VsZi5fY2xpZW50X2hlbGxvICs9IGRhdGEKCiAgICAgICAgZXJyb3IgPSBOb25lCiAgICAgICAgdHJ5OgogICAgICAgICAgICBzZW50ID0gc29ja2V0LnNlbmQoZGF0YSkKICAgICAgICBleGNlcHQgKHNvY2tldF8uZXJyb3IpIGFzIGU6CiAgICAgICAgICAgIGVycm9yID0gZS5lcnJubwoKICAgICAgICBpZiBlcnJvciBpcyBub3QgTm9uZSBhbmQgZXJyb3IgIT0gZXJybm8uRUFHQUlOOgogICAgICAgICAgICBpZiBlcnJvciA9PSBlcnJuby5FQ09OTlJFU0VUIG9yIGVycm9yID09IGVycm5vLkVQSVBFOgogICAgICAgICAgICAgICAgcmV0dXJuIFNlY3VyaXR5Q29uc3QuZXJyU1NMQ2xvc2VkTm9Ob3RpZnkKICAgICAgICAgICAgcmV0dXJuIFNlY3VyaXR5Q29uc3QuZXJyU1NMQ2xvc2VkQWJvcnQKCiAgICAgICAgaWYgc2VudCAhPSBkYXRhX2xlbmd0aDoKICAgICAgICAgICAgcG9pbnRlcl9zZXQoZGF0YV9sZW5ndGhfcG9pbnRlciwgc2VudCkKICAgICAgICAgICAgcmV0dXJuIFNlY3VyaXR5Q29uc3QuZXJyU1NMV291bGRCbG9jawoKICAgICAgICByZXR1cm4gMAogICAgZXhjZXB0IChLZXlib2FyZEludGVycnVwdCkgYXMgZToKICAgICAgICBzZWxmLl9leGNlcHRpb24gPSBlCiAgICAgICAgcmV0dXJuIFNlY3VyaXR5Q29uc3QuZXJyU1NMUGVlclVzZXJDYW5jZWxsZWQKCgpfcmVhZF9jYWxsYmFja19wb2ludGVyID0gY2FsbGJhY2soU2VjdXJpdHksICdTU0xSZWFkRnVuYycsIF9yZWFkX2NhbGxiYWNrKQpfd3JpdGVfY2FsbGJhY2tfcG9pbnRlciA9IGNhbGxiYWNrKFNlY3VyaXR5LCAnU1NMV3JpdGVGdW5jJywgX3dyaXRlX2NhbGxiYWNrKQoKCmNsYXNzIFRMU1Nlc3Npb24ob2JqZWN0KToKICAgICIiIgogICAgQSBUTFMgc2Vzc2lvbiBvYmplY3QgdGhhdCBtdWx0aXBsZSBUTFNTb2NrZXQgb2JqZWN0cyBjYW4gc2hhcmUgZm9yIHRoZQogICAgc2FrZSBvZiBzZXNzaW9uIHJldXNlCiAgICAiIiIKCiAgICBfcHJvdG9jb2xzID0gTm9uZQogICAgX2NpcGhlcnMgPSBOb25lCiAgICBfbWFudWFsX3ZhbGlkYXRpb24gPSBOb25lCiAgICBfZXh0cmFfdHJ1c3Rfcm9vdHMgPSBOb25lCiAgICBfcGVlcl9pZCA9IE5vbmUKCiAgICBkZWYgX19pbml0X18oc2VsZiwgcHJvdG9jb2w9Tm9uZSwgbWFudWFsX3ZhbGlkYXRpb249RmFsc2UsIGV4dHJhX3RydXN0X3Jvb3RzPU5vbmUpOgogICAgICAgICIiIgogICAgICAgIDpwYXJhbSBwcm90b2NvbDoKICAgICAgICAgICAgQSB1bmljb2RlIHN0cmluZyBvciBzZXQgb2YgdW5pY29kZSBzdHJpbmdzIHJlcHJlc2VudGluZyBhbGxvd2FibGUKICAgICAgICAgICAgcHJvdG9jb2xzIHRvIG5lZ290aWF0ZSB3aXRoIHRoZSBzZXJ2ZXI6CgogICAgICAgICAgICAgLSAiVExTdjEuMiIKICAgICAgICAgICAgIC0gIlRMU3YxLjEiCiAgICAgICAgICAgICAtICJUTFN2MSIKICAgICAgICAgICAgIC0gIlNTTHYzIgoKICAgICAgICAgICAgRGVmYXVsdCBpczogeyJUTFN2MSIsICJUTFN2MS4xIiwgIlRMU3YxLjIifQoKICAgICAgICA6cGFyYW0gbWFudWFsX3ZhbGlkYXRpb246CiAgICAgICAgICAgIElmIGNlcnRpZmljYXRlIGFuZCBjZXJ0aWZpY2F0ZSBwYXRoIHZhbGlkYXRpb24gc2hvdWxkIGJlIHNraXBwZWQKICAgICAgICAgICAgYW5kIGxlZnQgdG8gdGhlIGRldmVsb3BlciB0byBpbXBsZW1lbnQKCiAgICAgICAgOnBhcmFtIGV4dHJhX3RydXN0X3Jvb3RzOgogICAgICAgICAgICBBIGxpc3QgY29udGFpbmluZyBvbmUgb3IgbW9yZSBjZXJ0aWZpY2F0ZXMgdG8gYmUgdHJlYXRlZCBhcyB0cnVzdAogICAgICAgICAgICByb290cywgaW4gb25lIG9mIHRoZSBmb2xsb3dpbmcgZm9ybWF0czoKICAgICAgICAgICAgIC0gQSBieXRlIHN0cmluZyBvZiB0aGUgREVSIGVuY29kZWQgY2VydGlmaWNhdGUKICAgICAgICAgICAgIC0gQSB1bmljb2RlIHN0cmluZyBvZiB0aGUgY2VydGlmaWNhdGUgZmlsZW5hbWUKICAgICAgICAgICAgIC0gQW4gYXNuMWNyeXB0by54NTA5LkNlcnRpZmljYXRlIG9iamVjdAogICAgICAgICAgICAgLSBBbiBvc2NyeXB0by5hc3ltbWV0cmljLkNlcnRpZmljYXRlIG9iamVjdAoKICAgICAgICA6cmFpc2VzOgogICAgICAgICAgICBWYWx1ZUVycm9yIC0gd2hlbiBhbnkgb2YgdGhlIHBhcmFtZXRlcnMgY29udGFpbiBhbiBpbnZhbGlkIHZhbHVlCiAgICAgICAgICAgIFR5cGVFcnJvciAtIHdoZW4gYW55IG9mIHRoZSBwYXJhbWV0ZXJzIGFyZSBvZiB0aGUgd3JvbmcgdHlwZQogICAgICAgICAgICBPU0Vycm9yIC0gd2hlbiBhbiBlcnJvciBpcyByZXR1cm5lZCBieSB0aGUgT1MgY3J5cHRvIGxpYnJhcnkKICAgICAgICAiIiIKCiAgICAgICAgaWYgbm90IGlzaW5zdGFuY2UobWFudWFsX3ZhbGlkYXRpb24sIGJvb2wpOgogICAgICAgICAgICByYWlzZSBUeXBlRXJyb3IocHJldHR5X21lc3NhZ2UoCiAgICAgICAgICAgICAgICAnJycKICAgICAgICAgICAgICAgIG1hbnVhbF92YWxpZGF0aW9uIG11c3QgYmUgYSBib29sZWFuLCBub3QgJXMKICAgICAgICAgICAgICAgICcnJywKICAgICAgICAgICAgICAgIHR5cGVfbmFtZShtYW51YWxfdmFsaWRhdGlvbikKICAgICAgICAgICAgKSkKCiAgICAgICAgc2VsZi5fbWFudWFsX3ZhbGlkYXRpb24gPSBtYW51YWxfdmFsaWRhdGlvbgoKICAgICAgICBpZiBwcm90b2NvbCBpcyBOb25lOgogICAgICAgICAgICBwcm90b2NvbCA9IHNldChbJ1RMU3YxJywgJ1RMU3YxLjEnLCAnVExTdjEuMiddKQoKICAgICAgICBpZiBpc2luc3RhbmNlKHByb3RvY29sLCBzdHJfY2xzKToKICAgICAgICAgICAgcHJvdG9jb2wgPSBzZXQoW3Byb3RvY29sXSkKICAgICAgICBlbGlmIG5vdCBpc2luc3RhbmNlKHByb3RvY29sLCBzZXQpOgogICAgICAgICAgICByYWlzZSBUeXBlRXJyb3IocHJldHR5X21lc3NhZ2UoCiAgICAgICAgICAgICAgICAnJycKICAgICAgICAgICAgICAgIHByb3RvY29sIG11c3QgYmUgYSB1bmljb2RlIHN0cmluZyBvciBzZXQgb2YgdW5pY29kZSBzdHJpbmdzLAogICAgICAgICAgICAgICAgbm90ICVzCiAgICAgICAgICAgICAgICAnJycsCiAgICAgICAgICAgICAgICB0eXBlX25hbWUocHJvdG9jb2wpCiAgICAgICAgICAgICkpCgogICAgICAgIHVuc3VwcG9ydGVkX3Byb3RvY29scyA9IHByb3RvY29sIC0gc2V0KFsnU1NMdjMnLCAnVExTdjEnLCAnVExTdjEuMScsICdUTFN2MS4yJ10pCiAgICAgICAgaWYgdW5zdXBwb3J0ZWRfcHJvdG9jb2xzOgogICAgICAgICAgICByYWlzZSBWYWx1ZUVycm9yKHByZXR0eV9tZXNzYWdlKAogICAgICAgICAgICAgICAgJycnCiAgICAgICAgICAgICAgICBwcm90b2NvbCBtdXN0IGNvbnRhaW4gb25seSB0aGUgdW5pY29kZSBzdHJpbmdzICJTU0x2MyIsICJUTFN2MSIsCiAgICAgICAgICAgICAgICAiVExTdjEuMSIsICJUTFN2MS4yIiwgbm90ICVzCiAgICAgICAgICAgICAgICAnJycsCiAgICAgICAgICAgICAgICByZXByKHVuc3VwcG9ydGVkX3Byb3RvY29scykKICAgICAgICAgICAgKSkKCiAgICAgICAgc2VsZi5fcHJvdG9jb2xzID0gcHJvdG9jb2wKCiAgICAgICAgc2VsZi5fZXh0cmFfdHJ1c3Rfcm9vdHMgPSBbXQogICAgICAgIGlmIGV4dHJhX3RydXN0X3Jvb3RzOgogICAgICAgICAgICBmb3IgZXh0cmFfdHJ1c3Rfcm9vdCBpbiBleHRyYV90cnVzdF9yb290czoKICAgICAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UoZXh0cmFfdHJ1c3Rfcm9vdCwgQ2VydGlmaWNhdGUpOgogICAgICAgICAgICAgICAgICAgIGV4dHJhX3RydXN0X3Jvb3QgPSBleHRyYV90cnVzdF9yb290LmFzbjEKICAgICAgICAgICAgICAgIGVsaWYgaXNpbnN0YW5jZShleHRyYV90cnVzdF9yb290LCBieXRlX2Nscyk6CiAgICAgICAgICAgICAgICAgICAgZXh0cmFfdHJ1c3Rfcm9vdCA9IHBhcnNlX2NlcnRpZmljYXRlKGV4dHJhX3RydXN0X3Jvb3QpCiAgICAgICAgICAgICAgICBlbGlmIGlzaW5zdGFuY2UoZXh0cmFfdHJ1c3Rfcm9vdCwgc3RyX2Nscyk6CiAgICAgICAgICAgICAgICAgICAgd2l0aCBvcGVuKGV4dHJhX3RydXN0X3Jvb3QsICdyYicpIGFzIGY6CiAgICAgICAgICAgICAgICAgICAgICAgIGV4dHJhX3RydXN0X3Jvb3QgPSBwYXJzZV9jZXJ0aWZpY2F0ZShmLnJlYWQoKSkKICAgICAgICAgICAgICAgIGVsaWYgbm90IGlzaW5zdGFuY2UoZXh0cmFfdHJ1c3Rfcm9vdCwgQXNuMUNlcnRpZmljYXRlKToKICAgICAgICAgICAgICAgICAgICByYWlzZSBUeXBlRXJyb3IocHJldHR5X21lc3NhZ2UoCiAgICAgICAgICAgICAgICAgICAgICAgICcnJwogICAgICAgICAgICAgICAgICAgICAgICBleHRyYV90cnVzdF9yb290cyBtdXN0IGJlIGEgbGlzdCBvZiBieXRlIHN0cmluZ3MsIHVuaWNvZGUKICAgICAgICAgICAgICAgICAgICAgICAgc3RyaW5ncywgYXNuMWNyeXB0by54NTA5LkNlcnRpZmljYXRlIG9iamVjdHMgb3IKICAgICAgICAgICAgICAgICAgICAgICAgb3NjcnlwdG8uYXN5bW1ldHJpYy5DZXJ0aWZpY2F0ZSBvYmplY3RzLCBub3QgJXMKICAgICAgICAgICAgICAgICAgICAgICAgJycnLAogICAgICAgICAgICAgICAgICAgICAgICB0eXBlX25hbWUoZXh0cmFfdHJ1c3Rfcm9vdCkKICAgICAgICAgICAgICAgICAgICApKQogICAgICAgICAgICAgICAgc2VsZi5fZXh0cmFfdHJ1c3Rfcm9vdHMuYXBwZW5kKGV4dHJhX3RydXN0X3Jvb3QpCgogICAgICAgIHNlbGYuX3BlZXJfaWQgPSByYW5kX2J5dGVzKDgpCgoKY2xhc3MgVExTU29ja2V0KG9iamVjdCk6CiAgICAiIiIKICAgIEEgd3JhcHBlciBhcm91bmQgYSBzb2NrZXQuc29ja2V0IHRoYXQgYWRkcyBUTFMKICAgICIiIgoKICAgIF9zb2NrZXQgPSBOb25lCiAgICBfc2Vzc2lvbiA9IE5vbmUKICAgIF9leGNlcHRpb24gPSBOb25lCgogICAgX3Nlc3Npb25fY29udGV4dCA9IE5vbmUKCiAgICBfZGVjcnlwdGVkX2J5dGVzID0gTm9uZQoKICAgIF9ob3N0bmFtZSA9IE5vbmUKCiAgICBfY2VydGlmaWNhdGUgPSBOb25lCiAgICBfaW50ZXJtZWRpYXRlcyA9IE5vbmUKCiAgICBfcHJvdG9jb2wgPSBOb25lCiAgICBfY2lwaGVyX3N1aXRlID0gTm9uZQogICAgX2NvbXByZXNzaW9uID0gTm9uZQogICAgX3Nlc3Npb25faWQgPSBOb25lCiAgICBfc2Vzc2lvbl90aWNrZXQgPSBOb25lCgogICAgX2RvbmVfaGFuZHNoYWtlID0gTm9uZQogICAgX3NlcnZlcl9oZWxsbyA9IE5vbmUKICAgIF9jbGllbnRfaGVsbG8gPSBOb25lCgogICAgX2xvY2FsX2Nsb3NlZCA9IEZhbHNlCiAgICBfZ3JhY2VmdWxseV9jbG9zZWQgPSBGYWxzZQoKICAgIF9jb25uZWN0aW9uX2lkID0gTm9uZQoKICAgIEBjbGFzc21ldGhvZAogICAgZGVmIHdyYXAoY2xzLCBzb2NrZXQsIGhvc3RuYW1lLCBzZXNzaW9uPU5vbmUpOgogICAgICAgICIiIgogICAgICAgIFRha2VzIGFuIGV4aXN0aW5nIHNvY2tldCBhbmQgYWRkcyBUTFMKCiAgICAgICAgOnBhcmFtIHNvY2tldDoKICAgICAgICAgICAgQSBzb2NrZXQuc29ja2V0IG9iamVjdCB0byB3cmFwIHdpdGggVExTCgogICAgICAgIDpwYXJhbSBob3N0bmFtZToKICAgICAgICAgICAgQSB1bmljb2RlIHN0cmluZyBvZiB0aGUgaG9zdG5hbWUgb3IgSVAgdGhlIHNvY2tldCBpcyBjb25uZWN0ZWQgdG8KCiAgICAgICAgOnBhcmFtIHNlc3Npb246CiAgICAgICAgICAgIEFuIGV4aXN0aW5nIFRMU1Nlc3Npb24gb2JqZWN0IHRvIGFsbG93IGZvciBzZXNzaW9uIHJldXNlLCBzcGVjaWZpYwogICAgICAgICAgICBwcm90b2NvbCBvciBtYW51YWwgY2VydGlmaWNhdGUgdmFsaWRhdGlvbgoKICAgICAgICA6cmFpc2VzOgogICAgICAgICAgICBWYWx1ZUVycm9yIC0gd2hlbiBhbnkgb2YgdGhlIHBhcmFtZXRlcnMgY29udGFpbiBhbiBpbnZhbGlkIHZhbHVlCiAgICAgICAgICAgIFR5cGVFcnJvciAtIHdoZW4gYW55IG9mIHRoZSBwYXJhbWV0ZXJzIGFyZSBvZiB0aGUgd3JvbmcgdHlwZQogICAgICAgICAgICBPU0Vycm9yIC0gd2hlbiBhbiBlcnJvciBpcyByZXR1cm5lZCBieSB0aGUgT1MgY3J5cHRvIGxpYnJhcnkKICAgICAgICAiIiIKCiAgICAgICAgaWYgbm90IGlzaW5zdGFuY2Uoc29ja2V0LCBzb2NrZXRfLnNvY2tldCk6CiAgICAgICAgICAgIHJhaXNlIFR5cGVFcnJvcihwcmV0dHlfbWVzc2FnZSgKICAgICAgICAgICAgICAgICcnJwogICAgICAgICAgICAgICAgc29ja2V0IG11c3QgYmUgYW4gaW5zdGFuY2Ugb2Ygc29ja2V0LnNvY2tldCwgbm90ICVzCiAgICAgICAgICAgICAgICAnJycsCiAgICAgICAgICAgICAgICB0eXBlX25hbWUoc29ja2V0KQogICAgICAgICAgICApKQoKICAgICAgICBpZiBub3QgaXNpbnN0YW5jZShob3N0bmFtZSwgc3RyX2Nscyk6CiAgICAgICAgICAgIHJhaXNlIFR5cGVFcnJvcihwcmV0dHlfbWVzc2FnZSgKICAgICAgICAgICAgICAgICcnJwogICAgICAgICAgICAgICAgaG9zdG5hbWUgbXVzdCBiZSBhIHVuaWNvZGUgc3RyaW5nLCBub3QgJXMKICAgICAgICAgICAgICAgICcnJywKICAgICAgICAgICAgICAgIHR5cGVfbmFtZShob3N0bmFtZSkKICAgICAgICAgICAgKSkKCiAgICAgICAgaWYgc2Vzc2lvbiBpcyBub3QgTm9uZSBhbmQgbm90IGlzaW5zdGFuY2Uoc2Vzc2lvbiwgVExTU2Vzc2lvbik6CiAgICAgICAgICAgIHJhaXNlIFR5cGVFcnJvcihwcmV0dHlfbWVzc2FnZSgKICAgICAgICAgICAgICAgICcnJwogICAgICAgICAgICAgICAgc2Vzc2lvbiBtdXN0IGJlIGFuIGluc3RhbmNlIG9mIG9zY3J5cHRvLnRscy5UTFNTZXNzaW9uLCBub3QgJXMKICAgICAgICAgICAgICAgICcnJywKICAgICAgICAgICAgICAgIHR5cGVfbmFtZShzZXNzaW9uKQogICAgICAgICAgICApKQoKICAgICAgICBuZXdfc29ja2V0ID0gY2xzKE5vbmUsIE5vbmUsIHNlc3Npb249c2Vzc2lvbikKICAgICAgICBuZXdfc29ja2V0Ll9zb2NrZXQgPSBzb2NrZXQKICAgICAgICBuZXdfc29ja2V0Ll9ob3N0bmFtZSA9IGhvc3RuYW1lCiAgICAgICAgbmV3X3NvY2tldC5faGFuZHNoYWtlKCkKCiAgICAgICAgcmV0dXJuIG5ld19zb2NrZXQKCiAgICBkZWYgX19pbml0X18oc2VsZiwgYWRkcmVzcywgcG9ydCwgdGltZW91dD0xMCwgc2Vzc2lvbj1Ob25lKToKICAgICAgICAiIiIKICAgICAgICA6cGFyYW0gYWRkcmVzczoKICAgICAgICAgICAgQSB1bmljb2RlIHN0cmluZyBvZiB0aGUgZG9tYWluIG5hbWUgb3IgSVAgYWRkcmVzcyB0byBjb25uZWN0IHRvCgogICAgICAgIDpwYXJhbSBwb3J0OgogICAgICAgICAgICBBbiBpbnRlZ2VyIG9mIHRoZSBwb3J0IG51bWJlciB0byBjb25uZWN0IHRvCgogICAgICAgIDpwYXJhbSB0aW1lb3V0OgogICAgICAgICAgICBBbiBpbnRlZ2VyIHRpbWVvdXQgdG8gdXNlIGZvciB0aGUgc29ja2V0CgogICAgICAgIDpwYXJhbSBzZXNzaW9uOgogICAgICAgICAgICBBbiBvc2NyeXB0by50bHMuVExTU2Vzc2lvbiBvYmplY3QgdG8gYWxsb3cgZm9yIHNlc3Npb24gcmV1c2UgYW5kCiAgICAgICAgICAgIGNvbnRyb2xsaW5nIHRoZSBwcm90b2NvbHMgYW5kIHZhbGlkYXRpb24gcGVyZm9ybWVkCiAgICAgICAgIiIiCgogICAgICAgIHNlbGYuX2RvbmVfaGFuZHNoYWtlID0gRmFsc2UKICAgICAgICBzZWxmLl9zZXJ2ZXJfaGVsbG8gPSBiJycKICAgICAgICBzZWxmLl9jbGllbnRfaGVsbG8gPSBiJycKCiAgICAgICAgc2VsZi5fZGVjcnlwdGVkX2J5dGVzID0gYicnCgogICAgICAgIGlmIGFkZHJlc3MgaXMgTm9uZSBhbmQgcG9ydCBpcyBOb25lOgogICAgICAgICAgICBzZWxmLl9zb2NrZXQgPSBOb25lCgogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGlmIG5vdCBpc2luc3RhbmNlKGFkZHJlc3MsIHN0cl9jbHMpOgogICAgICAgICAgICAgICAgcmFpc2UgVHlwZUVycm9yKHByZXR0eV9tZXNzYWdlKAogICAgICAgICAgICAgICAgICAgICcnJwogICAgICAgICAgICAgICAgICAgIGFkZHJlc3MgbXVzdCBiZSBhIHVuaWNvZGUgc3RyaW5nLCBub3QgJXMKICAgICAgICAgICAgICAgICAgICAnJycsCiAgICAgICAgICAgICAgICAgICAgdHlwZV9uYW1lKGFkZHJlc3MpCiAgICAgICAgICAgICAgICApKQoKICAgICAgICAgICAgaWYgbm90IGlzaW5zdGFuY2UocG9ydCwgaW50X3R5cGVzKToKICAgICAgICAgICAgICAgIHJhaXNlIFR5cGVFcnJvcihwcmV0dHlfbWVzc2FnZSgKICAgICAgICAgICAgICAgICAgICAnJycKICAgICAgICAgICAgICAgICAgICBwb3J0IG11c3QgYmUgYW4gaW50ZWdlciwgbm90ICVzCiAgICAgICAgICAgICAgICAgICAgJycnLAogICAgICAgICAgICAgICAgICAgIHR5cGVfbmFtZShwb3J0KQogICAgICAgICAgICAgICAgKSkKCiAgICAgICAgICAgIGlmIHRpbWVvdXQgaXMgbm90IE5vbmUgYW5kIG5vdCBpc2luc3RhbmNlKHRpbWVvdXQsIG51bWJlcnMuTnVtYmVyKToKICAgICAgICAgICAgICAgIHJhaXNlIFR5cGVFcnJvcihwcmV0dHlfbWVzc2FnZSgKICAgICAgICAgICAgICAgICAgICAnJycKICAgICAgICAgICAgICAgICAgICB0aW1lb3V0IG11c3QgYmUgYSBudW1iZXIsIG5vdCAlcwogICAgICAgICAgICAgICAgICAgICcnJywKICAgICAgICAgICAgICAgICAgICB0eXBlX25hbWUodGltZW91dCkKICAgICAgICAgICAgICAgICkpCgogICAgICAgICAgICBzZWxmLl9zb2NrZXQgPSBzb2NrZXRfLmNyZWF0ZV9jb25uZWN0aW9uKChhZGRyZXNzLCBwb3J0KSwgdGltZW91dCkKICAgICAgICAgICAgc2VsZi5fc29ja2V0LnNldHRpbWVvdXQodGltZW91dCkKCiAgICAgICAgaWYgc2Vzc2lvbiBpcyBOb25lOgogICAgICAgICAgICBzZXNzaW9uID0gVExTU2Vzc2lvbigpCgogICAgICAgIGVsaWYgbm90IGlzaW5zdGFuY2Uoc2Vzc2lvbiwgVExTU2Vzc2lvbik6CiAgICAgICAgICAgIHJhaXNlIFR5cGVFcnJvcihwcmV0dHlfbWVzc2FnZSgKICAgICAgICAgICAgICAgICcnJwogICAgICAgICAgICAgICAgc2Vzc2lvbiBtdXN0IGJlIGFuIGluc3RhbmNlIG9mIG9zY3J5cHRvLnRscy5UTFNTZXNzaW9uLCBub3QgJXMKICAgICAgICAgICAgICAgICcnJywKICAgICAgICAgICAgICAgIHR5cGVfbmFtZShzZXNzaW9uKQogICAgICAgICAgICApKQoKICAgICAgICBzZWxmLl9zZXNzaW9uID0gc2Vzc2lvbgoKICAgICAgICBpZiBzZWxmLl9zb2NrZXQ6CiAgICAgICAgICAgIHNlbGYuX2hvc3RuYW1lID0gYWRkcmVzcwogICAgICAgICAgICBzZWxmLl9oYW5kc2hha2UoKQoKICAgIGRlZiBfaGFuZHNoYWtlKHNlbGYpOgogICAgICAgICIiIgogICAgICAgIFBlcmZvcm0gYW4gaW5pdGlhbCBUTFMgaGFuZHNoYWtlCiAgICAgICAgIiIiCgogICAgICAgIHNlc3Npb25fY29udGV4dCA9IE5vbmUKICAgICAgICBzc2xfcG9saWN5X3JlZiA9IE5vbmUKICAgICAgICBjcmxfc2VhcmNoX3JlZiA9IE5vbmUKICAgICAgICBjcmxfcG9saWN5X3JlZiA9IE5vbmUKICAgICAgICBvY3NwX3NlYXJjaF9yZWYgPSBOb25lCiAgICAgICAgb2NzcF9wb2xpY3lfcmVmID0gTm9uZQogICAgICAgIHBvbGljeV9hcnJheV9yZWYgPSBOb25lCiAgICAgICAgdHJ1c3RfcmVmID0gTm9uZQoKICAgICAgICB0cnk6CiAgICAgICAgICAgIGlmIG9zeF92ZXJzaW9uX2luZm8gPCAoMTAsIDgpOgogICAgICAgICAgICAgICAgc2Vzc2lvbl9jb250ZXh0X3BvaW50ZXIgPSBuZXcoU2VjdXJpdHksICdTU0xDb250ZXh0UmVmIConKQogICAgICAgICAgICAgICAgcmVzdWx0ID0gU2VjdXJpdHkuU1NMTmV3Q29udGV4dChGYWxzZSwgc2Vzc2lvbl9jb250ZXh0X3BvaW50ZXIpCiAgICAgICAgICAgICAgICBoYW5kbGVfc2VjX2Vycm9yKHJlc3VsdCkKICAgICAgICAgICAgICAgIHNlc3Npb25fY29udGV4dCA9IHVud3JhcChzZXNzaW9uX2NvbnRleHRfcG9pbnRlcikKCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBzZXNzaW9uX2NvbnRleHQgPSBTZWN1cml0eS5TU0xDcmVhdGVDb250ZXh0KAogICAgICAgICAgICAgICAgICAgIG51bGwoKSwKICAgICAgICAgICAgICAgICAgICBTZWN1cml0eUNvbnN0LmtTU0xDbGllbnRTaWRlLAogICAgICAgICAgICAgICAgICAgIFNlY3VyaXR5Q29uc3Qua1NTTFN0cmVhbVR5cGUKICAgICAgICAgICAgICAgICkKCiAgICAgICAgICAgIHJlc3VsdCA9IFNlY3VyaXR5LlNTTFNldElPRnVuY3MoCiAgICAgICAgICAgICAgICBzZXNzaW9uX2NvbnRleHQsCiAgICAgICAgICAgICAgICBfcmVhZF9jYWxsYmFja19wb2ludGVyLAogICAgICAgICAgICAgICAgX3dyaXRlX2NhbGxiYWNrX3BvaW50ZXIKICAgICAgICAgICAgKQogICAgICAgICAgICBoYW5kbGVfc2VjX2Vycm9yKHJlc3VsdCkKCiAgICAgICAgICAgIHNlbGYuX2Nvbm5lY3Rpb25faWQgPSBpZChzZWxmKSAlIDIxNDc0ODM2NDcKICAgICAgICAgICAgX2Nvbm5lY3Rpb25fcmVmc1tzZWxmLl9jb25uZWN0aW9uX2lkXSA9IHNlbGYKICAgICAgICAgICAgX3NvY2tldF9yZWZzW3NlbGYuX2Nvbm5lY3Rpb25faWRdID0gc2VsZi5fc29ja2V0CiAgICAgICAgICAgIHJlc3VsdCA9IFNlY3VyaXR5LlNTTFNldENvbm5lY3Rpb24oc2Vzc2lvbl9jb250ZXh0LCBzZWxmLl9jb25uZWN0aW9uX2lkKQogICAgICAgICAgICBoYW5kbGVfc2VjX2Vycm9yKHJlc3VsdCkKCiAgICAgICAgICAgIHV0ZjhfZG9tYWluID0gc2VsZi5faG9zdG5hbWUuZW5jb2RlKCd1dGYtOCcpCiAgICAgICAgICAgIHJlc3VsdCA9IFNlY3VyaXR5LlNTTFNldFBlZXJEb21haW5OYW1lKAogICAgICAgICAgICAgICAgc2Vzc2lvbl9jb250ZXh0LAogICAgICAgICAgICAgICAgdXRmOF9kb21haW4sCiAgICAgICAgICAgICAgICBsZW4odXRmOF9kb21haW4pCiAgICAgICAgICAgICkKICAgICAgICAgICAgaGFuZGxlX3NlY19lcnJvcihyZXN1bHQpCgogICAgICAgICAgICBpZiBvc3hfdmVyc2lvbl9pbmZvID49ICgxMCwgMTApOgogICAgICAgICAgICAgICAgZGlzYWJsZV9hdXRvX3ZhbGlkYXRpb24gPSBzZWxmLl9zZXNzaW9uLl9tYW51YWxfdmFsaWRhdGlvbiBvciBzZWxmLl9zZXNzaW9uLl9leHRyYV90cnVzdF9yb290cwogICAgICAgICAgICAgICAgZXhwbGljaXRfdmFsaWRhdGlvbiA9IChub3Qgc2VsZi5fc2Vzc2lvbi5fbWFudWFsX3ZhbGlkYXRpb24pIGFuZCBzZWxmLl9zZXNzaW9uLl9leHRyYV90cnVzdF9yb290cwogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgZGlzYWJsZV9hdXRvX3ZhbGlkYXRpb24gPSBUcnVlCiAgICAgICAgICAgICAgICBleHBsaWNpdF92YWxpZGF0aW9uID0gbm90IHNlbGYuX3Nlc3Npb24uX21hbnVhbF92YWxpZGF0aW9uCgogICAgICAgICAgICAjIEVuc3VyZSByZXF1ZXN0ZWQgcHJvdG9jb2wgc3VwcG9ydCBpcyBzZXQgZm9yIHRoZSBzZXNzaW9uCiAgICAgICAgICAgIGlmIG9zeF92ZXJzaW9uX2luZm8gPCAoMTAsIDgpOgogICAgICAgICAgICAgICAgZm9yIHByb3RvY29sIGluIFsnU1NMdjInLCAnU1NMdjMnLCAnVExTdjEnXToKICAgICAgICAgICAgICAgICAgICBwcm90b2NvbF9jb25zdCA9IF9QUk9UT0NPTF9TVFJJTkdfQ09OU1RfTUFQW3Byb3RvY29sXQogICAgICAgICAgICAgICAgICAgIGVuYWJsZWQgPSBwcm90b2NvbCBpbiBzZWxmLl9zZXNzaW9uLl9wcm90b2NvbHMKICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSBTZWN1cml0eS5TU0xTZXRQcm90b2NvbFZlcnNpb25FbmFibGVkKAogICAgICAgICAgICAgICAgICAgICAgICBzZXNzaW9uX2NvbnRleHQsCiAgICAgICAgICAgICAgICAgICAgICAgIHByb3RvY29sX2NvbnN0LAogICAgICAgICAgICAgICAgICAgICAgICBlbmFibGVkCiAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICAgIGhhbmRsZV9zZWNfZXJyb3IocmVzdWx0KQoKICAgICAgICAgICAgICAgIGlmIGRpc2FibGVfYXV0b192YWxpZGF0aW9uOgogICAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IFNlY3VyaXR5LlNTTFNldEVuYWJsZUNlcnRWZXJpZnkoc2Vzc2lvbl9jb250ZXh0LCBGYWxzZSkKICAgICAgICAgICAgICAgICAgICBoYW5kbGVfc2VjX2Vycm9yKHJlc3VsdCkKCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBwcm90b2NvbF9jb25zdHMgPSBbX1BST1RPQ09MX1NUUklOR19DT05TVF9NQVBbcHJvdG9jb2xdIGZvciBwcm90b2NvbCBpbiBzZWxmLl9zZXNzaW9uLl9wcm90b2NvbHNdCiAgICAgICAgICAgICAgICBtaW5fcHJvdG9jb2wgPSBtaW4ocHJvdG9jb2xfY29uc3RzKQogICAgICAgICAgICAgICAgbWF4X3Byb3RvY29sID0gbWF4KHByb3RvY29sX2NvbnN0cykKICAgICAgICAgICAgICAgIHJlc3VsdCA9IFNlY3VyaXR5LlNTTFNldFByb3RvY29sVmVyc2lvbk1pbigKICAgICAgICAgICAgICAgICAgICBzZXNzaW9uX2NvbnRleHQsCiAgICAgICAgICAgICAgICAgICAgbWluX3Byb3RvY29sCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICBoYW5kbGVfc2VjX2Vycm9yKHJlc3VsdCkKICAgICAgICAgICAgICAgIHJlc3VsdCA9IFNlY3VyaXR5LlNTTFNldFByb3RvY29sVmVyc2lvbk1heCgKICAgICAgICAgICAgICAgICAgICBzZXNzaW9uX2NvbnRleHQsCiAgICAgICAgICAgICAgICAgICAgbWF4X3Byb3RvY29sCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICBoYW5kbGVfc2VjX2Vycm9yKHJlc3VsdCkKCiAgICAgICAgICAgICAgICBpZiBkaXNhYmxlX2F1dG9fdmFsaWRhdGlvbjoKICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSBTZWN1cml0eS5TU0xTZXRTZXNzaW9uT3B0aW9uKAogICAgICAgICAgICAgICAgICAgICAgICBzZXNzaW9uX2NvbnRleHQsCiAgICAgICAgICAgICAgICAgICAgICAgIFNlY3VyaXR5Q29uc3Qua1NTTFNlc3Npb25PcHRpb25CcmVha09uU2VydmVyQXV0aCwKICAgICAgICAgICAgICAgICAgICAgICAgVHJ1ZQogICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICBoYW5kbGVfc2VjX2Vycm9yKHJlc3VsdCkKCiAgICAgICAgICAgICMgRGlzYWJsZSBhbGwgc29ydHMgb2YgYmFkIGNpcGhlciBzdWl0ZXMKICAgICAgICAgICAgc3VwcG9ydGVkX2NpcGhlcnNfcG9pbnRlciA9IG5ldyhTZWN1cml0eSwgJ3NpemVfdCAqJykKICAgICAgICAgICAgcmVzdWx0ID0gU2VjdXJpdHkuU1NMR2V0TnVtYmVyU3VwcG9ydGVkQ2lwaGVycyhzZXNzaW9uX2NvbnRleHQsIHN1cHBvcnRlZF9jaXBoZXJzX3BvaW50ZXIpCiAgICAgICAgICAgIGhhbmRsZV9zZWNfZXJyb3IocmVzdWx0KQoKICAgICAgICAgICAgc3VwcG9ydGVkX2NpcGhlcnMgPSBkZXJlZihzdXBwb3J0ZWRfY2lwaGVyc19wb2ludGVyKQoKICAgICAgICAgICAgY2lwaGVyX2J1ZmZlciA9IGJ1ZmZlcl9mcm9tX2J5dGVzKHN1cHBvcnRlZF9jaXBoZXJzICogc2l6ZW9mKFNlY3VyaXR5LCAnU1NMQ2lwaGVyU3VpdGUnKSkKICAgICAgICAgICAgc3VwcG9ydGVkX2NpcGhlcl9zdWl0ZXNfcG9pbnRlciA9IGNhc3QoU2VjdXJpdHksICdTU0xDaXBoZXJTdWl0ZSAqJywgY2lwaGVyX2J1ZmZlcikKICAgICAgICAgICAgcmVzdWx0ID0gU2VjdXJpdHkuU1NMR2V0U3VwcG9ydGVkQ2lwaGVycygKICAgICAgICAgICAgICAgIHNlc3Npb25fY29udGV4dCwKICAgICAgICAgICAgICAgIHN1cHBvcnRlZF9jaXBoZXJfc3VpdGVzX3BvaW50ZXIsCiAgICAgICAgICAgICAgICBzdXBwb3J0ZWRfY2lwaGVyc19wb2ludGVyCiAgICAgICAgICAgICkKICAgICAgICAgICAgaGFuZGxlX3NlY19lcnJvcihyZXN1bHQpCgogICAgICAgICAgICBzdXBwb3J0ZWRfY2lwaGVycyA9IGRlcmVmKHN1cHBvcnRlZF9jaXBoZXJzX3BvaW50ZXIpCiAgICAgICAgICAgIHN1cHBvcnRlZF9jaXBoZXJfc3VpdGVzID0gYXJyYXlfZnJvbV9wb2ludGVyKAogICAgICAgICAgICAgICAgU2VjdXJpdHksCiAgICAgICAgICAgICAgICAnU1NMQ2lwaGVyU3VpdGUnLAogICAgICAgICAgICAgICAgc3VwcG9ydGVkX2NpcGhlcl9zdWl0ZXNfcG9pbnRlciwKICAgICAgICAgICAgICAgIHN1cHBvcnRlZF9jaXBoZXJzCiAgICAgICAgICAgICkKICAgICAgICAgICAgZ29vZF9jaXBoZXJzID0gW10KICAgICAgICAgICAgZm9yIHN1cHBvcnRlZF9jaXBoZXJfc3VpdGUgaW4gc3VwcG9ydGVkX2NpcGhlcl9zdWl0ZXM6CiAgICAgICAgICAgICAgICBjaXBoZXJfc3VpdGUgPSBpbnRfdG9fYnl0ZXMoc3VwcG9ydGVkX2NpcGhlcl9zdWl0ZSwgd2lkdGg9MikKICAgICAgICAgICAgICAgIGNpcGhlcl9zdWl0ZV9uYW1lID0gQ0lQSEVSX1NVSVRFX01BUC5nZXQoY2lwaGVyX3N1aXRlLCBjaXBoZXJfc3VpdGUpCiAgICAgICAgICAgICAgICBnb29kX2NpcGhlciA9IF9jaXBoZXJfYmxhY2tsaXN0X3JlZ2V4LnNlYXJjaChjaXBoZXJfc3VpdGVfbmFtZSkgaXMgTm9uZQogICAgICAgICAgICAgICAgaWYgZ29vZF9jaXBoZXI6CiAgICAgICAgICAgICAgICAgICAgZ29vZF9jaXBoZXJzLmFwcGVuZChzdXBwb3J0ZWRfY2lwaGVyX3N1aXRlKQoKICAgICAgICAgICAgbnVtX2dvb2RfY2lwaGVycyA9IGxlbihnb29kX2NpcGhlcnMpCiAgICAgICAgICAgIGdvb2RfY2lwaGVyc19hcnJheSA9IG5ldyhTZWN1cml0eSwgJ1NTTENpcGhlclN1aXRlW10nLCBudW1fZ29vZF9jaXBoZXJzKQogICAgICAgICAgICBhcnJheV9zZXQoZ29vZF9jaXBoZXJzX2FycmF5LCBnb29kX2NpcGhlcnMpCiAgICAgICAgICAgIGdvb2RfY2lwaGVyc19wb2ludGVyID0gY2FzdChTZWN1cml0eSwgJ1NTTENpcGhlclN1aXRlIConLCBnb29kX2NpcGhlcnNfYXJyYXkpCiAgICAgICAgICAgIHJlc3VsdCA9IFNlY3VyaXR5LlNTTFNldEVuYWJsZWRDaXBoZXJzKAogICAgICAgICAgICAgICAgc2Vzc2lvbl9jb250ZXh0LAogICAgICAgICAgICAgICAgZ29vZF9jaXBoZXJzX3BvaW50ZXIsCiAgICAgICAgICAgICAgICBudW1fZ29vZF9jaXBoZXJzCiAgICAgICAgICAgICkKICAgICAgICAgICAgaGFuZGxlX3NlY19lcnJvcihyZXN1bHQpCgogICAgICAgICAgICAjIFNldCBhIHBlZXIgaWQgZnJvbSB0aGUgc2Vzc2lvbiB0byBhbGxvdyBmb3Igc2Vzc2lvbiByZXVzZSwgdGhlIGhvc3RuYW1lCiAgICAgICAgICAgICMgaXMgYXBwZW5kZWQgdG8gcHJldmVudCBhIGJ1ZyBvbiBPUyBYIDEwLjcgd2hlcmUgaXQgdHJpZXMgdG8gcmV1c2UgYQogICAgICAgICAgICAjIGNvbm5lY3Rpb24gZXZlbiBpZiB0aGUgaG9zdG5hbWVzIGFyZSBkaWZmZXJlbnQuCiAgICAgICAgICAgIHBlZXJfaWQgPSBzZWxmLl9zZXNzaW9uLl9wZWVyX2lkICsgc2VsZi5faG9zdG5hbWUuZW5jb2RlKCd1dGYtOCcpCiAgICAgICAgICAgIHJlc3VsdCA9IFNlY3VyaXR5LlNTTFNldFBlZXJJRChzZXNzaW9uX2NvbnRleHQsIHBlZXJfaWQsIGxlbihwZWVyX2lkKSkKICAgICAgICAgICAgaGFuZGxlX3NlY19lcnJvcihyZXN1bHQpCgogICAgICAgICAgICBoYW5kc2hha2VfcmVzdWx0ID0gU2VjdXJpdHkuU1NMSGFuZHNoYWtlKHNlc3Npb25fY29udGV4dCkKICAgICAgICAgICAgaWYgc2VsZi5fZXhjZXB0aW9uIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgZXhjZXB0aW9uID0gc2VsZi5fZXhjZXB0aW9uCiAgICAgICAgICAgICAgICBzZWxmLl9leGNlcHRpb24gPSBOb25lCiAgICAgICAgICAgICAgICByYWlzZSBleGNlcHRpb24KICAgICAgICAgICAgd2hpbGUgaGFuZHNoYWtlX3Jlc3VsdCA9PSBTZWN1cml0eUNvbnN0LmVyclNTTFdvdWxkQmxvY2s6CiAgICAgICAgICAgICAgICBoYW5kc2hha2VfcmVzdWx0ID0gU2VjdXJpdHkuU1NMSGFuZHNoYWtlKHNlc3Npb25fY29udGV4dCkKICAgICAgICAgICAgICAgIGlmIHNlbGYuX2V4Y2VwdGlvbiBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgICAgICBleGNlcHRpb24gPSBzZWxmLl9leGNlcHRpb24KICAgICAgICAgICAgICAgICAgICBzZWxmLl9leGNlcHRpb24gPSBOb25lCiAgICAgICAgICAgICAgICAgICAgcmFpc2UgZXhjZXB0aW9uCgogICAgICAgICAgICBpZiBvc3hfdmVyc2lvbl9pbmZvIDwgKDEwLCA4KSBhbmQgb3N4X3ZlcnNpb25faW5mbyA+PSAoMTAsIDcpOgogICAgICAgICAgICAgICAgZG9fdmFsaWRhdGlvbiA9IGV4cGxpY2l0X3ZhbGlkYXRpb24gYW5kIGhhbmRzaGFrZV9yZXN1bHQgPT0gMAogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgZG9fdmFsaWRhdGlvbiA9IGV4cGxpY2l0X3ZhbGlkYXRpb24gYW5kIGhhbmRzaGFrZV9yZXN1bHQgPT0gU2VjdXJpdHlDb25zdC5lcnJTU0xTZXJ2ZXJBdXRoQ29tcGxldGVkCgogICAgICAgICAgICBpZiBkb192YWxpZGF0aW9uOgogICAgICAgICAgICAgICAgdHJ1c3RfcmVmX3BvaW50ZXIgPSBuZXcoU2VjdXJpdHksICdTZWNUcnVzdFJlZiAqJykKICAgICAgICAgICAgICAgIHJlc3VsdCA9IFNlY3VyaXR5LlNTTENvcHlQZWVyVHJ1c3QoCiAgICAgICAgICAgICAgICAgICAgc2Vzc2lvbl9jb250ZXh0LAogICAgICAgICAgICAgICAgICAgIHRydXN0X3JlZl9wb2ludGVyCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICBoYW5kbGVfc2VjX2Vycm9yKHJlc3VsdCkKICAgICAgICAgICAgICAgIHRydXN0X3JlZiA9IHVud3JhcCh0cnVzdF9yZWZfcG9pbnRlcikKCiAgICAgICAgICAgICAgICBjZl9zdHJpbmdfaG9zdG5hbWUgPSBDRkhlbHBlcnMuY2Zfc3RyaW5nX2Zyb21fdW5pY29kZShzZWxmLl9ob3N0bmFtZSkKICAgICAgICAgICAgICAgIHNzbF9wb2xpY3lfcmVmID0gU2VjdXJpdHkuU2VjUG9saWN5Q3JlYXRlU1NMKFRydWUsIGNmX3N0cmluZ19ob3N0bmFtZSkKICAgICAgICAgICAgICAgIHJlc3VsdCA9IENvcmVGb3VuZGF0aW9uLkNGUmVsZWFzZShjZl9zdHJpbmdfaG9zdG5hbWUpCiAgICAgICAgICAgICAgICBoYW5kbGVfY2ZfZXJyb3IocmVzdWx0KQoKICAgICAgICAgICAgICAgICMgQ3JlYXRlIGEgbmV3IHBvbGljeSBmb3IgT0NTUCBjaGVja2luZyB0byBkaXNhYmxlIGl0CiAgICAgICAgICAgICAgICBvY3NwX29pZF9wb2ludGVyID0gc3RydWN0KFNlY3VyaXR5LCAnQ1NTTV9PSUQnKQogICAgICAgICAgICAgICAgb2NzcF9vaWQgPSB1bndyYXAob2NzcF9vaWRfcG9pbnRlcikKICAgICAgICAgICAgICAgIG9jc3Bfb2lkLkxlbmd0aCA9IGxlbihTZWN1cml0eUNvbnN0LkFQUExFX1RQX1JFVk9DQVRJT05fT0NTUCkKICAgICAgICAgICAgICAgIG9jc3Bfb2lkX2J1ZmZlciA9IGJ1ZmZlcl9mcm9tX2J5dGVzKFNlY3VyaXR5Q29uc3QuQVBQTEVfVFBfUkVWT0NBVElPTl9PQ1NQKQogICAgICAgICAgICAgICAgb2NzcF9vaWQuRGF0YSA9IGNhc3QoU2VjdXJpdHksICdjaGFyIConLCBvY3NwX29pZF9idWZmZXIpCgogICAgICAgICAgICAgICAgb2NzcF9zZWFyY2hfcmVmX3BvaW50ZXIgPSBuZXcoU2VjdXJpdHksICdTZWNQb2xpY3lTZWFyY2hSZWYgKicpCiAgICAgICAgICAgICAgICByZXN1bHQgPSBTZWN1cml0eS5TZWNQb2xpY3lTZWFyY2hDcmVhdGUoCiAgICAgICAgICAgICAgICAgICAgU2VjdXJpdHlDb25zdC5DU1NNX0NFUlRfWF81MDl2MywKICAgICAgICAgICAgICAgICAgICBvY3NwX29pZF9wb2ludGVyLAogICAgICAgICAgICAgICAgICAgIG51bGwoKSwKICAgICAgICAgICAgICAgICAgICBvY3NwX3NlYXJjaF9yZWZfcG9pbnRlcgogICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgaGFuZGxlX3NlY19lcnJvcihyZXN1bHQpCiAgICAgICAgICAgICAgICBvY3NwX3NlYXJjaF9yZWYgPSB1bndyYXAob2NzcF9zZWFyY2hfcmVmX3BvaW50ZXIpCgogICAgICAgICAgICAgICAgb2NzcF9wb2xpY3lfcmVmX3BvaW50ZXIgPSBuZXcoU2VjdXJpdHksICdTZWNQb2xpY3lSZWYgKicpCiAgICAgICAgICAgICAgICByZXN1bHQgPSBTZWN1cml0eS5TZWNQb2xpY3lTZWFyY2hDb3B5TmV4dChvY3NwX3NlYXJjaF9yZWYsIG9jc3BfcG9saWN5X3JlZl9wb2ludGVyKQogICAgICAgICAgICAgICAgaGFuZGxlX3NlY19lcnJvcihyZXN1bHQpCiAgICAgICAgICAgICAgICBvY3NwX3BvbGljeV9yZWYgPSB1bndyYXAob2NzcF9wb2xpY3lfcmVmX3BvaW50ZXIpCgogICAgICAgICAgICAgICAgb2NzcF9zdHJ1Y3RfcG9pbnRlciA9IHN0cnVjdChTZWN1cml0eSwgJ0NTU01fQVBQTEVfVFBfT0NTUF9PUFRJT05TJykKICAgICAgICAgICAgICAgIG9jc3Bfc3RydWN0ID0gdW53cmFwKG9jc3Bfc3RydWN0X3BvaW50ZXIpCiAgICAgICAgICAgICAgICBvY3NwX3N0cnVjdC5WZXJzaW9uID0gU2VjdXJpdHlDb25zdC5DU1NNX0FQUExFX1RQX09DU1BfT1BUU19WRVJTSU9OCiAgICAgICAgICAgICAgICBvY3NwX3N0cnVjdC5GbGFncyA9ICgKICAgICAgICAgICAgICAgICAgICBTZWN1cml0eUNvbnN0LkNTU01fVFBfQUNUSU9OX09DU1BfRElTQUJMRV9ORVQgfAogICAgICAgICAgICAgICAgICAgIFNlY3VyaXR5Q29uc3QuQ1NTTV9UUF9BQ1RJT05fT0NTUF9DQUNIRV9SRUFEX0RJU0FCTEUKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgIG9jc3Bfc3RydWN0X2J5dGVzID0gc3RydWN0X2J5dGVzKG9jc3Bfc3RydWN0X3BvaW50ZXIpCgogICAgICAgICAgICAgICAgY3NzbV9kYXRhX3BvaW50ZXIgPSBzdHJ1Y3QoU2VjdXJpdHksICdDU1NNX0RBVEEnKQogICAgICAgICAgICAgICAgY3NzbV9kYXRhID0gdW53cmFwKGNzc21fZGF0YV9wb2ludGVyKQogICAgICAgICAgICAgICAgY3NzbV9kYXRhLkxlbmd0aCA9IGxlbihvY3NwX3N0cnVjdF9ieXRlcykKICAgICAgICAgICAgICAgIG9jc3Bfc3RydWN0X2J1ZmZlciA9IGJ1ZmZlcl9mcm9tX2J5dGVzKG9jc3Bfc3RydWN0X2J5dGVzKQogICAgICAgICAgICAgICAgY3NzbV9kYXRhLkRhdGEgPSBjYXN0KFNlY3VyaXR5LCAnY2hhciAqJywgb2NzcF9zdHJ1Y3RfYnVmZmVyKQoKICAgICAgICAgICAgICAgIHJlc3VsdCA9IFNlY3VyaXR5LlNlY1BvbGljeVNldFZhbHVlKG9jc3BfcG9saWN5X3JlZiwgY3NzbV9kYXRhX3BvaW50ZXIpCiAgICAgICAgICAgICAgICBoYW5kbGVfc2VjX2Vycm9yKHJlc3VsdCkKCiAgICAgICAgICAgICAgICAjIENyZWF0ZSBhIG5ldyBwb2xpY3kgZm9yIENSTCBjaGVja2luZyB0byBkaXNhYmxlIGl0CiAgICAgICAgICAgICAgICBjcmxfb2lkX3BvaW50ZXIgPSBzdHJ1Y3QoU2VjdXJpdHksICdDU1NNX09JRCcpCiAgICAgICAgICAgICAgICBjcmxfb2lkID0gdW53cmFwKGNybF9vaWRfcG9pbnRlcikKICAgICAgICAgICAgICAgIGNybF9vaWQuTGVuZ3RoID0gbGVuKFNlY3VyaXR5Q29uc3QuQVBQTEVfVFBfUkVWT0NBVElPTl9DUkwpCiAgICAgICAgICAgICAgICBjcmxfb2lkX2J1ZmZlciA9IGJ1ZmZlcl9mcm9tX2J5dGVzKFNlY3VyaXR5Q29uc3QuQVBQTEVfVFBfUkVWT0NBVElPTl9DUkwpCiAgICAgICAgICAgICAgICBjcmxfb2lkLkRhdGEgPSBjYXN0KFNlY3VyaXR5LCAnY2hhciAqJywgY3JsX29pZF9idWZmZXIpCgogICAgICAgICAgICAgICAgY3JsX3NlYXJjaF9yZWZfcG9pbnRlciA9IG5ldyhTZWN1cml0eSwgJ1NlY1BvbGljeVNlYXJjaFJlZiAqJykKICAgICAgICAgICAgICAgIHJlc3VsdCA9IFNlY3VyaXR5LlNlY1BvbGljeVNlYXJjaENyZWF0ZSgKICAgICAgICAgICAgICAgICAgICBTZWN1cml0eUNvbnN0LkNTU01fQ0VSVF9YXzUwOXYzLAogICAgICAgICAgICAgICAgICAgIGNybF9vaWRfcG9pbnRlciwKICAgICAgICAgICAgICAgICAgICBudWxsKCksCiAgICAgICAgICAgICAgICAgICAgY3JsX3NlYXJjaF9yZWZfcG9pbnRlcgogICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgaGFuZGxlX3NlY19lcnJvcihyZXN1bHQpCiAgICAgICAgICAgICAgICBjcmxfc2VhcmNoX3JlZiA9IHVud3JhcChjcmxfc2VhcmNoX3JlZl9wb2ludGVyKQoKICAgICAgICAgICAgICAgIGNybF9wb2xpY3lfcmVmX3BvaW50ZXIgPSBuZXcoU2VjdXJpdHksICdTZWNQb2xpY3lSZWYgKicpCiAgICAgICAgICAgICAgICByZXN1bHQgPSBTZWN1cml0eS5TZWNQb2xpY3lTZWFyY2hDb3B5TmV4dChjcmxfc2VhcmNoX3JlZiwgY3JsX3BvbGljeV9yZWZfcG9pbnRlcikKICAgICAgICAgICAgICAgIGhhbmRsZV9zZWNfZXJyb3IocmVzdWx0KQogICAgICAgICAgICAgICAgY3JsX3BvbGljeV9yZWYgPSB1bndyYXAoY3JsX3BvbGljeV9yZWZfcG9pbnRlcikKCiAgICAgICAgICAgICAgICBjcmxfc3RydWN0X3BvaW50ZXIgPSBzdHJ1Y3QoU2VjdXJpdHksICdDU1NNX0FQUExFX1RQX0NSTF9PUFRJT05TJykKICAgICAgICAgICAgICAgIGNybF9zdHJ1Y3QgPSB1bndyYXAoY3JsX3N0cnVjdF9wb2ludGVyKQogICAgICAgICAgICAgICAgY3JsX3N0cnVjdC5WZXJzaW9uID0gU2VjdXJpdHlDb25zdC5DU1NNX0FQUExFX1RQX0NSTF9PUFRTX1ZFUlNJT04KICAgICAgICAgICAgICAgIGNybF9zdHJ1Y3QuQ3JsRmxhZ3MgPSAwCiAgICAgICAgICAgICAgICBjcmxfc3RydWN0X2J5dGVzID0gc3RydWN0X2J5dGVzKGNybF9zdHJ1Y3RfcG9pbnRlcikKCiAgICAgICAgICAgICAgICBjc3NtX2RhdGFfcG9pbnRlciA9IHN0cnVjdChTZWN1cml0eSwgJ0NTU01fREFUQScpCiAgICAgICAgICAgICAgICBjc3NtX2RhdGEgPSB1bndyYXAoY3NzbV9kYXRhX3BvaW50ZXIpCiAgICAgICAgICAgICAgICBjc3NtX2RhdGEuTGVuZ3RoID0gbGVuKGNybF9zdHJ1Y3RfYnl0ZXMpCiAgICAgICAgICAgICAgICBjcmxfc3RydWN0X2J1ZmZlciA9IGJ1ZmZlcl9mcm9tX2J5dGVzKGNybF9zdHJ1Y3RfYnl0ZXMpCiAgICAgICAgICAgICAgICBjc3NtX2RhdGEuRGF0YSA9IGNhc3QoU2VjdXJpdHksICdjaGFyIConLCBjcmxfc3RydWN0X2J1ZmZlcikKCiAgICAgICAgICAgICAgICByZXN1bHQgPSBTZWN1cml0eS5TZWNQb2xpY3lTZXRWYWx1ZShjcmxfcG9saWN5X3JlZiwgY3NzbV9kYXRhX3BvaW50ZXIpCiAgICAgICAgICAgICAgICBoYW5kbGVfc2VjX2Vycm9yKHJlc3VsdCkKCiAgICAgICAgICAgICAgICBwb2xpY3lfYXJyYXlfcmVmID0gQ0ZIZWxwZXJzLmNmX2FycmF5X2Zyb21fbGlzdChbCiAgICAgICAgICAgICAgICAgICAgc3NsX3BvbGljeV9yZWYsCiAgICAgICAgICAgICAgICAgICAgY3JsX3BvbGljeV9yZWYsCiAgICAgICAgICAgICAgICAgICAgb2NzcF9wb2xpY3lfcmVmCiAgICAgICAgICAgICAgICBdKQoKICAgICAgICAgICAgICAgIHJlc3VsdCA9IFNlY3VyaXR5LlNlY1RydXN0U2V0UG9saWNpZXModHJ1c3RfcmVmLCBwb2xpY3lfYXJyYXlfcmVmKQogICAgICAgICAgICAgICAgaGFuZGxlX3NlY19lcnJvcihyZXN1bHQpCgogICAgICAgICAgICAgICAgaWYgc2VsZi5fc2Vzc2lvbi5fZXh0cmFfdHJ1c3Rfcm9vdHM6CiAgICAgICAgICAgICAgICAgICAgY2FfY2VydF9yZWZzID0gW10KICAgICAgICAgICAgICAgICAgICBjYV9jZXJ0cyA9IFtdCiAgICAgICAgICAgICAgICAgICAgZm9yIGNlcnQgaW4gc2VsZi5fc2Vzc2lvbi5fZXh0cmFfdHJ1c3Rfcm9vdHM6CiAgICAgICAgICAgICAgICAgICAgICAgIGNhX2NlcnQgPSBsb2FkX2NlcnRpZmljYXRlKGNlcnQpCiAgICAgICAgICAgICAgICAgICAgICAgIGNhX2NlcnRzLmFwcGVuZChjYV9jZXJ0KQogICAgICAgICAgICAgICAgICAgICAgICBjYV9jZXJ0X3JlZnMuYXBwZW5kKGNhX2NlcnQuc2VjX2NlcnRpZmljYXRlX3JlZikKCiAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gU2VjdXJpdHkuU2VjVHJ1c3RTZXRBbmNob3JDZXJ0aWZpY2F0ZXNPbmx5KHRydXN0X3JlZiwgRmFsc2UpCiAgICAgICAgICAgICAgICAgICAgaGFuZGxlX3NlY19lcnJvcihyZXN1bHQpCgogICAgICAgICAgICAgICAgICAgIGFycmF5X3JlZiA9IENGSGVscGVycy5jZl9hcnJheV9mcm9tX2xpc3QoY2FfY2VydF9yZWZzKQogICAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IFNlY3VyaXR5LlNlY1RydXN0U2V0QW5jaG9yQ2VydGlmaWNhdGVzKHRydXN0X3JlZiwgYXJyYXlfcmVmKQogICAgICAgICAgICAgICAgICAgIGhhbmRsZV9zZWNfZXJyb3IocmVzdWx0KQoKICAgICAgICAgICAgICAgIHJlc3VsdF9wb2ludGVyID0gbmV3KFNlY3VyaXR5LCAnU2VjVHJ1c3RSZXN1bHRUeXBlIConKQogICAgICAgICAgICAgICAgcmVzdWx0ID0gU2VjdXJpdHkuU2VjVHJ1c3RFdmFsdWF0ZSh0cnVzdF9yZWYsIHJlc3VsdF9wb2ludGVyKQogICAgICAgICAgICAgICAgaGFuZGxlX3NlY19lcnJvcihyZXN1bHQpCgogICAgICAgICAgICAgICAgdHJ1c3RfcmVzdWx0X2NvZGUgPSBkZXJlZihyZXN1bHRfcG9pbnRlcikKICAgICAgICAgICAgICAgIGludmFsaWRfY2hhaW5fZXJyb3JfY29kZXMgPSBzZXQoWwogICAgICAgICAgICAgICAgICAgIFNlY3VyaXR5Q29uc3Qua1NlY1RydXN0UmVzdWx0UHJvY2VlZCwKICAgICAgICAgICAgICAgICAgICBTZWN1cml0eUNvbnN0LmtTZWNUcnVzdFJlc3VsdFVuc3BlY2lmaWVkCiAgICAgICAgICAgICAgICBdKQogICAgICAgICAgICAgICAgaWYgdHJ1c3RfcmVzdWx0X2NvZGUgbm90IGluIGludmFsaWRfY2hhaW5fZXJyb3JfY29kZXM6CiAgICAgICAgICAgICAgICAgICAgaGFuZHNoYWtlX3Jlc3VsdCA9IFNlY3VyaXR5Q29uc3QuZXJyU1NMWENlcnRDaGFpbkludmFsaWQKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgaGFuZHNoYWtlX3Jlc3VsdCA9IFNlY3VyaXR5LlNTTEhhbmRzaGFrZShzZXNzaW9uX2NvbnRleHQpCiAgICAgICAgICAgICAgICAgICAgd2hpbGUgaGFuZHNoYWtlX3Jlc3VsdCA9PSBTZWN1cml0eUNvbnN0LmVyclNTTFdvdWxkQmxvY2s6CiAgICAgICAgICAgICAgICAgICAgICAgIGhhbmRzaGFrZV9yZXN1bHQgPSBTZWN1cml0eS5TU0xIYW5kc2hha2Uoc2Vzc2lvbl9jb250ZXh0KQoKICAgICAgICAgICAgc2VsZi5fZG9uZV9oYW5kc2hha2UgPSBUcnVlCgogICAgICAgICAgICBoYW5kc2hha2VfZXJyb3JfY29kZXMgPSBzZXQoWwogICAgICAgICAgICAgICAgU2VjdXJpdHlDb25zdC5lcnJTU0xYQ2VydENoYWluSW52YWxpZCwKICAgICAgICAgICAgICAgIFNlY3VyaXR5Q29uc3QuZXJyU1NMQ2VydEV4cGlyZWQsCiAgICAgICAgICAgICAgICBTZWN1cml0eUNvbnN0LmVyclNTTENlcnROb3RZZXRWYWxpZCwKICAgICAgICAgICAgICAgIFNlY3VyaXR5Q29uc3QuZXJyU1NMVW5rbm93blJvb3RDZXJ0LAogICAgICAgICAgICAgICAgU2VjdXJpdHlDb25zdC5lcnJTU0xOb1Jvb3RDZXJ0LAogICAgICAgICAgICAgICAgU2VjdXJpdHlDb25zdC5lcnJTU0xIb3N0TmFtZU1pc21hdGNoLAogICAgICAgICAgICAgICAgU2VjdXJpdHlDb25zdC5lcnJTU0xJbnRlcm5hbCwKICAgICAgICAgICAgXSkKCiAgICAgICAgICAgICMgSW4gdGVzdGluZywgb25seSBlcnJTU0xYQ2VydENoYWluSW52YWxpZCB3YXMgZXZlciByZXR1cm5lZCBmb3IKICAgICAgICAgICAgIyBhbGwgb2YgdGhlc2UgZGlmZmVyZW50IHNpdHVhdGlvbnMsIGhvd2V2ZXIgd2UgaW5jbHVkZSB0aGUgb3RoZXJzCiAgICAgICAgICAgICMgZm9yIGNvbXBsZXRlbmVzcy4gVG8gZ2V0IHRoZSByZWFsIHJlYXNvbiB3ZSBoYXZlIHRvIHVzZSB0aGUKICAgICAgICAgICAgIyBjZXJ0aWZpY2F0ZSBmcm9tIHRoZSBoYW5kc2hha2UgYW5kIHVzZSB0aGUgZGVwcmVjYXRlZCBmdW5jdGlvbgogICAgICAgICAgICAjIFNlY1RydXN0R2V0Q3NzbVJlc3VsdENvZGUoKS4KICAgICAgICAgICAgaWYgaGFuZHNoYWtlX3Jlc3VsdCBpbiBoYW5kc2hha2VfZXJyb3JfY29kZXM6CiAgICAgICAgICAgICAgICBpZiB0cnVzdF9yZWY6CiAgICAgICAgICAgICAgICAgICAgQ29yZUZvdW5kYXRpb24uQ0ZSZWxlYXNlKHRydXN0X3JlZikKICAgICAgICAgICAgICAgICAgICB0cnVzdF9yZWYgPSBOb25lCgogICAgICAgICAgICAgICAgdHJ1c3RfcmVmX3BvaW50ZXIgPSBuZXcoU2VjdXJpdHksICdTZWNUcnVzdFJlZiAqJykKICAgICAgICAgICAgICAgIHJlc3VsdCA9IFNlY3VyaXR5LlNTTENvcHlQZWVyVHJ1c3QoCiAgICAgICAgICAgICAgICAgICAgc2Vzc2lvbl9jb250ZXh0LAogICAgICAgICAgICAgICAgICAgIHRydXN0X3JlZl9wb2ludGVyCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICBoYW5kbGVfc2VjX2Vycm9yKHJlc3VsdCkKICAgICAgICAgICAgICAgIHRydXN0X3JlZiA9IHVud3JhcCh0cnVzdF9yZWZfcG9pbnRlcikKCiAgICAgICAgICAgICAgICByZXN1bHRfY29kZV9wb2ludGVyID0gbmV3KFNlY3VyaXR5LCAnT1NTdGF0dXMgKicpCiAgICAgICAgICAgICAgICByZXN1bHQgPSBTZWN1cml0eS5TZWNUcnVzdEdldENzc21SZXN1bHRDb2RlKHRydXN0X3JlZiwgcmVzdWx0X2NvZGVfcG9pbnRlcikKICAgICAgICAgICAgICAgIHJlc3VsdF9jb2RlID0gZGVyZWYocmVzdWx0X2NvZGVfcG9pbnRlcikKCiAgICAgICAgICAgICAgICBjaGFpbiA9IGV4dHJhY3RfY2hhaW4oc2VsZi5fc2VydmVyX2hlbGxvKQoKICAgICAgICAgICAgICAgIHNlbGZfc2lnbmVkID0gRmFsc2UKICAgICAgICAgICAgICAgIHJldm9rZWQgPSBGYWxzZQogICAgICAgICAgICAgICAgZXhwaXJlZCA9IEZhbHNlCiAgICAgICAgICAgICAgICBub3RfeWV0X3ZhbGlkID0gRmFsc2UKICAgICAgICAgICAgICAgIG5vX2lzc3VlciA9IEZhbHNlCiAgICAgICAgICAgICAgICBjZXJ0ID0gTm9uZQogICAgICAgICAgICAgICAgYmFkX2hvc3RuYW1lID0gRmFsc2UKCiAgICAgICAgICAgICAgICBpZiBjaGFpbjoKICAgICAgICAgICAgICAgICAgICBjZXJ0ID0gY2hhaW5bMF0KICAgICAgICAgICAgICAgICAgICBvc2NyeXB0b19jZXJ0ID0gbG9hZF9jZXJ0aWZpY2F0ZShjZXJ0KQogICAgICAgICAgICAgICAgICAgIHNlbGZfc2lnbmVkID0gb3NjcnlwdG9fY2VydC5zZWxmX3NpZ25lZAogICAgICAgICAgICAgICAgICAgIHJldm9rZWQgPSByZXN1bHRfY29kZSA9PSBTZWN1cml0eUNvbnN0LkNTU01FUlJfVFBfQ0VSVF9SRVZPS0VECiAgICAgICAgICAgICAgICAgICAgbm9faXNzdWVyID0gbm90IHNlbGZfc2lnbmVkIGFuZCByZXN1bHRfY29kZSA9PSBTZWN1cml0eUNvbnN0LkNTU01FUlJfVFBfTk9UX1RSVVNURUQKICAgICAgICAgICAgICAgICAgICBleHBpcmVkID0gcmVzdWx0X2NvZGUgPT0gU2VjdXJpdHlDb25zdC5DU1NNRVJSX1RQX0NFUlRfRVhQSVJFRAogICAgICAgICAgICAgICAgICAgIG5vdF95ZXRfdmFsaWQgPSByZXN1bHRfY29kZSA9PSBTZWN1cml0eUNvbnN0LkNTU01FUlJfVFBfQ0VSVF9OT1RfVkFMSURfWUVUCiAgICAgICAgICAgICAgICAgICAgYmFkX2hvc3RuYW1lID0gcmVzdWx0X2NvZGUgPT0gU2VjdXJpdHlDb25zdC5DU1NNRVJSX0FQUExFVFBfSE9TVE5BTUVfTUlTTUFUQ0gKICAgICAgICAgICAgICAgICAgICB2YWxpZGl0eV90b29fbG9uZyA9IHJlc3VsdF9jb2RlID09IFNlY3VyaXR5Q29uc3QuQ1NTTUVSUl9UUF9DRVJUX1NVU1BFTkRFRAoKICAgICAgICAgICAgICAgICAgICAjIE9uIG1hY09TIDEwLjEyLCBzb21lIGV4cGlyZWQgY2VydGlmaWNhdGVzIHJldHVybiBlcnJTU0xJbnRlcm5hbAogICAgICAgICAgICAgICAgICAgIGlmIG9zeF92ZXJzaW9uX2luZm8gPj0gKDEwLCAxMik6CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbGlkaXR5ID0gY2VydFsndGJzX2NlcnRpZmljYXRlJ11bJ3ZhbGlkaXR5J10KICAgICAgICAgICAgICAgICAgICAgICAgbm90X2JlZm9yZSA9IHZhbGlkaXR5Wydub3RfYmVmb3JlJ10uY2hvc2VuLm5hdGl2ZQogICAgICAgICAgICAgICAgICAgICAgICBub3RfYWZ0ZXIgPSB2YWxpZGl0eVsnbm90X2FmdGVyJ10uY2hvc2VuLm5hdGl2ZQogICAgICAgICAgICAgICAgICAgICAgICB1dGNub3cgPSBkYXRldGltZS5kYXRldGltZS5ub3codGltZXpvbmUudXRjKQogICAgICAgICAgICAgICAgICAgICAgICBleHBpcmVkID0gbm90X2FmdGVyIDwgdXRjbm93CiAgICAgICAgICAgICAgICAgICAgICAgIG5vdF95ZXRfdmFsaWQgPSBub3RfYmVmb3JlID4gdXRjbm93CgogICAgICAgICAgICAgICAgaWYgY2hhaW4gYW5kIGNoYWluWzBdLmhhc2hfYWxnbyBpbiBzZXQoWydtZDUnLCAnbWQyJ10pOgogICAgICAgICAgICAgICAgICAgIHJhaXNlX3dlYWtfc2lnbmF0dXJlKGNoYWluWzBdKQoKICAgICAgICAgICAgICAgIGlmIHJldm9rZWQ6CiAgICAgICAgICAgICAgICAgICAgcmFpc2VfcmV2b2tlZChjZXJ0KQoKICAgICAgICAgICAgICAgIGlmIGJhZF9ob3N0bmFtZToKICAgICAgICAgICAgICAgICAgICByYWlzZV9ob3N0bmFtZShjZXJ0LCBzZWxmLl9ob3N0bmFtZSkKCiAgICAgICAgICAgICAgICBlbGlmIGV4cGlyZWQgb3Igbm90X3lldF92YWxpZDoKICAgICAgICAgICAgICAgICAgICByYWlzZV9leHBpcmVkX25vdF95ZXRfdmFsaWQoY2VydCkKCiAgICAgICAgICAgICAgICBlbGlmIG5vX2lzc3VlcjoKICAgICAgICAgICAgICAgICAgICByYWlzZV9ub19pc3N1ZXIoY2VydCkKCiAgICAgICAgICAgICAgICBlbGlmIHNlbGZfc2lnbmVkOgogICAgICAgICAgICAgICAgICAgIHJhaXNlX3NlbGZfc2lnbmVkKGNlcnQpCgogICAgICAgICAgICAgICAgZWxpZiB2YWxpZGl0eV90b29fbG9uZzoKICAgICAgICAgICAgICAgICAgICByYWlzZV9saWZldGltZV90b29fbG9uZyhjZXJ0KQoKICAgICAgICAgICAgICAgIGlmIGRldGVjdF9jbGllbnRfYXV0aF9yZXF1ZXN0KHNlbGYuX3NlcnZlcl9oZWxsbyk6CiAgICAgICAgICAgICAgICAgICAgcmFpc2VfY2xpZW50X2F1dGgoKQoKICAgICAgICAgICAgICAgIHJhaXNlX3ZlcmlmaWNhdGlvbihjZXJ0KQoKICAgICAgICAgICAgaWYgaGFuZHNoYWtlX3Jlc3VsdCA9PSBTZWN1cml0eUNvbnN0LmVyclNTTFBlZXJIYW5kc2hha2VGYWlsOgogICAgICAgICAgICAgICAgaWYgZGV0ZWN0X2NsaWVudF9hdXRoX3JlcXVlc3Qoc2VsZi5fc2VydmVyX2hlbGxvKToKICAgICAgICAgICAgICAgICAgICByYWlzZV9jbGllbnRfYXV0aCgpCiAgICAgICAgICAgICAgICByYWlzZV9oYW5kc2hha2UoKQoKICAgICAgICAgICAgaWYgaGFuZHNoYWtlX3Jlc3VsdCA9PSBTZWN1cml0eUNvbnN0LmVyclNTTFdlYWtQZWVyRXBoZW1lcmFsREhLZXk6CiAgICAgICAgICAgICAgICByYWlzZV9kaF9wYXJhbXMoKQoKICAgICAgICAgICAgaWYgaGFuZHNoYWtlX3Jlc3VsdCA9PSBTZWN1cml0eUNvbnN0LmVyclNTTFBlZXJQcm90b2NvbFZlcnNpb246CiAgICAgICAgICAgICAgICByYWlzZV9wcm90b2NvbF92ZXJzaW9uKCkKCiAgICAgICAgICAgIGlmIGhhbmRzaGFrZV9yZXN1bHQgaW4gc2V0KFtTZWN1cml0eUNvbnN0LmVyclNTTFJlY29yZE92ZXJmbG93LCBTZWN1cml0eUNvbnN0LmVyclNTTFByb3RvY29sXSk6CiAgICAgICAgICAgICAgICBzZWxmLl9zZXJ2ZXJfaGVsbG8gKz0gX3JlYWRfcmVtYWluaW5nKHNlbGYuX3NvY2tldCkKICAgICAgICAgICAgICAgIHJhaXNlX3Byb3RvY29sX2Vycm9yKHNlbGYuX3NlcnZlcl9oZWxsbykKCiAgICAgICAgICAgIGlmIGhhbmRzaGFrZV9yZXN1bHQgaW4gc2V0KFtTZWN1cml0eUNvbnN0LmVyclNTTENsb3NlZE5vTm90aWZ5LCBTZWN1cml0eUNvbnN0LmVyclNTTENsb3NlZEFib3J0XSk6CiAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5fZG9uZV9oYW5kc2hha2U6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5fc2VydmVyX2hlbGxvICs9IF9yZWFkX3JlbWFpbmluZyhzZWxmLl9zb2NrZXQpCiAgICAgICAgICAgICAgICBpZiBkZXRlY3Rfb3RoZXJfcHJvdG9jb2woc2VsZi5fc2VydmVyX2hlbGxvKToKICAgICAgICAgICAgICAgICAgICByYWlzZV9wcm90b2NvbF9lcnJvcihzZWxmLl9zZXJ2ZXJfaGVsbG8pCiAgICAgICAgICAgICAgICByYWlzZV9kaXNjb25uZWN0aW9uKCkKCiAgICAgICAgICAgIGlmIG9zeF92ZXJzaW9uX2luZm8gPCAoMTAsIDEwKToKICAgICAgICAgICAgICAgIGRoX3BhcmFtc19sZW5ndGggPSBnZXRfZGhfcGFyYW1zX2xlbmd0aChzZWxmLl9zZXJ2ZXJfaGVsbG8pCiAgICAgICAgICAgICAgICBpZiBkaF9wYXJhbXNfbGVuZ3RoIGlzIG5vdCBOb25lIGFuZCBkaF9wYXJhbXNfbGVuZ3RoIDwgMTAyNDoKICAgICAgICAgICAgICAgICAgICByYWlzZV9kaF9wYXJhbXMoKQoKICAgICAgICAgICAgd291bGRfYmxvY2sgPSBoYW5kc2hha2VfcmVzdWx0ID09IFNlY3VyaXR5Q29uc3QuZXJyU1NMV291bGRCbG9jawogICAgICAgICAgICBzZXJ2ZXJfYXV0aF9jb21wbGV0ZSA9IGhhbmRzaGFrZV9yZXN1bHQgPT0gU2VjdXJpdHlDb25zdC5lcnJTU0xTZXJ2ZXJBdXRoQ29tcGxldGVkCiAgICAgICAgICAgIG1hbnVhbF92YWxpZGF0aW9uID0gc2VsZi5fc2Vzc2lvbi5fbWFudWFsX3ZhbGlkYXRpb24gYW5kIHNlcnZlcl9hdXRoX2NvbXBsZXRlCiAgICAgICAgICAgIGlmIG5vdCB3b3VsZF9ibG9jayBhbmQgbm90IG1hbnVhbF92YWxpZGF0aW9uOgogICAgICAgICAgICAgICAgaGFuZGxlX3NlY19lcnJvcihoYW5kc2hha2VfcmVzdWx0LCBUTFNFcnJvcikKCiAgICAgICAgICAgIHNlbGYuX3Nlc3Npb25fY29udGV4dCA9IHNlc3Npb25fY29udGV4dAoKICAgICAgICAgICAgcHJvdG9jb2xfY29uc3RfcG9pbnRlciA9IG5ldyhTZWN1cml0eSwgJ1NTTFByb3RvY29sIConKQogICAgICAgICAgICByZXN1bHQgPSBTZWN1cml0eS5TU0xHZXROZWdvdGlhdGVkUHJvdG9jb2xWZXJzaW9uKAogICAgICAgICAgICAgICAgc2Vzc2lvbl9jb250ZXh0LAogICAgICAgICAgICAgICAgcHJvdG9jb2xfY29uc3RfcG9pbnRlcgogICAgICAgICAgICApCiAgICAgICAgICAgIGhhbmRsZV9zZWNfZXJyb3IocmVzdWx0KQogICAgICAgICAgICBwcm90b2NvbF9jb25zdCA9IGRlcmVmKHByb3RvY29sX2NvbnN0X3BvaW50ZXIpCgogICAgICAgICAgICBzZWxmLl9wcm90b2NvbCA9IF9QUk9UT0NPTF9DT05TVF9TVFJJTkdfTUFQW3Byb3RvY29sX2NvbnN0XQoKICAgICAgICAgICAgY2lwaGVyX2ludF9wb2ludGVyID0gbmV3KFNlY3VyaXR5LCAnU1NMQ2lwaGVyU3VpdGUgKicpCiAgICAgICAgICAgIHJlc3VsdCA9IFNlY3VyaXR5LlNTTEdldE5lZ290aWF0ZWRDaXBoZXIoCiAgICAgICAgICAgICAgICBzZXNzaW9uX2NvbnRleHQsCiAgICAgICAgICAgICAgICBjaXBoZXJfaW50X3BvaW50ZXIKICAgICAgICAgICAgKQogICAgICAgICAgICBoYW5kbGVfc2VjX2Vycm9yKHJlc3VsdCkKICAgICAgICAgICAgY2lwaGVyX2ludCA9IGRlcmVmKGNpcGhlcl9pbnRfcG9pbnRlcikKCiAgICAgICAgICAgIGNpcGhlcl9ieXRlcyA9IGludF90b19ieXRlcyhjaXBoZXJfaW50LCB3aWR0aD0yKQogICAgICAgICAgICBzZWxmLl9jaXBoZXJfc3VpdGUgPSBDSVBIRVJfU1VJVEVfTUFQLmdldChjaXBoZXJfYnl0ZXMsIGNpcGhlcl9ieXRlcykKCiAgICAgICAgICAgIHNlc3Npb25faW5mbyA9IHBhcnNlX3Nlc3Npb25faW5mbygKICAgICAgICAgICAgICAgIHNlbGYuX3NlcnZlcl9oZWxsbywKICAgICAgICAgICAgICAgIHNlbGYuX2NsaWVudF9oZWxsbwogICAgICAgICAgICApCiAgICAgICAgICAgIHNlbGYuX2NvbXByZXNzaW9uID0gc2Vzc2lvbl9pbmZvWydjb21wcmVzc2lvbiddCiAgICAgICAgICAgIHNlbGYuX3Nlc3Npb25faWQgPSBzZXNzaW9uX2luZm9bJ3Nlc3Npb25faWQnXQogICAgICAgICAgICBzZWxmLl9zZXNzaW9uX3RpY2tldCA9IHNlc3Npb25faW5mb1snc2Vzc2lvbl90aWNrZXQnXQoKICAgICAgICBleGNlcHQgKE9TRXJyb3IsIHNvY2tldF8uZXJyb3IpOgogICAgICAgICAgICBpZiBzZXNzaW9uX2NvbnRleHQ6CiAgICAgICAgICAgICAgICBpZiBvc3hfdmVyc2lvbl9pbmZvIDwgKDEwLCA4KToKICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSBTZWN1cml0eS5TU0xEaXNwb3NlQ29udGV4dChzZXNzaW9uX2NvbnRleHQpCiAgICAgICAgICAgICAgICAgICAgaGFuZGxlX3NlY19lcnJvcihyZXN1bHQpCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IENvcmVGb3VuZGF0aW9uLkNGUmVsZWFzZShzZXNzaW9uX2NvbnRleHQpCiAgICAgICAgICAgICAgICAgICAgaGFuZGxlX2NmX2Vycm9yKHJlc3VsdCkKCiAgICAgICAgICAgIHNlbGYuX3Nlc3Npb25fY29udGV4dCA9IE5vbmUKICAgICAgICAgICAgc2VsZi5jbG9zZSgpCgogICAgICAgICAgICByYWlzZQoKICAgICAgICBmaW5hbGx5OgogICAgICAgICAgICAjIFRyeWluZyB0byByZWxlYXNlIGNybF9zZWFyY2hfcmVmIG9yIG9jc3Bfc2VhcmNoX3JlZiByZXN1bHRzIGluCiAgICAgICAgICAgICMgYSBzZWdtZW50YXRpb24gZmF1bHQsIHNvIHdlIGRvIG5vdCBkbyB0aGF0CgogICAgICAgICAgICBpZiBzc2xfcG9saWN5X3JlZjoKICAgICAgICAgICAgICAgIHJlc3VsdCA9IENvcmVGb3VuZGF0aW9uLkNGUmVsZWFzZShzc2xfcG9saWN5X3JlZikKICAgICAgICAgICAgICAgIGhhbmRsZV9jZl9lcnJvcihyZXN1bHQpCiAgICAgICAgICAgICAgICBzc2xfcG9saWN5X3JlZiA9IE5vbmUKCiAgICAgICAgICAgIGlmIGNybF9wb2xpY3lfcmVmOgogICAgICAgICAgICAgICAgcmVzdWx0ID0gQ29yZUZvdW5kYXRpb24uQ0ZSZWxlYXNlKGNybF9wb2xpY3lfcmVmKQogICAgICAgICAgICAgICAgaGFuZGxlX2NmX2Vycm9yKHJlc3VsdCkKICAgICAgICAgICAgICAgIGNybF9wb2xpY3lfcmVmID0gTm9uZQoKICAgICAgICAgICAgaWYgb2NzcF9wb2xpY3lfcmVmOgogICAgICAgICAgICAgICAgcmVzdWx0ID0gQ29yZUZvdW5kYXRpb24uQ0ZSZWxlYXNlKG9jc3BfcG9saWN5X3JlZikKICAgICAgICAgICAgICAgIGhhbmRsZV9jZl9lcnJvcihyZXN1bHQpCiAgICAgICAgICAgICAgICBvY3NwX3BvbGljeV9yZWYgPSBOb25lCgogICAgICAgICAgICBpZiBwb2xpY3lfYXJyYXlfcmVmOgogICAgICAgICAgICAgICAgcmVzdWx0ID0gQ29yZUZvdW5kYXRpb24uQ0ZSZWxlYXNlKHBvbGljeV9hcnJheV9yZWYpCiAgICAgICAgICAgICAgICBoYW5kbGVfY2ZfZXJyb3IocmVzdWx0KQogICAgICAgICAgICAgICAgcG9saWN5X2FycmF5X3JlZiA9IE5vbmUKCiAgICAgICAgICAgIGlmIHRydXN0X3JlZjoKICAgICAgICAgICAgICAgIENvcmVGb3VuZGF0aW9uLkNGUmVsZWFzZSh0cnVzdF9yZWYpCiAgICAgICAgICAgICAgICB0cnVzdF9yZWYgPSBOb25lCgogICAgZGVmIHJlYWQoc2VsZiwgbWF4X2xlbmd0aCk6CiAgICAgICAgIiIiCiAgICAgICAgUmVhZHMgZGF0YSBmcm9tIHRoZSBUTFMtd3JhcHBlZCBzb2NrZXQKCiAgICAgICAgOnBhcmFtIG1heF9sZW5ndGg6CiAgICAgICAgICAgIFRoZSBudW1iZXIgb2YgYnl0ZXMgdG8gcmVhZCAtIG91dHB1dCBtYXkgYmUgbGVzcyB0aGFuIHRoaXMKCiAgICAgICAgOnJhaXNlczoKICAgICAgICAgICAgc29ja2V0LnNvY2tldCAtIHdoZW4gYSBub24tVExTIHNvY2tldCBlcnJvciBvY2N1cnMKICAgICAgICAgICAgb3NjcnlwdG8uZXJyb3JzLlRMU0Vycm9yIC0gd2hlbiBhIFRMUy1yZWxhdGVkIGVycm9yIG9jY3VycwogICAgICAgICAgICBvc2NyeXB0by5lcnJvcnMuVExTRGlzY29ubmVjdEVycm9yIC0gd2hlbiB0aGUgY29ubmVjdGlvbiBkaXNjb25uZWN0cwogICAgICAgICAgICBvc2NyeXB0by5lcnJvcnMuVExTR3JhY2VmdWxEaXNjb25uZWN0RXJyb3IgLSB3aGVuIHRoZSByZW1vdGUgZW5kIGdyYWNlZnVsbHkgY2xvc2VkIHRoZSBjb25uZWN0aW9uCiAgICAgICAgICAgIFZhbHVlRXJyb3IgLSB3aGVuIGFueSBvZiB0aGUgcGFyYW1ldGVycyBjb250YWluIGFuIGludmFsaWQgdmFsdWUKICAgICAgICAgICAgVHlwZUVycm9yIC0gd2hlbiBhbnkgb2YgdGhlIHBhcmFtZXRlcnMgYXJlIG9mIHRoZSB3cm9uZyB0eXBlCiAgICAgICAgICAgIE9TRXJyb3IgLSB3aGVuIGFuIGVycm9yIGlzIHJldHVybmVkIGJ5IHRoZSBPUyBjcnlwdG8gbGlicmFyeQoKICAgICAgICA6cmV0dXJuOgogICAgICAgICAgICBBIGJ5dGUgc3RyaW5nIG9mIHRoZSBkYXRhIHJlYWQKICAgICAgICAiIiIKCiAgICAgICAgaWYgbm90IGlzaW5zdGFuY2UobWF4X2xlbmd0aCwgaW50X3R5cGVzKToKICAgICAgICAgICAgcmFpc2UgVHlwZUVycm9yKHByZXR0eV9tZXNzYWdlKAogICAgICAgICAgICAgICAgJycnCiAgICAgICAgICAgICAgICBtYXhfbGVuZ3RoIG11c3QgYmUgYW4gaW50ZWdlciwgbm90ICVzCiAgICAgICAgICAgICAgICAnJycsCiAgICAgICAgICAgICAgICB0eXBlX25hbWUobWF4X2xlbmd0aCkKICAgICAgICAgICAgKSkKCiAgICAgICAgaWYgc2VsZi5fc2Vzc2lvbl9jb250ZXh0IGlzIE5vbmU6CiAgICAgICAgICAgICMgRXZlbiBpZiB0aGUgc2Vzc2lvbiBpcyBjbG9zZWQsIHdlIGNhbiB1c2UKICAgICAgICAgICAgIyBidWZmZXJlZCBkYXRhIHRvIHJlc3BvbmQgdG8gcmVhZCByZXF1ZXN0cwogICAgICAgICAgICBpZiBzZWxmLl9kZWNyeXB0ZWRfYnl0ZXMgIT0gYicnOgogICAgICAgICAgICAgICAgb3V0cHV0ID0gc2VsZi5fZGVjcnlwdGVkX2J5dGVzCiAgICAgICAgICAgICAgICBzZWxmLl9kZWNyeXB0ZWRfYnl0ZXMgPSBiJycKICAgICAgICAgICAgICAgIHJldHVybiBvdXRwdXQKCiAgICAgICAgICAgIHNlbGYuX3JhaXNlX2Nsb3NlZCgpCgogICAgICAgIGJ1ZmZlcmVkX2xlbmd0aCA9IGxlbihzZWxmLl9kZWNyeXB0ZWRfYnl0ZXMpCgogICAgICAgICMgSWYgd2UgYWxyZWFkeSBoYXZlIGVub3VnaCBidWZmZXJlZCBkYXRhLCBqdXN0IHVzZSB0aGF0CiAgICAgICAgaWYgYnVmZmVyZWRfbGVuZ3RoID49IG1heF9sZW5ndGg6CiAgICAgICAgICAgIG91dHB1dCA9IHNlbGYuX2RlY3J5cHRlZF9ieXRlc1swOm1heF9sZW5ndGhdCiAgICAgICAgICAgIHNlbGYuX2RlY3J5cHRlZF9ieXRlcyA9IHNlbGYuX2RlY3J5cHRlZF9ieXRlc1ttYXhfbGVuZ3RoOl0KICAgICAgICAgICAgcmV0dXJuIG91dHB1dAoKICAgICAgICAjIERvbid0IGJsb2NrIGlmIHdlIGhhdmUgYnVmZmVyZWQgZGF0YSBhdmFpbGFibGUsIHNpbmNlIGl0IGlzIG9rIHRvCiAgICAgICAgIyByZXR1cm4gbGVzcyB0aGFuIHRoZSBtYXhfbGVuZ3RoCiAgICAgICAgaWYgYnVmZmVyZWRfbGVuZ3RoID4gMCBhbmQgbm90IHNlbGYuc2VsZWN0X3JlYWQoMCk6CiAgICAgICAgICAgIG91dHB1dCA9IHNlbGYuX2RlY3J5cHRlZF9ieXRlcwogICAgICAgICAgICBzZWxmLl9kZWNyeXB0ZWRfYnl0ZXMgPSBiJycKICAgICAgICAgICAgcmV0dXJuIG91dHB1dAoKICAgICAgICAjIE9ubHkgcmVhZCBlbm91Z2ggdG8gZ2V0IHRoZSByZXF1ZXN0ZWQgYW1vdW50IHdoZW4KICAgICAgICAjIGNvbWJpbmVkIHdpdGggYnVmZmVyZWQgZGF0YQogICAgICAgIHRvX3JlYWQgPSBtYXhfbGVuZ3RoIC0gbGVuKHNlbGYuX2RlY3J5cHRlZF9ieXRlcykKCiAgICAgICAgcmVhZF9idWZmZXIgPSBidWZmZXJfZnJvbV9ieXRlcyh0b19yZWFkKQogICAgICAgIHByb2Nlc3NlZF9wb2ludGVyID0gbmV3KFNlY3VyaXR5LCAnc2l6ZV90IConKQogICAgICAgIHJlc3VsdCA9IFNlY3VyaXR5LlNTTFJlYWQoCiAgICAgICAgICAgIHNlbGYuX3Nlc3Npb25fY29udGV4dCwKICAgICAgICAgICAgcmVhZF9idWZmZXIsCiAgICAgICAgICAgIHRvX3JlYWQsCiAgICAgICAgICAgIHByb2Nlc3NlZF9wb2ludGVyCiAgICAgICAgKQogICAgICAgIGlmIHNlbGYuX2V4Y2VwdGlvbiBpcyBub3QgTm9uZToKICAgICAgICAgICAgZXhjZXB0aW9uID0gc2VsZi5fZXhjZXB0aW9uCiAgICAgICAgICAgIHNlbGYuX2V4Y2VwdGlvbiA9IE5vbmUKICAgICAgICAgICAgcmFpc2UgZXhjZXB0aW9uCiAgICAgICAgaWYgcmVzdWx0IGFuZCByZXN1bHQgbm90IGluIHNldChbU2VjdXJpdHlDb25zdC5lcnJTU0xXb3VsZEJsb2NrLCBTZWN1cml0eUNvbnN0LmVyclNTTENsb3NlZEdyYWNlZnVsXSk6CiAgICAgICAgICAgIGhhbmRsZV9zZWNfZXJyb3IocmVzdWx0LCBUTFNFcnJvcikKCiAgICAgICAgaWYgcmVzdWx0IGFuZCByZXN1bHQgPT0gU2VjdXJpdHlDb25zdC5lcnJTU0xDbG9zZWRHcmFjZWZ1bDoKICAgICAgICAgICAgc2VsZi5fZ3JhY2VmdWxseV9jbG9zZWQgPSBUcnVlCiAgICAgICAgICAgIHNlbGYuX3NodXRkb3duKEZhbHNlKQogICAgICAgICAgICBzZWxmLl9yYWlzZV9jbG9zZWQoKQoKICAgICAgICBieXRlc19yZWFkID0gZGVyZWYocHJvY2Vzc2VkX3BvaW50ZXIpCiAgICAgICAgb3V0cHV0ID0gc2VsZi5fZGVjcnlwdGVkX2J5dGVzICsgYnl0ZXNfZnJvbV9idWZmZXIocmVhZF9idWZmZXIsIGJ5dGVzX3JlYWQpCgogICAgICAgIHNlbGYuX2RlY3J5cHRlZF9ieXRlcyA9IG91dHB1dFttYXhfbGVuZ3RoOl0KICAgICAgICByZXR1cm4gb3V0cHV0WzA6bWF4X2xlbmd0aF0KCiAgICBkZWYgc2VsZWN0X3JlYWQoc2VsZiwgdGltZW91dD1Ob25lKToKICAgICAgICAiIiIKICAgICAgICBCbG9ja3MgdW50aWwgdGhlIHNvY2tldCBpcyByZWFkeSB0byBiZSByZWFkIGZyb20sIG9yIHRoZSB0aW1lb3V0IGlzIGhpdAoKICAgICAgICA6cGFyYW0gdGltZW91dDoKICAgICAgICAgICAgQSBmbG9hdCAtIHRoZSBwZXJpb2Qgb2YgdGltZSB0byB3YWl0IGZvciBkYXRhIHRvIGJlIHJlYWQuIE5vbmUgZm9yCiAgICAgICAgICAgIG5vIHRpbWUgbGltaXQuCgogICAgICAgIDpyZXR1cm46CiAgICAgICAgICAgIEEgYm9vbGVhbiAtIGlmIGRhdGEgaXMgcmVhZHkgdG8gYmUgcmVhZC4gV2lsbCBvbmx5IGJlIEZhbHNlIGlmCiAgICAgICAgICAgIHRpbWVvdXQgaXMgbm90IE5vbmUuCiAgICAgICAgIiIiCgogICAgICAgICMgSWYgd2UgaGF2ZSBidWZmZXJlZCBkYXRhLCB3ZSBjb25zaWRlciBhIHJlYWQgcG9zc2libGUKICAgICAgICBpZiBsZW4oc2VsZi5fZGVjcnlwdGVkX2J5dGVzKSA+IDA6CiAgICAgICAgICAgIHJldHVybiBUcnVlCgogICAgICAgIHJlYWRfcmVhZHksIF8sIF8gPSBzZWxlY3Quc2VsZWN0KFtzZWxmLl9zb2NrZXRdLCBbXSwgW10sIHRpbWVvdXQpCiAgICAgICAgcmV0dXJuIGxlbihyZWFkX3JlYWR5KSA+IDAKCiAgICBkZWYgcmVhZF91bnRpbChzZWxmLCBtYXJrZXIpOgogICAgICAgICIiIgogICAgICAgIFJlYWRzIGRhdGEgZnJvbSB0aGUgc29ja2V0IHVudGlsIGEgbWFya2VyIGlzIGZvdW5kLiBEYXRhIHJlYWQgaW5jbHVkZXMKICAgICAgICB0aGUgbWFya2VyLgoKICAgICAgICA6cGFyYW0gbWFya2VyOgogICAgICAgICAgICBBIGJ5dGUgc3RyaW5nIG9yIHJlZ2V4IG9iamVjdCBmcm9tIHJlLmNvbXBpbGUoKS4gVXNlZCB0byBkZXRlcm1pbmUKICAgICAgICAgICAgd2hlbiB0byBzdG9wIHJlYWRpbmcuIFJlZ2V4IG9iamVjdHMgYXJlIG1vcmUgaW5lZmZpY2llbnQgc2luY2UKICAgICAgICAgICAgdGhleSBtdXN0IHNjYW4gdGhlIGVudGlyZSBieXRlIHN0cmluZyBvZiByZWFkIGRhdGEgZWFjaCB0aW1lIGRhdGEKICAgICAgICAgICAgaXMgcmVhZCBvZmYgdGhlIHNvY2tldC4KCiAgICAgICAgOnJldHVybjoKICAgICAgICAgICAgQSBieXRlIHN0cmluZyBvZiB0aGUgZGF0YSByZWFkLCBpbmNsdWRpbmcgdGhlIG1hcmtlcgogICAgICAgICIiIgoKICAgICAgICBpZiBub3QgaXNpbnN0YW5jZShtYXJrZXIsIGJ5dGVfY2xzKSBhbmQgbm90IGlzaW5zdGFuY2UobWFya2VyLCBQYXR0ZXJuKToKICAgICAgICAgICAgcmFpc2UgVHlwZUVycm9yKHByZXR0eV9tZXNzYWdlKAogICAgICAgICAgICAgICAgJycnCiAgICAgICAgICAgICAgICBtYXJrZXIgbXVzdCBiZSBhIGJ5dGUgc3RyaW5nIG9yIGNvbXBpbGVkIHJlZ2V4IG9iamVjdCwgbm90ICVzCiAgICAgICAgICAgICAgICAnJycsCiAgICAgICAgICAgICAgICB0eXBlX25hbWUobWFya2VyKQogICAgICAgICAgICApKQoKICAgICAgICBvdXRwdXQgPSBiJycKCiAgICAgICAgaXNfcmVnZXggPSBpc2luc3RhbmNlKG1hcmtlciwgUGF0dGVybikKCiAgICAgICAgd2hpbGUgVHJ1ZToKICAgICAgICAgICAgaWYgbGVuKHNlbGYuX2RlY3J5cHRlZF9ieXRlcykgPiAwOgogICAgICAgICAgICAgICAgY2h1bmsgPSBzZWxmLl9kZWNyeXB0ZWRfYnl0ZXMKICAgICAgICAgICAgICAgIHNlbGYuX2RlY3J5cHRlZF9ieXRlcyA9IGInJwogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgdG9fcmVhZCA9IHNlbGYuX29zX2J1ZmZlcmVkX3NpemUoKSBvciA4MTkyCiAgICAgICAgICAgICAgICBjaHVuayA9IHNlbGYucmVhZCh0b19yZWFkKQoKICAgICAgICAgICAgb2Zmc2V0ID0gbGVuKG91dHB1dCkKICAgICAgICAgICAgb3V0cHV0ICs9IGNodW5rCgogICAgICAgICAgICBpZiBpc19yZWdleDoKICAgICAgICAgICAgICAgIG1hdGNoID0gbWFya2VyLnNlYXJjaChvdXRwdXQpCiAgICAgICAgICAgICAgICBpZiBtYXRjaCBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgICAgICBlbmQgPSBtYXRjaC5lbmQoKQogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAjIElmIHRoZSBtYXJrZXIgd2FzIG5vdCBmb3VuZCBsYXN0IHRpbWUsIHdlIGhhdmUgdG8gc3RhcnQKICAgICAgICAgICAgICAgICMgYXQgYSBwb3NpdGlvbiB3aGVyZSB0aGUgbWFya2VyIHdvdWxkIGhhdmUgaXRzIGZpbmFsIGNoYXIKICAgICAgICAgICAgICAgICMgaW4gdGhlIG5ld2x5IHJlYWQgY2h1bmsKICAgICAgICAgICAgICAgIHN0YXJ0ID0gbWF4KDAsIG9mZnNldCAtIGxlbihtYXJrZXIpIC0gMSkKICAgICAgICAgICAgICAgIG1hdGNoID0gb3V0cHV0LmZpbmQobWFya2VyLCBzdGFydCkKICAgICAgICAgICAgICAgIGlmIG1hdGNoICE9IC0xOgogICAgICAgICAgICAgICAgICAgIGVuZCA9IG1hdGNoICsgbGVuKG1hcmtlcikKICAgICAgICAgICAgICAgICAgICBicmVhawoKICAgICAgICBzZWxmLl9kZWNyeXB0ZWRfYnl0ZXMgPSBvdXRwdXRbZW5kOl0gKyBzZWxmLl9kZWNyeXB0ZWRfYnl0ZXMKICAgICAgICByZXR1cm4gb3V0cHV0WzA6ZW5kXQoKICAgIGRlZiBfb3NfYnVmZmVyZWRfc2l6ZShzZWxmKToKICAgICAgICAiIiIKICAgICAgICBSZXR1cm5zIHRoZSBudW1iZXIgb2YgYnl0ZXMgb2YgZGVjcnlwdGVkIGRhdGEgc3RvcmVkIGluIHRoZSBTZWN1cmUKICAgICAgICBUcmFuc3BvcnQgcmVhZCBidWZmZXIuIFRoaXMgYW1vdW50IG9mIGRhdGEgY2FuIGJlIHJlYWQgZnJvbSBTU0xSZWFkKCkKICAgICAgICB3aXRob3V0IGNhbGxpbmcgc2VsZi5fc29ja2V0LnJlY3YoKS4KCiAgICAgICAgOnJldHVybjoKICAgICAgICAgICAgQW4gaW50ZWdlciAtIHRoZSBudW1iZXIgb2YgYXZhaWxhYmxlIGJ5dGVzCiAgICAgICAgIiIiCgogICAgICAgIG51bV9ieXRlc19wb2ludGVyID0gbmV3KFNlY3VyaXR5LCAnc2l6ZV90IConKQogICAgICAgIHJlc3VsdCA9IFNlY3VyaXR5LlNTTEdldEJ1ZmZlcmVkUmVhZFNpemUoCiAgICAgICAgICAgIHNlbGYuX3Nlc3Npb25fY29udGV4dCwKICAgICAgICAgICAgbnVtX2J5dGVzX3BvaW50ZXIKICAgICAgICApCiAgICAgICAgaGFuZGxlX3NlY19lcnJvcihyZXN1bHQpCgogICAgICAgIHJldHVybiBkZXJlZihudW1fYnl0ZXNfcG9pbnRlcikKCiAgICBkZWYgcmVhZF9saW5lKHNlbGYpOgogICAgICAgIHIiIiIKICAgICAgICBSZWFkcyBhIGxpbmUgZnJvbSB0aGUgc29ja2V0LCBpbmNsdWRpbmcgdGhlIGxpbmUgZW5kaW5nIG9mICJcclxuIiwgIlxyIiwKICAgICAgICBvciAiXG4iCgogICAgICAgIDpyZXR1cm46CiAgICAgICAgICAgIEEgYnl0ZSBzdHJpbmcgb2YgdGhlIG5leHQgbGluZSBmcm9tIHRoZSBzb2NrZXQKICAgICAgICAiIiIKCiAgICAgICAgcmV0dXJuIHNlbGYucmVhZF91bnRpbChfbGluZV9yZWdleCkKCiAgICBkZWYgcmVhZF9leGFjdGx5KHNlbGYsIG51bV9ieXRlcyk6CiAgICAgICAgIiIiCiAgICAgICAgUmVhZHMgZXhhY3RseSB0aGUgc3BlY2lmaWVkIG51bWJlciBvZiBieXRlcyBmcm9tIHRoZSBzb2NrZXQKCiAgICAgICAgOnBhcmFtIG51bV9ieXRlczoKICAgICAgICAgICAgQW4gaW50ZWdlciAtIHRoZSBleGFjdCBudW1iZXIgb2YgYnl0ZXMgdG8gcmVhZAoKICAgICAgICA6cmV0dXJuOgogICAgICAgICAgICBBIGJ5dGUgc3RyaW5nIG9mIHRoZSBkYXRhIHRoYXQgd2FzIHJlYWQKICAgICAgICAiIiIKCiAgICAgICAgb3V0cHV0ID0gYicnCiAgICAgICAgcmVtYWluaW5nID0gbnVtX2J5dGVzCiAgICAgICAgd2hpbGUgcmVtYWluaW5nID4gMDoKICAgICAgICAgICAgb3V0cHV0ICs9IHNlbGYucmVhZChyZW1haW5pbmcpCiAgICAgICAgICAgIHJlbWFpbmluZyA9IG51bV9ieXRlcyAtIGxlbihvdXRwdXQpCgogICAgICAgIHJldHVybiBvdXRwdXQKCiAgICBkZWYgd3JpdGUoc2VsZiwgZGF0YSk6CiAgICAgICAgIiIiCiAgICAgICAgV3JpdGVzIGRhdGEgdG8gdGhlIFRMUy13cmFwcGVkIHNvY2tldAoKICAgICAgICA6cGFyYW0gZGF0YToKICAgICAgICAgICAgQSBieXRlIHN0cmluZyB0byB3cml0ZSB0byB0aGUgc29ja2V0CgogICAgICAgIDpyYWlzZXM6CiAgICAgICAgICAgIHNvY2tldC5zb2NrZXQgLSB3aGVuIGEgbm9uLVRMUyBzb2NrZXQgZXJyb3Igb2NjdXJzCiAgICAgICAgICAgIG9zY3J5cHRvLmVycm9ycy5UTFNFcnJvciAtIHdoZW4gYSBUTFMtcmVsYXRlZCBlcnJvciBvY2N1cnMKICAgICAgICAgICAgb3NjcnlwdG8uZXJyb3JzLlRMU0Rpc2Nvbm5lY3RFcnJvciAtIHdoZW4gdGhlIGNvbm5lY3Rpb24gZGlzY29ubmVjdHMKICAgICAgICAgICAgb3NjcnlwdG8uZXJyb3JzLlRMU0dyYWNlZnVsRGlzY29ubmVjdEVycm9yIC0gd2hlbiB0aGUgcmVtb3RlIGVuZCBncmFjZWZ1bGx5IGNsb3NlZCB0aGUgY29ubmVjdGlvbgogICAgICAgICAgICBWYWx1ZUVycm9yIC0gd2hlbiBhbnkgb2YgdGhlIHBhcmFtZXRlcnMgY29udGFpbiBhbiBpbnZhbGlkIHZhbHVlCiAgICAgICAgICAgIFR5cGVFcnJvciAtIHdoZW4gYW55IG9mIHRoZSBwYXJhbWV0ZXJzIGFyZSBvZiB0aGUgd3JvbmcgdHlwZQogICAgICAgICAgICBPU0Vycm9yIC0gd2hlbiBhbiBlcnJvciBpcyByZXR1cm5lZCBieSB0aGUgT1MgY3J5cHRvIGxpYnJhcnkKICAgICAgICAiIiIKCiAgICAgICAgaWYgc2VsZi5fc2Vzc2lvbl9jb250ZXh0IGlzIE5vbmU6CiAgICAgICAgICAgIHNlbGYuX3JhaXNlX2Nsb3NlZCgpCgogICAgICAgIHByb2Nlc3NlZF9wb2ludGVyID0gbmV3KFNlY3VyaXR5LCAnc2l6ZV90IConKQoKICAgICAgICBkYXRhX2xlbiA9IGxlbihkYXRhKQogICAgICAgIHdoaWxlIGRhdGFfbGVuOgogICAgICAgICAgICB3cml0ZV9idWZmZXIgPSBidWZmZXJfZnJvbV9ieXRlcyhkYXRhKQogICAgICAgICAgICByZXN1bHQgPSBTZWN1cml0eS5TU0xXcml0ZSgKICAgICAgICAgICAgICAgIHNlbGYuX3Nlc3Npb25fY29udGV4dCwKICAgICAgICAgICAgICAgIHdyaXRlX2J1ZmZlciwKICAgICAgICAgICAgICAgIGRhdGFfbGVuLAogICAgICAgICAgICAgICAgcHJvY2Vzc2VkX3BvaW50ZXIKICAgICAgICAgICAgKQogICAgICAgICAgICBpZiBzZWxmLl9leGNlcHRpb24gaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICBleGNlcHRpb24gPSBzZWxmLl9leGNlcHRpb24KICAgICAgICAgICAgICAgIHNlbGYuX2V4Y2VwdGlvbiA9IE5vbmUKICAgICAgICAgICAgICAgIHJhaXNlIGV4Y2VwdGlvbgogICAgICAgICAgICBoYW5kbGVfc2VjX2Vycm9yKHJlc3VsdCwgVExTRXJyb3IpCgogICAgICAgICAgICBieXRlc193cml0dGVuID0gZGVyZWYocHJvY2Vzc2VkX3BvaW50ZXIpCiAgICAgICAgICAgIGRhdGEgPSBkYXRhW2J5dGVzX3dyaXR0ZW46XQogICAgICAgICAgICBkYXRhX2xlbiA9IGxlbihkYXRhKQogICAgICAgICAgICBpZiBkYXRhX2xlbiA+IDA6CiAgICAgICAgICAgICAgICBzZWxmLnNlbGVjdF93cml0ZSgpCgogICAgZGVmIHNlbGVjdF93cml0ZShzZWxmLCB0aW1lb3V0PU5vbmUpOgogICAgICAgICIiIgogICAgICAgIEJsb2NrcyB1bnRpbCB0aGUgc29ja2V0IGlzIHJlYWR5IHRvIGJlIHdyaXR0ZW4gdG8sIG9yIHRoZSB0aW1lb3V0IGlzIGhpdAoKICAgICAgICA6cGFyYW0gdGltZW91dDoKICAgICAgICAgICAgQSBmbG9hdCAtIHRoZSBwZXJpb2Qgb2YgdGltZSB0byB3YWl0IGZvciB0aGUgc29ja2V0IHRvIGJlIHJlYWR5IHRvCiAgICAgICAgICAgIHdyaXR0ZW4gdG8uIE5vbmUgZm9yIG5vIHRpbWUgbGltaXQuCgogICAgICAgIDpyZXR1cm46CiAgICAgICAgICAgIEEgYm9vbGVhbiAtIGlmIHRoZSBzb2NrZXQgaXMgcmVhZHkgZm9yIHdyaXRpbmcuIFdpbGwgb25seSBiZSBGYWxzZQogICAgICAgICAgICBpZiB0aW1lb3V0IGlzIG5vdCBOb25lLgogICAgICAgICIiIgoKICAgICAgICBfLCB3cml0ZV9yZWFkeSwgXyA9IHNlbGVjdC5zZWxlY3QoW10sIFtzZWxmLl9zb2NrZXRdLCBbXSwgdGltZW91dCkKICAgICAgICByZXR1cm4gbGVuKHdyaXRlX3JlYWR5KSA+IDAKCiAgICBkZWYgX3NodXRkb3duKHNlbGYsIG1hbnVhbCk6CiAgICAgICAgIiIiCiAgICAgICAgU2h1dHMgZG93biB0aGUgVExTIHNlc3Npb24gYW5kIHRoZW4gc2h1dHMgZG93biB0aGUgdW5kZXJseWluZyBzb2NrZXQKCiAgICAgICAgOnBhcmFtIG1hbnVhbDoKICAgICAgICAgICAgQSBib29sZWFuIGlmIHRoZSBjb25uZWN0aW9uIHdhcyBtYW51YWxseSBzaHV0ZG93bgogICAgICAgICIiIgoKICAgICAgICBpZiBzZWxmLl9zZXNzaW9uX2NvbnRleHQgaXMgTm9uZToKICAgICAgICAgICAgcmV0dXJuCgogICAgICAgICMgSWdub3JlIGVycm9yIGR1cmluZyBjbG9zZSBpbiBjYXNlIG90aGVyIGVuZCBjbG9zZWQgYWxyZWFkeQogICAgICAgIHJlc3VsdCA9IFNlY3VyaXR5LlNTTENsb3NlKHNlbGYuX3Nlc3Npb25fY29udGV4dCkKCiAgICAgICAgaWYgb3N4X3ZlcnNpb25faW5mbyA8ICgxMCwgOCk6CiAgICAgICAgICAgIHJlc3VsdCA9IFNlY3VyaXR5LlNTTERpc3Bvc2VDb250ZXh0KHNlbGYuX3Nlc3Npb25fY29udGV4dCkKICAgICAgICAgICAgaGFuZGxlX3NlY19lcnJvcihyZXN1bHQpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmVzdWx0ID0gQ29yZUZvdW5kYXRpb24uQ0ZSZWxlYXNlKHNlbGYuX3Nlc3Npb25fY29udGV4dCkKICAgICAgICAgICAgaGFuZGxlX2NmX2Vycm9yKHJlc3VsdCkKCiAgICAgICAgc2VsZi5fc2Vzc2lvbl9jb250ZXh0ID0gTm9uZQoKICAgICAgICBpZiBtYW51YWw6CiAgICAgICAgICAgIHNlbGYuX2xvY2FsX2Nsb3NlZCA9IFRydWUKCiAgICAgICAgdHJ5OgogICAgICAgICAgICBzZWxmLl9zb2NrZXQuc2h1dGRvd24oc29ja2V0Xy5TSFVUX1JEV1IpCiAgICAgICAgZXhjZXB0IChzb2NrZXRfLmVycm9yKToKICAgICAgICAgICAgcGFzcwoKICAgIGRlZiBzaHV0ZG93bihzZWxmKToKICAgICAgICAiIiIKICAgICAgICBTaHV0cyBkb3duIHRoZSBUTFMgc2Vzc2lvbiBhbmQgdGhlbiBzaHV0cyBkb3duIHRoZSB1bmRlcmx5aW5nIHNvY2tldAogICAgICAgICIiIgoKICAgICAgICBzZWxmLl9zaHV0ZG93bihUcnVlKQoKICAgIGRlZiBjbG9zZShzZWxmKToKICAgICAgICAiIiIKICAgICAgICBTaHV0cyBkb3duIHRoZSBUTFMgc2Vzc2lvbiBhbmQgc29ja2V0IGFuZCBmb3JjaWJseSBjbG9zZXMgaXQKICAgICAgICAiIiIKCiAgICAgICAgdHJ5OgogICAgICAgICAgICBzZWxmLnNodXRkb3duKCkKCiAgICAgICAgZmluYWxseToKICAgICAgICAgICAgaWYgc2VsZi5fc29ja2V0OgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIHNlbGYuX3NvY2tldC5jbG9zZSgpCiAgICAgICAgICAgICAgICBleGNlcHQgKHNvY2tldF8uZXJyb3IpOgogICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgICAgIHNlbGYuX3NvY2tldCA9IE5vbmUKCiAgICAgICAgICAgIGlmIHNlbGYuX2Nvbm5lY3Rpb25faWQgaW4gX3NvY2tldF9yZWZzOgogICAgICAgICAgICAgICAgZGVsIF9zb2NrZXRfcmVmc1tzZWxmLl9jb25uZWN0aW9uX2lkXQoKICAgIGRlZiBfcmVhZF9jZXJ0aWZpY2F0ZXMoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgUmVhZHMgZW5kLWVudGl0eSBhbmQgaW50ZXJtZWRpYXRlIGNlcnRpZmljYXRlIGluZm9ybWF0aW9uIGZyb20gdGhlCiAgICAgICAgVExTIHNlc3Npb24KICAgICAgICAiIiIKCiAgICAgICAgdHJ1c3RfcmVmID0gTm9uZQogICAgICAgIGNmX2RhdGFfcmVmID0gTm9uZQogICAgICAgIHJlc3VsdCA9IE5vbmUKCiAgICAgICAgdHJ5OgogICAgICAgICAgICB0cnVzdF9yZWZfcG9pbnRlciA9IG5ldyhTZWN1cml0eSwgJ1NlY1RydXN0UmVmIConKQogICAgICAgICAgICByZXN1bHQgPSBTZWN1cml0eS5TU0xDb3B5UGVlclRydXN0KAogICAgICAgICAgICAgICAgc2VsZi5fc2Vzc2lvbl9jb250ZXh0LAogICAgICAgICAgICAgICAgdHJ1c3RfcmVmX3BvaW50ZXIKICAgICAgICAgICAgKQogICAgICAgICAgICBoYW5kbGVfc2VjX2Vycm9yKHJlc3VsdCkKCiAgICAgICAgICAgIHRydXN0X3JlZiA9IHVud3JhcCh0cnVzdF9yZWZfcG9pbnRlcikKCiAgICAgICAgICAgIG51bWJlcl9jZXJ0cyA9IFNlY3VyaXR5LlNlY1RydXN0R2V0Q2VydGlmaWNhdGVDb3VudCh0cnVzdF9yZWYpCgogICAgICAgICAgICBzZWxmLl9pbnRlcm1lZGlhdGVzID0gW10KCiAgICAgICAgICAgIGZvciBpbmRleCBpbiByYW5nZSgwLCBudW1iZXJfY2VydHMpOgogICAgICAgICAgICAgICAgc2VjX2NlcnRpZmljYXRlX3JlZiA9IFNlY3VyaXR5LlNlY1RydXN0R2V0Q2VydGlmaWNhdGVBdEluZGV4KAogICAgICAgICAgICAgICAgICAgIHRydXN0X3JlZiwKICAgICAgICAgICAgICAgICAgICBpbmRleAogICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgY2ZfZGF0YV9yZWYgPSBTZWN1cml0eS5TZWNDZXJ0aWZpY2F0ZUNvcHlEYXRhKHNlY19jZXJ0aWZpY2F0ZV9yZWYpCgogICAgICAgICAgICAgICAgY2VydF9kYXRhID0gQ0ZIZWxwZXJzLmNmX2RhdGFfdG9fYnl0ZXMoY2ZfZGF0YV9yZWYpCgogICAgICAgICAgICAgICAgcmVzdWx0ID0gQ29yZUZvdW5kYXRpb24uQ0ZSZWxlYXNlKGNmX2RhdGFfcmVmKQogICAgICAgICAgICAgICAgaGFuZGxlX2NmX2Vycm9yKHJlc3VsdCkKICAgICAgICAgICAgICAgIGNmX2RhdGFfcmVmID0gTm9uZQoKICAgICAgICAgICAgICAgIGNlcnQgPSBBc24xQ2VydGlmaWNhdGUubG9hZChjZXJ0X2RhdGEpCgogICAgICAgICAgICAgICAgaWYgaW5kZXggPT0gMDoKICAgICAgICAgICAgICAgICAgICBzZWxmLl9jZXJ0aWZpY2F0ZSA9IGNlcnQKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5faW50ZXJtZWRpYXRlcy5hcHBlbmQoY2VydCkKCiAgICAgICAgZmluYWxseToKICAgICAgICAgICAgaWYgdHJ1c3RfcmVmOgogICAgICAgICAgICAgICAgcmVzdWx0ID0gQ29yZUZvdW5kYXRpb24uQ0ZSZWxlYXNlKHRydXN0X3JlZikKICAgICAgICAgICAgICAgIGhhbmRsZV9jZl9lcnJvcihyZXN1bHQpCiAgICAgICAgICAgIGlmIGNmX2RhdGFfcmVmOgogICAgICAgICAgICAgICAgcmVzdWx0ID0gQ29yZUZvdW5kYXRpb24uQ0ZSZWxlYXNlKGNmX2RhdGFfcmVmKQogICAgICAgICAgICAgICAgaGFuZGxlX2NmX2Vycm9yKHJlc3VsdCkKCiAgICBkZWYgX3JhaXNlX2Nsb3NlZChzZWxmKToKICAgICAgICAiIiIKICAgICAgICBSYWlzZXMgYW4gZXhjZXB0aW9uIGRlc2NyaWJpbmcgaWYgdGhlIGxvY2FsIG9yIHJlbW90ZSBlbmQgY2xvc2VkIHRoZQogICAgICAgIGNvbm5lY3Rpb24KICAgICAgICAiIiIKCiAgICAgICAgaWYgc2VsZi5fbG9jYWxfY2xvc2VkOgogICAgICAgICAgICByYWlzZSBUTFNEaXNjb25uZWN0RXJyb3IoJ1RoZSBjb25uZWN0aW9uIHdhcyBhbHJlYWR5IGNsb3NlZCcpCiAgICAgICAgZWxpZiBzZWxmLl9ncmFjZWZ1bGx5X2Nsb3NlZDoKICAgICAgICAgICAgcmFpc2UgVExTR3JhY2VmdWxEaXNjb25uZWN0RXJyb3IoJ1RoZSByZW1vdGUgZW5kIGNsb3NlZCB0aGUgY29ubmVjdGlvbicpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmFpc2UgVExTRGlzY29ubmVjdEVycm9yKCdUaGUgY29ubmVjdGlvbiB3YXMgY2xvc2VkJykKCiAgICBAcHJvcGVydHkKICAgIGRlZiBjZXJ0aWZpY2F0ZShzZWxmKToKICAgICAgICAiIiIKICAgICAgICBBbiBhc24xY3J5cHRvLng1MDkuQ2VydGlmaWNhdGUgb2JqZWN0IG9mIHRoZSBlbmQtZW50aXR5IGNlcnRpZmljYXRlCiAgICAgICAgcHJlc2VudGVkIGJ5IHRoZSBzZXJ2ZXIKICAgICAgICAiIiIKCiAgICAgICAgaWYgc2VsZi5fc2Vzc2lvbl9jb250ZXh0IGlzIE5vbmU6CiAgICAgICAgICAgIHNlbGYuX3JhaXNlX2Nsb3NlZCgpCgogICAgICAgIGlmIHNlbGYuX2NlcnRpZmljYXRlIGlzIE5vbmU6CiAgICAgICAgICAgIHNlbGYuX3JlYWRfY2VydGlmaWNhdGVzKCkKCiAgICAgICAgcmV0dXJuIHNlbGYuX2NlcnRpZmljYXRlCgogICAgQHByb3BlcnR5CiAgICBkZWYgaW50ZXJtZWRpYXRlcyhzZWxmKToKICAgICAgICAiIiIKICAgICAgICBBIGxpc3Qgb2YgYXNuMWNyeXB0by54NTA5LkNlcnRpZmljYXRlIG9iamVjdHMgdGhhdCB3ZXJlIHByZXNlbnRlZCBhcwogICAgICAgIGludGVybWVkaWF0ZXMgYnkgdGhlIHNlcnZlcgogICAgICAgICIiIgoKICAgICAgICBpZiBzZWxmLl9zZXNzaW9uX2NvbnRleHQgaXMgTm9uZToKICAgICAgICAgICAgc2VsZi5fcmFpc2VfY2xvc2VkKCkKCiAgICAgICAgaWYgc2VsZi5fY2VydGlmaWNhdGUgaXMgTm9uZToKICAgICAgICAgICAgc2VsZi5fcmVhZF9jZXJ0aWZpY2F0ZXMoKQoKICAgICAgICByZXR1cm4gc2VsZi5faW50ZXJtZWRpYXRlcwoKICAgIEBwcm9wZXJ0eQogICAgZGVmIGNpcGhlcl9zdWl0ZShzZWxmKToKICAgICAgICAiIiIKICAgICAgICBBIHVuaWNvZGUgc3RyaW5nIG9mIHRoZSBJQU5BIGNpcGhlciBzdWl0ZSBuYW1lIG9mIHRoZSBuZWdvdGlhdGVkCiAgICAgICAgY2lwaGVyIHN1aXRlCiAgICAgICAgIiIiCgogICAgICAgIHJldHVybiBzZWxmLl9jaXBoZXJfc3VpdGUKCiAgICBAcHJvcGVydHkKICAgIGRlZiBwcm90b2NvbChzZWxmKToKICAgICAgICAiIiIKICAgICAgICBBIHVuaWNvZGUgc3RyaW5nIG9mOiAiVExTdjEuMiIsICJUTFN2MS4xIiwgIlRMU3YxIiwgIlNTTHYzIgogICAgICAgICIiIgoKICAgICAgICByZXR1cm4gc2VsZi5fcHJvdG9jb2wKCiAgICBAcHJvcGVydHkKICAgIGRlZiBjb21wcmVzc2lvbihzZWxmKToKICAgICAgICAiIiIKICAgICAgICBBIGJvb2xlYW4gaWYgY29tcHJlc3Npb24gaXMgZW5hYmxlZAogICAgICAgICIiIgoKICAgICAgICByZXR1cm4gc2VsZi5fY29tcHJlc3Npb24KCiAgICBAcHJvcGVydHkKICAgIGRlZiBzZXNzaW9uX2lkKHNlbGYpOgogICAgICAgICIiIgogICAgICAgIEEgdW5pY29kZSBzdHJpbmcgb2YgIm5ldyIgb3IgInJldXNlZCIgb3IgTm9uZSBmb3Igbm8gdGlja2V0CiAgICAgICAgIiIiCgogICAgICAgIHJldHVybiBzZWxmLl9zZXNzaW9uX2lkCgogICAgQHByb3BlcnR5CiAgICBkZWYgc2Vzc2lvbl90aWNrZXQoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgQSB1bmljb2RlIHN0cmluZyBvZiAibmV3IiBvciAicmV1c2VkIiBvciBOb25lIGZvciBubyB0aWNrZXQKICAgICAgICAiIiIKCiAgICAgICAgcmV0dXJuIHNlbGYuX3Nlc3Npb25fdGlja2V0CgogICAgQHByb3BlcnR5CiAgICBkZWYgc2Vzc2lvbihzZWxmKToKICAgICAgICAiIiIKICAgICAgICBUaGUgb3NjcnlwdG8udGxzLlRMU1Nlc3Npb24gb2JqZWN0IHVzZWQgZm9yIHRoaXMgY29ubmVjdGlvbgogICAgICAgICIiIgoKICAgICAgICByZXR1cm4gc2VsZi5fc2Vzc2lvbgoKICAgIEBwcm9wZXJ0eQogICAgZGVmIGhvc3RuYW1lKHNlbGYpOgogICAgICAgICIiIgogICAgICAgIEEgdW5pY29kZSBzdHJpbmcgb2YgdGhlIFRMUyBzZXJ2ZXIgZG9tYWluIG5hbWUgb3IgSVAgYWRkcmVzcwogICAgICAgICIiIgoKICAgICAgICByZXR1cm4gc2VsZi5faG9zdG5hbWUKCiAgICBAcHJvcGVydHkKICAgIGRlZiBwb3J0KHNlbGYpOgogICAgICAgICIiIgogICAgICAgIEFuIGludGVnZXIgb2YgdGhlIHBvcnQgbnVtYmVyIHRoZSBzb2NrZXQgaXMgY29ubmVjdGVkIHRvCiAgICAgICAgIiIiCgogICAgICAgIHJldHVybiBzZWxmLnNvY2tldC5nZXRwZWVybmFtZSgpWzFdCgogICAgQHByb3BlcnR5CiAgICBkZWYgc29ja2V0KHNlbGYpOgogICAgICAgICIiIgogICAgICAgIFRoZSB1bmRlcmx5aW5nIHNvY2tldC5zb2NrZXQgY29ubmVjdGlvbgogICAgICAgICIiIgoKICAgICAgICBpZiBzZWxmLl9zZXNzaW9uX2NvbnRleHQgaXMgTm9uZToKICAgICAgICAgICAgc2VsZi5fcmFpc2VfY2xvc2VkKCkKCiAgICAgICAgcmV0dXJuIHNlbGYuX3NvY2tldAoKICAgIGRlZiBfX2RlbF9fKHNlbGYpOgogICAgICAgIHNlbGYuY2xvc2UoKQo=
