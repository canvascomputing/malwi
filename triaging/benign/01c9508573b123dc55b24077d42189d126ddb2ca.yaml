statistics:
  total_files: 1
  skipped_files: 0.0
  processed_objects: 1
  malicious_objects: 0
details:
- path: .repo_cache/malicious_repos/pypi_malregistry/discord-py-v13/1.3/discord_py_v13-1.3-py3-none-any/discord-py-v13/webhook.py
  contents:
  - name: Webhook.send
    score: 0.0
    code: |-
      def send(self, content=None, *, wait=False, username=None, avatar_url=None, tts=False,
                                          file=None, files=None, embed=None, embeds=None, allowed_mentions=None):
              """|maybecoro|

              Sends a message using the webhook.

              If the webhook is constructed with a :class:`RequestsWebhookAdapter` then this is
              not a coroutine.

              The content must be a type that can convert to a string through ``str(content)``.

              To upload a single file, the ``file`` parameter should be used with a
              single :class:`File` object.

              If the ``embed`` parameter is provided, it must be of type :class:`Embed` and
              it must be a rich embed type. You cannot mix the ``embed`` parameter with the
              ``embeds`` parameter, which must be a :class:`list` of :class:`Embed` objects to send.

              Parameters
              ------------
              content: :class:`str`
                  The content of the message to send.
              wait: :class:`bool`
                  Whether the server should wait before sending a response. This essentially
                  means that the return type of this function changes from ``None`` to
                  a :class:`WebhookMessage` if set to ``True``.
              username: :class:`str`
                  The username to send with this message. If no username is provided
                  then the default username for the webhook is used.
              avatar_url: Union[:class:`str`, :class:`Asset`]
                  The avatar URL to send with this message. If no avatar URL is provided
                  then the default avatar for the webhook is used.
              tts: :class:`bool`
                  Indicates if the message should be sent using text-to-speech.
              file: :class:`File`
                  The file to upload. This cannot be mixed with ``files`` parameter.
              files: List[:class:`File`]
                  A list of files to send with the content. This cannot be mixed with the
                  ``file`` parameter.
              embed: :class:`Embed`
                  The rich embed for the content to send. This cannot be mixed with
                  ``embeds`` parameter.
              embeds: List[:class:`Embed`]
                  A list of embeds to send with the content. Maximum of 10. This cannot
                  be mixed with the ``embed`` parameter.
              allowed_mentions: :class:`AllowedMentions`
                  Controls the mentions being processed in this message.

                  .. versionadded:: 1.4

              Raises
              --------
              HTTPException
                  Sending the message failed.
              NotFound
                  This webhook was not found.
              Forbidden
                  The authorization token for the webhook is incorrect.
              InvalidArgument
                  You specified both ``embed`` and ``embeds`` or the length of
                  ``embeds`` was invalid or there was no token associated with
                  this webhook.

              Returns
              ---------
              Optional[:class:`WebhookMessage`]
                  The message that was sent.
              """

              payload = {}
              if self.token is None:
                  raise InvalidArgument('This webhook does not have a token associated with it')
              if files is not None and file is not None:
                  raise InvalidArgument('Cannot mix file and files keyword arguments.')
              if embeds is not None and embed is not None:
                  raise InvalidArgument('Cannot mix embed and embeds keyword arguments.')

              if embeds is not None:
                  if len(embeds) > 10:
                      raise InvalidArgument('embeds has a maximum of 10 elements.')
                  payload['embeds'] = [e.to_dict() for e in embeds]

              if embed is not None:
                  payload['embeds'] = [embed.to_dict()]

              if content is not None:
                  payload['content'] = str(content)

              payload['tts'] = tts
              if avatar_url:
                  payload['avatar_url'] = str(avatar_url)
              if username:
                  payload['username'] = username

              previous_mentions = getattr(self._state, 'allowed_mentions', None)

              if allowed_mentions:
                  if previous_mentions is not None:
                      payload['allowed_mentions'] = previous_mentions.merge(allowed_mentions).to_dict()
                  else:
                      payload['allowed_mentions'] = allowed_mentions.to_dict()
              elif previous_mentions is not None:
                  payload['allowed_mentions'] = previous_mentions.to_dict()

              return self._adapter.execute_webhook(wait=wait, file=file, files=files, payload=payload)
    tokens: resume build_map store_fast payload load_fast self load_attr token pop_jump_if_not_none TO_NUMBER load_global InvalidArgument load_const STRING_LEN_S_ENT_HIGH call raise_varargs load_fast files pop_jump_if_none TO_NUMBER load_fast file pop_jump_if_none TO_NUMBER load_global InvalidArgument load_const STRING_LEN_S_ENT_HIGH call raise_varargs load_fast embeds pop_jump_if_none TO_NUMBER load_fast embed pop_jump_if_none TO_NUMBER load_global InvalidArgument load_const STRING_LEN_S_ENT_HIGH call raise_varargs load_fast embeds pop_jump_if_none TO_NUMBER load_global len load_fast embeds call load_const INTEGER compare_op > pop_jump_if_false TO_NUMBER load_global InvalidArgument load_const STRING_LEN_S_ENT_HIGH call raise_varargs load_fast embeds get_iter load_fast_and_clear e swap build_list swap for_iter TO_NUMBER store_fast e load_fast e load_attr to_dict call list_append jump_backward TO_NUMBER end_for swap store_fast e load_fast payload load_const embeds store_subscr load_fast embed pop_jump_if_none TO_NUMBER load_fast embed load_attr to_dict call build_list load_fast payload load_const embeds store_subscr load_fast content pop_jump_if_none TO_NUMBER load_global str load_fast content call load_fast payload load_const content store_subscr load_fast tts load_fast payload load_const tts store_subscr load_fast avatar_url pop_jump_if_false TO_NUMBER load_global str load_fast avatar_url call load_fast payload load_const avatar_url store_subscr load_fast username pop_jump_if_false TO_NUMBER load_fast username load_fast payload load_const username store_subscr load_global REFLECTION_DYNAMIC_READ load_fast self load_attr _state load_const STRING_LEN_S_ENT_HIGH load_const call store_fast STRING_LEN_S_ENT_HIGH load_fast STRING_LEN_S_ENT_HIGH pop_jump_if_false TO_NUMBER load_fast STRING_LEN_S_ENT_HIGH pop_jump_if_none TO_NUMBER load_fast STRING_LEN_S_ENT_HIGH load_attr merge load_fast STRING_LEN_S_ENT_HIGH call load_attr to_dict call load_fast payload load_const STRING_LEN_S_ENT_HIGH store_subscr jump_forward TO_NUMBER load_fast STRING_LEN_S_ENT_HIGH load_attr to_dict call load_fast payload load_const STRING_LEN_S_ENT_HIGH store_subscr jump_forward TO_NUMBER load_fast STRING_LEN_S_ENT_HIGH pop_jump_if_none TO_NUMBER load_fast STRING_LEN_S_ENT_HIGH load_attr to_dict call load_fast payload load_const STRING_LEN_S_ENT_HIGH store_subscr load_fast self load_attr _adapter load_attr execute_webhook load_fast wait load_fast file load_fast files load_fast payload kw_names file files payload wait call return_value swap pop_top swap store_fast e reraise
    hash: 1a046ad502c9641913998a453563a3e68ad2f2f7ab17fa3170dfb67259fc87f8
sources:
  .repo_cache/malicious_repos/pypi_malregistry/discord-py-v13/1.3/discord_py_v13-1.3-py3-none-any/discord-py-v13/webhook.py: IyAtKi0gY29kaW5nOiB1dGYtOCAtKi0KCiIiIgpUaGUgTUlUIExpY2Vuc2UgKE1JVCkKCkNvcHlyaWdodCAoYykgMjAxNS1wcmVzZW50IFJhcHB0egoKUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEKY29weSBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZSAiU29mdHdhcmUiKSwKdG8gZGVhbCBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbgp0aGUgcmlnaHRzIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwKYW5kL29yIHNlbGwgY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlClNvZnR3YXJlIGlzIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6CgpUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbgphbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KClRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTCk9SIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLApGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEUKQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUgpMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORwpGUk9NLCBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSCkRFQUxJTkdTIElOIFRIRSBTT0ZUV0FSRS4KIiIiCgppbXBvcnQgbG9nZ2luZwppbXBvcnQgYXN5bmNpbwppbXBvcnQganNvbgppbXBvcnQgdGltZQppbXBvcnQgcmUKZnJvbSB1cmxsaWIucGFyc2UgaW1wb3J0IHF1b3RlIGFzIF91cmlxdW90ZQoKaW1wb3J0IGFpb2h0dHAKCmZyb20gLiBpbXBvcnQgdXRpbHMKZnJvbSAuZXJyb3JzIGltcG9ydCBJbnZhbGlkQXJndW1lbnQsIEhUVFBFeGNlcHRpb24sIEZvcmJpZGRlbiwgTm90Rm91bmQsIERpc2NvcmRTZXJ2ZXJFcnJvcgpmcm9tIC5tZXNzYWdlIGltcG9ydCBNZXNzYWdlCmZyb20gLmVudW1zIGltcG9ydCB0cnlfZW51bSwgV2ViaG9va1R5cGUKZnJvbSAudXNlciBpbXBvcnQgQmFzZVVzZXIsIFVzZXIKZnJvbSAuYXNzZXQgaW1wb3J0IEFzc2V0CmZyb20gLm1peGlucyBpbXBvcnQgSGFzaGFibGUKCl9fYWxsX18gPSAoCiAgICAnV2ViaG9va0FkYXB0ZXInLAogICAgJ0FzeW5jV2ViaG9va0FkYXB0ZXInLAogICAgJ1JlcXVlc3RzV2ViaG9va0FkYXB0ZXInLAogICAgJ1dlYmhvb2snLAogICAgJ1dlYmhvb2tNZXNzYWdlJywKKQoKbG9nID0gbG9nZ2luZy5nZXRMb2dnZXIoX19uYW1lX18pCgpjbGFzcyBXZWJob29rQWRhcHRlcjoKICAgICIiIkJhc2UgY2xhc3MgZm9yIGFsbCB3ZWJob29rIGFkYXB0ZXJzLgoKICAgIEF0dHJpYnV0ZXMKICAgIC0tLS0tLS0tLS0tLQogICAgd2ViaG9vazogOmNsYXNzOmBXZWJob29rYAogICAgICAgIFRoZSB3ZWJob29rIHRoYXQgb3ducyB0aGlzIGFkYXB0ZXIuCiAgICAiIiIKCiAgICBCQVNFID0gJ2h0dHBzOi8vZGlzY29yZC5jb20vYXBpL3Y3JwoKICAgIGRlZiBfcHJlcGFyZShzZWxmLCB3ZWJob29rKToKICAgICAgICBzZWxmLl93ZWJob29rX2lkID0gd2ViaG9vay5pZAogICAgICAgIHNlbGYuX3dlYmhvb2tfdG9rZW4gPSB3ZWJob29rLnRva2VuCiAgICAgICAgc2VsZi5fcmVxdWVzdF91cmwgPSAnezAuQkFTRX0vd2ViaG9va3MvezF9L3syfScuZm9ybWF0KHNlbGYsIHdlYmhvb2suaWQsIHdlYmhvb2sudG9rZW4pCiAgICAgICAgc2VsZi53ZWJob29rID0gd2ViaG9vawoKICAgIGRlZiBpc19hc3luYyhzZWxmKToKICAgICAgICByZXR1cm4gRmFsc2UKCiAgICBkZWYgcmVxdWVzdChzZWxmLCB2ZXJiLCB1cmwsIHBheWxvYWQ9Tm9uZSwgbXVsdGlwYXJ0PU5vbmUpOgogICAgICAgICIiIkFjdHVhbGx5IGRvZXMgdGhlIHJlcXVlc3QuCgogICAgICAgIFN1YmNsYXNzZXMgbXVzdCBpbXBsZW1lbnQgdGhpcy4KCiAgICAgICAgUGFyYW1ldGVycwogICAgICAgIC0tLS0tLS0tLS0tCiAgICAgICAgdmVyYjogOmNsYXNzOmBzdHJgCiAgICAgICAgICAgIFRoZSBIVFRQIHZlcmIgdG8gdXNlIGZvciB0aGUgcmVxdWVzdC4KICAgICAgICB1cmw6IDpjbGFzczpgc3RyYAogICAgICAgICAgICBUaGUgVVJMIHRvIHNlbmQgdGhlIHJlcXVlc3QgdG8uIFRoaXMgd2lsbCBoYXZlCiAgICAgICAgICAgIHRoZSBxdWVyeSBwYXJhbWV0ZXJzIGFscmVhZHkgYWRkZWQgdG8gaXQsIGlmIGFueS4KICAgICAgICBtdWx0aXBhcnQ6IE9wdGlvbmFsWzpjbGFzczpgZGljdGBdCiAgICAgICAgICAgIEEgZGljdCBjb250YWluaW5nIG11bHRpcGFydCBmb3JtIGRhdGEgdG8gc2VuZCB3aXRoCiAgICAgICAgICAgIHRoZSByZXF1ZXN0LiBJZiBhIGZpbGVuYW1lIGlzIGJlaW5nIHVwbG9hZGVkLCB0aGVuIGl0IHdpbGwKICAgICAgICAgICAgYmUgdW5kZXIgYSBgYGZpbGVgYCBrZXkgd2hpY2ggd2lsbCBoYXZlIGEgMy1lbGVtZW50IDpjbGFzczpgdHVwbGVgCiAgICAgICAgICAgIGRlbm90aW5nIGBgKGZpbGVuYW1lLCBmaWxlLCBjb250ZW50X3R5cGUpYGAuCiAgICAgICAgcGF5bG9hZDogT3B0aW9uYWxbOmNsYXNzOmBkaWN0YF0KICAgICAgICAgICAgVGhlIEpTT04gdG8gc2VuZCB3aXRoIHRoZSByZXF1ZXN0LCBpZiBhbnkuCiAgICAgICAgIiIiCiAgICAgICAgcmFpc2UgTm90SW1wbGVtZW50ZWRFcnJvcigpCgogICAgZGVmIGRlbGV0ZV93ZWJob29rKHNlbGYsICosIHJlYXNvbj1Ob25lKToKICAgICAgICByZXR1cm4gc2VsZi5yZXF1ZXN0KCdERUxFVEUnLCBzZWxmLl9yZXF1ZXN0X3VybCwgcmVhc29uPXJlYXNvbikKCiAgICBkZWYgZWRpdF93ZWJob29rKHNlbGYsICosIHJlYXNvbj1Ob25lLCAqKnBheWxvYWQpOgogICAgICAgIHJldHVybiBzZWxmLnJlcXVlc3QoJ1BBVENIJywgc2VsZi5fcmVxdWVzdF91cmwsIHBheWxvYWQ9cGF5bG9hZCwgcmVhc29uPXJlYXNvbikKCiAgICBkZWYgZWRpdF93ZWJob29rX21lc3NhZ2Uoc2VsZiwgbWVzc2FnZV9pZCwgcGF5bG9hZCk6CiAgICAgICAgcmV0dXJuIHNlbGYucmVxdWVzdCgnUEFUQ0gnLCAne30vbWVzc2FnZXMve30nLmZvcm1hdChzZWxmLl9yZXF1ZXN0X3VybCwgbWVzc2FnZV9pZCksIHBheWxvYWQ9cGF5bG9hZCkKCiAgICBkZWYgZGVsZXRlX3dlYmhvb2tfbWVzc2FnZShzZWxmLCBtZXNzYWdlX2lkKToKICAgICAgICByZXR1cm4gc2VsZi5yZXF1ZXN0KCdERUxFVEUnLCAne30vbWVzc2FnZXMve30nLmZvcm1hdChzZWxmLl9yZXF1ZXN0X3VybCwgbWVzc2FnZV9pZCkpCgogICAgZGVmIGhhbmRsZV9leGVjdXRpb25fcmVzcG9uc2Uoc2VsZiwgZGF0YSwgKiwgd2FpdCk6CiAgICAgICAgIiIiVHJhbnNmb3JtcyB0aGUgd2ViaG9vayBleGVjdXRpb24gcmVzcG9uc2UgaW50byBzb21ldGhpbmcKICAgICAgICBtb3JlIG1lYW5pbmdmdWwuCgogICAgICAgIFRoaXMgaXMgbWFpbmx5IHVzZWQgdG8gY29udmVydCB0aGUgZGF0YSBpbnRvIGEgOmNsYXNzOmBNZXNzYWdlYAogICAgICAgIGlmIG5lY2Vzc2FyeS4KCiAgICAgICAgU3ViY2xhc3NlcyBtdXN0IGltcGxlbWVudCB0aGlzLgoKICAgICAgICBQYXJhbWV0ZXJzCiAgICAgICAgLS0tLS0tLS0tLS0tCiAgICAgICAgZGF0YQogICAgICAgICAgICBUaGUgZGF0YSB0aGF0IHdhcyByZXR1cm5lZCBmcm9tIHRoZSByZXF1ZXN0LgogICAgICAgIHdhaXQ6IDpjbGFzczpgYm9vbGAKICAgICAgICAgICAgV2hldGhlciB0aGUgd2ViaG9vayBleGVjdXRpb24gd2FzIGFza2VkIHRvIHdhaXQgb3Igbm90LgogICAgICAgICIiIgogICAgICAgIHJhaXNlIE5vdEltcGxlbWVudGVkRXJyb3IoKQoKICAgIGFzeW5jIGRlZiBfd3JhcF9jb3JvdXRpbmVfYW5kX2NsZWFudXAoc2VsZiwgY29ybywgY2xlYW51cCk6CiAgICAgICAgdHJ5OgogICAgICAgICAgICByZXR1cm4gYXdhaXQgY29ybwogICAgICAgIGZpbmFsbHk6CiAgICAgICAgICAgIGNsZWFudXAoKQoKICAgIGRlZiBleGVjdXRlX3dlYmhvb2soc2VsZiwgKiwgcGF5bG9hZCwgd2FpdD1GYWxzZSwgZmlsZT1Ob25lLCBmaWxlcz1Ob25lKToKICAgICAgICBjbGVhbnVwID0gTm9uZQogICAgICAgIGlmIGZpbGUgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIG11bHRpcGFydCA9IHsKICAgICAgICAgICAgICAgICdmaWxlJzogKGZpbGUuZmlsZW5hbWUsIGZpbGUuZnAsICdhcHBsaWNhdGlvbi9vY3RldC1zdHJlYW0nKSwKICAgICAgICAgICAgICAgICdwYXlsb2FkX2pzb24nOiB1dGlscy50b19qc29uKHBheWxvYWQpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGF0YSA9IE5vbmUKICAgICAgICAgICAgY2xlYW51cCA9IGZpbGUuY2xvc2UKICAgICAgICAgICAgZmlsZXNfdG9fcGFzcyA9IFtmaWxlXQogICAgICAgIGVsaWYgZmlsZXMgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIG11bHRpcGFydCA9IHsKICAgICAgICAgICAgICAgICdwYXlsb2FkX2pzb24nOiB1dGlscy50b19qc29uKHBheWxvYWQpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgZm9yIGksIGZpbGUgaW4gZW51bWVyYXRlKGZpbGVzKToKICAgICAgICAgICAgICAgIG11bHRpcGFydFsnZmlsZSVpJyAlIGldID0gKGZpbGUuZmlsZW5hbWUsIGZpbGUuZnAsICdhcHBsaWNhdGlvbi9vY3RldC1zdHJlYW0nKQogICAgICAgICAgICBkYXRhID0gTm9uZQoKICAgICAgICAgICAgZGVmIF9hbm9uKCk6CiAgICAgICAgICAgICAgICBmb3IgZiBpbiBmaWxlczoKICAgICAgICAgICAgICAgICAgICBmLmNsb3NlKCkKCiAgICAgICAgICAgIGNsZWFudXAgPSBfYW5vbgogICAgICAgICAgICBmaWxlc190b19wYXNzID0gZmlsZXMKICAgICAgICBlbHNlOgogICAgICAgICAgICBkYXRhID0gcGF5bG9hZAogICAgICAgICAgICBtdWx0aXBhcnQgPSBOb25lCiAgICAgICAgICAgIGZpbGVzX3RvX3Bhc3MgPSBOb25lCgogICAgICAgIHVybCA9ICclcz93YWl0PSVkJyAlIChzZWxmLl9yZXF1ZXN0X3VybCwgd2FpdCkKICAgICAgICBtYXliZV9jb3JvID0gTm9uZQogICAgICAgIHRyeToKICAgICAgICAgICAgbWF5YmVfY29ybyA9IHNlbGYucmVxdWVzdCgnUE9TVCcsIHVybCwgbXVsdGlwYXJ0PW11bHRpcGFydCwgcGF5bG9hZD1kYXRhLCBmaWxlcz1maWxlc190b19wYXNzKQogICAgICAgIGZpbmFsbHk6CiAgICAgICAgICAgIGlmIG1heWJlX2Nvcm8gaXMgbm90IE5vbmUgYW5kIGNsZWFudXAgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICBpZiBub3QgYXN5bmNpby5pc2Nvcm91dGluZShtYXliZV9jb3JvKToKICAgICAgICAgICAgICAgICAgICBjbGVhbnVwKCkKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgbWF5YmVfY29ybyA9IHNlbGYuX3dyYXBfY29yb3V0aW5lX2FuZF9jbGVhbnVwKG1heWJlX2Nvcm8sIGNsZWFudXApCgogICAgICAgICMgaWYgcmVxdWVzdCByYWlzZXMgdXAgdGhlcmUgdGhlbiB0aGlzIHNob3VsZCBuZXZlciBiZSBgTm9uZWAKICAgICAgICByZXR1cm4gc2VsZi5oYW5kbGVfZXhlY3V0aW9uX3Jlc3BvbnNlKG1heWJlX2Nvcm8sIHdhaXQ9d2FpdCkKCmNsYXNzIEFzeW5jV2ViaG9va0FkYXB0ZXIoV2ViaG9va0FkYXB0ZXIpOgogICAgIiIiQSB3ZWJob29rIGFkYXB0ZXIgc3VpdGVkIGZvciB1c2Ugd2l0aCBhaW9odHRwLgoKICAgIC4uIG5vdGU6OgoKICAgICAgICBZb3UgYXJlIHJlc3BvbnNpYmxlIGZvciBjbGVhbmluZyB1cCB0aGUgY2xpZW50IHNlc3Npb24uCgogICAgUGFyYW1ldGVycwogICAgLS0tLS0tLS0tLS0KICAgIHNlc3Npb246IDpjbGFzczpgYWlvaHR0cC5DbGllbnRTZXNzaW9uYAogICAgICAgIFRoZSBzZXNzaW9uIHRvIHVzZSB0byBzZW5kIHJlcXVlc3RzLgogICAgIiIiCgogICAgZGVmIF9faW5pdF9fKHNlbGYsIHNlc3Npb24pOgogICAgICAgIHNlbGYuc2Vzc2lvbiA9IHNlc3Npb24KICAgICAgICBzZWxmLmxvb3AgPSBhc3luY2lvLmdldF9ldmVudF9sb29wKCkKCiAgICBkZWYgaXNfYXN5bmMoc2VsZik6CiAgICAgICAgcmV0dXJuIFRydWUKCiAgICBhc3luYyBkZWYgcmVxdWVzdChzZWxmLCB2ZXJiLCB1cmwsIHBheWxvYWQ9Tm9uZSwgbXVsdGlwYXJ0PU5vbmUsICosIGZpbGVzPU5vbmUsIHJlYXNvbj1Ob25lKToKICAgICAgICBoZWFkZXJzID0ge30KICAgICAgICBkYXRhID0gTm9uZQogICAgICAgIGZpbGVzID0gZmlsZXMgb3IgW10KICAgICAgICBpZiBwYXlsb2FkOgogICAgICAgICAgICBoZWFkZXJzWydDb250ZW50LVR5cGUnXSA9ICdhcHBsaWNhdGlvbi9qc29uJwogICAgICAgICAgICBkYXRhID0gdXRpbHMudG9fanNvbihwYXlsb2FkKQoKICAgICAgICBpZiByZWFzb246CiAgICAgICAgICAgIGhlYWRlcnNbJ1gtQXVkaXQtTG9nLVJlYXNvbiddID0gX3VyaXF1b3RlKHJlYXNvbiwgc2FmZT0nLyAnKQoKCiAgICAgICAgYmFzZV91cmwgPSB1cmwucmVwbGFjZShzZWxmLl9yZXF1ZXN0X3VybCwgJy8nKSBvciAnLycKICAgICAgICBfaWQgPSBzZWxmLl93ZWJob29rX2lkCiAgICAgICAgZm9yIHRyaWVzIGluIHJhbmdlKDUpOgogICAgICAgICAgICBmb3IgZmlsZSBpbiBmaWxlczoKICAgICAgICAgICAgICAgIGZpbGUucmVzZXQoc2Vlaz10cmllcykKCiAgICAgICAgICAgIGlmIG11bHRpcGFydDoKICAgICAgICAgICAgICAgIGRhdGEgPSBhaW9odHRwLkZvcm1EYXRhKCkKICAgICAgICAgICAgICAgIGZvciBrZXksIHZhbHVlIGluIG11bHRpcGFydC5pdGVtcygpOgogICAgICAgICAgICAgICAgICAgIGlmIGtleS5zdGFydHN3aXRoKCdmaWxlJyk6CiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEuYWRkX2ZpZWxkKGtleSwgdmFsdWVbMV0sIGZpbGVuYW1lPXZhbHVlWzBdLCBjb250ZW50X3R5cGU9dmFsdWVbMl0pCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgZGF0YS5hZGRfZmllbGQoa2V5LCB2YWx1ZSkKCiAgICAgICAgICAgIGFzeW5jIHdpdGggc2VsZi5zZXNzaW9uLnJlcXVlc3QodmVyYiwgdXJsLCBoZWFkZXJzPWhlYWRlcnMsIGRhdGE9ZGF0YSkgYXMgcjoKICAgICAgICAgICAgICAgIGxvZy5kZWJ1ZygnV2ViaG9vayBJRCAlcyB3aXRoICVzICVzIGhhcyByZXR1cm5lZCBzdGF0dXMgY29kZSAlcycsIF9pZCwgdmVyYiwgYmFzZV91cmwsIHIuc3RhdHVzKQogICAgICAgICAgICAgICAgIyBDb2VyY2UgZW1wdHkgc3RyaW5ncyB0byByZXR1cm4gTm9uZSBmb3IgaHlnaWVuZSBwdXJwb3NlcwogICAgICAgICAgICAgICAgcmVzcG9uc2UgPSAoYXdhaXQgci50ZXh0KGVuY29kaW5nPSd1dGYtOCcpKSBvciBOb25lCiAgICAgICAgICAgICAgICBpZiByLmhlYWRlcnNbJ0NvbnRlbnQtVHlwZSddID09ICdhcHBsaWNhdGlvbi9qc29uJzoKICAgICAgICAgICAgICAgICAgICByZXNwb25zZSA9IGpzb24ubG9hZHMocmVzcG9uc2UpCgogICAgICAgICAgICAgICAgIyBjaGVjayBpZiB3ZSBoYXZlIHJhdGUgbGltaXQgaGVhZGVyIGluZm9ybWF0aW9uCiAgICAgICAgICAgICAgICByZW1haW5pbmcgPSByLmhlYWRlcnMuZ2V0KCdYLVJhdGVsaW1pdC1SZW1haW5pbmcnKQogICAgICAgICAgICAgICAgaWYgcmVtYWluaW5nID09ICcwJyBhbmQgci5zdGF0dXMgIT0gNDI5OgogICAgICAgICAgICAgICAgICAgIGRlbHRhID0gdXRpbHMuX3BhcnNlX3JhdGVsaW1pdF9oZWFkZXIocikKICAgICAgICAgICAgICAgICAgICBsb2cuZGVidWcoJ1dlYmhvb2sgSUQgJXMgaGFzIGJlZW4gcHJlLWVtcHRpdmVseSByYXRlIGxpbWl0ZWQsIHdhaXRpbmcgJS4yZiBzZWNvbmRzJywgX2lkLCBkZWx0YSkKICAgICAgICAgICAgICAgICAgICBhd2FpdCBhc3luY2lvLnNsZWVwKGRlbHRhKQoKICAgICAgICAgICAgICAgIGlmIDMwMCA+IHIuc3RhdHVzID49IDIwMDoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UKCiAgICAgICAgICAgICAgICAjIHdlIGFyZSBiZWluZyByYXRlIGxpbWl0ZWQKICAgICAgICAgICAgICAgIGlmIHIuc3RhdHVzID09IDQyOToKICAgICAgICAgICAgICAgICAgICBpZiBub3Qgci5oZWFkZXJzLmdldCgnVmlhJyk6CiAgICAgICAgICAgICAgICAgICAgICAgICMgQmFubmVkIGJ5IENsb3VkZmxhcmUgbW9yZSB0aGFuIGxpa2VseS4KICAgICAgICAgICAgICAgICAgICAgICAgcmFpc2UgSFRUUEV4Y2VwdGlvbihyLCBkYXRhKQoKICAgICAgICAgICAgICAgICAgICByZXRyeV9hZnRlciA9IHJlc3BvbnNlWydyZXRyeV9hZnRlciddIC8gMTAwMC4wCiAgICAgICAgICAgICAgICAgICAgbG9nLndhcm5pbmcoJ1dlYmhvb2sgSUQgJXMgaXMgcmF0ZSBsaW1pdGVkLiBSZXRyeWluZyBpbiAlLjJmIHNlY29uZHMnLCBfaWQsIHJldHJ5X2FmdGVyKQogICAgICAgICAgICAgICAgICAgIGF3YWl0IGFzeW5jaW8uc2xlZXAocmV0cnlfYWZ0ZXIpCiAgICAgICAgICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgICAgICAgICBpZiByLnN0YXR1cyBpbiAoNTAwLCA1MDIpOgogICAgICAgICAgICAgICAgICAgIGF3YWl0IGFzeW5jaW8uc2xlZXAoMSArIHRyaWVzICogMikKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQoKICAgICAgICAgICAgICAgIGlmIHIuc3RhdHVzID09IDQwMzoKICAgICAgICAgICAgICAgICAgICByYWlzZSBGb3JiaWRkZW4ociwgcmVzcG9uc2UpCiAgICAgICAgICAgICAgICBlbGlmIHIuc3RhdHVzID09IDQwNDoKICAgICAgICAgICAgICAgICAgICByYWlzZSBOb3RGb3VuZChyLCByZXNwb25zZSkKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgcmFpc2UgSFRUUEV4Y2VwdGlvbihyLCByZXNwb25zZSkKCiAgICAgICAgIyBubyBtb3JlIHJldHJpZXMKICAgICAgICBpZiByLnN0YXR1cyA+PSA1MDA6CiAgICAgICAgICAgIHJhaXNlIERpc2NvcmRTZXJ2ZXJFcnJvcihyLCByZXNwb25zZSkKICAgICAgICByYWlzZSBIVFRQRXhjZXB0aW9uKHIsIHJlc3BvbnNlKQoKICAgIGFzeW5jIGRlZiBoYW5kbGVfZXhlY3V0aW9uX3Jlc3BvbnNlKHNlbGYsIHJlc3BvbnNlLCAqLCB3YWl0KToKICAgICAgICBkYXRhID0gYXdhaXQgcmVzcG9uc2UKICAgICAgICBpZiBub3Qgd2FpdDoKICAgICAgICAgICAgcmV0dXJuIGRhdGEKCiAgICAgICAgIyB0cmFuc2Zvcm0gaW50byBNZXNzYWdlIG9iamVjdAogICAgICAgICMgTWFrZSBzdXJlIHRvIGNvZXJjZSB0aGUgc3RhdGUgdG8gdGhlIHBhcnRpYWwgb25lIHRvIGFsbG93IG1lc3NhZ2UgZWRpdHMvZGVsZXRlCiAgICAgICAgc3RhdGUgPSBfUGFydGlhbFdlYmhvb2tTdGF0ZShzZWxmLCBzZWxmLndlYmhvb2ssIHBhcmVudD1zZWxmLndlYmhvb2suX3N0YXRlKQogICAgICAgIHJldHVybiBXZWJob29rTWVzc2FnZShkYXRhPWRhdGEsIHN0YXRlPXN0YXRlLCBjaGFubmVsPXNlbGYud2ViaG9vay5jaGFubmVsKQoKY2xhc3MgUmVxdWVzdHNXZWJob29rQWRhcHRlcihXZWJob29rQWRhcHRlcik6CiAgICAiIiJBIHdlYmhvb2sgYWRhcHRlciBzdWl0ZWQgZm9yIHVzZSB3aXRoIGBgcmVxdWVzdHNgYC4KCiAgICBPbmx5IHZlcnNpb25zIG9mIDpkb2M6YHJlcTppbmRleGAgaGlnaGVyIHRoYW4gMi4xMy4wIGFyZSBzdXBwb3J0ZWQuCgogICAgUGFyYW1ldGVycwogICAgLS0tLS0tLS0tLS0KICAgIHNlc3Npb246IE9wdGlvbmFsW2ByZXF1ZXN0cy5TZXNzaW9uIDxodHRwOi8vZG9jcy5weXRob24tcmVxdWVzdHMub3JnL2VuL2xhdGVzdC9hcGkvI3JlcXVlc3RzLlNlc3Npb24+YF9dCiAgICAgICAgVGhlIHJlcXVlc3RzIHNlc3Npb24gdG8gdXNlIGZvciBzZW5kaW5nIHJlcXVlc3RzLiBJZiBub3QgZ2l2ZW4gdGhlbgogICAgICAgIGVhY2ggcmVxdWVzdCB3aWxsIGNyZWF0ZSBhIG5ldyBzZXNzaW9uLiBOb3RlIGlmIGEgc2Vzc2lvbiBpcyBnaXZlbiwKICAgICAgICB0aGUgd2ViaG9vayBhZGFwdGVyICoqd2lsbCBub3QqKiBjbGVhbiBpdCB1cCBmb3IgeW91LiBZb3UgbXVzdCBjbG9zZQogICAgICAgIHRoZSBzZXNzaW9uIHlvdXJzZWxmLgogICAgc2xlZXA6IDpjbGFzczpgYm9vbGAKICAgICAgICBXaGV0aGVyIHRvIHNsZWVwIHRoZSB0aHJlYWQgd2hlbiBlbmNvdW50ZXJpbmcgYSA0Mjkgb3IgcHJlLWVtcHRpdmUKICAgICAgICByYXRlIGxpbWl0IG9yIGEgNXh4IHN0YXR1cyBjb2RlLiBEZWZhdWx0cyB0byBgYFRydWVgYC4gSWYgc2V0IHRvCiAgICAgICAgYGBGYWxzZWBgIHRoZW4gdGhpcyB3aWxsIHJhaXNlIGFuIDpleGM6YEhUVFBFeGNlcHRpb25gIGluc3RlYWQuCiAgICAiIiIKCiAgICBkZWYgX19pbml0X18oc2VsZiwgc2Vzc2lvbj1Ob25lLCAqLCBzbGVlcD1UcnVlKToKICAgICAgICBpbXBvcnQgcmVxdWVzdHMKICAgICAgICBzZWxmLnNlc3Npb24gPSBzZXNzaW9uIG9yIHJlcXVlc3RzCiAgICAgICAgc2VsZi5zbGVlcCA9IHNsZWVwCgogICAgZGVmIHJlcXVlc3Qoc2VsZiwgdmVyYiwgdXJsLCBwYXlsb2FkPU5vbmUsIG11bHRpcGFydD1Ob25lLCAqLCBmaWxlcz1Ob25lLCByZWFzb249Tm9uZSk6CiAgICAgICAgaGVhZGVycyA9IHt9CiAgICAgICAgZGF0YSA9IE5vbmUKICAgICAgICBmaWxlcyA9IGZpbGVzIG9yIFtdCiAgICAgICAgaWYgcGF5bG9hZDoKICAgICAgICAgICAgaGVhZGVyc1snQ29udGVudC1UeXBlJ10gPSAnYXBwbGljYXRpb24vanNvbicKICAgICAgICAgICAgZGF0YSA9IHV0aWxzLnRvX2pzb24ocGF5bG9hZCkKCiAgICAgICAgaWYgcmVhc29uOgogICAgICAgICAgICBoZWFkZXJzWydYLUF1ZGl0LUxvZy1SZWFzb24nXSA9IF91cmlxdW90ZShyZWFzb24sIHNhZmU9Jy8gJykKCiAgICAgICAgaWYgbXVsdGlwYXJ0IGlzIG5vdCBOb25lOgogICAgICAgICAgICBkYXRhID0geydwYXlsb2FkX2pzb24nOiBtdWx0aXBhcnQucG9wKCdwYXlsb2FkX2pzb24nKX0KCiAgICAgICAgYmFzZV91cmwgPSB1cmwucmVwbGFjZShzZWxmLl9yZXF1ZXN0X3VybCwgJy8nKSBvciAnLycKICAgICAgICBfaWQgPSBzZWxmLl93ZWJob29rX2lkCiAgICAgICAgZm9yIHRyaWVzIGluIHJhbmdlKDUpOgogICAgICAgICAgICBmb3IgZmlsZSBpbiBmaWxlczoKICAgICAgICAgICAgICAgIGZpbGUucmVzZXQoc2Vlaz10cmllcykKCiAgICAgICAgICAgIHIgPSBzZWxmLnNlc3Npb24ucmVxdWVzdCh2ZXJiLCB1cmwsIGhlYWRlcnM9aGVhZGVycywgZGF0YT1kYXRhLCBmaWxlcz1tdWx0aXBhcnQpCiAgICAgICAgICAgIHIuZW5jb2RpbmcgPSAndXRmLTgnCiAgICAgICAgICAgICMgQ29lcmNlIGVtcHR5IHJlc3BvbnNlcyB0byByZXR1cm4gTm9uZSBmb3IgaHlnaWVuZSBwdXJwb3NlcwogICAgICAgICAgICByZXNwb25zZSA9IHIudGV4dCBvciBOb25lCgogICAgICAgICAgICAjIGNvbXBhdGliaWxpdHkgd2l0aCBhaW9odHRwCiAgICAgICAgICAgIHIuc3RhdHVzID0gci5zdGF0dXNfY29kZQoKICAgICAgICAgICAgbG9nLmRlYnVnKCdXZWJob29rIElEICVzIHdpdGggJXMgJXMgaGFzIHJldHVybmVkIHN0YXR1cyBjb2RlICVzJywgX2lkLCB2ZXJiLCBiYXNlX3VybCwgci5zdGF0dXMpCiAgICAgICAgICAgIGlmIHIuaGVhZGVyc1snQ29udGVudC1UeXBlJ10gPT0gJ2FwcGxpY2F0aW9uL2pzb24nOgogICAgICAgICAgICAgICAgcmVzcG9uc2UgPSBqc29uLmxvYWRzKHJlc3BvbnNlKQoKICAgICAgICAgICAgIyBjaGVjayBpZiB3ZSBoYXZlIHJhdGUgbGltaXQgaGVhZGVyIGluZm9ybWF0aW9uCiAgICAgICAgICAgIHJlbWFpbmluZyA9IHIuaGVhZGVycy5nZXQoJ1gtUmF0ZWxpbWl0LVJlbWFpbmluZycpCiAgICAgICAgICAgIGlmIHJlbWFpbmluZyA9PSAnMCcgYW5kIHIuc3RhdHVzICE9IDQyOSBhbmQgc2VsZi5zbGVlcDoKICAgICAgICAgICAgICAgIGRlbHRhID0gdXRpbHMuX3BhcnNlX3JhdGVsaW1pdF9oZWFkZXIocikKICAgICAgICAgICAgICAgIGxvZy5kZWJ1ZygnV2ViaG9vayBJRCAlcyBoYXMgYmVlbiBwcmUtZW1wdGl2ZWx5IHJhdGUgbGltaXRlZCwgd2FpdGluZyAlLjJmIHNlY29uZHMnLCBfaWQsIGRlbHRhKQogICAgICAgICAgICAgICAgdGltZS5zbGVlcChkZWx0YSkKCiAgICAgICAgICAgIGlmIDMwMCA+IHIuc3RhdHVzID49IDIwMDoKICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZQoKICAgICAgICAgICAgIyB3ZSBhcmUgYmVpbmcgcmF0ZSBsaW1pdGVkCiAgICAgICAgICAgIGlmIHIuc3RhdHVzID09IDQyOToKICAgICAgICAgICAgICAgIGlmIHNlbGYuc2xlZXA6CiAgICAgICAgICAgICAgICAgICAgaWYgbm90IHIuaGVhZGVycy5nZXQoJ1ZpYScpOgogICAgICAgICAgICAgICAgICAgICAgICAjIEJhbm5lZCBieSBDbG91ZGZsYXJlIG1vcmUgdGhhbiBsaWtlbHkuCiAgICAgICAgICAgICAgICAgICAgICAgIHJhaXNlIEhUVFBFeGNlcHRpb24ociwgZGF0YSkKCiAgICAgICAgICAgICAgICAgICAgcmV0cnlfYWZ0ZXIgPSByZXNwb25zZVsncmV0cnlfYWZ0ZXInXSAvIDEwMDAuMAogICAgICAgICAgICAgICAgICAgIGxvZy53YXJuaW5nKCdXZWJob29rIElEICVzIGlzIHJhdGUgbGltaXRlZC4gUmV0cnlpbmcgaW4gJS4yZiBzZWNvbmRzJywgX2lkLCByZXRyeV9hZnRlcikKICAgICAgICAgICAgICAgICAgICB0aW1lLnNsZWVwKHJldHJ5X2FmdGVyKQogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIHJhaXNlIEhUVFBFeGNlcHRpb24ociwgcmVzcG9uc2UpCgogICAgICAgICAgICBpZiBzZWxmLnNsZWVwIGFuZCByLnN0YXR1cyBpbiAoNTAwLCA1MDIpOgogICAgICAgICAgICAgICAgdGltZS5zbGVlcCgxICsgdHJpZXMgKiAyKQogICAgICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgICAgIGlmIHIuc3RhdHVzID09IDQwMzoKICAgICAgICAgICAgICAgIHJhaXNlIEZvcmJpZGRlbihyLCByZXNwb25zZSkKICAgICAgICAgICAgZWxpZiByLnN0YXR1cyA9PSA0MDQ6CiAgICAgICAgICAgICAgICByYWlzZSBOb3RGb3VuZChyLCByZXNwb25zZSkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHJhaXNlIEhUVFBFeGNlcHRpb24ociwgcmVzcG9uc2UpCgogICAgICAgICMgbm8gbW9yZSByZXRyaWVzCiAgICAgICAgaWYgci5zdGF0dXMgPj0gNTAwOgogICAgICAgICAgICByYWlzZSBEaXNjb3JkU2VydmVyRXJyb3IociwgcmVzcG9uc2UpCiAgICAgICAgcmFpc2UgSFRUUEV4Y2VwdGlvbihyLCByZXNwb25zZSkKCiAgICBkZWYgaGFuZGxlX2V4ZWN1dGlvbl9yZXNwb25zZShzZWxmLCByZXNwb25zZSwgKiwgd2FpdCk6CiAgICAgICAgaWYgbm90IHdhaXQ6CiAgICAgICAgICAgIHJldHVybiByZXNwb25zZQoKICAgICAgICAjIHRyYW5zZm9ybSBpbnRvIE1lc3NhZ2Ugb2JqZWN0CiAgICAgICAgIyBNYWtlIHN1cmUgdG8gY29lcmNlIHRoZSBzdGF0ZSB0byB0aGUgcGFydGlhbCBvbmUgdG8gYWxsb3cgbWVzc2FnZSBlZGl0cy9kZWxldGUKICAgICAgICBzdGF0ZSA9IF9QYXJ0aWFsV2ViaG9va1N0YXRlKHNlbGYsIHNlbGYud2ViaG9vaywgcGFyZW50PXNlbGYud2ViaG9vay5fc3RhdGUpCiAgICAgICAgcmV0dXJuIFdlYmhvb2tNZXNzYWdlKGRhdGE9cmVzcG9uc2UsIHN0YXRlPXN0YXRlLCBjaGFubmVsPXNlbGYud2ViaG9vay5jaGFubmVsKQoKY2xhc3MgX0ZyaWVuZGx5SHR0cEF0dHJpYnV0ZUVycm9ySGVscGVyOgogICAgX19zbG90c19fID0gKCkKCiAgICBkZWYgX19nZXRhdHRyX18oc2VsZiwgYXR0cik6CiAgICAgICAgcmFpc2UgQXR0cmlidXRlRXJyb3IoJ1BhcnRpYWxXZWJob29rU3RhdGUgZG9lcyBub3Qgc3VwcG9ydCBodHRwIG1ldGhvZHMuJykKCmNsYXNzIF9QYXJ0aWFsV2ViaG9va1N0YXRlOgogICAgX19zbG90c19fID0gKCdsb29wJywgJ3BhcmVudCcsICdfd2ViaG9vaycpCgogICAgZGVmIF9faW5pdF9fKHNlbGYsIGFkYXB0ZXIsIHdlYmhvb2ssIHBhcmVudCk6CiAgICAgICAgc2VsZi5fd2ViaG9vayA9IHdlYmhvb2sKCiAgICAgICAgaWYgaXNpbnN0YW5jZShwYXJlbnQsIHNlbGYuX19jbGFzc19fKToKICAgICAgICAgICAgc2VsZi5wYXJlbnQgPSBOb25lCiAgICAgICAgZWxzZToKICAgICAgICAgICAgc2VsZi5wYXJlbnQgPSBwYXJlbnQKCiAgICAgICAgIyBGZXRjaCB0aGUgbG9vcCBmcm9tIHRoZSBhZGFwdGVyIGlmIGl0J3MgdGhlcmUKICAgICAgICB0cnk6CiAgICAgICAgICAgIHNlbGYubG9vcCA9IGFkYXB0ZXIubG9vcAogICAgICAgIGV4Y2VwdCBBdHRyaWJ1dGVFcnJvcjoKICAgICAgICAgICAgc2VsZi5sb29wID0gTm9uZQoKICAgIGRlZiBfZ2V0X2d1aWxkKHNlbGYsIGd1aWxkX2lkKToKICAgICAgICByZXR1cm4gTm9uZQoKICAgIGRlZiBzdG9yZV91c2VyKHNlbGYsIGRhdGEpOgogICAgICAgIHJldHVybiBCYXNlVXNlcihzdGF0ZT1zZWxmLCBkYXRhPWRhdGEpCgogICAgQHByb3BlcnR5CiAgICBkZWYgaXNfYm90KHNlbGYpOgogICAgICAgIHJldHVybiBUcnVlCgogICAgQHByb3BlcnR5CiAgICBkZWYgaHR0cChzZWxmKToKICAgICAgICBpZiBzZWxmLnBhcmVudCBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0dXJuIHNlbGYucGFyZW50Lmh0dHAKCiAgICAgICAgIyBTb21lIGRhdGEgY2xhc3NlcyBhc3NpZ24gc3RhdGUuaHR0cCBhbmQgdGhhdCBzaG91bGQgYmUga29zaGVyCiAgICAgICAgIyBob3dldmVyLCB1c2luZyBpdCBzaG91bGQgcmVzdWx0IGluIGEgbGF0ZS1iaW5kaW5nIGVycm9yLgogICAgICAgIHJldHVybiBfRnJpZW5kbHlIdHRwQXR0cmlidXRlRXJyb3JIZWxwZXIoKQoKICAgIGRlZiBfX2dldGF0dHJfXyhzZWxmLCBhdHRyKToKICAgICAgICBpZiBzZWxmLnBhcmVudCBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0dXJuIGdldGF0dHIoc2VsZi5wYXJlbnQsIGF0dHIpCgogICAgICAgIHJhaXNlIEF0dHJpYnV0ZUVycm9yKCdQYXJ0aWFsV2ViaG9va1N0YXRlIGRvZXMgbm90IHN1cHBvcnQgezAhcn0uJy5mb3JtYXQoYXR0cikpCgpjbGFzcyBXZWJob29rTWVzc2FnZShNZXNzYWdlKToKICAgICIiIlJlcHJlc2VudHMgYSBtZXNzYWdlIHNlbnQgZnJvbSB5b3VyIHdlYmhvb2suCgogICAgVGhpcyBhbGxvd3MgeW91IHRvIGVkaXQgb3IgZGVsZXRlIGEgbWVzc2FnZSBzZW50IGJ5IHlvdXIKICAgIHdlYmhvb2suCgogICAgVGhpcyBpbmhlcml0cyBmcm9tIDpjbGFzczpgZGlzY29yZC5NZXNzYWdlYCB3aXRoIGNoYW5nZXMgdG8KICAgIDptZXRoOmBlZGl0YCBhbmQgOm1ldGg6YGRlbGV0ZWAgdG8gd29yay4KCiAgICAuLiB2ZXJzaW9uYWRkZWQ6OiAxLjYKICAgICIiIgoKICAgIGRlZiBlZGl0KHNlbGYsICoqZmllbGRzKToKICAgICAgICAiIiJ8bWF5YmVjb3JvfAoKICAgICAgICBFZGl0cyB0aGUgbWVzc2FnZS4KCiAgICAgICAgVGhlIGNvbnRlbnQgbXVzdCBiZSBhYmxlIHRvIGJlIHRyYW5zZm9ybWVkIGludG8gYSBzdHJpbmcgdmlhIGBgc3RyKGNvbnRlbnQpYGAuCgogICAgICAgIC4uIHZlcnNpb25hZGRlZDo6IDEuNgoKICAgICAgICBQYXJhbWV0ZXJzCiAgICAgICAgLS0tLS0tLS0tLS0tCiAgICAgICAgY29udGVudDogT3B0aW9uYWxbOmNsYXNzOmBzdHJgXQogICAgICAgICAgICBUaGUgY29udGVudCB0byBlZGl0IHRoZSBtZXNzYWdlIHdpdGggb3IgYGBOb25lYGAgdG8gY2xlYXIgaXQuCiAgICAgICAgZW1iZWRzOiBMaXN0WzpjbGFzczpgRW1iZWRgXQogICAgICAgICAgICBBIGxpc3Qgb2YgZW1iZWRzIHRvIGVkaXQgdGhlIG1lc3NhZ2Ugd2l0aC4KICAgICAgICBlbWJlZDogT3B0aW9uYWxbOmNsYXNzOmBFbWJlZGBdCiAgICAgICAgICAgIFRoZSBlbWJlZCB0byBlZGl0IHRoZSBtZXNzYWdlIHdpdGguIGBgTm9uZWBgIHN1cHByZXNzZXMgdGhlIGVtYmVkcy4KICAgICAgICAgICAgVGhpcyBzaG91bGQgbm90IGJlIG1peGVkIHdpdGggdGhlIGBgZW1iZWRzYGAgcGFyYW1ldGVyLgogICAgICAgIGFsbG93ZWRfbWVudGlvbnM6IDpjbGFzczpgQWxsb3dlZE1lbnRpb25zYAogICAgICAgICAgICBDb250cm9scyB0aGUgbWVudGlvbnMgYmVpbmcgcHJvY2Vzc2VkIGluIHRoaXMgbWVzc2FnZS4KICAgICAgICAgICAgU2VlIDptZXRoOmAuYWJjLk1lc3NhZ2VhYmxlLnNlbmRgIGZvciBtb3JlIGluZm9ybWF0aW9uLgoKICAgICAgICBSYWlzZXMKICAgICAgICAtLS0tLS0tCiAgICAgICAgSFRUUEV4Y2VwdGlvbgogICAgICAgICAgICBFZGl0aW5nIHRoZSBtZXNzYWdlIGZhaWxlZC4KICAgICAgICBGb3JiaWRkZW4KICAgICAgICAgICAgRWRpdGVkIGEgbWVzc2FnZSB0aGF0IGlzIG5vdCB5b3Vycy4KICAgICAgICBJbnZhbGlkQXJndW1lbnQKICAgICAgICAgICAgWW91IHNwZWNpZmllZCBib3RoIGBgZW1iZWRgYCBhbmQgYGBlbWJlZHNgYCBvciB0aGUgbGVuZ3RoIG9mCiAgICAgICAgICAgIGBgZW1iZWRzYGAgd2FzIGludmFsaWQgb3IgdGhlcmUgd2FzIG5vIHRva2VuIGFzc29jaWF0ZWQgd2l0aAogICAgICAgICAgICB0aGlzIHdlYmhvb2suCiAgICAgICAgIiIiCiAgICAgICAgcmV0dXJuIHNlbGYuX3N0YXRlLl93ZWJob29rLmVkaXRfbWVzc2FnZShzZWxmLmlkLCAqKmZpZWxkcykKCiAgICBkZWYgX2RlbGV0ZV9kZWxheV9zeW5jKHNlbGYsIGRlbGF5KToKICAgICAgICB0aW1lLnNsZWVwKGRlbGF5KQogICAgICAgIHJldHVybiBzZWxmLl9zdGF0ZS5fd2ViaG9vay5kZWxldGVfbWVzc2FnZShzZWxmLmlkKQoKICAgIGFzeW5jIGRlZiBfZGVsZXRlX2RlbGF5X2FzeW5jKHNlbGYsIGRlbGF5KToKICAgICAgICBhc3luYyBkZWYgaW5uZXJfY2FsbCgpOgogICAgICAgICAgICBhd2FpdCBhc3luY2lvLnNsZWVwKGRlbGF5KQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBhd2FpdCBzZWxmLl9zdGF0ZS5fd2ViaG9vay5kZWxldGVfbWVzc2FnZShzZWxmLmlkKQogICAgICAgICAgICBleGNlcHQgSFRUUEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgIHBhc3MKCiAgICAgICAgYXN5bmNpby5lbnN1cmVfZnV0dXJlKGlubmVyX2NhbGwoKSwgbG9vcD1zZWxmLl9zdGF0ZS5sb29wKQogICAgICAgIHJldHVybiBhd2FpdCBhc3luY2lvLnNsZWVwKDApCgogICAgZGVmIGRlbGV0ZShzZWxmLCAqLCBkZWxheT1Ob25lKToKICAgICAgICAiIiJ8Y29yb3wKCiAgICAgICAgRGVsZXRlcyB0aGUgbWVzc2FnZS4KCiAgICAgICAgUGFyYW1ldGVycwogICAgICAgIC0tLS0tLS0tLS0tCiAgICAgICAgZGVsYXk6IE9wdGlvbmFsWzpjbGFzczpgZmxvYXRgXQogICAgICAgICAgICBJZiBwcm92aWRlZCwgdGhlIG51bWJlciBvZiBzZWNvbmRzIHRvIHdhaXQgYmVmb3JlIGRlbGV0aW5nIHRoZSBtZXNzYWdlLgogICAgICAgICAgICBJZiB0aGlzIGlzIGEgY29yb3V0aW5lLCB0aGUgd2FpdGluZyBpcyBkb25lIGluIHRoZSBiYWNrZ3JvdW5kIGFuZCBkZWxldGlvbiBmYWlsdXJlcwogICAgICAgICAgICBhcmUgaWdub3JlZC4gSWYgdGhpcyBpcyBub3QgYSBjb3JvdXRpbmUgdGhlbiB0aGUgZGVsYXkgYmxvY2tzIHRoZSB0aHJlYWQuCgogICAgICAgIFJhaXNlcwogICAgICAgIC0tLS0tLQogICAgICAgIEZvcmJpZGRlbgogICAgICAgICAgICBZb3UgZG8gbm90IGhhdmUgcHJvcGVyIHBlcm1pc3Npb25zIHRvIGRlbGV0ZSB0aGUgbWVzc2FnZS4KICAgICAgICBOb3RGb3VuZAogICAgICAgICAgICBUaGUgbWVzc2FnZSB3YXMgZGVsZXRlZCBhbHJlYWR5LgogICAgICAgIEhUVFBFeGNlcHRpb24KICAgICAgICAgICAgRGVsZXRpbmcgdGhlIG1lc3NhZ2UgZmFpbGVkLgogICAgICAgICIiIgoKICAgICAgICBpZiBkZWxheSBpcyBub3QgTm9uZToKICAgICAgICAgICAgaWYgc2VsZi5fc3RhdGUuX3dlYmhvb2suX2FkYXB0ZXIuaXNfYXN5bmMoKToKICAgICAgICAgICAgICAgIHJldHVybiBzZWxmLl9kZWxldGVfZGVsYXlfYXN5bmMoZGVsYXkpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICByZXR1cm4gc2VsZi5fZGVsZXRlX2RlbGF5X3N5bmMoZGVsYXkpCgogICAgICAgIHJldHVybiBzZWxmLl9zdGF0ZS5fd2ViaG9vay5kZWxldGVfbWVzc2FnZShzZWxmLmlkKQoKY2xhc3MgV2ViaG9vayhIYXNoYWJsZSk6CiAgICAiIiJSZXByZXNlbnRzIGEgRGlzY29yZCB3ZWJob29rLgoKICAgIFdlYmhvb2tzIGFyZSBhIGZvcm0gdG8gc2VuZCBtZXNzYWdlcyB0byBjaGFubmVscyBpbiBEaXNjb3JkIHdpdGhvdXQgYQogICAgYm90IHVzZXIgb3IgYXV0aGVudGljYXRpb24uCgogICAgVGhlcmUgYXJlIHR3byBtYWluIHdheXMgdG8gdXNlIFdlYmhvb2tzLiBUaGUgZmlyc3QgaXMgdGhyb3VnaCB0aGUgb25lcwogICAgcmVjZWl2ZWQgYnkgdGhlIGxpYnJhcnkgc3VjaCBhcyA6bWV0aDpgLkd1aWxkLndlYmhvb2tzYCBhbmQKICAgIDptZXRoOmAuVGV4dENoYW5uZWwud2ViaG9va3NgLiBUaGUgb25lcyByZWNlaXZlZCBieSB0aGUgbGlicmFyeSB3aWxsCiAgICBhdXRvbWF0aWNhbGx5IGhhdmUgYW4gYWRhcHRlciBib3VuZCB1c2luZyB0aGUgbGlicmFyeSdzIEhUVFAgc2Vzc2lvbi4KICAgIFRob3NlIHdlYmhvb2tzIHdpbGwgaGF2ZSA6bWV0aDpgfi5XZWJob29rLnNlbmRgLCA6bWV0aDpgfi5XZWJob29rLmRlbGV0ZWAgYW5kCiAgICA6bWV0aDpgfi5XZWJob29rLmVkaXRgIGFzIGNvcm91dGluZXMuCgogICAgVGhlIHNlY29uZCBmb3JtIGludm9sdmVzIGNyZWF0aW5nIGEgd2ViaG9vayBvYmplY3QgbWFudWFsbHkgd2l0aG91dCBoYXZpbmcKICAgIGl0IGJvdW5kIHRvIGEgd2Vic29ja2V0IGNvbm5lY3Rpb24gdXNpbmcgdGhlIDptZXRoOmB+LldlYmhvb2suZnJvbV91cmxgIG9yCiAgICA6bWV0aDpgfi5XZWJob29rLnBhcnRpYWxgIGNsYXNzbWV0aG9kcy4gVGhpcyBmb3JtIGFsbG93cyBmaW5lciBncmFpbmVkIGNvbnRyb2wKICAgIG92ZXIgaG93IHJlcXVlc3RzIGFyZSBkb25lLCBhbGxvd2luZyB5b3UgdG8gbWl4IGFzeW5jIGFuZCBzeW5jIGNvZGUgdXNpbmcgZWl0aGVyCiAgICA6ZG9jOmBhaW9odHRwIDxhaW86aW5kZXg+YCBvciA6ZG9jOmByZXE6aW5kZXhgLgoKICAgIEZvciBleGFtcGxlLCBjcmVhdGluZyBhIHdlYmhvb2sgZnJvbSBhIFVSTCBhbmQgdXNpbmcgOmRvYzpgYWlvaHR0cCA8YWlvOmluZGV4PmA6CgogICAgLi4gY29kZS1ibG9jazo6IHB5dGhvbjMKCiAgICAgICAgZnJvbSBkaXNjb3JkIGltcG9ydCBXZWJob29rLCBBc3luY1dlYmhvb2tBZGFwdGVyCiAgICAgICAgaW1wb3J0IGFpb2h0dHAKCiAgICAgICAgYXN5bmMgZGVmIGZvbygpOgogICAgICAgICAgICBhc3luYyB3aXRoIGFpb2h0dHAuQ2xpZW50U2Vzc2lvbigpIGFzIHNlc3Npb246CiAgICAgICAgICAgICAgICB3ZWJob29rID0gV2ViaG9vay5mcm9tX3VybCgndXJsLWhlcmUnLCBhZGFwdGVyPUFzeW5jV2ViaG9va0FkYXB0ZXIoc2Vzc2lvbikpCiAgICAgICAgICAgICAgICBhd2FpdCB3ZWJob29rLnNlbmQoJ0hlbGxvIFdvcmxkJywgdXNlcm5hbWU9J0ZvbycpCgogICAgT3IgY3JlYXRpbmcgYSB3ZWJob29rIGZyb20gYW4gSUQgYW5kIHRva2VuIGFuZCB1c2luZyA6ZG9jOmByZXE6aW5kZXhgOgoKICAgIC4uIGNvZGUtYmxvY2s6OiBweXRob24zCgogICAgICAgIGltcG9ydCByZXF1ZXN0cwogICAgICAgIGZyb20gZGlzY29yZCBpbXBvcnQgV2ViaG9vaywgUmVxdWVzdHNXZWJob29rQWRhcHRlcgoKICAgICAgICB3ZWJob29rID0gV2ViaG9vay5wYXJ0aWFsKDEyMzQ1NiwgJ2FiY2RlZmcnLCBhZGFwdGVyPVJlcXVlc3RzV2ViaG9va0FkYXB0ZXIoKSkKICAgICAgICB3ZWJob29rLnNlbmQoJ0hlbGxvIFdvcmxkJywgdXNlcm5hbWU9J0ZvbycpCgogICAgLi4gY29udGFpbmVyOjogb3BlcmF0aW9ucwoKICAgICAgICAuLiBkZXNjcmliZTo6IHggPT0geQoKICAgICAgICAgICAgQ2hlY2tzIGlmIHR3byB3ZWJob29rcyBhcmUgZXF1YWwuCgogICAgICAgIC4uIGRlc2NyaWJlOjogeCAhPSB5CgogICAgICAgICAgICBDaGVja3MgaWYgdHdvIHdlYmhvb2tzIGFyZSBub3QgZXF1YWwuCgogICAgICAgIC4uIGRlc2NyaWJlOjogaGFzaCh4KQoKICAgICAgICAgICAgUmV0dXJucyB0aGUgd2ViaG9va3MncyBoYXNoLgoKICAgIC4uIHZlcnNpb25jaGFuZ2VkOjogMS40CiAgICAgICAgV2ViaG9va3MgYXJlIG5vdyBjb21wYXJhYmxlIGFuZCBoYXNoYWJsZS4KCiAgICBBdHRyaWJ1dGVzCiAgICAtLS0tLS0tLS0tLS0KICAgIGlkOiA6Y2xhc3M6YGludGAKICAgICAgICBUaGUgd2ViaG9vaydzIElECiAgICB0eXBlOiA6Y2xhc3M6YFdlYmhvb2tUeXBlYAogICAgICAgIFRoZSB0eXBlIG9mIHRoZSB3ZWJob29rLgoKICAgICAgICAuLiB2ZXJzaW9uYWRkZWQ6OiAxLjMKCiAgICB0b2tlbjogT3B0aW9uYWxbOmNsYXNzOmBzdHJgXQogICAgICAgIFRoZSBhdXRoZW50aWNhdGlvbiB0b2tlbiBvZiB0aGUgd2ViaG9vay4gSWYgdGhpcyBpcyBgYE5vbmVgYAogICAgICAgIHRoZW4gdGhlIHdlYmhvb2sgY2Fubm90IGJlIHVzZWQgdG8gbWFrZSByZXF1ZXN0cy4KICAgIGd1aWxkX2lkOiBPcHRpb25hbFs6Y2xhc3M6YGludGBdCiAgICAgICAgVGhlIGd1aWxkIElEIHRoaXMgd2ViaG9vayBpcyBmb3IuCiAgICBjaGFubmVsX2lkOiBPcHRpb25hbFs6Y2xhc3M6YGludGBdCiAgICAgICAgVGhlIGNoYW5uZWwgSUQgdGhpcyB3ZWJob29rIGlzIGZvci4KICAgIHVzZXI6IE9wdGlvbmFsWzpjbGFzczpgYWJjLlVzZXJgXQogICAgICAgIFRoZSB1c2VyIHRoaXMgd2ViaG9vayB3YXMgY3JlYXRlZCBieS4gSWYgdGhlIHdlYmhvb2sgd2FzCiAgICAgICAgcmVjZWl2ZWQgd2l0aG91dCBhdXRoZW50aWNhdGlvbiB0aGVuIHRoaXMgd2lsbCBiZSBgYE5vbmVgYC4KICAgIG5hbWU6IE9wdGlvbmFsWzpjbGFzczpgc3RyYF0KICAgICAgICBUaGUgZGVmYXVsdCBuYW1lIG9mIHRoZSB3ZWJob29rLgogICAgYXZhdGFyOiBPcHRpb25hbFs6Y2xhc3M6YHN0cmBdCiAgICAgICAgVGhlIGRlZmF1bHQgYXZhdGFyIG9mIHRoZSB3ZWJob29rLgogICAgIiIiCgogICAgX19zbG90c19fID0gKCdpZCcsICd0eXBlJywgJ2d1aWxkX2lkJywgJ2NoYW5uZWxfaWQnLCAndXNlcicsICduYW1lJywKICAgICAgICAgICAgICAgICAnYXZhdGFyJywgJ3Rva2VuJywgJ19zdGF0ZScsICdfYWRhcHRlcicpCgogICAgZGVmIF9faW5pdF9fKHNlbGYsIGRhdGEsICosIGFkYXB0ZXIsIHN0YXRlPU5vbmUpOgogICAgICAgIHNlbGYuaWQgPSBpbnQoZGF0YVsnaWQnXSkKICAgICAgICBzZWxmLnR5cGUgPSB0cnlfZW51bShXZWJob29rVHlwZSwgaW50KGRhdGFbJ3R5cGUnXSkpCiAgICAgICAgc2VsZi5jaGFubmVsX2lkID0gdXRpbHMuX2dldF9hc19zbm93Zmxha2UoZGF0YSwgJ2NoYW5uZWxfaWQnKQogICAgICAgIHNlbGYuZ3VpbGRfaWQgPSB1dGlscy5fZ2V0X2FzX3Nub3dmbGFrZShkYXRhLCAnZ3VpbGRfaWQnKQogICAgICAgIHNlbGYubmFtZSA9IGRhdGEuZ2V0KCduYW1lJykKICAgICAgICBzZWxmLmF2YXRhciA9IGRhdGEuZ2V0KCdhdmF0YXInKQogICAgICAgIHNlbGYudG9rZW4gPSBkYXRhLmdldCgndG9rZW4nKQogICAgICAgIHNlbGYuX3N0YXRlID0gc3RhdGUgb3IgX1BhcnRpYWxXZWJob29rU3RhdGUoYWRhcHRlciwgc2VsZiwgcGFyZW50PXN0YXRlKQogICAgICAgIHNlbGYuX2FkYXB0ZXIgPSBhZGFwdGVyCiAgICAgICAgc2VsZi5fYWRhcHRlci5fcHJlcGFyZShzZWxmKQoKICAgICAgICB1c2VyID0gZGF0YS5nZXQoJ3VzZXInKQogICAgICAgIGlmIHVzZXIgaXMgTm9uZToKICAgICAgICAgICAgc2VsZi51c2VyID0gTm9uZQogICAgICAgIGVsaWYgc3RhdGUgaXMgTm9uZToKICAgICAgICAgICAgc2VsZi51c2VyID0gQmFzZVVzZXIoc3RhdGU9Tm9uZSwgZGF0YT11c2VyKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHNlbGYudXNlciA9IFVzZXIoc3RhdGU9c3RhdGUsIGRhdGE9dXNlcikKCiAgICBkZWYgX19yZXByX18oc2VsZik6CiAgICAgICAgcmV0dXJuICc8V2ViaG9vayBpZD0lcj4nICUgc2VsZi5pZAoKICAgIEBwcm9wZXJ0eQogICAgZGVmIHVybChzZWxmKToKICAgICAgICAiIiI6Y2xhc3M6YHN0cmAgOiBSZXR1cm5zIHRoZSB3ZWJob29rJ3MgdXJsLiIiIgogICAgICAgIHJldHVybiAnaHR0cHM6Ly9kaXNjb3JkLmNvbS9hcGkvd2ViaG9va3Mve30ve30nLmZvcm1hdChzZWxmLmlkLCBzZWxmLnRva2VuKQoKICAgIEBjbGFzc21ldGhvZAogICAgZGVmIHBhcnRpYWwoY2xzLCBpZCwgdG9rZW4sICosIGFkYXB0ZXIpOgogICAgICAgICIiIkNyZWF0ZXMgYSBwYXJ0aWFsIDpjbGFzczpgV2ViaG9va2AuCgogICAgICAgIFBhcmFtZXRlcnMKICAgICAgICAtLS0tLS0tLS0tLQogICAgICAgIGlkOiA6Y2xhc3M6YGludGAKICAgICAgICAgICAgVGhlIElEIG9mIHRoZSB3ZWJob29rLgogICAgICAgIHRva2VuOiA6Y2xhc3M6YHN0cmAKICAgICAgICAgICAgVGhlIGF1dGhlbnRpY2F0aW9uIHRva2VuIG9mIHRoZSB3ZWJob29rLgogICAgICAgIGFkYXB0ZXI6IDpjbGFzczpgV2ViaG9va0FkYXB0ZXJgCiAgICAgICAgICAgIFRoZSB3ZWJob29rIGFkYXB0ZXIgdG8gdXNlIHdoZW4gc2VuZGluZyByZXF1ZXN0cy4gVGhpcyBpcwogICAgICAgICAgICB0eXBpY2FsbHkgOmNsYXNzOmBBc3luY1dlYmhvb2tBZGFwdGVyYCBmb3IgOmRvYzpgYWlvaHR0cCA8YWlvOmluZGV4PmAgb3IKICAgICAgICAgICAgOmNsYXNzOmBSZXF1ZXN0c1dlYmhvb2tBZGFwdGVyYCBmb3IgOmRvYzpgcmVxOmluZGV4YC4KCiAgICAgICAgUmV0dXJucwogICAgICAgIC0tLS0tLS0tCiAgICAgICAgOmNsYXNzOmBXZWJob29rYAogICAgICAgICAgICBBIHBhcnRpYWwgOmNsYXNzOmBXZWJob29rYC4KICAgICAgICAgICAgQSBwYXJ0aWFsIHdlYmhvb2sgaXMganVzdCBhIHdlYmhvb2sgb2JqZWN0IHdpdGggYW4gSUQgYW5kIGEgdG9rZW4uCiAgICAgICAgIiIiCgogICAgICAgIGlmIG5vdCBpc2luc3RhbmNlKGFkYXB0ZXIsIFdlYmhvb2tBZGFwdGVyKToKICAgICAgICAgICAgcmFpc2UgVHlwZUVycm9yKCdhZGFwdGVyIG11c3QgYmUgYSBzdWJjbGFzcyBvZiBXZWJob29rQWRhcHRlcicpCgogICAgICAgIGRhdGEgPSB7CiAgICAgICAgICAgICdpZCc6IGlkLAogICAgICAgICAgICAndHlwZSc6IDEsCiAgICAgICAgICAgICd0b2tlbic6IHRva2VuCiAgICAgICAgfQoKICAgICAgICByZXR1cm4gY2xzKGRhdGEsIGFkYXB0ZXI9YWRhcHRlcikKCiAgICBAY2xhc3NtZXRob2QKICAgIGRlZiBmcm9tX3VybChjbHMsIHVybCwgKiwgYWRhcHRlcik6CiAgICAgICAgIiIiQ3JlYXRlcyBhIHBhcnRpYWwgOmNsYXNzOmBXZWJob29rYCBmcm9tIGEgd2ViaG9vayBVUkwuCgogICAgICAgIFBhcmFtZXRlcnMKICAgICAgICAtLS0tLS0tLS0tLS0KICAgICAgICB1cmw6IDpjbGFzczpgc3RyYAogICAgICAgICAgICBUaGUgVVJMIG9mIHRoZSB3ZWJob29rLgogICAgICAgIGFkYXB0ZXI6IDpjbGFzczpgV2ViaG9va0FkYXB0ZXJgCiAgICAgICAgICAgIFRoZSB3ZWJob29rIGFkYXB0ZXIgdG8gdXNlIHdoZW4gc2VuZGluZyByZXF1ZXN0cy4gVGhpcyBpcwogICAgICAgICAgICB0eXBpY2FsbHkgOmNsYXNzOmBBc3luY1dlYmhvb2tBZGFwdGVyYCBmb3IgOmRvYzpgYWlvaHR0cCA8YWlvOmluZGV4PmAgb3IKICAgICAgICAgICAgOmNsYXNzOmBSZXF1ZXN0c1dlYmhvb2tBZGFwdGVyYCBmb3IgOmRvYzpgcmVxOmluZGV4YC4KCiAgICAgICAgUmFpc2VzCiAgICAgICAgLS0tLS0tLQogICAgICAgIEludmFsaWRBcmd1bWVudAogICAgICAgICAgICBUaGUgVVJMIGlzIGludmFsaWQuCgogICAgICAgIFJldHVybnMKICAgICAgICAtLS0tLS0tLQogICAgICAgIDpjbGFzczpgV2ViaG9va2AKICAgICAgICAgICAgQSBwYXJ0aWFsIDpjbGFzczpgV2ViaG9va2AuCiAgICAgICAgICAgIEEgcGFydGlhbCB3ZWJob29rIGlzIGp1c3QgYSB3ZWJob29rIG9iamVjdCB3aXRoIGFuIElEIGFuZCBhIHRva2VuLgogICAgICAgICIiIgoKICAgICAgICBtID0gcmUuc2VhcmNoKHInZGlzY29yZCg/OmFwcCk/LmNvbS9hcGkvd2ViaG9va3MvKD9QPGlkPlswLTldezE3LDIwfSkvKD9QPHRva2VuPltBLVphLXowLTlcLlwtXF9dezYwLDY4fSknLCB1cmwpCiAgICAgICAgaWYgbSBpcyBOb25lOgogICAgICAgICAgICByYWlzZSBJbnZhbGlkQXJndW1lbnQoJ0ludmFsaWQgd2ViaG9vayBVUkwgZ2l2ZW4uJykKICAgICAgICBkYXRhID0gbS5ncm91cGRpY3QoKQogICAgICAgIGRhdGFbJ3R5cGUnXSA9IDEKICAgICAgICByZXR1cm4gY2xzKGRhdGEsIGFkYXB0ZXI9YWRhcHRlcikKCiAgICBAY2xhc3NtZXRob2QKICAgIGRlZiBfYXNfZm9sbG93ZXIoY2xzLCBkYXRhLCAqLCBjaGFubmVsLCB1c2VyKToKICAgICAgICBuYW1lID0gInt9ICN7fSIuZm9ybWF0KGNoYW5uZWwuZ3VpbGQsIGNoYW5uZWwpCiAgICAgICAgZmVlZCA9IHsKICAgICAgICAgICAgJ2lkJzogZGF0YVsnd2ViaG9va19pZCddLAogICAgICAgICAgICAndHlwZSc6IDIsCiAgICAgICAgICAgICduYW1lJzogbmFtZSwKICAgICAgICAgICAgJ2NoYW5uZWxfaWQnOiBjaGFubmVsLmlkLAogICAgICAgICAgICAnZ3VpbGRfaWQnOiBjaGFubmVsLmd1aWxkLmlkLAogICAgICAgICAgICAndXNlcic6IHsKICAgICAgICAgICAgICAgICd1c2VybmFtZSc6IHVzZXIubmFtZSwKICAgICAgICAgICAgICAgICdkaXNjcmltaW5hdG9yJzogdXNlci5kaXNjcmltaW5hdG9yLAogICAgICAgICAgICAgICAgJ2lkJzogdXNlci5pZCwKICAgICAgICAgICAgICAgICdhdmF0YXInOiB1c2VyLmF2YXRhcgogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBzZXNzaW9uID0gY2hhbm5lbC5fc3RhdGUuaHR0cC5fSFRUUENsaWVudF9fc2Vzc2lvbgogICAgICAgIHJldHVybiBjbHMoZmVlZCwgYWRhcHRlcj1Bc3luY1dlYmhvb2tBZGFwdGVyKHNlc3Npb249c2Vzc2lvbikpCgogICAgQGNsYXNzbWV0aG9kCiAgICBkZWYgZnJvbV9zdGF0ZShjbHMsIGRhdGEsIHN0YXRlKToKICAgICAgICBzZXNzaW9uID0gc3RhdGUuaHR0cC5fSFRUUENsaWVudF9fc2Vzc2lvbgogICAgICAgIHJldHVybiBjbHMoZGF0YSwgYWRhcHRlcj1Bc3luY1dlYmhvb2tBZGFwdGVyKHNlc3Npb249c2Vzc2lvbiksIHN0YXRlPXN0YXRlKQoKICAgIEBwcm9wZXJ0eQogICAgZGVmIGd1aWxkKHNlbGYpOgogICAgICAgICIiIk9wdGlvbmFsWzpjbGFzczpgR3VpbGRgXTogVGhlIGd1aWxkIHRoaXMgd2ViaG9vayBiZWxvbmdzIHRvLgoKICAgICAgICBJZiB0aGlzIGlzIGEgcGFydGlhbCB3ZWJob29rLCB0aGVuIHRoaXMgd2lsbCBhbHdheXMgcmV0dXJuIGBgTm9uZWBgLgogICAgICAgICIiIgogICAgICAgIHJldHVybiBzZWxmLl9zdGF0ZS5fZ2V0X2d1aWxkKHNlbGYuZ3VpbGRfaWQpCgogICAgQHByb3BlcnR5CiAgICBkZWYgY2hhbm5lbChzZWxmKToKICAgICAgICAiIiJPcHRpb25hbFs6Y2xhc3M6YFRleHRDaGFubmVsYF06IFRoZSB0ZXh0IGNoYW5uZWwgdGhpcyB3ZWJob29rIGJlbG9uZ3MgdG8uCgogICAgICAgIElmIHRoaXMgaXMgYSBwYXJ0aWFsIHdlYmhvb2ssIHRoZW4gdGhpcyB3aWxsIGFsd2F5cyByZXR1cm4gYGBOb25lYGAuCiAgICAgICAgIiIiCiAgICAgICAgZ3VpbGQgPSBzZWxmLmd1aWxkCiAgICAgICAgcmV0dXJuIGd1aWxkIGFuZCBndWlsZC5nZXRfY2hhbm5lbChzZWxmLmNoYW5uZWxfaWQpCgogICAgQHByb3BlcnR5CiAgICBkZWYgY3JlYXRlZF9hdChzZWxmKToKICAgICAgICAiIiI6Y2xhc3M6YGRhdGV0aW1lLmRhdGV0aW1lYDogUmV0dXJucyB0aGUgd2ViaG9vaydzIGNyZWF0aW9uIHRpbWUgaW4gVVRDLiIiIgogICAgICAgIHJldHVybiB1dGlscy5zbm93Zmxha2VfdGltZShzZWxmLmlkKQoKICAgIEBwcm9wZXJ0eQogICAgZGVmIGF2YXRhcl91cmwoc2VsZik6CiAgICAgICAgIiIiOmNsYXNzOmBBc3NldGA6IFJldHVybnMgYW4gOmNsYXNzOmBBc3NldGAgZm9yIHRoZSBhdmF0YXIgdGhlIHdlYmhvb2sgaGFzLgoKICAgICAgICBJZiB0aGUgd2ViaG9vayBkb2VzIG5vdCBoYXZlIGEgdHJhZGl0aW9uYWwgYXZhdGFyLCBhbiBhc3NldCBmb3IKICAgICAgICB0aGUgZGVmYXVsdCBhdmF0YXIgaXMgcmV0dXJuZWQgaW5zdGVhZC4KCiAgICAgICAgVGhpcyBpcyBlcXVpdmFsZW50IHRvIGNhbGxpbmcgOm1ldGg6YGF2YXRhcl91cmxfYXNgIHdpdGggdGhlCiAgICAgICAgZGVmYXVsdCBwYXJhbWV0ZXJzLgogICAgICAgICIiIgogICAgICAgIHJldHVybiBzZWxmLmF2YXRhcl91cmxfYXMoKQoKICAgIGRlZiBhdmF0YXJfdXJsX2FzKHNlbGYsICosIGZvcm1hdD1Ob25lLCBzaXplPTEwMjQpOgogICAgICAgICIiIlJldHVybnMgYW4gOmNsYXNzOmBBc3NldGAgZm9yIHRoZSBhdmF0YXIgdGhlIHdlYmhvb2sgaGFzLgoKICAgICAgICBJZiB0aGUgd2ViaG9vayBkb2VzIG5vdCBoYXZlIGEgdHJhZGl0aW9uYWwgYXZhdGFyLCBhbiBhc3NldCBmb3IKICAgICAgICB0aGUgZGVmYXVsdCBhdmF0YXIgaXMgcmV0dXJuZWQgaW5zdGVhZC4KCiAgICAgICAgVGhlIGZvcm1hdCBtdXN0IGJlIG9uZSBvZiAnanBlZycsICdqcGcnLCBvciAncG5nJy4KICAgICAgICBUaGUgc2l6ZSBtdXN0IGJlIGEgcG93ZXIgb2YgMiBiZXR3ZWVuIDE2IGFuZCAxMDI0LgoKICAgICAgICBQYXJhbWV0ZXJzCiAgICAgICAgLS0tLS0tLS0tLS0KICAgICAgICBmb3JtYXQ6IE9wdGlvbmFsWzpjbGFzczpgc3RyYF0KICAgICAgICAgICAgVGhlIGZvcm1hdCB0byBhdHRlbXB0IHRvIGNvbnZlcnQgdGhlIGF2YXRhciB0by4KICAgICAgICAgICAgSWYgdGhlIGZvcm1hdCBpcyBgYE5vbmVgYCwgdGhlbiBpdCBpcyBlcXVpdmFsZW50IHRvIHBuZy4KICAgICAgICBzaXplOiA6Y2xhc3M6YGludGAKICAgICAgICAgICAgVGhlIHNpemUgb2YgdGhlIGltYWdlIHRvIGRpc3BsYXkuCgogICAgICAgIFJhaXNlcwogICAgICAgIC0tLS0tLQogICAgICAgIEludmFsaWRBcmd1bWVudAogICAgICAgICAgICBCYWQgaW1hZ2UgZm9ybWF0IHBhc3NlZCB0byBgYGZvcm1hdGBgIG9yIGludmFsaWQgYGBzaXplYGAuCgogICAgICAgIFJldHVybnMKICAgICAgICAtLS0tLS0tLQogICAgICAgIDpjbGFzczpgQXNzZXRgCiAgICAgICAgICAgIFRoZSByZXN1bHRpbmcgQ0ROIGFzc2V0LgogICAgICAgICIiIgogICAgICAgIGlmIHNlbGYuYXZhdGFyIGlzIE5vbmU6CiAgICAgICAgICAgICMgRGVmYXVsdCBpcyBhbHdheXMgYmx1cnBsZSBhcHBhcmVudGx5CiAgICAgICAgICAgIHJldHVybiBBc3NldChzZWxmLl9zdGF0ZSwgJy9lbWJlZC9hdmF0YXJzLzAucG5nJykKCiAgICAgICAgaWYgbm90IHV0aWxzLnZhbGlkX2ljb25fc2l6ZShzaXplKToKICAgICAgICAgICAgcmFpc2UgSW52YWxpZEFyZ3VtZW50KCJzaXplIG11c3QgYmUgYSBwb3dlciBvZiAyIGJldHdlZW4gMTYgYW5kIDEwMjQiKQoKICAgICAgICBmb3JtYXQgPSBmb3JtYXQgb3IgJ3BuZycKCiAgICAgICAgaWYgZm9ybWF0IG5vdCBpbiAoJ3BuZycsICdqcGcnLCAnanBlZycpOgogICAgICAgICAgICByYWlzZSBJbnZhbGlkQXJndW1lbnQoImZvcm1hdCBtdXN0IGJlIG9uZSBvZiAncG5nJywgJ2pwZycsIG9yICdqcGVnJy4iKQoKICAgICAgICB1cmwgPSAnL2F2YXRhcnMvezAuaWR9L3swLmF2YXRhcn0uezF9P3NpemU9ezJ9Jy5mb3JtYXQoc2VsZiwgZm9ybWF0LCBzaXplKQogICAgICAgIHJldHVybiBBc3NldChzZWxmLl9zdGF0ZSwgdXJsKQoKICAgIGRlZiBkZWxldGUoc2VsZiwgKiwgcmVhc29uPU5vbmUpOgogICAgICAgICIiInxtYXliZWNvcm98CgogICAgICAgIERlbGV0ZXMgdGhpcyBXZWJob29rLgoKICAgICAgICBJZiB0aGUgd2ViaG9vayBpcyBjb25zdHJ1Y3RlZCB3aXRoIGEgOmNsYXNzOmBSZXF1ZXN0c1dlYmhvb2tBZGFwdGVyYCB0aGVuIHRoaXMgaXMKICAgICAgICBub3QgYSBjb3JvdXRpbmUuCgogICAgICAgIFBhcmFtZXRlcnMKICAgICAgICAtLS0tLS0tLS0tLS0KICAgICAgICByZWFzb246IE9wdGlvbmFsWzpjbGFzczpgc3RyYF0KICAgICAgICAgICAgVGhlIHJlYXNvbiBmb3IgZGVsZXRpbmcgdGhpcyB3ZWJob29rLiBTaG93cyB1cCBvbiB0aGUgYXVkaXQgbG9nLgoKICAgICAgICAgICAgLi4gdmVyc2lvbmFkZGVkOjogMS40CgogICAgICAgIFJhaXNlcwogICAgICAgIC0tLS0tLS0KICAgICAgICBIVFRQRXhjZXB0aW9uCiAgICAgICAgICAgIERlbGV0aW5nIHRoZSB3ZWJob29rIGZhaWxlZC4KICAgICAgICBOb3RGb3VuZAogICAgICAgICAgICBUaGlzIHdlYmhvb2sgZG9lcyBub3QgZXhpc3QuCiAgICAgICAgRm9yYmlkZGVuCiAgICAgICAgICAgIFlvdSBkbyBub3QgaGF2ZSBwZXJtaXNzaW9ucyB0byBkZWxldGUgdGhpcyB3ZWJob29rLgogICAgICAgIEludmFsaWRBcmd1bWVudAogICAgICAgICAgICBUaGlzIHdlYmhvb2sgZG9lcyBub3QgaGF2ZSBhIHRva2VuIGFzc29jaWF0ZWQgd2l0aCBpdC4KICAgICAgICAiIiIKICAgICAgICBpZiBzZWxmLnRva2VuIGlzIE5vbmU6CiAgICAgICAgICAgIHJhaXNlIEludmFsaWRBcmd1bWVudCgnVGhpcyB3ZWJob29rIGRvZXMgbm90IGhhdmUgYSB0b2tlbiBhc3NvY2lhdGVkIHdpdGggaXQnKQoKICAgICAgICByZXR1cm4gc2VsZi5fYWRhcHRlci5kZWxldGVfd2ViaG9vayhyZWFzb249cmVhc29uKQoKICAgIGRlZiBlZGl0KHNlbGYsICosIHJlYXNvbj1Ob25lLCAqKmt3YXJncyk6CiAgICAgICAgIiIifG1heWJlY29yb3wKCiAgICAgICAgRWRpdHMgdGhpcyBXZWJob29rLgoKICAgICAgICBJZiB0aGUgd2ViaG9vayBpcyBjb25zdHJ1Y3RlZCB3aXRoIGEgOmNsYXNzOmBSZXF1ZXN0c1dlYmhvb2tBZGFwdGVyYCB0aGVuIHRoaXMgaXMKICAgICAgICBub3QgYSBjb3JvdXRpbmUuCgogICAgICAgIFBhcmFtZXRlcnMKICAgICAgICAtLS0tLS0tLS0tLS0KICAgICAgICBuYW1lOiBPcHRpb25hbFs6Y2xhc3M6YHN0cmBdCiAgICAgICAgICAgIFRoZSB3ZWJob29rJ3MgbmV3IGRlZmF1bHQgbmFtZS4KICAgICAgICBhdmF0YXI6IE9wdGlvbmFsWzpjbGFzczpgYnl0ZXNgXQogICAgICAgICAgICBBIDp0ZXJtOmBweTpieXRlcy1saWtlIG9iamVjdGAgcmVwcmVzZW50aW5nIHRoZSB3ZWJob29rJ3MgbmV3IGRlZmF1bHQgYXZhdGFyLgogICAgICAgIHJlYXNvbjogT3B0aW9uYWxbOmNsYXNzOmBzdHJgXQogICAgICAgICAgICBUaGUgcmVhc29uIGZvciBlZGl0aW5nIHRoaXMgd2ViaG9vay4gU2hvd3MgdXAgb24gdGhlIGF1ZGl0IGxvZy4KCiAgICAgICAgICAgIC4uIHZlcnNpb25hZGRlZDo6IDEuNAoKICAgICAgICBSYWlzZXMKICAgICAgICAtLS0tLS0tCiAgICAgICAgSFRUUEV4Y2VwdGlvbgogICAgICAgICAgICBFZGl0aW5nIHRoZSB3ZWJob29rIGZhaWxlZC4KICAgICAgICBOb3RGb3VuZAogICAgICAgICAgICBUaGlzIHdlYmhvb2sgZG9lcyBub3QgZXhpc3QuCiAgICAgICAgSW52YWxpZEFyZ3VtZW50CiAgICAgICAgICAgIFRoaXMgd2ViaG9vayBkb2VzIG5vdCBoYXZlIGEgdG9rZW4gYXNzb2NpYXRlZCB3aXRoIGl0LgogICAgICAgICIiIgogICAgICAgIGlmIHNlbGYudG9rZW4gaXMgTm9uZToKICAgICAgICAgICAgcmFpc2UgSW52YWxpZEFyZ3VtZW50KCdUaGlzIHdlYmhvb2sgZG9lcyBub3QgaGF2ZSBhIHRva2VuIGFzc29jaWF0ZWQgd2l0aCBpdCcpCgogICAgICAgIHBheWxvYWQgPSB7fQoKICAgICAgICB0cnk6CiAgICAgICAgICAgIG5hbWUgPSBrd2FyZ3NbJ25hbWUnXQogICAgICAgIGV4Y2VwdCBLZXlFcnJvcjoKICAgICAgICAgICAgcGFzcwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGlmIG5hbWUgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICBwYXlsb2FkWyduYW1lJ10gPSBzdHIobmFtZSkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHBheWxvYWRbJ25hbWUnXSA9IE5vbmUKCiAgICAgICAgdHJ5OgogICAgICAgICAgICBhdmF0YXIgPSBrd2FyZ3NbJ2F2YXRhciddCiAgICAgICAgZXhjZXB0IEtleUVycm9yOgogICAgICAgICAgICBwYXNzCiAgICAgICAgZWxzZToKICAgICAgICAgICAgaWYgYXZhdGFyIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgcGF5bG9hZFsnYXZhdGFyJ10gPSB1dGlscy5fYnl0ZXNfdG9fYmFzZTY0X2RhdGEoYXZhdGFyKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgcGF5bG9hZFsnYXZhdGFyJ10gPSBOb25lCgogICAgICAgIHJldHVybiBzZWxmLl9hZGFwdGVyLmVkaXRfd2ViaG9vayhyZWFzb249cmVhc29uLCAqKnBheWxvYWQpCgogICAgZGVmIHNlbmQoc2VsZiwgY29udGVudD1Ob25lLCAqLCB3YWl0PUZhbHNlLCB1c2VybmFtZT1Ob25lLCBhdmF0YXJfdXJsPU5vbmUsIHR0cz1GYWxzZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsZT1Ob25lLCBmaWxlcz1Ob25lLCBlbWJlZD1Ob25lLCBlbWJlZHM9Tm9uZSwgYWxsb3dlZF9tZW50aW9ucz1Ob25lKToKICAgICAgICAiIiJ8bWF5YmVjb3JvfAoKICAgICAgICBTZW5kcyBhIG1lc3NhZ2UgdXNpbmcgdGhlIHdlYmhvb2suCgogICAgICAgIElmIHRoZSB3ZWJob29rIGlzIGNvbnN0cnVjdGVkIHdpdGggYSA6Y2xhc3M6YFJlcXVlc3RzV2ViaG9va0FkYXB0ZXJgIHRoZW4gdGhpcyBpcwogICAgICAgIG5vdCBhIGNvcm91dGluZS4KCiAgICAgICAgVGhlIGNvbnRlbnQgbXVzdCBiZSBhIHR5cGUgdGhhdCBjYW4gY29udmVydCB0byBhIHN0cmluZyB0aHJvdWdoIGBgc3RyKGNvbnRlbnQpYGAuCgogICAgICAgIFRvIHVwbG9hZCBhIHNpbmdsZSBmaWxlLCB0aGUgYGBmaWxlYGAgcGFyYW1ldGVyIHNob3VsZCBiZSB1c2VkIHdpdGggYQogICAgICAgIHNpbmdsZSA6Y2xhc3M6YEZpbGVgIG9iamVjdC4KCiAgICAgICAgSWYgdGhlIGBgZW1iZWRgYCBwYXJhbWV0ZXIgaXMgcHJvdmlkZWQsIGl0IG11c3QgYmUgb2YgdHlwZSA6Y2xhc3M6YEVtYmVkYCBhbmQKICAgICAgICBpdCBtdXN0IGJlIGEgcmljaCBlbWJlZCB0eXBlLiBZb3UgY2Fubm90IG1peCB0aGUgYGBlbWJlZGBgIHBhcmFtZXRlciB3aXRoIHRoZQogICAgICAgIGBgZW1iZWRzYGAgcGFyYW1ldGVyLCB3aGljaCBtdXN0IGJlIGEgOmNsYXNzOmBsaXN0YCBvZiA6Y2xhc3M6YEVtYmVkYCBvYmplY3RzIHRvIHNlbmQuCgogICAgICAgIFBhcmFtZXRlcnMKICAgICAgICAtLS0tLS0tLS0tLS0KICAgICAgICBjb250ZW50OiA6Y2xhc3M6YHN0cmAKICAgICAgICAgICAgVGhlIGNvbnRlbnQgb2YgdGhlIG1lc3NhZ2UgdG8gc2VuZC4KICAgICAgICB3YWl0OiA6Y2xhc3M6YGJvb2xgCiAgICAgICAgICAgIFdoZXRoZXIgdGhlIHNlcnZlciBzaG91bGQgd2FpdCBiZWZvcmUgc2VuZGluZyBhIHJlc3BvbnNlLiBUaGlzIGVzc2VudGlhbGx5CiAgICAgICAgICAgIG1lYW5zIHRoYXQgdGhlIHJldHVybiB0eXBlIG9mIHRoaXMgZnVuY3Rpb24gY2hhbmdlcyBmcm9tIGBgTm9uZWBgIHRvCiAgICAgICAgICAgIGEgOmNsYXNzOmBXZWJob29rTWVzc2FnZWAgaWYgc2V0IHRvIGBgVHJ1ZWBgLgogICAgICAgIHVzZXJuYW1lOiA6Y2xhc3M6YHN0cmAKICAgICAgICAgICAgVGhlIHVzZXJuYW1lIHRvIHNlbmQgd2l0aCB0aGlzIG1lc3NhZ2UuIElmIG5vIHVzZXJuYW1lIGlzIHByb3ZpZGVkCiAgICAgICAgICAgIHRoZW4gdGhlIGRlZmF1bHQgdXNlcm5hbWUgZm9yIHRoZSB3ZWJob29rIGlzIHVzZWQuCiAgICAgICAgYXZhdGFyX3VybDogVW5pb25bOmNsYXNzOmBzdHJgLCA6Y2xhc3M6YEFzc2V0YF0KICAgICAgICAgICAgVGhlIGF2YXRhciBVUkwgdG8gc2VuZCB3aXRoIHRoaXMgbWVzc2FnZS4gSWYgbm8gYXZhdGFyIFVSTCBpcyBwcm92aWRlZAogICAgICAgICAgICB0aGVuIHRoZSBkZWZhdWx0IGF2YXRhciBmb3IgdGhlIHdlYmhvb2sgaXMgdXNlZC4KICAgICAgICB0dHM6IDpjbGFzczpgYm9vbGAKICAgICAgICAgICAgSW5kaWNhdGVzIGlmIHRoZSBtZXNzYWdlIHNob3VsZCBiZSBzZW50IHVzaW5nIHRleHQtdG8tc3BlZWNoLgogICAgICAgIGZpbGU6IDpjbGFzczpgRmlsZWAKICAgICAgICAgICAgVGhlIGZpbGUgdG8gdXBsb2FkLiBUaGlzIGNhbm5vdCBiZSBtaXhlZCB3aXRoIGBgZmlsZXNgYCBwYXJhbWV0ZXIuCiAgICAgICAgZmlsZXM6IExpc3RbOmNsYXNzOmBGaWxlYF0KICAgICAgICAgICAgQSBsaXN0IG9mIGZpbGVzIHRvIHNlbmQgd2l0aCB0aGUgY29udGVudC4gVGhpcyBjYW5ub3QgYmUgbWl4ZWQgd2l0aCB0aGUKICAgICAgICAgICAgYGBmaWxlYGAgcGFyYW1ldGVyLgogICAgICAgIGVtYmVkOiA6Y2xhc3M6YEVtYmVkYAogICAgICAgICAgICBUaGUgcmljaCBlbWJlZCBmb3IgdGhlIGNvbnRlbnQgdG8gc2VuZC4gVGhpcyBjYW5ub3QgYmUgbWl4ZWQgd2l0aAogICAgICAgICAgICBgYGVtYmVkc2BgIHBhcmFtZXRlci4KICAgICAgICBlbWJlZHM6IExpc3RbOmNsYXNzOmBFbWJlZGBdCiAgICAgICAgICAgIEEgbGlzdCBvZiBlbWJlZHMgdG8gc2VuZCB3aXRoIHRoZSBjb250ZW50LiBNYXhpbXVtIG9mIDEwLiBUaGlzIGNhbm5vdAogICAgICAgICAgICBiZSBtaXhlZCB3aXRoIHRoZSBgYGVtYmVkYGAgcGFyYW1ldGVyLgogICAgICAgIGFsbG93ZWRfbWVudGlvbnM6IDpjbGFzczpgQWxsb3dlZE1lbnRpb25zYAogICAgICAgICAgICBDb250cm9scyB0aGUgbWVudGlvbnMgYmVpbmcgcHJvY2Vzc2VkIGluIHRoaXMgbWVzc2FnZS4KCiAgICAgICAgICAgIC4uIHZlcnNpb25hZGRlZDo6IDEuNAoKICAgICAgICBSYWlzZXMKICAgICAgICAtLS0tLS0tLQogICAgICAgIEhUVFBFeGNlcHRpb24KICAgICAgICAgICAgU2VuZGluZyB0aGUgbWVzc2FnZSBmYWlsZWQuCiAgICAgICAgTm90Rm91bmQKICAgICAgICAgICAgVGhpcyB3ZWJob29rIHdhcyBub3QgZm91bmQuCiAgICAgICAgRm9yYmlkZGVuCiAgICAgICAgICAgIFRoZSBhdXRob3JpemF0aW9uIHRva2VuIGZvciB0aGUgd2ViaG9vayBpcyBpbmNvcnJlY3QuCiAgICAgICAgSW52YWxpZEFyZ3VtZW50CiAgICAgICAgICAgIFlvdSBzcGVjaWZpZWQgYm90aCBgYGVtYmVkYGAgYW5kIGBgZW1iZWRzYGAgb3IgdGhlIGxlbmd0aCBvZgogICAgICAgICAgICBgYGVtYmVkc2BgIHdhcyBpbnZhbGlkIG9yIHRoZXJlIHdhcyBubyB0b2tlbiBhc3NvY2lhdGVkIHdpdGgKICAgICAgICAgICAgdGhpcyB3ZWJob29rLgoKICAgICAgICBSZXR1cm5zCiAgICAgICAgLS0tLS0tLS0tCiAgICAgICAgT3B0aW9uYWxbOmNsYXNzOmBXZWJob29rTWVzc2FnZWBdCiAgICAgICAgICAgIFRoZSBtZXNzYWdlIHRoYXQgd2FzIHNlbnQuCiAgICAgICAgIiIiCgogICAgICAgIHBheWxvYWQgPSB7fQogICAgICAgIGlmIHNlbGYudG9rZW4gaXMgTm9uZToKICAgICAgICAgICAgcmFpc2UgSW52YWxpZEFyZ3VtZW50KCdUaGlzIHdlYmhvb2sgZG9lcyBub3QgaGF2ZSBhIHRva2VuIGFzc29jaWF0ZWQgd2l0aCBpdCcpCiAgICAgICAgaWYgZmlsZXMgaXMgbm90IE5vbmUgYW5kIGZpbGUgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJhaXNlIEludmFsaWRBcmd1bWVudCgnQ2Fubm90IG1peCBmaWxlIGFuZCBmaWxlcyBrZXl3b3JkIGFyZ3VtZW50cy4nKQogICAgICAgIGlmIGVtYmVkcyBpcyBub3QgTm9uZSBhbmQgZW1iZWQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJhaXNlIEludmFsaWRBcmd1bWVudCgnQ2Fubm90IG1peCBlbWJlZCBhbmQgZW1iZWRzIGtleXdvcmQgYXJndW1lbnRzLicpCgogICAgICAgIGlmIGVtYmVkcyBpcyBub3QgTm9uZToKICAgICAgICAgICAgaWYgbGVuKGVtYmVkcykgPiAxMDoKICAgICAgICAgICAgICAgIHJhaXNlIEludmFsaWRBcmd1bWVudCgnZW1iZWRzIGhhcyBhIG1heGltdW0gb2YgMTAgZWxlbWVudHMuJykKICAgICAgICAgICAgcGF5bG9hZFsnZW1iZWRzJ10gPSBbZS50b19kaWN0KCkgZm9yIGUgaW4gZW1iZWRzXQoKICAgICAgICBpZiBlbWJlZCBpcyBub3QgTm9uZToKICAgICAgICAgICAgcGF5bG9hZFsnZW1iZWRzJ10gPSBbZW1iZWQudG9fZGljdCgpXQoKICAgICAgICBpZiBjb250ZW50IGlzIG5vdCBOb25lOgogICAgICAgICAgICBwYXlsb2FkWydjb250ZW50J10gPSBzdHIoY29udGVudCkKCiAgICAgICAgcGF5bG9hZFsndHRzJ10gPSB0dHMKICAgICAgICBpZiBhdmF0YXJfdXJsOgogICAgICAgICAgICBwYXlsb2FkWydhdmF0YXJfdXJsJ10gPSBzdHIoYXZhdGFyX3VybCkKICAgICAgICBpZiB1c2VybmFtZToKICAgICAgICAgICAgcGF5bG9hZFsndXNlcm5hbWUnXSA9IHVzZXJuYW1lCgogICAgICAgIHByZXZpb3VzX21lbnRpb25zID0gZ2V0YXR0cihzZWxmLl9zdGF0ZSwgJ2FsbG93ZWRfbWVudGlvbnMnLCBOb25lKQoKICAgICAgICBpZiBhbGxvd2VkX21lbnRpb25zOgogICAgICAgICAgICBpZiBwcmV2aW91c19tZW50aW9ucyBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgIHBheWxvYWRbJ2FsbG93ZWRfbWVudGlvbnMnXSA9IHByZXZpb3VzX21lbnRpb25zLm1lcmdlKGFsbG93ZWRfbWVudGlvbnMpLnRvX2RpY3QoKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgcGF5bG9hZFsnYWxsb3dlZF9tZW50aW9ucyddID0gYWxsb3dlZF9tZW50aW9ucy50b19kaWN0KCkKICAgICAgICBlbGlmIHByZXZpb3VzX21lbnRpb25zIGlzIG5vdCBOb25lOgogICAgICAgICAgICBwYXlsb2FkWydhbGxvd2VkX21lbnRpb25zJ10gPSBwcmV2aW91c19tZW50aW9ucy50b19kaWN0KCkKCiAgICAgICAgcmV0dXJuIHNlbGYuX2FkYXB0ZXIuZXhlY3V0ZV93ZWJob29rKHdhaXQ9d2FpdCwgZmlsZT1maWxlLCBmaWxlcz1maWxlcywgcGF5bG9hZD1wYXlsb2FkKQoKICAgIGRlZiBleGVjdXRlKHNlbGYsICphcmdzLCAqKmt3YXJncyk6CiAgICAgICAgIiIiQW4gYWxpYXMgZm9yIDptZXRoOmB+LldlYmhvb2suc2VuZGAuIiIiCiAgICAgICAgcmV0dXJuIHNlbGYuc2VuZCgqYXJncywgKiprd2FyZ3MpCgogICAgZGVmIGVkaXRfbWVzc2FnZShzZWxmLCBtZXNzYWdlX2lkLCAqKmZpZWxkcyk6CiAgICAgICAgIiIifG1heWJlY29yb3wKCiAgICAgICAgRWRpdHMgYSBtZXNzYWdlIG93bmVkIGJ5IHRoaXMgd2ViaG9vay4KCiAgICAgICAgVGhpcyBpcyBhIGxvd2VyIGxldmVsIGludGVyZmFjZSB0byA6bWV0aDpgV2ViaG9va01lc3NhZ2UuZWRpdGAgaW4gY2FzZQogICAgICAgIHlvdSBvbmx5IGhhdmUgYW4gSUQuCgogICAgICAgIC4uIHZlcnNpb25hZGRlZDo6IDEuNgoKICAgICAgICBQYXJhbWV0ZXJzCiAgICAgICAgLS0tLS0tLS0tLS0tCiAgICAgICAgbWVzc2FnZV9pZDogOmNsYXNzOmBpbnRgCiAgICAgICAgICAgIFRoZSBtZXNzYWdlIElEIHRvIGVkaXQuCiAgICAgICAgY29udGVudDogT3B0aW9uYWxbOmNsYXNzOmBzdHJgXQogICAgICAgICAgICBUaGUgY29udGVudCB0byBlZGl0IHRoZSBtZXNzYWdlIHdpdGggb3IgYGBOb25lYGAgdG8gY2xlYXIgaXQuCiAgICAgICAgZW1iZWRzOiBMaXN0WzpjbGFzczpgRW1iZWRgXQogICAgICAgICAgICBBIGxpc3Qgb2YgZW1iZWRzIHRvIGVkaXQgdGhlIG1lc3NhZ2Ugd2l0aC4KICAgICAgICBlbWJlZDogT3B0aW9uYWxbOmNsYXNzOmBFbWJlZGBdCiAgICAgICAgICAgIFRoZSBlbWJlZCB0byBlZGl0IHRoZSBtZXNzYWdlIHdpdGguIGBgTm9uZWBgIHN1cHByZXNzZXMgdGhlIGVtYmVkcy4KICAgICAgICAgICAgVGhpcyBzaG91bGQgbm90IGJlIG1peGVkIHdpdGggdGhlIGBgZW1iZWRzYGAgcGFyYW1ldGVyLgogICAgICAgIGFsbG93ZWRfbWVudGlvbnM6IDpjbGFzczpgQWxsb3dlZE1lbnRpb25zYAogICAgICAgICAgICBDb250cm9scyB0aGUgbWVudGlvbnMgYmVpbmcgcHJvY2Vzc2VkIGluIHRoaXMgbWVzc2FnZS4KICAgICAgICAgICAgU2VlIDptZXRoOmAuYWJjLk1lc3NhZ2VhYmxlLnNlbmRgIGZvciBtb3JlIGluZm9ybWF0aW9uLgoKICAgICAgICBSYWlzZXMKICAgICAgICAtLS0tLS0tCiAgICAgICAgSFRUUEV4Y2VwdGlvbgogICAgICAgICAgICBFZGl0aW5nIHRoZSBtZXNzYWdlIGZhaWxlZC4KICAgICAgICBGb3JiaWRkZW4KICAgICAgICAgICAgRWRpdGVkIGEgbWVzc2FnZSB0aGF0IGlzIG5vdCB5b3Vycy4KICAgICAgICBJbnZhbGlkQXJndW1lbnQKICAgICAgICAgICAgWW91IHNwZWNpZmllZCBib3RoIGBgZW1iZWRgYCBhbmQgYGBlbWJlZHNgYCBvciB0aGUgbGVuZ3RoIG9mCiAgICAgICAgICAgIGBgZW1iZWRzYGAgd2FzIGludmFsaWQgb3IgdGhlcmUgd2FzIG5vIHRva2VuIGFzc29jaWF0ZWQgd2l0aAogICAgICAgICAgICB0aGlzIHdlYmhvb2suCiAgICAgICAgIiIiCgogICAgICAgIHBheWxvYWQgPSB7fQoKICAgICAgICBpZiBzZWxmLnRva2VuIGlzIE5vbmU6CiAgICAgICAgICAgIHJhaXNlIEludmFsaWRBcmd1bWVudCgnVGhpcyB3ZWJob29rIGRvZXMgbm90IGhhdmUgYSB0b2tlbiBhc3NvY2lhdGVkIHdpdGggaXQnKQoKICAgICAgICB0cnk6CiAgICAgICAgICAgIGNvbnRlbnQgPSBmaWVsZHNbJ2NvbnRlbnQnXQogICAgICAgIGV4Y2VwdCBLZXlFcnJvcjoKICAgICAgICAgICAgcGFzcwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGlmIGNvbnRlbnQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICBjb250ZW50ID0gc3RyKGNvbnRlbnQpCiAgICAgICAgICAgIHBheWxvYWRbJ2NvbnRlbnQnXSA9IGNvbnRlbnQKCiAgICAgICAgIyBDaGVjayBpZiB0aGUgZW1iZWRzIGludGVyZmFjZSBpcyBiZWluZyB1c2VkCiAgICAgICAgdHJ5OgogICAgICAgICAgICBlbWJlZHMgPSBmaWVsZHNbJ2VtYmVkcyddCiAgICAgICAgZXhjZXB0IEtleUVycm9yOgogICAgICAgICAgICAjIE5vcGUKICAgICAgICAgICAgcGFzcwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGlmIGVtYmVkcyBpcyBOb25lIG9yIGxlbihlbWJlZHMpID4gMTA6CiAgICAgICAgICAgICAgICByYWlzZSBJbnZhbGlkQXJndW1lbnQoJ2VtYmVkcyBoYXMgYSBtYXhpbXVtIG9mIDEwIGVsZW1lbnRzJykKICAgICAgICAgICAgcGF5bG9hZFsnZW1iZWRzJ10gPSBbZS50b19kaWN0KCkgZm9yIGUgaW4gZW1iZWRzXQoKICAgICAgICB0cnk6CiAgICAgICAgICAgIGVtYmVkID0gZmllbGRzWydlbWJlZCddCiAgICAgICAgZXhjZXB0IEtleUVycm9yOgogICAgICAgICAgICBwYXNzCiAgICAgICAgZWxzZToKICAgICAgICAgICAgaWYgJ2VtYmVkcycgaW4gcGF5bG9hZDoKICAgICAgICAgICAgICAgIHJhaXNlIEludmFsaWRBcmd1bWVudCgnQ2Fubm90IG1peCBlbWJlZCBhbmQgZW1iZWRzIGtleXdvcmQgYXJndW1lbnRzJykKCiAgICAgICAgICAgIGlmIGVtYmVkIGlzIE5vbmU6CiAgICAgICAgICAgICAgICBwYXlsb2FkWydlbWJlZHMnXSA9IFtdCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBwYXlsb2FkWydlbWJlZHMnXSA9IFtlbWJlZC50b19kaWN0KCldCgogICAgICAgIGFsbG93ZWRfbWVudGlvbnMgPSBmaWVsZHMucG9wKCdhbGxvd2VkX21lbnRpb25zJywgTm9uZSkKICAgICAgICBwcmV2aW91c19tZW50aW9ucyA9IGdldGF0dHIoc2VsZi5fc3RhdGUsICdhbGxvd2VkX21lbnRpb25zJywgTm9uZSkKCiAgICAgICAgaWYgYWxsb3dlZF9tZW50aW9uczoKICAgICAgICAgICAgaWYgcHJldmlvdXNfbWVudGlvbnMgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICBwYXlsb2FkWydhbGxvd2VkX21lbnRpb25zJ10gPSBwcmV2aW91c19tZW50aW9ucy5tZXJnZShhbGxvd2VkX21lbnRpb25zKS50b19kaWN0KCkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHBheWxvYWRbJ2FsbG93ZWRfbWVudGlvbnMnXSA9IGFsbG93ZWRfbWVudGlvbnMudG9fZGljdCgpCiAgICAgICAgZWxpZiBwcmV2aW91c19tZW50aW9ucyBpcyBub3QgTm9uZToKICAgICAgICAgICAgcGF5bG9hZFsnYWxsb3dlZF9tZW50aW9ucyddID0gcHJldmlvdXNfbWVudGlvbnMudG9fZGljdCgpCgogICAgICAgIHJldHVybiBzZWxmLl9hZGFwdGVyLmVkaXRfd2ViaG9va19tZXNzYWdlKG1lc3NhZ2VfaWQsIHBheWxvYWQ9cGF5bG9hZCkKCiAgICBkZWYgZGVsZXRlX21lc3NhZ2Uoc2VsZiwgbWVzc2FnZV9pZCk6CiAgICAgICAgIiIifG1heWJlY29yb3wKCiAgICAgICAgRGVsZXRlcyBhIG1lc3NhZ2Ugb3duZWQgYnkgdGhpcyB3ZWJob29rLgoKICAgICAgICBUaGlzIGlzIGEgbG93ZXIgbGV2ZWwgaW50ZXJmYWNlIHRvIDptZXRoOmBXZWJob29rTWVzc2FnZS5kZWxldGVgIGluIGNhc2UKICAgICAgICB5b3Ugb25seSBoYXZlIGFuIElELgoKICAgICAgICAuLiB2ZXJzaW9uYWRkZWQ6OiAxLjYKCiAgICAgICAgUGFyYW1ldGVycwogICAgICAgIC0tLS0tLS0tLS0tLQogICAgICAgIG1lc3NhZ2VfaWQ6IDpjbGFzczpgaW50YAogICAgICAgICAgICBUaGUgbWVzc2FnZSBJRCB0byBkZWxldGUuCgogICAgICAgIFJhaXNlcwogICAgICAgIC0tLS0tLS0KICAgICAgICBIVFRQRXhjZXB0aW9uCiAgICAgICAgICAgIERlbGV0aW5nIHRoZSBtZXNzYWdlIGZhaWxlZC4KICAgICAgICBGb3JiaWRkZW4KICAgICAgICAgICAgRGVsZXRlZCBhIG1lc3NhZ2UgdGhhdCBpcyBub3QgeW91cnMuCiAgICAgICAgIiIiCiAgICAgICAgcmV0dXJuIHNlbGYuX2FkYXB0ZXIuZGVsZXRlX3dlYmhvb2tfbWVzc2FnZShtZXNzYWdlX2lkKQo=
