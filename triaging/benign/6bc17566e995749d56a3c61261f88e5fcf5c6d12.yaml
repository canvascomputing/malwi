statistics:
  total_files: 1
  skipped_files: 0.0
  processed_objects: 1
  malicious_objects: 0
details:
- path: .repo_cache/malicious_repos/pypi_malregistry/reuquests/2.28.2/reuquests-2.28.2/reuquests-2.28.2/tests/test_requests.py
  contents:
  - name: TestRequests.test_unicode_get
    score: 0.0
    code: "@pytest.mark.parametrize(\n        \"url, params\",\n        (\n            (\"/get\", {\"foo\": \"f\xF8\xF8\"}),\n            (\"/get\", {\"f\xF8\xF8\": \"f\xF8\xF8\"}),\n            (\"/get\", {\"f\xF8\xF8\": \"f\xF8\xF8\"}),\n            (\"/get\", {\"foo\": \"foo\"}),\n            (\"\xF8\", {\"foo\": \"foo\"}),\n        ),\n    )\n    def test_unicode_get(self, httpbin, url, params):\n        requests.get(httpbin(url), params=params)"
    tokens: resume load_global requests load_attr get push_null load_fast httpbin load_fast url call load_fast params kw_names params call pop_top return_const None
    hash: f0506c89e714ebe729dbb4e4721df84ca712adb94cd30fbb2d28ebbe66345382
sources:
  .repo_cache/malicious_repos/pypi_malregistry/reuquests/2.28.2/reuquests-2.28.2/reuquests-2.28.2/tests/test_requests.py: IiIiVGVzdHMgZm9yIFJlcXVlc3RzLiIiIgoKaW1wb3J0IGNvbGxlY3Rpb25zCmltcG9ydCBjb250ZXh0bGliCmltcG9ydCBpbwppbXBvcnQganNvbgppbXBvcnQgb3MKaW1wb3J0IHBpY2tsZQppbXBvcnQgcmUKaW1wb3J0IHdhcm5pbmdzCgppbXBvcnQgcHl0ZXN0CmltcG9ydCB1cmxsaWIzCmZyb20gdXJsbGliMy51dGlsIGltcG9ydCBUaW1lb3V0IGFzIFVybGxpYjNUaW1lb3V0CgppbXBvcnQgcmVxdWVzdHMKZnJvbSByZXF1ZXN0cy5hZGFwdGVycyBpbXBvcnQgSFRUUEFkYXB0ZXIKZnJvbSByZXF1ZXN0cy5hdXRoIGltcG9ydCBIVFRQRGlnZXN0QXV0aCwgX2Jhc2ljX2F1dGhfc3RyCmZyb20gcmVxdWVzdHMuY29tcGF0IGltcG9ydCAoCiAgICBKU09ORGVjb2RlRXJyb3IsCiAgICBNb3JzZWwsCiAgICBNdXRhYmxlTWFwcGluZywKICAgIGJ1aWx0aW5fc3RyLAogICAgY29va2llbGliLAogICAgZ2V0cHJveGllcywKICAgIHVybHBhcnNlLAopCmZyb20gcmVxdWVzdHMuY29va2llcyBpbXBvcnQgY29va2llamFyX2Zyb21fZGljdCwgbW9yc2VsX3RvX2Nvb2tpZQpmcm9tIHJlcXVlc3RzLmV4Y2VwdGlvbnMgaW1wb3J0ICgKICAgIENodW5rZWRFbmNvZGluZ0Vycm9yLAogICAgQ29ubmVjdGlvbkVycm9yLAogICAgQ29ubmVjdFRpbWVvdXQsCiAgICBDb250ZW50RGVjb2RpbmdFcnJvciwKICAgIEludmFsaWRIZWFkZXIsCiAgICBJbnZhbGlkUHJveHlVUkwsCiAgICBJbnZhbGlkU2NoZW1hLAogICAgSW52YWxpZFVSTCwKICAgIE1pc3NpbmdTY2hlbWEsCiAgICBQcm94eUVycm9yLAogICAgUmVhZFRpbWVvdXQsCiAgICBSZXF1ZXN0RXhjZXB0aW9uLAogICAgUmV0cnlFcnJvciwKKQpmcm9tIHJlcXVlc3RzLmV4Y2VwdGlvbnMgaW1wb3J0IFNTTEVycm9yIGFzIFJlcXVlc3RzU1NMRXJyb3IKZnJvbSByZXF1ZXN0cy5leGNlcHRpb25zIGltcG9ydCBUaW1lb3V0LCBUb29NYW55UmVkaXJlY3RzLCBVbnJld2luZGFibGVCb2R5RXJyb3IKZnJvbSByZXF1ZXN0cy5ob29rcyBpbXBvcnQgZGVmYXVsdF9ob29rcwpmcm9tIHJlcXVlc3RzLm1vZGVscyBpbXBvcnQgUHJlcGFyZWRSZXF1ZXN0LCB1cmxlbmNvZGUKZnJvbSByZXF1ZXN0cy5zZXNzaW9ucyBpbXBvcnQgU2Vzc2lvblJlZGlyZWN0TWl4aW4KZnJvbSByZXF1ZXN0cy5zdHJ1Y3R1cmVzIGltcG9ydCBDYXNlSW5zZW5zaXRpdmVEaWN0Cgpmcm9tIC5jb21wYXQgaW1wb3J0IFN0cmluZ0lPCmZyb20gLnV0aWxzIGltcG9ydCBvdmVycmlkZV9lbnZpcm9uCgojIFJlcXVlc3RzIHRvIHRoaXMgVVJMIHNob3VsZCBhbHdheXMgZmFpbCB3aXRoIGEgY29ubmVjdGlvbiB0aW1lb3V0IChub3RoaW5nCiMgbGlzdGVuaW5nIG9uIHRoYXQgcG9ydCkKVEFSUElUID0gImh0dHA6Ly8xMC4yNTUuMjU1LjEiCgojIFRoaXMgaXMgdG8gYXZvaWQgd2FpdGluZyB0aGUgdGltZW91dCBvZiB1c2luZyBUQVJQSVQKSU5WQUxJRF9QUk9YWSA9ICJodHRwOi8vbG9jYWxob3N0OjEiCgp0cnk6CiAgICBmcm9tIHNzbCBpbXBvcnQgU1NMQ29udGV4dAoKICAgIGRlbCBTU0xDb250ZXh0CiAgICBIQVNfTU9ERVJOX1NTTCA9IFRydWUKZXhjZXB0IEltcG9ydEVycm9yOgogICAgSEFTX01PREVSTl9TU0wgPSBGYWxzZQoKdHJ5OgogICAgcmVxdWVzdHMucHlvcGVuc3NsCiAgICBIQVNfUFlPUEVOU1NMID0gVHJ1ZQpleGNlcHQgQXR0cmlidXRlRXJyb3I6CiAgICBIQVNfUFlPUEVOU1NMID0gRmFsc2UKCgpjbGFzcyBUZXN0UmVxdWVzdHM6CgogICAgZGlnZXN0X2F1dGhfYWxnbyA9ICgiTUQ1IiwgIlNIQS0yNTYiLCAiU0hBLTUxMiIpCgogICAgZGVmIHRlc3RfZW50cnlfcG9pbnRzKHNlbGYpOgoKICAgICAgICByZXF1ZXN0cy5zZXNzaW9uCiAgICAgICAgcmVxdWVzdHMuc2Vzc2lvbigpLmdldAogICAgICAgIHJlcXVlc3RzLnNlc3Npb24oKS5oZWFkCiAgICAgICAgcmVxdWVzdHMuZ2V0CiAgICAgICAgcmVxdWVzdHMuaGVhZAogICAgICAgIHJlcXVlc3RzLnB1dAogICAgICAgIHJlcXVlc3RzLnBhdGNoCiAgICAgICAgcmVxdWVzdHMucG9zdAogICAgICAgICMgTm90IHJlYWxseSBhbiBlbnRyeSBwb2ludCwgYnV0IHBlb3BsZSByZWx5IG9uIGl0LgogICAgICAgIGZyb20gcmVxdWVzdHMucGFja2FnZXMudXJsbGliMy5wb29sbWFuYWdlciBpbXBvcnQgUG9vbE1hbmFnZXIgICMgbm9xYTpGNDAxCgogICAgQHB5dGVzdC5tYXJrLnBhcmFtZXRyaXplKAogICAgICAgICJleGNlcHRpb24sIHVybCIsCiAgICAgICAgKAogICAgICAgICAgICAoTWlzc2luZ1NjaGVtYSwgImhpd3BlZmhpcG93aGVmb3B3IiksCiAgICAgICAgICAgIChJbnZhbGlkU2NoZW1hLCAibG9jYWxob3N0OjMxMjgiKSwKICAgICAgICAgICAgKEludmFsaWRTY2hlbWEsICJsb2NhbGhvc3QubG9jYWxkb21haW46MzEyOC8iKSwKICAgICAgICAgICAgKEludmFsaWRTY2hlbWEsICIxMC4xMjIuMS4xOjMxMjgvIiksCiAgICAgICAgICAgIChJbnZhbGlkVVJMLCAiaHR0cDovLyIpLAogICAgICAgICAgICAoSW52YWxpZFVSTCwgImh0dHA6Ly8qZXhhbXBsZS5jb20iKSwKICAgICAgICAgICAgKEludmFsaWRVUkwsICJodHRwOi8vLmV4YW1wbGUuY29tIiksCiAgICAgICAgKSwKICAgICkKICAgIGRlZiB0ZXN0X2ludmFsaWRfdXJsKHNlbGYsIGV4Y2VwdGlvbiwgdXJsKToKICAgICAgICB3aXRoIHB5dGVzdC5yYWlzZXMoZXhjZXB0aW9uKToKICAgICAgICAgICAgcmVxdWVzdHMuZ2V0KHVybCkKCiAgICBkZWYgdGVzdF9iYXNpY19idWlsZGluZyhzZWxmKToKICAgICAgICByZXEgPSByZXF1ZXN0cy5SZXF1ZXN0KCkKICAgICAgICByZXEudXJsID0gImh0dHA6Ly9rZW5uZXRocmVpdHoub3JnLyIKICAgICAgICByZXEuZGF0YSA9IHsibGlmZSI6ICI0MiJ9CgogICAgICAgIHByID0gcmVxLnByZXBhcmUoKQogICAgICAgIGFzc2VydCBwci51cmwgPT0gcmVxLnVybAogICAgICAgIGFzc2VydCBwci5ib2R5ID09ICJsaWZlPTQyIgoKICAgIEBweXRlc3QubWFyay5wYXJhbWV0cml6ZSgibWV0aG9kIiwgKCJHRVQiLCAiSEVBRCIpKQogICAgZGVmIHRlc3Rfbm9fY29udGVudF9sZW5ndGgoc2VsZiwgaHR0cGJpbiwgbWV0aG9kKToKICAgICAgICByZXEgPSByZXF1ZXN0cy5SZXF1ZXN0KG1ldGhvZCwgaHR0cGJpbihtZXRob2QubG93ZXIoKSkpLnByZXBhcmUoKQogICAgICAgIGFzc2VydCAiQ29udGVudC1MZW5ndGgiIG5vdCBpbiByZXEuaGVhZGVycwoKICAgIEBweXRlc3QubWFyay5wYXJhbWV0cml6ZSgibWV0aG9kIiwgKCJQT1NUIiwgIlBVVCIsICJQQVRDSCIsICJPUFRJT05TIikpCiAgICBkZWYgdGVzdF9ub19ib2R5X2NvbnRlbnRfbGVuZ3RoKHNlbGYsIGh0dHBiaW4sIG1ldGhvZCk6CiAgICAgICAgcmVxID0gcmVxdWVzdHMuUmVxdWVzdChtZXRob2QsIGh0dHBiaW4obWV0aG9kLmxvd2VyKCkpKS5wcmVwYXJlKCkKICAgICAgICBhc3NlcnQgcmVxLmhlYWRlcnNbIkNvbnRlbnQtTGVuZ3RoIl0gPT0gIjAiCgogICAgQHB5dGVzdC5tYXJrLnBhcmFtZXRyaXplKCJtZXRob2QiLCAoIlBPU1QiLCAiUFVUIiwgIlBBVENIIiwgIk9QVElPTlMiKSkKICAgIGRlZiB0ZXN0X2VtcHR5X2NvbnRlbnRfbGVuZ3RoKHNlbGYsIGh0dHBiaW4sIG1ldGhvZCk6CiAgICAgICAgcmVxID0gcmVxdWVzdHMuUmVxdWVzdChtZXRob2QsIGh0dHBiaW4obWV0aG9kLmxvd2VyKCkpLCBkYXRhPSIiKS5wcmVwYXJlKCkKICAgICAgICBhc3NlcnQgcmVxLmhlYWRlcnNbIkNvbnRlbnQtTGVuZ3RoIl0gPT0gIjAiCgogICAgZGVmIHRlc3Rfb3ZlcnJpZGVfY29udGVudF9sZW5ndGgoc2VsZiwgaHR0cGJpbik6CiAgICAgICAgaGVhZGVycyA9IHsiQ29udGVudC1MZW5ndGgiOiAibm90IHplcm8ifQogICAgICAgIHIgPSByZXF1ZXN0cy5SZXF1ZXN0KCJQT1NUIiwgaHR0cGJpbigicG9zdCIpLCBoZWFkZXJzPWhlYWRlcnMpLnByZXBhcmUoKQogICAgICAgIGFzc2VydCAiQ29udGVudC1MZW5ndGgiIGluIHIuaGVhZGVycwogICAgICAgIGFzc2VydCByLmhlYWRlcnNbIkNvbnRlbnQtTGVuZ3RoIl0gPT0gIm5vdCB6ZXJvIgoKICAgIGRlZiB0ZXN0X3BhdGhfaXNfbm90X2RvdWJsZV9lbmNvZGVkKHNlbGYpOgogICAgICAgIHJlcXVlc3QgPSByZXF1ZXN0cy5SZXF1ZXN0KCJHRVQiLCAiaHR0cDovLzAuMC4wLjAvZ2V0L3Rlc3QgY2FzZSIpLnByZXBhcmUoKQoKICAgICAgICBhc3NlcnQgcmVxdWVzdC5wYXRoX3VybCA9PSAiL2dldC90ZXN0JTIwY2FzZSIKCiAgICBAcHl0ZXN0Lm1hcmsucGFyYW1ldHJpemUoCiAgICAgICAgInVybCwgZXhwZWN0ZWQiLAogICAgICAgICgKICAgICAgICAgICAgKAogICAgICAgICAgICAgICAgImh0dHA6Ly9leGFtcGxlLmNvbS9wYXRoI2ZyYWdtZW50IiwKICAgICAgICAgICAgICAgICJodHRwOi8vZXhhbXBsZS5jb20vcGF0aD9hPWIjZnJhZ21lbnQiLAogICAgICAgICAgICApLAogICAgICAgICAgICAoCiAgICAgICAgICAgICAgICAiaHR0cDovL2V4YW1wbGUuY29tL3BhdGg/a2V5PXZhbHVlI2ZyYWdtZW50IiwKICAgICAgICAgICAgICAgICJodHRwOi8vZXhhbXBsZS5jb20vcGF0aD9rZXk9dmFsdWUmYT1iI2ZyYWdtZW50IiwKICAgICAgICAgICAgKSwKICAgICAgICApLAogICAgKQogICAgZGVmIHRlc3RfcGFyYW1zX2FyZV9hZGRlZF9iZWZvcmVfZnJhZ21lbnQoc2VsZiwgdXJsLCBleHBlY3RlZCk6CiAgICAgICAgcmVxdWVzdCA9IHJlcXVlc3RzLlJlcXVlc3QoIkdFVCIsIHVybCwgcGFyYW1zPXsiYSI6ICJiIn0pLnByZXBhcmUoKQogICAgICAgIGFzc2VydCByZXF1ZXN0LnVybCA9PSBleHBlY3RlZAoKICAgIGRlZiB0ZXN0X3BhcmFtc19vcmlnaW5hbF9vcmRlcl9pc19wcmVzZXJ2ZWRfYnlfZGVmYXVsdChzZWxmKToKICAgICAgICBwYXJhbV9vcmRlcmVkX2RpY3QgPSBjb2xsZWN0aW9ucy5PcmRlcmVkRGljdCgKICAgICAgICAgICAgKCgieiIsIDEpLCAoImEiLCAxKSwgKCJrIiwgMSksICgiZCIsIDEpKQogICAgICAgICkKICAgICAgICBzZXNzaW9uID0gcmVxdWVzdHMuU2Vzc2lvbigpCiAgICAgICAgcmVxdWVzdCA9IHJlcXVlc3RzLlJlcXVlc3QoCiAgICAgICAgICAgICJHRVQiLCAiaHR0cDovL2V4YW1wbGUuY29tLyIsIHBhcmFtcz1wYXJhbV9vcmRlcmVkX2RpY3QKICAgICAgICApCiAgICAgICAgcHJlcCA9IHNlc3Npb24ucHJlcGFyZV9yZXF1ZXN0KHJlcXVlc3QpCiAgICAgICAgYXNzZXJ0IHByZXAudXJsID09ICJodHRwOi8vZXhhbXBsZS5jb20vP3o9MSZhPTEmaz0xJmQ9MSIKCiAgICBkZWYgdGVzdF9wYXJhbXNfYnl0ZXNfYXJlX2VuY29kZWQoc2VsZik6CiAgICAgICAgcmVxdWVzdCA9IHJlcXVlc3RzLlJlcXVlc3QoCiAgICAgICAgICAgICJHRVQiLCAiaHR0cDovL2V4YW1wbGUuY29tIiwgcGFyYW1zPWIidGVzdD1mb28iCiAgICAgICAgKS5wcmVwYXJlKCkKICAgICAgICBhc3NlcnQgcmVxdWVzdC51cmwgPT0gImh0dHA6Ly9leGFtcGxlLmNvbS8/dGVzdD1mb28iCgogICAgZGVmIHRlc3RfYmluYXJ5X3B1dChzZWxmKToKICAgICAgICByZXF1ZXN0ID0gcmVxdWVzdHMuUmVxdWVzdCgKICAgICAgICAgICAgIlBVVCIsICJodHRwOi8vZXhhbXBsZS5jb20iLCBkYXRhPSLDtsO2w7YiLmVuY29kZSgpCiAgICAgICAgKS5wcmVwYXJlKCkKICAgICAgICBhc3NlcnQgaXNpbnN0YW5jZShyZXF1ZXN0LmJvZHksIGJ5dGVzKQoKICAgIGRlZiB0ZXN0X3doaXRlc3BhY2VzX2FyZV9yZW1vdmVkX2Zyb21fdXJsKHNlbGYpOgogICAgICAgICMgVGVzdCBmb3IgaXNzdWUgIzM2OTYKICAgICAgICByZXF1ZXN0ID0gcmVxdWVzdHMuUmVxdWVzdCgiR0VUIiwgIiBodHRwOi8vZXhhbXBsZS5jb20iKS5wcmVwYXJlKCkKICAgICAgICBhc3NlcnQgcmVxdWVzdC51cmwgPT0gImh0dHA6Ly9leGFtcGxlLmNvbS8iCgogICAgQHB5dGVzdC5tYXJrLnBhcmFtZXRyaXplKCJzY2hlbWUiLCAoImh0dHA6Ly8iLCAiSFRUUDovLyIsICJoVFRwOi8vIiwgIkh0dFA6Ly8iKSkKICAgIGRlZiB0ZXN0X21peGVkX2Nhc2Vfc2NoZW1lX2FjY2VwdGFibGUoc2VsZiwgaHR0cGJpbiwgc2NoZW1lKToKICAgICAgICBzID0gcmVxdWVzdHMuU2Vzc2lvbigpCiAgICAgICAgcy5wcm94aWVzID0gZ2V0cHJveGllcygpCiAgICAgICAgcGFydHMgPSB1cmxwYXJzZShodHRwYmluKCJnZXQiKSkKICAgICAgICB1cmwgPSBzY2hlbWUgKyBwYXJ0cy5uZXRsb2MgKyBwYXJ0cy5wYXRoCiAgICAgICAgciA9IHJlcXVlc3RzLlJlcXVlc3QoIkdFVCIsIHVybCkKICAgICAgICByID0gcy5zZW5kKHIucHJlcGFyZSgpKQogICAgICAgIGFzc2VydCByLnN0YXR1c19jb2RlID09IDIwMCwgZiJmYWlsZWQgZm9yIHNjaGVtZSB7c2NoZW1lfSIKCiAgICBkZWYgdGVzdF9IVFRQXzIwMF9PS19HRVRfQUxURVJOQVRJVkUoc2VsZiwgaHR0cGJpbik6CiAgICAgICAgciA9IHJlcXVlc3RzLlJlcXVlc3QoIkdFVCIsIGh0dHBiaW4oImdldCIpKQogICAgICAgIHMgPSByZXF1ZXN0cy5TZXNzaW9uKCkKICAgICAgICBzLnByb3hpZXMgPSBnZXRwcm94aWVzKCkKCiAgICAgICAgciA9IHMuc2VuZChyLnByZXBhcmUoKSkKCiAgICAgICAgYXNzZXJ0IHIuc3RhdHVzX2NvZGUgPT0gMjAwCgogICAgZGVmIHRlc3RfSFRUUF8zMDJfQUxMT1dfUkVESVJFQ1RfR0VUKHNlbGYsIGh0dHBiaW4pOgogICAgICAgIHIgPSByZXF1ZXN0cy5nZXQoaHR0cGJpbigicmVkaXJlY3QiLCAiMSIpKQogICAgICAgIGFzc2VydCByLnN0YXR1c19jb2RlID09IDIwMAogICAgICAgIGFzc2VydCByLmhpc3RvcnlbMF0uc3RhdHVzX2NvZGUgPT0gMzAyCiAgICAgICAgYXNzZXJ0IHIuaGlzdG9yeVswXS5pc19yZWRpcmVjdAoKICAgIGRlZiB0ZXN0X0hUVFBfMzA3X0FMTE9XX1JFRElSRUNUX1BPU1Qoc2VsZiwgaHR0cGJpbik6CiAgICAgICAgciA9IHJlcXVlc3RzLnBvc3QoCiAgICAgICAgICAgIGh0dHBiaW4oInJlZGlyZWN0LXRvIiksCiAgICAgICAgICAgIGRhdGE9InRlc3QiLAogICAgICAgICAgICBwYXJhbXM9eyJ1cmwiOiAicG9zdCIsICJzdGF0dXNfY29kZSI6IDMwN30sCiAgICAgICAgKQogICAgICAgIGFzc2VydCByLnN0YXR1c19jb2RlID09IDIwMAogICAgICAgIGFzc2VydCByLmhpc3RvcnlbMF0uc3RhdHVzX2NvZGUgPT0gMzA3CiAgICAgICAgYXNzZXJ0IHIuaGlzdG9yeVswXS5pc19yZWRpcmVjdAogICAgICAgIGFzc2VydCByLmpzb24oKVsiZGF0YSJdID09ICJ0ZXN0IgoKICAgIGRlZiB0ZXN0X0hUVFBfMzA3X0FMTE9XX1JFRElSRUNUX1BPU1RfV0lUSF9TRUVLQUJMRShzZWxmLCBodHRwYmluKToKICAgICAgICBieXRlX3N0ciA9IGIidGVzdCIKICAgICAgICByID0gcmVxdWVzdHMucG9zdCgKICAgICAgICAgICAgaHR0cGJpbigicmVkaXJlY3QtdG8iKSwKICAgICAgICAgICAgZGF0YT1pby5CeXRlc0lPKGJ5dGVfc3RyKSwKICAgICAgICAgICAgcGFyYW1zPXsidXJsIjogInBvc3QiLCAic3RhdHVzX2NvZGUiOiAzMDd9LAogICAgICAgICkKICAgICAgICBhc3NlcnQgci5zdGF0dXNfY29kZSA9PSAyMDAKICAgICAgICBhc3NlcnQgci5oaXN0b3J5WzBdLnN0YXR1c19jb2RlID09IDMwNwogICAgICAgIGFzc2VydCByLmhpc3RvcnlbMF0uaXNfcmVkaXJlY3QKICAgICAgICBhc3NlcnQgci5qc29uKClbImRhdGEiXSA9PSBieXRlX3N0ci5kZWNvZGUoInV0Zi04IikKCiAgICBkZWYgdGVzdF9IVFRQXzMwMl9UT09fTUFOWV9SRURJUkVDVFMoc2VsZiwgaHR0cGJpbik6CiAgICAgICAgdHJ5OgogICAgICAgICAgICByZXF1ZXN0cy5nZXQoaHR0cGJpbigicmVsYXRpdmUtcmVkaXJlY3QiLCAiNTAiKSkKICAgICAgICBleGNlcHQgVG9vTWFueVJlZGlyZWN0cyBhcyBlOgogICAgICAgICAgICB1cmwgPSBodHRwYmluKCJyZWxhdGl2ZS1yZWRpcmVjdCIsICIyMCIpCiAgICAgICAgICAgIGFzc2VydCBlLnJlcXVlc3QudXJsID09IHVybAogICAgICAgICAgICBhc3NlcnQgZS5yZXNwb25zZS51cmwgPT0gdXJsCiAgICAgICAgICAgIGFzc2VydCBsZW4oZS5yZXNwb25zZS5oaXN0b3J5KSA9PSAzMAogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHB5dGVzdC5mYWlsKCJFeHBlY3RlZCByZWRpcmVjdCB0byByYWlzZSBUb29NYW55UmVkaXJlY3RzIGJ1dCBpdCBkaWQgbm90IikKCiAgICBkZWYgdGVzdF9IVFRQXzMwMl9UT09fTUFOWV9SRURJUkVDVFNfV0lUSF9QQVJBTVMoc2VsZiwgaHR0cGJpbik6CiAgICAgICAgcyA9IHJlcXVlc3RzLnNlc3Npb24oKQogICAgICAgIHMubWF4X3JlZGlyZWN0cyA9IDUKICAgICAgICB0cnk6CiAgICAgICAgICAgIHMuZ2V0KGh0dHBiaW4oInJlbGF0aXZlLXJlZGlyZWN0IiwgIjUwIikpCiAgICAgICAgZXhjZXB0IFRvb01hbnlSZWRpcmVjdHMgYXMgZToKICAgICAgICAgICAgdXJsID0gaHR0cGJpbigicmVsYXRpdmUtcmVkaXJlY3QiLCAiNDUiKQogICAgICAgICAgICBhc3NlcnQgZS5yZXF1ZXN0LnVybCA9PSB1cmwKICAgICAgICAgICAgYXNzZXJ0IGUucmVzcG9uc2UudXJsID09IHVybAogICAgICAgICAgICBhc3NlcnQgbGVuKGUucmVzcG9uc2UuaGlzdG9yeSkgPT0gNQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHB5dGVzdC5mYWlsKAogICAgICAgICAgICAgICAgIkV4cGVjdGVkIGN1c3RvbSBtYXggbnVtYmVyIG9mIHJlZGlyZWN0cyB0byBiZSByZXNwZWN0ZWQgYnV0IHdhcyBub3QiCiAgICAgICAgICAgICkKCiAgICBkZWYgdGVzdF9odHRwXzMwMV9jaGFuZ2VzX3Bvc3RfdG9fZ2V0KHNlbGYsIGh0dHBiaW4pOgogICAgICAgIHIgPSByZXF1ZXN0cy5wb3N0KGh0dHBiaW4oInN0YXR1cyIsICIzMDEiKSkKICAgICAgICBhc3NlcnQgci5zdGF0dXNfY29kZSA9PSAyMDAKICAgICAgICBhc3NlcnQgci5yZXF1ZXN0Lm1ldGhvZCA9PSAiR0VUIgogICAgICAgIGFzc2VydCByLmhpc3RvcnlbMF0uc3RhdHVzX2NvZGUgPT0gMzAxCiAgICAgICAgYXNzZXJ0IHIuaGlzdG9yeVswXS5pc19yZWRpcmVjdAoKICAgIGRlZiB0ZXN0X2h0dHBfMzAxX2RvZXNudF9jaGFuZ2VfaGVhZF90b19nZXQoc2VsZiwgaHR0cGJpbik6CiAgICAgICAgciA9IHJlcXVlc3RzLmhlYWQoaHR0cGJpbigic3RhdHVzIiwgIjMwMSIpLCBhbGxvd19yZWRpcmVjdHM9VHJ1ZSkKICAgICAgICBwcmludChyLmNvbnRlbnQpCiAgICAgICAgYXNzZXJ0IHIuc3RhdHVzX2NvZGUgPT0gMjAwCiAgICAgICAgYXNzZXJ0IHIucmVxdWVzdC5tZXRob2QgPT0gIkhFQUQiCiAgICAgICAgYXNzZXJ0IHIuaGlzdG9yeVswXS5zdGF0dXNfY29kZSA9PSAzMDEKICAgICAgICBhc3NlcnQgci5oaXN0b3J5WzBdLmlzX3JlZGlyZWN0CgogICAgZGVmIHRlc3RfaHR0cF8zMDJfY2hhbmdlc19wb3N0X3RvX2dldChzZWxmLCBodHRwYmluKToKICAgICAgICByID0gcmVxdWVzdHMucG9zdChodHRwYmluKCJzdGF0dXMiLCAiMzAyIikpCiAgICAgICAgYXNzZXJ0IHIuc3RhdHVzX2NvZGUgPT0gMjAwCiAgICAgICAgYXNzZXJ0IHIucmVxdWVzdC5tZXRob2QgPT0gIkdFVCIKICAgICAgICBhc3NlcnQgci5oaXN0b3J5WzBdLnN0YXR1c19jb2RlID09IDMwMgogICAgICAgIGFzc2VydCByLmhpc3RvcnlbMF0uaXNfcmVkaXJlY3QKCiAgICBkZWYgdGVzdF9odHRwXzMwMl9kb2VzbnRfY2hhbmdlX2hlYWRfdG9fZ2V0KHNlbGYsIGh0dHBiaW4pOgogICAgICAgIHIgPSByZXF1ZXN0cy5oZWFkKGh0dHBiaW4oInN0YXR1cyIsICIzMDIiKSwgYWxsb3dfcmVkaXJlY3RzPVRydWUpCiAgICAgICAgYXNzZXJ0IHIuc3RhdHVzX2NvZGUgPT0gMjAwCiAgICAgICAgYXNzZXJ0IHIucmVxdWVzdC5tZXRob2QgPT0gIkhFQUQiCiAgICAgICAgYXNzZXJ0IHIuaGlzdG9yeVswXS5zdGF0dXNfY29kZSA9PSAzMDIKICAgICAgICBhc3NlcnQgci5oaXN0b3J5WzBdLmlzX3JlZGlyZWN0CgogICAgZGVmIHRlc3RfaHR0cF8zMDNfY2hhbmdlc19wb3N0X3RvX2dldChzZWxmLCBodHRwYmluKToKICAgICAgICByID0gcmVxdWVzdHMucG9zdChodHRwYmluKCJzdGF0dXMiLCAiMzAzIikpCiAgICAgICAgYXNzZXJ0IHIuc3RhdHVzX2NvZGUgPT0gMjAwCiAgICAgICAgYXNzZXJ0IHIucmVxdWVzdC5tZXRob2QgPT0gIkdFVCIKICAgICAgICBhc3NlcnQgci5oaXN0b3J5WzBdLnN0YXR1c19jb2RlID09IDMwMwogICAgICAgIGFzc2VydCByLmhpc3RvcnlbMF0uaXNfcmVkaXJlY3QKCiAgICBkZWYgdGVzdF9odHRwXzMwM19kb2VzbnRfY2hhbmdlX2hlYWRfdG9fZ2V0KHNlbGYsIGh0dHBiaW4pOgogICAgICAgIHIgPSByZXF1ZXN0cy5oZWFkKGh0dHBiaW4oInN0YXR1cyIsICIzMDMiKSwgYWxsb3dfcmVkaXJlY3RzPVRydWUpCiAgICAgICAgYXNzZXJ0IHIuc3RhdHVzX2NvZGUgPT0gMjAwCiAgICAgICAgYXNzZXJ0IHIucmVxdWVzdC5tZXRob2QgPT0gIkhFQUQiCiAgICAgICAgYXNzZXJ0IHIuaGlzdG9yeVswXS5zdGF0dXNfY29kZSA9PSAzMDMKICAgICAgICBhc3NlcnQgci5oaXN0b3J5WzBdLmlzX3JlZGlyZWN0CgogICAgZGVmIHRlc3RfaGVhZGVyX2FuZF9ib2R5X3JlbW92YWxfb25fcmVkaXJlY3Qoc2VsZiwgaHR0cGJpbik6CiAgICAgICAgcHVyZ2VkX2hlYWRlcnMgPSAoIkNvbnRlbnQtTGVuZ3RoIiwgIkNvbnRlbnQtVHlwZSIpCiAgICAgICAgc2VzID0gcmVxdWVzdHMuU2Vzc2lvbigpCiAgICAgICAgcmVxID0gcmVxdWVzdHMuUmVxdWVzdCgiUE9TVCIsIGh0dHBiaW4oInBvc3QiKSwgZGF0YT17InRlc3QiOiAiZGF0YSJ9KQogICAgICAgIHByZXAgPSBzZXMucHJlcGFyZV9yZXF1ZXN0KHJlcSkKICAgICAgICByZXNwID0gc2VzLnNlbmQocHJlcCkKCiAgICAgICAgIyBNaW1pYyBhIHJlZGlyZWN0IHJlc3BvbnNlCiAgICAgICAgcmVzcC5zdGF0dXNfY29kZSA9IDMwMgogICAgICAgIHJlc3AuaGVhZGVyc1sibG9jYXRpb24iXSA9ICJnZXQiCgogICAgICAgICMgUnVuIHJlcXVlc3QgdGhyb3VnaCByZXNvbHZlX3JlZGlyZWN0cwogICAgICAgIG5leHRfcmVzcCA9IG5leHQoc2VzLnJlc29sdmVfcmVkaXJlY3RzKHJlc3AsIHByZXApKQogICAgICAgIGFzc2VydCBuZXh0X3Jlc3AucmVxdWVzdC5ib2R5IGlzIE5vbmUKICAgICAgICBmb3IgaGVhZGVyIGluIHB1cmdlZF9oZWFkZXJzOgogICAgICAgICAgICBhc3NlcnQgaGVhZGVyIG5vdCBpbiBuZXh0X3Jlc3AucmVxdWVzdC5oZWFkZXJzCgogICAgZGVmIHRlc3RfdHJhbnNmZXJfZW5jX3JlbW92YWxfb25fcmVkaXJlY3Qoc2VsZiwgaHR0cGJpbik6CiAgICAgICAgcHVyZ2VkX2hlYWRlcnMgPSAoIlRyYW5zZmVyLUVuY29kaW5nIiwgIkNvbnRlbnQtVHlwZSIpCiAgICAgICAgc2VzID0gcmVxdWVzdHMuU2Vzc2lvbigpCiAgICAgICAgcmVxID0gcmVxdWVzdHMuUmVxdWVzdCgiUE9TVCIsIGh0dHBiaW4oInBvc3QiKSwgZGF0YT0oYiJ4IiBmb3IgeCBpbiByYW5nZSgxKSkpCiAgICAgICAgcHJlcCA9IHNlcy5wcmVwYXJlX3JlcXVlc3QocmVxKQogICAgICAgIGFzc2VydCAiVHJhbnNmZXItRW5jb2RpbmciIGluIHByZXAuaGVhZGVycwoKICAgICAgICAjIENyZWF0ZSBSZXNwb25zZSB0byBhdm9pZCBodHRwczovL2dpdGh1Yi5jb20va2V2aW4xMDI0L3B5dGVzdC1odHRwYmluL2lzc3Vlcy8zMwogICAgICAgIHJlc3AgPSByZXF1ZXN0cy5SZXNwb25zZSgpCiAgICAgICAgcmVzcC5yYXcgPSBpby5CeXRlc0lPKGIidGhlIGNvbnRlbnQiKQogICAgICAgIHJlc3AucmVxdWVzdCA9IHByZXAKICAgICAgICBzZXRhdHRyKHJlc3AucmF3LCAicmVsZWFzZV9jb25uIiwgbGFtYmRhICphcmdzOiBhcmdzKQoKICAgICAgICAjIE1pbWljIGEgcmVkaXJlY3QgcmVzcG9uc2UKICAgICAgICByZXNwLnN0YXR1c19jb2RlID0gMzAyCiAgICAgICAgcmVzcC5oZWFkZXJzWyJsb2NhdGlvbiJdID0gaHR0cGJpbigiZ2V0IikKCiAgICAgICAgIyBSdW4gcmVxdWVzdCB0aHJvdWdoIHJlc29sdmVfcmVkaXJlY3QKICAgICAgICBuZXh0X3Jlc3AgPSBuZXh0KHNlcy5yZXNvbHZlX3JlZGlyZWN0cyhyZXNwLCBwcmVwKSkKICAgICAgICBhc3NlcnQgbmV4dF9yZXNwLnJlcXVlc3QuYm9keSBpcyBOb25lCiAgICAgICAgZm9yIGhlYWRlciBpbiBwdXJnZWRfaGVhZGVyczoKICAgICAgICAgICAgYXNzZXJ0IGhlYWRlciBub3QgaW4gbmV4dF9yZXNwLnJlcXVlc3QuaGVhZGVycwoKICAgIGRlZiB0ZXN0X2ZyYWdtZW50X21haW50YWluZWRfb25fcmVkaXJlY3Qoc2VsZiwgaHR0cGJpbik6CiAgICAgICAgZnJhZ21lbnQgPSAiI3ZpZXc9ZWRpdCZ0b2tlbj1odW50ZXIyIgogICAgICAgIHIgPSByZXF1ZXN0cy5nZXQoaHR0cGJpbigicmVkaXJlY3QtdG8/dXJsPWdldCIpICsgZnJhZ21lbnQpCgogICAgICAgIGFzc2VydCBsZW4oci5oaXN0b3J5KSA+IDAKICAgICAgICBhc3NlcnQgci5oaXN0b3J5WzBdLnJlcXVlc3QudXJsID09IGh0dHBiaW4oInJlZGlyZWN0LXRvP3VybD1nZXQiKSArIGZyYWdtZW50CiAgICAgICAgYXNzZXJ0IHIudXJsID09IGh0dHBiaW4oImdldCIpICsgZnJhZ21lbnQKCiAgICBkZWYgdGVzdF9IVFRQXzIwMF9PS19HRVRfV0lUSF9QQVJBTVMoc2VsZiwgaHR0cGJpbik6CiAgICAgICAgaGVhZHMgPSB7IlVzZXItYWdlbnQiOiAiTW96aWxsYS81LjAifQoKICAgICAgICByID0gcmVxdWVzdHMuZ2V0KGh0dHBiaW4oInVzZXItYWdlbnQiKSwgaGVhZGVycz1oZWFkcykKCiAgICAgICAgYXNzZXJ0IGhlYWRzWyJVc2VyLWFnZW50Il0gaW4gci50ZXh0CiAgICAgICAgYXNzZXJ0IHIuc3RhdHVzX2NvZGUgPT0gMjAwCgogICAgZGVmIHRlc3RfSFRUUF8yMDBfT0tfR0VUX1dJVEhfTUlYRURfUEFSQU1TKHNlbGYsIGh0dHBiaW4pOgogICAgICAgIGhlYWRzID0geyJVc2VyLWFnZW50IjogIk1vemlsbGEvNS4wIn0KCiAgICAgICAgciA9IHJlcXVlc3RzLmdldCgKICAgICAgICAgICAgaHR0cGJpbigiZ2V0IikgKyAiP3Rlc3Q9dHJ1ZSIsIHBhcmFtcz17InEiOiAidGVzdCJ9LCBoZWFkZXJzPWhlYWRzCiAgICAgICAgKQogICAgICAgIGFzc2VydCByLnN0YXR1c19jb2RlID09IDIwMAoKICAgIGRlZiB0ZXN0X3NldF9jb29raWVfb25fMzAxKHNlbGYsIGh0dHBiaW4pOgogICAgICAgIHMgPSByZXF1ZXN0cy5zZXNzaW9uKCkKICAgICAgICB1cmwgPSBodHRwYmluKCJjb29raWVzL3NldD9mb289YmFyIikKICAgICAgICBzLmdldCh1cmwpCiAgICAgICAgYXNzZXJ0IHMuY29va2llc1siZm9vIl0gPT0gImJhciIKCiAgICBkZWYgdGVzdF9jb29raWVfc2VudF9vbl9yZWRpcmVjdChzZWxmLCBodHRwYmluKToKICAgICAgICBzID0gcmVxdWVzdHMuc2Vzc2lvbigpCiAgICAgICAgcy5nZXQoaHR0cGJpbigiY29va2llcy9zZXQ/Zm9vPWJhciIpKQogICAgICAgIHIgPSBzLmdldChodHRwYmluKCJyZWRpcmVjdC8xIikpICAjIHJlZGlyZWN0cyB0byBodHRwYmluKCdnZXQnKQogICAgICAgIGFzc2VydCAiQ29va2llIiBpbiByLmpzb24oKVsiaGVhZGVycyJdCgogICAgZGVmIHRlc3RfY29va2llX3JlbW92ZWRfb25fZXhwaXJlKHNlbGYsIGh0dHBiaW4pOgogICAgICAgIHMgPSByZXF1ZXN0cy5zZXNzaW9uKCkKICAgICAgICBzLmdldChodHRwYmluKCJjb29raWVzL3NldD9mb289YmFyIikpCiAgICAgICAgYXNzZXJ0IHMuY29va2llc1siZm9vIl0gPT0gImJhciIKICAgICAgICBzLmdldCgKICAgICAgICAgICAgaHR0cGJpbigicmVzcG9uc2UtaGVhZGVycyIpLAogICAgICAgICAgICBwYXJhbXM9eyJTZXQtQ29va2llIjogImZvbz1kZWxldGVkOyBleHBpcmVzPVRodSwgMDEtSmFuLTE5NzAgMDA6MDA6MDEgR01UIn0sCiAgICAgICAgKQogICAgICAgIGFzc2VydCAiZm9vIiBub3QgaW4gcy5jb29raWVzCgogICAgZGVmIHRlc3RfY29va2llX3F1b3RlX3dyYXBwZWQoc2VsZiwgaHR0cGJpbik6CiAgICAgICAgcyA9IHJlcXVlc3RzLnNlc3Npb24oKQogICAgICAgIHMuZ2V0KGh0dHBiaW4oJ2Nvb2tpZXMvc2V0P2Zvbz0iYmFyOmJheiInKSkKICAgICAgICBhc3NlcnQgcy5jb29raWVzWyJmb28iXSA9PSAnImJhcjpiYXoiJwoKICAgIGRlZiB0ZXN0X2Nvb2tpZV9wZXJzaXN0c192aWFfYXBpKHNlbGYsIGh0dHBiaW4pOgogICAgICAgIHMgPSByZXF1ZXN0cy5zZXNzaW9uKCkKICAgICAgICByID0gcy5nZXQoaHR0cGJpbigicmVkaXJlY3QvMSIpLCBjb29raWVzPXsiZm9vIjogImJhciJ9KQogICAgICAgIGFzc2VydCAiZm9vIiBpbiByLnJlcXVlc3QuaGVhZGVyc1siQ29va2llIl0KICAgICAgICBhc3NlcnQgImZvbyIgaW4gci5oaXN0b3J5WzBdLnJlcXVlc3QuaGVhZGVyc1siQ29va2llIl0KCiAgICBkZWYgdGVzdF9yZXF1ZXN0X2Nvb2tpZV9vdmVycmlkZXNfc2Vzc2lvbl9jb29raWUoc2VsZiwgaHR0cGJpbik6CiAgICAgICAgcyA9IHJlcXVlc3RzLnNlc3Npb24oKQogICAgICAgIHMuY29va2llc1siZm9vIl0gPSAiYmFyIgogICAgICAgIHIgPSBzLmdldChodHRwYmluKCJjb29raWVzIiksIGNvb2tpZXM9eyJmb28iOiAiYmF6In0pCiAgICAgICAgYXNzZXJ0IHIuanNvbigpWyJjb29raWVzIl1bImZvbyJdID09ICJiYXoiCiAgICAgICAgIyBTZXNzaW9uIGNvb2tpZSBzaG91bGQgbm90IGJlIG1vZGlmaWVkCiAgICAgICAgYXNzZXJ0IHMuY29va2llc1siZm9vIl0gPT0gImJhciIKCiAgICBkZWYgdGVzdF9yZXF1ZXN0X2Nvb2tpZXNfbm90X3BlcnNpc3RlZChzZWxmLCBodHRwYmluKToKICAgICAgICBzID0gcmVxdWVzdHMuc2Vzc2lvbigpCiAgICAgICAgcy5nZXQoaHR0cGJpbigiY29va2llcyIpLCBjb29raWVzPXsiZm9vIjogImJheiJ9KQogICAgICAgICMgU2VuZGluZyBhIHJlcXVlc3Qgd2l0aCBjb29raWVzIHNob3VsZCBub3QgYWRkIGNvb2tpZXMgdG8gdGhlIHNlc3Npb24KICAgICAgICBhc3NlcnQgbm90IHMuY29va2llcwoKICAgIGRlZiB0ZXN0X2dlbmVyaWNfY29va2llamFyX3dvcmtzKHNlbGYsIGh0dHBiaW4pOgogICAgICAgIGNqID0gY29va2llbGliLkNvb2tpZUphcigpCiAgICAgICAgY29va2llamFyX2Zyb21fZGljdCh7ImZvbyI6ICJiYXIifSwgY2opCiAgICAgICAgcyA9IHJlcXVlc3RzLnNlc3Npb24oKQogICAgICAgIHMuY29va2llcyA9IGNqCiAgICAgICAgciA9IHMuZ2V0KGh0dHBiaW4oImNvb2tpZXMiKSkKICAgICAgICAjIE1ha2Ugc3VyZSB0aGUgY29va2llIHdhcyBzZW50CiAgICAgICAgYXNzZXJ0IHIuanNvbigpWyJjb29raWVzIl1bImZvbyJdID09ICJiYXIiCiAgICAgICAgIyBNYWtlIHN1cmUgdGhlIHNlc3Npb24gY2ogaXMgc3RpbGwgdGhlIGN1c3RvbSBvbmUKICAgICAgICBhc3NlcnQgcy5jb29raWVzIGlzIGNqCgogICAgZGVmIHRlc3RfcGFyYW1fY29va2llamFyX3dvcmtzKHNlbGYsIGh0dHBiaW4pOgogICAgICAgIGNqID0gY29va2llbGliLkNvb2tpZUphcigpCiAgICAgICAgY29va2llamFyX2Zyb21fZGljdCh7ImZvbyI6ICJiYXIifSwgY2opCiAgICAgICAgcyA9IHJlcXVlc3RzLnNlc3Npb24oKQogICAgICAgIHIgPSBzLmdldChodHRwYmluKCJjb29raWVzIiksIGNvb2tpZXM9Y2opCiAgICAgICAgIyBNYWtlIHN1cmUgdGhlIGNvb2tpZSB3YXMgc2VudAogICAgICAgIGFzc2VydCByLmpzb24oKVsiY29va2llcyJdWyJmb28iXSA9PSAiYmFyIgoKICAgIGRlZiB0ZXN0X2Nvb2tpZWxpYl9jb29raWVqYXJfb25fcmVkaXJlY3Qoc2VsZiwgaHR0cGJpbik6CiAgICAgICAgIiIiVGVzdHMgcmVzb2x2ZV9yZWRpcmVjdCBkb2Vzbid0IGZhaWwgd2hlbiBtZXJnaW5nIGNvb2tpZXMKICAgICAgICB3aXRoIG5vbi1SZXF1ZXN0c0Nvb2tpZUphciBjb29raWVqYXIuCgogICAgICAgIFNlZSBHSCAjMzU3OQogICAgICAgICIiIgogICAgICAgIGNqID0gY29va2llamFyX2Zyb21fZGljdCh7ImZvbyI6ICJiYXIifSwgY29va2llbGliLkNvb2tpZUphcigpKQogICAgICAgIHMgPSByZXF1ZXN0cy5TZXNzaW9uKCkKICAgICAgICBzLmNvb2tpZXMgPSBjb29raWVqYXJfZnJvbV9kaWN0KHsiY29va2llIjogInRhc3R5In0pCgogICAgICAgICMgUHJlcGFyZSByZXF1ZXN0IHdpdGhvdXQgdXNpbmcgU2Vzc2lvbgogICAgICAgIHJlcSA9IHJlcXVlc3RzLlJlcXVlc3QoIkdFVCIsIGh0dHBiaW4oImhlYWRlcnMiKSwgY29va2llcz1jaikKICAgICAgICBwcmVwX3JlcSA9IHJlcS5wcmVwYXJlKCkKCiAgICAgICAgIyBTZW5kIHJlcXVlc3QgYW5kIHNpbXVsYXRlIHJlZGlyZWN0CiAgICAgICAgcmVzcCA9IHMuc2VuZChwcmVwX3JlcSkKICAgICAgICByZXNwLnN0YXR1c19jb2RlID0gMzAyCiAgICAgICAgcmVzcC5oZWFkZXJzWyJsb2NhdGlvbiJdID0gaHR0cGJpbigiZ2V0IikKICAgICAgICByZWRpcmVjdHMgPSBzLnJlc29sdmVfcmVkaXJlY3RzKHJlc3AsIHByZXBfcmVxKQogICAgICAgIHJlc3AgPSBuZXh0KHJlZGlyZWN0cykKCiAgICAgICAgIyBWZXJpZnkgQ29va2llSmFyIGlzbid0IGJlaW5nIGNvbnZlcnRlZCB0byBSZXF1ZXN0c0Nvb2tpZUphcgogICAgICAgIGFzc2VydCBpc2luc3RhbmNlKHByZXBfcmVxLl9jb29raWVzLCBjb29raWVsaWIuQ29va2llSmFyKQogICAgICAgIGFzc2VydCBpc2luc3RhbmNlKHJlc3AucmVxdWVzdC5fY29va2llcywgY29va2llbGliLkNvb2tpZUphcikKICAgICAgICBhc3NlcnQgbm90IGlzaW5zdGFuY2UocmVzcC5yZXF1ZXN0Ll9jb29raWVzLCByZXF1ZXN0cy5jb29raWVzLlJlcXVlc3RzQ29va2llSmFyKQoKICAgICAgICBjb29raWVzID0ge30KICAgICAgICBmb3IgYyBpbiByZXNwLnJlcXVlc3QuX2Nvb2tpZXM6CiAgICAgICAgICAgIGNvb2tpZXNbYy5uYW1lXSA9IGMudmFsdWUKICAgICAgICBhc3NlcnQgY29va2llc1siZm9vIl0gPT0gImJhciIKICAgICAgICBhc3NlcnQgY29va2llc1siY29va2llIl0gPT0gInRhc3R5IgoKICAgIGRlZiB0ZXN0X3JlcXVlc3RzX2luX2hpc3RvcnlfYXJlX25vdF9vdmVycmlkZGVuKHNlbGYsIGh0dHBiaW4pOgogICAgICAgIHJlc3AgPSByZXF1ZXN0cy5nZXQoaHR0cGJpbigicmVkaXJlY3QvMyIpKQogICAgICAgIHVybHMgPSBbci51cmwgZm9yIHIgaW4gcmVzcC5oaXN0b3J5XQogICAgICAgIHJlcV91cmxzID0gW3IucmVxdWVzdC51cmwgZm9yIHIgaW4gcmVzcC5oaXN0b3J5XQogICAgICAgIGFzc2VydCB1cmxzID09IHJlcV91cmxzCgogICAgZGVmIHRlc3RfaGlzdG9yeV9pc19hbHdheXNfYV9saXN0KHNlbGYsIGh0dHBiaW4pOgogICAgICAgICIiIlNob3cgdGhhdCBldmVuIHdpdGggcmVkaXJlY3RzLCBSZXNwb25zZS5oaXN0b3J5IGlzIGFsd2F5cyBhIGxpc3QuIiIiCiAgICAgICAgcmVzcCA9IHJlcXVlc3RzLmdldChodHRwYmluKCJnZXQiKSkKICAgICAgICBhc3NlcnQgaXNpbnN0YW5jZShyZXNwLmhpc3RvcnksIGxpc3QpCiAgICAgICAgcmVzcCA9IHJlcXVlc3RzLmdldChodHRwYmluKCJyZWRpcmVjdC8xIikpCiAgICAgICAgYXNzZXJ0IGlzaW5zdGFuY2UocmVzcC5oaXN0b3J5LCBsaXN0KQogICAgICAgIGFzc2VydCBub3QgaXNpbnN0YW5jZShyZXNwLmhpc3RvcnksIHR1cGxlKQoKICAgIGRlZiB0ZXN0X2hlYWRlcnNfb25fc2Vzc2lvbl93aXRoX05vbmVfYXJlX25vdF9zZW50KHNlbGYsIGh0dHBiaW4pOgogICAgICAgICIiIkRvIG5vdCBzZW5kIGhlYWRlcnMgaW4gU2Vzc2lvbi5oZWFkZXJzIHdpdGggTm9uZSB2YWx1ZXMuIiIiCiAgICAgICAgc2VzID0gcmVxdWVzdHMuU2Vzc2lvbigpCiAgICAgICAgc2VzLmhlYWRlcnNbIkFjY2VwdC1FbmNvZGluZyJdID0gTm9uZQogICAgICAgIHJlcSA9IHJlcXVlc3RzLlJlcXVlc3QoIkdFVCIsIGh0dHBiaW4oImdldCIpKQogICAgICAgIHByZXAgPSBzZXMucHJlcGFyZV9yZXF1ZXN0KHJlcSkKICAgICAgICBhc3NlcnQgIkFjY2VwdC1FbmNvZGluZyIgbm90IGluIHByZXAuaGVhZGVycwoKICAgIGRlZiB0ZXN0X2hlYWRlcnNfcHJlc2VydmVfb3JkZXIoc2VsZiwgaHR0cGJpbik6CiAgICAgICAgIiIiUHJlc2VydmUgb3JkZXIgd2hlbiBoZWFkZXJzIHByb3ZpZGVkIGFzIE9yZGVyZWREaWN0LiIiIgogICAgICAgIHNlcyA9IHJlcXVlc3RzLlNlc3Npb24oKQogICAgICAgIHNlcy5oZWFkZXJzID0gY29sbGVjdGlvbnMuT3JkZXJlZERpY3QoKQogICAgICAgIHNlcy5oZWFkZXJzWyJBY2NlcHQtRW5jb2RpbmciXSA9ICJpZGVudGl0eSIKICAgICAgICBzZXMuaGVhZGVyc1siRmlyc3QiXSA9ICIxIgogICAgICAgIHNlcy5oZWFkZXJzWyJTZWNvbmQiXSA9ICIyIgogICAgICAgIGhlYWRlcnMgPSBjb2xsZWN0aW9ucy5PcmRlcmVkRGljdChbKCJUaGlyZCIsICIzIiksICgiRm91cnRoIiwgIjQiKV0pCiAgICAgICAgaGVhZGVyc1siRmlmdGgiXSA9ICI1IgogICAgICAgIGhlYWRlcnNbIlNlY29uZCJdID0gIjIyMiIKICAgICAgICByZXEgPSByZXF1ZXN0cy5SZXF1ZXN0KCJHRVQiLCBodHRwYmluKCJnZXQiKSwgaGVhZGVycz1oZWFkZXJzKQogICAgICAgIHByZXAgPSBzZXMucHJlcGFyZV9yZXF1ZXN0KHJlcSkKICAgICAgICBpdGVtcyA9IGxpc3QocHJlcC5oZWFkZXJzLml0ZW1zKCkpCiAgICAgICAgYXNzZXJ0IGl0ZW1zWzBdID09ICgiQWNjZXB0LUVuY29kaW5nIiwgImlkZW50aXR5IikKICAgICAgICBhc3NlcnQgaXRlbXNbMV0gPT0gKCJGaXJzdCIsICIxIikKICAgICAgICBhc3NlcnQgaXRlbXNbMl0gPT0gKCJTZWNvbmQiLCAiMjIyIikKICAgICAgICBhc3NlcnQgaXRlbXNbM10gPT0gKCJUaGlyZCIsICIzIikKICAgICAgICBhc3NlcnQgaXRlbXNbNF0gPT0gKCJGb3VydGgiLCAiNCIpCiAgICAgICAgYXNzZXJ0IGl0ZW1zWzVdID09ICgiRmlmdGgiLCAiNSIpCgogICAgQHB5dGVzdC5tYXJrLnBhcmFtZXRyaXplKCJrZXkiLCAoIlVzZXItYWdlbnQiLCAidXNlci1hZ2VudCIpKQogICAgZGVmIHRlc3RfdXNlcl9hZ2VudF90cmFuc2ZlcnMoc2VsZiwgaHR0cGJpbiwga2V5KToKCiAgICAgICAgaGVhZHMgPSB7a2V5OiAiTW96aWxsYS81LjAgKGdpdGh1Yi5jb20vcHNmL3JlcXVlc3RzKSJ9CgogICAgICAgIHIgPSByZXF1ZXN0cy5nZXQoaHR0cGJpbigidXNlci1hZ2VudCIpLCBoZWFkZXJzPWhlYWRzKQogICAgICAgIGFzc2VydCBoZWFkc1trZXldIGluIHIudGV4dAoKICAgIGRlZiB0ZXN0X0hUVFBfMjAwX09LX0hFQUQoc2VsZiwgaHR0cGJpbik6CiAgICAgICAgciA9IHJlcXVlc3RzLmhlYWQoaHR0cGJpbigiZ2V0IikpCiAgICAgICAgYXNzZXJ0IHIuc3RhdHVzX2NvZGUgPT0gMjAwCgogICAgZGVmIHRlc3RfSFRUUF8yMDBfT0tfUFVUKHNlbGYsIGh0dHBiaW4pOgogICAgICAgIHIgPSByZXF1ZXN0cy5wdXQoaHR0cGJpbigicHV0IikpCiAgICAgICAgYXNzZXJ0IHIuc3RhdHVzX2NvZGUgPT0gMjAwCgogICAgZGVmIHRlc3RfQkFTSUNBVVRIX1RVUExFX0hUVFBfMjAwX09LX0dFVChzZWxmLCBodHRwYmluKToKICAgICAgICBhdXRoID0gKCJ1c2VyIiwgInBhc3MiKQogICAgICAgIHVybCA9IGh0dHBiaW4oImJhc2ljLWF1dGgiLCAidXNlciIsICJwYXNzIikKCiAgICAgICAgciA9IHJlcXVlc3RzLmdldCh1cmwsIGF1dGg9YXV0aCkKICAgICAgICBhc3NlcnQgci5zdGF0dXNfY29kZSA9PSAyMDAKCiAgICAgICAgciA9IHJlcXVlc3RzLmdldCh1cmwpCiAgICAgICAgYXNzZXJ0IHIuc3RhdHVzX2NvZGUgPT0gNDAxCgogICAgICAgIHMgPSByZXF1ZXN0cy5zZXNzaW9uKCkKICAgICAgICBzLmF1dGggPSBhdXRoCiAgICAgICAgciA9IHMuZ2V0KHVybCkKICAgICAgICBhc3NlcnQgci5zdGF0dXNfY29kZSA9PSAyMDAKCiAgICBAcHl0ZXN0Lm1hcmsucGFyYW1ldHJpemUoCiAgICAgICAgInVzZXJuYW1lLCBwYXNzd29yZCIsCiAgICAgICAgKAogICAgICAgICAgICAoInVzZXIiLCAicGFzcyIpLAogICAgICAgICAgICAoItC40LzRjyIuZW5jb2RlKCksICLQv9Cw0YDQvtC70YwiLmVuY29kZSgpKSwKICAgICAgICAgICAgKDQyLCA0MiksCiAgICAgICAgICAgIChOb25lLCBOb25lKSwKICAgICAgICApLAogICAgKQogICAgZGVmIHRlc3Rfc2V0X2Jhc2ljYXV0aChzZWxmLCBodHRwYmluLCB1c2VybmFtZSwgcGFzc3dvcmQpOgogICAgICAgIGF1dGggPSAodXNlcm5hbWUsIHBhc3N3b3JkKQogICAgICAgIHVybCA9IGh0dHBiaW4oImdldCIpCgogICAgICAgIHIgPSByZXF1ZXN0cy5SZXF1ZXN0KCJHRVQiLCB1cmwsIGF1dGg9YXV0aCkKICAgICAgICBwID0gci5wcmVwYXJlKCkKCiAgICAgICAgYXNzZXJ0IHAuaGVhZGVyc1siQXV0aG9yaXphdGlvbiJdID09IF9iYXNpY19hdXRoX3N0cih1c2VybmFtZSwgcGFzc3dvcmQpCgogICAgZGVmIHRlc3RfYmFzaWNhdXRoX2VuY29kZXNfYnl0ZV9zdHJpbmdzKHNlbGYpOgogICAgICAgICIiIkVuc3VyZSBiJ3Rlc3QnIGZvcm1hdHMgYXMgdGhlIGJ5dGUgc3RyaW5nICJ0ZXN0IiByYXRoZXIKICAgICAgICB0aGFuIHRoZSB1bmljb2RlIHN0cmluZyAiYid0ZXN0JyIgaW4gUHl0aG9uIDMuCiAgICAgICAgIiIiCiAgICAgICAgYXV0aCA9IChiIlx4YzVceGFmc2VybmFtZSIsIGIidGVzdFx4YzZceGI2IikKICAgICAgICByID0gcmVxdWVzdHMuUmVxdWVzdCgiR0VUIiwgImh0dHA6Ly9sb2NhbGhvc3QiLCBhdXRoPWF1dGgpCiAgICAgICAgcCA9IHIucHJlcGFyZSgpCgogICAgICAgIGFzc2VydCBwLmhlYWRlcnNbIkF1dGhvcml6YXRpb24iXSA9PSAiQmFzaWMgeGE5elpYSnVZVzFsT25SbGMzVEd0Zz09IgoKICAgIEBweXRlc3QubWFyay5wYXJhbWV0cml6ZSgKICAgICAgICAidXJsLCBleGNlcHRpb24iLAogICAgICAgICgKICAgICAgICAgICAgIyBDb25uZWN0aW5nIHRvIGFuIHVua25vd24gZG9tYWluIHNob3VsZCByYWlzZSBhIENvbm5lY3Rpb25FcnJvcgogICAgICAgICAgICAoImh0dHA6Ly9kb2Vzbm90ZXhpc3QuZ29vZ2xlLmNvbSIsIENvbm5lY3Rpb25FcnJvciksCiAgICAgICAgICAgICMgQ29ubmVjdGluZyB0byBhbiBpbnZhbGlkIHBvcnQgc2hvdWxkIHJhaXNlIGEgQ29ubmVjdGlvbkVycm9yCiAgICAgICAgICAgICgiaHR0cDovL2xvY2FsaG9zdDoxIiwgQ29ubmVjdGlvbkVycm9yKSwKICAgICAgICAgICAgIyBJbnB1dGluZyBhIFVSTCB0aGF0IGNhbm5vdCBiZSBwYXJzZWQgc2hvdWxkIHJhaXNlIGFuIEludmFsaWRVUkwgZXJyb3IKICAgICAgICAgICAgKCJodHRwOi8vZmU4MDo6NTA1NDpmZjpmZTVhOmZjMCIsIEludmFsaWRVUkwpLAogICAgICAgICksCiAgICApCiAgICBkZWYgdGVzdF9lcnJvcnMoc2VsZiwgdXJsLCBleGNlcHRpb24pOgogICAgICAgIHdpdGggcHl0ZXN0LnJhaXNlcyhleGNlcHRpb24pOgogICAgICAgICAgICByZXF1ZXN0cy5nZXQodXJsLCB0aW1lb3V0PTEpCgogICAgZGVmIHRlc3RfcHJveHlfZXJyb3Ioc2VsZik6CiAgICAgICAgIyBhbnkgcHJveHkgcmVsYXRlZCBlcnJvciAoYWRkcmVzcyByZXNvbHV0aW9uLCBubyByb3V0ZSB0byBob3N0LCBldGMpIHNob3VsZCByZXN1bHQgaW4gYSBQcm94eUVycm9yCiAgICAgICAgd2l0aCBweXRlc3QucmFpc2VzKFByb3h5RXJyb3IpOgogICAgICAgICAgICByZXF1ZXN0cy5nZXQoCiAgICAgICAgICAgICAgICAiaHR0cDovL2xvY2FsaG9zdDoxIiwgcHJveGllcz17Imh0dHAiOiAibm9uLXJlc29sdmFibGUtYWRkcmVzcyJ9CiAgICAgICAgICAgICkKCiAgICBkZWYgdGVzdF9wcm94eV9lcnJvcl9vbl9iYWRfdXJsKHNlbGYsIGh0dHBiaW4sIGh0dHBiaW5fc2VjdXJlKToKICAgICAgICB3aXRoIHB5dGVzdC5yYWlzZXMoSW52YWxpZFByb3h5VVJMKToKICAgICAgICAgICAgcmVxdWVzdHMuZ2V0KGh0dHBiaW5fc2VjdXJlKCksIHByb3hpZXM9eyJodHRwcyI6ICJodHRwOi9iYWRwcm94eXVybDozMTI4In0pCgogICAgICAgIHdpdGggcHl0ZXN0LnJhaXNlcyhJbnZhbGlkUHJveHlVUkwpOgogICAgICAgICAgICByZXF1ZXN0cy5nZXQoaHR0cGJpbigpLCBwcm94aWVzPXsiaHR0cCI6ICJodHRwOi8vOjgwODAifSkKCiAgICAgICAgd2l0aCBweXRlc3QucmFpc2VzKEludmFsaWRQcm94eVVSTCk6CiAgICAgICAgICAgIHJlcXVlc3RzLmdldChodHRwYmluX3NlY3VyZSgpLCBwcm94aWVzPXsiaHR0cHMiOiAiaHR0cHM6Ly8ifSkKCiAgICAgICAgd2l0aCBweXRlc3QucmFpc2VzKEludmFsaWRQcm94eVVSTCk6CiAgICAgICAgICAgIHJlcXVlc3RzLmdldChodHRwYmluKCksIHByb3hpZXM9eyJodHRwIjogImh0dHA6Ly8vZXhhbXBsZS5jb206ODA4MCJ9KQoKICAgIGRlZiB0ZXN0X3Jlc3BlY3RfcHJveHlfZW52X29uX3NlbmRfc2VsZl9wcmVwYXJlZF9yZXF1ZXN0KHNlbGYsIGh0dHBiaW4pOgogICAgICAgIHdpdGggb3ZlcnJpZGVfZW52aXJvbihodHRwX3Byb3h5PUlOVkFMSURfUFJPWFkpOgogICAgICAgICAgICB3aXRoIHB5dGVzdC5yYWlzZXMoUHJveHlFcnJvcik6CiAgICAgICAgICAgICAgICBzZXNzaW9uID0gcmVxdWVzdHMuU2Vzc2lvbigpCiAgICAgICAgICAgICAgICByZXF1ZXN0ID0gcmVxdWVzdHMuUmVxdWVzdCgiR0VUIiwgaHR0cGJpbigpKQogICAgICAgICAgICAgICAgc2Vzc2lvbi5zZW5kKHJlcXVlc3QucHJlcGFyZSgpKQoKICAgIGRlZiB0ZXN0X3Jlc3BlY3RfcHJveHlfZW52X29uX3NlbmRfc2Vzc2lvbl9wcmVwYXJlZF9yZXF1ZXN0KHNlbGYsIGh0dHBiaW4pOgogICAgICAgIHdpdGggb3ZlcnJpZGVfZW52aXJvbihodHRwX3Byb3h5PUlOVkFMSURfUFJPWFkpOgogICAgICAgICAgICB3aXRoIHB5dGVzdC5yYWlzZXMoUHJveHlFcnJvcik6CiAgICAgICAgICAgICAgICBzZXNzaW9uID0gcmVxdWVzdHMuU2Vzc2lvbigpCiAgICAgICAgICAgICAgICByZXF1ZXN0ID0gcmVxdWVzdHMuUmVxdWVzdCgiR0VUIiwgaHR0cGJpbigpKQogICAgICAgICAgICAgICAgcHJlcGFyZWQgPSBzZXNzaW9uLnByZXBhcmVfcmVxdWVzdChyZXF1ZXN0KQogICAgICAgICAgICAgICAgc2Vzc2lvbi5zZW5kKHByZXBhcmVkKQoKICAgIGRlZiB0ZXN0X3Jlc3BlY3RfcHJveHlfZW52X29uX3NlbmRfd2l0aF9yZWRpcmVjdHMoc2VsZiwgaHR0cGJpbik6CiAgICAgICAgd2l0aCBvdmVycmlkZV9lbnZpcm9uKGh0dHBfcHJveHk9SU5WQUxJRF9QUk9YWSk6CiAgICAgICAgICAgIHdpdGggcHl0ZXN0LnJhaXNlcyhQcm94eUVycm9yKToKICAgICAgICAgICAgICAgIHNlc3Npb24gPSByZXF1ZXN0cy5TZXNzaW9uKCkKICAgICAgICAgICAgICAgIHVybCA9IGh0dHBiaW4oInJlZGlyZWN0LzEiKQogICAgICAgICAgICAgICAgcHJpbnQodXJsKQogICAgICAgICAgICAgICAgcmVxdWVzdCA9IHJlcXVlc3RzLlJlcXVlc3QoIkdFVCIsIHVybCkKICAgICAgICAgICAgICAgIHNlc3Npb24uc2VuZChyZXF1ZXN0LnByZXBhcmUoKSkKCiAgICBkZWYgdGVzdF9yZXNwZWN0X3Byb3h5X2Vudl9vbl9nZXQoc2VsZiwgaHR0cGJpbik6CiAgICAgICAgd2l0aCBvdmVycmlkZV9lbnZpcm9uKGh0dHBfcHJveHk9SU5WQUxJRF9QUk9YWSk6CiAgICAgICAgICAgIHdpdGggcHl0ZXN0LnJhaXNlcyhQcm94eUVycm9yKToKICAgICAgICAgICAgICAgIHNlc3Npb24gPSByZXF1ZXN0cy5TZXNzaW9uKCkKICAgICAgICAgICAgICAgIHNlc3Npb24uZ2V0KGh0dHBiaW4oKSkKCiAgICBkZWYgdGVzdF9yZXNwZWN0X3Byb3h5X2Vudl9vbl9yZXF1ZXN0KHNlbGYsIGh0dHBiaW4pOgogICAgICAgIHdpdGggb3ZlcnJpZGVfZW52aXJvbihodHRwX3Byb3h5PUlOVkFMSURfUFJPWFkpOgogICAgICAgICAgICB3aXRoIHB5dGVzdC5yYWlzZXMoUHJveHlFcnJvcik6CiAgICAgICAgICAgICAgICBzZXNzaW9uID0gcmVxdWVzdHMuU2Vzc2lvbigpCiAgICAgICAgICAgICAgICBzZXNzaW9uLnJlcXVlc3QobWV0aG9kPSJHRVQiLCB1cmw9aHR0cGJpbigpKQoKICAgIGRlZiB0ZXN0X3Byb3h5X2F1dGhvcml6YXRpb25fcHJlc2VydmVkX29uX3JlcXVlc3Qoc2VsZiwgaHR0cGJpbik6CiAgICAgICAgcHJveHlfYXV0aF92YWx1ZSA9ICJCZWFyZXIgWFhYIgogICAgICAgIHNlc3Npb24gPSByZXF1ZXN0cy5TZXNzaW9uKCkKICAgICAgICBzZXNzaW9uLmhlYWRlcnMudXBkYXRlKHsiUHJveHktQXV0aG9yaXphdGlvbiI6IHByb3h5X2F1dGhfdmFsdWV9KQogICAgICAgIHJlc3AgPSBzZXNzaW9uLnJlcXVlc3QobWV0aG9kPSJHRVQiLCB1cmw9aHR0cGJpbigiZ2V0IikpCiAgICAgICAgc2VudF9oZWFkZXJzID0gcmVzcC5qc29uKCkuZ2V0KCJoZWFkZXJzIiwge30pCgogICAgICAgIGFzc2VydCBzZW50X2hlYWRlcnMuZ2V0KCJQcm94eS1BdXRob3JpemF0aW9uIikgPT0gcHJveHlfYXV0aF92YWx1ZQoKICAgIGRlZiB0ZXN0X2Jhc2ljYXV0aF93aXRoX25ldHJjKHNlbGYsIGh0dHBiaW4pOgogICAgICAgIGF1dGggPSAoInVzZXIiLCAicGFzcyIpCiAgICAgICAgd3JvbmdfYXV0aCA9ICgid3Jvbmd1c2VyIiwgIndyb25ncGFzcyIpCiAgICAgICAgdXJsID0gaHR0cGJpbigiYmFzaWMtYXV0aCIsICJ1c2VyIiwgInBhc3MiKQoKICAgICAgICBvbGRfYXV0aCA9IHJlcXVlc3RzLnNlc3Npb25zLmdldF9uZXRyY19hdXRoCgogICAgICAgIHRyeToKCiAgICAgICAgICAgIGRlZiBnZXRfbmV0cmNfYXV0aF9tb2NrKHVybCk6CiAgICAgICAgICAgICAgICByZXR1cm4gYXV0aAoKICAgICAgICAgICAgcmVxdWVzdHMuc2Vzc2lvbnMuZ2V0X25ldHJjX2F1dGggPSBnZXRfbmV0cmNfYXV0aF9tb2NrCgogICAgICAgICAgICAjIFNob3VsZCB1c2UgbmV0cmMgYW5kIHdvcmsuCiAgICAgICAgICAgIHIgPSByZXF1ZXN0cy5nZXQodXJsKQogICAgICAgICAgICBhc3NlcnQgci5zdGF0dXNfY29kZSA9PSAyMDAKCiAgICAgICAgICAgICMgR2l2ZW4gYXV0aCBzaG91bGQgb3ZlcnJpZGUgYW5kIGZhaWwuCiAgICAgICAgICAgIHIgPSByZXF1ZXN0cy5nZXQodXJsLCBhdXRoPXdyb25nX2F1dGgpCiAgICAgICAgICAgIGFzc2VydCByLnN0YXR1c19jb2RlID09IDQwMQoKICAgICAgICAgICAgcyA9IHJlcXVlc3RzLnNlc3Npb24oKQoKICAgICAgICAgICAgIyBTaG91bGQgdXNlIG5ldHJjIGFuZCB3b3JrLgogICAgICAgICAgICByID0gcy5nZXQodXJsKQogICAgICAgICAgICBhc3NlcnQgci5zdGF0dXNfY29kZSA9PSAyMDAKCiAgICAgICAgICAgICMgR2l2ZW4gYXV0aCBzaG91bGQgb3ZlcnJpZGUgYW5kIGZhaWwuCiAgICAgICAgICAgIHMuYXV0aCA9IHdyb25nX2F1dGgKICAgICAgICAgICAgciA9IHMuZ2V0KHVybCkKICAgICAgICAgICAgYXNzZXJ0IHIuc3RhdHVzX2NvZGUgPT0gNDAxCiAgICAgICAgZmluYWxseToKICAgICAgICAgICAgcmVxdWVzdHMuc2Vzc2lvbnMuZ2V0X25ldHJjX2F1dGggPSBvbGRfYXV0aAoKICAgIGRlZiB0ZXN0X0RJR0VTVF9IVFRQXzIwMF9PS19HRVQoc2VsZiwgaHR0cGJpbik6CgogICAgICAgIGZvciBhdXRodHlwZSBpbiBzZWxmLmRpZ2VzdF9hdXRoX2FsZ286CiAgICAgICAgICAgIGF1dGggPSBIVFRQRGlnZXN0QXV0aCgidXNlciIsICJwYXNzIikKICAgICAgICAgICAgdXJsID0gaHR0cGJpbigiZGlnZXN0LWF1dGgiLCAiYXV0aCIsICJ1c2VyIiwgInBhc3MiLCBhdXRodHlwZSwgIm5ldmVyIikKCiAgICAgICAgICAgIHIgPSByZXF1ZXN0cy5nZXQodXJsLCBhdXRoPWF1dGgpCiAgICAgICAgICAgIGFzc2VydCByLnN0YXR1c19jb2RlID09IDIwMAoKICAgICAgICAgICAgciA9IHJlcXVlc3RzLmdldCh1cmwpCiAgICAgICAgICAgIGFzc2VydCByLnN0YXR1c19jb2RlID09IDQwMQogICAgICAgICAgICBwcmludChyLmhlYWRlcnNbIldXVy1BdXRoZW50aWNhdGUiXSkKCiAgICAgICAgICAgIHMgPSByZXF1ZXN0cy5zZXNzaW9uKCkKICAgICAgICAgICAgcy5hdXRoID0gSFRUUERpZ2VzdEF1dGgoInVzZXIiLCAicGFzcyIpCiAgICAgICAgICAgIHIgPSBzLmdldCh1cmwpCiAgICAgICAgICAgIGFzc2VydCByLnN0YXR1c19jb2RlID09IDIwMAoKICAgIGRlZiB0ZXN0X0RJR0VTVF9BVVRIX1JFVFVSTlNfQ09PS0lFKHNlbGYsIGh0dHBiaW4pOgoKICAgICAgICBmb3IgYXV0aHR5cGUgaW4gc2VsZi5kaWdlc3RfYXV0aF9hbGdvOgogICAgICAgICAgICB1cmwgPSBodHRwYmluKCJkaWdlc3QtYXV0aCIsICJhdXRoIiwgInVzZXIiLCAicGFzcyIsIGF1dGh0eXBlKQogICAgICAgICAgICBhdXRoID0gSFRUUERpZ2VzdEF1dGgoInVzZXIiLCAicGFzcyIpCiAgICAgICAgICAgIHIgPSByZXF1ZXN0cy5nZXQodXJsKQogICAgICAgICAgICBhc3NlcnQgci5jb29raWVzWyJmYWtlIl0gPT0gImZha2VfdmFsdWUiCgogICAgICAgICAgICByID0gcmVxdWVzdHMuZ2V0KHVybCwgYXV0aD1hdXRoKQogICAgICAgICAgICBhc3NlcnQgci5zdGF0dXNfY29kZSA9PSAyMDAKCiAgICBkZWYgdGVzdF9ESUdFU1RfQVVUSF9TRVRTX1NFU1NJT05fQ09PS0lFUyhzZWxmLCBodHRwYmluKToKCiAgICAgICAgZm9yIGF1dGh0eXBlIGluIHNlbGYuZGlnZXN0X2F1dGhfYWxnbzoKICAgICAgICAgICAgdXJsID0gaHR0cGJpbigiZGlnZXN0LWF1dGgiLCAiYXV0aCIsICJ1c2VyIiwgInBhc3MiLCBhdXRodHlwZSkKICAgICAgICAgICAgYXV0aCA9IEhUVFBEaWdlc3RBdXRoKCJ1c2VyIiwgInBhc3MiKQogICAgICAgICAgICBzID0gcmVxdWVzdHMuU2Vzc2lvbigpCiAgICAgICAgICAgIHMuZ2V0KHVybCwgYXV0aD1hdXRoKQogICAgICAgICAgICBhc3NlcnQgcy5jb29raWVzWyJmYWtlIl0gPT0gImZha2VfdmFsdWUiCgogICAgZGVmIHRlc3RfRElHRVNUX1NUUkVBTShzZWxmLCBodHRwYmluKToKCiAgICAgICAgZm9yIGF1dGh0eXBlIGluIHNlbGYuZGlnZXN0X2F1dGhfYWxnbzoKICAgICAgICAgICAgYXV0aCA9IEhUVFBEaWdlc3RBdXRoKCJ1c2VyIiwgInBhc3MiKQogICAgICAgICAgICB1cmwgPSBodHRwYmluKCJkaWdlc3QtYXV0aCIsICJhdXRoIiwgInVzZXIiLCAicGFzcyIsIGF1dGh0eXBlKQoKICAgICAgICAgICAgciA9IHJlcXVlc3RzLmdldCh1cmwsIGF1dGg9YXV0aCwgc3RyZWFtPVRydWUpCiAgICAgICAgICAgIGFzc2VydCByLnJhdy5yZWFkKCkgIT0gYiIiCgogICAgICAgICAgICByID0gcmVxdWVzdHMuZ2V0KHVybCwgYXV0aD1hdXRoLCBzdHJlYW09RmFsc2UpCiAgICAgICAgICAgIGFzc2VydCByLnJhdy5yZWFkKCkgPT0gYiIiCgogICAgZGVmIHRlc3RfRElHRVNUQVVUSF9XUk9OR19IVFRQXzQwMV9HRVQoc2VsZiwgaHR0cGJpbik6CgogICAgICAgIGZvciBhdXRodHlwZSBpbiBzZWxmLmRpZ2VzdF9hdXRoX2FsZ286CiAgICAgICAgICAgIGF1dGggPSBIVFRQRGlnZXN0QXV0aCgidXNlciIsICJ3cm9uZ3Bhc3MiKQogICAgICAgICAgICB1cmwgPSBodHRwYmluKCJkaWdlc3QtYXV0aCIsICJhdXRoIiwgInVzZXIiLCAicGFzcyIsIGF1dGh0eXBlKQoKICAgICAgICAgICAgciA9IHJlcXVlc3RzLmdldCh1cmwsIGF1dGg9YXV0aCkKICAgICAgICAgICAgYXNzZXJ0IHIuc3RhdHVzX2NvZGUgPT0gNDAxCgogICAgICAgICAgICByID0gcmVxdWVzdHMuZ2V0KHVybCkKICAgICAgICAgICAgYXNzZXJ0IHIuc3RhdHVzX2NvZGUgPT0gNDAxCgogICAgICAgICAgICBzID0gcmVxdWVzdHMuc2Vzc2lvbigpCiAgICAgICAgICAgIHMuYXV0aCA9IGF1dGgKICAgICAgICAgICAgciA9IHMuZ2V0KHVybCkKICAgICAgICAgICAgYXNzZXJ0IHIuc3RhdHVzX2NvZGUgPT0gNDAxCgogICAgZGVmIHRlc3RfRElHRVNUQVVUSF9RVU9URVNfUU9QX1ZBTFVFKHNlbGYsIGh0dHBiaW4pOgoKICAgICAgICBmb3IgYXV0aHR5cGUgaW4gc2VsZi5kaWdlc3RfYXV0aF9hbGdvOgogICAgICAgICAgICBhdXRoID0gSFRUUERpZ2VzdEF1dGgoInVzZXIiLCAicGFzcyIpCiAgICAgICAgICAgIHVybCA9IGh0dHBiaW4oImRpZ2VzdC1hdXRoIiwgImF1dGgiLCAidXNlciIsICJwYXNzIiwgYXV0aHR5cGUpCgogICAgICAgICAgICByID0gcmVxdWVzdHMuZ2V0KHVybCwgYXV0aD1hdXRoKQogICAgICAgICAgICBhc3NlcnQgJyJhdXRoIicgaW4gci5yZXF1ZXN0LmhlYWRlcnNbIkF1dGhvcml6YXRpb24iXQoKICAgIGRlZiB0ZXN0X1BPU1RCSU5fR0VUX1BPU1RfRklMRVMoc2VsZiwgaHR0cGJpbik6CgogICAgICAgIHVybCA9IGh0dHBiaW4oInBvc3QiKQogICAgICAgIHJlcXVlc3RzLnBvc3QodXJsKS5yYWlzZV9mb3Jfc3RhdHVzKCkKCiAgICAgICAgcG9zdDEgPSByZXF1ZXN0cy5wb3N0KHVybCwgZGF0YT17InNvbWUiOiAiZGF0YSJ9KQogICAgICAgIGFzc2VydCBwb3N0MS5zdGF0dXNfY29kZSA9PSAyMDAKCiAgICAgICAgd2l0aCBvcGVuKCJyZXF1aXJlbWVudHMtZGV2LnR4dCIpIGFzIGY6CiAgICAgICAgICAgIHBvc3QyID0gcmVxdWVzdHMucG9zdCh1cmwsIGZpbGVzPXsic29tZSI6IGZ9KQogICAgICAgIGFzc2VydCBwb3N0Mi5zdGF0dXNfY29kZSA9PSAyMDAKCiAgICAgICAgcG9zdDQgPSByZXF1ZXN0cy5wb3N0KHVybCwgZGF0YT0nW3sic29tZSI6ICJqc29uIn1dJykKICAgICAgICBhc3NlcnQgcG9zdDQuc3RhdHVzX2NvZGUgPT0gMjAwCgogICAgICAgIHdpdGggcHl0ZXN0LnJhaXNlcyhWYWx1ZUVycm9yKToKICAgICAgICAgICAgcmVxdWVzdHMucG9zdCh1cmwsIGZpbGVzPVsiYmFkIGZpbGUgZGF0YSJdKQoKICAgIGRlZiB0ZXN0X2ludmFsaWRfZmlsZXNfaW5wdXQoc2VsZiwgaHR0cGJpbik6CgogICAgICAgIHVybCA9IGh0dHBiaW4oInBvc3QiKQogICAgICAgIHBvc3QgPSByZXF1ZXN0cy5wb3N0KHVybCwgZmlsZXM9eyJyYW5kb20tZmlsZS0xIjogTm9uZSwgInJhbmRvbS1maWxlLTIiOiAxfSkKICAgICAgICBhc3NlcnQgYiduYW1lPSJyYW5kb20tZmlsZS0xIicgbm90IGluIHBvc3QucmVxdWVzdC5ib2R5CiAgICAgICAgYXNzZXJ0IGInbmFtZT0icmFuZG9tLWZpbGUtMiInIGluIHBvc3QucmVxdWVzdC5ib2R5CgogICAgZGVmIHRlc3RfUE9TVEJJTl9TRUVLRURfT0JKRUNUX1dJVEhfTk9fSVRFUihzZWxmLCBodHRwYmluKToKICAgICAgICBjbGFzcyBUZXN0U3RyZWFtOgogICAgICAgICAgICBkZWYgX19pbml0X18oc2VsZiwgZGF0YSk6CiAgICAgICAgICAgICAgICBzZWxmLmRhdGEgPSBkYXRhLmVuY29kZSgpCiAgICAgICAgICAgICAgICBzZWxmLmxlbmd0aCA9IGxlbihzZWxmLmRhdGEpCiAgICAgICAgICAgICAgICBzZWxmLmluZGV4ID0gMAoKICAgICAgICAgICAgZGVmIF9fbGVuX18oc2VsZik6CiAgICAgICAgICAgICAgICByZXR1cm4gc2VsZi5sZW5ndGgKCiAgICAgICAgICAgIGRlZiByZWFkKHNlbGYsIHNpemU9Tm9uZSk6CiAgICAgICAgICAgICAgICBpZiBzaXplOgogICAgICAgICAgICAgICAgICAgIHJldCA9IHNlbGYuZGF0YVtzZWxmLmluZGV4IDogc2VsZi5pbmRleCArIHNpemVdCiAgICAgICAgICAgICAgICAgICAgc2VsZi5pbmRleCArPSBzaXplCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIHJldCA9IHNlbGYuZGF0YVtzZWxmLmluZGV4IDpdCiAgICAgICAgICAgICAgICAgICAgc2VsZi5pbmRleCA9IHNlbGYubGVuZ3RoCiAgICAgICAgICAgICAgICByZXR1cm4gcmV0CgogICAgICAgICAgICBkZWYgdGVsbChzZWxmKToKICAgICAgICAgICAgICAgIHJldHVybiBzZWxmLmluZGV4CgogICAgICAgICAgICBkZWYgc2VlayhzZWxmLCBvZmZzZXQsIHdoZXJlPTApOgogICAgICAgICAgICAgICAgaWYgd2hlcmUgPT0gMDoKICAgICAgICAgICAgICAgICAgICBzZWxmLmluZGV4ID0gb2Zmc2V0CiAgICAgICAgICAgICAgICBlbGlmIHdoZXJlID09IDE6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5pbmRleCArPSBvZmZzZXQKICAgICAgICAgICAgICAgIGVsaWYgd2hlcmUgPT0gMjoKICAgICAgICAgICAgICAgICAgICBzZWxmLmluZGV4ID0gc2VsZi5sZW5ndGggKyBvZmZzZXQKCiAgICAgICAgdGVzdCA9IFRlc3RTdHJlYW0oInRlc3QiKQogICAgICAgIHBvc3QxID0gcmVxdWVzdHMucG9zdChodHRwYmluKCJwb3N0IiksIGRhdGE9dGVzdCkKICAgICAgICBhc3NlcnQgcG9zdDEuc3RhdHVzX2NvZGUgPT0gMjAwCiAgICAgICAgYXNzZXJ0IHBvc3QxLmpzb24oKVsiZGF0YSJdID09ICJ0ZXN0IgoKICAgICAgICB0ZXN0ID0gVGVzdFN0cmVhbSgidGVzdCIpCiAgICAgICAgdGVzdC5zZWVrKDIpCiAgICAgICAgcG9zdDIgPSByZXF1ZXN0cy5wb3N0KGh0dHBiaW4oInBvc3QiKSwgZGF0YT10ZXN0KQogICAgICAgIGFzc2VydCBwb3N0Mi5zdGF0dXNfY29kZSA9PSAyMDAKICAgICAgICBhc3NlcnQgcG9zdDIuanNvbigpWyJkYXRhIl0gPT0gInN0IgoKICAgIGRlZiB0ZXN0X1BPU1RCSU5fR0VUX1BPU1RfRklMRVNfV0lUSF9EQVRBKHNlbGYsIGh0dHBiaW4pOgoKICAgICAgICB1cmwgPSBodHRwYmluKCJwb3N0IikKICAgICAgICByZXF1ZXN0cy5wb3N0KHVybCkucmFpc2VfZm9yX3N0YXR1cygpCgogICAgICAgIHBvc3QxID0gcmVxdWVzdHMucG9zdCh1cmwsIGRhdGE9eyJzb21lIjogImRhdGEifSkKICAgICAgICBhc3NlcnQgcG9zdDEuc3RhdHVzX2NvZGUgPT0gMjAwCgogICAgICAgIHdpdGggb3BlbigicmVxdWlyZW1lbnRzLWRldi50eHQiKSBhcyBmOgogICAgICAgICAgICBwb3N0MiA9IHJlcXVlc3RzLnBvc3QodXJsLCBkYXRhPXsic29tZSI6ICJkYXRhIn0sIGZpbGVzPXsic29tZSI6IGZ9KQogICAgICAgIGFzc2VydCBwb3N0Mi5zdGF0dXNfY29kZSA9PSAyMDAKCiAgICAgICAgcG9zdDQgPSByZXF1ZXN0cy5wb3N0KHVybCwgZGF0YT0nW3sic29tZSI6ICJqc29uIn1dJykKICAgICAgICBhc3NlcnQgcG9zdDQuc3RhdHVzX2NvZGUgPT0gMjAwCgogICAgICAgIHdpdGggcHl0ZXN0LnJhaXNlcyhWYWx1ZUVycm9yKToKICAgICAgICAgICAgcmVxdWVzdHMucG9zdCh1cmwsIGZpbGVzPVsiYmFkIGZpbGUgZGF0YSJdKQoKICAgIGRlZiB0ZXN0X3Bvc3Rfd2l0aF9jdXN0b21fbWFwcGluZyhzZWxmLCBodHRwYmluKToKICAgICAgICBjbGFzcyBDdXN0b21NYXBwaW5nKE11dGFibGVNYXBwaW5nKToKICAgICAgICAgICAgZGVmIF9faW5pdF9fKHNlbGYsICphcmdzLCAqKmt3YXJncyk6CiAgICAgICAgICAgICAgICBzZWxmLmRhdGEgPSBkaWN0KCphcmdzLCAqKmt3YXJncykKCiAgICAgICAgICAgIGRlZiBfX2RlbGl0ZW1fXyhzZWxmLCBrZXkpOgogICAgICAgICAgICAgICAgZGVsIHNlbGYuZGF0YVtrZXldCgogICAgICAgICAgICBkZWYgX19nZXRpdGVtX18oc2VsZiwga2V5KToKICAgICAgICAgICAgICAgIHJldHVybiBzZWxmLmRhdGFba2V5XQoKICAgICAgICAgICAgZGVmIF9fc2V0aXRlbV9fKHNlbGYsIGtleSwgdmFsdWUpOgogICAgICAgICAgICAgICAgc2VsZi5kYXRhW2tleV0gPSB2YWx1ZQoKICAgICAgICAgICAgZGVmIF9faXRlcl9fKHNlbGYpOgogICAgICAgICAgICAgICAgcmV0dXJuIGl0ZXIoc2VsZi5kYXRhKQoKICAgICAgICAgICAgZGVmIF9fbGVuX18oc2VsZik6CiAgICAgICAgICAgICAgICByZXR1cm4gbGVuKHNlbGYuZGF0YSkKCiAgICAgICAgZGF0YSA9IEN1c3RvbU1hcHBpbmcoeyJzb21lIjogImRhdGEifSkKICAgICAgICB1cmwgPSBodHRwYmluKCJwb3N0IikKICAgICAgICBmb3VuZF9qc29uID0gcmVxdWVzdHMucG9zdCh1cmwsIGRhdGE9ZGF0YSkuanNvbigpLmdldCgiZm9ybSIpCiAgICAgICAgYXNzZXJ0IGZvdW5kX2pzb24gPT0geyJzb21lIjogImRhdGEifQoKICAgIGRlZiB0ZXN0X2NvbmZsaWN0aW5nX3Bvc3RfcGFyYW1zKHNlbGYsIGh0dHBiaW4pOgogICAgICAgIHVybCA9IGh0dHBiaW4oInBvc3QiKQogICAgICAgIHdpdGggb3BlbigicmVxdWlyZW1lbnRzLWRldi50eHQiKSBhcyBmOgogICAgICAgICAgICB3aXRoIHB5dGVzdC5yYWlzZXMoVmFsdWVFcnJvcik6CiAgICAgICAgICAgICAgICByZXF1ZXN0cy5wb3N0KHVybCwgZGF0YT0nW3sic29tZSI6ICJkYXRhIn1dJywgZmlsZXM9eyJzb21lIjogZn0pCgogICAgZGVmIHRlc3RfcmVxdWVzdF9va19zZXQoc2VsZiwgaHR0cGJpbik6CiAgICAgICAgciA9IHJlcXVlc3RzLmdldChodHRwYmluKCJzdGF0dXMiLCAiNDA0IikpCiAgICAgICAgYXNzZXJ0IG5vdCByLm9rCgogICAgZGVmIHRlc3Rfc3RhdHVzX3JhaXNpbmcoc2VsZiwgaHR0cGJpbik6CiAgICAgICAgciA9IHJlcXVlc3RzLmdldChodHRwYmluKCJzdGF0dXMiLCAiNDA0IikpCiAgICAgICAgd2l0aCBweXRlc3QucmFpc2VzKHJlcXVlc3RzLmV4Y2VwdGlvbnMuSFRUUEVycm9yKToKICAgICAgICAgICAgci5yYWlzZV9mb3Jfc3RhdHVzKCkKCiAgICAgICAgciA9IHJlcXVlc3RzLmdldChodHRwYmluKCJzdGF0dXMiLCAiNTAwIikpCiAgICAgICAgYXNzZXJ0IG5vdCByLm9rCgogICAgZGVmIHRlc3RfZGVjb21wcmVzc19nemlwKHNlbGYsIGh0dHBiaW4pOgogICAgICAgIHIgPSByZXF1ZXN0cy5nZXQoaHR0cGJpbigiZ3ppcCIpKQogICAgICAgIHIuY29udGVudC5kZWNvZGUoImFzY2lpIikKCiAgICBAcHl0ZXN0Lm1hcmsucGFyYW1ldHJpemUoCiAgICAgICAgInVybCwgcGFyYW1zIiwKICAgICAgICAoCiAgICAgICAgICAgICgiL2dldCIsIHsiZm9vIjogImbDuMO4In0pLAogICAgICAgICAgICAoIi9nZXQiLCB7ImbDuMO4IjogImbDuMO4In0pLAogICAgICAgICAgICAoIi9nZXQiLCB7ImbDuMO4IjogImbDuMO4In0pLAogICAgICAgICAgICAoIi9nZXQiLCB7ImZvbyI6ICJmb28ifSksCiAgICAgICAgICAgICgiw7giLCB7ImZvbyI6ICJmb28ifSksCiAgICAgICAgKSwKICAgICkKICAgIGRlZiB0ZXN0X3VuaWNvZGVfZ2V0KHNlbGYsIGh0dHBiaW4sIHVybCwgcGFyYW1zKToKICAgICAgICByZXF1ZXN0cy5nZXQoaHR0cGJpbih1cmwpLCBwYXJhbXM9cGFyYW1zKQoKICAgIGRlZiB0ZXN0X3VuaWNvZGVfaGVhZGVyX25hbWUoc2VsZiwgaHR0cGJpbik6CiAgICAgICAgcmVxdWVzdHMucHV0KAogICAgICAgICAgICBodHRwYmluKCJwdXQiKSwKICAgICAgICAgICAgaGVhZGVycz17IkNvbnRlbnQtVHlwZSI6ICJhcHBsaWNhdGlvbi9vY3RldC1zdHJlYW0ifSwKICAgICAgICAgICAgZGF0YT0iXHhmZiIsCiAgICAgICAgKSAgIyBjb21wYXQuc3RyIGlzIHVuaWNvZGUuCgogICAgZGVmIHRlc3RfcHlvcGVuc3NsX3JlZGlyZWN0KHNlbGYsIGh0dHBiaW5fc2VjdXJlLCBodHRwYmluX2NhX2J1bmRsZSk6CiAgICAgICAgcmVxdWVzdHMuZ2V0KGh0dHBiaW5fc2VjdXJlKCJzdGF0dXMiLCAiMzAxIiksIHZlcmlmeT1odHRwYmluX2NhX2J1bmRsZSkKCiAgICBkZWYgdGVzdF9pbnZhbGlkX2NhX2NlcnRpZmljYXRlX3BhdGgoc2VsZiwgaHR0cGJpbl9zZWN1cmUpOgogICAgICAgIElOVkFMSURfUEFUSCA9ICIvZ2FyYmFnZSIKICAgICAgICB3aXRoIHB5dGVzdC5yYWlzZXMoSU9FcnJvcikgYXMgZToKICAgICAgICAgICAgcmVxdWVzdHMuZ2V0KGh0dHBiaW5fc2VjdXJlKCksIHZlcmlmeT1JTlZBTElEX1BBVEgpCiAgICAgICAgYXNzZXJ0IHN0cigKICAgICAgICAgICAgZS52YWx1ZQogICAgICAgICkgPT0gIkNvdWxkIG5vdCBmaW5kIGEgc3VpdGFibGUgVExTIENBIGNlcnRpZmljYXRlIGJ1bmRsZSwgaW52YWxpZCBwYXRoOiB7fSIuZm9ybWF0KAogICAgICAgICAgICBJTlZBTElEX1BBVEgKICAgICAgICApCgogICAgZGVmIHRlc3RfaW52YWxpZF9zc2xfY2VydGlmaWNhdGVfZmlsZXMoc2VsZiwgaHR0cGJpbl9zZWN1cmUpOgogICAgICAgIElOVkFMSURfUEFUSCA9ICIvZ2FyYmFnZSIKICAgICAgICB3aXRoIHB5dGVzdC5yYWlzZXMoSU9FcnJvcikgYXMgZToKICAgICAgICAgICAgcmVxdWVzdHMuZ2V0KGh0dHBiaW5fc2VjdXJlKCksIGNlcnQ9SU5WQUxJRF9QQVRIKQogICAgICAgIGFzc2VydCBzdHIoCiAgICAgICAgICAgIGUudmFsdWUKICAgICAgICApID09ICJDb3VsZCBub3QgZmluZCB0aGUgVExTIGNlcnRpZmljYXRlIGZpbGUsIGludmFsaWQgcGF0aDoge30iLmZvcm1hdCgKICAgICAgICAgICAgSU5WQUxJRF9QQVRICiAgICAgICAgKQoKICAgICAgICB3aXRoIHB5dGVzdC5yYWlzZXMoSU9FcnJvcikgYXMgZToKICAgICAgICAgICAgcmVxdWVzdHMuZ2V0KGh0dHBiaW5fc2VjdXJlKCksIGNlcnQ9KCIuIiwgSU5WQUxJRF9QQVRIKSkKICAgICAgICBhc3NlcnQgc3RyKGUudmFsdWUpID09ICgKICAgICAgICAgICAgZiJDb3VsZCBub3QgZmluZCB0aGUgVExTIGtleSBmaWxlLCBpbnZhbGlkIHBhdGg6IHtJTlZBTElEX1BBVEh9IgogICAgICAgICkKCiAgICBAcHl0ZXN0Lm1hcmsucGFyYW1ldHJpemUoCiAgICAgICAgImVudiwgZXhwZWN0ZWQiLAogICAgICAgICgKICAgICAgICAgICAgKHt9LCBUcnVlKSwKICAgICAgICAgICAgKHsiUkVRVUVTVFNfQ0FfQlVORExFIjogIi9zb21lL3BhdGgifSwgIi9zb21lL3BhdGgiKSwKICAgICAgICAgICAgKHsiUkVRVUVTVFNfQ0FfQlVORExFIjogIiJ9LCBUcnVlKSwKICAgICAgICAgICAgKHsiQ1VSTF9DQV9CVU5ETEUiOiAiL3NvbWUvcGF0aCJ9LCAiL3NvbWUvcGF0aCIpLAogICAgICAgICAgICAoeyJDVVJMX0NBX0JVTkRMRSI6ICIifSwgVHJ1ZSksCiAgICAgICAgICAgICh7IlJFUVVFU1RTX0NBX0JVTkRMRSI6ICIiLCAiQ1VSTF9DQV9CVU5ETEUiOiAiIn0sIFRydWUpLAogICAgICAgICAgICAoCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgIlJFUVVFU1RTX0NBX0JVTkRMRSI6ICIvc29tZS9wYXRoIiwKICAgICAgICAgICAgICAgICAgICAiQ1VSTF9DQV9CVU5ETEUiOiAiL2N1cmwvcGF0aCIsCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgIi9zb21lL3BhdGgiLAogICAgICAgICAgICApLAogICAgICAgICAgICAoCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgIlJFUVVFU1RTX0NBX0JVTkRMRSI6ICIiLAogICAgICAgICAgICAgICAgICAgICJDVVJMX0NBX0JVTkRMRSI6ICIvY3VybC9wYXRoIiwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAiL2N1cmwvcGF0aCIsCiAgICAgICAgICAgICksCiAgICAgICAgKSwKICAgICkKICAgIGRlZiB0ZXN0X2Vudl9jZXJ0X2J1bmRsZXMoc2VsZiwgaHR0cGJpbiwgbW9ja2VyLCBlbnYsIGV4cGVjdGVkKToKICAgICAgICBzID0gcmVxdWVzdHMuU2Vzc2lvbigpCiAgICAgICAgbW9ja2VyLnBhdGNoKCJvcy5lbnZpcm9uIiwgZW52KQogICAgICAgIHNldHRpbmdzID0gcy5tZXJnZV9lbnZpcm9ubWVudF9zZXR0aW5ncygKICAgICAgICAgICAgdXJsPWh0dHBiaW4oImdldCIpLCBwcm94aWVzPXt9LCBzdHJlYW09RmFsc2UsIHZlcmlmeT1UcnVlLCBjZXJ0PU5vbmUKICAgICAgICApCiAgICAgICAgYXNzZXJ0IHNldHRpbmdzWyJ2ZXJpZnkiXSA9PSBleHBlY3RlZAoKICAgIGRlZiB0ZXN0X2h0dHBfd2l0aF9jZXJ0aWZpY2F0ZShzZWxmLCBodHRwYmluKToKICAgICAgICByID0gcmVxdWVzdHMuZ2V0KGh0dHBiaW4oKSwgY2VydD0iLiIpCiAgICAgICAgYXNzZXJ0IHIuc3RhdHVzX2NvZGUgPT0gMjAwCgogICAgZGVmIHRlc3RfaHR0cHNfd2FybmluZ3Moc2VsZiwgbm9zYW5fc2VydmVyKToKICAgICAgICAiIiJ3YXJuaW5ncyBhcmUgZW1pdHRlZCB3aXRoIHJlcXVlc3RzLmdldCIiIgogICAgICAgIGhvc3QsIHBvcnQsIGNhX2J1bmRsZSA9IG5vc2FuX3NlcnZlcgogICAgICAgIGlmIEhBU19NT0RFUk5fU1NMIG9yIEhBU19QWU9QRU5TU0w6CiAgICAgICAgICAgIHdhcm5pbmdzX2V4cGVjdGVkID0gKCJTdWJqZWN0QWx0TmFtZVdhcm5pbmciLCkKICAgICAgICBlbHNlOgogICAgICAgICAgICB3YXJuaW5nc19leHBlY3RlZCA9ICgKICAgICAgICAgICAgICAgICJTTklNaXNzaW5nV2FybmluZyIsCiAgICAgICAgICAgICAgICAiSW5zZWN1cmVQbGF0Zm9ybVdhcm5pbmciLAogICAgICAgICAgICAgICAgIlN1YmplY3RBbHROYW1lV2FybmluZyIsCiAgICAgICAgICAgICkKCiAgICAgICAgd2l0aCBweXRlc3Qud2FybnMoTm9uZSkgYXMgd2FybmluZ19yZWNvcmRzOgogICAgICAgICAgICB3YXJuaW5ncy5zaW1wbGVmaWx0ZXIoImFsd2F5cyIpCiAgICAgICAgICAgIHJlcXVlc3RzLmdldChmImh0dHBzOi8vbG9jYWxob3N0Ontwb3J0fS8iLCB2ZXJpZnk9Y2FfYnVuZGxlKQoKICAgICAgICB3YXJuaW5nX3JlY29yZHMgPSBbCiAgICAgICAgICAgIGl0ZW0KICAgICAgICAgICAgZm9yIGl0ZW0gaW4gd2FybmluZ19yZWNvcmRzCiAgICAgICAgICAgIGlmIGl0ZW0uY2F0ZWdvcnkuX19uYW1lX18gIT0gIlJlc291cmNlV2FybmluZyIKICAgICAgICBdCgogICAgICAgIHdhcm5pbmdzX2NhdGVnb3J5ID0gdHVwbGUoaXRlbS5jYXRlZ29yeS5fX25hbWVfXyBmb3IgaXRlbSBpbiB3YXJuaW5nX3JlY29yZHMpCiAgICAgICAgYXNzZXJ0IHdhcm5pbmdzX2NhdGVnb3J5ID09IHdhcm5pbmdzX2V4cGVjdGVkCgogICAgZGVmIHRlc3RfY2VydGlmaWNhdGVfZmFpbHVyZShzZWxmLCBodHRwYmluX3NlY3VyZSk6CiAgICAgICAgIiIiCiAgICAgICAgV2hlbiB1bmRlcmx5aW5nIFNTTCBwcm9ibGVtcyBvY2N1ciwgYW4gU1NMRXJyb3IgaXMgcmFpc2VkLgogICAgICAgICIiIgogICAgICAgIHdpdGggcHl0ZXN0LnJhaXNlcyhSZXF1ZXN0c1NTTEVycm9yKToKICAgICAgICAgICAgIyBPdXIgbG9jYWwgaHR0cGJpbiBkb2VzIG5vdCBoYXZlIGEgdHJ1c3RlZCBDQSwgc28gdGhpcyBjYWxsIHdpbGwKICAgICAgICAgICAgIyBmYWlsIGlmIHdlIHVzZSBvdXIgZGVmYXVsdCB0cnVzdCBidW5kbGUuCiAgICAgICAgICAgIHJlcXVlc3RzLmdldChodHRwYmluX3NlY3VyZSgic3RhdHVzIiwgIjIwMCIpKQoKICAgIGRlZiB0ZXN0X3VybGVuY29kZWRfZ2V0X3F1ZXJ5X211bHRpdmFsdWVkX3BhcmFtKHNlbGYsIGh0dHBiaW4pOgoKICAgICAgICByID0gcmVxdWVzdHMuZ2V0KGh0dHBiaW4oImdldCIpLCBwYXJhbXM9eyJ0ZXN0IjogWyJmb28iLCAiYmF6Il19KQogICAgICAgIGFzc2VydCByLnN0YXR1c19jb2RlID09IDIwMAogICAgICAgIGFzc2VydCByLnVybCA9PSBodHRwYmluKCJnZXQ/dGVzdD1mb28mdGVzdD1iYXoiKQoKICAgIGRlZiB0ZXN0X2Zvcm1fZW5jb2RlZF9wb3N0X3F1ZXJ5X211bHRpdmFsdWVkX2VsZW1lbnQoc2VsZiwgaHR0cGJpbik6CiAgICAgICAgciA9IHJlcXVlc3RzLlJlcXVlc3QoCiAgICAgICAgICAgIG1ldGhvZD0iUE9TVCIsIHVybD1odHRwYmluKCJwb3N0IiksIGRhdGE9ZGljdCh0ZXN0PVsiZm9vIiwgImJheiJdKQogICAgICAgICkKICAgICAgICBwcmVwID0gci5wcmVwYXJlKCkKICAgICAgICBhc3NlcnQgcHJlcC5ib2R5ID09ICJ0ZXN0PWZvbyZ0ZXN0PWJheiIKCiAgICBkZWYgdGVzdF9kaWZmZXJlbnRfZW5jb2RpbmdzX2RvbnRfYnJlYWtfcG9zdChzZWxmLCBodHRwYmluKToKICAgICAgICB3aXRoIG9wZW4oX19maWxlX18sICJyYiIpIGFzIGY6CiAgICAgICAgICAgIHIgPSByZXF1ZXN0cy5wb3N0KAogICAgICAgICAgICAgICAgaHR0cGJpbigicG9zdCIpLAogICAgICAgICAgICAgICAgZGF0YT17InN0dWZmIjoganNvbi5kdW1wcyh7ImEiOiAxMjN9KX0sCiAgICAgICAgICAgICAgICBwYXJhbXM9eyJibGFoIjogImFzZGYxMjM0In0sCiAgICAgICAgICAgICAgICBmaWxlcz17ImZpbGUiOiAoInRlc3RfcmVxdWVzdHMucHkiLCBmKX0sCiAgICAgICAgICAgICkKICAgICAgICBhc3NlcnQgci5zdGF0dXNfY29kZSA9PSAyMDAKCiAgICBAcHl0ZXN0Lm1hcmsucGFyYW1ldHJpemUoCiAgICAgICAgImRhdGEiLAogICAgICAgICgKICAgICAgICAgICAgeyJzdHVmZiI6ICLDq2zDr3hyIn0sCiAgICAgICAgICAgIHsic3R1ZmYiOiAiw6tsw694ciIuZW5jb2RlKCl9LAogICAgICAgICAgICB7InN0dWZmIjogImVsaXhyIn0sCiAgICAgICAgICAgIHsic3R1ZmYiOiBiImVsaXhyIn0sCiAgICAgICAgKSwKICAgICkKICAgIGRlZiB0ZXN0X3VuaWNvZGVfbXVsdGlwYXJ0X3Bvc3Qoc2VsZiwgaHR0cGJpbiwgZGF0YSk6CiAgICAgICAgd2l0aCBvcGVuKF9fZmlsZV9fLCAicmIiKSBhcyBmOgogICAgICAgICAgICByID0gcmVxdWVzdHMucG9zdCgKICAgICAgICAgICAgICAgIGh0dHBiaW4oInBvc3QiKSwKICAgICAgICAgICAgICAgIGRhdGE9ZGF0YSwKICAgICAgICAgICAgICAgIGZpbGVzPXsiZmlsZSI6ICgidGVzdF9yZXF1ZXN0cy5weSIsIGYpfSwKICAgICAgICAgICAgKQogICAgICAgIGFzc2VydCByLnN0YXR1c19jb2RlID09IDIwMAoKICAgIGRlZiB0ZXN0X3VuaWNvZGVfbXVsdGlwYXJ0X3Bvc3RfZmllbGRuYW1lcyhzZWxmLCBodHRwYmluKToKICAgICAgICBmaWxlbmFtZSA9IG9zLnBhdGguc3BsaXRleHQoX19maWxlX18pWzBdICsgIi5weSIKICAgICAgICB3aXRoIG9wZW4oZmlsZW5hbWUsICJyYiIpIGFzIGY6CiAgICAgICAgICAgIHIgPSByZXF1ZXN0cy5SZXF1ZXN0KAogICAgICAgICAgICAgICAgbWV0aG9kPSJQT1NUIiwKICAgICAgICAgICAgICAgIHVybD1odHRwYmluKCJwb3N0IiksCiAgICAgICAgICAgICAgICBkYXRhPXtiInN0dWZmIjogImVsaXhyIn0sCiAgICAgICAgICAgICAgICBmaWxlcz17ImZpbGUiOiAoInRlc3RfcmVxdWVzdHMucHkiLCBmKX0sCiAgICAgICAgICAgICkKICAgICAgICAgICAgcHJlcCA9IHIucHJlcGFyZSgpCgogICAgICAgIGFzc2VydCBiJ25hbWU9InN0dWZmIicgaW4gcHJlcC5ib2R5CiAgICAgICAgYXNzZXJ0IGIibmFtZT1cImInc3R1ZmYnXCIiIG5vdCBpbiBwcmVwLmJvZHkKCiAgICBkZWYgdGVzdF91bmljb2RlX21ldGhvZF9uYW1lKHNlbGYsIGh0dHBiaW4pOgogICAgICAgIHdpdGggb3BlbihfX2ZpbGVfXywgInJiIikgYXMgZjoKICAgICAgICAgICAgZmlsZXMgPSB7ImZpbGUiOiBmfQogICAgICAgICAgICByID0gcmVxdWVzdHMucmVxdWVzdCgKICAgICAgICAgICAgICAgIG1ldGhvZD0iUE9TVCIsCiAgICAgICAgICAgICAgICB1cmw9aHR0cGJpbigicG9zdCIpLAogICAgICAgICAgICAgICAgZmlsZXM9ZmlsZXMsCiAgICAgICAgICAgICkKICAgICAgICBhc3NlcnQgci5zdGF0dXNfY29kZSA9PSAyMDAKCiAgICBkZWYgdGVzdF91bmljb2RlX21ldGhvZF9uYW1lX3dpdGhfcmVxdWVzdF9vYmplY3Qoc2VsZiwgaHR0cGJpbik6CiAgICAgICAgcyA9IHJlcXVlc3RzLlNlc3Npb24oKQogICAgICAgIHdpdGggb3BlbihfX2ZpbGVfXywgInJiIikgYXMgZjoKICAgICAgICAgICAgZmlsZXMgPSB7ImZpbGUiOiBmfQogICAgICAgICAgICByZXEgPSByZXF1ZXN0cy5SZXF1ZXN0KCJQT1NUIiwgaHR0cGJpbigicG9zdCIpLCBmaWxlcz1maWxlcykKICAgICAgICAgICAgcHJlcCA9IHMucHJlcGFyZV9yZXF1ZXN0KHJlcSkKICAgICAgICBhc3NlcnQgaXNpbnN0YW5jZShwcmVwLm1ldGhvZCwgYnVpbHRpbl9zdHIpCiAgICAgICAgYXNzZXJ0IHByZXAubWV0aG9kID09ICJQT1NUIgoKICAgICAgICByZXNwID0gcy5zZW5kKHByZXApCiAgICAgICAgYXNzZXJ0IHJlc3Auc3RhdHVzX2NvZGUgPT0gMjAwCgogICAgZGVmIHRlc3Rfbm9uX3ByZXBhcmVkX3JlcXVlc3RfZXJyb3Ioc2VsZik6CiAgICAgICAgcyA9IHJlcXVlc3RzLlNlc3Npb24oKQogICAgICAgIHJlcSA9IHJlcXVlc3RzLlJlcXVlc3QoIlBPU1QiLCAiLyIpCgogICAgICAgIHdpdGggcHl0ZXN0LnJhaXNlcyhWYWx1ZUVycm9yKSBhcyBlOgogICAgICAgICAgICBzLnNlbmQocmVxKQogICAgICAgIGFzc2VydCBzdHIoZS52YWx1ZSkgPT0gIllvdSBjYW4gb25seSBzZW5kIFByZXBhcmVkUmVxdWVzdHMuIgoKICAgIGRlZiB0ZXN0X2N1c3RvbV9jb250ZW50X3R5cGUoc2VsZiwgaHR0cGJpbik6CiAgICAgICAgd2l0aCBvcGVuKF9fZmlsZV9fLCAicmIiKSBhcyBmMToKICAgICAgICAgICAgd2l0aCBvcGVuKF9fZmlsZV9fLCAicmIiKSBhcyBmMjoKICAgICAgICAgICAgICAgIGRhdGEgPSB7InN0dWZmIjoganNvbi5kdW1wcyh7ImEiOiAxMjN9KX0KICAgICAgICAgICAgICAgIGZpbGVzID0gewogICAgICAgICAgICAgICAgICAgICJmaWxlMSI6ICgidGVzdF9yZXF1ZXN0cy5weSIsIGYxKSwKICAgICAgICAgICAgICAgICAgICAiZmlsZTIiOiAoInRlc3RfcmVxdWVzdHMiLCBmMiwgInRleHQvcHktY29udGVudC10eXBlIiksCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByID0gcmVxdWVzdHMucG9zdChodHRwYmluKCJwb3N0IiksIGRhdGE9ZGF0YSwgZmlsZXM9ZmlsZXMpCiAgICAgICAgYXNzZXJ0IHIuc3RhdHVzX2NvZGUgPT0gMjAwCiAgICAgICAgYXNzZXJ0IGIidGV4dC9weS1jb250ZW50LXR5cGUiIGluIHIucmVxdWVzdC5ib2R5CgogICAgZGVmIHRlc3RfaG9va19yZWNlaXZlc19yZXF1ZXN0X2FyZ3VtZW50cyhzZWxmLCBodHRwYmluKToKICAgICAgICBkZWYgaG9vayhyZXNwLCAqKmt3YXJncyk6CiAgICAgICAgICAgIGFzc2VydCByZXNwIGlzIG5vdCBOb25lCiAgICAgICAgICAgIGFzc2VydCBrd2FyZ3MgIT0ge30KCiAgICAgICAgcyA9IHJlcXVlc3RzLlNlc3Npb24oKQogICAgICAgIHIgPSByZXF1ZXN0cy5SZXF1ZXN0KCJHRVQiLCBodHRwYmluKCksIGhvb2tzPXsicmVzcG9uc2UiOiBob29rfSkKICAgICAgICBwcmVwID0gcy5wcmVwYXJlX3JlcXVlc3QocikKICAgICAgICBzLnNlbmQocHJlcCkKCiAgICBkZWYgdGVzdF9zZXNzaW9uX2hvb2tzX2FyZV91c2VkX3dpdGhfbm9fcmVxdWVzdF9ob29rcyhzZWxmLCBodHRwYmluKToKICAgICAgICBkZWYgaG9vaygqYXJncywgKiprd2FyZ3MpOgogICAgICAgICAgICBwYXNzCgogICAgICAgIHMgPSByZXF1ZXN0cy5TZXNzaW9uKCkKICAgICAgICBzLmhvb2tzWyJyZXNwb25zZSJdLmFwcGVuZChob29rKQogICAgICAgIHIgPSByZXF1ZXN0cy5SZXF1ZXN0KCJHRVQiLCBodHRwYmluKCkpCiAgICAgICAgcHJlcCA9IHMucHJlcGFyZV9yZXF1ZXN0KHIpCiAgICAgICAgYXNzZXJ0IHByZXAuaG9va3NbInJlc3BvbnNlIl0gIT0gW10KICAgICAgICBhc3NlcnQgcHJlcC5ob29rc1sicmVzcG9uc2UiXSA9PSBbaG9va10KCiAgICBkZWYgdGVzdF9zZXNzaW9uX2hvb2tzX2FyZV9vdmVycmlkZGVuX2J5X3JlcXVlc3RfaG9va3Moc2VsZiwgaHR0cGJpbik6CiAgICAgICAgZGVmIGhvb2sxKCphcmdzLCAqKmt3YXJncyk6CiAgICAgICAgICAgIHBhc3MKCiAgICAgICAgZGVmIGhvb2syKCphcmdzLCAqKmt3YXJncyk6CiAgICAgICAgICAgIHBhc3MKCiAgICAgICAgYXNzZXJ0IGhvb2sxIGlzIG5vdCBob29rMgogICAgICAgIHMgPSByZXF1ZXN0cy5TZXNzaW9uKCkKICAgICAgICBzLmhvb2tzWyJyZXNwb25zZSJdLmFwcGVuZChob29rMikKICAgICAgICByID0gcmVxdWVzdHMuUmVxdWVzdCgiR0VUIiwgaHR0cGJpbigpLCBob29rcz17InJlc3BvbnNlIjogW2hvb2sxXX0pCiAgICAgICAgcHJlcCA9IHMucHJlcGFyZV9yZXF1ZXN0KHIpCiAgICAgICAgYXNzZXJ0IHByZXAuaG9va3NbInJlc3BvbnNlIl0gPT0gW2hvb2sxXQoKICAgIGRlZiB0ZXN0X3ByZXBhcmVkX3JlcXVlc3RfaG9vayhzZWxmLCBodHRwYmluKToKICAgICAgICBkZWYgaG9vayhyZXNwLCAqKmt3YXJncyk6CiAgICAgICAgICAgIHJlc3AuaG9va193b3JraW5nID0gVHJ1ZQogICAgICAgICAgICByZXR1cm4gcmVzcAoKICAgICAgICByZXEgPSByZXF1ZXN0cy5SZXF1ZXN0KCJHRVQiLCBodHRwYmluKCksIGhvb2tzPXsicmVzcG9uc2UiOiBob29rfSkKICAgICAgICBwcmVwID0gcmVxLnByZXBhcmUoKQoKICAgICAgICBzID0gcmVxdWVzdHMuU2Vzc2lvbigpCiAgICAgICAgcy5wcm94aWVzID0gZ2V0cHJveGllcygpCiAgICAgICAgcmVzcCA9IHMuc2VuZChwcmVwKQoKICAgICAgICBhc3NlcnQgaGFzYXR0cihyZXNwLCAiaG9va193b3JraW5nIikKCiAgICBkZWYgdGVzdF9wcmVwYXJlZF9mcm9tX3Nlc3Npb24oc2VsZiwgaHR0cGJpbik6CiAgICAgICAgY2xhc3MgRHVtbXlBdXRoKHJlcXVlc3RzLmF1dGguQXV0aEJhc2UpOgogICAgICAgICAgICBkZWYgX19jYWxsX18oc2VsZiwgcik6CiAgICAgICAgICAgICAgICByLmhlYWRlcnNbIkR1bW15LUF1dGgtVGVzdCJdID0gImR1bW15LWF1dGgtdGVzdC1vayIKICAgICAgICAgICAgICAgIHJldHVybiByCgogICAgICAgIHJlcSA9IHJlcXVlc3RzLlJlcXVlc3QoIkdFVCIsIGh0dHBiaW4oImhlYWRlcnMiKSkKICAgICAgICBhc3NlcnQgbm90IHJlcS5hdXRoCgogICAgICAgIHMgPSByZXF1ZXN0cy5TZXNzaW9uKCkKICAgICAgICBzLmF1dGggPSBEdW1teUF1dGgoKQoKICAgICAgICBwcmVwID0gcy5wcmVwYXJlX3JlcXVlc3QocmVxKQogICAgICAgIHJlc3AgPSBzLnNlbmQocHJlcCkKCiAgICAgICAgYXNzZXJ0IHJlc3AuanNvbigpWyJoZWFkZXJzIl1bIkR1bW15LUF1dGgtVGVzdCJdID09ICJkdW1teS1hdXRoLXRlc3Qtb2siCgogICAgZGVmIHRlc3RfcHJlcGFyZV9yZXF1ZXN0X3dpdGhfYnl0ZXN0cmluZ191cmwoc2VsZik6CiAgICAgICAgcmVxID0gcmVxdWVzdHMuUmVxdWVzdCgiR0VUIiwgYiJodHRwczovL2h0dHBiaW4ub3JnLyIpCiAgICAgICAgcyA9IHJlcXVlc3RzLlNlc3Npb24oKQogICAgICAgIHByZXAgPSBzLnByZXBhcmVfcmVxdWVzdChyZXEpCiAgICAgICAgYXNzZXJ0IHByZXAudXJsID09ICJodHRwczovL2h0dHBiaW4ub3JnLyIKCiAgICBkZWYgdGVzdF9yZXF1ZXN0X3dpdGhfYnl0ZXN0cmluZ19ob3N0KHNlbGYsIGh0dHBiaW4pOgogICAgICAgIHMgPSByZXF1ZXN0cy5TZXNzaW9uKCkKICAgICAgICByZXNwID0gcy5yZXF1ZXN0KAogICAgICAgICAgICAiR0VUIiwKICAgICAgICAgICAgaHR0cGJpbigiY29va2llcy9zZXQ/Y29va2llPXZhbHVlIiksCiAgICAgICAgICAgIGFsbG93X3JlZGlyZWN0cz1GYWxzZSwKICAgICAgICAgICAgaGVhZGVycz17Ikhvc3QiOiBiImh0dHBiaW4ub3JnIn0sCiAgICAgICAgKQogICAgICAgIGFzc2VydCByZXNwLmNvb2tpZXMuZ2V0KCJjb29raWUiKSA9PSAidmFsdWUiCgogICAgZGVmIHRlc3RfbGlua3Moc2VsZik6CiAgICAgICAgciA9IHJlcXVlc3RzLlJlc3BvbnNlKCkKICAgICAgICByLmhlYWRlcnMgPSB7CiAgICAgICAgICAgICJjYWNoZS1jb250cm9sIjogInB1YmxpYywgbWF4LWFnZT02MCwgcy1tYXhhZ2U9NjAiLAogICAgICAgICAgICAiY29ubmVjdGlvbiI6ICJrZWVwLWFsaXZlIiwKICAgICAgICAgICAgImNvbnRlbnQtZW5jb2RpbmciOiAiZ3ppcCIsCiAgICAgICAgICAgICJjb250ZW50LXR5cGUiOiAiYXBwbGljYXRpb24vanNvbjsgY2hhcnNldD11dGYtOCIsCiAgICAgICAgICAgICJkYXRlIjogIlNhdCwgMjYgSmFuIDIwMTMgMTY6NDc6NTYgR01UIiwKICAgICAgICAgICAgImV0YWciOiAnIjZmZjZhNzNjMGU0NDZjMWY2MTYxNDc2OWUzY2ViNzc4IicsCiAgICAgICAgICAgICJsYXN0LW1vZGlmaWVkIjogIlNhdCwgMjYgSmFuIDIwMTMgMTY6MjI6MzkgR01UIiwKICAgICAgICAgICAgImxpbmsiOiAoCiAgICAgICAgICAgICAgICAiPGh0dHBzOi8vYXBpLmdpdGh1Yi5jb20vdXNlcnMva2VubmV0aHJlaXR6L3JlcG9zPyIKICAgICAgICAgICAgICAgICdwYWdlPTImcGVyX3BhZ2U9MTA+OyByZWw9Im5leHQiLCA8aHR0cHM6Ly9hcGkuZ2l0aHViLicKICAgICAgICAgICAgICAgICJjb20vdXNlcnMva2VubmV0aHJlaXR6L3JlcG9zP3BhZ2U9NyZwZXJfcGFnZT0xMD47ICIKICAgICAgICAgICAgICAgICcgcmVsPSJsYXN0IicKICAgICAgICAgICAgKSwKICAgICAgICAgICAgInNlcnZlciI6ICJHaXRIdWIuY29tIiwKICAgICAgICAgICAgInN0YXR1cyI6ICIyMDAgT0siLAogICAgICAgICAgICAidmFyeSI6ICJBY2NlcHQiLAogICAgICAgICAgICAieC1jb250ZW50LXR5cGUtb3B0aW9ucyI6ICJub3NuaWZmIiwKICAgICAgICAgICAgIngtZ2l0aHViLW1lZGlhLXR5cGUiOiAiZ2l0aHViLmJldGEiLAogICAgICAgICAgICAieC1yYXRlbGltaXQtbGltaXQiOiAiNjAiLAogICAgICAgICAgICAieC1yYXRlbGltaXQtcmVtYWluaW5nIjogIjU3IiwKICAgICAgICB9CiAgICAgICAgYXNzZXJ0IHIubGlua3NbIm5leHQiXVsicmVsIl0gPT0gIm5leHQiCgogICAgZGVmIHRlc3RfY29va2llX3BhcmFtZXRlcnMoc2VsZik6CiAgICAgICAga2V5ID0gInNvbWVfY29va2llIgogICAgICAgIHZhbHVlID0gInNvbWVfdmFsdWUiCiAgICAgICAgc2VjdXJlID0gVHJ1ZQogICAgICAgIGRvbWFpbiA9ICJ0ZXN0LmNvbSIKICAgICAgICByZXN0ID0geyJIdHRwT25seSI6IFRydWV9CgogICAgICAgIGphciA9IHJlcXVlc3RzLmNvb2tpZXMuUmVxdWVzdHNDb29raWVKYXIoKQogICAgICAgIGphci5zZXQoa2V5LCB2YWx1ZSwgc2VjdXJlPXNlY3VyZSwgZG9tYWluPWRvbWFpbiwgcmVzdD1yZXN0KQoKICAgICAgICBhc3NlcnQgbGVuKGphcikgPT0gMQogICAgICAgIGFzc2VydCAic29tZV9jb29raWUiIGluIGphcgoKICAgICAgICBjb29raWUgPSBsaXN0KGphcilbMF0KICAgICAgICBhc3NlcnQgY29va2llLnNlY3VyZSA9PSBzZWN1cmUKICAgICAgICBhc3NlcnQgY29va2llLmRvbWFpbiA9PSBkb21haW4KICAgICAgICBhc3NlcnQgY29va2llLl9yZXN0WyJIdHRwT25seSJdID09IHJlc3RbIkh0dHBPbmx5Il0KCiAgICBkZWYgdGVzdF9jb29raWVfYXNfZGljdF9rZWVwc19sZW4oc2VsZik6CiAgICAgICAga2V5ID0gInNvbWVfY29va2llIgogICAgICAgIHZhbHVlID0gInNvbWVfdmFsdWUiCgogICAgICAgIGtleTEgPSAic29tZV9jb29raWUxIgogICAgICAgIHZhbHVlMSA9ICJzb21lX3ZhbHVlMSIKCiAgICAgICAgamFyID0gcmVxdWVzdHMuY29va2llcy5SZXF1ZXN0c0Nvb2tpZUphcigpCiAgICAgICAgamFyLnNldChrZXksIHZhbHVlKQogICAgICAgIGphci5zZXQoa2V5MSwgdmFsdWUxKQoKICAgICAgICBkMSA9IGRpY3QoamFyKQogICAgICAgIGQyID0gZGljdChqYXIuaXRlcml0ZW1zKCkpCiAgICAgICAgZDMgPSBkaWN0KGphci5pdGVtcygpKQoKICAgICAgICBhc3NlcnQgbGVuKGphcikgPT0gMgogICAgICAgIGFzc2VydCBsZW4oZDEpID09IDIKICAgICAgICBhc3NlcnQgbGVuKGQyKSA9PSAyCiAgICAgICAgYXNzZXJ0IGxlbihkMykgPT0gMgoKICAgIGRlZiB0ZXN0X2Nvb2tpZV9hc19kaWN0X2tlZXBzX2l0ZW1zKHNlbGYpOgogICAgICAgIGtleSA9ICJzb21lX2Nvb2tpZSIKICAgICAgICB2YWx1ZSA9ICJzb21lX3ZhbHVlIgoKICAgICAgICBrZXkxID0gInNvbWVfY29va2llMSIKICAgICAgICB2YWx1ZTEgPSAic29tZV92YWx1ZTEiCgogICAgICAgIGphciA9IHJlcXVlc3RzLmNvb2tpZXMuUmVxdWVzdHNDb29raWVKYXIoKQogICAgICAgIGphci5zZXQoa2V5LCB2YWx1ZSkKICAgICAgICBqYXIuc2V0KGtleTEsIHZhbHVlMSkKCiAgICAgICAgZDEgPSBkaWN0KGphcikKICAgICAgICBkMiA9IGRpY3QoamFyLml0ZXJpdGVtcygpKQogICAgICAgIGQzID0gZGljdChqYXIuaXRlbXMoKSkKCiAgICAgICAgYXNzZXJ0IGQxWyJzb21lX2Nvb2tpZSJdID09ICJzb21lX3ZhbHVlIgogICAgICAgIGFzc2VydCBkMlsic29tZV9jb29raWUiXSA9PSAic29tZV92YWx1ZSIKICAgICAgICBhc3NlcnQgZDNbInNvbWVfY29va2llMSJdID09ICJzb21lX3ZhbHVlMSIKCiAgICBkZWYgdGVzdF9jb29raWVfYXNfZGljdF9rZXlzKHNlbGYpOgogICAgICAgIGtleSA9ICJzb21lX2Nvb2tpZSIKICAgICAgICB2YWx1ZSA9ICJzb21lX3ZhbHVlIgoKICAgICAgICBrZXkxID0gInNvbWVfY29va2llMSIKICAgICAgICB2YWx1ZTEgPSAic29tZV92YWx1ZTEiCgogICAgICAgIGphciA9IHJlcXVlc3RzLmNvb2tpZXMuUmVxdWVzdHNDb29raWVKYXIoKQogICAgICAgIGphci5zZXQoa2V5LCB2YWx1ZSkKICAgICAgICBqYXIuc2V0KGtleTEsIHZhbHVlMSkKCiAgICAgICAga2V5cyA9IGphci5rZXlzKCkKICAgICAgICBhc3NlcnQga2V5cyA9PSBsaXN0KGtleXMpCiAgICAgICAgIyBtYWtlIHN1cmUgb25lIGNhbiB1c2Uga2V5cyBtdWx0aXBsZSB0aW1lcwogICAgICAgIGFzc2VydCBsaXN0KGtleXMpID09IGxpc3Qoa2V5cykKCiAgICBkZWYgdGVzdF9jb29raWVfYXNfZGljdF92YWx1ZXMoc2VsZik6CiAgICAgICAga2V5ID0gInNvbWVfY29va2llIgogICAgICAgIHZhbHVlID0gInNvbWVfdmFsdWUiCgogICAgICAgIGtleTEgPSAic29tZV9jb29raWUxIgogICAgICAgIHZhbHVlMSA9ICJzb21lX3ZhbHVlMSIKCiAgICAgICAgamFyID0gcmVxdWVzdHMuY29va2llcy5SZXF1ZXN0c0Nvb2tpZUphcigpCiAgICAgICAgamFyLnNldChrZXksIHZhbHVlKQogICAgICAgIGphci5zZXQoa2V5MSwgdmFsdWUxKQoKICAgICAgICB2YWx1ZXMgPSBqYXIudmFsdWVzKCkKICAgICAgICBhc3NlcnQgdmFsdWVzID09IGxpc3QodmFsdWVzKQogICAgICAgICMgbWFrZSBzdXJlIG9uZSBjYW4gdXNlIHZhbHVlcyBtdWx0aXBsZSB0aW1lcwogICAgICAgIGFzc2VydCBsaXN0KHZhbHVlcykgPT0gbGlzdCh2YWx1ZXMpCgogICAgZGVmIHRlc3RfY29va2llX2FzX2RpY3RfaXRlbXMoc2VsZik6CiAgICAgICAga2V5ID0gInNvbWVfY29va2llIgogICAgICAgIHZhbHVlID0gInNvbWVfdmFsdWUiCgogICAgICAgIGtleTEgPSAic29tZV9jb29raWUxIgogICAgICAgIHZhbHVlMSA9ICJzb21lX3ZhbHVlMSIKCiAgICAgICAgamFyID0gcmVxdWVzdHMuY29va2llcy5SZXF1ZXN0c0Nvb2tpZUphcigpCiAgICAgICAgamFyLnNldChrZXksIHZhbHVlKQogICAgICAgIGphci5zZXQoa2V5MSwgdmFsdWUxKQoKICAgICAgICBpdGVtcyA9IGphci5pdGVtcygpCiAgICAgICAgYXNzZXJ0IGl0ZW1zID09IGxpc3QoaXRlbXMpCiAgICAgICAgIyBtYWtlIHN1cmUgb25lIGNhbiB1c2UgaXRlbXMgbXVsdGlwbGUgdGltZXMKICAgICAgICBhc3NlcnQgbGlzdChpdGVtcykgPT0gbGlzdChpdGVtcykKCiAgICBkZWYgdGVzdF9jb29raWVfZHVwbGljYXRlX25hbWVzX2RpZmZlcmVudF9kb21haW5zKHNlbGYpOgogICAgICAgIGtleSA9ICJzb21lX2Nvb2tpZSIKICAgICAgICB2YWx1ZSA9ICJzb21lX3ZhbHVlIgogICAgICAgIGRvbWFpbjEgPSAidGVzdDEuY29tIgogICAgICAgIGRvbWFpbjIgPSAidGVzdDIuY29tIgoKICAgICAgICBqYXIgPSByZXF1ZXN0cy5jb29raWVzLlJlcXVlc3RzQ29va2llSmFyKCkKICAgICAgICBqYXIuc2V0KGtleSwgdmFsdWUsIGRvbWFpbj1kb21haW4xKQogICAgICAgIGphci5zZXQoa2V5LCB2YWx1ZSwgZG9tYWluPWRvbWFpbjIpCiAgICAgICAgYXNzZXJ0IGtleSBpbiBqYXIKICAgICAgICBpdGVtcyA9IGphci5pdGVtcygpCiAgICAgICAgYXNzZXJ0IGxlbihpdGVtcykgPT0gMgoKICAgICAgICAjIFZlcmlmeSB0aGF0IENvb2tpZUNvbmZsaWN0RXJyb3IgaXMgcmFpc2VkIGlmIGRvbWFpbiBpcyBub3Qgc3BlY2lmaWVkCiAgICAgICAgd2l0aCBweXRlc3QucmFpc2VzKHJlcXVlc3RzLmNvb2tpZXMuQ29va2llQ29uZmxpY3RFcnJvcik6CiAgICAgICAgICAgIGphci5nZXQoa2V5KQoKICAgICAgICAjIFZlcmlmeSB0aGF0IENvb2tpZUNvbmZsaWN0RXJyb3IgaXMgbm90IHJhaXNlZCBpZiBkb21haW4gaXMgc3BlY2lmaWVkCiAgICAgICAgY29va2llID0gamFyLmdldChrZXksIGRvbWFpbj1kb21haW4xKQogICAgICAgIGFzc2VydCBjb29raWUgPT0gdmFsdWUKCiAgICBkZWYgdGVzdF9jb29raWVfZHVwbGljYXRlX25hbWVzX3JhaXNlc19jb29raWVfY29uZmxpY3RfZXJyb3Ioc2VsZik6CiAgICAgICAga2V5ID0gInNvbWVfY29va2llIgogICAgICAgIHZhbHVlID0gInNvbWVfdmFsdWUiCiAgICAgICAgcGF0aCA9ICJzb21lX3BhdGgiCgogICAgICAgIGphciA9IHJlcXVlc3RzLmNvb2tpZXMuUmVxdWVzdHNDb29raWVKYXIoKQogICAgICAgIGphci5zZXQoa2V5LCB2YWx1ZSwgcGF0aD1wYXRoKQogICAgICAgIGphci5zZXQoa2V5LCB2YWx1ZSkKICAgICAgICB3aXRoIHB5dGVzdC5yYWlzZXMocmVxdWVzdHMuY29va2llcy5Db29raWVDb25mbGljdEVycm9yKToKICAgICAgICAgICAgamFyLmdldChrZXkpCgogICAgZGVmIHRlc3RfY29va2llX3BvbGljeV9jb3B5KHNlbGYpOgogICAgICAgIGNsYXNzIE15Q29va2llUG9saWN5KGNvb2tpZWxpYi5EZWZhdWx0Q29va2llUG9saWN5KToKICAgICAgICAgICAgcGFzcwoKICAgICAgICBqYXIgPSByZXF1ZXN0cy5jb29raWVzLlJlcXVlc3RzQ29va2llSmFyKCkKICAgICAgICBqYXIuc2V0X3BvbGljeShNeUNvb2tpZVBvbGljeSgpKQogICAgICAgIGFzc2VydCBpc2luc3RhbmNlKGphci5jb3B5KCkuZ2V0X3BvbGljeSgpLCBNeUNvb2tpZVBvbGljeSkKCiAgICBkZWYgdGVzdF90aW1lX2VsYXBzZWRfYmxhbmsoc2VsZiwgaHR0cGJpbik6CiAgICAgICAgciA9IHJlcXVlc3RzLmdldChodHRwYmluKCJnZXQiKSkKICAgICAgICB0ZCA9IHIuZWxhcHNlZAogICAgICAgIHRvdGFsX3NlY29uZHMgPSAoCiAgICAgICAgICAgIHRkLm1pY3Jvc2Vjb25kcyArICh0ZC5zZWNvbmRzICsgdGQuZGF5cyAqIDI0ICogMzYwMCkgKiAxMCoqNgogICAgICAgICkgLyAxMCoqNgogICAgICAgIGFzc2VydCB0b3RhbF9zZWNvbmRzID4gMC4wCgogICAgZGVmIHRlc3RfZW1wdHlfcmVzcG9uc2VfaGFzX2NvbnRlbnRfbm9uZShzZWxmKToKICAgICAgICByID0gcmVxdWVzdHMuUmVzcG9uc2UoKQogICAgICAgIGFzc2VydCByLmNvbnRlbnQgaXMgTm9uZQoKICAgIGRlZiB0ZXN0X3Jlc3BvbnNlX2lzX2l0ZXJhYmxlKHNlbGYpOgogICAgICAgIHIgPSByZXF1ZXN0cy5SZXNwb25zZSgpCiAgICAgICAgaW8gPSBTdHJpbmdJTy5TdHJpbmdJTygiYWJjIikKICAgICAgICByZWFkXyA9IGlvLnJlYWQKCiAgICAgICAgZGVmIHJlYWRfbW9jayhhbXQsIGRlY29kZV9jb250ZW50PU5vbmUpOgogICAgICAgICAgICByZXR1cm4gcmVhZF8oYW10KQoKICAgICAgICBzZXRhdHRyKGlvLCAicmVhZCIsIHJlYWRfbW9jaykKICAgICAgICByLnJhdyA9IGlvCiAgICAgICAgYXNzZXJ0IG5leHQoaXRlcihyKSkKICAgICAgICBpby5jbG9zZSgpCgogICAgZGVmIHRlc3RfcmVzcG9uc2VfZGVjb2RlX3VuaWNvZGUoc2VsZik6CiAgICAgICAgIiIiV2hlbiBjYWxsZWQgd2l0aCBkZWNvZGVfdW5pY29kZSwgUmVzcG9uc2UuaXRlcl9jb250ZW50IHNob3VsZCBhbHdheXMKICAgICAgICByZXR1cm4gdW5pY29kZS4KICAgICAgICAiIiIKICAgICAgICByID0gcmVxdWVzdHMuUmVzcG9uc2UoKQogICAgICAgIHIuX2NvbnRlbnRfY29uc3VtZWQgPSBUcnVlCiAgICAgICAgci5fY29udGVudCA9IGIidGhlIGNvbnRlbnQiCiAgICAgICAgci5lbmNvZGluZyA9ICJhc2NpaSIKCiAgICAgICAgY2h1bmtzID0gci5pdGVyX2NvbnRlbnQoZGVjb2RlX3VuaWNvZGU9VHJ1ZSkKICAgICAgICBhc3NlcnQgYWxsKGlzaW5zdGFuY2UoY2h1bmssIHN0cikgZm9yIGNodW5rIGluIGNodW5rcykKCiAgICAgICAgIyBhbHNvIGZvciBzdHJlYW1pbmcKICAgICAgICByID0gcmVxdWVzdHMuUmVzcG9uc2UoKQogICAgICAgIHIucmF3ID0gaW8uQnl0ZXNJTyhiInRoZSBjb250ZW50IikKICAgICAgICByLmVuY29kaW5nID0gImFzY2lpIgogICAgICAgIGNodW5rcyA9IHIuaXRlcl9jb250ZW50KGRlY29kZV91bmljb2RlPVRydWUpCiAgICAgICAgYXNzZXJ0IGFsbChpc2luc3RhbmNlKGNodW5rLCBzdHIpIGZvciBjaHVuayBpbiBjaHVua3MpCgogICAgZGVmIHRlc3RfcmVzcG9uc2VfcmVhc29uX3VuaWNvZGUoc2VsZik6CiAgICAgICAgIyBjaGVjayBmb3IgdW5pY29kZSBIVFRQIHN0YXR1cwogICAgICAgIHIgPSByZXF1ZXN0cy5SZXNwb25zZSgpCiAgICAgICAgci51cmwgPSAidW5pY29kZSBVUkwiCiAgICAgICAgci5yZWFzb24gPSAiS29tcG9uZW50dGlhIGVpIGzDtnlkeSIuZW5jb2RlKCkKICAgICAgICByLnN0YXR1c19jb2RlID0gNDA0CiAgICAgICAgci5lbmNvZGluZyA9IE5vbmUKICAgICAgICBhc3NlcnQgbm90IHIub2sgICMgb2xkIGJlaGF2aW91ciAtIGNyYXNoZXMgaGVyZQoKICAgIGRlZiB0ZXN0X3Jlc3BvbnNlX3JlYXNvbl91bmljb2RlX2ZhbGxiYWNrKHNlbGYpOgogICAgICAgICMgY2hlY2sgcmFpc2Vfc3RhdHVzIGZhbGxzIGJhY2sgdG8gSVNPLTg4NTktMQogICAgICAgIHIgPSByZXF1ZXN0cy5SZXNwb25zZSgpCiAgICAgICAgci51cmwgPSAic29tZSB1cmwiCiAgICAgICAgcmVhc29uID0gIktvbXBvbmVudHRpYSBlaSBsw7Z5ZHkiCiAgICAgICAgci5yZWFzb24gPSByZWFzb24uZW5jb2RlKCJsYXRpbi0xIikKICAgICAgICByLnN0YXR1c19jb2RlID0gNTAwCiAgICAgICAgci5lbmNvZGluZyA9IE5vbmUKICAgICAgICB3aXRoIHB5dGVzdC5yYWlzZXMocmVxdWVzdHMuZXhjZXB0aW9ucy5IVFRQRXJyb3IpIGFzIGU6CiAgICAgICAgICAgIHIucmFpc2VfZm9yX3N0YXR1cygpCiAgICAgICAgYXNzZXJ0IHJlYXNvbiBpbiBlLnZhbHVlLmFyZ3NbMF0KCiAgICBkZWYgdGVzdF9yZXNwb25zZV9jaHVua19zaXplX3R5cGUoc2VsZik6CiAgICAgICAgIiIiRW5zdXJlIHRoYXQgY2h1bmtfc2l6ZSBpcyBwYXNzZWQgYXMgTm9uZSBvciBhbiBpbnRlZ2VyLCBvdGhlcndpc2UKICAgICAgICByYWlzZSBhIFR5cGVFcnJvci4KICAgICAgICAiIiIKICAgICAgICByID0gcmVxdWVzdHMuUmVzcG9uc2UoKQogICAgICAgIHIucmF3ID0gaW8uQnl0ZXNJTyhiInRoZSBjb250ZW50IikKICAgICAgICBjaHVua3MgPSByLml0ZXJfY29udGVudCgxKQogICAgICAgIGFzc2VydCBhbGwobGVuKGNodW5rKSA9PSAxIGZvciBjaHVuayBpbiBjaHVua3MpCgogICAgICAgIHIgPSByZXF1ZXN0cy5SZXNwb25zZSgpCiAgICAgICAgci5yYXcgPSBpby5CeXRlc0lPKGIidGhlIGNvbnRlbnQiKQogICAgICAgIGNodW5rcyA9IHIuaXRlcl9jb250ZW50KE5vbmUpCiAgICAgICAgYXNzZXJ0IGxpc3QoY2h1bmtzKSA9PSBbYiJ0aGUgY29udGVudCJdCgogICAgICAgIHIgPSByZXF1ZXN0cy5SZXNwb25zZSgpCiAgICAgICAgci5yYXcgPSBpby5CeXRlc0lPKGIidGhlIGNvbnRlbnQiKQogICAgICAgIHdpdGggcHl0ZXN0LnJhaXNlcyhUeXBlRXJyb3IpOgogICAgICAgICAgICBjaHVua3MgPSByLml0ZXJfY29udGVudCgiMTAyNCIpCgogICAgQHB5dGVzdC5tYXJrLnBhcmFtZXRyaXplKAogICAgICAgICJleGNlcHRpb24sIGFyZ3MsIGV4cGVjdGVkIiwKICAgICAgICAoCiAgICAgICAgICAgICh1cmxsaWIzLmV4Y2VwdGlvbnMuUHJvdG9jb2xFcnJvciwgdHVwbGUoKSwgQ2h1bmtlZEVuY29kaW5nRXJyb3IpLAogICAgICAgICAgICAodXJsbGliMy5leGNlcHRpb25zLkRlY29kZUVycm9yLCB0dXBsZSgpLCBDb250ZW50RGVjb2RpbmdFcnJvciksCiAgICAgICAgICAgICh1cmxsaWIzLmV4Y2VwdGlvbnMuUmVhZFRpbWVvdXRFcnJvciwgKE5vbmUsICIiLCAiIiksIENvbm5lY3Rpb25FcnJvciksCiAgICAgICAgICAgICh1cmxsaWIzLmV4Y2VwdGlvbnMuU1NMRXJyb3IsIHR1cGxlKCksIFJlcXVlc3RzU1NMRXJyb3IpLAogICAgICAgICksCiAgICApCiAgICBkZWYgdGVzdF9pdGVyX2NvbnRlbnRfd3JhcHNfZXhjZXB0aW9ucygKICAgICAgICBzZWxmLCBodHRwYmluLCBtb2NrZXIsIGV4Y2VwdGlvbiwgYXJncywgZXhwZWN0ZWQKICAgICk6CiAgICAgICAgciA9IHJlcXVlc3RzLlJlc3BvbnNlKCkKICAgICAgICByLnJhdyA9IG1vY2tlci5Nb2NrKCkKICAgICAgICAjIFJlYWRUaW1lb3V0RXJyb3IgY2FuJ3QgYmUgaW5pdGlhbGl6ZWQgYnkgbW9jawogICAgICAgICMgc28gd2UnbGwgbWFudWFsbHkgY3JlYXRlIHRoZSBpbnN0YW5jZSB3aXRoIGFyZ3MKICAgICAgICByLnJhdy5zdHJlYW0uc2lkZV9lZmZlY3QgPSBleGNlcHRpb24oKmFyZ3MpCgogICAgICAgIHdpdGggcHl0ZXN0LnJhaXNlcyhleHBlY3RlZCk6CiAgICAgICAgICAgIG5leHQoci5pdGVyX2NvbnRlbnQoMTAyNCkpCgogICAgZGVmIHRlc3RfcmVxdWVzdF9hbmRfcmVzcG9uc2VfYXJlX3BpY2tsZWFibGUoc2VsZiwgaHR0cGJpbik6CiAgICAgICAgciA9IHJlcXVlc3RzLmdldChodHRwYmluKCJnZXQiKSkKCiAgICAgICAgIyB2ZXJpZnkgd2UgY2FuIHBpY2tsZSB0aGUgb3JpZ2luYWwgcmVxdWVzdAogICAgICAgIGFzc2VydCBwaWNrbGUubG9hZHMocGlja2xlLmR1bXBzKHIucmVxdWVzdCkpCgogICAgICAgICMgdmVyaWZ5IHdlIGNhbiBwaWNrbGUgdGhlIHJlc3BvbnNlIGFuZCB0aGF0IHdlIGhhdmUgYWNjZXNzIHRvCiAgICAgICAgIyB0aGUgb3JpZ2luYWwgcmVxdWVzdC4KICAgICAgICBwciA9IHBpY2tsZS5sb2FkcyhwaWNrbGUuZHVtcHMocikpCiAgICAgICAgYXNzZXJ0IHIucmVxdWVzdC51cmwgPT0gcHIucmVxdWVzdC51cmwKICAgICAgICBhc3NlcnQgci5yZXF1ZXN0LmhlYWRlcnMgPT0gcHIucmVxdWVzdC5oZWFkZXJzCgogICAgZGVmIHRlc3RfcHJlcGFyZWRfcmVxdWVzdF9pc19waWNrbGVhYmxlKHNlbGYsIGh0dHBiaW4pOgogICAgICAgIHAgPSByZXF1ZXN0cy5SZXF1ZXN0KCJHRVQiLCBodHRwYmluKCJnZXQiKSkucHJlcGFyZSgpCgogICAgICAgICMgVmVyaWZ5IFByZXBhcmVkUmVxdWVzdCBjYW4gYmUgcGlja2xlZCBhbmQgdW5waWNrbGVkCiAgICAgICAgciA9IHBpY2tsZS5sb2FkcyhwaWNrbGUuZHVtcHMocCkpCiAgICAgICAgYXNzZXJ0IHIudXJsID09IHAudXJsCiAgICAgICAgYXNzZXJ0IHIuaGVhZGVycyA9PSBwLmhlYWRlcnMKICAgICAgICBhc3NlcnQgci5ib2R5ID09IHAuYm9keQoKICAgICAgICAjIFZlcmlmeSB1bnBpY2tsZWQgUHJlcGFyZWRSZXF1ZXN0IHNlbmRzIHByb3Blcmx5CiAgICAgICAgcyA9IHJlcXVlc3RzLlNlc3Npb24oKQogICAgICAgIHJlc3AgPSBzLnNlbmQocikKICAgICAgICBhc3NlcnQgcmVzcC5zdGF0dXNfY29kZSA9PSAyMDAKCiAgICBkZWYgdGVzdF9wcmVwYXJlZF9yZXF1ZXN0X3dpdGhfZmlsZV9pc19waWNrbGVhYmxlKHNlbGYsIGh0dHBiaW4pOgogICAgICAgIHdpdGggb3BlbihfX2ZpbGVfXywgInJiIikgYXMgZjoKICAgICAgICAgICAgciA9IHJlcXVlc3RzLlJlcXVlc3QoIlBPU1QiLCBodHRwYmluKCJwb3N0IiksIGZpbGVzPXsiZmlsZSI6IGZ9KQogICAgICAgICAgICBwID0gci5wcmVwYXJlKCkKCiAgICAgICAgIyBWZXJpZnkgUHJlcGFyZWRSZXF1ZXN0IGNhbiBiZSBwaWNrbGVkIGFuZCB1bnBpY2tsZWQKICAgICAgICByID0gcGlja2xlLmxvYWRzKHBpY2tsZS5kdW1wcyhwKSkKICAgICAgICBhc3NlcnQgci51cmwgPT0gcC51cmwKICAgICAgICBhc3NlcnQgci5oZWFkZXJzID09IHAuaGVhZGVycwogICAgICAgIGFzc2VydCByLmJvZHkgPT0gcC5ib2R5CgogICAgICAgICMgVmVyaWZ5IHVucGlja2xlZCBQcmVwYXJlZFJlcXVlc3Qgc2VuZHMgcHJvcGVybHkKICAgICAgICBzID0gcmVxdWVzdHMuU2Vzc2lvbigpCiAgICAgICAgcmVzcCA9IHMuc2VuZChyKQogICAgICAgIGFzc2VydCByZXNwLnN0YXR1c19jb2RlID09IDIwMAoKICAgIGRlZiB0ZXN0X3ByZXBhcmVkX3JlcXVlc3Rfd2l0aF9ob29rX2lzX3BpY2tsZWFibGUoc2VsZiwgaHR0cGJpbik6CiAgICAgICAgciA9IHJlcXVlc3RzLlJlcXVlc3QoIkdFVCIsIGh0dHBiaW4oImdldCIpLCBob29rcz1kZWZhdWx0X2hvb2tzKCkpCiAgICAgICAgcCA9IHIucHJlcGFyZSgpCgogICAgICAgICMgVmVyaWZ5IFByZXBhcmVkUmVxdWVzdCBjYW4gYmUgcGlja2xlZAogICAgICAgIHIgPSBwaWNrbGUubG9hZHMocGlja2xlLmR1bXBzKHApKQogICAgICAgIGFzc2VydCByLnVybCA9PSBwLnVybAogICAgICAgIGFzc2VydCByLmhlYWRlcnMgPT0gcC5oZWFkZXJzCiAgICAgICAgYXNzZXJ0IHIuYm9keSA9PSBwLmJvZHkKICAgICAgICBhc3NlcnQgci5ob29rcyA9PSBwLmhvb2tzCgogICAgICAgICMgVmVyaWZ5IHVucGlja2xlZCBQcmVwYXJlZFJlcXVlc3Qgc2VuZHMgcHJvcGVybHkKICAgICAgICBzID0gcmVxdWVzdHMuU2Vzc2lvbigpCiAgICAgICAgcmVzcCA9IHMuc2VuZChyKQogICAgICAgIGFzc2VydCByZXNwLnN0YXR1c19jb2RlID09IDIwMAoKICAgIGRlZiB0ZXN0X2Nhbm5vdF9zZW5kX3VucHJlcGFyZWRfcmVxdWVzdHMoc2VsZiwgaHR0cGJpbik6CiAgICAgICAgciA9IHJlcXVlc3RzLlJlcXVlc3QodXJsPWh0dHBiaW4oKSkKICAgICAgICB3aXRoIHB5dGVzdC5yYWlzZXMoVmFsdWVFcnJvcik6CiAgICAgICAgICAgIHJlcXVlc3RzLlNlc3Npb24oKS5zZW5kKHIpCgogICAgZGVmIHRlc3RfaHR0cF9lcnJvcihzZWxmKToKICAgICAgICBlcnJvciA9IHJlcXVlc3RzLmV4Y2VwdGlvbnMuSFRUUEVycm9yKCkKICAgICAgICBhc3NlcnQgbm90IGVycm9yLnJlc3BvbnNlCiAgICAgICAgcmVzcG9uc2UgPSByZXF1ZXN0cy5SZXNwb25zZSgpCiAgICAgICAgZXJyb3IgPSByZXF1ZXN0cy5leGNlcHRpb25zLkhUVFBFcnJvcihyZXNwb25zZT1yZXNwb25zZSkKICAgICAgICBhc3NlcnQgZXJyb3IucmVzcG9uc2UgPT0gcmVzcG9uc2UKICAgICAgICBlcnJvciA9IHJlcXVlc3RzLmV4Y2VwdGlvbnMuSFRUUEVycm9yKCJtZXNzYWdlIiwgcmVzcG9uc2U9cmVzcG9uc2UpCiAgICAgICAgYXNzZXJ0IHN0cihlcnJvcikgPT0gIm1lc3NhZ2UiCiAgICAgICAgYXNzZXJ0IGVycm9yLnJlc3BvbnNlID09IHJlc3BvbnNlCgogICAgZGVmIHRlc3Rfc2Vzc2lvbl9waWNrbGluZyhzZWxmLCBodHRwYmluKToKICAgICAgICByID0gcmVxdWVzdHMuUmVxdWVzdCgiR0VUIiwgaHR0cGJpbigiZ2V0IikpCiAgICAgICAgcyA9IHJlcXVlc3RzLlNlc3Npb24oKQoKICAgICAgICBzID0gcGlja2xlLmxvYWRzKHBpY2tsZS5kdW1wcyhzKSkKICAgICAgICBzLnByb3hpZXMgPSBnZXRwcm94aWVzKCkKCiAgICAgICAgciA9IHMuc2VuZChyLnByZXBhcmUoKSkKICAgICAgICBhc3NlcnQgci5zdGF0dXNfY29kZSA9PSAyMDAKCiAgICBkZWYgdGVzdF9maXhlc18xMzI5KHNlbGYsIGh0dHBiaW4pOgogICAgICAgICIiIkVuc3VyZSB0aGF0IGhlYWRlciB1cGRhdGVzIGFyZSBkb25lIGNhc2UtaW5zZW5zaXRpdmVseS4iIiIKICAgICAgICBzID0gcmVxdWVzdHMuU2Vzc2lvbigpCiAgICAgICAgcy5oZWFkZXJzLnVwZGF0ZSh7IkFDQ0VQVCI6ICJCT0dVUyJ9KQogICAgICAgIHMuaGVhZGVycy51cGRhdGUoeyJhY2NlcHQiOiAiYXBwbGljYXRpb24vanNvbiJ9KQogICAgICAgIHIgPSBzLmdldChodHRwYmluKCJnZXQiKSkKICAgICAgICBoZWFkZXJzID0gci5yZXF1ZXN0LmhlYWRlcnMKICAgICAgICBhc3NlcnQgaGVhZGVyc1siYWNjZXB0Il0gPT0gImFwcGxpY2F0aW9uL2pzb24iCiAgICAgICAgYXNzZXJ0IGhlYWRlcnNbIkFjY2VwdCJdID09ICJhcHBsaWNhdGlvbi9qc29uIgogICAgICAgIGFzc2VydCBoZWFkZXJzWyJBQ0NFUFQiXSA9PSAiYXBwbGljYXRpb24vanNvbiIKCiAgICBkZWYgdGVzdF91cHBlcmNhc2Vfc2NoZW1lX3JlZGlyZWN0KHNlbGYsIGh0dHBiaW4pOgogICAgICAgIHBhcnRzID0gdXJscGFyc2UoaHR0cGJpbigiaHRtbCIpKQogICAgICAgIHVybCA9ICJIVFRQOi8vIiArIHBhcnRzLm5ldGxvYyArIHBhcnRzLnBhdGgKICAgICAgICByID0gcmVxdWVzdHMuZ2V0KGh0dHBiaW4oInJlZGlyZWN0LXRvIiksIHBhcmFtcz17InVybCI6IHVybH0pCiAgICAgICAgYXNzZXJ0IHIuc3RhdHVzX2NvZGUgPT0gMjAwCiAgICAgICAgYXNzZXJ0IHIudXJsLmxvd2VyKCkgPT0gdXJsLmxvd2VyKCkKCiAgICBkZWYgdGVzdF90cmFuc3BvcnRfYWRhcHRlcl9vcmRlcmluZyhzZWxmKToKICAgICAgICBzID0gcmVxdWVzdHMuU2Vzc2lvbigpCiAgICAgICAgb3JkZXIgPSBbImh0dHBzOi8vIiwgImh0dHA6Ly8iXQogICAgICAgIGFzc2VydCBvcmRlciA9PSBsaXN0KHMuYWRhcHRlcnMpCiAgICAgICAgcy5tb3VudCgiaHR0cDovL2dpdCIsIEhUVFBBZGFwdGVyKCkpCiAgICAgICAgcy5tb3VudCgiaHR0cDovL2dpdGh1YiIsIEhUVFBBZGFwdGVyKCkpCiAgICAgICAgcy5tb3VudCgiaHR0cDovL2dpdGh1Yi5jb20iLCBIVFRQQWRhcHRlcigpKQogICAgICAgIHMubW91bnQoImh0dHA6Ly9naXRodWIuY29tL2Fib3V0LyIsIEhUVFBBZGFwdGVyKCkpCiAgICAgICAgb3JkZXIgPSBbCiAgICAgICAgICAgICJodHRwOi8vZ2l0aHViLmNvbS9hYm91dC8iLAogICAgICAgICAgICAiaHR0cDovL2dpdGh1Yi5jb20iLAogICAgICAgICAgICAiaHR0cDovL2dpdGh1YiIsCiAgICAgICAgICAgICJodHRwOi8vZ2l0IiwKICAgICAgICAgICAgImh0dHBzOi8vIiwKICAgICAgICAgICAgImh0dHA6Ly8iLAogICAgICAgIF0KICAgICAgICBhc3NlcnQgb3JkZXIgPT0gbGlzdChzLmFkYXB0ZXJzKQogICAgICAgIHMubW91bnQoImh0dHA6Ly9naXR0aXAiLCBIVFRQQWRhcHRlcigpKQogICAgICAgIHMubW91bnQoImh0dHA6Ly9naXR0aXAuY29tIiwgSFRUUEFkYXB0ZXIoKSkKICAgICAgICBzLm1vdW50KCJodHRwOi8vZ2l0dGlwLmNvbS9hYm91dC8iLCBIVFRQQWRhcHRlcigpKQogICAgICAgIG9yZGVyID0gWwogICAgICAgICAgICAiaHR0cDovL2dpdGh1Yi5jb20vYWJvdXQvIiwKICAgICAgICAgICAgImh0dHA6Ly9naXR0aXAuY29tL2Fib3V0LyIsCiAgICAgICAgICAgICJodHRwOi8vZ2l0aHViLmNvbSIsCiAgICAgICAgICAgICJodHRwOi8vZ2l0dGlwLmNvbSIsCiAgICAgICAgICAgICJodHRwOi8vZ2l0aHViIiwKICAgICAgICAgICAgImh0dHA6Ly9naXR0aXAiLAogICAgICAgICAgICAiaHR0cDovL2dpdCIsCiAgICAgICAgICAgICJodHRwczovLyIsCiAgICAgICAgICAgICJodHRwOi8vIiwKICAgICAgICBdCiAgICAgICAgYXNzZXJ0IG9yZGVyID09IGxpc3Qocy5hZGFwdGVycykKICAgICAgICBzMiA9IHJlcXVlc3RzLlNlc3Npb24oKQogICAgICAgIHMyLmFkYXB0ZXJzID0geyJodHRwOi8vIjogSFRUUEFkYXB0ZXIoKX0KICAgICAgICBzMi5tb3VudCgiaHR0cHM6Ly8iLCBIVFRQQWRhcHRlcigpKQogICAgICAgIGFzc2VydCAiaHR0cDovLyIgaW4gczIuYWRhcHRlcnMKICAgICAgICBhc3NlcnQgImh0dHBzOi8vIiBpbiBzMi5hZGFwdGVycwoKICAgIGRlZiB0ZXN0X3Nlc3Npb25fZ2V0X2FkYXB0ZXJfcHJlZml4X21hdGNoaW5nKHNlbGYpOgogICAgICAgIHByZWZpeCA9ICJodHRwczovL2V4YW1wbGUuY29tIgogICAgICAgIG1vcmVfc3BlY2lmaWNfcHJlZml4ID0gcHJlZml4ICsgIi9zb21lL3BhdGgiCgogICAgICAgIHVybF9tYXRjaGluZ19vbmx5X3ByZWZpeCA9IHByZWZpeCArICIvYW5vdGhlci9wYXRoIgogICAgICAgIHVybF9tYXRjaGluZ19tb3JlX3NwZWNpZmljX3ByZWZpeCA9IG1vcmVfc3BlY2lmaWNfcHJlZml4ICsgIi9sb25nZXIvcGF0aCIKICAgICAgICB1cmxfbm90X21hdGNoaW5nX3ByZWZpeCA9ICJodHRwczovL2Fub3RoZXIuZXhhbXBsZS5jb20vIgoKICAgICAgICBzID0gcmVxdWVzdHMuU2Vzc2lvbigpCiAgICAgICAgcHJlZml4X2FkYXB0ZXIgPSBIVFRQQWRhcHRlcigpCiAgICAgICAgbW9yZV9zcGVjaWZpY19wcmVmaXhfYWRhcHRlciA9IEhUVFBBZGFwdGVyKCkKICAgICAgICBzLm1vdW50KHByZWZpeCwgcHJlZml4X2FkYXB0ZXIpCiAgICAgICAgcy5tb3VudChtb3JlX3NwZWNpZmljX3ByZWZpeCwgbW9yZV9zcGVjaWZpY19wcmVmaXhfYWRhcHRlcikKCiAgICAgICAgYXNzZXJ0IHMuZ2V0X2FkYXB0ZXIodXJsX21hdGNoaW5nX29ubHlfcHJlZml4KSBpcyBwcmVmaXhfYWRhcHRlcgogICAgICAgIGFzc2VydCAoCiAgICAgICAgICAgIHMuZ2V0X2FkYXB0ZXIodXJsX21hdGNoaW5nX21vcmVfc3BlY2lmaWNfcHJlZml4KQogICAgICAgICAgICBpcyBtb3JlX3NwZWNpZmljX3ByZWZpeF9hZGFwdGVyCiAgICAgICAgKQogICAgICAgIGFzc2VydCBzLmdldF9hZGFwdGVyKHVybF9ub3RfbWF0Y2hpbmdfcHJlZml4KSBub3QgaW4gKAogICAgICAgICAgICBwcmVmaXhfYWRhcHRlciwKICAgICAgICAgICAgbW9yZV9zcGVjaWZpY19wcmVmaXhfYWRhcHRlciwKICAgICAgICApCgogICAgZGVmIHRlc3Rfc2Vzc2lvbl9nZXRfYWRhcHRlcl9wcmVmaXhfbWF0Y2hpbmdfbWl4ZWRfY2FzZShzZWxmKToKICAgICAgICBtaXhlZF9jYXNlX3ByZWZpeCA9ICJoVHRQczovL2VYYW1QbGUuQ29NL01peEVkX0NBc2VfUFJFZml4IgogICAgICAgIHVybF9tYXRjaGluZ19wcmVmaXggPSBtaXhlZF9jYXNlX3ByZWZpeCArICIvZnVsbF91cmwiCgogICAgICAgIHMgPSByZXF1ZXN0cy5TZXNzaW9uKCkKICAgICAgICBteV9hZGFwdGVyID0gSFRUUEFkYXB0ZXIoKQogICAgICAgIHMubW91bnQobWl4ZWRfY2FzZV9wcmVmaXgsIG15X2FkYXB0ZXIpCgogICAgICAgIGFzc2VydCBzLmdldF9hZGFwdGVyKHVybF9tYXRjaGluZ19wcmVmaXgpIGlzIG15X2FkYXB0ZXIKCiAgICBkZWYgdGVzdF9zZXNzaW9uX2dldF9hZGFwdGVyX3ByZWZpeF9tYXRjaGluZ19pc19jYXNlX2luc2Vuc2l0aXZlKHNlbGYpOgogICAgICAgIG1peGVkX2Nhc2VfcHJlZml4ID0gImhUdFBzOi8vZVhhbVBsZS5Db00vTWl4RWRfQ0FzZV9QUkVmaXgiCiAgICAgICAgdXJsX21hdGNoaW5nX3ByZWZpeF93aXRoX2RpZmZlcmVudF9jYXNlID0gKAogICAgICAgICAgICAiSHRUcFM6Ly9leGFNUExlLmNPbS9NaVhlRF9jYVNFX3ByZUZJWC9hbm90aGVyX3VybCIKICAgICAgICApCgogICAgICAgIHMgPSByZXF1ZXN0cy5TZXNzaW9uKCkKICAgICAgICBteV9hZGFwdGVyID0gSFRUUEFkYXB0ZXIoKQogICAgICAgIHMubW91bnQobWl4ZWRfY2FzZV9wcmVmaXgsIG15X2FkYXB0ZXIpCgogICAgICAgIGFzc2VydCBzLmdldF9hZGFwdGVyKHVybF9tYXRjaGluZ19wcmVmaXhfd2l0aF9kaWZmZXJlbnRfY2FzZSkgaXMgbXlfYWRhcHRlcgoKICAgIGRlZiB0ZXN0X2hlYWRlcl9yZW1vdmVfaXNfY2FzZV9pbnNlbnNpdGl2ZShzZWxmLCBodHRwYmluKToKICAgICAgICAjIEZyb20gaXNzdWUgIzEzMjEKICAgICAgICBzID0gcmVxdWVzdHMuU2Vzc2lvbigpCiAgICAgICAgcy5oZWFkZXJzWyJmb28iXSA9ICJiYXIiCiAgICAgICAgciA9IHMuZ2V0KGh0dHBiaW4oImdldCIpLCBoZWFkZXJzPXsiRk9PIjogTm9uZX0pCiAgICAgICAgYXNzZXJ0ICJmb28iIG5vdCBpbiByLnJlcXVlc3QuaGVhZGVycwoKICAgIGRlZiB0ZXN0X3BhcmFtc19hcmVfbWVyZ2VkX2Nhc2Vfc2Vuc2l0aXZlKHNlbGYsIGh0dHBiaW4pOgogICAgICAgIHMgPSByZXF1ZXN0cy5TZXNzaW9uKCkKICAgICAgICBzLnBhcmFtc1siZm9vIl0gPSAiYmFyIgogICAgICAgIHIgPSBzLmdldChodHRwYmluKCJnZXQiKSwgcGFyYW1zPXsiRk9PIjogImJhciJ9KQogICAgICAgIGFzc2VydCByLmpzb24oKVsiYXJncyJdID09IHsiZm9vIjogImJhciIsICJGT08iOiAiYmFyIn0KCiAgICBkZWYgdGVzdF9sb25nX2F1dGhpbmZvX2luX3VybChzZWxmKToKICAgICAgICB1cmwgPSAiaHR0cDovL3t9Ont9QHt9OjkwMDAvcGF0aD9xdWVyeSNmcmFnIi5mb3JtYXQoCiAgICAgICAgICAgICJFOEEzQkU4Ny05RTNGLTQ2MjAtODg1OC05NTQ3OEUzODVCNUIiLAogICAgICAgICAgICAiRUE3NzAwMzItREE0RC00RDg0LThDRTktMjlDNkQ5MTBCRjFFIiwKICAgICAgICAgICAgImV4YWN0bHktLS0tLS0tLS0tLS0tc2l4dHktLS0tLS0tLS0tLXRocmVlLS0tLS0tLS0tLS0tY2hhcmFjdGVycyIsCiAgICAgICAgKQogICAgICAgIHIgPSByZXF1ZXN0cy5SZXF1ZXN0KCJHRVQiLCB1cmwpLnByZXBhcmUoKQogICAgICAgIGFzc2VydCByLnVybCA9PSB1cmwKCiAgICBkZWYgdGVzdF9oZWFkZXJfa2V5c19hcmVfbmF0aXZlKHNlbGYsIGh0dHBiaW4pOgogICAgICAgIGhlYWRlcnMgPSB7InVuaWNvZGUiOiAiYmxhaCIsIGIiYnl0ZSI6ICJibGFoIn0KICAgICAgICByID0gcmVxdWVzdHMuUmVxdWVzdCgiR0VUIiwgaHR0cGJpbigiZ2V0IiksIGhlYWRlcnM9aGVhZGVycykKICAgICAgICBwID0gci5wcmVwYXJlKCkKCiAgICAgICAgIyBUaGlzIGlzIHRlc3RpbmcgdGhhdCB0aGV5IGFyZSBidWlsdGluIHN0cmluZ3MuIEEgYml0IHdlaXJkLCBidXQgdGhlcmUKICAgICAgICAjIHdlIGdvLgogICAgICAgIGFzc2VydCAidW5pY29kZSIgaW4gcC5oZWFkZXJzLmtleXMoKQogICAgICAgIGFzc2VydCAiYnl0ZSIgaW4gcC5oZWFkZXJzLmtleXMoKQoKICAgIGRlZiB0ZXN0X2hlYWRlcl92YWxpZGF0aW9uKHNlbGYsIGh0dHBiaW4pOgogICAgICAgICIiIkVuc3VyZSBwcmVwYXJlX2hlYWRlcnMgcmVnZXggaXNuJ3QgZmxhZ2dpbmcgdmFsaWQgaGVhZGVyIGNvbnRlbnRzLiIiIgogICAgICAgIHZhbGlkX2hlYWRlcnMgPSB7CiAgICAgICAgICAgICJmb28iOiAiYmFyIGJheiBxdXgiLAogICAgICAgICAgICAiYmFyIjogYiJmYmJxIiwKICAgICAgICAgICAgImJheiI6ICIiLAogICAgICAgICAgICAicXV4IjogIjEiLAogICAgICAgIH0KICAgICAgICByID0gcmVxdWVzdHMuZ2V0KGh0dHBiaW4oImdldCIpLCBoZWFkZXJzPXZhbGlkX2hlYWRlcnMpCiAgICAgICAgZm9yIGtleSBpbiB2YWxpZF9oZWFkZXJzLmtleXMoKToKICAgICAgICAgICAgdmFsaWRfaGVhZGVyc1trZXldID09IHIucmVxdWVzdC5oZWFkZXJzW2tleV0KCiAgICBAcHl0ZXN0Lm1hcmsucGFyYW1ldHJpemUoCiAgICAgICAgImludmFsaWRfaGVhZGVyLCBrZXkiLAogICAgICAgICgKICAgICAgICAgICAgKHsiZm9vIjogM30sICJmb28iKSwKICAgICAgICAgICAgKHsiYmFyIjogeyJmb28iOiAiYmFyIn19LCAiYmFyIiksCiAgICAgICAgICAgICh7ImJheiI6IFsiZm9vIiwgImJhciJdfSwgImJheiIpLAogICAgICAgICksCiAgICApCiAgICBkZWYgdGVzdF9oZWFkZXJfdmFsdWVfbm90X3N0cihzZWxmLCBodHRwYmluLCBpbnZhbGlkX2hlYWRlciwga2V5KToKICAgICAgICAiIiJFbnN1cmUgdGhlIGhlYWRlciB2YWx1ZSBpcyBvZiB0eXBlIHN0cmluZyBvciBieXRlcyBhcwogICAgICAgIHBlciBkaXNjdXNzaW9uIGluIEdIIGlzc3VlICMzMzg2CiAgICAgICAgIiIiCiAgICAgICAgd2l0aCBweXRlc3QucmFpc2VzKEludmFsaWRIZWFkZXIpIGFzIGV4Y2luZm86CiAgICAgICAgICAgIHJlcXVlc3RzLmdldChodHRwYmluKCJnZXQiKSwgaGVhZGVycz1pbnZhbGlkX2hlYWRlcikKICAgICAgICBhc3NlcnQga2V5IGluIHN0cihleGNpbmZvLnZhbHVlKQoKICAgIEBweXRlc3QubWFyay5wYXJhbWV0cml6ZSgKICAgICAgICAiaW52YWxpZF9oZWFkZXIiLAogICAgICAgICgKICAgICAgICAgICAgeyJmb28iOiAiYmFyXHJcbmJhejogcXV4In0sCiAgICAgICAgICAgIHsiZm9vIjogImJhclxuXHJiYXo6IHF1eCJ9LAogICAgICAgICAgICB7ImZvbyI6ICJiYXJcbmJhejogcXV4In0sCiAgICAgICAgICAgIHsiZm9vIjogImJhclxyYmF6OiBxdXgifSwKICAgICAgICAgICAgeyJmb1xybyI6ICJiYXIifSwKICAgICAgICAgICAgeyJmb1xyXG5vIjogImJhciJ9LAogICAgICAgICAgICB7ImZvXG5ccm8iOiAiYmFyIn0sCiAgICAgICAgICAgIHsiZm9cbm8iOiAiYmFyIn0sCiAgICAgICAgKSwKICAgICkKICAgIGRlZiB0ZXN0X2hlYWRlcl9ub19yZXR1cm5fY2hhcnMoc2VsZiwgaHR0cGJpbiwgaW52YWxpZF9oZWFkZXIpOgogICAgICAgICIiIkVuc3VyZSB0aGF0IGEgaGVhZGVyIGNvbnRhaW5pbmcgcmV0dXJuIGNoYXJhY3RlciBzZXF1ZW5jZXMgcmFpc2UgYW4KICAgICAgICBleGNlcHRpb24uIE90aGVyd2lzZSwgbXVsdGlwbGUgaGVhZGVycyBhcmUgY3JlYXRlZCBmcm9tIHNpbmdsZSBzdHJpbmcuCiAgICAgICAgIiIiCiAgICAgICAgd2l0aCBweXRlc3QucmFpc2VzKEludmFsaWRIZWFkZXIpOgogICAgICAgICAgICByZXF1ZXN0cy5nZXQoaHR0cGJpbigiZ2V0IiksIGhlYWRlcnM9aW52YWxpZF9oZWFkZXIpCgogICAgQHB5dGVzdC5tYXJrLnBhcmFtZXRyaXplKAogICAgICAgICJpbnZhbGlkX2hlYWRlciIsCiAgICAgICAgKAogICAgICAgICAgICB7IiBmb28iOiAiYmFyIn0sCiAgICAgICAgICAgIHsiXHRmb28iOiAiYmFyIn0sCiAgICAgICAgICAgIHsiICAgIGZvbyI6ICJiYXIifSwKICAgICAgICAgICAgeyJmb28iOiAiIGJhciJ9LAogICAgICAgICAgICB7ImZvbyI6ICIgICAgYmFyIn0sCiAgICAgICAgICAgIHsiZm9vIjogIlx0YmFyIn0sCiAgICAgICAgICAgIHsiICI6ICJiYXIifSwKICAgICAgICApLAogICAgKQogICAgZGVmIHRlc3RfaGVhZGVyX25vX2xlYWRpbmdfc3BhY2Uoc2VsZiwgaHR0cGJpbiwgaW52YWxpZF9oZWFkZXIpOgogICAgICAgICIiIkVuc3VyZSBoZWFkZXJzIGNvbnRhaW5pbmcgbGVhZGluZyB3aGl0ZXNwYWNlIHJhaXNlCiAgICAgICAgSW52YWxpZEhlYWRlciBFcnJvciBiZWZvcmUgc2VuZGluZy4KICAgICAgICAiIiIKICAgICAgICB3aXRoIHB5dGVzdC5yYWlzZXMoSW52YWxpZEhlYWRlcik6CiAgICAgICAgICAgIHJlcXVlc3RzLmdldChodHRwYmluKCJnZXQiKSwgaGVhZGVycz1pbnZhbGlkX2hlYWRlcikKCiAgICBAcHl0ZXN0Lm1hcmsucGFyYW1ldHJpemUoImZpbGVzIiwgKCJmb28iLCBiImZvbyIsIGJ5dGVhcnJheShiImZvbyIpKSkKICAgIGRlZiB0ZXN0X2Nhbl9zZW5kX29iamVjdHNfd2l0aF9maWxlcyhzZWxmLCBodHRwYmluLCBmaWxlcyk6CiAgICAgICAgZGF0YSA9IHsiYSI6ICJ0aGlzIGlzIGEgc3RyaW5nIn0KICAgICAgICBmaWxlcyA9IHsiYiI6IGZpbGVzfQogICAgICAgIHIgPSByZXF1ZXN0cy5SZXF1ZXN0KCJQT1NUIiwgaHR0cGJpbigicG9zdCIpLCBkYXRhPWRhdGEsIGZpbGVzPWZpbGVzKQogICAgICAgIHAgPSByLnByZXBhcmUoKQogICAgICAgIGFzc2VydCAibXVsdGlwYXJ0L2Zvcm0tZGF0YSIgaW4gcC5oZWFkZXJzWyJDb250ZW50LVR5cGUiXQoKICAgIGRlZiB0ZXN0X2Nhbl9zZW5kX2ZpbGVfb2JqZWN0X3dpdGhfbm9uX3N0cmluZ19maWxlbmFtZShzZWxmLCBodHRwYmluKToKICAgICAgICBmID0gaW8uQnl0ZXNJTygpCiAgICAgICAgZi5uYW1lID0gMgogICAgICAgIHIgPSByZXF1ZXN0cy5SZXF1ZXN0KCJQT1NUIiwgaHR0cGJpbigicG9zdCIpLCBmaWxlcz17ImYiOiBmfSkKICAgICAgICBwID0gci5wcmVwYXJlKCkKCiAgICAgICAgYXNzZXJ0ICJtdWx0aXBhcnQvZm9ybS1kYXRhIiBpbiBwLmhlYWRlcnNbIkNvbnRlbnQtVHlwZSJdCgogICAgZGVmIHRlc3RfYXV0b3NldF9oZWFkZXJfdmFsdWVzX2FyZV9uYXRpdmUoc2VsZiwgaHR0cGJpbik6CiAgICAgICAgZGF0YSA9ICJ0aGlzIGlzIGEgc3RyaW5nIgogICAgICAgIGxlbmd0aCA9ICIxNiIKICAgICAgICByZXEgPSByZXF1ZXN0cy5SZXF1ZXN0KCJQT1NUIiwgaHR0cGJpbigicG9zdCIpLCBkYXRhPWRhdGEpCiAgICAgICAgcCA9IHJlcS5wcmVwYXJlKCkKCiAgICAgICAgYXNzZXJ0IHAuaGVhZGVyc1siQ29udGVudC1MZW5ndGgiXSA9PSBsZW5ndGgKCiAgICBkZWYgdGVzdF9ub25odHRwX3NjaGVtZXNfZG9udF9jaGVja19VUkxzKHNlbGYpOgogICAgICAgIHRlc3RfdXJscyA9ICgKICAgICAgICAgICAgImRhdGE6aW1hZ2UvZ2lmO2Jhc2U2NCxSMGxHT0RsaEFRQUJBSEFBQUNINUJBVUFBQUFBTEFBQUFBQUJBQUVBQUFJQ1JBRUFPdz09IiwKICAgICAgICAgICAgImZpbGU6Ly8vZXRjL3Bhc3N3ZCIsCiAgICAgICAgICAgICJtYWduZXQ6P3h0PXVybjpidGloOmJlMDhmMDAzMDJiYzJkMWQzY2ZhM2FmMDIwMjRmYTY0N2EyNzE0MzEiLAogICAgICAgICkKICAgICAgICBmb3IgdGVzdF91cmwgaW4gdGVzdF91cmxzOgogICAgICAgICAgICByZXEgPSByZXF1ZXN0cy5SZXF1ZXN0KCJHRVQiLCB0ZXN0X3VybCkKICAgICAgICAgICAgcHJlcSA9IHJlcS5wcmVwYXJlKCkKICAgICAgICAgICAgYXNzZXJ0IHRlc3RfdXJsID09IHByZXEudXJsCgogICAgZGVmIHRlc3RfYXV0aF9pc19zdHJpcHBlZF9vbl9odHRwX2Rvd25ncmFkZSgKICAgICAgICBzZWxmLCBodHRwYmluLCBodHRwYmluX3NlY3VyZSwgaHR0cGJpbl9jYV9idW5kbGUKICAgICk6CiAgICAgICAgciA9IHJlcXVlc3RzLmdldCgKICAgICAgICAgICAgaHR0cGJpbl9zZWN1cmUoInJlZGlyZWN0LXRvIiksCiAgICAgICAgICAgIHBhcmFtcz17InVybCI6IGh0dHBiaW4oImdldCIpfSwKICAgICAgICAgICAgYXV0aD0oInVzZXIiLCAicGFzcyIpLAogICAgICAgICAgICB2ZXJpZnk9aHR0cGJpbl9jYV9idW5kbGUsCiAgICAgICAgKQogICAgICAgIGFzc2VydCByLmhpc3RvcnlbMF0ucmVxdWVzdC5oZWFkZXJzWyJBdXRob3JpemF0aW9uIl0KICAgICAgICBhc3NlcnQgIkF1dGhvcml6YXRpb24iIG5vdCBpbiByLnJlcXVlc3QuaGVhZGVycwoKICAgIGRlZiB0ZXN0X2F1dGhfaXNfcmV0YWluZWRfZm9yX3JlZGlyZWN0X29uX2hvc3Qoc2VsZiwgaHR0cGJpbik6CiAgICAgICAgciA9IHJlcXVlc3RzLmdldChodHRwYmluKCJyZWRpcmVjdC8xIiksIGF1dGg9KCJ1c2VyIiwgInBhc3MiKSkKICAgICAgICBoMSA9IHIuaGlzdG9yeVswXS5yZXF1ZXN0LmhlYWRlcnNbIkF1dGhvcml6YXRpb24iXQogICAgICAgIGgyID0gci5yZXF1ZXN0LmhlYWRlcnNbIkF1dGhvcml6YXRpb24iXQoKICAgICAgICBhc3NlcnQgaDEgPT0gaDIKCiAgICBkZWYgdGVzdF9zaG91bGRfc3RyaXBfYXV0aF9ob3N0X2NoYW5nZShzZWxmKToKICAgICAgICBzID0gcmVxdWVzdHMuU2Vzc2lvbigpCiAgICAgICAgYXNzZXJ0IHMuc2hvdWxkX3N0cmlwX2F1dGgoCiAgICAgICAgICAgICJodHRwOi8vZXhhbXBsZS5jb20vZm9vIiwgImh0dHA6Ly9hbm90aGVyLmV4YW1wbGUuY29tLyIKICAgICAgICApCgogICAgZGVmIHRlc3Rfc2hvdWxkX3N0cmlwX2F1dGhfaHR0cF9kb3duZ3JhZGUoc2VsZik6CiAgICAgICAgcyA9IHJlcXVlc3RzLlNlc3Npb24oKQogICAgICAgIGFzc2VydCBzLnNob3VsZF9zdHJpcF9hdXRoKCJodHRwczovL2V4YW1wbGUuY29tL2ZvbyIsICJodHRwOi8vZXhhbXBsZS5jb20vYmFyIikKCiAgICBkZWYgdGVzdF9zaG91bGRfc3RyaXBfYXV0aF9odHRwc191cGdyYWRlKHNlbGYpOgogICAgICAgIHMgPSByZXF1ZXN0cy5TZXNzaW9uKCkKICAgICAgICBhc3NlcnQgbm90IHMuc2hvdWxkX3N0cmlwX2F1dGgoCiAgICAgICAgICAgICJodHRwOi8vZXhhbXBsZS5jb20vZm9vIiwgImh0dHBzOi8vZXhhbXBsZS5jb20vYmFyIgogICAgICAgICkKICAgICAgICBhc3NlcnQgbm90IHMuc2hvdWxkX3N0cmlwX2F1dGgoCiAgICAgICAgICAgICJodHRwOi8vZXhhbXBsZS5jb206ODAvZm9vIiwgImh0dHBzOi8vZXhhbXBsZS5jb20vYmFyIgogICAgICAgICkKICAgICAgICBhc3NlcnQgbm90IHMuc2hvdWxkX3N0cmlwX2F1dGgoCiAgICAgICAgICAgICJodHRwOi8vZXhhbXBsZS5jb20vZm9vIiwgImh0dHBzOi8vZXhhbXBsZS5jb206NDQzL2JhciIKICAgICAgICApCiAgICAgICAgIyBOb24tc3RhbmRhcmQgcG9ydHMgc2hvdWxkIHRyaWdnZXIgc3RyaXBwaW5nCiAgICAgICAgYXNzZXJ0IHMuc2hvdWxkX3N0cmlwX2F1dGgoCiAgICAgICAgICAgICJodHRwOi8vZXhhbXBsZS5jb206ODA4MC9mb28iLCAiaHR0cHM6Ly9leGFtcGxlLmNvbS9iYXIiCiAgICAgICAgKQogICAgICAgIGFzc2VydCBzLnNob3VsZF9zdHJpcF9hdXRoKAogICAgICAgICAgICAiaHR0cDovL2V4YW1wbGUuY29tL2ZvbyIsICJodHRwczovL2V4YW1wbGUuY29tOjg0NDMvYmFyIgogICAgICAgICkKCiAgICBkZWYgdGVzdF9zaG91bGRfc3RyaXBfYXV0aF9wb3J0X2NoYW5nZShzZWxmKToKICAgICAgICBzID0gcmVxdWVzdHMuU2Vzc2lvbigpCiAgICAgICAgYXNzZXJ0IHMuc2hvdWxkX3N0cmlwX2F1dGgoCiAgICAgICAgICAgICJodHRwOi8vZXhhbXBsZS5jb206MTIzNC9mb28iLCAiaHR0cHM6Ly9leGFtcGxlLmNvbTo0MzIxL2JhciIKICAgICAgICApCgogICAgQHB5dGVzdC5tYXJrLnBhcmFtZXRyaXplKAogICAgICAgICJvbGRfdXJpLCBuZXdfdXJpIiwKICAgICAgICAoCiAgICAgICAgICAgICgiaHR0cHM6Ly9leGFtcGxlLmNvbTo0NDMvZm9vIiwgImh0dHBzOi8vZXhhbXBsZS5jb20vYmFyIiksCiAgICAgICAgICAgICgiaHR0cDovL2V4YW1wbGUuY29tOjgwL2ZvbyIsICJodHRwOi8vZXhhbXBsZS5jb20vYmFyIiksCiAgICAgICAgICAgICgiaHR0cHM6Ly9leGFtcGxlLmNvbS9mb28iLCAiaHR0cHM6Ly9leGFtcGxlLmNvbTo0NDMvYmFyIiksCiAgICAgICAgICAgICgiaHR0cDovL2V4YW1wbGUuY29tL2ZvbyIsICJodHRwOi8vZXhhbXBsZS5jb206ODAvYmFyIiksCiAgICAgICAgKSwKICAgICkKICAgIGRlZiB0ZXN0X3Nob3VsZF9zdHJpcF9hdXRoX2RlZmF1bHRfcG9ydChzZWxmLCBvbGRfdXJpLCBuZXdfdXJpKToKICAgICAgICBzID0gcmVxdWVzdHMuU2Vzc2lvbigpCiAgICAgICAgYXNzZXJ0IG5vdCBzLnNob3VsZF9zdHJpcF9hdXRoKG9sZF91cmksIG5ld191cmkpCgogICAgZGVmIHRlc3RfbWFudWFsX3JlZGlyZWN0X3dpdGhfcGFydGlhbF9ib2R5X3JlYWQoc2VsZiwgaHR0cGJpbik6CiAgICAgICAgcyA9IHJlcXVlc3RzLlNlc3Npb24oKQogICAgICAgIHIxID0gcy5nZXQoaHR0cGJpbigicmVkaXJlY3QvMiIpLCBhbGxvd19yZWRpcmVjdHM9RmFsc2UsIHN0cmVhbT1UcnVlKQogICAgICAgIGFzc2VydCByMS5pc19yZWRpcmVjdAogICAgICAgIHJnID0gcy5yZXNvbHZlX3JlZGlyZWN0cyhyMSwgcjEucmVxdWVzdCwgc3RyZWFtPVRydWUpCgogICAgICAgICMgcmVhZCBvbmx5IHRoZSBmaXJzdCBlaWdodCBieXRlcyBvZiB0aGUgcmVzcG9uc2UgYm9keSwKICAgICAgICAjIHRoZW4gZm9sbG93IHRoZSByZWRpcmVjdAogICAgICAgIHIxLml0ZXJfY29udGVudCg4KQogICAgICAgIHIyID0gbmV4dChyZykKICAgICAgICBhc3NlcnQgcjIuaXNfcmVkaXJlY3QKCiAgICAgICAgIyByZWFkIGFsbCBvZiB0aGUgcmVzcG9uc2UgdmlhIGl0ZXJfY29udGVudCwKICAgICAgICAjIHRoZW4gZm9sbG93IHRoZSByZWRpcmVjdAogICAgICAgIGZvciBfIGluIHIyLml0ZXJfY29udGVudCgpOgogICAgICAgICAgICBwYXNzCiAgICAgICAgcjMgPSBuZXh0KHJnKQogICAgICAgIGFzc2VydCBub3QgcjMuaXNfcmVkaXJlY3QKCiAgICBkZWYgdGVzdF9wcmVwYXJlX2JvZHlfcG9zaXRpb25fbm9uX3N0cmVhbShzZWxmKToKICAgICAgICBkYXRhID0gYiJ0aGUgZGF0YSIKICAgICAgICBwcmVwID0gcmVxdWVzdHMuUmVxdWVzdCgiR0VUIiwgImh0dHA6Ly9leGFtcGxlLmNvbSIsIGRhdGE9ZGF0YSkucHJlcGFyZSgpCiAgICAgICAgYXNzZXJ0IHByZXAuX2JvZHlfcG9zaXRpb24gaXMgTm9uZQoKICAgIGRlZiB0ZXN0X3Jld2luZF9ib2R5KHNlbGYpOgogICAgICAgIGRhdGEgPSBpby5CeXRlc0lPKGIidGhlIGRhdGEiKQogICAgICAgIHByZXAgPSByZXF1ZXN0cy5SZXF1ZXN0KCJHRVQiLCAiaHR0cDovL2V4YW1wbGUuY29tIiwgZGF0YT1kYXRhKS5wcmVwYXJlKCkKICAgICAgICBhc3NlcnQgcHJlcC5fYm9keV9wb3NpdGlvbiA9PSAwCiAgICAgICAgYXNzZXJ0IHByZXAuYm9keS5yZWFkKCkgPT0gYiJ0aGUgZGF0YSIKCiAgICAgICAgIyB0aGUgZGF0YSBoYXMgYWxsIGJlZW4gcmVhZAogICAgICAgIGFzc2VydCBwcmVwLmJvZHkucmVhZCgpID09IGIiIgoKICAgICAgICAjIHJld2luZCBpdCBiYWNrCiAgICAgICAgcmVxdWVzdHMudXRpbHMucmV3aW5kX2JvZHkocHJlcCkKICAgICAgICBhc3NlcnQgcHJlcC5ib2R5LnJlYWQoKSA9PSBiInRoZSBkYXRhIgoKICAgIGRlZiB0ZXN0X3Jld2luZF9wYXJ0aWFsbHlfcmVhZF9ib2R5KHNlbGYpOgogICAgICAgIGRhdGEgPSBpby5CeXRlc0lPKGIidGhlIGRhdGEiKQogICAgICAgIGRhdGEucmVhZCg0KSAgIyByZWFkIHNvbWUgZGF0YQogICAgICAgIHByZXAgPSByZXF1ZXN0cy5SZXF1ZXN0KCJHRVQiLCAiaHR0cDovL2V4YW1wbGUuY29tIiwgZGF0YT1kYXRhKS5wcmVwYXJlKCkKICAgICAgICBhc3NlcnQgcHJlcC5fYm9keV9wb3NpdGlvbiA9PSA0CiAgICAgICAgYXNzZXJ0IHByZXAuYm9keS5yZWFkKCkgPT0gYiJkYXRhIgoKICAgICAgICAjIHRoZSBkYXRhIGhhcyBhbGwgYmVlbiByZWFkCiAgICAgICAgYXNzZXJ0IHByZXAuYm9keS5yZWFkKCkgPT0gYiIiCgogICAgICAgICMgcmV3aW5kIGl0IGJhY2sKICAgICAgICByZXF1ZXN0cy51dGlscy5yZXdpbmRfYm9keShwcmVwKQogICAgICAgIGFzc2VydCBwcmVwLmJvZHkucmVhZCgpID09IGIiZGF0YSIKCiAgICBkZWYgdGVzdF9yZXdpbmRfYm9keV9ub19zZWVrKHNlbGYpOgogICAgICAgIGNsYXNzIEJhZEZpbGVPYmo6CiAgICAgICAgICAgIGRlZiBfX2luaXRfXyhzZWxmLCBkYXRhKToKICAgICAgICAgICAgICAgIHNlbGYuZGF0YSA9IGRhdGEKCiAgICAgICAgICAgIGRlZiB0ZWxsKHNlbGYpOgogICAgICAgICAgICAgICAgcmV0dXJuIDAKCiAgICAgICAgICAgIGRlZiBfX2l0ZXJfXyhzZWxmKToKICAgICAgICAgICAgICAgIHJldHVybgoKICAgICAgICBkYXRhID0gQmFkRmlsZU9iaigidGhlIGRhdGEiKQogICAgICAgIHByZXAgPSByZXF1ZXN0cy5SZXF1ZXN0KCJHRVQiLCAiaHR0cDovL2V4YW1wbGUuY29tIiwgZGF0YT1kYXRhKS5wcmVwYXJlKCkKICAgICAgICBhc3NlcnQgcHJlcC5fYm9keV9wb3NpdGlvbiA9PSAwCgogICAgICAgIHdpdGggcHl0ZXN0LnJhaXNlcyhVbnJld2luZGFibGVCb2R5RXJyb3IpIGFzIGU6CiAgICAgICAgICAgIHJlcXVlc3RzLnV0aWxzLnJld2luZF9ib2R5KHByZXApCgogICAgICAgIGFzc2VydCAiVW5hYmxlIHRvIHJld2luZCByZXF1ZXN0IGJvZHkiIGluIHN0cihlKQoKICAgIGRlZiB0ZXN0X3Jld2luZF9ib2R5X2ZhaWxlZF9zZWVrKHNlbGYpOgogICAgICAgIGNsYXNzIEJhZEZpbGVPYmo6CiAgICAgICAgICAgIGRlZiBfX2luaXRfXyhzZWxmLCBkYXRhKToKICAgICAgICAgICAgICAgIHNlbGYuZGF0YSA9IGRhdGEKCiAgICAgICAgICAgIGRlZiB0ZWxsKHNlbGYpOgogICAgICAgICAgICAgICAgcmV0dXJuIDAKCiAgICAgICAgICAgIGRlZiBzZWVrKHNlbGYsIHBvcywgd2hlbmNlPTApOgogICAgICAgICAgICAgICAgcmFpc2UgT1NFcnJvcigpCgogICAgICAgICAgICBkZWYgX19pdGVyX18oc2VsZik6CiAgICAgICAgICAgICAgICByZXR1cm4KCiAgICAgICAgZGF0YSA9IEJhZEZpbGVPYmooInRoZSBkYXRhIikKICAgICAgICBwcmVwID0gcmVxdWVzdHMuUmVxdWVzdCgiR0VUIiwgImh0dHA6Ly9leGFtcGxlLmNvbSIsIGRhdGE9ZGF0YSkucHJlcGFyZSgpCiAgICAgICAgYXNzZXJ0IHByZXAuX2JvZHlfcG9zaXRpb24gPT0gMAoKICAgICAgICB3aXRoIHB5dGVzdC5yYWlzZXMoVW5yZXdpbmRhYmxlQm9keUVycm9yKSBhcyBlOgogICAgICAgICAgICByZXF1ZXN0cy51dGlscy5yZXdpbmRfYm9keShwcmVwKQoKICAgICAgICBhc3NlcnQgImVycm9yIG9jY3VycmVkIHdoZW4gcmV3aW5kaW5nIHJlcXVlc3QgYm9keSIgaW4gc3RyKGUpCgogICAgZGVmIHRlc3RfcmV3aW5kX2JvZHlfZmFpbGVkX3RlbGwoc2VsZik6CiAgICAgICAgY2xhc3MgQmFkRmlsZU9iajoKICAgICAgICAgICAgZGVmIF9faW5pdF9fKHNlbGYsIGRhdGEpOgogICAgICAgICAgICAgICAgc2VsZi5kYXRhID0gZGF0YQoKICAgICAgICAgICAgZGVmIHRlbGwoc2VsZik6CiAgICAgICAgICAgICAgICByYWlzZSBPU0Vycm9yKCkKCiAgICAgICAgICAgIGRlZiBfX2l0ZXJfXyhzZWxmKToKICAgICAgICAgICAgICAgIHJldHVybgoKICAgICAgICBkYXRhID0gQmFkRmlsZU9iaigidGhlIGRhdGEiKQogICAgICAgIHByZXAgPSByZXF1ZXN0cy5SZXF1ZXN0KCJHRVQiLCAiaHR0cDovL2V4YW1wbGUuY29tIiwgZGF0YT1kYXRhKS5wcmVwYXJlKCkKICAgICAgICBhc3NlcnQgcHJlcC5fYm9keV9wb3NpdGlvbiBpcyBub3QgTm9uZQoKICAgICAgICB3aXRoIHB5dGVzdC5yYWlzZXMoVW5yZXdpbmRhYmxlQm9keUVycm9yKSBhcyBlOgogICAgICAgICAgICByZXF1ZXN0cy51dGlscy5yZXdpbmRfYm9keShwcmVwKQoKICAgICAgICBhc3NlcnQgIlVuYWJsZSB0byByZXdpbmQgcmVxdWVzdCBib2R5IiBpbiBzdHIoZSkKCiAgICBkZWYgX3BhdGNoX2FkYXB0ZXJfZ3ppcHBlZF9yZWRpcmVjdChzZWxmLCBzZXNzaW9uLCB1cmwpOgogICAgICAgIGFkYXB0ZXIgPSBzZXNzaW9uLmdldF9hZGFwdGVyKHVybD11cmwpCiAgICAgICAgb3JnX2J1aWxkX3Jlc3BvbnNlID0gYWRhcHRlci5idWlsZF9yZXNwb25zZQogICAgICAgIHNlbGYuX3BhdGNoZWRfcmVzcG9uc2UgPSBGYWxzZQoKICAgICAgICBkZWYgYnVpbGRfcmVzcG9uc2UoKmFyZ3MsICoqa3dhcmdzKToKICAgICAgICAgICAgcmVzcCA9IG9yZ19idWlsZF9yZXNwb25zZSgqYXJncywgKiprd2FyZ3MpCiAgICAgICAgICAgIGlmIG5vdCBzZWxmLl9wYXRjaGVkX3Jlc3BvbnNlOgogICAgICAgICAgICAgICAgcmVzcC5yYXcuaGVhZGVyc1siY29udGVudC1lbmNvZGluZyJdID0gImd6aXAiCiAgICAgICAgICAgICAgICBzZWxmLl9wYXRjaGVkX3Jlc3BvbnNlID0gVHJ1ZQogICAgICAgICAgICByZXR1cm4gcmVzcAoKICAgICAgICBhZGFwdGVyLmJ1aWxkX3Jlc3BvbnNlID0gYnVpbGRfcmVzcG9uc2UKCiAgICBkZWYgdGVzdF9yZWRpcmVjdF93aXRoX3dyb25nX2d6aXBwZWRfaGVhZGVyKHNlbGYsIGh0dHBiaW4pOgogICAgICAgIHMgPSByZXF1ZXN0cy5TZXNzaW9uKCkKICAgICAgICB1cmwgPSBodHRwYmluKCJyZWRpcmVjdC8xIikKICAgICAgICBzZWxmLl9wYXRjaF9hZGFwdGVyX2d6aXBwZWRfcmVkaXJlY3QocywgdXJsKQogICAgICAgIHMuZ2V0KHVybCkKCiAgICBAcHl0ZXN0Lm1hcmsucGFyYW1ldHJpemUoCiAgICAgICAgInVzZXJuYW1lLCBwYXNzd29yZCwgYXV0aF9zdHIiLAogICAgICAgICgKICAgICAgICAgICAgKCJ0ZXN0IiwgInRlc3QiLCAiQmFzaWMgZEdWemREcDBaWE4wIiksCiAgICAgICAgICAgICgKICAgICAgICAgICAgICAgICLQuNC80Y8iLmVuY29kZSgpLAogICAgICAgICAgICAgICAgItC/0LDRgNC+0LvRjCIuZW5jb2RlKCksCiAgICAgICAgICAgICAgICAiQmFzaWMgMExqUXZOR1BPdEMvMExEUmdOQyswTHZSakE9PSIsCiAgICAgICAgICAgICksCiAgICAgICAgKSwKICAgICkKICAgIGRlZiB0ZXN0X2Jhc2ljX2F1dGhfc3RyX2lzX2Fsd2F5c19uYXRpdmUoc2VsZiwgdXNlcm5hbWUsIHBhc3N3b3JkLCBhdXRoX3N0cik6CiAgICAgICAgcyA9IF9iYXNpY19hdXRoX3N0cih1c2VybmFtZSwgcGFzc3dvcmQpCiAgICAgICAgYXNzZXJ0IGlzaW5zdGFuY2UocywgYnVpbHRpbl9zdHIpCiAgICAgICAgYXNzZXJ0IHMgPT0gYXV0aF9zdHIKCiAgICBkZWYgdGVzdF9yZXF1ZXN0c19oaXN0b3J5X2lzX3NhdmVkKHNlbGYsIGh0dHBiaW4pOgogICAgICAgIHIgPSByZXF1ZXN0cy5nZXQoaHR0cGJpbigicmVkaXJlY3QvNSIpKQogICAgICAgIHRvdGFsID0gci5oaXN0b3J5Wy0xXS5oaXN0b3J5CiAgICAgICAgaSA9IDAKICAgICAgICBmb3IgaXRlbSBpbiByLmhpc3Rvcnk6CiAgICAgICAgICAgIGFzc2VydCBpdGVtLmhpc3RvcnkgPT0gdG90YWxbMDppXQogICAgICAgICAgICBpICs9IDEKCiAgICBkZWYgdGVzdF9qc29uX3BhcmFtX3Bvc3RfY29udGVudF90eXBlX3dvcmtzKHNlbGYsIGh0dHBiaW4pOgogICAgICAgIHIgPSByZXF1ZXN0cy5wb3N0KGh0dHBiaW4oInBvc3QiKSwganNvbj17ImxpZmUiOiA0Mn0pCiAgICAgICAgYXNzZXJ0IHIuc3RhdHVzX2NvZGUgPT0gMjAwCiAgICAgICAgYXNzZXJ0ICJhcHBsaWNhdGlvbi9qc29uIiBpbiByLnJlcXVlc3QuaGVhZGVyc1siQ29udGVudC1UeXBlIl0KICAgICAgICBhc3NlcnQgeyJsaWZlIjogNDJ9ID09IHIuanNvbigpWyJqc29uIl0KCiAgICBkZWYgdGVzdF9qc29uX3BhcmFtX3Bvc3Rfc2hvdWxkX25vdF9vdmVycmlkZV9kYXRhX3BhcmFtKHNlbGYsIGh0dHBiaW4pOgogICAgICAgIHIgPSByZXF1ZXN0cy5SZXF1ZXN0KAogICAgICAgICAgICBtZXRob2Q9IlBPU1QiLAogICAgICAgICAgICB1cmw9aHR0cGJpbigicG9zdCIpLAogICAgICAgICAgICBkYXRhPXsic3R1ZmYiOiAiZWxpeHIifSwKICAgICAgICAgICAganNvbj17Im11c2ljIjogImZsdXRlIn0sCiAgICAgICAgKQogICAgICAgIHByZXAgPSByLnByZXBhcmUoKQogICAgICAgIGFzc2VydCAic3R1ZmY9ZWxpeHIiID09IHByZXAuYm9keQoKICAgIGRlZiB0ZXN0X3Jlc3BvbnNlX2l0ZXJfbGluZXMoc2VsZiwgaHR0cGJpbik6CiAgICAgICAgciA9IHJlcXVlc3RzLmdldChodHRwYmluKCJzdHJlYW0vNCIpLCBzdHJlYW09VHJ1ZSkKICAgICAgICBhc3NlcnQgci5zdGF0dXNfY29kZSA9PSAyMDAKCiAgICAgICAgaXQgPSByLml0ZXJfbGluZXMoKQogICAgICAgIG5leHQoaXQpCiAgICAgICAgYXNzZXJ0IGxlbihsaXN0KGl0KSkgPT0gMwoKICAgIGRlZiB0ZXN0X3Jlc3BvbnNlX2NvbnRleHRfbWFuYWdlcihzZWxmLCBodHRwYmluKToKICAgICAgICB3aXRoIHJlcXVlc3RzLmdldChodHRwYmluKCJzdHJlYW0vNCIpLCBzdHJlYW09VHJ1ZSkgYXMgcmVzcG9uc2U6CiAgICAgICAgICAgIGFzc2VydCBpc2luc3RhbmNlKHJlc3BvbnNlLCByZXF1ZXN0cy5SZXNwb25zZSkKCiAgICAgICAgYXNzZXJ0IHJlc3BvbnNlLnJhdy5jbG9zZWQKCiAgICBkZWYgdGVzdF91bmNvbnN1bWVkX3Nlc3Npb25fcmVzcG9uc2VfY2xvc2VzX2Nvbm5lY3Rpb24oc2VsZiwgaHR0cGJpbik6CiAgICAgICAgcyA9IHJlcXVlc3RzLnNlc3Npb24oKQoKICAgICAgICB3aXRoIGNvbnRleHRsaWIuY2xvc2luZyhzLmdldChodHRwYmluKCJzdHJlYW0vNCIpLCBzdHJlYW09VHJ1ZSkpIGFzIHJlc3BvbnNlOgogICAgICAgICAgICBwYXNzCgogICAgICAgIGFzc2VydCByZXNwb25zZS5fY29udGVudF9jb25zdW1lZCBpcyBGYWxzZQogICAgICAgIGFzc2VydCByZXNwb25zZS5yYXcuY2xvc2VkCgogICAgQHB5dGVzdC5tYXJrLnhmYWlsCiAgICBkZWYgdGVzdF9yZXNwb25zZV9pdGVyX2xpbmVzX3JlZW50cmFudChzZWxmLCBodHRwYmluKToKICAgICAgICAiIiJSZXNwb25zZS5pdGVyX2xpbmVzKCkgaXMgbm90IHJlZW50cmFudCBzYWZlIiIiCiAgICAgICAgciA9IHJlcXVlc3RzLmdldChodHRwYmluKCJzdHJlYW0vNCIpLCBzdHJlYW09VHJ1ZSkKICAgICAgICBhc3NlcnQgci5zdGF0dXNfY29kZSA9PSAyMDAKCiAgICAgICAgbmV4dChyLml0ZXJfbGluZXMoKSkKICAgICAgICBhc3NlcnQgbGVuKGxpc3Qoci5pdGVyX2xpbmVzKCkpKSA9PSAzCgogICAgZGVmIHRlc3Rfc2Vzc2lvbl9jbG9zZV9wcm94eV9jbGVhcihzZWxmLCBtb2NrZXIpOgogICAgICAgIHByb3hpZXMgPSB7CiAgICAgICAgICAgICJvbmUiOiBtb2NrZXIuTW9jaygpLAogICAgICAgICAgICAidHdvIjogbW9ja2VyLk1vY2soKSwKICAgICAgICB9CiAgICAgICAgc2Vzc2lvbiA9IHJlcXVlc3RzLlNlc3Npb24oKQogICAgICAgIG1vY2tlci5wYXRjaC5kaWN0KHNlc3Npb24uYWRhcHRlcnNbImh0dHA6Ly8iXS5wcm94eV9tYW5hZ2VyLCBwcm94aWVzKQogICAgICAgIHNlc3Npb24uY2xvc2UoKQogICAgICAgIHByb3hpZXNbIm9uZSJdLmNsZWFyLmFzc2VydF9jYWxsZWRfb25jZV93aXRoKCkKICAgICAgICBwcm94aWVzWyJ0d28iXS5jbGVhci5hc3NlcnRfY2FsbGVkX29uY2Vfd2l0aCgpCgogICAgZGVmIHRlc3RfcHJveHlfYXV0aChzZWxmKToKICAgICAgICBhZGFwdGVyID0gSFRUUEFkYXB0ZXIoKQogICAgICAgIGhlYWRlcnMgPSBhZGFwdGVyLnByb3h5X2hlYWRlcnMoImh0dHA6Ly91c2VyOnBhc3NAaHR0cGJpbi5vcmciKQogICAgICAgIGFzc2VydCBoZWFkZXJzID09IHsiUHJveHktQXV0aG9yaXphdGlvbiI6ICJCYXNpYyBkWE5sY2pwd1lYTnoifQoKICAgIGRlZiB0ZXN0X3Byb3h5X2F1dGhfZW1wdHlfcGFzcyhzZWxmKToKICAgICAgICBhZGFwdGVyID0gSFRUUEFkYXB0ZXIoKQogICAgICAgIGhlYWRlcnMgPSBhZGFwdGVyLnByb3h5X2hlYWRlcnMoImh0dHA6Ly91c2VyOkBodHRwYmluLm9yZyIpCiAgICAgICAgYXNzZXJ0IGhlYWRlcnMgPT0geyJQcm94eS1BdXRob3JpemF0aW9uIjogIkJhc2ljIGRYTmxjam89In0KCiAgICBkZWYgdGVzdF9yZXNwb25zZV9qc29uX3doZW5fY29udGVudF9pc19Ob25lKHNlbGYsIGh0dHBiaW4pOgogICAgICAgIHIgPSByZXF1ZXN0cy5nZXQoaHR0cGJpbigiL3N0YXR1cy8yMDQiKSkKICAgICAgICAjIE1ha2Ugc3VyZSByLmNvbnRlbnQgaXMgTm9uZQogICAgICAgIHIuc3RhdHVzX2NvZGUgPSAwCiAgICAgICAgci5fY29udGVudCA9IEZhbHNlCiAgICAgICAgci5fY29udGVudF9jb25zdW1lZCA9IEZhbHNlCgogICAgICAgIGFzc2VydCByLmNvbnRlbnQgaXMgTm9uZQogICAgICAgIHdpdGggcHl0ZXN0LnJhaXNlcyhWYWx1ZUVycm9yKToKICAgICAgICAgICAgci5qc29uKCkKCiAgICBkZWYgdGVzdF9yZXNwb25zZV93aXRob3V0X3JlbGVhc2VfY29ubihzZWxmKToKICAgICAgICAiIiJUZXN0IGBjbG9zZWAgY2FsbCBmb3Igbm9uLXVybGxpYjMtbGlrZSByYXcgb2JqZWN0cy4KICAgICAgICBTaG91bGQgd29yayB3aGVuIGByZWxlYXNlX2Nvbm5gIGF0dHIgZG9lc24ndCBleGlzdCBvbiBgcmVzcG9uc2UucmF3YC4KICAgICAgICAiIiIKICAgICAgICByZXNwID0gcmVxdWVzdHMuUmVzcG9uc2UoKQogICAgICAgIHJlc3AucmF3ID0gU3RyaW5nSU8uU3RyaW5nSU8oInRlc3QiKQogICAgICAgIGFzc2VydCBub3QgcmVzcC5yYXcuY2xvc2VkCiAgICAgICAgcmVzcC5jbG9zZSgpCiAgICAgICAgYXNzZXJ0IHJlc3AucmF3LmNsb3NlZAoKICAgIGRlZiB0ZXN0X2VtcHR5X3N0cmVhbV93aXRoX2F1dGhfZG9lc19ub3Rfc2V0X2NvbnRlbnRfbGVuZ3RoX2hlYWRlcihzZWxmLCBodHRwYmluKToKICAgICAgICAiIiJFbnN1cmUgdGhhdCBhIGJ5dGUgc3RyZWFtIHdpdGggc2l6ZSAwIHdpbGwgbm90IHNldCBib3RoIGEgQ29udGVudC1MZW5ndGgKICAgICAgICBhbmQgVHJhbnNmZXItRW5jb2RpbmcgaGVhZGVyLgogICAgICAgICIiIgogICAgICAgIGF1dGggPSAoInVzZXIiLCAicGFzcyIpCiAgICAgICAgdXJsID0gaHR0cGJpbigicG9zdCIpCiAgICAgICAgZmlsZV9vYmogPSBpby5CeXRlc0lPKGIiIikKICAgICAgICByID0gcmVxdWVzdHMuUmVxdWVzdCgiUE9TVCIsIHVybCwgYXV0aD1hdXRoLCBkYXRhPWZpbGVfb2JqKQogICAgICAgIHByZXBhcmVkX3JlcXVlc3QgPSByLnByZXBhcmUoKQogICAgICAgIGFzc2VydCAiVHJhbnNmZXItRW5jb2RpbmciIGluIHByZXBhcmVkX3JlcXVlc3QuaGVhZGVycwogICAgICAgIGFzc2VydCAiQ29udGVudC1MZW5ndGgiIG5vdCBpbiBwcmVwYXJlZF9yZXF1ZXN0LmhlYWRlcnMKCiAgICBkZWYgdGVzdF9zdHJlYW1fd2l0aF9hdXRoX2RvZXNfbm90X3NldF90cmFuc2Zlcl9lbmNvZGluZ19oZWFkZXIoc2VsZiwgaHR0cGJpbik6CiAgICAgICAgIiIiRW5zdXJlIHRoYXQgYSBieXRlIHN0cmVhbSB3aXRoIHNpemUgPiAwIHdpbGwgbm90IHNldCBib3RoIGEgQ29udGVudC1MZW5ndGgKICAgICAgICBhbmQgVHJhbnNmZXItRW5jb2RpbmcgaGVhZGVyLgogICAgICAgICIiIgogICAgICAgIGF1dGggPSAoInVzZXIiLCAicGFzcyIpCiAgICAgICAgdXJsID0gaHR0cGJpbigicG9zdCIpCiAgICAgICAgZmlsZV9vYmogPSBpby5CeXRlc0lPKGIidGVzdCBkYXRhIikKICAgICAgICByID0gcmVxdWVzdHMuUmVxdWVzdCgiUE9TVCIsIHVybCwgYXV0aD1hdXRoLCBkYXRhPWZpbGVfb2JqKQogICAgICAgIHByZXBhcmVkX3JlcXVlc3QgPSByLnByZXBhcmUoKQogICAgICAgIGFzc2VydCAiVHJhbnNmZXItRW5jb2RpbmciIG5vdCBpbiBwcmVwYXJlZF9yZXF1ZXN0LmhlYWRlcnMKICAgICAgICBhc3NlcnQgIkNvbnRlbnQtTGVuZ3RoIiBpbiBwcmVwYXJlZF9yZXF1ZXN0LmhlYWRlcnMKCiAgICBkZWYgdGVzdF9jaHVua2VkX3VwbG9hZF9kb2VzX25vdF9zZXRfY29udGVudF9sZW5ndGhfaGVhZGVyKHNlbGYsIGh0dHBiaW4pOgogICAgICAgICIiIkVuc3VyZSB0aGF0IHJlcXVlc3RzIHdpdGggYSBnZW5lcmF0b3IgYm9keSBzdHJlYW0gdXNpbmcKICAgICAgICBUcmFuc2Zlci1FbmNvZGluZzogY2h1bmtlZCwgbm90IGEgQ29udGVudC1MZW5ndGggaGVhZGVyLgogICAgICAgICIiIgogICAgICAgIGRhdGEgPSAoaSBmb3IgaSBpbiBbYiJhIiwgYiJiIiwgYiJjIl0pCiAgICAgICAgdXJsID0gaHR0cGJpbigicG9zdCIpCiAgICAgICAgciA9IHJlcXVlc3RzLlJlcXVlc3QoIlBPU1QiLCB1cmwsIGRhdGE9ZGF0YSkKICAgICAgICBwcmVwYXJlZF9yZXF1ZXN0ID0gci5wcmVwYXJlKCkKICAgICAgICBhc3NlcnQgIlRyYW5zZmVyLUVuY29kaW5nIiBpbiBwcmVwYXJlZF9yZXF1ZXN0LmhlYWRlcnMKICAgICAgICBhc3NlcnQgIkNvbnRlbnQtTGVuZ3RoIiBub3QgaW4gcHJlcGFyZWRfcmVxdWVzdC5oZWFkZXJzCgogICAgZGVmIHRlc3RfY3VzdG9tX3JlZGlyZWN0X21peGluKHNlbGYsIGh0dHBiaW4pOgogICAgICAgICIiIlRlc3RzIGEgY3VzdG9tIG1peGluIHRvIG92ZXJ3cml0ZSBgYGdldF9yZWRpcmVjdF90YXJnZXRgYC4KCiAgICAgICAgRW5zdXJlcyBhIHN1YmNsYXNzZWQgYGByZXF1ZXN0cy5TZXNzaW9uYGAgY2FuIGhhbmRsZSBhIGNlcnRhaW4gdHlwZSBvZgogICAgICAgIG1hbGZvcm1lZCByZWRpcmVjdCByZXNwb25zZXMuCgogICAgICAgIDEuIG9yaWdpbmFsIHJlcXVlc3QgcmVjZWl2ZXMgYSBwcm9wZXIgcmVzcG9uc2U6IDMwMiByZWRpcmVjdAogICAgICAgIDIuIGZvbGxvd2luZyB0aGUgcmVkaXJlY3QsIGEgbWFsZm9ybWVkIHJlc3BvbnNlIGlzIGdpdmVuOgogICAgICAgICAgICBzdGF0dXMgY29kZSA9IEhUVFAgMjAwCiAgICAgICAgICAgIGxvY2F0aW9uID0gYWx0ZXJuYXRlIHVybAogICAgICAgIDMuIHRoZSBjdXN0b20gc2Vzc2lvbiBjYXRjaGVzIHRoZSBlZGdlIGNhc2UgYW5kIGZvbGxvd3MgdGhlIHJlZGlyZWN0CiAgICAgICAgIiIiCiAgICAgICAgdXJsX2ZpbmFsID0gaHR0cGJpbigiaHRtbCIpCiAgICAgICAgcXVlcnlzdHJpbmdfbWFsZm9ybWVkID0gdXJsZW5jb2RlKHsibG9jYXRpb24iOiB1cmxfZmluYWx9KQogICAgICAgIHVybF9yZWRpcmVjdF9tYWxmb3JtZWQgPSBodHRwYmluKCJyZXNwb25zZS1oZWFkZXJzPyVzIiAlIHF1ZXJ5c3RyaW5nX21hbGZvcm1lZCkKICAgICAgICBxdWVyeXN0cmluZ19yZWRpcmVjdCA9IHVybGVuY29kZSh7InVybCI6IHVybF9yZWRpcmVjdF9tYWxmb3JtZWR9KQogICAgICAgIHVybF9yZWRpcmVjdCA9IGh0dHBiaW4oInJlZGlyZWN0LXRvPyVzIiAlIHF1ZXJ5c3RyaW5nX3JlZGlyZWN0KQogICAgICAgIHVybHNfdGVzdCA9IFsKICAgICAgICAgICAgdXJsX3JlZGlyZWN0LAogICAgICAgICAgICB1cmxfcmVkaXJlY3RfbWFsZm9ybWVkLAogICAgICAgICAgICB1cmxfZmluYWwsCiAgICAgICAgXQoKICAgICAgICBjbGFzcyBDdXN0b21SZWRpcmVjdFNlc3Npb24ocmVxdWVzdHMuU2Vzc2lvbik6CiAgICAgICAgICAgIGRlZiBnZXRfcmVkaXJlY3RfdGFyZ2V0KHNlbGYsIHJlc3ApOgogICAgICAgICAgICAgICAgIyBkZWZhdWx0IGJlaGF2aW9yCiAgICAgICAgICAgICAgICBpZiByZXNwLmlzX3JlZGlyZWN0OgogICAgICAgICAgICAgICAgICAgIHJldHVybiByZXNwLmhlYWRlcnNbImxvY2F0aW9uIl0KICAgICAgICAgICAgICAgICMgZWRnZSBjYXNlIC0gY2hlY2sgdG8gc2VlIGlmICdsb2NhdGlvbicgaXMgaW4gaGVhZGVycyBhbnl3YXlzCiAgICAgICAgICAgICAgICBsb2NhdGlvbiA9IHJlc3AuaGVhZGVycy5nZXQoImxvY2F0aW9uIikKICAgICAgICAgICAgICAgIGlmIGxvY2F0aW9uIGFuZCAobG9jYXRpb24gIT0gcmVzcC51cmwpOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBsb2NhdGlvbgogICAgICAgICAgICAgICAgcmV0dXJuIE5vbmUKCiAgICAgICAgc2Vzc2lvbiA9IEN1c3RvbVJlZGlyZWN0U2Vzc2lvbigpCiAgICAgICAgciA9IHNlc3Npb24uZ2V0KHVybHNfdGVzdFswXSkKICAgICAgICBhc3NlcnQgbGVuKHIuaGlzdG9yeSkgPT0gMgogICAgICAgIGFzc2VydCByLnN0YXR1c19jb2RlID09IDIwMAogICAgICAgIGFzc2VydCByLmhpc3RvcnlbMF0uc3RhdHVzX2NvZGUgPT0gMzAyCiAgICAgICAgYXNzZXJ0IHIuaGlzdG9yeVswXS5pc19yZWRpcmVjdAogICAgICAgIGFzc2VydCByLmhpc3RvcnlbMV0uc3RhdHVzX2NvZGUgPT0gMjAwCiAgICAgICAgYXNzZXJ0IG5vdCByLmhpc3RvcnlbMV0uaXNfcmVkaXJlY3QKICAgICAgICBhc3NlcnQgci51cmwgPT0gdXJsc190ZXN0WzJdCgoKY2xhc3MgVGVzdENhc2VJbnNlbnNpdGl2ZURpY3Q6CiAgICBAcHl0ZXN0Lm1hcmsucGFyYW1ldHJpemUoCiAgICAgICAgImNpZCIsCiAgICAgICAgKAogICAgICAgICAgICBDYXNlSW5zZW5zaXRpdmVEaWN0KHsiRm9vIjogImZvbyIsICJCQXIiOiAiYmFyIn0pLAogICAgICAgICAgICBDYXNlSW5zZW5zaXRpdmVEaWN0KFsoIkZvbyIsICJmb28iKSwgKCJCQXIiLCAiYmFyIildKSwKICAgICAgICAgICAgQ2FzZUluc2Vuc2l0aXZlRGljdChGT089ImZvbyIsIEJBcj0iYmFyIiksCiAgICAgICAgKSwKICAgICkKICAgIGRlZiB0ZXN0X2luaXQoc2VsZiwgY2lkKToKICAgICAgICBhc3NlcnQgbGVuKGNpZCkgPT0gMgogICAgICAgIGFzc2VydCAiZm9vIiBpbiBjaWQKICAgICAgICBhc3NlcnQgImJhciIgaW4gY2lkCgogICAgZGVmIHRlc3RfZG9jc3RyaW5nX2V4YW1wbGUoc2VsZik6CiAgICAgICAgY2lkID0gQ2FzZUluc2Vuc2l0aXZlRGljdCgpCiAgICAgICAgY2lkWyJBY2NlcHQiXSA9ICJhcHBsaWNhdGlvbi9qc29uIgogICAgICAgIGFzc2VydCBjaWRbImFDQ0VQVCJdID09ICJhcHBsaWNhdGlvbi9qc29uIgogICAgICAgIGFzc2VydCBsaXN0KGNpZCkgPT0gWyJBY2NlcHQiXQoKICAgIGRlZiB0ZXN0X2xlbihzZWxmKToKICAgICAgICBjaWQgPSBDYXNlSW5zZW5zaXRpdmVEaWN0KHsiYSI6ICJhIiwgImIiOiAiYiJ9KQogICAgICAgIGNpZFsiQSJdID0gImEiCiAgICAgICAgYXNzZXJ0IGxlbihjaWQpID09IDIKCiAgICBkZWYgdGVzdF9nZXRpdGVtKHNlbGYpOgogICAgICAgIGNpZCA9IENhc2VJbnNlbnNpdGl2ZURpY3QoeyJTcGFtIjogImJsdWV2YWwifSkKICAgICAgICBhc3NlcnQgY2lkWyJzcGFtIl0gPT0gImJsdWV2YWwiCiAgICAgICAgYXNzZXJ0IGNpZFsiU1BBTSJdID09ICJibHVldmFsIgoKICAgIGRlZiB0ZXN0X2ZpeGVzXzY0OShzZWxmKToKICAgICAgICAiIiJfX3NldGl0ZW1fXyBzaG91bGQgYmVoYXZlIGNhc2UtaW5zZW5zaXRpdmVseS4iIiIKICAgICAgICBjaWQgPSBDYXNlSW5zZW5zaXRpdmVEaWN0KCkKICAgICAgICBjaWRbInNwYW0iXSA9ICJvbmV2YWwiCiAgICAgICAgY2lkWyJTcGFtIl0gPSAidHdvdmFsIgogICAgICAgIGNpZFsic1BBTSJdID0gInJlZHZhbCIKICAgICAgICBjaWRbIlNQQU0iXSA9ICJibHVldmFsIgogICAgICAgIGFzc2VydCBjaWRbInNwYW0iXSA9PSAiYmx1ZXZhbCIKICAgICAgICBhc3NlcnQgY2lkWyJTUEFNIl0gPT0gImJsdWV2YWwiCiAgICAgICAgYXNzZXJ0IGxpc3QoY2lkLmtleXMoKSkgPT0gWyJTUEFNIl0KCiAgICBkZWYgdGVzdF9kZWxpdGVtKHNlbGYpOgogICAgICAgIGNpZCA9IENhc2VJbnNlbnNpdGl2ZURpY3QoKQogICAgICAgIGNpZFsiU3BhbSJdID0gInNvbWV2YWwiCiAgICAgICAgZGVsIGNpZFsic1BhbSJdCiAgICAgICAgYXNzZXJ0ICJzcGFtIiBub3QgaW4gY2lkCiAgICAgICAgYXNzZXJ0IGxlbihjaWQpID09IDAKCiAgICBkZWYgdGVzdF9jb250YWlucyhzZWxmKToKICAgICAgICBjaWQgPSBDYXNlSW5zZW5zaXRpdmVEaWN0KCkKICAgICAgICBjaWRbIlNwYW0iXSA9ICJzb21ldmFsIgogICAgICAgIGFzc2VydCAiU3BhbSIgaW4gY2lkCiAgICAgICAgYXNzZXJ0ICJzcGFtIiBpbiBjaWQKICAgICAgICBhc3NlcnQgIlNQQU0iIGluIGNpZAogICAgICAgIGFzc2VydCAic1BhbSIgaW4gY2lkCiAgICAgICAgYXNzZXJ0ICJub3RzcGFtIiBub3QgaW4gY2lkCgogICAgZGVmIHRlc3RfZ2V0KHNlbGYpOgogICAgICAgIGNpZCA9IENhc2VJbnNlbnNpdGl2ZURpY3QoKQogICAgICAgIGNpZFsic3BhbSJdID0gIm9uZXZhbCIKICAgICAgICBjaWRbIlNQQU0iXSA9ICJibHVldmFsIgogICAgICAgIGFzc2VydCBjaWQuZ2V0KCJzcGFtIikgPT0gImJsdWV2YWwiCiAgICAgICAgYXNzZXJ0IGNpZC5nZXQoIlNQQU0iKSA9PSAiYmx1ZXZhbCIKICAgICAgICBhc3NlcnQgY2lkLmdldCgic1BhbSIpID09ICJibHVldmFsIgogICAgICAgIGFzc2VydCBjaWQuZ2V0KCJub3RzcGFtIiwgImRlZmF1bHQiKSA9PSAiZGVmYXVsdCIKCiAgICBkZWYgdGVzdF91cGRhdGUoc2VsZik6CiAgICAgICAgY2lkID0gQ2FzZUluc2Vuc2l0aXZlRGljdCgpCiAgICAgICAgY2lkWyJzcGFtIl0gPSAiYmx1ZXZhbCIKICAgICAgICBjaWQudXBkYXRlKHsic1BhbSI6ICJub3RibHVldmFsIn0pCiAgICAgICAgYXNzZXJ0IGNpZFsic3BhbSJdID09ICJub3RibHVldmFsIgogICAgICAgIGNpZCA9IENhc2VJbnNlbnNpdGl2ZURpY3QoeyJGb28iOiAiZm9vIiwgIkJBciI6ICJiYXIifSkKICAgICAgICBjaWQudXBkYXRlKHsiZk9PIjogImFub3RoZXJmb28iLCAiYkFSIjogImFub3RoZXJiYXIifSkKICAgICAgICBhc3NlcnQgbGVuKGNpZCkgPT0gMgogICAgICAgIGFzc2VydCBjaWRbImZvbyJdID09ICJhbm90aGVyZm9vIgogICAgICAgIGFzc2VydCBjaWRbImJhciJdID09ICJhbm90aGVyYmFyIgoKICAgIGRlZiB0ZXN0X3VwZGF0ZV9yZXRhaW5zX3VuY2hhbmdlZChzZWxmKToKICAgICAgICBjaWQgPSBDYXNlSW5zZW5zaXRpdmVEaWN0KHsiZm9vIjogImZvbyIsICJiYXIiOiAiYmFyIn0pCiAgICAgICAgY2lkLnVwZGF0ZSh7ImZvbyI6ICJuZXdmb28ifSkKICAgICAgICBhc3NlcnQgY2lkWyJiYXIiXSA9PSAiYmFyIgoKICAgIGRlZiB0ZXN0X2l0ZXIoc2VsZik6CiAgICAgICAgY2lkID0gQ2FzZUluc2Vuc2l0aXZlRGljdCh7IlNwYW0iOiAic3BhbSIsICJFZ2dzIjogImVnZ3MifSkKICAgICAgICBrZXlzID0gZnJvemVuc2V0KFsiU3BhbSIsICJFZ2dzIl0pCiAgICAgICAgYXNzZXJ0IGZyb3plbnNldChpdGVyKGNpZCkpID09IGtleXMKCiAgICBkZWYgdGVzdF9lcXVhbGl0eShzZWxmKToKICAgICAgICBjaWQgPSBDYXNlSW5zZW5zaXRpdmVEaWN0KHsiU1BBTSI6ICJibHVldmFsIiwgIkVnZ3MiOiAicmVkdmFsIn0pCiAgICAgICAgb3RoZXJjaWQgPSBDYXNlSW5zZW5zaXRpdmVEaWN0KHsic3BhbSI6ICJibHVldmFsIiwgImVnZ3MiOiAicmVkdmFsIn0pCiAgICAgICAgYXNzZXJ0IGNpZCA9PSBvdGhlcmNpZAogICAgICAgIGRlbCBvdGhlcmNpZFsic3BhbSJdCiAgICAgICAgYXNzZXJ0IGNpZCAhPSBvdGhlcmNpZAogICAgICAgIGFzc2VydCBjaWQgPT0geyJzcGFtIjogImJsdWV2YWwiLCAiZWdncyI6ICJyZWR2YWwifQogICAgICAgIGFzc2VydCBjaWQgIT0gb2JqZWN0KCkKCiAgICBkZWYgdGVzdF9zZXRkZWZhdWx0KHNlbGYpOgogICAgICAgIGNpZCA9IENhc2VJbnNlbnNpdGl2ZURpY3QoeyJTcGFtIjogImJsdWV2YWwifSkKICAgICAgICBhc3NlcnQgY2lkLnNldGRlZmF1bHQoInNwYW0iLCAibm90Ymx1ZXZhbCIpID09ICJibHVldmFsIgogICAgICAgIGFzc2VydCBjaWQuc2V0ZGVmYXVsdCgibm90c3BhbSIsICJub3RibHVldmFsIikgPT0gIm5vdGJsdWV2YWwiCgogICAgZGVmIHRlc3RfbG93ZXJfaXRlbXMoc2VsZik6CiAgICAgICAgY2lkID0gQ2FzZUluc2Vuc2l0aXZlRGljdCgKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgIkFjY2VwdCI6ICJhcHBsaWNhdGlvbi9qc29uIiwKICAgICAgICAgICAgICAgICJ1c2VyLUFnZW50IjogInJlcXVlc3RzIiwKICAgICAgICAgICAgfQogICAgICAgICkKICAgICAgICBrZXlzZXQgPSBmcm96ZW5zZXQobG93ZXJrZXkgZm9yIGxvd2Vya2V5LCB2IGluIGNpZC5sb3dlcl9pdGVtcygpKQogICAgICAgIGxvd2Vya2V5c2V0ID0gZnJvemVuc2V0KFsiYWNjZXB0IiwgInVzZXItYWdlbnQiXSkKICAgICAgICBhc3NlcnQga2V5c2V0ID09IGxvd2Vya2V5c2V0CgogICAgZGVmIHRlc3RfcHJlc2VydmVfa2V5X2Nhc2Uoc2VsZik6CiAgICAgICAgY2lkID0gQ2FzZUluc2Vuc2l0aXZlRGljdCgKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgIkFjY2VwdCI6ICJhcHBsaWNhdGlvbi9qc29uIiwKICAgICAgICAgICAgICAgICJ1c2VyLUFnZW50IjogInJlcXVlc3RzIiwKICAgICAgICAgICAgfQogICAgICAgICkKICAgICAgICBrZXlzZXQgPSBmcm96ZW5zZXQoWyJBY2NlcHQiLCAidXNlci1BZ2VudCJdKQogICAgICAgIGFzc2VydCBmcm96ZW5zZXQoaVswXSBmb3IgaSBpbiBjaWQuaXRlbXMoKSkgPT0ga2V5c2V0CiAgICAgICAgYXNzZXJ0IGZyb3plbnNldChjaWQua2V5cygpKSA9PSBrZXlzZXQKICAgICAgICBhc3NlcnQgZnJvemVuc2V0KGNpZCkgPT0ga2V5c2V0CgogICAgZGVmIHRlc3RfcHJlc2VydmVfbGFzdF9rZXlfY2FzZShzZWxmKToKICAgICAgICBjaWQgPSBDYXNlSW5zZW5zaXRpdmVEaWN0KAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAiQWNjZXB0IjogImFwcGxpY2F0aW9uL2pzb24iLAogICAgICAgICAgICAgICAgInVzZXItQWdlbnQiOiAicmVxdWVzdHMiLAogICAgICAgICAgICB9CiAgICAgICAgKQogICAgICAgIGNpZC51cGRhdGUoeyJBQ0NFUFQiOiAiYXBwbGljYXRpb24vanNvbiJ9KQogICAgICAgIGNpZFsiVVNFUi1BR0VOVCJdID0gInJlcXVlc3RzIgogICAgICAgIGtleXNldCA9IGZyb3plbnNldChbIkFDQ0VQVCIsICJVU0VSLUFHRU5UIl0pCiAgICAgICAgYXNzZXJ0IGZyb3plbnNldChpWzBdIGZvciBpIGluIGNpZC5pdGVtcygpKSA9PSBrZXlzZXQKICAgICAgICBhc3NlcnQgZnJvemVuc2V0KGNpZC5rZXlzKCkpID09IGtleXNldAogICAgICAgIGFzc2VydCBmcm96ZW5zZXQoY2lkKSA9PSBrZXlzZXQKCiAgICBkZWYgdGVzdF9jb3B5KHNlbGYpOgogICAgICAgIGNpZCA9IENhc2VJbnNlbnNpdGl2ZURpY3QoCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICJBY2NlcHQiOiAiYXBwbGljYXRpb24vanNvbiIsCiAgICAgICAgICAgICAgICAidXNlci1BZ2VudCI6ICJyZXF1ZXN0cyIsCiAgICAgICAgICAgIH0KICAgICAgICApCiAgICAgICAgY2lkX2NvcHkgPSBjaWQuY29weSgpCiAgICAgICAgYXNzZXJ0IGNpZCA9PSBjaWRfY29weQogICAgICAgIGNpZFsiY2hhbmdlZCJdID0gVHJ1ZQogICAgICAgIGFzc2VydCBjaWQgIT0gY2lkX2NvcHkKCgpjbGFzcyBUZXN0TW9yc2VsVG9Db29raWVFeHBpcmVzOgogICAgIiIiVGVzdHMgZm9yIG1vcnNlbF90b19jb29raWUgd2hlbiBtb3JzZWwgY29udGFpbnMgZXhwaXJlcy4iIiIKCiAgICBkZWYgdGVzdF9leHBpcmVzX3ZhbGlkX3N0cihzZWxmKToKICAgICAgICAiIiJUZXN0IGNhc2Ugd2hlcmUgd2UgY29udmVydCBleHBpcmVzIGZyb20gc3RyaW5nIHRpbWUuIiIiCgogICAgICAgIG1vcnNlbCA9IE1vcnNlbCgpCiAgICAgICAgbW9yc2VsWyJleHBpcmVzIl0gPSAiVGh1LCAwMS1KYW4tMTk3MCAwMDowMDowMSBHTVQiCiAgICAgICAgY29va2llID0gbW9yc2VsX3RvX2Nvb2tpZShtb3JzZWwpCiAgICAgICAgYXNzZXJ0IGNvb2tpZS5leHBpcmVzID09IDEKCiAgICBAcHl0ZXN0Lm1hcmsucGFyYW1ldHJpemUoCiAgICAgICAgInZhbHVlLCBleGNlcHRpb24iLAogICAgICAgICgKICAgICAgICAgICAgKDEwMCwgVHlwZUVycm9yKSwKICAgICAgICAgICAgKCJ3b29wcyIsIFZhbHVlRXJyb3IpLAogICAgICAgICksCiAgICApCiAgICBkZWYgdGVzdF9leHBpcmVzX2ludmFsaWRfaW50KHNlbGYsIHZhbHVlLCBleGNlcHRpb24pOgogICAgICAgICIiIlRlc3QgY2FzZSB3aGVyZSBhbiBpbnZhbGlkIHR5cGUgaXMgcGFzc2VkIGZvciBleHBpcmVzLiIiIgogICAgICAgIG1vcnNlbCA9IE1vcnNlbCgpCiAgICAgICAgbW9yc2VsWyJleHBpcmVzIl0gPSB2YWx1ZQogICAgICAgIHdpdGggcHl0ZXN0LnJhaXNlcyhleGNlcHRpb24pOgogICAgICAgICAgICBtb3JzZWxfdG9fY29va2llKG1vcnNlbCkKCiAgICBkZWYgdGVzdF9leHBpcmVzX25vbmUoc2VsZik6CiAgICAgICAgIiIiVGVzdCBjYXNlIHdoZXJlIGV4cGlyZXMgaXMgTm9uZS4iIiIKCiAgICAgICAgbW9yc2VsID0gTW9yc2VsKCkKICAgICAgICBtb3JzZWxbImV4cGlyZXMiXSA9IE5vbmUKICAgICAgICBjb29raWUgPSBtb3JzZWxfdG9fY29va2llKG1vcnNlbCkKICAgICAgICBhc3NlcnQgY29va2llLmV4cGlyZXMgaXMgTm9uZQoKCmNsYXNzIFRlc3RNb3JzZWxUb0Nvb2tpZU1heEFnZToKCiAgICAiIiJUZXN0cyBmb3IgbW9yc2VsX3RvX2Nvb2tpZSB3aGVuIG1vcnNlbCBjb250YWlucyBtYXgtYWdlLiIiIgoKICAgIGRlZiB0ZXN0X21heF9hZ2VfdmFsaWRfaW50KHNlbGYpOgogICAgICAgICIiIlRlc3QgY2FzZSB3aGVyZSBhIHZhbGlkIG1heCBhZ2UgaW4gc2Vjb25kcyBpcyBwYXNzZWQuIiIiCgogICAgICAgIG1vcnNlbCA9IE1vcnNlbCgpCiAgICAgICAgbW9yc2VsWyJtYXgtYWdlIl0gPSA2MAogICAgICAgIGNvb2tpZSA9IG1vcnNlbF90b19jb29raWUobW9yc2VsKQogICAgICAgIGFzc2VydCBpc2luc3RhbmNlKGNvb2tpZS5leHBpcmVzLCBpbnQpCgogICAgZGVmIHRlc3RfbWF4X2FnZV9pbnZhbGlkX3N0cihzZWxmKToKICAgICAgICAiIiJUZXN0IGNhc2Ugd2hlcmUgYSBpbnZhbGlkIG1heCBhZ2UgaXMgcGFzc2VkLiIiIgoKICAgICAgICBtb3JzZWwgPSBNb3JzZWwoKQogICAgICAgIG1vcnNlbFsibWF4LWFnZSJdID0gIndvb3BzIgogICAgICAgIHdpdGggcHl0ZXN0LnJhaXNlcyhUeXBlRXJyb3IpOgogICAgICAgICAgICBtb3JzZWxfdG9fY29va2llKG1vcnNlbCkKCgpjbGFzcyBUZXN0VGltZW91dDoKICAgIGRlZiB0ZXN0X3N0cmVhbV90aW1lb3V0KHNlbGYsIGh0dHBiaW4pOgogICAgICAgIHRyeToKICAgICAgICAgICAgcmVxdWVzdHMuZ2V0KGh0dHBiaW4oImRlbGF5LzEwIiksIHRpbWVvdXQ9Mi4wKQogICAgICAgIGV4Y2VwdCByZXF1ZXN0cy5leGNlcHRpb25zLlRpbWVvdXQgYXMgZToKICAgICAgICAgICAgYXNzZXJ0ICJSZWFkIHRpbWVkIG91dCIgaW4gZS5hcmdzWzBdLmFyZ3NbMF0KCiAgICBAcHl0ZXN0Lm1hcmsucGFyYW1ldHJpemUoCiAgICAgICAgInRpbWVvdXQsIGVycm9yX3RleHQiLAogICAgICAgICgKICAgICAgICAgICAgKCgzLCA0LCA1KSwgIihjb25uZWN0LCByZWFkKSIpLAogICAgICAgICAgICAoImZvbyIsICJtdXN0IGJlIGFuIGludCwgZmxvYXQgb3IgTm9uZSIpLAogICAgICAgICksCiAgICApCiAgICBkZWYgdGVzdF9pbnZhbGlkX3RpbWVvdXQoc2VsZiwgaHR0cGJpbiwgdGltZW91dCwgZXJyb3JfdGV4dCk6CiAgICAgICAgd2l0aCBweXRlc3QucmFpc2VzKFZhbHVlRXJyb3IpIGFzIGU6CiAgICAgICAgICAgIHJlcXVlc3RzLmdldChodHRwYmluKCJnZXQiKSwgdGltZW91dD10aW1lb3V0KQogICAgICAgIGFzc2VydCBlcnJvcl90ZXh0IGluIHN0cihlKQoKICAgIEBweXRlc3QubWFyay5wYXJhbWV0cml6ZSgidGltZW91dCIsIChOb25lLCBVcmxsaWIzVGltZW91dChjb25uZWN0PU5vbmUsIHJlYWQ9Tm9uZSkpKQogICAgZGVmIHRlc3Rfbm9uZV90aW1lb3V0KHNlbGYsIGh0dHBiaW4sIHRpbWVvdXQpOgogICAgICAgICIiIkNoZWNrIHRoYXQgeW91IGNhbiBzZXQgTm9uZSBhcyBhIHZhbGlkIHRpbWVvdXQgdmFsdWUuCgogICAgICAgIFRvIGFjdHVhbGx5IHRlc3QgdGhpcyBiZWhhdmlvciwgd2UnZCB3YW50IHRvIGNoZWNrIHRoYXQgc2V0dGluZyB0aGUKICAgICAgICB0aW1lb3V0IHRvIE5vbmUgYWN0dWFsbHkgbGV0cyB0aGUgcmVxdWVzdCBibG9jayBwYXN0IHRoZSBzeXN0ZW0gZGVmYXVsdAogICAgICAgIHRpbWVvdXQuIEhvd2V2ZXIsIHRoaXMgd291bGQgbWFrZSB0aGUgdGVzdCBzdWl0ZSB1bmJlYXJhYmx5IHNsb3cuCiAgICAgICAgSW5zdGVhZCB3ZSB2ZXJpZnkgdGhhdCBzZXR0aW5nIHRoZSB0aW1lb3V0IHRvIE5vbmUgZG9lcyBub3QgcHJldmVudCB0aGUKICAgICAgICByZXF1ZXN0IGZyb20gc3VjY2VlZGluZy4KICAgICAgICAiIiIKICAgICAgICByID0gcmVxdWVzdHMuZ2V0KGh0dHBiaW4oImdldCIpLCB0aW1lb3V0PXRpbWVvdXQpCiAgICAgICAgYXNzZXJ0IHIuc3RhdHVzX2NvZGUgPT0gMjAwCgogICAgQHB5dGVzdC5tYXJrLnBhcmFtZXRyaXplKAogICAgICAgICJ0aW1lb3V0IiwgKChOb25lLCAwLjEpLCBVcmxsaWIzVGltZW91dChjb25uZWN0PU5vbmUsIHJlYWQ9MC4xKSkKICAgICkKICAgIGRlZiB0ZXN0X3JlYWRfdGltZW91dChzZWxmLCBodHRwYmluLCB0aW1lb3V0KToKICAgICAgICB0cnk6CiAgICAgICAgICAgIHJlcXVlc3RzLmdldChodHRwYmluKCJkZWxheS8xMCIpLCB0aW1lb3V0PXRpbWVvdXQpCiAgICAgICAgICAgIHB5dGVzdC5mYWlsKCJUaGUgcmVjdigpIHJlcXVlc3Qgc2hvdWxkIHRpbWUgb3V0LiIpCiAgICAgICAgZXhjZXB0IFJlYWRUaW1lb3V0OgogICAgICAgICAgICBwYXNzCgogICAgQHB5dGVzdC5tYXJrLnBhcmFtZXRyaXplKAogICAgICAgICJ0aW1lb3V0IiwgKCgwLjEsIE5vbmUpLCBVcmxsaWIzVGltZW91dChjb25uZWN0PTAuMSwgcmVhZD1Ob25lKSkKICAgICkKICAgIGRlZiB0ZXN0X2Nvbm5lY3RfdGltZW91dChzZWxmLCB0aW1lb3V0KToKICAgICAgICB0cnk6CiAgICAgICAgICAgIHJlcXVlc3RzLmdldChUQVJQSVQsIHRpbWVvdXQ9dGltZW91dCkKICAgICAgICAgICAgcHl0ZXN0LmZhaWwoIlRoZSBjb25uZWN0KCkgcmVxdWVzdCBzaG91bGQgdGltZSBvdXQuIikKICAgICAgICBleGNlcHQgQ29ubmVjdFRpbWVvdXQgYXMgZToKICAgICAgICAgICAgYXNzZXJ0IGlzaW5zdGFuY2UoZSwgQ29ubmVjdGlvbkVycm9yKQogICAgICAgICAgICBhc3NlcnQgaXNpbnN0YW5jZShlLCBUaW1lb3V0KQoKICAgIEBweXRlc3QubWFyay5wYXJhbWV0cml6ZSgKICAgICAgICAidGltZW91dCIsICgoMC4xLCAwLjEpLCBVcmxsaWIzVGltZW91dChjb25uZWN0PTAuMSwgcmVhZD0wLjEpKQogICAgKQogICAgZGVmIHRlc3RfdG90YWxfdGltZW91dF9jb25uZWN0KHNlbGYsIHRpbWVvdXQpOgogICAgICAgIHRyeToKICAgICAgICAgICAgcmVxdWVzdHMuZ2V0KFRBUlBJVCwgdGltZW91dD10aW1lb3V0KQogICAgICAgICAgICBweXRlc3QuZmFpbCgiVGhlIGNvbm5lY3QoKSByZXF1ZXN0IHNob3VsZCB0aW1lIG91dC4iKQogICAgICAgIGV4Y2VwdCBDb25uZWN0VGltZW91dDoKICAgICAgICAgICAgcGFzcwoKICAgIGRlZiB0ZXN0X2VuY29kZWRfbWV0aG9kcyhzZWxmLCBodHRwYmluKToKICAgICAgICAiIiJTZWU6IGh0dHBzOi8vZ2l0aHViLmNvbS9wc2YvcmVxdWVzdHMvaXNzdWVzLzIzMTYiIiIKICAgICAgICByID0gcmVxdWVzdHMucmVxdWVzdChiIkdFVCIsIGh0dHBiaW4oImdldCIpKQogICAgICAgIGFzc2VydCByLm9rCgoKU2VuZENhbGwgPSBjb2xsZWN0aW9ucy5uYW1lZHR1cGxlKCJTZW5kQ2FsbCIsICgiYXJncyIsICJrd2FyZ3MiKSkKCgpjbGFzcyBSZWRpcmVjdFNlc3Npb24oU2Vzc2lvblJlZGlyZWN0TWl4aW4pOgogICAgZGVmIF9faW5pdF9fKHNlbGYsIG9yZGVyX29mX3JlZGlyZWN0cyk6CiAgICAgICAgc2VsZi5yZWRpcmVjdHMgPSBvcmRlcl9vZl9yZWRpcmVjdHMKICAgICAgICBzZWxmLmNhbGxzID0gW10KICAgICAgICBzZWxmLm1heF9yZWRpcmVjdHMgPSAzMAogICAgICAgIHNlbGYuY29va2llcyA9IHt9CiAgICAgICAgc2VsZi50cnVzdF9lbnYgPSBGYWxzZQoKICAgIGRlZiBzZW5kKHNlbGYsICphcmdzLCAqKmt3YXJncyk6CiAgICAgICAgc2VsZi5jYWxscy5hcHBlbmQoU2VuZENhbGwoYXJncywga3dhcmdzKSkKICAgICAgICByZXR1cm4gc2VsZi5idWlsZF9yZXNwb25zZSgpCgogICAgZGVmIGJ1aWxkX3Jlc3BvbnNlKHNlbGYpOgogICAgICAgIHJlcXVlc3QgPSBzZWxmLmNhbGxzWy0xXS5hcmdzWzBdCiAgICAgICAgciA9IHJlcXVlc3RzLlJlc3BvbnNlKCkKCiAgICAgICAgdHJ5OgogICAgICAgICAgICByLnN0YXR1c19jb2RlID0gaW50KHNlbGYucmVkaXJlY3RzLnBvcCgwKSkKICAgICAgICBleGNlcHQgSW5kZXhFcnJvcjoKICAgICAgICAgICAgci5zdGF0dXNfY29kZSA9IDIwMAoKICAgICAgICByLmhlYWRlcnMgPSBDYXNlSW5zZW5zaXRpdmVEaWN0KHsiTG9jYXRpb24iOiAiLyJ9KQogICAgICAgIHIucmF3ID0gc2VsZi5fYnVpbGRfcmF3KCkKICAgICAgICByLnJlcXVlc3QgPSByZXF1ZXN0CiAgICAgICAgcmV0dXJuIHIKCiAgICBkZWYgX2J1aWxkX3JhdyhzZWxmKToKICAgICAgICBzdHJpbmcgPSBTdHJpbmdJTy5TdHJpbmdJTygiIikKICAgICAgICBzZXRhdHRyKHN0cmluZywgInJlbGVhc2VfY29ubiIsIGxhbWJkYSAqYXJnczogYXJncykKICAgICAgICByZXR1cm4gc3RyaW5nCgoKZGVmIHRlc3RfanNvbl9lbmNvZGVzX2FzX2J5dGVzKCk6CiAgICAjIHVybGxpYjMgZXhwZWN0cyBib2RpZXMgYXMgYnl0ZXMtbGlrZSBvYmplY3RzCiAgICBib2R5ID0geyJrZXkiOiAidmFsdWUifQogICAgcCA9IFByZXBhcmVkUmVxdWVzdCgpCiAgICBwLnByZXBhcmUobWV0aG9kPSJHRVQiLCB1cmw9Imh0dHBzOi8vd3d3LmV4YW1wbGUuY29tLyIsIGpzb249Ym9keSkKICAgIGFzc2VydCBpc2luc3RhbmNlKHAuYm9keSwgYnl0ZXMpCgoKZGVmIHRlc3RfcmVxdWVzdHNfYXJlX3VwZGF0ZWRfZWFjaF90aW1lKGh0dHBiaW4pOgogICAgc2Vzc2lvbiA9IFJlZGlyZWN0U2Vzc2lvbihbMzAzLCAzMDddKQogICAgcHJlcCA9IHJlcXVlc3RzLlJlcXVlc3QoIlBPU1QiLCBodHRwYmluKCJwb3N0IikpLnByZXBhcmUoKQogICAgcjAgPSBzZXNzaW9uLnNlbmQocHJlcCkKICAgIGFzc2VydCByMC5yZXF1ZXN0Lm1ldGhvZCA9PSAiUE9TVCIKICAgIGFzc2VydCBzZXNzaW9uLmNhbGxzWy0xXSA9PSBTZW5kQ2FsbCgocjAucmVxdWVzdCwpLCB7fSkKICAgIHJlZGlyZWN0X2dlbmVyYXRvciA9IHNlc3Npb24ucmVzb2x2ZV9yZWRpcmVjdHMocjAsIHByZXApCiAgICBkZWZhdWx0X2tleXdvcmRfYXJncyA9IHsKICAgICAgICAic3RyZWFtIjogRmFsc2UsCiAgICAgICAgInZlcmlmeSI6IFRydWUsCiAgICAgICAgImNlcnQiOiBOb25lLAogICAgICAgICJ0aW1lb3V0IjogTm9uZSwKICAgICAgICAiYWxsb3dfcmVkaXJlY3RzIjogRmFsc2UsCiAgICAgICAgInByb3hpZXMiOiB7fSwKICAgIH0KICAgIGZvciByZXNwb25zZSBpbiByZWRpcmVjdF9nZW5lcmF0b3I6CiAgICAgICAgYXNzZXJ0IHJlc3BvbnNlLnJlcXVlc3QubWV0aG9kID09ICJHRVQiCiAgICAgICAgc2VuZF9jYWxsID0gU2VuZENhbGwoKHJlc3BvbnNlLnJlcXVlc3QsKSwgZGVmYXVsdF9rZXl3b3JkX2FyZ3MpCiAgICAgICAgYXNzZXJ0IHNlc3Npb24uY2FsbHNbLTFdID09IHNlbmRfY2FsbAoKCkBweXRlc3QubWFyay5wYXJhbWV0cml6ZSgKICAgICJ2YXIsdXJsLHByb3h5IiwKICAgIFsKICAgICAgICAoImh0dHBfcHJveHkiLCAiaHR0cDovL2V4YW1wbGUuY29tIiwgInNvY2tzNTovL3Byb3h5LmNvbTo5ODc2IiksCiAgICAgICAgKCJodHRwc19wcm94eSIsICJodHRwczovL2V4YW1wbGUuY29tIiwgInNvY2tzNTovL3Byb3h5LmNvbTo5ODc2IiksCiAgICAgICAgKCJhbGxfcHJveHkiLCAiaHR0cDovL2V4YW1wbGUuY29tIiwgInNvY2tzNTovL3Byb3h5LmNvbTo5ODc2IiksCiAgICAgICAgKCJhbGxfcHJveHkiLCAiaHR0cHM6Ly9leGFtcGxlLmNvbSIsICJzb2NrczU6Ly9wcm94eS5jb206OTg3NiIpLAogICAgXSwKKQpkZWYgdGVzdF9wcm94eV9lbnZfdmFyc19vdmVycmlkZV9kZWZhdWx0KHZhciwgdXJsLCBwcm94eSk6CiAgICBzZXNzaW9uID0gcmVxdWVzdHMuU2Vzc2lvbigpCiAgICBwcmVwID0gUHJlcGFyZWRSZXF1ZXN0KCkKICAgIHByZXAucHJlcGFyZShtZXRob2Q9IkdFVCIsIHVybD11cmwpCgogICAga3dhcmdzID0ge3ZhcjogcHJveHl9CiAgICBzY2hlbWUgPSB1cmxwYXJzZSh1cmwpLnNjaGVtZQogICAgd2l0aCBvdmVycmlkZV9lbnZpcm9uKCoqa3dhcmdzKToKICAgICAgICBwcm94aWVzID0gc2Vzc2lvbi5yZWJ1aWxkX3Byb3hpZXMocHJlcCwge30pCiAgICAgICAgYXNzZXJ0IHNjaGVtZSBpbiBwcm94aWVzCiAgICAgICAgYXNzZXJ0IHByb3hpZXNbc2NoZW1lXSA9PSBwcm94eQoKCkBweXRlc3QubWFyay5wYXJhbWV0cml6ZSgKICAgICJkYXRhIiwKICAgICgKICAgICAgICAoKCJhIiwgImIiKSwgKCJjIiwgImQiKSksCiAgICAgICAgKCgiYyIsICJkIiksICgiYSIsICJiIikpLAogICAgICAgICgoImEiLCAiYiIpLCAoImMiLCAiZCIpLCAoImUiLCAiZiIpKSwKICAgICksCikKZGVmIHRlc3RfZGF0YV9hcmd1bWVudF9hY2NlcHRzX3R1cGxlcyhkYXRhKToKICAgICIiIkVuc3VyZSB0aGF0IHRoZSBkYXRhIGFyZ3VtZW50IHdpbGwgYWNjZXB0IHR1cGxlcyBvZiBzdHJpbmdzCiAgICBhbmQgcHJvcGVybHkgZW5jb2RlIHRoZW0uCiAgICAiIiIKICAgIHAgPSBQcmVwYXJlZFJlcXVlc3QoKQogICAgcC5wcmVwYXJlKAogICAgICAgIG1ldGhvZD0iR0VUIiwgdXJsPSJodHRwOi8vd3d3LmV4YW1wbGUuY29tIiwgZGF0YT1kYXRhLCBob29rcz1kZWZhdWx0X2hvb2tzKCkKICAgICkKICAgIGFzc2VydCBwLmJvZHkgPT0gdXJsZW5jb2RlKGRhdGEpCgoKQHB5dGVzdC5tYXJrLnBhcmFtZXRyaXplKAogICAgImt3YXJncyIsCiAgICAoCiAgICAgICAgTm9uZSwKICAgICAgICB7CiAgICAgICAgICAgICJtZXRob2QiOiAiR0VUIiwKICAgICAgICAgICAgInVybCI6ICJodHRwOi8vd3d3LmV4YW1wbGUuY29tIiwKICAgICAgICAgICAgImRhdGEiOiAiZm9vPWJhciIsCiAgICAgICAgICAgICJob29rcyI6IGRlZmF1bHRfaG9va3MoKSwKICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgICAgIm1ldGhvZCI6ICJHRVQiLAogICAgICAgICAgICAidXJsIjogImh0dHA6Ly93d3cuZXhhbXBsZS5jb20iLAogICAgICAgICAgICAiZGF0YSI6ICJmb289YmFyIiwKICAgICAgICAgICAgImhvb2tzIjogZGVmYXVsdF9ob29rcygpLAogICAgICAgICAgICAiY29va2llcyI6IHsiZm9vIjogImJhciJ9LAogICAgICAgIH0sCiAgICAgICAgeyJtZXRob2QiOiAiR0VUIiwgInVybCI6ICJodHRwOi8vd3d3LmV4YW1wbGUuY29tL8O8bmnDp8O44oiCw6kifSwKICAgICksCikKZGVmIHRlc3RfcHJlcGFyZWRfY29weShrd2FyZ3MpOgogICAgcCA9IFByZXBhcmVkUmVxdWVzdCgpCiAgICBpZiBrd2FyZ3M6CiAgICAgICAgcC5wcmVwYXJlKCoqa3dhcmdzKQogICAgY29weSA9IHAuY29weSgpCiAgICBmb3IgYXR0ciBpbiAoIm1ldGhvZCIsICJ1cmwiLCAiaGVhZGVycyIsICJfY29va2llcyIsICJib2R5IiwgImhvb2tzIik6CiAgICAgICAgYXNzZXJ0IGdldGF0dHIocCwgYXR0cikgPT0gZ2V0YXR0cihjb3B5LCBhdHRyKQoKCmRlZiB0ZXN0X3VybGxpYjNfcmV0cmllcyhodHRwYmluKToKICAgIGZyb20gdXJsbGliMy51dGlsIGltcG9ydCBSZXRyeQoKICAgIHMgPSByZXF1ZXN0cy5TZXNzaW9uKCkKICAgIHMubW91bnQoImh0dHA6Ly8iLCBIVFRQQWRhcHRlcihtYXhfcmV0cmllcz1SZXRyeSh0b3RhbD0yLCBzdGF0dXNfZm9yY2VsaXN0PVs1MDBdKSkpCgogICAgd2l0aCBweXRlc3QucmFpc2VzKFJldHJ5RXJyb3IpOgogICAgICAgIHMuZ2V0KGh0dHBiaW4oInN0YXR1cy81MDAiKSkKCgpkZWYgdGVzdF91cmxsaWIzX3Bvb2xfY29ubmVjdGlvbl9jbG9zZWQoaHR0cGJpbik6CiAgICBzID0gcmVxdWVzdHMuU2Vzc2lvbigpCiAgICBzLm1vdW50KCJodHRwOi8vIiwgSFRUUEFkYXB0ZXIocG9vbF9jb25uZWN0aW9ucz0wLCBwb29sX21heHNpemU9MCkpCgogICAgdHJ5OgogICAgICAgIHMuZ2V0KGh0dHBiaW4oInN0YXR1cy8yMDAiKSkKICAgIGV4Y2VwdCBDb25uZWN0aW9uRXJyb3IgYXMgZToKICAgICAgICBhc3NlcnQgIlBvb2wgaXMgY2xvc2VkLiIgaW4gc3RyKGUpCgoKY2xhc3MgVGVzdFByZXBhcmluZ1VSTHM6CiAgICBAcHl0ZXN0Lm1hcmsucGFyYW1ldHJpemUoCiAgICAgICAgInVybCxleHBlY3RlZCIsCiAgICAgICAgKAogICAgICAgICAgICAoImh0dHA6Ly9nb29nbGUuY29tIiwgImh0dHA6Ly9nb29nbGUuY29tLyIpLAogICAgICAgICAgICAoImh0dHA6Ly/jgrjjgqfjg7zjg5Tjg7zjg4vjg4Pjgq8uanAiLCAiaHR0cDovL3huLS1oY2txejliemIxY3lyYi5qcC8iKSwKICAgICAgICAgICAgKCJodHRwOi8veG4tLW4zaC5uZXQvIiwgImh0dHA6Ly94bi0tbjNoLm5ldC8iKSwKICAgICAgICAgICAgKCJodHRwOi8v44K444Kn44O844OU44O844OL44OD44KvLmpwIi5lbmNvZGUoKSwgImh0dHA6Ly94bi0taGNrcXo5YnpiMWN5cmIuanAvIiksCiAgICAgICAgICAgICgiaHR0cDovL3N0cmHDn2UuZGUvc3RyYcOfZSIsICJodHRwOi8veG4tLXN0cmFlLW9xYS5kZS9zdHJhJUMzJTlGZSIpLAogICAgICAgICAgICAoCiAgICAgICAgICAgICAgICAiaHR0cDovL3N0cmHDn2UuZGUvc3RyYcOfZSIuZW5jb2RlKCksCiAgICAgICAgICAgICAgICAiaHR0cDovL3huLS1zdHJhZS1vcWEuZGUvc3RyYSVDMyU5RmUiLAogICAgICAgICAgICApLAogICAgICAgICAgICAoCiAgICAgICAgICAgICAgICAiaHR0cDovL0vDtm5pZ3Nnw6TDn2NoZW4uZGUvc3RyYcOfZSIsCiAgICAgICAgICAgICAgICAiaHR0cDovL3huLS1rbmlnc2djaGVuLWI0YTNkdW4uZGUvc3RyYSVDMyU5RmUiLAogICAgICAgICAgICApLAogICAgICAgICAgICAoCiAgICAgICAgICAgICAgICAiaHR0cDovL0vDtm5pZ3Nnw6TDn2NoZW4uZGUvc3RyYcOfZSIuZW5jb2RlKCksCiAgICAgICAgICAgICAgICAiaHR0cDovL3huLS1rbmlnc2djaGVuLWI0YTNkdW4uZGUvc3RyYSVDMyU5RmUiLAogICAgICAgICAgICApLAogICAgICAgICAgICAoYiJodHRwOi8veG4tLW4zaC5uZXQvIiwgImh0dHA6Ly94bi0tbjNoLm5ldC8iKSwKICAgICAgICAgICAgKAogICAgICAgICAgICAgICAgYiJodHRwOi8vWzEyMDA6MDAwMDphYjAwOjEyMzQ6MDAwMDoyNTUyOjc3Nzc6MTMxM106MTIzNDUvIiwKICAgICAgICAgICAgICAgICJodHRwOi8vWzEyMDA6MDAwMDphYjAwOjEyMzQ6MDAwMDoyNTUyOjc3Nzc6MTMxM106MTIzNDUvIiwKICAgICAgICAgICAgKSwKICAgICAgICAgICAgKAogICAgICAgICAgICAgICAgImh0dHA6Ly9bMTIwMDowMDAwOmFiMDA6MTIzNDowMDAwOjI1NTI6Nzc3NzoxMzEzXToxMjM0NS8iLAogICAgICAgICAgICAgICAgImh0dHA6Ly9bMTIwMDowMDAwOmFiMDA6MTIzNDowMDAwOjI1NTI6Nzc3NzoxMzEzXToxMjM0NS8iLAogICAgICAgICAgICApLAogICAgICAgICksCiAgICApCiAgICBkZWYgdGVzdF9wcmVwYXJpbmdfdXJsKHNlbGYsIHVybCwgZXhwZWN0ZWQpOgogICAgICAgIGRlZiBub3JtYWxpemVfcGVyY2VudF9lbmNvZGUoeCk6CiAgICAgICAgICAgICMgSGVscGVyIGZ1bmN0aW9uIHRoYXQgbm9ybWFsaXplcyBlcXVpdmFsZW50CiAgICAgICAgICAgICMgcGVyY2VudC1lbmNvZGVkIGJ5dGVzIGJlZm9yZSBjb21wYXJpc29ucwogICAgICAgICAgICBmb3IgYyBpbiByZS5maW5kYWxsKHIiJVthLWZBLUYwLTldezJ9IiwgeCk6CiAgICAgICAgICAgICAgICB4ID0geC5yZXBsYWNlKGMsIGMudXBwZXIoKSkKICAgICAgICAgICAgcmV0dXJuIHgKCiAgICAgICAgciA9IHJlcXVlc3RzLlJlcXVlc3QoIkdFVCIsIHVybD11cmwpCiAgICAgICAgcCA9IHIucHJlcGFyZSgpCiAgICAgICAgYXNzZXJ0IG5vcm1hbGl6ZV9wZXJjZW50X2VuY29kZShwLnVybCkgPT0gZXhwZWN0ZWQKCiAgICBAcHl0ZXN0Lm1hcmsucGFyYW1ldHJpemUoCiAgICAgICAgInVybCIsCiAgICAgICAgKAogICAgICAgICAgICBiImh0dHA6Ly8qLmdvb2dsZS5jb20iLAogICAgICAgICAgICBiImh0dHA6Ly8qIiwKICAgICAgICAgICAgImh0dHA6Ly8qLmdvb2dsZS5jb20iLAogICAgICAgICAgICAiaHR0cDovLyoiLAogICAgICAgICAgICAiaHR0cDovL+KYgy5uZXQvIiwKICAgICAgICApLAogICAgKQogICAgZGVmIHRlc3RfcHJlcGFyaW5nX2JhZF91cmwoc2VsZiwgdXJsKToKICAgICAgICByID0gcmVxdWVzdHMuUmVxdWVzdCgiR0VUIiwgdXJsPXVybCkKICAgICAgICB3aXRoIHB5dGVzdC5yYWlzZXMocmVxdWVzdHMuZXhjZXB0aW9ucy5JbnZhbGlkVVJMKToKICAgICAgICAgICAgci5wcmVwYXJlKCkKCiAgICBAcHl0ZXN0Lm1hcmsucGFyYW1ldHJpemUoInVybCwgZXhjZXB0aW9uIiwgKCgiaHR0cDovL2xvY2FsaG9zdDotMSIsIEludmFsaWRVUkwpLCkpCiAgICBkZWYgdGVzdF9yZWRpcmVjdGluZ190b19iYWRfdXJsKHNlbGYsIGh0dHBiaW4sIHVybCwgZXhjZXB0aW9uKToKICAgICAgICB3aXRoIHB5dGVzdC5yYWlzZXMoZXhjZXB0aW9uKToKICAgICAgICAgICAgcmVxdWVzdHMuZ2V0KGh0dHBiaW4oInJlZGlyZWN0LXRvIiksIHBhcmFtcz17InVybCI6IHVybH0pCgogICAgQHB5dGVzdC5tYXJrLnBhcmFtZXRyaXplKAogICAgICAgICJpbnB1dCwgZXhwZWN0ZWQiLAogICAgICAgICgKICAgICAgICAgICAgKAogICAgICAgICAgICAgICAgYiJodHRwK3VuaXg6Ly8lMkZ2YXIlMkZydW4lMkZzb2NrZXQvcGF0aCU3RSIsCiAgICAgICAgICAgICAgICAiaHR0cCt1bml4Oi8vJTJGdmFyJTJGcnVuJTJGc29ja2V0L3BhdGh+IiwKICAgICAgICAgICAgKSwKICAgICAgICAgICAgKAogICAgICAgICAgICAgICAgImh0dHArdW5peDovLyUyRnZhciUyRnJ1biUyRnNvY2tldC9wYXRoJTdFIiwKICAgICAgICAgICAgICAgICJodHRwK3VuaXg6Ly8lMkZ2YXIlMkZydW4lMkZzb2NrZXQvcGF0aH4iLAogICAgICAgICAgICApLAogICAgICAgICAgICAoCiAgICAgICAgICAgICAgICBiIm1haWx0bzp1c2VyQGV4YW1wbGUub3JnIiwKICAgICAgICAgICAgICAgICJtYWlsdG86dXNlckBleGFtcGxlLm9yZyIsCiAgICAgICAgICAgICksCiAgICAgICAgICAgICgKICAgICAgICAgICAgICAgICJtYWlsdG86dXNlckBleGFtcGxlLm9yZyIsCiAgICAgICAgICAgICAgICAibWFpbHRvOnVzZXJAZXhhbXBsZS5vcmciLAogICAgICAgICAgICApLAogICAgICAgICAgICAoCiAgICAgICAgICAgICAgICBiImRhdGE6U1NEaW1hVWdVSGwwYUc5dUlRPT0iLAogICAgICAgICAgICAgICAgImRhdGE6U1NEaW1hVWdVSGwwYUc5dUlRPT0iLAogICAgICAgICAgICApLAogICAgICAgICksCiAgICApCiAgICBkZWYgdGVzdF91cmxfbXV0YXRpb24oc2VsZiwgaW5wdXQsIGV4cGVjdGVkKToKICAgICAgICAiIiIKICAgICAgICBUaGlzIHRlc3QgdmFsaWRhdGVzIHRoYXQgd2UgY29ycmVjdGx5IGV4Y2x1ZGUgc29tZSBVUkxzIGZyb20KICAgICAgICBwcmVwYXJhdGlvbiwgYW5kIHRoYXQgd2UgaGFuZGxlIG90aGVycy4gU3BlY2lmaWNhbGx5LCBpdCB0ZXN0cyB0aGF0CiAgICAgICAgYW55IFVSTCB3aG9zZSBzY2hlbWUgZG9lc24ndCBiZWdpbiB3aXRoICJodHRwIiBpcyBsZWZ0IGFsb25lLCBhbmQKICAgICAgICB0aG9zZSB3aG9zZSBzY2hlbWUgKmRvZXMqIGJlZ2luIHdpdGggImh0dHAiIGFyZSBtdXRhdGVkLgogICAgICAgICIiIgogICAgICAgIHIgPSByZXF1ZXN0cy5SZXF1ZXN0KCJHRVQiLCB1cmw9aW5wdXQpCiAgICAgICAgcCA9IHIucHJlcGFyZSgpCiAgICAgICAgYXNzZXJ0IHAudXJsID09IGV4cGVjdGVkCgogICAgQHB5dGVzdC5tYXJrLnBhcmFtZXRyaXplKAogICAgICAgICJpbnB1dCwgcGFyYW1zLCBleHBlY3RlZCIsCiAgICAgICAgKAogICAgICAgICAgICAoCiAgICAgICAgICAgICAgICBiImh0dHArdW5peDovLyUyRnZhciUyRnJ1biUyRnNvY2tldC9wYXRoIiwKICAgICAgICAgICAgICAgIHsia2V5IjogInZhbHVlIn0sCiAgICAgICAgICAgICAgICAiaHR0cCt1bml4Oi8vJTJGdmFyJTJGcnVuJTJGc29ja2V0L3BhdGg/a2V5PXZhbHVlIiwKICAgICAgICAgICAgKSwKICAgICAgICAgICAgKAogICAgICAgICAgICAgICAgImh0dHArdW5peDovLyUyRnZhciUyRnJ1biUyRnNvY2tldC9wYXRoIiwKICAgICAgICAgICAgICAgIHsia2V5IjogInZhbHVlIn0sCiAgICAgICAgICAgICAgICAiaHR0cCt1bml4Oi8vJTJGdmFyJTJGcnVuJTJGc29ja2V0L3BhdGg/a2V5PXZhbHVlIiwKICAgICAgICAgICAgKSwKICAgICAgICAgICAgKAogICAgICAgICAgICAgICAgYiJtYWlsdG86dXNlckBleGFtcGxlLm9yZyIsCiAgICAgICAgICAgICAgICB7ImtleSI6ICJ2YWx1ZSJ9LAogICAgICAgICAgICAgICAgIm1haWx0bzp1c2VyQGV4YW1wbGUub3JnIiwKICAgICAgICAgICAgKSwKICAgICAgICAgICAgKAogICAgICAgICAgICAgICAgIm1haWx0bzp1c2VyQGV4YW1wbGUub3JnIiwKICAgICAgICAgICAgICAgIHsia2V5IjogInZhbHVlIn0sCiAgICAgICAgICAgICAgICAibWFpbHRvOnVzZXJAZXhhbXBsZS5vcmciLAogICAgICAgICAgICApLAogICAgICAgICksCiAgICApCiAgICBkZWYgdGVzdF9wYXJhbWV0ZXJzX2Zvcl9ub25zdGFuZGFyZF9zY2hlbWVzKHNlbGYsIGlucHV0LCBwYXJhbXMsIGV4cGVjdGVkKToKICAgICAgICAiIiIKICAgICAgICBTZXR0aW5nIHBhcmFtZXRlcnMgZm9yIG5vbnN0YW5kYXJkIHNjaGVtZXMgaXMgYWxsb3dlZCBpZiB0aG9zZSBzY2hlbWVzCiAgICAgICAgYmVnaW4gd2l0aCAiaHR0cCIsIGFuZCBpcyBmb3JiaWRkZW4gb3RoZXJ3aXNlLgogICAgICAgICIiIgogICAgICAgIHIgPSByZXF1ZXN0cy5SZXF1ZXN0KCJHRVQiLCB1cmw9aW5wdXQsIHBhcmFtcz1wYXJhbXMpCiAgICAgICAgcCA9IHIucHJlcGFyZSgpCiAgICAgICAgYXNzZXJ0IHAudXJsID09IGV4cGVjdGVkCgogICAgZGVmIHRlc3RfcG9zdF9qc29uX25hbihzZWxmLCBodHRwYmluKToKICAgICAgICBkYXRhID0geyJmb28iOiBmbG9hdCgibmFuIil9CiAgICAgICAgd2l0aCBweXRlc3QucmFpc2VzKHJlcXVlc3RzLmV4Y2VwdGlvbnMuSW52YWxpZEpTT05FcnJvcik6CiAgICAgICAgICAgIHJlcXVlc3RzLnBvc3QoaHR0cGJpbigicG9zdCIpLCBqc29uPWRhdGEpCgogICAgZGVmIHRlc3RfanNvbl9kZWNvZGVfY29tcGF0aWJpbGl0eShzZWxmLCBodHRwYmluKToKICAgICAgICByID0gcmVxdWVzdHMuZ2V0KGh0dHBiaW4oImJ5dGVzLzIwIikpCiAgICAgICAgd2l0aCBweXRlc3QucmFpc2VzKHJlcXVlc3RzLmV4Y2VwdGlvbnMuSlNPTkRlY29kZUVycm9yKSBhcyBleGNpbmZvOgogICAgICAgICAgICByLmpzb24oKQogICAgICAgIGFzc2VydCBpc2luc3RhbmNlKGV4Y2luZm8udmFsdWUsIFJlcXVlc3RFeGNlcHRpb24pCiAgICAgICAgYXNzZXJ0IGlzaW5zdGFuY2UoZXhjaW5mby52YWx1ZSwgSlNPTkRlY29kZUVycm9yKQogICAgICAgIGFzc2VydCByLnRleHQgbm90IGluIHN0cihleGNpbmZvLnZhbHVlKQoKICAgIGRlZiB0ZXN0X2pzb25fZGVjb2RlX3BlcnNpc3RzX2RvY19hdHRyKHNlbGYsIGh0dHBiaW4pOgogICAgICAgIHIgPSByZXF1ZXN0cy5nZXQoaHR0cGJpbigiYnl0ZXMvMjAiKSkKICAgICAgICB3aXRoIHB5dGVzdC5yYWlzZXMocmVxdWVzdHMuZXhjZXB0aW9ucy5KU09ORGVjb2RlRXJyb3IpIGFzIGV4Y2luZm86CiAgICAgICAgICAgIHIuanNvbigpCiAgICAgICAgYXNzZXJ0IGV4Y2luZm8udmFsdWUuZG9jID09IHIudGV4dAo=
