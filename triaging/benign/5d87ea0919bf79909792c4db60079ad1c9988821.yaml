statistics:
  total_files: 1
  skipped_files: 0.0
  processed_objects: 1
  malicious_objects: 0
details:
- path: .repo_cache/malicious_repos/pypi_malregistry/awscl/1.27.67/awscl-1.27.67/awscl-1.27.67/awscli/customizations/cloudtrail/validation.py
  contents:
  - name: Sha256RSADigestValidator.validate
    score: 0.0
    code: |-
      def validate(self, bucket, key, public_key, digest_data, inflated_digest):
              """Validates a digest file.

              Throws a DigestError when the digest is invalid.

              :param bucket: Bucket of the digest file
              :param key: Key of the digest file
              :param public_key: Public key bytes.
              :param digest_data: Dict of digest data returned when JSON
                  decoding a manifest.
              :param inflated_digest: Inflated digest file contents as bytes.
              """
              try:
                  decoded_key = base64.b64decode(public_key)
                  public_key = rsa.PublicKey.load_pkcs1(decoded_key, format='DER')
                  to_sign = self._create_string_to_sign(digest_data, inflated_digest)
                  signature_bytes = binascii.unhexlify(digest_data['_signature'])
                  rsa.verify(to_sign, signature_bytes, public_key)
              except PyAsn1Error:
                  raise DigestError(
                      ('Digest file\ts3://%s/%s\tINVALID: Unable to load PKCS #1 key'
                       ' with fingerprint %s')
                      % (bucket, key, digest_data['digestPublicKeyFingerprint']))
              except rsa.pkcs1.VerificationError:
                  # Note from the Python-RSA docs: Never display the stack trace of
                  # a rsa.pkcs1.VerificationError exception. It shows where in the
                  # code the exception occurred, and thus leaks information about
                  # the key.
                  raise DigestSignatureError(bucket, key)
    tokens: resume nop load_global base64 load_attr ENCODING_DECODING load_fast public_key call store_fast decoded_key load_global rsa load_attr PublicKey load_attr load_pkcs1 load_fast decoded_key load_const DER kw_names format call store_fast public_key load_fast self load_attr STRING_LEN_S_ENT_HIGH load_fast digest_data load_fast inflated_digest call store_fast to_sign load_global binascii load_attr ENCODING_DECODING load_fast digest_data load_const _signature binary_subscr call store_fast signature_bytes load_global rsa load_attr verify load_fast to_sign load_fast signature_bytes load_fast public_key call pop_top return_const None push_exc_info load_global PyAsn1Error check_exc_match pop_jump_if_false TO_NUMBER pop_top load_global DigestError load_const STRING_FILE_PATH load_fast bucket format_value INTEGER load_const / load_fast key format_value INTEGER load_const STRING_LEN_S_ENT_HIGH load_fast digest_data load_const STRING_LEN_S_ENT_HIGH binary_subscr format_value INTEGER build_string call raise_varargs load_global rsa load_attr pkcs1 load_attr STRING_LEN_S_ENT_HIGH check_exc_match pop_jump_if_false TO_NUMBER pop_top load_global STRING_BASE64_LEN_S_ENT_HIGH load_fast bucket load_fast key call raise_varargs reraise copy pop_except reraise
    hash: 861a37882fce7608c838e9af99b97314258a86056a9878b807c9af2670317352
sources:
  ? .repo_cache/malicious_repos/pypi_malregistry/awscl/1.27.67/awscl-1.27.67/awscl-1.27.67/awscli/customizations/cloudtrail/validation.py
  : IyBDb3B5cmlnaHQgMjAxMi0yMDE1IEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuCiMKIyBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgIkxpY2Vuc2UiKS4gWW91CiMgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuIEEgY29weSBvZgojIHRoZSBMaWNlbnNlIGlzIGxvY2F0ZWQgYXQKIwojIGh0dHA6Ly9hd3MuYW1hem9uLmNvbS9hcGFjaGUyLjAvCiMKIyBvciBpbiB0aGUgImxpY2Vuc2UiIGZpbGUgYWNjb21wYW55aW5nIHRoaXMgZmlsZS4gVGhpcyBmaWxlIGlzCiMgZGlzdHJpYnV0ZWQgb24gYW4gIkFTIElTIiBCQVNJUywgV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YKIyBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4gU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMKIyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLgppbXBvcnQgYmFzZTY0CmltcG9ydCBiaW5hc2NpaQppbXBvcnQganNvbgppbXBvcnQgaGFzaGxpYgppbXBvcnQgbG9nZ2luZwppbXBvcnQgcmUKaW1wb3J0IHN5cwppbXBvcnQgemxpYgpmcm9tIHpsaWIgaW1wb3J0IGVycm9yIGFzIFpMaWJFcnJvcgpmcm9tIGRhdGV0aW1lIGltcG9ydCBkYXRldGltZSwgdGltZWRlbHRhCmZyb20gZGF0ZXV0aWwgaW1wb3J0IHR6LCBwYXJzZXIKCmZyb20gcHlhc24xLmVycm9yIGltcG9ydCBQeUFzbjFFcnJvcgppbXBvcnQgcnNhCgpmcm9tIGF3c2NsaS5jdXN0b21pemF0aW9ucy5jbG91ZHRyYWlsLnV0aWxzIGltcG9ydCBnZXRfdHJhaWxfYnlfYXJuLCBcCiAgICBnZXRfYWNjb3VudF9pZF9mcm9tX2Fybgpmcm9tIGF3c2NsaS5jdXN0b21pemF0aW9ucy5jb21tYW5kcyBpbXBvcnQgQmFzaWNDb21tYW5kCmZyb20gYm90b2NvcmUuZXhjZXB0aW9ucyBpbXBvcnQgQ2xpZW50RXJyb3IKZnJvbSBhd3NjbGkuc2NoZW1hIGltcG9ydCBQYXJhbWV0ZXJSZXF1aXJlZEVycm9yCgoKTE9HID0gbG9nZ2luZy5nZXRMb2dnZXIoX19uYW1lX18pCkRBVEVfRk9STUFUID0gJyVZJW0lZFQlSCVNJVNaJwpESVNQTEFZX0RBVEVfRk9STUFUID0gJyVZLSVtLSVkVCVIOiVNOiVTWicKCgpkZWYgZm9ybWF0X2RhdGUoZGF0ZSk6CiAgICAiIiJSZXR1cm5zIGEgZm9ybWF0dGVkIGRhdGUgc3RyaW5nIGluIGEgQ2xvdWRUcmFpbCBkYXRlIGZvcm1hdCIiIgogICAgcmV0dXJuIGRhdGUuc3RyZnRpbWUoREFURV9GT1JNQVQpCgoKZGVmIGZvcm1hdF9kaXNwbGF5X2RhdGUoZGF0ZSk6CiAgICAiIiJSZXR1cm5zIGEgZm9ybWF0dGVkIGRhdGUgc3RyaW5nIG1lYW50IGZvciBDTEkgb3V0cHV0IiIiCiAgICByZXR1cm4gZGF0ZS5zdHJmdGltZShESVNQTEFZX0RBVEVfRk9STUFUKQoKCmRlZiBub3JtYWxpemVfZGF0ZShkYXRlKToKICAgICIiIlJldHVybnMgYSBub3JtYWxpemVkIGRhdGUgdXNpbmcgYSBVVEMgdGltZXpvbmUiIiIKICAgIHJldHVybiBkYXRlLnJlcGxhY2UodHppbmZvPXR6LnR6dXRjKCkpCgoKZGVmIGV4dHJhY3RfZGlnZXN0X2tleV9kYXRlKGRpZ2VzdF9zM19rZXkpOgogICAgIiIiRXh0cmFjdCB0aGUgdGltZXN0YW1wIHBvcnRpb24gb2YgYSBtYW5pZmVzdCBmaWxlLgoKICAgIE1hbmlmZXN0IGZpbGUgbmFtZXMgdGFrZSB0aGUgZm9sbG93aW5nIGZvcm06CiAgICBBV1NMb2dzL3thY2NvdW50fS9DbG91ZFRyYWlsLURpZ2VzdC97cmVnaW9ufS97eW1kfS97YWNjb3VudH1fQ2xvdWRUcmFpbCBcCiAgICAtRGlnZXN0X3tyZWdpb259X3tuYW1lfV9yZWdpb25fe2RhdGV9Lmpzb24uZ3oKICAgICIiIgogICAgcmV0dXJuIGRpZ2VzdF9zM19rZXlbLTI0Oi04XQoKCmRlZiBwYXJzZV9kYXRlKGRhdGVfc3RyaW5nKToKICAgIHRyeToKICAgICAgICByZXR1cm4gcGFyc2VyLnBhcnNlKGRhdGVfc3RyaW5nKQogICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAgcmFpc2UgVmFsdWVFcnJvcignVW5hYmxlIHRvIHBhcnNlIGRhdGUgdmFsdWU6ICVzJyAlIGRhdGVfc3RyaW5nKQoKCmRlZiBhc3NlcnRfY2xvdWR0cmFpbF9hcm5faXNfdmFsaWQodHJhaWxfYXJuKToKICAgICIiIkVuc3VyZXMgdGhhdCB0aGUgYXJuIGxvb2tzIGNvcnJlY3QuCgogICAgQVJOcyBsb29rIGxpa2U6IGFybjphd3M6Y2xvdWR0cmFpbDp1cy1lYXN0LTE6MTIzNDU2Nzg5MDEyOnRyYWlsL2ZvbyIiIgogICAgcGF0dGVybiA9IHJlLmNvbXBpbGUoJ2FybjouKzpjbG91ZHRyYWlsOi4rOlxkezEyfTp0cmFpbC8uKycpCiAgICBpZiBub3QgcGF0dGVybi5tYXRjaCh0cmFpbF9hcm4pOgogICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoJ0ludmFsaWQgdHJhaWwgQVJOIHByb3ZpZGVkOiAlcycgJSB0cmFpbF9hcm4pCgoKZGVmIGNyZWF0ZV9kaWdlc3RfdHJhdmVyc2VyKGNsb3VkdHJhaWxfY2xpZW50LCBvcmdhbml6YXRpb25fY2xpZW50LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgczNfY2xpZW50X3Byb3ZpZGVyLCB0cmFpbF9hcm4sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cmFpbF9zb3VyY2VfcmVnaW9uPU5vbmUsIG9uX2ludmFsaWQ9Tm9uZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9uX2dhcD1Ob25lLCBvbl9taXNzaW5nPU5vbmUsIGJ1Y2tldD1Ob25lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJlZml4PU5vbmUsIGFjY291bnRfaWQ9Tm9uZSk6CiAgICAiIiJDcmVhdGVzIGEgQ2xvdWRUcmFpbCBEaWdlc3RUcmF2ZXJzZXIgYW5kIGl0cyBvYmplY3QgZ3JhcGguCgogICAgOnR5cGUgY2xvdWR0cmFpbF9jbGllbnQ6IGJvdG9jb3JlLmNsaWVudC5DbG91ZFRyYWlsCiAgICA6cGFyYW0gY2xvdWR0cmFpbF9jbGllbnQ6IENsaWVudCB1c2VkIHRvIGNvbm5lY3QgdG8gQ2xvdWRUcmFpbAogICAgOnR5cGUgb3JnYW5pemF0aW9uX2NsaWVudDogYm90b2NvcmUuY2xpZW50Lm9yZ2FuaXphdGlvbnMKICAgIDpwYXJhbSBvcmdhbml6YXRpb25fY2xpZW50OiBDbGllbnQgdXNlZCB0byBjb25uZWN0IHRvIE9yZ2FuaXphdGlvbnMKICAgIDp0eXBlIHMzX2NsaWVudF9wcm92aWRlcjogUzNDbGllbnRQcm92aWRlcgogICAgOnBhcmFtIHMzX2NsaWVudF9wcm92aWRlcjogVXNlZCB0byBjcmVhdGUgQW1hem9uIFMzIGNsaWVudCBwZXIvcmVnaW9uLgogICAgOnBhcmFtIHRyYWlsX2FybjogQ2xvdWRUcmFpbCB0cmFpbCBBUk4KICAgIDpwYXJhbSB0cmFpbF9zb3VyY2VfcmVnaW9uOiBUaGUgc2Nhbm5lZCByZWdpb24gb2YgYSB0cmFpbC4KICAgIDpwYXJhbSBvbl9pbnZhbGlkOiBDYWxsYmFjayB0aGF0IGlzIGludm9rZWQgd2hlbiB2YWxpZGF0aW5nIGEgZGlnZXN0IGZhaWxzLgogICAgOnBhcmFtIG9uX2dhcDogQ2FsbGJhY2sgdGhhdCBpcyBpbnZva2VkIHdoZW4gYSBkaWdlc3QgaGFzIG5vIGxpbmsgdG8gdGhlCiAgICAgICAgcHJldmlvdXMgZGlnZXN0LCBidXQgdGhlcmUgYXJlIG1vcmUgZGlnZXN0cyB0byB2YWxpZGF0ZS4gVGhpcyBjYW4KICAgICAgICBoYXBwZW4gd2hlbiBhIHRyYWlsIGlzIGRpc2FibGVkIGZvciBhIHBlcmlvZCBvZiB0aW1lLgogICAgOnBhcmFtIG9uX21pc3Npbmc6IENhbGxiYWNrIHRoYXQgaXMgaW52b2tlZCB3aGVuIGEgZGlnZXN0IGZpbGUgaGFzIGJlZW4KICAgICAgICBkZWxldGVkIGZyb20gQW1hem9uIFMzIGJ1dCBpcyBzdXBwb3NlZCB0byBiZSBwcmVzZW50LgogICAgOnBhcmFtIGJ1Y2tldDogQW1hem9uIFMzIGJ1Y2tldCBvZiB0aGUgdHJhaWwgaWYgaXQgaXMgZGlmZmVyZW50IHRoYW4gdGhlCiAgICAgICAgYnVja2V0IHRoYXQgaXMgY3VycmVudGx5IGFzc29jaWF0ZWQgd2l0aCB0aGUgdHJhaWwuCiAgICA6cGFyYW0gcHJlZml4OiBidWNrZXQ6IEtleSBwcmVmaXggcHJlcGVuZGVkIHRvIGVhY2ggZGlnZXN0IGFuZCBsb2cgcGxhY2VkCiAgICAgICAgaW4gdGhlIEFtYXpvbiBTMyBidWNrZXQgaWYgaXQgaXMgZGlmZmVyZW50IHRoYW4gdGhlIHByZWZpeCB0aGF0IGlzCiAgICAgICAgY3VycmVudGx5IGFzc29jaWF0ZWQgd2l0aCB0aGUgdHJhaWwuCiAgICA6cGFyYW0gYWNjb3VudF9pZDogVGhlIGFjY291bnQgaWQgZm9yIHdoaWNoIHRoZSBkaWdlc3QgZmlsZXMgYXJlCiAgICAgICAgdmFsaWRhdGVkLiBGb3Igbm9ybWFsIHRyYWlscyB0aGlzIGlzIHRoZSBjYWxsZXIgYWNjb3VudCwgZm9yCiAgICAgICAgb3JnYW5pemF0aW9uIHRyYWlscyBpdCBpcyB0aGUgbWVtYmVyIGFjY291dC4KCiAgICBgYG9uX2dhcGBgLCBgYG9uX2ludmFsaWRgYCwgYW5kIGBgb25fbWlzc2luZ2BgIGNhbGxiYWNrcyBhcmUgaW52b2tlZCB3aXRoCiAgICB0aGUgZm9sbG93aW5nIG5hbWVkIGFyZ3VtZW50czoKCiAgICAtIGBgYnVja2V0YDogVGhlIG5leHQgUzMgYnVja2V0LgogICAgLSBgYG5leHRfa2V5YGA6IChvcHRpb25hbCkgTmV4dCBkaWdlc3Qga2V5IHRoYXQgd2FzIGZvdW5kIGluIHRoZSBidWNrZXQuCiAgICAtIGBgbmV4dF9lbmRfZGF0ZWBgOiAob3B0aW9uYWwpIEVuZCBkYXRlIG9mIHRoZSBuZXh0IGZvdW5kIGRpZ2VzdC4KICAgIC0gYGBsYXN0X2tleWBgOiBUaGUgbGFzdCBkaWdlc3Qga2V5IHRoYXQgd2FzIGZvdW5kLgogICAgLSBgYGxhc3Rfc3RhcnRfZGF0ZWBgOiAob3B0aW9uYWwpIFN0YXJ0IGRhdGUgb2YgbGFzdCBmb3VuZCBkaWdlc3QuCiAgICAtIGBgbWVzc2FnZWBgOiAob3B0aW9uYWwpIE1lc3NhZ2Ugc3RyaW5nIGFib3V0IHRoZSBub3RpZmljYXRpb24uCiAgICAiIiIKICAgIGFzc2VydF9jbG91ZHRyYWlsX2Fybl9pc192YWxpZCh0cmFpbF9hcm4pCiAgICBvcmdhbml6YXRpb25faWQgPSBOb25lCiAgICBpZiBidWNrZXQgaXMgTm9uZToKICAgICAgICAjIERldGVybWluZSB0aGUgYnVja2V0IGFuZCBwcmVmaXggYmFzZWQgb24gdGhlIHRyYWlsIGFybi4KICAgICAgICB0cmFpbF9pbmZvID0gZ2V0X3RyYWlsX2J5X2FybihjbG91ZHRyYWlsX2NsaWVudCwgdHJhaWxfYXJuKQogICAgICAgIExPRy5kZWJ1ZygnTG9hZGVkIHRyYWlsIGluZm86ICVzJywgdHJhaWxfaW5mbykKICAgICAgICBidWNrZXQgPSB0cmFpbF9pbmZvWydTM0J1Y2tldE5hbWUnXQogICAgICAgIHByZWZpeCA9IHRyYWlsX2luZm8uZ2V0KCdTM0tleVByZWZpeCcsIE5vbmUpCiAgICAgICAgaXNfb3JnX3RyYWlsID0gdHJhaWxfaW5mby5nZXQoJ0lzT3JnYW5pemF0aW9uVHJhaWwnKQogICAgICAgIGlmIGlzX29yZ190cmFpbDoKICAgICAgICAgICAgaWYgbm90IGFjY291bnRfaWQ6CiAgICAgICAgICAgICAgICByYWlzZSBQYXJhbWV0ZXJSZXF1aXJlZEVycm9yKAogICAgICAgICAgICAgICAgICAgICJNaXNzaW5nIHJlcXVpcmVkIHBhcmFtZXRlciBmb3Igb3JnYW5pemF0aW9uICIKICAgICAgICAgICAgICAgICAgICAidHJhaWw6ICctLWFjY291bnQtaWQnIikKICAgICAgICAgICAgb3JnYW5pemF0aW9uX2lkID0gb3JnYW5pemF0aW9uX2NsaWVudC5kZXNjcmliZV9vcmdhbml6YXRpb24oKVsKICAgICAgICAgICAgICAgICdPcmdhbml6YXRpb24nXVsnSWQnXQoKICAgICMgRGV0ZXJtaW5lIHRoZSByZWdpb24gZnJvbSB0aGUgQVJOIChlLmcuLCBhcm46YXdzOmNsb3VkdHJhaWw6UkVHSU9OOi4uLikKICAgIHRyYWlsX3JlZ2lvbiA9IHRyYWlsX2Fybi5zcGxpdCgnOicpWzNdCiAgICAjIERldGVybWluZSB0aGUgbmFtZSBmcm9tIHRoZSBBUk4gKHRoZSBsYXN0IHBhcnQgYWZ0ZXIgIi8iKQogICAgdHJhaWxfbmFtZSA9IHRyYWlsX2Fybi5zcGxpdCgnLycpWy0xXQogICAgIyBJZiBhY2NvdW50IGlkIGlzIG5vdCBzcGVjaWZpZWQgcGFyc2UgaXQgZnJvbSB0cmFpbCBBUk4KICAgIGlmIG5vdCBhY2NvdW50X2lkOgogICAgICAgIGFjY291bnRfaWQgPSBnZXRfYWNjb3VudF9pZF9mcm9tX2Fybih0cmFpbF9hcm4pCgogICAgZGlnZXN0X3Byb3ZpZGVyID0gRGlnZXN0UHJvdmlkZXIoCiAgICAgICAgYWNjb3VudF9pZD1hY2NvdW50X2lkLCB0cmFpbF9uYW1lPXRyYWlsX25hbWUsCiAgICAgICAgczNfY2xpZW50X3Byb3ZpZGVyPXMzX2NsaWVudF9wcm92aWRlciwKICAgICAgICB0cmFpbF9zb3VyY2VfcmVnaW9uPXRyYWlsX3NvdXJjZV9yZWdpb24sCiAgICAgICAgdHJhaWxfaG9tZV9yZWdpb249dHJhaWxfcmVnaW9uLAogICAgICAgIG9yZ2FuaXphdGlvbl9pZD1vcmdhbml6YXRpb25faWQpCiAgICByZXR1cm4gRGlnZXN0VHJhdmVyc2VyKAogICAgICAgIGRpZ2VzdF9wcm92aWRlcj1kaWdlc3RfcHJvdmlkZXIsIHN0YXJ0aW5nX2J1Y2tldD1idWNrZXQsCiAgICAgICAgc3RhcnRpbmdfcHJlZml4PXByZWZpeCwgb25faW52YWxpZD1vbl9pbnZhbGlkLCBvbl9nYXA9b25fZ2FwLAogICAgICAgIG9uX21pc3Npbmc9b25fbWlzc2luZywKICAgICAgICBwdWJsaWNfa2V5X3Byb3ZpZGVyPVB1YmxpY0tleVByb3ZpZGVyKGNsb3VkdHJhaWxfY2xpZW50KSkKCgpjbGFzcyBTM0NsaWVudFByb3ZpZGVyKG9iamVjdCk6CiAgICAiIiJDcmVhdGVzIEFtYXpvbiBTMyBjbGllbnRzIGFuZCBkZXRlcm1pbmVzIHRoZSByZWdpb24gbmFtZSBvZiBhIGNsaWVudC4KCiAgICBUaGlzIGNsYXNzIHdpbGwgY2FjaGUgdGhlIGxvY2F0aW9uIGNvbnN0cmFpbnRzIG9mIHByZXZpb3VzbHkgcmVxdWVzdGVkCiAgICBidWNrZXRzIGFuZCBjYWNoZSBwcmV2aW91c2x5IGNyZWF0ZWQgY2xpZW50cyBmb3IgdGhlIHNhbWUgcmVnaW9uLgogICAgIiIiCiAgICBkZWYgX19pbml0X18oc2VsZiwgc2Vzc2lvbiwgZ2V0X2J1Y2tldF9sb2NhdGlvbl9yZWdpb249J3VzLWVhc3QtMScpOgogICAgICAgIHNlbGYuX3Nlc3Npb24gPSBzZXNzaW9uCiAgICAgICAgc2VsZi5fZ2V0X2J1Y2tldF9sb2NhdGlvbl9yZWdpb24gPSBnZXRfYnVja2V0X2xvY2F0aW9uX3JlZ2lvbgogICAgICAgIHNlbGYuX2NsaWVudF9jYWNoZSA9IHt9CiAgICAgICAgc2VsZi5fcmVnaW9uX2NhY2hlID0ge30KCiAgICBkZWYgZ2V0X2NsaWVudChzZWxmLCBidWNrZXRfbmFtZSk6CiAgICAgICAgIiIiQ3JlYXRlcyBhbiBTMyBjbGllbnQgdGhhdCBjYW4gd29yayB3aXRoIHRoZSBnaXZlbiBidWNrZXQgbmFtZSIiIgogICAgICAgIHJlZ2lvbl9uYW1lID0gc2VsZi5fZ2V0X2J1Y2tldF9yZWdpb24oYnVja2V0X25hbWUpCiAgICAgICAgcmV0dXJuIHNlbGYuX2NyZWF0ZV9jbGllbnQocmVnaW9uX25hbWUpCgogICAgZGVmIF9nZXRfYnVja2V0X3JlZ2lvbihzZWxmLCBidWNrZXRfbmFtZSk6CiAgICAgICAgIiIiUmV0dXJucyB0aGUgcmVnaW9uIG9mIGEgYnVja2V0IiIiCiAgICAgICAgaWYgYnVja2V0X25hbWUgbm90IGluIHNlbGYuX3JlZ2lvbl9jYWNoZToKICAgICAgICAgICAgY2xpZW50ID0gc2VsZi5fY3JlYXRlX2NsaWVudChzZWxmLl9nZXRfYnVja2V0X2xvY2F0aW9uX3JlZ2lvbikKICAgICAgICAgICAgcmVzdWx0ID0gY2xpZW50LmdldF9idWNrZXRfbG9jYXRpb24oQnVja2V0PWJ1Y2tldF9uYW1lKQogICAgICAgICAgICByZWdpb24gPSByZXN1bHRbJ0xvY2F0aW9uQ29uc3RyYWludCddIG9yICd1cy1lYXN0LTEnCiAgICAgICAgICAgIHNlbGYuX3JlZ2lvbl9jYWNoZVtidWNrZXRfbmFtZV0gPSByZWdpb24KICAgICAgICByZXR1cm4gc2VsZi5fcmVnaW9uX2NhY2hlW2J1Y2tldF9uYW1lXQoKICAgIGRlZiBfY3JlYXRlX2NsaWVudChzZWxmLCByZWdpb25fbmFtZSk6CiAgICAgICAgIiIiQ3JlYXRlcyBhbiBBbWF6b24gUzMgY2xpZW50IGZvciB0aGUgZ2l2ZW4gcmVnaW9uIG5hbWUiIiIKICAgICAgICBpZiByZWdpb25fbmFtZSBub3QgaW4gc2VsZi5fY2xpZW50X2NhY2hlOgogICAgICAgICAgICBjbGllbnQgPSBzZWxmLl9zZXNzaW9uLmNyZWF0ZV9jbGllbnQoJ3MzJywgcmVnaW9uX25hbWUpCiAgICAgICAgICAgICMgUmVtb3ZlIHRoZSBDTEkgZXJyb3IgZXZlbnQgdGhhdCBwcmV2ZW50cyBleGNlcHRpb25zLgogICAgICAgICAgICBzZWxmLl9jbGllbnRfY2FjaGVbcmVnaW9uX25hbWVdID0gY2xpZW50CiAgICAgICAgcmV0dXJuIHNlbGYuX2NsaWVudF9jYWNoZVtyZWdpb25fbmFtZV0KCgpjbGFzcyBEaWdlc3RFcnJvcihWYWx1ZUVycm9yKToKICAgICIiIkV4Y2VwdGlvbiByYWlzZWQgd2hlbiBhIGRpZ2VzdCBmYWlscyB0byB2YWxpZGF0ZSIiIgogICAgcGFzcwoKCmNsYXNzIERpZ2VzdFNpZ25hdHVyZUVycm9yKERpZ2VzdEVycm9yKToKICAgICIiIkV4Y2VwdGlvbiByYWlzZWQgd2hlbiBhIGRpZ2VzdCBzaWduYXR1cmUgaXMgaW52YWxpZCIiIgogICAgZGVmIF9faW5pdF9fKHNlbGYsIGJ1Y2tldCwga2V5KToKICAgICAgICBtZXNzYWdlID0gKCdEaWdlc3QgZmlsZVx0czM6Ly8lcy8lc1x0SU5WQUxJRDogc2lnbmF0dXJlIHZlcmlmaWNhdGlvbiAnCiAgICAgICAgICAgICAgICAgICAnZmFpbGVkJykgJSAoYnVja2V0LCBrZXkpCiAgICAgICAgc3VwZXIoRGlnZXN0U2lnbmF0dXJlRXJyb3IsIHNlbGYpLl9faW5pdF9fKG1lc3NhZ2UpCgoKY2xhc3MgSW52YWxpZERpZ2VzdEZvcm1hdChEaWdlc3RFcnJvcik6CiAgICAiIiJFeGNlcHRpb24gcmFpc2VkIHdoZW4gYSBkaWdlc3QgaGFzIGFuIGludmFsaWQgZm9ybWF0IiIiCiAgICBkZWYgX19pbml0X18oc2VsZiwgYnVja2V0LCBrZXkpOgogICAgICAgIG1lc3NhZ2UgPSAnRGlnZXN0IGZpbGVcdHMzOi8vJXMvJXNcdElOVkFMSUQ6IGludmFsaWQgZm9ybWF0JyAlIChidWNrZXQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtleSkKICAgICAgICBzdXBlcihJbnZhbGlkRGlnZXN0Rm9ybWF0LCBzZWxmKS5fX2luaXRfXyhtZXNzYWdlKQoKCmNsYXNzIFB1YmxpY0tleVByb3ZpZGVyKG9iamVjdCk6CiAgICAiIiJSZXRyaWV2ZXMgcHVibGljIGtleXMgZnJvbSBDbG91ZFRyYWlsIHdpdGhpbiBhIGRhdGUgcmFuZ2UuIiIiCiAgICBkZWYgX19pbml0X18oc2VsZiwgY2xvdWR0cmFpbF9jbGllbnQpOgogICAgICAgIHNlbGYuX2Nsb3VkdHJhaWxfY2xpZW50ID0gY2xvdWR0cmFpbF9jbGllbnQKCiAgICBkZWYgZ2V0X3B1YmxpY19rZXlzKHNlbGYsIHN0YXJ0X2RhdGUsIGVuZF9kYXRlKToKICAgICAgICAiIiJMb2FkcyBwdWJsaWMga2V5cyBpbiBhIGRhdGUgcmFuZ2UgaW50byBhIHJldHVybmVkIGRpY3QuCgogICAgICAgIDp0eXBlIHN0YXJ0X2RhdGU6IGRhdGV0aW1lCiAgICAgICAgOnBhcmFtIHN0YXJ0X2RhdGU6IFN0YXJ0IGRhdGUgb2YgYSBkYXRlIHJhbmdlLgogICAgICAgIDp0eXBlIGVuZF9kYXRlOiBkYXRldGltZQogICAgICAgIDpwYXJhbSBlbmRfZGF0ZTogRW5kIGRhdGUgb2YgYSBkYXRlIHJhbmdlLgogICAgICAgIDpydHlwZTogZGljdAogICAgICAgIDpyZXR1cm46IFJldHVybnMgYSBkaWN0IHdoZXJlIGVhY2gga2V5IGlzIHRoZSBmaW5nZXJwcmludCBvZiB0aGUKICAgICAgICAgICAgcHVibGljIGtleSwgYW5kIGVhY2ggdmFsdWUgaXMgYSBkaWN0IG9mIHB1YmxpYyBrZXkgZGF0YS4KICAgICAgICAiIiIKICAgICAgICBwdWJsaWNfa2V5cyA9IHNlbGYuX2Nsb3VkdHJhaWxfY2xpZW50Lmxpc3RfcHVibGljX2tleXMoCiAgICAgICAgICAgIFN0YXJ0VGltZT1zdGFydF9kYXRlLCBFbmRUaW1lPWVuZF9kYXRlKQogICAgICAgIHB1YmxpY19rZXlzX2luX3JhbmdlID0gcHVibGljX2tleXNbJ1B1YmxpY0tleUxpc3QnXQogICAgICAgIExPRy5kZWJ1ZygnTG9hZGVkIHB1YmxpYyBrZXlzIGluIHJhbmdlOiAlcycsIHB1YmxpY19rZXlzX2luX3JhbmdlKQogICAgICAgIHJldHVybiBkaWN0KChrZXlbJ0ZpbmdlcnByaW50J10sIGtleSkgZm9yIGtleSBpbiBwdWJsaWNfa2V5c19pbl9yYW5nZSkKCgpjbGFzcyBEaWdlc3RQcm92aWRlcihvYmplY3QpOgogICAgIiIiCiAgICBSZXRyaWV2ZXMgZGlnZXN0IGtleXMgYW5kIGRpZ2VzdHMgZnJvbSBBbWF6b24gUzMuCgogICAgVGhpcyBjbGFzcyBpcyByZXNwb25zaWJsZSBmb3IgZGV0ZXJtaW5pbmcgdGhlIGZ1bGwgbGlzdCBvZiBkaWdlc3QgZmlsZXMKICAgIGluIGEgYnVja2V0IGFuZCBsb2FkaW5nIGRpZ2VzdHMgZnJvbSB0aGUgYnVja2V0IGludG8gYSBKU09OIGRlY29kZWQKICAgIGRpY3QuIFRoaXMgY2xhc3MgaXMgbm90IHJlc3BvbnNpYmxlIGZvciB2YWxpZGF0aW9uIG9yIGl0ZXJhdGluZyBmcm9tCiAgICBvbmUgZGlnZXN0IHRvIHRoZSBuZXh0LgogICAgIiIiCiAgICBkZWYgX19pbml0X18oc2VsZiwgczNfY2xpZW50X3Byb3ZpZGVyLCBhY2NvdW50X2lkLCB0cmFpbF9uYW1lLAogICAgICAgICAgICAgICAgIHRyYWlsX2hvbWVfcmVnaW9uLCB0cmFpbF9zb3VyY2VfcmVnaW9uPU5vbmUsCiAgICAgICAgICAgICAgICAgb3JnYW5pemF0aW9uX2lkPU5vbmUpOgogICAgICAgIHNlbGYuX2NsaWVudF9wcm92aWRlciA9IHMzX2NsaWVudF9wcm92aWRlcgogICAgICAgIHNlbGYudHJhaWxfbmFtZSA9IHRyYWlsX25hbWUKICAgICAgICBzZWxmLmFjY291bnRfaWQgPSBhY2NvdW50X2lkCiAgICAgICAgc2VsZi50cmFpbF9ob21lX3JlZ2lvbiA9IHRyYWlsX2hvbWVfcmVnaW9uCiAgICAgICAgc2VsZi50cmFpbF9zb3VyY2VfcmVnaW9uID0gdHJhaWxfc291cmNlX3JlZ2lvbiBvciB0cmFpbF9ob21lX3JlZ2lvbgogICAgICAgIHNlbGYub3JnYW5pemF0aW9uX2lkID0gb3JnYW5pemF0aW9uX2lkCgogICAgZGVmIGxvYWRfZGlnZXN0X2tleXNfaW5fcmFuZ2Uoc2VsZiwgYnVja2V0LCBwcmVmaXgsIHN0YXJ0X2RhdGUsIGVuZF9kYXRlKToKICAgICAgICAiIiJSZXR1cm5zIGEgbGlzdCBvZiBkaWdlc3Qga2V5cyBpbiB0aGUgZGF0ZSByYW5nZS4KCiAgICAgICAgVGhpcyBtZXRob2QgdXNlcyBhIGxpc3Rfb2JqZWN0cyBBUEkgY2FsbCBhbmQgcHJvdmlkZXMgYSBNYXJrZXIKICAgICAgICBwYXJhbWV0ZXIgdGhhdCBpcyBjYWxjdWxhdGVkIGJhc2VkIG9uIHRoZSBzdGFydF9kYXRlIHByb3ZpZGVkLgogICAgICAgIEFtYXpvbiBTMyB0aGVuIHJldHVybnMgYWxsIGtleXMgaW4gdGhlIGJ1Y2tldCB0aGF0IHN0YXJ0IGFmdGVyCiAgICAgICAgdGhlIGdpdmVuIGtleSAobm9uLWluY2x1c2l2ZSkuIFdlIHRoZW4gaXRlcmF0ZSBvdmVyIHRoZSBrZXlzCiAgICAgICAgdW50aWwgdGhlIGRhdGUgZXh0cmFjdGVkIGZyb20gdGhlIHlpZWxkZWQga2V5cyBpcyBncmVhdGVyIHRoYW4KICAgICAgICB0aGUgZ2l2ZW4gZW5kX2RhdGUuCiAgICAgICAgIiIiCiAgICAgICAgZGlnZXN0cyA9IFtdCiAgICAgICAgbWFya2VyID0gc2VsZi5fY3JlYXRlX2RpZ2VzdF9rZXkoc3RhcnRfZGF0ZSwgcHJlZml4KQogICAgICAgIGNsaWVudCA9IHNlbGYuX2NsaWVudF9wcm92aWRlci5nZXRfY2xpZW50KGJ1Y2tldCkKICAgICAgICBwYWdpbmF0b3IgPSBjbGllbnQuZ2V0X3BhZ2luYXRvcignbGlzdF9vYmplY3RzJykKICAgICAgICBwYWdlX2l0ZXJhdG9yID0gcGFnaW5hdG9yLnBhZ2luYXRlKEJ1Y2tldD1idWNrZXQsIE1hcmtlcj1tYXJrZXIpCiAgICAgICAga2V5X2ZpbHRlciA9IHBhZ2VfaXRlcmF0b3Iuc2VhcmNoKCdDb250ZW50c1sqXS5LZXknKQogICAgICAgICMgQ3JlYXRlIGEgdGFyZ2V0IHN0YXJ0IGVuZCBlbmQgZGF0ZQogICAgICAgIHRhcmdldF9zdGFydF9kYXRlID0gZm9ybWF0X2RhdGUobm9ybWFsaXplX2RhdGUoc3RhcnRfZGF0ZSkpCiAgICAgICAgIyBBZGQgb25lIGhvdXIgdG8gdGhlIGVuZF9kYXRlIHRvIGdldCBsb2dzIHRoYXQgc3BpbGxlZCBvdmVyIHRvIG5leHQuCiAgICAgICAgdGFyZ2V0X2VuZF9kYXRlID0gZm9ybWF0X2RhdGUoCiAgICAgICAgICAgIG5vcm1hbGl6ZV9kYXRlKGVuZF9kYXRlICsgdGltZWRlbHRhKGhvdXJzPTEpKSkKICAgICAgICAjIEVuc3VyZSBkaWdlc3RzIGFyZSBmcm9tIHRoZSBzYW1lIHRyYWlsLgogICAgICAgIGRpZ2VzdF9rZXlfcmVnZXggPSByZS5jb21waWxlKHNlbGYuX2NyZWF0ZV9kaWdlc3Rfa2V5X3JlZ2V4KHByZWZpeCkpCiAgICAgICAgZm9yIGtleSBpbiBrZXlfZmlsdGVyOgogICAgICAgICAgICBpZiBkaWdlc3Rfa2V5X3JlZ2V4Lm1hdGNoKGtleSk6CiAgICAgICAgICAgICAgICAjIFVzZSBhIGxleGljb2dyYXBoaWMgY29tcGFyaXNvbiB0byBrbm93IHdoZW4gdG8gc3RvcC4KICAgICAgICAgICAgICAgIGV4dHJhY3RlZF9kYXRlID0gZXh0cmFjdF9kaWdlc3Rfa2V5X2RhdGUoa2V5KQogICAgICAgICAgICAgICAgaWYgZXh0cmFjdGVkX2RhdGUgPiB0YXJnZXRfZW5kX2RhdGU6CiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICMgT25seSBhcHBlbmQgZGlnZXN0cyBhZnRlciB0aGUgc3RhcnQgZGF0ZS4KICAgICAgICAgICAgICAgIGlmIGV4dHJhY3RlZF9kYXRlID49IHRhcmdldF9zdGFydF9kYXRlOgogICAgICAgICAgICAgICAgICAgIGRpZ2VzdHMuYXBwZW5kKGtleSkKICAgICAgICByZXR1cm4gZGlnZXN0cwoKICAgIGRlZiBmZXRjaF9kaWdlc3Qoc2VsZiwgYnVja2V0LCBrZXkpOgogICAgICAgICIiIkxvYWRzIGEgZGlnZXN0IGJ5IGtleSBmcm9tIFMzLgoKICAgICAgICBSZXR1cm5zIHRoZSBKU09OIGRlY29kZSBkYXRhIGFuZCBHWklQIGluZmxhdGVkIHJhdyBjb250ZW50LgogICAgICAgICIiIgogICAgICAgIGNsaWVudCA9IHNlbGYuX2NsaWVudF9wcm92aWRlci5nZXRfY2xpZW50KGJ1Y2tldCkKICAgICAgICByZXN1bHQgPSBjbGllbnQuZ2V0X29iamVjdChCdWNrZXQ9YnVja2V0LCBLZXk9a2V5KQogICAgICAgIHRyeToKICAgICAgICAgICAgZGlnZXN0ID0gemxpYi5kZWNvbXByZXNzKHJlc3VsdFsnQm9keSddLnJlYWQoKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHpsaWIuTUFYX1dCSVRTIHwgMTYpCiAgICAgICAgICAgIGRpZ2VzdF9kYXRhID0ganNvbi5sb2FkcyhkaWdlc3QuZGVjb2RlKCkpCiAgICAgICAgZXhjZXB0IChWYWx1ZUVycm9yLCBaTGliRXJyb3IpOgogICAgICAgICAgICAjIENhbm5vdCBnemlwIGRlY29kZSBvciBKU09OIHBhcnNlLgogICAgICAgICAgICByYWlzZSBJbnZhbGlkRGlnZXN0Rm9ybWF0KGJ1Y2tldCwga2V5KQogICAgICAgICMgQWRkIHRoZSBleHBlY3RlZCBkaWdlc3Qgc2lnbmF0dXJlIGFuZCBhbGdvcml0aG0gdG8gdGhlIGRpY3QuCiAgICAgICAgaWYgJ3NpZ25hdHVyZScgbm90IGluIHJlc3VsdFsnTWV0YWRhdGEnXSBcCiAgICAgICAgICAgICAgICBvciAnc2lnbmF0dXJlLWFsZ29yaXRobScgbm90IGluIHJlc3VsdFsnTWV0YWRhdGEnXToKICAgICAgICAgICAgcmFpc2UgRGlnZXN0U2lnbmF0dXJlRXJyb3IoYnVja2V0LCBrZXkpCiAgICAgICAgZGlnZXN0X2RhdGFbJ19zaWduYXR1cmUnXSA9IHJlc3VsdFsnTWV0YWRhdGEnXVsnc2lnbmF0dXJlJ10KICAgICAgICBkaWdlc3RfZGF0YVsnX3NpZ25hdHVyZV9hbGdvcml0aG0nXSA9IFwKICAgICAgICAgICAgcmVzdWx0WydNZXRhZGF0YSddWydzaWduYXR1cmUtYWxnb3JpdGhtJ10KICAgICAgICByZXR1cm4gZGlnZXN0X2RhdGEsIGRpZ2VzdAoKICAgIGRlZiBfY3JlYXRlX2RpZ2VzdF9rZXkoc2VsZiwgc3RhcnRfZGF0ZSwga2V5X3ByZWZpeCk6CiAgICAgICAgIiIiQ29tcHV0ZXMgYW4gQW1hem9uIFMzIGtleSBiYXNlZCBvbiB0aGUgcHJvdmlkZWQgZGF0YS4KCiAgICAgICAgVGhlIGNvbXB1dGVkIGlzIHdoYXQgd291bGQgaGF2ZSBiZWVuIHBsYWNlZCBpbiB0aGUgUzMgYnVja2V0IGlmCiAgICAgICAgYSBsb2cgZGlnZXN0IHdlcmUgY3JlYXRlZCBhdCBhIHNwZWNpZmljIHRpbWUuIFRoaXMgY29tcHV0ZWQga2V5CiAgICAgICAgZG9lcyBub3QgaGF2ZSB0byBhY3R1YWxseSBleGlzdCBhcyBpdCB3aWxsIG9ubHkgYmUgdXNlZCB0byBhcwogICAgICAgIGEgTWFya2VyIHBhcmFtZXRlciBpbiBhIGxpc3Rfb2JqZWN0cyBjYWxsLgoKICAgICAgICA6cmV0dXJuOiBSZXR1cm5zIGEgY29tcHV0ZWQga2V5IGFzIGEgc3RyaW5nLgogICAgICAgICIiIgogICAgICAgICMgU3VidHJhY3Qgb25lIG1pbnV0ZSB0byBlbnN1cmUgdGhlIGRhdGVzIGFyZSBpbmNsdXNpdmUuCiAgICAgICAgZGF0ZSA9IHN0YXJ0X2RhdGUgLSB0aW1lZGVsdGEobWludXRlcz0xKQogICAgICAgIHRlbXBsYXRlID0gJ0FXU0xvZ3MvJwogICAgICAgIHRlbXBsYXRlX3BhcmFtcyA9IHsKICAgICAgICAgICAgJ2FjY291bnRfaWQnOiBzZWxmLmFjY291bnRfaWQsCiAgICAgICAgICAgICdkYXRlJzogZm9ybWF0X2RhdGUoZGF0ZSksCiAgICAgICAgICAgICd5bWQnOiBkYXRlLnN0cmZ0aW1lKCclWS8lbS8lZCcpLAogICAgICAgICAgICAnc291cmNlX3JlZ2lvbic6IHNlbGYudHJhaWxfc291cmNlX3JlZ2lvbiwKICAgICAgICAgICAgJ2hvbWVfcmVnaW9uJzogc2VsZi50cmFpbF9ob21lX3JlZ2lvbiwKICAgICAgICAgICAgJ25hbWUnOiBzZWxmLnRyYWlsX25hbWUKICAgICAgICB9CiAgICAgICAgaWYgc2VsZi5vcmdhbml6YXRpb25faWQ6CiAgICAgICAgICAgIHRlbXBsYXRlICs9ICd7b3JnYW5pemF0aW9uX2lkfS8nCiAgICAgICAgICAgIHRlbXBsYXRlX3BhcmFtc1snb3JnYW5pemF0aW9uX2lkJ10gPSBzZWxmLm9yZ2FuaXphdGlvbl9pZAogICAgICAgIHRlbXBsYXRlICs9ICgKICAgICAgICAgICAgJ3thY2NvdW50X2lkfS9DbG91ZFRyYWlsLURpZ2VzdC97c291cmNlX3JlZ2lvbn0vJwogICAgICAgICAgICAne3ltZH0ve2FjY291bnRfaWR9X0Nsb3VkVHJhaWwtRGlnZXN0X3tzb3VyY2VfcmVnaW9ufV97bmFtZX1fJwogICAgICAgICAgICAne2hvbWVfcmVnaW9ufV97ZGF0ZX0uanNvbi5neicKICAgICAgICApCiAgICAgICAga2V5ID0gdGVtcGxhdGUuZm9ybWF0KCoqdGVtcGxhdGVfcGFyYW1zKQogICAgICAgIGlmIGtleV9wcmVmaXg6CiAgICAgICAgICAgIGtleSA9IGtleV9wcmVmaXggKyAnLycgKyBrZXkKICAgICAgICByZXR1cm4ga2V5CgogICAgZGVmIF9jcmVhdGVfZGlnZXN0X2tleV9yZWdleChzZWxmLCBrZXlfcHJlZml4KToKICAgICAgICAiIiJDcmVhdGVzIGEgcmVndWxhciBleHByZXNzaW9uIHVzZWQgdG8gbWF0Y2ggYWdhaW5zdCBTMyBrZXlzIiIiCiAgICAgICAgdGVtcGxhdGUgPSAnQVdTTG9ncy8nCiAgICAgICAgdGVtcGxhdGVfcGFyYW1zID0gewogICAgICAgICAgICAnYWNjb3VudF9pZCc6IHJlLmVzY2FwZShzZWxmLmFjY291bnRfaWQpLAogICAgICAgICAgICAnc291cmNlX3JlZ2lvbic6IHJlLmVzY2FwZShzZWxmLnRyYWlsX3NvdXJjZV9yZWdpb24pLAogICAgICAgICAgICAnaG9tZV9yZWdpb24nOiByZS5lc2NhcGUoc2VsZi50cmFpbF9ob21lX3JlZ2lvbiksCiAgICAgICAgICAgICduYW1lJzogcmUuZXNjYXBlKHNlbGYudHJhaWxfbmFtZSkKICAgICAgICB9CiAgICAgICAgaWYgc2VsZi5vcmdhbml6YXRpb25faWQ6CiAgICAgICAgICAgIHRlbXBsYXRlICs9ICd7b3JnYW5pemF0aW9uX2lkfS8nCiAgICAgICAgICAgIHRlbXBsYXRlX3BhcmFtc1snb3JnYW5pemF0aW9uX2lkJ10gPSBzZWxmLm9yZ2FuaXphdGlvbl9pZAogICAgICAgIHRlbXBsYXRlICs9ICgKICAgICAgICAgICAgJ3thY2NvdW50X2lkfS9DbG91ZFRyYWlsXFwtRGlnZXN0L3tzb3VyY2VfcmVnaW9ufS8nCiAgICAgICAgICAgICdcXGQrL1xcZCsvXFxkKy97YWNjb3VudF9pZH1fQ2xvdWRUcmFpbFxcLURpZ2VzdF8nCiAgICAgICAgICAgICd7c291cmNlX3JlZ2lvbn1fe25hbWV9X3tob21lX3JlZ2lvbn1fLitcXC5qc29uXFwuZ3onCiAgICAgICAgKQogICAgICAgIGtleSA9IHRlbXBsYXRlLmZvcm1hdCgqKnRlbXBsYXRlX3BhcmFtcykKICAgICAgICBpZiBrZXlfcHJlZml4OgogICAgICAgICAgICBrZXkgPSByZS5lc2NhcGUoa2V5X3ByZWZpeCkgKyAnLycgKyBrZXkKICAgICAgICByZXR1cm4gJ14nICsga2V5ICsgJyQnCgoKY2xhc3MgRGlnZXN0VHJhdmVyc2VyKG9iamVjdCk6CiAgICAiIiJSZXRyaWV2ZXMgYW5kIHZhbGlkYXRlcyBkaWdlc3RzIHdpdGhpbiBhIGRhdGUgcmFuZ2UuIiIiCiAgICAjIFRoZXNlIGtleXMgYXJlIHJlcXVpcmVkIHRvIGJlIHByZXNlbnQgYmVmb3JlIHZhbGlkYXRpbmcgdGhlIGNvbnRlbnRzCiAgICAjIG9mIGEgZGlnZXN0LgogICAgcmVxdWlyZWRfZGlnZXN0X2tleXMgPSBbJ2RpZ2VzdFB1YmxpY0tleUZpbmdlcnByaW50JywgJ2RpZ2VzdFMzQnVja2V0JywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICdkaWdlc3RTM09iamVjdCcsICdwcmV2aW91c0RpZ2VzdFNpZ25hdHVyZScsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnZGlnZXN0RW5kVGltZScsICdkaWdlc3RTdGFydFRpbWUnXQoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBkaWdlc3RfcHJvdmlkZXIsIHN0YXJ0aW5nX2J1Y2tldCwgc3RhcnRpbmdfcHJlZml4LAogICAgICAgICAgICAgICAgIHB1YmxpY19rZXlfcHJvdmlkZXIsIGRpZ2VzdF92YWxpZGF0b3I9Tm9uZSwKICAgICAgICAgICAgICAgICBvbl9pbnZhbGlkPU5vbmUsIG9uX2dhcD1Ob25lLCBvbl9taXNzaW5nPU5vbmUpOgogICAgICAgICIiIgogICAgICAgIDp0eXBlIGRpZ2VzdF9wcm92aWRlcjogRGlnZXN0UHJvdmlkZXIKICAgICAgICA6cGFyYW0gZGlnZXN0X3Byb3ZpZGVyOiBEaWdlc3RQcm92aWRlciBvYmplY3QKICAgICAgICA6cGFyYW0gc3RhcnRpbmdfYnVja2V0OiBTMyBidWNrZXQgd2hlcmUgdGhlIGRpZ2VzdHMgYXJlIHN0b3JlZC4KICAgICAgICA6cGFyYW0gc3RhcnRpbmdfcHJlZml4OiBBbiBvcHRpb25hbCBwcmVmaXggYXBwbGllZCB0byBlYWNoIFMzIGtleS4KICAgICAgICA6cGFyYW0gcHVibGljX2tleV9wcm92aWRlcjogUHJvdmlkZXMgcHVibGljIGtleXMgZm9yIGEgcmFuZ2UuCiAgICAgICAgOnBhcmFtIGRpZ2VzdF92YWxpZGF0b3I6IFZhbGlkYXRlcyBkaWdlc3QgdXNpbmcgYSB2YWxpZGF0ZSBtZXRob2QuCiAgICAgICAgOnBhcmFtIG9uX2ludmFsaWQ6IENhbGxiYWNrIGludm9rZWQgd2hlbiBhIGRpZ2VzdCBpcyBpbnZhbGlkLgogICAgICAgIDpwYXJhbSBvbl9nYXA6IENhbGxiYWNrIGludm9rZWQgd2hlbiBhIGRpZ2VzdCBoYXMgbm8gcGFyZW50LCBidXQKICAgICAgICAgICAgdGhlcmUgYXJlIHN0aWxsIG1vcmUgZGlnZXN0cyB0byB2YWxpZGF0ZS4KICAgICAgICA6cGFyYW0gb25fbWlzc2luZzogQ2FsbGJhY2sgaW52b2tlZCB3aGVuIGEgZGlnZXN0IGZpbGUgaXMgbWlzc2luZy4KICAgICAgICAiIiIKICAgICAgICBzZWxmLnN0YXJ0aW5nX2J1Y2tldCA9IHN0YXJ0aW5nX2J1Y2tldAogICAgICAgIHNlbGYuc3RhcnRpbmdfcHJlZml4ID0gc3RhcnRpbmdfcHJlZml4CiAgICAgICAgc2VsZi5kaWdlc3RfcHJvdmlkZXIgPSBkaWdlc3RfcHJvdmlkZXIKICAgICAgICBzZWxmLl9wdWJsaWNfa2V5X3Byb3ZpZGVyID0gcHVibGljX2tleV9wcm92aWRlcgogICAgICAgIHNlbGYuX29uX2dhcCA9IG9uX2dhcAogICAgICAgIHNlbGYuX29uX2ludmFsaWQgPSBvbl9pbnZhbGlkCiAgICAgICAgc2VsZi5fb25fbWlzc2luZyA9IG9uX21pc3NpbmcKICAgICAgICBpZiBkaWdlc3RfdmFsaWRhdG9yIGlzIE5vbmU6CiAgICAgICAgICAgIGRpZ2VzdF92YWxpZGF0b3IgPSBTaGEyNTZSU0FEaWdlc3RWYWxpZGF0b3IoKQogICAgICAgIHNlbGYuX2RpZ2VzdF92YWxpZGF0b3IgPSBkaWdlc3RfdmFsaWRhdG9yCgogICAgZGVmIHRyYXZlcnNlKHNlbGYsIHN0YXJ0X2RhdGUsIGVuZF9kYXRlPU5vbmUpOgogICAgICAgICIiIkNyZWF0ZXMgYW5kIHJldHVybnMgYSBnZW5lcmF0b3IgdGhhdCB5aWVsZHMgdmFsaWRhdGVkIGRpZ2VzdCBkYXRhLgoKICAgICAgICBFYWNoIHlpZWxkZWQgZGlnZXN0IGRpY3Rpb25hcnkgY29udGFpbnMgaW5mb3JtYXRpb24gYWJvdXQgdGhlIGRpZ2VzdAogICAgICAgIGFuZCB0aGUgbG9nIGZpbGUgYXNzb2NpYXRlZCB3aXRoIHRoZSBkaWdlc3QuIERpZ2VzdCBmaWxlcyBhcmUgdmFsaWRhdGVkCiAgICAgICAgYmVmb3JlIHRoZXkgYXJlIHlpZWxkZWQuIFdoZXRoZXIgb3Igbm90IHRoZSBkaWdlc3QgaXMgc3VjY2Vzc2Z1bGx5CiAgICAgICAgdmFsaWRhdGVkIGlzIHN0YXRlZCBpbiB0aGUgImlzVmFsaWQiIGtleSB2YWx1ZSBwYWlyIG9mIHRoZSB5aWVsZGVkCiAgICAgICAgZGljdGlvbmFyeS4KCiAgICAgICAgOnR5cGUgc3RhcnRfZGF0ZTogZGF0ZXRpbWUKICAgICAgICA6cGFyYW0gc3RhcnRfZGF0ZTogRGF0ZSB0byBzdGFydCB2YWxpZGF0aW5nIGZyb20gKGluY2x1c2l2ZSkuCiAgICAgICAgOnR5cGUgc3RhcnRfZGF0ZTogZGF0ZXRpbWUKICAgICAgICA6cGFyYW0gZW5kX2RhdGU6IERhdGUgdG8gc3RvcCB2YWxpZGF0aW5nIGF0IChpbmNsdXNpdmUpLgogICAgICAgICIiIgogICAgICAgIGlmIGVuZF9kYXRlIGlzIE5vbmU6CiAgICAgICAgICAgIGVuZF9kYXRlID0gZGF0ZXRpbWUudXRjbm93KCkKICAgICAgICBlbmRfZGF0ZSA9IG5vcm1hbGl6ZV9kYXRlKGVuZF9kYXRlKQogICAgICAgIHN0YXJ0X2RhdGUgPSBub3JtYWxpemVfZGF0ZShzdGFydF9kYXRlKQogICAgICAgIGJ1Y2tldCA9IHNlbGYuc3RhcnRpbmdfYnVja2V0CiAgICAgICAgcHJlZml4ID0gc2VsZi5zdGFydGluZ19wcmVmaXgKICAgICAgICBkaWdlc3RzID0gc2VsZi5fbG9hZF9kaWdlc3RzKGJ1Y2tldCwgcHJlZml4LCBzdGFydF9kYXRlLCBlbmRfZGF0ZSkKICAgICAgICBwdWJsaWNfa2V5cyA9IHNlbGYuX2xvYWRfcHVibGljX2tleXMoc3RhcnRfZGF0ZSwgZW5kX2RhdGUpCiAgICAgICAga2V5LCBlbmRfZGF0ZSA9IHNlbGYuX2dldF9sYXN0X2RpZ2VzdChkaWdlc3RzKQogICAgICAgIGxhc3Rfc3RhcnRfZGF0ZSA9IGVuZF9kYXRlCiAgICAgICAgd2hpbGUga2V5IGFuZCBzdGFydF9kYXRlIDw9IGxhc3Rfc3RhcnRfZGF0ZToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgZGlnZXN0LCBlbmRfZGF0ZSA9IHNlbGYuX2xvYWRfYW5kX3ZhbGlkYXRlX2RpZ2VzdCgKICAgICAgICAgICAgICAgICAgICBwdWJsaWNfa2V5cywgYnVja2V0LCBrZXkpCiAgICAgICAgICAgICAgICBsYXN0X3N0YXJ0X2RhdGUgPSBub3JtYWxpemVfZGF0ZSgKICAgICAgICAgICAgICAgICAgICBwYXJzZV9kYXRlKGRpZ2VzdFsnZGlnZXN0U3RhcnRUaW1lJ10pKQogICAgICAgICAgICAgICAgcHJldmlvdXNfYnVja2V0ID0gZGlnZXN0LmdldCgncHJldmlvdXNEaWdlc3RTM0J1Y2tldCcsIE5vbmUpCiAgICAgICAgICAgICAgICB5aWVsZCBkaWdlc3QKICAgICAgICAgICAgICAgIGlmIHByZXZpb3VzX2J1Y2tldCBpcyBOb25lOgogICAgICAgICAgICAgICAgICAgICMgVGhlIGNoYWluIGlzIGJyb2tlbiwgc28gZmluZCBuZXh0IGluIGRpZ2VzdCBzdG9yZS4KICAgICAgICAgICAgICAgICAgICBrZXksIGVuZF9kYXRlID0gc2VsZi5fZmluZF9uZXh0X2RpZ2VzdCgKICAgICAgICAgICAgICAgICAgICAgICAgZGlnZXN0cz1kaWdlc3RzLCBidWNrZXQ9YnVja2V0LCBsYXN0X2tleT1rZXksCiAgICAgICAgICAgICAgICAgICAgICAgIGxhc3Rfc3RhcnRfZGF0ZT1sYXN0X3N0YXJ0X2RhdGUsIGNiPXNlbGYuX29uX2dhcCwKICAgICAgICAgICAgICAgICAgICAgICAgaXNfY2JfY29uZGl0aW9uYWw9VHJ1ZSkKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAga2V5ID0gZGlnZXN0WydwcmV2aW91c0RpZ2VzdFMzT2JqZWN0J10KICAgICAgICAgICAgICAgICAgICBpZiBwcmV2aW91c19idWNrZXQgIT0gYnVja2V0OgogICAgICAgICAgICAgICAgICAgICAgICBidWNrZXQgPSBwcmV2aW91c19idWNrZXQKICAgICAgICAgICAgICAgICAgICAgICAgIyBUaGUgYnVja2V0IGNoYW5nZWQgc28gcmVsb2FkIHRoZSBkaWdlc3QgbGlzdC4KICAgICAgICAgICAgICAgICAgICAgICAgZGlnZXN0cyA9IHNlbGYuX2xvYWRfZGlnZXN0cygKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJ1Y2tldCwgcHJlZml4LCBzdGFydF9kYXRlLCBlbmRfZGF0ZSkKICAgICAgICAgICAgZXhjZXB0IENsaWVudEVycm9yIGFzIGU6CiAgICAgICAgICAgICAgICBpZiBlLnJlc3BvbnNlWydFcnJvciddWydDb2RlJ10gIT0gJ05vU3VjaEtleSc6CiAgICAgICAgICAgICAgICAgICAgcmFpc2UgZQogICAgICAgICAgICAgICAga2V5LCBlbmRfZGF0ZSA9IHNlbGYuX2ZpbmRfbmV4dF9kaWdlc3QoCiAgICAgICAgICAgICAgICAgICAgZGlnZXN0cz1kaWdlc3RzLCBidWNrZXQ9YnVja2V0LCBsYXN0X2tleT1rZXksCiAgICAgICAgICAgICAgICAgICAgbGFzdF9zdGFydF9kYXRlPWxhc3Rfc3RhcnRfZGF0ZSwgY2I9c2VsZi5fb25fbWlzc2luZywKICAgICAgICAgICAgICAgICAgICBtZXNzYWdlPXN0cihlKSkKICAgICAgICAgICAgZXhjZXB0IERpZ2VzdEVycm9yIGFzIGU6CiAgICAgICAgICAgICAgICBrZXksIGVuZF9kYXRlID0gc2VsZi5fZmluZF9uZXh0X2RpZ2VzdCgKICAgICAgICAgICAgICAgICAgICBkaWdlc3RzPWRpZ2VzdHMsIGJ1Y2tldD1idWNrZXQsIGxhc3Rfa2V5PWtleSwKICAgICAgICAgICAgICAgICAgICBsYXN0X3N0YXJ0X2RhdGU9bGFzdF9zdGFydF9kYXRlLCBjYj1zZWxmLl9vbl9pbnZhbGlkLAogICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U9c3RyKGUpKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICAjIEFueSBvdGhlciB1bmV4cGVjdGVkIGVycm9ycy4KICAgICAgICAgICAgICAgIGtleSwgZW5kX2RhdGUgPSBzZWxmLl9maW5kX25leHRfZGlnZXN0KAogICAgICAgICAgICAgICAgICAgIGRpZ2VzdHM9ZGlnZXN0cywgYnVja2V0PWJ1Y2tldCwgbGFzdF9rZXk9a2V5LAogICAgICAgICAgICAgICAgICAgIGxhc3Rfc3RhcnRfZGF0ZT1sYXN0X3N0YXJ0X2RhdGUsIGNiPXNlbGYuX29uX2ludmFsaWQsCiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZT0nRGlnZXN0IGZpbGVcdHMzOi8vJXMvJXNcdElOVkFMSUQ6ICVzJwogICAgICAgICAgICAgICAgICAgICAgICAgICAgJSAoYnVja2V0LCBrZXksIHN0cihlKSkpCgogICAgZGVmIF9sb2FkX2RpZ2VzdHMoc2VsZiwgYnVja2V0LCBwcmVmaXgsIHN0YXJ0X2RhdGUsIGVuZF9kYXRlKToKICAgICAgICByZXR1cm4gc2VsZi5kaWdlc3RfcHJvdmlkZXIubG9hZF9kaWdlc3Rfa2V5c19pbl9yYW5nZSgKICAgICAgICAgICAgYnVja2V0PWJ1Y2tldCwgcHJlZml4PXByZWZpeCwKICAgICAgICAgICAgc3RhcnRfZGF0ZT1zdGFydF9kYXRlLCBlbmRfZGF0ZT1lbmRfZGF0ZSkKCiAgICBkZWYgX2ZpbmRfbmV4dF9kaWdlc3Qoc2VsZiwgZGlnZXN0cywgYnVja2V0LCBsYXN0X2tleSwgbGFzdF9zdGFydF9kYXRlLAogICAgICAgICAgICAgICAgICAgICAgICAgIGNiPU5vbmUsIGlzX2NiX2NvbmRpdGlvbmFsPUZhbHNlLCBtZXNzYWdlPU5vbmUpOgogICAgICAgICIiIkZpbmRzIHRoZSBuZXh0IGRpZ2VzdCBpbiB0aGUgYnVja2V0IGFuZCBpbnZva2VzIGFueSBjYWxsYmFjay4iIiIKICAgICAgICBuZXh0X2tleSwgbmV4dF9lbmRfZGF0ZSA9IHNlbGYuX2dldF9sYXN0X2RpZ2VzdChkaWdlc3RzLCBsYXN0X2tleSkKICAgICAgICBpZiBjYiBhbmQgKG5vdCBpc19jYl9jb25kaXRpb25hbCBvciBuZXh0X2tleSk6CiAgICAgICAgICAgIGNiKGJ1Y2tldD1idWNrZXQsIG5leHRfa2V5PW5leHRfa2V5LCBsYXN0X2tleT1sYXN0X2tleSwKICAgICAgICAgICAgICAgbmV4dF9lbmRfZGF0ZT1uZXh0X2VuZF9kYXRlLCBsYXN0X3N0YXJ0X2RhdGU9bGFzdF9zdGFydF9kYXRlLAogICAgICAgICAgICAgICBtZXNzYWdlPW1lc3NhZ2UpCiAgICAgICAgcmV0dXJuIG5leHRfa2V5LCBuZXh0X2VuZF9kYXRlCgogICAgZGVmIF9nZXRfbGFzdF9kaWdlc3Qoc2VsZiwgZGlnZXN0cywgYmVmb3JlX2tleT1Ob25lKToKICAgICAgICAiIiJGaW5kcyB0aGUgcHJldmlvdXMgZGlnZXN0IGtleSAoZWl0aGVyIHRoZSBsYXN0IG9yIGJlZm9yZSBiZWZvcmVfa2V5KQoKICAgICAgICBJZiBubyBrZXkgaXMgcHJvdmlkZWQsIHRoZSBsYXN0IGRpZ2VzdCBpcyB1c2VkLiBJZiBhIGRpZ2VzdCBpcyBmb3VuZCwKICAgICAgICB0aGUgZW5kIGRhdGUgb2YgdGhlIHByb3ZpZGVyIGlzIGFkanVzdGVkIHRvIG1hdGNoIHRoZSBmb3VuZCBrZXkncyBlbmQKICAgICAgICBkYXRlLgogICAgICAgICIiIgogICAgICAgIGlmIG5vdCBkaWdlc3RzOgogICAgICAgICAgICByZXR1cm4gTm9uZSwgTm9uZQogICAgICAgIGVsaWYgYmVmb3JlX2tleSBpcyBOb25lOgogICAgICAgICAgICBuZXh0X2tleSA9IGRpZ2VzdHMucG9wKCkKICAgICAgICAgICAgbmV4dF9rZXlfZGF0ZSA9IG5vcm1hbGl6ZV9kYXRlKAogICAgICAgICAgICAgICAgcGFyc2VfZGF0ZShleHRyYWN0X2RpZ2VzdF9rZXlfZGF0ZShuZXh0X2tleSkpKQogICAgICAgICAgICByZXR1cm4gbmV4dF9rZXksIG5leHRfa2V5X2RhdGUKICAgICAgICAjIGZpbmQgYSBrZXkgYmVmb3JlIHRoZSBnaXZlbiBrZXkuCiAgICAgICAgYmVmb3JlX2tleV9kYXRlID0gcGFyc2VfZGF0ZShleHRyYWN0X2RpZ2VzdF9rZXlfZGF0ZShiZWZvcmVfa2V5KSkKICAgICAgICB3aGlsZSBkaWdlc3RzOgogICAgICAgICAgICBuZXh0X2tleSA9IGRpZ2VzdHMucG9wKCkKICAgICAgICAgICAgbmV4dF9rZXlfZGF0ZSA9IG5vcm1hbGl6ZV9kYXRlKAogICAgICAgICAgICAgICAgcGFyc2VfZGF0ZShleHRyYWN0X2RpZ2VzdF9rZXlfZGF0ZShuZXh0X2tleSkpKQogICAgICAgICAgICBpZiBuZXh0X2tleV9kYXRlIDwgYmVmb3JlX2tleV9kYXRlOgogICAgICAgICAgICAgICAgTE9HLmRlYnVnKCJOZXh0IGZvdW5kIGtleTogJXMiLCBuZXh0X2tleSkKICAgICAgICAgICAgICAgIHJldHVybiBuZXh0X2tleSwgbmV4dF9rZXlfZGF0ZQogICAgICAgIHJldHVybiBOb25lLCBOb25lCgogICAgZGVmIF9sb2FkX2FuZF92YWxpZGF0ZV9kaWdlc3Qoc2VsZiwgcHVibGljX2tleXMsIGJ1Y2tldCwga2V5KToKICAgICAgICAiIiJMb2FkcyBhbmQgdmFsaWRhdGVzIGEgZGlnZXN0IGZyb20gUzMuCgogICAgICAgIDpwYXJhbSBwdWJsaWNfa2V5czogUHVibGljIGtleSBkaWN0aW9uYXJ5IG9mIGZpbmdlcnByaW50IHRvIGRpY3QuCiAgICAgICAgOnJldHVybjogUmV0dXJucyBhIHR1cGxlIG9mIHRoZSBkaWdlc3QgZGF0YSBhcyBhIGRpY3QgYW5kIGVuZF9kYXRlCiAgICAgICAgOnJ0eXBlOiB0dXBsZQogICAgICAgICIiIgogICAgICAgIGRpZ2VzdF9kYXRhLCBkaWdlc3QgPSBzZWxmLmRpZ2VzdF9wcm92aWRlci5mZXRjaF9kaWdlc3QoYnVja2V0LCBrZXkpCiAgICAgICAgZm9yIHJlcXVpcmVkX2tleSBpbiBzZWxmLnJlcXVpcmVkX2RpZ2VzdF9rZXlzOgogICAgICAgICAgICBpZiByZXF1aXJlZF9rZXkgbm90IGluIGRpZ2VzdF9kYXRhOgogICAgICAgICAgICAgICAgcmFpc2UgSW52YWxpZERpZ2VzdEZvcm1hdChidWNrZXQsIGtleSkKICAgICAgICAjIEVuc3VyZSB0aGUgYnVja2V0IGFuZCBrZXkgYXJlIHRoZSBzYW1lIGFzIHdoYXQncyBleHBlY3RlZC4KICAgICAgICBpZiBkaWdlc3RfZGF0YVsnZGlnZXN0UzNCdWNrZXQnXSAhPSBidWNrZXQgXAogICAgICAgICAgICAgICAgb3IgZGlnZXN0X2RhdGFbJ2RpZ2VzdFMzT2JqZWN0J10gIT0ga2V5OgogICAgICAgICAgICByYWlzZSBEaWdlc3RFcnJvcigKICAgICAgICAgICAgICAgICgnRGlnZXN0IGZpbGVcdHMzOi8vJXMvJXNcdElOVkFMSUQ6IGhhcyBiZWVuIG1vdmVkIGZyb20gaXRzICcKICAgICAgICAgICAgICAgICAnb3JpZ2luYWwgbG9jYXRpb24nKSAlIChidWNrZXQsIGtleSkpCiAgICAgICAgIyBHZXQgdGhlIHB1YmxpYyBrZXlzIGluIHRoZSBnaXZlbiB0aW1lIHJhbmdlLgogICAgICAgIGZpbmdlcnByaW50ID0gZGlnZXN0X2RhdGFbJ2RpZ2VzdFB1YmxpY0tleUZpbmdlcnByaW50J10KICAgICAgICBpZiBmaW5nZXJwcmludCBub3QgaW4gcHVibGljX2tleXM6CiAgICAgICAgICAgIHJhaXNlIERpZ2VzdEVycm9yKAogICAgICAgICAgICAgICAgKCdEaWdlc3QgZmlsZVx0czM6Ly8lcy8lc1x0SU5WQUxJRDogcHVibGljIGtleSBub3QgZm91bmQgaW4gJwogICAgICAgICAgICAgICAgICdyZWdpb24gJXMgZm9yIGZpbmdlcnByaW50ICVzJykgJQogICAgICAgICAgICAgICAgKGJ1Y2tldCwga2V5LCBzZWxmLmRpZ2VzdF9wcm92aWRlci50cmFpbF9ob21lX3JlZ2lvbiwKICAgICAgICAgICAgICAgICBmaW5nZXJwcmludCkpCiAgICAgICAgcHVibGljX2tleV9oZXggPSBwdWJsaWNfa2V5c1tmaW5nZXJwcmludF1bJ1ZhbHVlJ10KICAgICAgICBzZWxmLl9kaWdlc3RfdmFsaWRhdG9yLnZhbGlkYXRlKAogICAgICAgICAgICBidWNrZXQsIGtleSwgcHVibGljX2tleV9oZXgsIGRpZ2VzdF9kYXRhLCBkaWdlc3QpCiAgICAgICAgZW5kX2RhdGUgPSBub3JtYWxpemVfZGF0ZShwYXJzZV9kYXRlKGRpZ2VzdF9kYXRhWydkaWdlc3RFbmRUaW1lJ10pKQogICAgICAgIHJldHVybiBkaWdlc3RfZGF0YSwgZW5kX2RhdGUKCiAgICBkZWYgX2xvYWRfcHVibGljX2tleXMoc2VsZiwgc3RhcnRfZGF0ZSwgZW5kX2RhdGUpOgogICAgICAgIHB1YmxpY19rZXlzID0gc2VsZi5fcHVibGljX2tleV9wcm92aWRlci5nZXRfcHVibGljX2tleXMoCiAgICAgICAgICAgIHN0YXJ0X2RhdGUsIGVuZF9kYXRlKQogICAgICAgIGlmIG5vdCBwdWJsaWNfa2V5czoKICAgICAgICAgICAgcmFpc2UgUnVudGltZUVycm9yKAogICAgICAgICAgICAgICAgJ05vIHB1YmxpYyBrZXlzIGZvdW5kIGJldHdlZW4gJXMgYW5kICVzJyAlCiAgICAgICAgICAgICAgICAoZm9ybWF0X2Rpc3BsYXlfZGF0ZShzdGFydF9kYXRlKSwKICAgICAgICAgICAgICAgICBmb3JtYXRfZGlzcGxheV9kYXRlKGVuZF9kYXRlKSkpCiAgICAgICAgcmV0dXJuIHB1YmxpY19rZXlzCgoKY2xhc3MgU2hhMjU2UlNBRGlnZXN0VmFsaWRhdG9yKG9iamVjdCk6CiAgICAiIiIKICAgIFZhbGlkYXRlcyBTSEEyNTZ3aXRoUlNBIHNpZ25lZCBkaWdlc3RzLgoKICAgIFRoZSByZXN1bHQgb2YgdmFsaWRhdGluZyB0aGUgZGlnZXN0IGlzIGluc2VydGVkIGludG8gdGhlIGRpZ2VzdF9kYXRhCiAgICBkaWN0aW9uYXJ5IHVzaW5nIHRoZSBpc1ZhbGlkIGtleSB2YWx1ZSBwYWlyLgogICAgIiIiCgogICAgZGVmIHZhbGlkYXRlKHNlbGYsIGJ1Y2tldCwga2V5LCBwdWJsaWNfa2V5LCBkaWdlc3RfZGF0YSwgaW5mbGF0ZWRfZGlnZXN0KToKICAgICAgICAiIiJWYWxpZGF0ZXMgYSBkaWdlc3QgZmlsZS4KCiAgICAgICAgVGhyb3dzIGEgRGlnZXN0RXJyb3Igd2hlbiB0aGUgZGlnZXN0IGlzIGludmFsaWQuCgogICAgICAgIDpwYXJhbSBidWNrZXQ6IEJ1Y2tldCBvZiB0aGUgZGlnZXN0IGZpbGUKICAgICAgICA6cGFyYW0ga2V5OiBLZXkgb2YgdGhlIGRpZ2VzdCBmaWxlCiAgICAgICAgOnBhcmFtIHB1YmxpY19rZXk6IFB1YmxpYyBrZXkgYnl0ZXMuCiAgICAgICAgOnBhcmFtIGRpZ2VzdF9kYXRhOiBEaWN0IG9mIGRpZ2VzdCBkYXRhIHJldHVybmVkIHdoZW4gSlNPTgogICAgICAgICAgICBkZWNvZGluZyBhIG1hbmlmZXN0LgogICAgICAgIDpwYXJhbSBpbmZsYXRlZF9kaWdlc3Q6IEluZmxhdGVkIGRpZ2VzdCBmaWxlIGNvbnRlbnRzIGFzIGJ5dGVzLgogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgZGVjb2RlZF9rZXkgPSBiYXNlNjQuYjY0ZGVjb2RlKHB1YmxpY19rZXkpCiAgICAgICAgICAgIHB1YmxpY19rZXkgPSByc2EuUHVibGljS2V5LmxvYWRfcGtjczEoZGVjb2RlZF9rZXksIGZvcm1hdD0nREVSJykKICAgICAgICAgICAgdG9fc2lnbiA9IHNlbGYuX2NyZWF0ZV9zdHJpbmdfdG9fc2lnbihkaWdlc3RfZGF0YSwgaW5mbGF0ZWRfZGlnZXN0KQogICAgICAgICAgICBzaWduYXR1cmVfYnl0ZXMgPSBiaW5hc2NpaS51bmhleGxpZnkoZGlnZXN0X2RhdGFbJ19zaWduYXR1cmUnXSkKICAgICAgICAgICAgcnNhLnZlcmlmeSh0b19zaWduLCBzaWduYXR1cmVfYnl0ZXMsIHB1YmxpY19rZXkpCiAgICAgICAgZXhjZXB0IFB5QXNuMUVycm9yOgogICAgICAgICAgICByYWlzZSBEaWdlc3RFcnJvcigKICAgICAgICAgICAgICAgICgnRGlnZXN0IGZpbGVcdHMzOi8vJXMvJXNcdElOVkFMSUQ6IFVuYWJsZSB0byBsb2FkIFBLQ1MgIzEga2V5JwogICAgICAgICAgICAgICAgICcgd2l0aCBmaW5nZXJwcmludCAlcycpCiAgICAgICAgICAgICAgICAlIChidWNrZXQsIGtleSwgZGlnZXN0X2RhdGFbJ2RpZ2VzdFB1YmxpY0tleUZpbmdlcnByaW50J10pKQogICAgICAgIGV4Y2VwdCByc2EucGtjczEuVmVyaWZpY2F0aW9uRXJyb3I6CiAgICAgICAgICAgICMgTm90ZSBmcm9tIHRoZSBQeXRob24tUlNBIGRvY3M6IE5ldmVyIGRpc3BsYXkgdGhlIHN0YWNrIHRyYWNlIG9mCiAgICAgICAgICAgICMgYSByc2EucGtjczEuVmVyaWZpY2F0aW9uRXJyb3IgZXhjZXB0aW9uLiBJdCBzaG93cyB3aGVyZSBpbiB0aGUKICAgICAgICAgICAgIyBjb2RlIHRoZSBleGNlcHRpb24gb2NjdXJyZWQsIGFuZCB0aHVzIGxlYWtzIGluZm9ybWF0aW9uIGFib3V0CiAgICAgICAgICAgICMgdGhlIGtleS4KICAgICAgICAgICAgcmFpc2UgRGlnZXN0U2lnbmF0dXJlRXJyb3IoYnVja2V0LCBrZXkpCgogICAgZGVmIF9jcmVhdGVfc3RyaW5nX3RvX3NpZ24oc2VsZiwgZGlnZXN0X2RhdGEsIGluZmxhdGVkX2RpZ2VzdCk6CiAgICAgICAgcHJldmlvdXNfc2lnbmF0dXJlID0gZGlnZXN0X2RhdGFbJ3ByZXZpb3VzRGlnZXN0U2lnbmF0dXJlJ10KICAgICAgICBpZiBwcmV2aW91c19zaWduYXR1cmUgaXMgTm9uZToKICAgICAgICAgICAgIyBUaGUgdmFsdWUgbXVzdCBiZSAnbnVsbCcgdG8gbWF0Y2ggdGhlIEphdmEgaW1wbGVtZW50YXRpb24uCiAgICAgICAgICAgIHByZXZpb3VzX3NpZ25hdHVyZSA9ICdudWxsJwogICAgICAgIHN0cmluZ190b19zaWduID0gIiVzXG4lcy8lc1xuJXNcbiVzIiAlICgKICAgICAgICAgICAgZGlnZXN0X2RhdGFbJ2RpZ2VzdEVuZFRpbWUnXSwKICAgICAgICAgICAgZGlnZXN0X2RhdGFbJ2RpZ2VzdFMzQnVja2V0J10sCiAgICAgICAgICAgIGRpZ2VzdF9kYXRhWydkaWdlc3RTM09iamVjdCddLAogICAgICAgICAgICBoYXNobGliLnNoYTI1NihpbmZsYXRlZF9kaWdlc3QpLmhleGRpZ2VzdCgpLAogICAgICAgICAgICBwcmV2aW91c19zaWduYXR1cmUpCiAgICAgICAgTE9HLmRlYnVnKCdEaWdlc3Qgc3RyaW5nIHRvIHNpZ246ICVzJywgc3RyaW5nX3RvX3NpZ24pCiAgICAgICAgcmV0dXJuIHN0cmluZ190b19zaWduLmVuY29kZSgpCgoKY2xhc3MgQ2xvdWRUcmFpbFZhbGlkYXRlTG9ncyhCYXNpY0NvbW1hbmQpOgogICAgIiIiCiAgICBWYWxpZGF0ZXMgbG9nIGRpZ2VzdHMgYW5kIGxvZyBmaWxlcywgb3B0aW9uYWxseSBzYXZpbmcgdGhlbSB0byBkaXNrLgogICAgIiIiCiAgICBOQU1FID0gJ3ZhbGlkYXRlLWxvZ3MnCiAgICBERVNDUklQVElPTiA9ICIiIgogICAgVmFsaWRhdGVzIENsb3VkVHJhaWwgbG9ncyBmb3IgYSBnaXZlbiBwZXJpb2Qgb2YgdGltZS4KCiAgICBUaGlzIGNvbW1hbmQgdXNlcyB0aGUgZGlnZXN0IGZpbGVzIGRlbGl2ZXJlZCB0byB5b3VyIFMzIGJ1Y2tldCB0byBwZXJmb3JtCiAgICB0aGUgdmFsaWRhdGlvbi4KCiAgICBUaGUgQVdTIENMSSBhbGxvd3MgeW91IHRvIGRldGVjdCB0aGUgZm9sbG93aW5nIHR5cGVzIG9mIGNoYW5nZXM6CgogICAgLSBNb2RpZmljYXRpb24gb3IgZGVsZXRpb24gb2YgQ2xvdWRUcmFpbCBsb2cgZmlsZXMuCiAgICAtIE1vZGlmaWNhdGlvbiBvciBkZWxldGlvbiBvZiBDbG91ZFRyYWlsIGRpZ2VzdCBmaWxlcy4KCiAgICBUbyB2YWxpZGF0ZSBsb2cgZmlsZXMgd2l0aCB0aGUgQVdTIENMSSwgdGhlIGZvbGxvd2luZyBwcmVjb25kaXRpb25zIG11c3QKICAgIGJlIG1ldDoKCiAgICAtIFlvdSBtdXN0IGhhdmUgb25saW5lIGNvbm5lY3Rpdml0eSB0byBBV1MuCiAgICAtIFlvdSBtdXN0IGhhdmUgcmVhZCBhY2Nlc3MgdG8gdGhlIFMzIGJ1Y2tldCB0aGF0IGNvbnRhaW5zIHRoZSBkaWdlc3QgYW5kCiAgICAgIGxvZyBmaWxlcy4KICAgIC0gVGhlIGRpZ2VzdCBhbmQgbG9nIGZpbGVzIG11c3Qgbm90IGhhdmUgYmVlbiBtb3ZlZCBmcm9tIHRoZSBvcmlnaW5hbCBTMwogICAgICBsb2NhdGlvbiB3aGVyZSBDbG91ZFRyYWlsIGRlbGl2ZXJlZCB0aGVtLgogICAgLSBGb3Igb3JnYW5pemF0aW9uIHRyYWlscyB5b3UgbXVzdCBoYXZlIGFjY2VzcyB0byBkZXNjcmliZS1vcmdhbml6YXRpb24gdG8KICAgICAgdmFsaWRhdGUgZGlnZXN0IGZpbGVzCgogICAgV2hlbiB5b3UgZGlzYWJsZSBMb2cgRmlsZSBWYWxpZGF0aW9uLCB0aGUgY2hhaW4gb2YgZGlnZXN0IGZpbGVzIGlzIGJyb2tlbgogICAgYWZ0ZXIgb25lIGhvdXIuIENsb3VkVHJhaWwgd2lsbCBub3QgZGlnZXN0IGxvZyBmaWxlcyB0aGF0IHdlcmUgZGVsaXZlcmVkCiAgICBkdXJpbmcgYSBwZXJpb2QgaW4gd2hpY2ggdGhlIExvZyBGaWxlIFZhbGlkYXRpb24gZmVhdHVyZSB3YXMgZGlzYWJsZWQuCiAgICBGb3IgZXhhbXBsZSwgaWYgeW91IGVuYWJsZSBMb2cgRmlsZSBWYWxpZGF0aW9uIG9uIEphbnVhcnkgMSwgZGlzYWJsZSBpdAogICAgb24gSmFudWFyeSAyLCBhbmQgcmUtZW5hYmxlIGl0IG9uIEphbnVhcnkgMTAsIGRpZ2VzdCBmaWxlcyB3aWxsIG5vdCBiZQogICAgY3JlYXRlZCBmb3IgdGhlIGxvZyBmaWxlcyBkZWxpdmVyZWQgZnJvbSBKYW51YXJ5IDMgdG8gSmFudWFyeSA5LiBUaGUgc2FtZQogICAgYXBwbGllcyB3aGVuZXZlciB5b3Ugc3RvcCBDbG91ZFRyYWlsIGxvZ2dpbmcgb3IgZGVsZXRlIGEgdHJhaWwuCgogICAgLi4gbm90ZTo6CgogICAgICAgIExvZyBmaWxlcyB0aGF0IGhhdmUgYmVlbiBkb3dubG9hZGVkIHRvIGxvY2FsIGRpc2sgY2Fubm90IGJlIHZhbGlkYXRlZAogICAgICAgIHdpdGggdGhlIEFXUyBDTEkuIFRoZSBDTEkgd2lsbCBkb3dubG9hZCBhbGwgbG9nIGZpbGVzIGVhY2ggdGltZSB0aGlzCiAgICAgICAgY29tbWFuZCBpcyBleGVjdXRlZC4KCiAgICAuLiBub3RlOjoKCiAgICAgICAgVGhpcyBjb21tYW5kIHJlcXVpcmVzIHRoYXQgdGhlIHJvbGUgZXhlY3V0aW5nIHRoZSBjb21tYW5kIGhhcwogICAgICAgIHBlcm1pc3Npb24gdG8gY2FsbCBMaXN0T2JqZWN0cywgR2V0T2JqZWN0LCBhbmQgR2V0QnVja2V0TG9jYXRpb24gZm9yCiAgICAgICAgZWFjaCBidWNrZXQgcmVmZXJlbmNlZCBieSB0aGUgdHJhaWwuCgogICAgIiIiCgogICAgQVJHX1RBQkxFID0gWwogICAgICAgIHsnbmFtZSc6ICd0cmFpbC1hcm4nLCAncmVxdWlyZWQnOiBUcnVlLCAnY2xpX3R5cGVfbmFtZSc6ICdzdHJpbmcnLAogICAgICAgICAnaGVscF90ZXh0JzogJ1NwZWNpZmllcyB0aGUgQVJOIG9mIHRoZSB0cmFpbCB0byBiZSB2YWxpZGF0ZWQnfSwKICAgICAgICB7J25hbWUnOiAnc3RhcnQtdGltZScsICdyZXF1aXJlZCc6IFRydWUsICdjbGlfdHlwZV9uYW1lJzogJ3N0cmluZycsCiAgICAgICAgICdoZWxwX3RleHQnOiAoJ1NwZWNpZmllcyB0aGF0IGxvZyBmaWxlcyBkZWxpdmVyZWQgb24gb3IgYWZ0ZXIgdGhlICcKICAgICAgICAgICAgICAgICAgICAgICAnc3BlY2lmaWVkIFVUQyB0aW1lc3RhbXAgdmFsdWUgd2lsbCBiZSB2YWxpZGF0ZWQuICcKICAgICAgICAgICAgICAgICAgICAgICAnRXhhbXBsZTogIjIwMTUtMDEtMDhUMDU6MjE6NDJaIi4nKX0sCiAgICAgICAgeyduYW1lJzogJ2VuZC10aW1lJywgJ2NsaV90eXBlX25hbWUnOiAnc3RyaW5nJywKICAgICAgICAgJ2hlbHBfdGV4dCc6ICgnT3B0aW9uYWxseSBzcGVjaWZpZXMgdGhhdCBsb2cgZmlsZXMgZGVsaXZlcmVkIG9uIG9yICcKICAgICAgICAgICAgICAgICAgICAgICAnYmVmb3JlIHRoZSBzcGVjaWZpZWQgVVRDIHRpbWVzdGFtcCB2YWx1ZSB3aWxsIGJlICcKICAgICAgICAgICAgICAgICAgICAgICAndmFsaWRhdGVkLiBUaGUgZGVmYXVsdCB2YWx1ZSBpcyB0aGUgY3VycmVudCB0aW1lLiAnCiAgICAgICAgICAgICAgICAgICAgICAgJ0V4YW1wbGU6ICIyMDE1LTAxLTA4VDEyOjMxOjQxWiIuJyl9LAogICAgICAgIHsnbmFtZSc6ICdzMy1idWNrZXQnLCAnY2xpX3R5cGVfbmFtZSc6ICdzdHJpbmcnLAogICAgICAgICAnaGVscF90ZXh0JzogKCdPcHRpb25hbGx5IHNwZWNpZmllcyB0aGUgUzMgYnVja2V0IHdoZXJlIHRoZSBkaWdlc3QgJwogICAgICAgICAgICAgICAgICAgICAgICdmaWxlcyBhcmUgc3RvcmVkLiBJZiBhIGJ1Y2tldCBuYW1lIGlzIG5vdCBzcGVjaWZpZWQsICcKICAgICAgICAgICAgICAgICAgICAgICAndGhlIENMSSB3aWxsIHJldHJpZXZlIGl0IGJ5IGNhbGxpbmcgZGVzY3JpYmVfdHJhaWxzJyl9LAogICAgICAgIHsnbmFtZSc6ICdzMy1wcmVmaXgnLCAnY2xpX3R5cGVfbmFtZSc6ICdzdHJpbmcnLAogICAgICAgICAnaGVscF90ZXh0JzogKCdPcHRpb25hbGx5IHNwZWNpZmllcyB0aGUgb3B0aW9uYWwgUzMgcHJlZml4IHdoZXJlIHRoZSAnCiAgICAgICAgICAgICAgICAgICAgICAgJ2RpZ2VzdCBmaWxlcyBhcmUgc3RvcmVkLiBJZiBub3Qgc3BlY2lmaWVkLCB0aGUgQ0xJICcKICAgICAgICAgICAgICAgICAgICAgICAnd2lsbCBkZXRlcm1pbmUgdGhlIHByZWZpeCBhdXRvbWF0aWNhbGx5IGJ5IGNhbGxpbmcgJwogICAgICAgICAgICAgICAgICAgICAgICdkZXNjcmliZV90cmFpbHMuJyl9LAogICAgICAgIHsnbmFtZSc6ICdhY2NvdW50LWlkJywgJ2NsaV90eXBlX25hbWUnOiAnc3RyaW5nJywKICAgICAgICAgJ2hlbHBfdGV4dCc6ICgnT3B0aW9uYWxseSBzcGVjaWZpZXMgdGhlIGFjY291bnQgZm9yIHZhbGlkYXRpbmcgbG9ncy4gJwogICAgICAgICAgICAgICAgICAgICAgICdUaGlzIHBhcmFtZXRlciBpcyBuZWVkZWQgZm9yIG9yZ2FuaXphdGlvbiB0cmFpbHMgJwogICAgICAgICAgICAgICAgICAgICAgICdmb3IgdmFsaWRhdGluZyBsb2dzIGZvciBzcGVjaWZpYyBhY2NvdW50IGluc2lkZSBhbiAnCiAgICAgICAgICAgICAgICAgICAgICAgJ29yZ2FuaXphdGlvbicpfSwKICAgICAgICB7J25hbWUnOiAndmVyYm9zZScsICdjbGlfdHlwZV9uYW1lJzogJ2Jvb2xlYW4nLAogICAgICAgICAnYWN0aW9uJzogJ3N0b3JlX3RydWUnLAogICAgICAgICAnaGVscF90ZXh0JzogJ0Rpc3BsYXkgdmVyYm9zZSBsb2cgdmFsaWRhdGlvbiBpbmZvcm1hdGlvbid9CiAgICBdCgogICAgZGVmIF9faW5pdF9fKHNlbGYsIHNlc3Npb24pOgogICAgICAgIHN1cGVyKENsb3VkVHJhaWxWYWxpZGF0ZUxvZ3MsIHNlbGYpLl9faW5pdF9fKHNlc3Npb24pCiAgICAgICAgc2VsZi50cmFpbF9hcm4gPSBOb25lCiAgICAgICAgc2VsZi5pc192ZXJib3NlID0gRmFsc2UKICAgICAgICBzZWxmLnN0YXJ0X3RpbWUgPSBOb25lCiAgICAgICAgc2VsZi5lbmRfdGltZSA9IE5vbmUKICAgICAgICBzZWxmLnMzX2J1Y2tldCA9IE5vbmUKICAgICAgICBzZWxmLnMzX3ByZWZpeCA9IE5vbmUKICAgICAgICBzZWxmLnMzX2NsaWVudF9wcm92aWRlciA9IE5vbmUKICAgICAgICBzZWxmLmNsb3VkdHJhaWxfY2xpZW50ID0gTm9uZQogICAgICAgIHNlbGYuYWNjb3VudF9pZCA9IE5vbmUKICAgICAgICBzZWxmLl9zb3VyY2VfcmVnaW9uID0gTm9uZQogICAgICAgIHNlbGYuX3ZhbGlkX2RpZ2VzdHMgPSAwCiAgICAgICAgc2VsZi5faW52YWxpZF9kaWdlc3RzID0gMAogICAgICAgIHNlbGYuX3ZhbGlkX2xvZ3MgPSAwCiAgICAgICAgc2VsZi5faW52YWxpZF9sb2dzID0gMAogICAgICAgIHNlbGYuX2lzX2xhc3Rfc3RhdHVzX2RvdWJsZV9zcGFjZSA9IFRydWUKICAgICAgICBzZWxmLl9mb3VuZF9zdGFydF90aW1lID0gTm9uZQogICAgICAgIHNlbGYuX2ZvdW5kX2VuZF90aW1lID0gTm9uZQoKICAgIGRlZiBfcnVuX21haW4oc2VsZiwgYXJncywgcGFyc2VkX2dsb2JhbHMpOgogICAgICAgIHNlbGYuaGFuZGxlX2FyZ3MoYXJncykKICAgICAgICBzZWxmLnNldHVwX3NlcnZpY2VzKHBhcnNlZF9nbG9iYWxzKQogICAgICAgIHNlbGYuX2NhbGwoKQogICAgICAgIGlmIHNlbGYuX2ludmFsaWRfZGlnZXN0cyA+IDAgb3Igc2VsZi5faW52YWxpZF9sb2dzID4gMDoKICAgICAgICAgICAgcmV0dXJuIDEKICAgICAgICByZXR1cm4gMAoKICAgIGRlZiBoYW5kbGVfYXJncyhzZWxmLCBhcmdzKToKICAgICAgICBzZWxmLnRyYWlsX2FybiA9IGFyZ3MudHJhaWxfYXJuCiAgICAgICAgc2VsZi5pc192ZXJib3NlID0gYXJncy52ZXJib3NlCiAgICAgICAgc2VsZi5zM19idWNrZXQgPSBhcmdzLnMzX2J1Y2tldAogICAgICAgIHNlbGYuczNfcHJlZml4ID0gYXJncy5zM19wcmVmaXgKICAgICAgICBzZWxmLmFjY291bnRfaWQgPSBhcmdzLmFjY291bnRfaWQKICAgICAgICBzZWxmLnN0YXJ0X3RpbWUgPSBub3JtYWxpemVfZGF0ZShwYXJzZV9kYXRlKGFyZ3Muc3RhcnRfdGltZSkpCiAgICAgICAgaWYgYXJncy5lbmRfdGltZToKICAgICAgICAgICAgc2VsZi5lbmRfdGltZSA9IG5vcm1hbGl6ZV9kYXRlKHBhcnNlX2RhdGUoYXJncy5lbmRfdGltZSkpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgc2VsZi5lbmRfdGltZSA9IG5vcm1hbGl6ZV9kYXRlKGRhdGV0aW1lLnV0Y25vdygpKQogICAgICAgIGlmIHNlbGYuc3RhcnRfdGltZSA+IHNlbGYuZW5kX3RpbWU6CiAgICAgICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoKCdJbnZhbGlkIHRpbWUgcmFuZ2Ugc3BlY2lmaWVkOiBzdGFydC10aW1lIG11c3QgJwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnb2NjdXIgYmVmb3JlIGVuZC10aW1lJykpCiAgICAgICAgIyBGb3VuZCBzdGFydCB0aW1lIGFsd2F5cyBkZWZhdWx0cyB0byB0aGUgZ2l2ZW4gc3RhcnQgdGltZS4gVGhpcyB2YWx1ZQogICAgICAgICMgbWF5IGNoYW5nZSBpZiB0aGUgZWFybGllc3QgZm91bmQgZGlnZXN0IGlzIGFmdGVyIHRoZSBnaXZlbiBzdGFydAogICAgICAgICMgdGltZS4gTm90ZSB0aGF0IHRoZSBzdW1tYXJ5IG91dHB1dCByZXBvcnQgb2Ygd2hhdCBkYXRlIHJhbmdlcyB3ZXJlCiAgICAgICAgIyBhY3R1YWxseSBmb3VuZCBpcyBvbmx5IHNob3duIGlmIGEgdmFsaWQgZGlnZXN0IGlzIGVuY291bnRlcmVkLAogICAgICAgICMgdGhlcmVieSBzZXR0aW5nIHNlbGYuX2ZvdW5kX2VuZF90aW1lIHRvIGEgdmFsdWUuCiAgICAgICAgc2VsZi5fZm91bmRfc3RhcnRfdGltZSA9IHNlbGYuc3RhcnRfdGltZQoKICAgIGRlZiBzZXR1cF9zZXJ2aWNlcyhzZWxmLCBwYXJzZWRfZ2xvYmFscyk6CiAgICAgICAgc2VsZi5fc291cmNlX3JlZ2lvbiA9IHBhcnNlZF9nbG9iYWxzLnJlZ2lvbgogICAgICAgICMgVXNlIHRoZSB0aGUgc2FtZSByZWdpb24gYXMgdGhlIHJlZ2lvbiBvZiB0aGUgQ0xJIHRvIGdldCBsb2NhdGlvbnMuCiAgICAgICAgc2VsZi5zM19jbGllbnRfcHJvdmlkZXIgPSBTM0NsaWVudFByb3ZpZGVyKAogICAgICAgICAgICBzZWxmLl9zZXNzaW9uLCBzZWxmLl9zb3VyY2VfcmVnaW9uKQogICAgICAgIGNsaWVudF9hcmdzID0geydyZWdpb25fbmFtZSc6IHBhcnNlZF9nbG9iYWxzLnJlZ2lvbiwKICAgICAgICAgICAgICAgICAgICAgICAndmVyaWZ5JzogcGFyc2VkX2dsb2JhbHMudmVyaWZ5X3NzbH0KICAgICAgICBzZWxmLm9yZ2FuaXphdGlvbl9jbGllbnQgPSBzZWxmLl9zZXNzaW9uLmNyZWF0ZV9jbGllbnQoCiAgICAgICAgICAgICdvcmdhbml6YXRpb25zJywgKipjbGllbnRfYXJncykKCiAgICAgICAgaWYgcGFyc2VkX2dsb2JhbHMuZW5kcG9pbnRfdXJsIGlzIG5vdCBOb25lOgogICAgICAgICAgICBjbGllbnRfYXJnc1snZW5kcG9pbnRfdXJsJ10gPSBwYXJzZWRfZ2xvYmFscy5lbmRwb2ludF91cmwKICAgICAgICBzZWxmLmNsb3VkdHJhaWxfY2xpZW50ID0gc2VsZi5fc2Vzc2lvbi5jcmVhdGVfY2xpZW50KAogICAgICAgICAgICAnY2xvdWR0cmFpbCcsICoqY2xpZW50X2FyZ3MpCgogICAgZGVmIF9jYWxsKHNlbGYpOgogICAgICAgIHRyYXZlcnNlciA9IGNyZWF0ZV9kaWdlc3RfdHJhdmVyc2VyKAogICAgICAgICAgICB0cmFpbF9hcm49c2VsZi50cmFpbF9hcm4sIGNsb3VkdHJhaWxfY2xpZW50PXNlbGYuY2xvdWR0cmFpbF9jbGllbnQsCiAgICAgICAgICAgIG9yZ2FuaXphdGlvbl9jbGllbnQ9c2VsZi5vcmdhbml6YXRpb25fY2xpZW50LAogICAgICAgICAgICB0cmFpbF9zb3VyY2VfcmVnaW9uPXNlbGYuX3NvdXJjZV9yZWdpb24sCiAgICAgICAgICAgIHMzX2NsaWVudF9wcm92aWRlcj1zZWxmLnMzX2NsaWVudF9wcm92aWRlciwgYnVja2V0PXNlbGYuczNfYnVja2V0LAogICAgICAgICAgICBwcmVmaXg9c2VsZi5zM19wcmVmaXgsIG9uX21pc3Npbmc9c2VsZi5fb25fbWlzc2luZ19kaWdlc3QsCiAgICAgICAgICAgIG9uX2ludmFsaWQ9c2VsZi5fb25faW52YWxpZF9kaWdlc3QsIG9uX2dhcD1zZWxmLl9vbl9kaWdlc3RfZ2FwLAogICAgICAgICAgICBhY2NvdW50X2lkPXNlbGYuYWNjb3VudF9pZCkKICAgICAgICBzZWxmLl93cml0ZV9zdGFydHVwX3RleHQoKQogICAgICAgIGRpZ2VzdHMgPSB0cmF2ZXJzZXIudHJhdmVyc2Uoc2VsZi5zdGFydF90aW1lLCBzZWxmLmVuZF90aW1lKQogICAgICAgIGZvciBkaWdlc3QgaW4gZGlnZXN0czoKICAgICAgICAgICAgIyBPbmx5IHZhbGlkIGRpZ2VzdHMgYXJlIHlpZWxkZWQgYW5kIG9ubHkgdmFsaWQgZGlnZXN0cyBjYW4gYWRqdXN0CiAgICAgICAgICAgICMgdGhlIGZvdW5kIHRpbWVzIHRoYXQgYXJlIHJlcG9ydGVkIGluIHRoZSBDTEkgb3V0cHV0IHN1bW1hcnkuCiAgICAgICAgICAgIHNlbGYuX3RyYWNrX2ZvdW5kX3RpbWVzKGRpZ2VzdCkKICAgICAgICAgICAgc2VsZi5fdmFsaWRfZGlnZXN0cyArPSAxCiAgICAgICAgICAgIHNlbGYuX3dyaXRlX3N0YXR1cygKICAgICAgICAgICAgICAgICdEaWdlc3QgZmlsZVx0czM6Ly8lcy8lc1x0dmFsaWQnCiAgICAgICAgICAgICAgICAlIChkaWdlc3RbJ2RpZ2VzdFMzQnVja2V0J10sIGRpZ2VzdFsnZGlnZXN0UzNPYmplY3QnXSkpCiAgICAgICAgICAgIGlmIG5vdCBkaWdlc3RbJ2xvZ0ZpbGVzJ106CiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICBmb3IgbG9nIGluIGRpZ2VzdFsnbG9nRmlsZXMnXToKICAgICAgICAgICAgICAgIHNlbGYuX2Rvd25sb2FkX2xvZyhsb2cpCiAgICAgICAgc2VsZi5fd3JpdGVfc3VtbWFyeV90ZXh0KCkKCiAgICBkZWYgX3RyYWNrX2ZvdW5kX3RpbWVzKHNlbGYsIGRpZ2VzdCk6CiAgICAgICAgIyBUcmFjayB0aGUgZWFybGllc3QgZm91bmQgc3RhcnQgdGltZSwgYnV0IGRvIG5vdCB1c2UgYSBkYXRlIGJlZm9yZQogICAgICAgICMgdGhlIHVzZXIgc3VwcGxpZWQgc3RhcnQgZGF0ZS4KICAgICAgICBkaWdlc3Rfc3RhcnRfdGltZSA9IHBhcnNlX2RhdGUoZGlnZXN0WydkaWdlc3RTdGFydFRpbWUnXSkKICAgICAgICBpZiBkaWdlc3Rfc3RhcnRfdGltZSA+IHNlbGYuc3RhcnRfdGltZToKICAgICAgICAgICAgc2VsZi5fZm91bmRfc3RhcnRfdGltZSA9IGRpZ2VzdF9zdGFydF90aW1lCiAgICAgICAgIyBPbmx5IHVzZSB0aGUgbGFzdCBmb3VuZCBlbmQgdGltZSBpZiBpdCBpcyBsZXNzIHRoYW4gdGhlCiAgICAgICAgIyB1c2VyIHN1cHBsaWVkIGVuZCB0aW1lIChvciB0aGUgY3VycmVudCBkYXRlKS4KICAgICAgICBpZiBub3Qgc2VsZi5fZm91bmRfZW5kX3RpbWU6CiAgICAgICAgICAgIGRpZ2VzdF9lbmRfdGltZSA9IHBhcnNlX2RhdGUoZGlnZXN0WydkaWdlc3RFbmRUaW1lJ10pCiAgICAgICAgICAgIHNlbGYuX2ZvdW5kX2VuZF90aW1lID0gbWluKGRpZ2VzdF9lbmRfdGltZSwgc2VsZi5lbmRfdGltZSkKCiAgICBkZWYgX2Rvd25sb2FkX2xvZyhzZWxmLCBsb2cpOgogICAgICAgICIiIiBEb3dubG9hZCBhIGxvZywgZGVjb21wcmVzcywgYW5kIGNvbXBhcmUgU0hBMjU2IGNoZWNrc3VtcyIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBDcmVhdGUgYSBjbGllbnQgdGhhdCBjYW4gd29yayB3aXRoIHRoaXMgYnVja2V0LgogICAgICAgICAgICBjbGllbnQgPSBzZWxmLnMzX2NsaWVudF9wcm92aWRlci5nZXRfY2xpZW50KGxvZ1snczNCdWNrZXQnXSkKICAgICAgICAgICAgcmVzcG9uc2UgPSBjbGllbnQuZ2V0X29iamVjdCgKICAgICAgICAgICAgICAgIEJ1Y2tldD1sb2dbJ3MzQnVja2V0J10sIEtleT1sb2dbJ3MzT2JqZWN0J10pCiAgICAgICAgICAgIGd6aXBfaW5mbGF0ZXIgPSB6bGliLmRlY29tcHJlc3NvYmooemxpYi5NQVhfV0JJVFMgfCAxNikKICAgICAgICAgICAgcm9sbGluZ19oYXNoID0gaGFzaGxpYi5zaGEyNTYoKQogICAgICAgICAgICBmb3IgY2h1bmsgaW4gaXRlcihsYW1iZGE6IHJlc3BvbnNlWydCb2R5J10ucmVhZCgyMDQ4KSwgYiIiKToKICAgICAgICAgICAgICAgIGRhdGEgPSBnemlwX2luZmxhdGVyLmRlY29tcHJlc3MoY2h1bmspCiAgICAgICAgICAgICAgICByb2xsaW5nX2hhc2gudXBkYXRlKGRhdGEpCiAgICAgICAgICAgIHJlbWFpbmluZ19kYXRhID0gZ3ppcF9pbmZsYXRlci5mbHVzaCgpCiAgICAgICAgICAgIGlmIHJlbWFpbmluZ19kYXRhOgogICAgICAgICAgICAgICAgcm9sbGluZ19oYXNoLnVwZGF0ZShyZW1haW5pbmdfZGF0YSkKICAgICAgICAgICAgY29tcHV0ZWRfaGFzaCA9IHJvbGxpbmdfaGFzaC5oZXhkaWdlc3QoKQogICAgICAgICAgICBpZiBjb21wdXRlZF9oYXNoICE9IGxvZ1snaGFzaFZhbHVlJ106CiAgICAgICAgICAgICAgICBzZWxmLl9vbl9sb2dfaW52YWxpZChsb2cpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBzZWxmLl92YWxpZF9sb2dzICs9IDEKICAgICAgICAgICAgICAgIHNlbGYuX3dyaXRlX3N0YXR1cygoJ0xvZyBmaWxlXHRzMzovLyVzLyVzXHR2YWxpZCcKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJSAobG9nWydzM0J1Y2tldCddLCBsb2dbJ3MzT2JqZWN0J10pKSkKICAgICAgICBleGNlcHQgQ2xpZW50RXJyb3IgYXMgZToKICAgICAgICAgICAgaWYgZS5yZXNwb25zZVsnRXJyb3InXVsnQ29kZSddICE9ICdOb1N1Y2hLZXknOgogICAgICAgICAgICAgICAgcmFpc2UKICAgICAgICAgICAgc2VsZi5fb25fbWlzc2luZ19sb2cobG9nKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHNlbGYuX29uX2ludmFsaWRfbG9nX2Zvcm1hdChsb2cpCgogICAgZGVmIF93cml0ZV9zdGF0dXMoc2VsZiwgbWVzc2FnZSwgaXNfZXJyb3I9RmFsc2UpOgogICAgICAgIGlmIGlzX2Vycm9yOgogICAgICAgICAgICBpZiBzZWxmLl9pc19sYXN0X3N0YXR1c19kb3VibGVfc3BhY2U6CiAgICAgICAgICAgICAgICBzeXMuc3RkZXJyLndyaXRlKCIlc1xuXG4iICUgbWVzc2FnZSkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHN5cy5zdGRlcnIud3JpdGUoIlxuJXNcblxuIiAlIG1lc3NhZ2UpCiAgICAgICAgICAgIHNlbGYuX2lzX2xhc3Rfc3RhdHVzX2RvdWJsZV9zcGFjZSA9IFRydWUKICAgICAgICBlbGlmIHNlbGYuaXNfdmVyYm9zZToKICAgICAgICAgICAgc2VsZi5faXNfbGFzdF9zdGF0dXNfZG91YmxlX3NwYWNlID0gRmFsc2UKICAgICAgICAgICAgc3lzLnN0ZG91dC53cml0ZSgiJXNcbiIgJSBtZXNzYWdlKQoKICAgIGRlZiBfd3JpdGVfc3RhcnR1cF90ZXh0KHNlbGYpOgogICAgICAgIHN5cy5zdGRvdXQud3JpdGUoCiAgICAgICAgICAgICdWYWxpZGF0aW5nIGxvZyBmaWxlcyBmb3IgdHJhaWwgJXMgYmV0d2VlbiAlcyBhbmQgJXNcblxuJwogICAgICAgICAgICAlIChzZWxmLnRyYWlsX2FybiwgZm9ybWF0X2Rpc3BsYXlfZGF0ZShzZWxmLnN0YXJ0X3RpbWUpLAogICAgICAgICAgICAgICBmb3JtYXRfZGlzcGxheV9kYXRlKHNlbGYuZW5kX3RpbWUpKSkKCiAgICBkZWYgX3dyaXRlX3N1bW1hcnlfdGV4dChzZWxmKToKICAgICAgICBpZiBub3Qgc2VsZi5faXNfbGFzdF9zdGF0dXNfZG91YmxlX3NwYWNlOgogICAgICAgICAgICBzeXMuc3Rkb3V0LndyaXRlKCdcbicpCiAgICAgICAgc3lzLnN0ZG91dC53cml0ZSgnUmVzdWx0cyByZXF1ZXN0ZWQgZm9yICVzIHRvICVzXG4nCiAgICAgICAgICAgICAgICAgICAgICAgICAlIChmb3JtYXRfZGlzcGxheV9kYXRlKHNlbGYuc3RhcnRfdGltZSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JtYXRfZGlzcGxheV9kYXRlKHNlbGYuZW5kX3RpbWUpKSkKICAgICAgICBpZiBub3Qgc2VsZi5fdmFsaWRfZGlnZXN0cyBhbmQgbm90IHNlbGYuX2ludmFsaWRfZGlnZXN0czoKICAgICAgICAgICAgc3lzLnN0ZG91dC53cml0ZSgnTm8gZGlnZXN0cyBmb3VuZFxuJykKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgaWYgbm90IHNlbGYuX2ZvdW5kX3N0YXJ0X3RpbWUgb3Igbm90IHNlbGYuX2ZvdW5kX2VuZF90aW1lOgogICAgICAgICAgICBzeXMuc3Rkb3V0LndyaXRlKCdObyB2YWxpZCBkaWdlc3RzIGZvdW5kIGluIHJhbmdlXG4nKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHN5cy5zdGRvdXQud3JpdGUoJ1Jlc3VsdHMgZm91bmQgZm9yICVzIHRvICVzOlxuJwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICUgKGZvcm1hdF9kaXNwbGF5X2RhdGUoc2VsZi5fZm91bmRfc3RhcnRfdGltZSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9ybWF0X2Rpc3BsYXlfZGF0ZShzZWxmLl9mb3VuZF9lbmRfdGltZSkpKQogICAgICAgIHNlbGYuX3dyaXRlX3JhdGlvKHNlbGYuX3ZhbGlkX2RpZ2VzdHMsIHNlbGYuX2ludmFsaWRfZGlnZXN0cywgJ2RpZ2VzdCcpCiAgICAgICAgc2VsZi5fd3JpdGVfcmF0aW8oc2VsZi5fdmFsaWRfbG9ncywgc2VsZi5faW52YWxpZF9sb2dzLCAnbG9nJykKICAgICAgICBzeXMuc3Rkb3V0LndyaXRlKCdcbicpCgogICAgZGVmIF93cml0ZV9yYXRpbyhzZWxmLCB2YWxpZCwgaW52YWxpZCwgbmFtZSk6CiAgICAgICAgdG90YWwgPSB2YWxpZCArIGludmFsaWQKICAgICAgICBpZiB0b3RhbCA+IDA6CiAgICAgICAgICAgIHN5cy5zdGRvdXQud3JpdGUoJ1xuJWQvJWQgJXMgZmlsZXMgdmFsaWQnICUgKHZhbGlkLCB0b3RhbCwgbmFtZSkpCiAgICAgICAgICAgIGlmIGludmFsaWQgPiAwOgogICAgICAgICAgICAgICAgc3lzLnN0ZG91dC53cml0ZSgnLCAlZC8lZCAlcyBmaWxlcyBJTlZBTElEJyAlIChpbnZhbGlkLCB0b3RhbCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZSkpCgogICAgZGVmIF9vbl9taXNzaW5nX2RpZ2VzdChzZWxmLCBidWNrZXQsIGxhc3Rfa2V5LCAqKmt3YXJncyk6CiAgICAgICAgc2VsZi5faW52YWxpZF9kaWdlc3RzICs9IDEKICAgICAgICBzZWxmLl93cml0ZV9zdGF0dXMoJ0RpZ2VzdCBmaWxlXHRzMzovLyVzLyVzXHRJTlZBTElEOiBub3QgZm91bmQnCiAgICAgICAgICAgICAgICAgICAgICAgICAgICUgKGJ1Y2tldCwgbGFzdF9rZXkpLCBUcnVlKQoKICAgIGRlZiBfb25fZGlnZXN0X2dhcChzZWxmLCAqKmt3YXJncyk6CiAgICAgICAgc2VsZi5fd3JpdGVfc3RhdHVzKAogICAgICAgICAgICAnTm8gbG9nIGZpbGVzIHdlcmUgZGVsaXZlcmVkIGJ5IENsb3VkVHJhaWwgYmV0d2VlbiAlcyBhbmQgJXMnCiAgICAgICAgICAgICUgKGZvcm1hdF9kaXNwbGF5X2RhdGUoa3dhcmdzWyduZXh0X2VuZF9kYXRlJ10pLAogICAgICAgICAgICAgICBmb3JtYXRfZGlzcGxheV9kYXRlKGt3YXJnc1snbGFzdF9zdGFydF9kYXRlJ10pKSwgVHJ1ZSkKCiAgICBkZWYgX29uX2ludmFsaWRfZGlnZXN0KHNlbGYsIG1lc3NhZ2UsICoqa3dhcmdzKToKICAgICAgICBzZWxmLl9pbnZhbGlkX2RpZ2VzdHMgKz0gMQogICAgICAgIHNlbGYuX3dyaXRlX3N0YXR1cyhtZXNzYWdlLCBUcnVlKQoKICAgIGRlZiBfb25faW52YWxpZF9sb2dfZm9ybWF0KHNlbGYsIGxvZ19kYXRhKToKICAgICAgICBzZWxmLl9pbnZhbGlkX2xvZ3MgKz0gMQogICAgICAgIHNlbGYuX3dyaXRlX3N0YXR1cygKICAgICAgICAgICAgKCdMb2cgZmlsZVx0czM6Ly8lcy8lc1x0SU5WQUxJRDogaW52YWxpZCBmb3JtYXQnCiAgICAgICAgICAgICAlIChsb2dfZGF0YVsnczNCdWNrZXQnXSwgbG9nX2RhdGFbJ3MzT2JqZWN0J10pKSwgVHJ1ZSkKCiAgICBkZWYgX29uX2xvZ19pbnZhbGlkKHNlbGYsIGxvZ19kYXRhKToKICAgICAgICBzZWxmLl9pbnZhbGlkX2xvZ3MgKz0gMQogICAgICAgIHNlbGYuX3dyaXRlX3N0YXR1cygKICAgICAgICAgICAgIkxvZyBmaWxlXHRzMzovLyVzLyVzXHRJTlZBTElEOiBoYXNoIHZhbHVlIGRvZXNuJ3QgbWF0Y2giCiAgICAgICAgICAgICUgKGxvZ19kYXRhWydzM0J1Y2tldCddLCBsb2dfZGF0YVsnczNPYmplY3QnXSksIFRydWUpCgogICAgZGVmIF9vbl9taXNzaW5nX2xvZyhzZWxmLCBsb2dfZGF0YSk6CiAgICAgICAgc2VsZi5faW52YWxpZF9sb2dzICs9IDEKICAgICAgICBzZWxmLl93cml0ZV9zdGF0dXMoCiAgICAgICAgICAgICdMb2cgZmlsZVx0czM6Ly8lcy8lc1x0SU5WQUxJRDogbm90IGZvdW5kJwogICAgICAgICAgICAlIChsb2dfZGF0YVsnczNCdWNrZXQnXSwgbG9nX2RhdGFbJ3MzT2JqZWN0J10pLCBUcnVlKQo=
