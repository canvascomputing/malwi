statistics:
  total_files: 1
  skipped_files: 0.0
  processed_objects: 1
  malicious_objects: 0
details:
- path: .repo_cache/malicious_repos/pypi_malregistry/discord-py-v13/1.3/discord_py_v13-1.3-py3-none-any/discord-py-v13/voice_client.py
  contents:
  - name: <module>
    score: 0.0
    code: |-
      # -*- coding: utf-8 -*-

      """
      The MIT License (MIT)

      Copyright (c) 2015-present Rapptz

      Permission is hereby granted, free of charge, to any person obtaining a
      copy of this software and associated documentation files (the "Software"),
      to deal in the Software without restriction, including without limitation
      the rights to use, copy, modify, merge, publish, distribute, sublicense,
      and/or sell copies of the Software, and to permit persons to whom the
      Software is furnished to do so, subject to the following conditions:

      The above copyright notice and this permission notice shall be included in
      all copies or substantial portions of the Software.

      THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
      OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
      FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
      AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
      LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
      FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
      DEALINGS IN THE SOFTWARE.
      """

      """Some documentation to refer to:

      - Our main web socket (mWS) sends opcode 4 with a guild ID and channel ID.
      - The mWS receives VOICE_STATE_UPDATE and VOICE_SERVER_UPDATE.
      - We pull the session_id from VOICE_STATE_UPDATE.
      - We pull the token, endpoint and server_id from VOICE_SERVER_UPDATE.
      - Then we initiate the voice web socket (vWS) pointing to the endpoint.
      - We send opcode 0 with the user_id, server_id, session_id and token using the vWS.
      - The vWS sends back opcode 2 with an ssrc, port, modes(array) and hearbeat_interval.
      - We send a UDP discovery packet to endpoint:port and receive our IP and our port in LE.
      - Then we send our IP and port via vWS with opcode 1.
      - When that's all done, we receive opcode 4 from the vWS.
      - Finally we can transmit data to endpoint:port.
      """

      import asyncio
      import socket
      import logging
      import struct
      import threading

      from . import opus, utils
      from .backoff import ExponentialBackoff
      from .gateway import *
      from .errors import ClientException, ConnectionClosed
      from .player import AudioPlayer, AudioSource

      try:
          import nacl.secret
          has_nacl = True
      except ImportError:
          has_nacl = False

      log = logging.getLogger(__name__)

      class VoiceProtocol:
          """A class that represents the Discord voice protocol.

          This is an abstract class. The library provides a concrete implementation
          under :class:`VoiceClient`.

          This class allows you to implement a protocol to allow for an external
          method of sending voice, such as Lavalink_ or a native library implementation.

          These classes are passed to :meth:`abc.Connectable.connect`.

          .. _Lavalink: https://github.com/freyacodes/Lavalink

          Parameters
          ------------
          client: :class:`Client`
              The client (or its subclasses) that started the connection request.
          channel: :class:`abc.Connectable`
              The voice channel that is being connected to.
          """

          def __init__(self, client, channel):
              self.client = client
              self.channel = channel

          async def on_voice_state_update(self, data):
              """|coro|

              An abstract method that is called when the client's voice state
              has changed. This corresponds to ``VOICE_STATE_UPDATE``.

              Parameters
              ------------
              data: :class:`dict`
                  The raw `voice state payload`__.

                  .. _voice_state_update_payload: https://discord.com/developers/docs/resources/voice#voice-state-object

                  __ voice_state_update_payload_
              """
              raise NotImplementedError

          async def on_voice_server_update(self, data):
              """|coro|

              An abstract method that is called when initially connecting to voice.
              This corresponds to ``VOICE_SERVER_UPDATE``.

              Parameters
              ------------
              data: :class:`dict`
                  The raw `voice server update payload`__.

                  .. _voice_server_update_payload: https://discord.com/developers/docs/topics/gateway#voice-server-update-voice-server-update-event-fields

                  __ voice_server_update_payload_
              """
              raise NotImplementedError

          async def connect(self, *, timeout, reconnect):
              """|coro|

              An abstract method called when the client initiates the connection request.

              When a connection is requested initially, the library calls the constructor
              under ``__init__`` and then calls :meth:`connect`. If :meth:`connect` fails at
              some point then :meth:`disconnect` is called.

              Within this method, to start the voice connection flow it is recommended to
              use :meth:`Guild.change_voice_state` to start the flow. After which,
              :meth:`on_voice_server_update` and :meth:`on_voice_state_update` will be called.
              The order that these two are called is unspecified.

              Parameters
              ------------
              timeout: :class:`float`
                  The timeout for the connection.
              reconnect: :class:`bool`
                  Whether reconnection is expected.
              """
              raise NotImplementedError

          async def disconnect(self, *, force):
              """|coro|

              An abstract method called when the client terminates the connection.

              See :meth:`cleanup`.

              Parameters
              ------------
              force: :class:`bool`
                  Whether the disconnection was forced.
              """
              raise NotImplementedError

          def cleanup(self):
              """This method *must* be called to ensure proper clean-up during a disconnect.

              It is advisable to call this from within :meth:`disconnect` when you are
              completely done with the voice protocol instance.

              This method removes it from the internal state cache that keeps track of
              currently alive voice clients. Failure to clean-up will cause subsequent
              connections to report that it's still connected.
              """
              key_id, _ = self.channel._get_voice_client_key()
              self.client._connection._remove_voice_client(key_id)
    tokens: resume load_const STRING_FILE_PATH store_name __doc__ nop load_const INTEGER load_const import_name asyncio store_name asyncio load_const INTEGER load_const import_name socket store_name socket load_const INTEGER load_const import_name logging store_name logging load_const INTEGER load_const import_name struct store_name struct load_const INTEGER load_const import_name threading store_name threading load_const INTEGER load_const import_name import_from opus store_name opus import_from utils store_name utils pop_top load_const INTEGER load_const import_name backoff import_from STRING_LEN_S_ENT_HIGH store_name STRING_LEN_S_ENT_HIGH pop_top load_const INTEGER load_const import_name gateway call_intrinsic_1 INTRINSIC_IMPORT_STAR pop_top load_const INTEGER load_const import_name errors import_from ClientException store_name ClientException import_from STRING_BASE64_LEN_S_ENT_HIGH store_name STRING_BASE64_LEN_S_ENT_HIGH pop_top load_const INTEGER load_const import_name player import_from AudioPlayer store_name AudioPlayer import_from AudioSource store_name AudioSource pop_top nop load_const INTEGER load_const import_name nacl.secret store_name nacl load_const INTEGER store_name has_nacl push_null load_name logging load_attr getLogger load_name __name__ call store_name log push_null load_build_class load_const OBJECT make_function load_const VoiceProtocol call store_name VoiceProtocol push_null load_build_class load_const OBJECT make_function load_const VoiceClient load_name VoiceProtocol call store_name VoiceClient return_const None push_exc_info load_name ImportError check_exc_match pop_jump_if_false TO_NUMBER pop_top load_const INTEGER store_name has_nacl pop_except jump_backward TO_NUMBER reraise copy pop_except reraise
    hash: e0e25878901cc4983de26811ab495f422558401a58777de6ad730a141b144efc
sources:
  ? .repo_cache/malicious_repos/pypi_malregistry/discord-py-v13/1.3/discord_py_v13-1.3-py3-none-any/discord-py-v13/voice_client.py
  : IyAtKi0gY29kaW5nOiB1dGYtOCAtKi0KCiIiIgpUaGUgTUlUIExpY2Vuc2UgKE1JVCkKCkNvcHlyaWdodCAoYykgMjAxNS1wcmVzZW50IFJhcHB0egoKUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEKY29weSBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZSAiU29mdHdhcmUiKSwKdG8gZGVhbCBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbgp0aGUgcmlnaHRzIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwKYW5kL29yIHNlbGwgY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlClNvZnR3YXJlIGlzIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6CgpUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbgphbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KClRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTCk9SIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLApGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEUKQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUgpMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORwpGUk9NLCBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSCkRFQUxJTkdTIElOIFRIRSBTT0ZUV0FSRS4KIiIiCgoiIiJTb21lIGRvY3VtZW50YXRpb24gdG8gcmVmZXIgdG86CgotIE91ciBtYWluIHdlYiBzb2NrZXQgKG1XUykgc2VuZHMgb3Bjb2RlIDQgd2l0aCBhIGd1aWxkIElEIGFuZCBjaGFubmVsIElELgotIFRoZSBtV1MgcmVjZWl2ZXMgVk9JQ0VfU1RBVEVfVVBEQVRFIGFuZCBWT0lDRV9TRVJWRVJfVVBEQVRFLgotIFdlIHB1bGwgdGhlIHNlc3Npb25faWQgZnJvbSBWT0lDRV9TVEFURV9VUERBVEUuCi0gV2UgcHVsbCB0aGUgdG9rZW4sIGVuZHBvaW50IGFuZCBzZXJ2ZXJfaWQgZnJvbSBWT0lDRV9TRVJWRVJfVVBEQVRFLgotIFRoZW4gd2UgaW5pdGlhdGUgdGhlIHZvaWNlIHdlYiBzb2NrZXQgKHZXUykgcG9pbnRpbmcgdG8gdGhlIGVuZHBvaW50LgotIFdlIHNlbmQgb3Bjb2RlIDAgd2l0aCB0aGUgdXNlcl9pZCwgc2VydmVyX2lkLCBzZXNzaW9uX2lkIGFuZCB0b2tlbiB1c2luZyB0aGUgdldTLgotIFRoZSB2V1Mgc2VuZHMgYmFjayBvcGNvZGUgMiB3aXRoIGFuIHNzcmMsIHBvcnQsIG1vZGVzKGFycmF5KSBhbmQgaGVhcmJlYXRfaW50ZXJ2YWwuCi0gV2Ugc2VuZCBhIFVEUCBkaXNjb3ZlcnkgcGFja2V0IHRvIGVuZHBvaW50OnBvcnQgYW5kIHJlY2VpdmUgb3VyIElQIGFuZCBvdXIgcG9ydCBpbiBMRS4KLSBUaGVuIHdlIHNlbmQgb3VyIElQIGFuZCBwb3J0IHZpYSB2V1Mgd2l0aCBvcGNvZGUgMS4KLSBXaGVuIHRoYXQncyBhbGwgZG9uZSwgd2UgcmVjZWl2ZSBvcGNvZGUgNCBmcm9tIHRoZSB2V1MuCi0gRmluYWxseSB3ZSBjYW4gdHJhbnNtaXQgZGF0YSB0byBlbmRwb2ludDpwb3J0LgoiIiIKCmltcG9ydCBhc3luY2lvCmltcG9ydCBzb2NrZXQKaW1wb3J0IGxvZ2dpbmcKaW1wb3J0IHN0cnVjdAppbXBvcnQgdGhyZWFkaW5nCgpmcm9tIC4gaW1wb3J0IG9wdXMsIHV0aWxzCmZyb20gLmJhY2tvZmYgaW1wb3J0IEV4cG9uZW50aWFsQmFja29mZgpmcm9tIC5nYXRld2F5IGltcG9ydCAqCmZyb20gLmVycm9ycyBpbXBvcnQgQ2xpZW50RXhjZXB0aW9uLCBDb25uZWN0aW9uQ2xvc2VkCmZyb20gLnBsYXllciBpbXBvcnQgQXVkaW9QbGF5ZXIsIEF1ZGlvU291cmNlCgp0cnk6CiAgICBpbXBvcnQgbmFjbC5zZWNyZXQKICAgIGhhc19uYWNsID0gVHJ1ZQpleGNlcHQgSW1wb3J0RXJyb3I6CiAgICBoYXNfbmFjbCA9IEZhbHNlCgpsb2cgPSBsb2dnaW5nLmdldExvZ2dlcihfX25hbWVfXykKCmNsYXNzIFZvaWNlUHJvdG9jb2w6CiAgICAiIiJBIGNsYXNzIHRoYXQgcmVwcmVzZW50cyB0aGUgRGlzY29yZCB2b2ljZSBwcm90b2NvbC4KCiAgICBUaGlzIGlzIGFuIGFic3RyYWN0IGNsYXNzLiBUaGUgbGlicmFyeSBwcm92aWRlcyBhIGNvbmNyZXRlIGltcGxlbWVudGF0aW9uCiAgICB1bmRlciA6Y2xhc3M6YFZvaWNlQ2xpZW50YC4KCiAgICBUaGlzIGNsYXNzIGFsbG93cyB5b3UgdG8gaW1wbGVtZW50IGEgcHJvdG9jb2wgdG8gYWxsb3cgZm9yIGFuIGV4dGVybmFsCiAgICBtZXRob2Qgb2Ygc2VuZGluZyB2b2ljZSwgc3VjaCBhcyBMYXZhbGlua18gb3IgYSBuYXRpdmUgbGlicmFyeSBpbXBsZW1lbnRhdGlvbi4KCiAgICBUaGVzZSBjbGFzc2VzIGFyZSBwYXNzZWQgdG8gOm1ldGg6YGFiYy5Db25uZWN0YWJsZS5jb25uZWN0YC4KCiAgICAuLiBfTGF2YWxpbms6IGh0dHBzOi8vZ2l0aHViLmNvbS9mcmV5YWNvZGVzL0xhdmFsaW5rCgogICAgUGFyYW1ldGVycwogICAgLS0tLS0tLS0tLS0tCiAgICBjbGllbnQ6IDpjbGFzczpgQ2xpZW50YAogICAgICAgIFRoZSBjbGllbnQgKG9yIGl0cyBzdWJjbGFzc2VzKSB0aGF0IHN0YXJ0ZWQgdGhlIGNvbm5lY3Rpb24gcmVxdWVzdC4KICAgIGNoYW5uZWw6IDpjbGFzczpgYWJjLkNvbm5lY3RhYmxlYAogICAgICAgIFRoZSB2b2ljZSBjaGFubmVsIHRoYXQgaXMgYmVpbmcgY29ubmVjdGVkIHRvLgogICAgIiIiCgogICAgZGVmIF9faW5pdF9fKHNlbGYsIGNsaWVudCwgY2hhbm5lbCk6CiAgICAgICAgc2VsZi5jbGllbnQgPSBjbGllbnQKICAgICAgICBzZWxmLmNoYW5uZWwgPSBjaGFubmVsCgogICAgYXN5bmMgZGVmIG9uX3ZvaWNlX3N0YXRlX3VwZGF0ZShzZWxmLCBkYXRhKToKICAgICAgICAiIiJ8Y29yb3wKCiAgICAgICAgQW4gYWJzdHJhY3QgbWV0aG9kIHRoYXQgaXMgY2FsbGVkIHdoZW4gdGhlIGNsaWVudCdzIHZvaWNlIHN0YXRlCiAgICAgICAgaGFzIGNoYW5nZWQuIFRoaXMgY29ycmVzcG9uZHMgdG8gYGBWT0lDRV9TVEFURV9VUERBVEVgYC4KCiAgICAgICAgUGFyYW1ldGVycwogICAgICAgIC0tLS0tLS0tLS0tLQogICAgICAgIGRhdGE6IDpjbGFzczpgZGljdGAKICAgICAgICAgICAgVGhlIHJhdyBgdm9pY2Ugc3RhdGUgcGF5bG9hZGBfXy4KCiAgICAgICAgICAgIC4uIF92b2ljZV9zdGF0ZV91cGRhdGVfcGF5bG9hZDogaHR0cHM6Ly9kaXNjb3JkLmNvbS9kZXZlbG9wZXJzL2RvY3MvcmVzb3VyY2VzL3ZvaWNlI3ZvaWNlLXN0YXRlLW9iamVjdAoKICAgICAgICAgICAgX18gdm9pY2Vfc3RhdGVfdXBkYXRlX3BheWxvYWRfCiAgICAgICAgIiIiCiAgICAgICAgcmFpc2UgTm90SW1wbGVtZW50ZWRFcnJvcgoKICAgIGFzeW5jIGRlZiBvbl92b2ljZV9zZXJ2ZXJfdXBkYXRlKHNlbGYsIGRhdGEpOgogICAgICAgICIiInxjb3JvfAoKICAgICAgICBBbiBhYnN0cmFjdCBtZXRob2QgdGhhdCBpcyBjYWxsZWQgd2hlbiBpbml0aWFsbHkgY29ubmVjdGluZyB0byB2b2ljZS4KICAgICAgICBUaGlzIGNvcnJlc3BvbmRzIHRvIGBgVk9JQ0VfU0VSVkVSX1VQREFURWBgLgoKICAgICAgICBQYXJhbWV0ZXJzCiAgICAgICAgLS0tLS0tLS0tLS0tCiAgICAgICAgZGF0YTogOmNsYXNzOmBkaWN0YAogICAgICAgICAgICBUaGUgcmF3IGB2b2ljZSBzZXJ2ZXIgdXBkYXRlIHBheWxvYWRgX18uCgogICAgICAgICAgICAuLiBfdm9pY2Vfc2VydmVyX3VwZGF0ZV9wYXlsb2FkOiBodHRwczovL2Rpc2NvcmQuY29tL2RldmVsb3BlcnMvZG9jcy90b3BpY3MvZ2F0ZXdheSN2b2ljZS1zZXJ2ZXItdXBkYXRlLXZvaWNlLXNlcnZlci11cGRhdGUtZXZlbnQtZmllbGRzCgogICAgICAgICAgICBfXyB2b2ljZV9zZXJ2ZXJfdXBkYXRlX3BheWxvYWRfCiAgICAgICAgIiIiCiAgICAgICAgcmFpc2UgTm90SW1wbGVtZW50ZWRFcnJvcgoKICAgIGFzeW5jIGRlZiBjb25uZWN0KHNlbGYsICosIHRpbWVvdXQsIHJlY29ubmVjdCk6CiAgICAgICAgIiIifGNvcm98CgogICAgICAgIEFuIGFic3RyYWN0IG1ldGhvZCBjYWxsZWQgd2hlbiB0aGUgY2xpZW50IGluaXRpYXRlcyB0aGUgY29ubmVjdGlvbiByZXF1ZXN0LgoKICAgICAgICBXaGVuIGEgY29ubmVjdGlvbiBpcyByZXF1ZXN0ZWQgaW5pdGlhbGx5LCB0aGUgbGlicmFyeSBjYWxscyB0aGUgY29uc3RydWN0b3IKICAgICAgICB1bmRlciBgYF9faW5pdF9fYGAgYW5kIHRoZW4gY2FsbHMgOm1ldGg6YGNvbm5lY3RgLiBJZiA6bWV0aDpgY29ubmVjdGAgZmFpbHMgYXQKICAgICAgICBzb21lIHBvaW50IHRoZW4gOm1ldGg6YGRpc2Nvbm5lY3RgIGlzIGNhbGxlZC4KCiAgICAgICAgV2l0aGluIHRoaXMgbWV0aG9kLCB0byBzdGFydCB0aGUgdm9pY2UgY29ubmVjdGlvbiBmbG93IGl0IGlzIHJlY29tbWVuZGVkIHRvCiAgICAgICAgdXNlIDptZXRoOmBHdWlsZC5jaGFuZ2Vfdm9pY2Vfc3RhdGVgIHRvIHN0YXJ0IHRoZSBmbG93LiBBZnRlciB3aGljaCwKICAgICAgICA6bWV0aDpgb25fdm9pY2Vfc2VydmVyX3VwZGF0ZWAgYW5kIDptZXRoOmBvbl92b2ljZV9zdGF0ZV91cGRhdGVgIHdpbGwgYmUgY2FsbGVkLgogICAgICAgIFRoZSBvcmRlciB0aGF0IHRoZXNlIHR3byBhcmUgY2FsbGVkIGlzIHVuc3BlY2lmaWVkLgoKICAgICAgICBQYXJhbWV0ZXJzCiAgICAgICAgLS0tLS0tLS0tLS0tCiAgICAgICAgdGltZW91dDogOmNsYXNzOmBmbG9hdGAKICAgICAgICAgICAgVGhlIHRpbWVvdXQgZm9yIHRoZSBjb25uZWN0aW9uLgogICAgICAgIHJlY29ubmVjdDogOmNsYXNzOmBib29sYAogICAgICAgICAgICBXaGV0aGVyIHJlY29ubmVjdGlvbiBpcyBleHBlY3RlZC4KICAgICAgICAiIiIKICAgICAgICByYWlzZSBOb3RJbXBsZW1lbnRlZEVycm9yCgogICAgYXN5bmMgZGVmIGRpc2Nvbm5lY3Qoc2VsZiwgKiwgZm9yY2UpOgogICAgICAgICIiInxjb3JvfAoKICAgICAgICBBbiBhYnN0cmFjdCBtZXRob2QgY2FsbGVkIHdoZW4gdGhlIGNsaWVudCB0ZXJtaW5hdGVzIHRoZSBjb25uZWN0aW9uLgoKICAgICAgICBTZWUgOm1ldGg6YGNsZWFudXBgLgoKICAgICAgICBQYXJhbWV0ZXJzCiAgICAgICAgLS0tLS0tLS0tLS0tCiAgICAgICAgZm9yY2U6IDpjbGFzczpgYm9vbGAKICAgICAgICAgICAgV2hldGhlciB0aGUgZGlzY29ubmVjdGlvbiB3YXMgZm9yY2VkLgogICAgICAgICIiIgogICAgICAgIHJhaXNlIE5vdEltcGxlbWVudGVkRXJyb3IKCiAgICBkZWYgY2xlYW51cChzZWxmKToKICAgICAgICAiIiJUaGlzIG1ldGhvZCAqbXVzdCogYmUgY2FsbGVkIHRvIGVuc3VyZSBwcm9wZXIgY2xlYW4tdXAgZHVyaW5nIGEgZGlzY29ubmVjdC4KCiAgICAgICAgSXQgaXMgYWR2aXNhYmxlIHRvIGNhbGwgdGhpcyBmcm9tIHdpdGhpbiA6bWV0aDpgZGlzY29ubmVjdGAgd2hlbiB5b3UgYXJlCiAgICAgICAgY29tcGxldGVseSBkb25lIHdpdGggdGhlIHZvaWNlIHByb3RvY29sIGluc3RhbmNlLgoKICAgICAgICBUaGlzIG1ldGhvZCByZW1vdmVzIGl0IGZyb20gdGhlIGludGVybmFsIHN0YXRlIGNhY2hlIHRoYXQga2VlcHMgdHJhY2sgb2YKICAgICAgICBjdXJyZW50bHkgYWxpdmUgdm9pY2UgY2xpZW50cy4gRmFpbHVyZSB0byBjbGVhbi11cCB3aWxsIGNhdXNlIHN1YnNlcXVlbnQKICAgICAgICBjb25uZWN0aW9ucyB0byByZXBvcnQgdGhhdCBpdCdzIHN0aWxsIGNvbm5lY3RlZC4KICAgICAgICAiIiIKICAgICAgICBrZXlfaWQsIF8gPSBzZWxmLmNoYW5uZWwuX2dldF92b2ljZV9jbGllbnRfa2V5KCkKICAgICAgICBzZWxmLmNsaWVudC5fY29ubmVjdGlvbi5fcmVtb3ZlX3ZvaWNlX2NsaWVudChrZXlfaWQpCgpjbGFzcyBWb2ljZUNsaWVudChWb2ljZVByb3RvY29sKToKICAgICIiIlJlcHJlc2VudHMgYSBEaXNjb3JkIHZvaWNlIGNvbm5lY3Rpb24uCgogICAgWW91IGRvIG5vdCBjcmVhdGUgdGhlc2UsIHlvdSB0eXBpY2FsbHkgZ2V0IHRoZW0gZnJvbQogICAgZS5nLiA6bWV0aDpgVm9pY2VDaGFubmVsLmNvbm5lY3RgLgoKICAgIFdhcm5pbmcKICAgIC0tLS0tLS0tCiAgICBJbiBvcmRlciB0byB1c2UgUENNIGJhc2VkIEF1ZGlvU291cmNlcywgeW91IG11c3QgaGF2ZSB0aGUgb3B1cyBsaWJyYXJ5CiAgICBpbnN0YWxsZWQgb24geW91ciBzeXN0ZW0gYW5kIGxvYWRlZCB0aHJvdWdoIDpmdW5jOmBvcHVzLmxvYWRfb3B1c2AuCiAgICBPdGhlcndpc2UsIHlvdXIgQXVkaW9Tb3VyY2VzIG11c3QgYmUgb3B1cyBlbmNvZGVkIChlLmcuIHVzaW5nIDpjbGFzczpgRkZtcGVnT3B1c0F1ZGlvYCkKICAgIG9yIHRoZSBsaWJyYXJ5IHdpbGwgbm90IGJlIGFibGUgdG8gdHJhbnNtaXQgYXVkaW8uCgogICAgQXR0cmlidXRlcwogICAgLS0tLS0tLS0tLS0KICAgIHNlc3Npb25faWQ6IDpjbGFzczpgc3RyYAogICAgICAgIFRoZSB2b2ljZSBjb25uZWN0aW9uIHNlc3Npb24gSUQuCiAgICB0b2tlbjogOmNsYXNzOmBzdHJgCiAgICAgICAgVGhlIHZvaWNlIGNvbm5lY3Rpb24gdG9rZW4uCiAgICBlbmRwb2ludDogOmNsYXNzOmBzdHJgCiAgICAgICAgVGhlIGVuZHBvaW50IHdlIGFyZSBjb25uZWN0aW5nIHRvLgogICAgY2hhbm5lbDogOmNsYXNzOmBhYmMuQ29ubmVjdGFibGVgCiAgICAgICAgVGhlIHZvaWNlIGNoYW5uZWwgY29ubmVjdGVkIHRvLgogICAgbG9vcDogOmNsYXNzOmBhc3luY2lvLkFic3RyYWN0RXZlbnRMb29wYAogICAgICAgIFRoZSBldmVudCBsb29wIHRoYXQgdGhlIHZvaWNlIGNsaWVudCBpcyBydW5uaW5nIG9uLgogICAgIiIiCiAgICBkZWYgX19pbml0X18oc2VsZiwgY2xpZW50LCBjaGFubmVsKToKICAgICAgICBpZiBub3QgaGFzX25hY2w6CiAgICAgICAgICAgIHJhaXNlIFJ1bnRpbWVFcnJvcigiUHlOYUNsIGxpYnJhcnkgbmVlZGVkIGluIG9yZGVyIHRvIHVzZSB2b2ljZSIpCgogICAgICAgIHN1cGVyKCkuX19pbml0X18oY2xpZW50LCBjaGFubmVsKQogICAgICAgIHN0YXRlID0gY2xpZW50Ll9jb25uZWN0aW9uCiAgICAgICAgc2VsZi50b2tlbiA9IE5vbmUKICAgICAgICBzZWxmLnNvY2tldCA9IE5vbmUKICAgICAgICBzZWxmLmxvb3AgPSBzdGF0ZS5sb29wCiAgICAgICAgc2VsZi5fc3RhdGUgPSBzdGF0ZQogICAgICAgICMgdGhpcyB3aWxsIGJlIHVzZWQgaW4gdGhlIEF1ZGlvUGxheWVyIHRocmVhZAogICAgICAgIHNlbGYuX2Nvbm5lY3RlZCA9IHRocmVhZGluZy5FdmVudCgpCgogICAgICAgIHNlbGYuX2hhbmRzaGFraW5nID0gRmFsc2UKICAgICAgICBzZWxmLl9wb3RlbnRpYWxseV9yZWNvbm5lY3RpbmcgPSBGYWxzZQogICAgICAgIHNlbGYuX3ZvaWNlX3N0YXRlX2NvbXBsZXRlID0gYXN5bmNpby5FdmVudCgpCiAgICAgICAgc2VsZi5fdm9pY2Vfc2VydmVyX2NvbXBsZXRlID0gYXN5bmNpby5FdmVudCgpCgogICAgICAgIHNlbGYubW9kZSA9IE5vbmUKICAgICAgICBzZWxmLl9jb25uZWN0aW9ucyA9IDAKICAgICAgICBzZWxmLnNlcXVlbmNlID0gMAogICAgICAgIHNlbGYudGltZXN0YW1wID0gMAogICAgICAgIHNlbGYuX3J1bm5lciA9IE5vbmUKICAgICAgICBzZWxmLl9wbGF5ZXIgPSBOb25lCiAgICAgICAgc2VsZi5lbmNvZGVyID0gTm9uZQogICAgICAgIHNlbGYuX2xpdGVfbm9uY2UgPSAwCiAgICAgICAgc2VsZi53cyA9IE5vbmUKCiAgICB3YXJuX25hY2wgPSBub3QgaGFzX25hY2wKICAgIHN1cHBvcnRlZF9tb2RlcyA9ICgKICAgICAgICAneHNhbHNhMjBfcG9seTEzMDVfbGl0ZScsCiAgICAgICAgJ3hzYWxzYTIwX3BvbHkxMzA1X3N1ZmZpeCcsCiAgICAgICAgJ3hzYWxzYTIwX3BvbHkxMzA1JywKICAgICkKCiAgICBAcHJvcGVydHkKICAgIGRlZiBndWlsZChzZWxmKToKICAgICAgICAiIiJPcHRpb25hbFs6Y2xhc3M6YEd1aWxkYF06IFRoZSBndWlsZCB3ZSdyZSBjb25uZWN0ZWQgdG8sIGlmIGFwcGxpY2FibGUuIiIiCiAgICAgICAgcmV0dXJuIGdldGF0dHIoc2VsZi5jaGFubmVsLCAnZ3VpbGQnLCBOb25lKQoKICAgIEBwcm9wZXJ0eQogICAgZGVmIHVzZXIoc2VsZik6CiAgICAgICAgIiIiOmNsYXNzOmBDbGllbnRVc2VyYDogVGhlIHVzZXIgY29ubmVjdGVkIHRvIHZvaWNlIChpLmUuIG91cnNlbHZlcykuIiIiCiAgICAgICAgcmV0dXJuIHNlbGYuX3N0YXRlLnVzZXIKCiAgICBkZWYgY2hlY2tlZF9hZGQoc2VsZiwgYXR0ciwgdmFsdWUsIGxpbWl0KToKICAgICAgICB2YWwgPSBnZXRhdHRyKHNlbGYsIGF0dHIpCiAgICAgICAgaWYgdmFsICsgdmFsdWUgPiBsaW1pdDoKICAgICAgICAgICAgc2V0YXR0cihzZWxmLCBhdHRyLCAwKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHNldGF0dHIoc2VsZiwgYXR0ciwgdmFsICsgdmFsdWUpCgogICAgIyBjb25uZWN0aW9uIHJlbGF0ZWQKCiAgICBhc3luYyBkZWYgb25fdm9pY2Vfc3RhdGVfdXBkYXRlKHNlbGYsIGRhdGEpOgogICAgICAgIHNlbGYuc2Vzc2lvbl9pZCA9IGRhdGFbJ3Nlc3Npb25faWQnXQogICAgICAgIGNoYW5uZWxfaWQgPSBkYXRhWydjaGFubmVsX2lkJ10KCiAgICAgICAgaWYgbm90IHNlbGYuX2hhbmRzaGFraW5nIG9yIHNlbGYuX3BvdGVudGlhbGx5X3JlY29ubmVjdGluZzoKICAgICAgICAgICAgIyBJZiB3ZSdyZSBkb25lIGhhbmRzaGFraW5nIHRoZW4gd2UganVzdCBuZWVkIHRvIHVwZGF0ZSBvdXJzZWx2ZXMKICAgICAgICAgICAgIyBJZiB3ZSdyZSBwb3RlbnRpYWxseSByZWNvbm5lY3RpbmcgZHVlIHRvIGEgNDAxNCwgdGhlbiB3ZSBuZWVkIHRvIGRpZmZlcmVudGlhdGUKICAgICAgICAgICAgIyBhIGNoYW5uZWwgbW92ZSBhbmQgYW4gYWN0dWFsIGZvcmNlIGRpc2Nvbm5lY3QKICAgICAgICAgICAgaWYgY2hhbm5lbF9pZCBpcyBOb25lOgogICAgICAgICAgICAgICAgIyBXZSdyZSBiZWluZyBkaXNjb25uZWN0ZWQgc28gY2xlYW51cAogICAgICAgICAgICAgICAgYXdhaXQgc2VsZi5kaXNjb25uZWN0KCkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGd1aWxkID0gc2VsZi5ndWlsZAogICAgICAgICAgICAgICAgc2VsZi5jaGFubmVsID0gY2hhbm5lbF9pZCBhbmQgZ3VpbGQgYW5kIGd1aWxkLmdldF9jaGFubmVsKGludChjaGFubmVsX2lkKSkKICAgICAgICBlbHNlOgogICAgICAgICAgICBzZWxmLl92b2ljZV9zdGF0ZV9jb21wbGV0ZS5zZXQoKQoKICAgIGFzeW5jIGRlZiBvbl92b2ljZV9zZXJ2ZXJfdXBkYXRlKHNlbGYsIGRhdGEpOgogICAgICAgIGlmIHNlbGYuX3ZvaWNlX3NlcnZlcl9jb21wbGV0ZS5pc19zZXQoKToKICAgICAgICAgICAgbG9nLmluZm8oJ0lnbm9yaW5nIGV4dHJhbmVvdXMgdm9pY2Ugc2VydmVyIHVwZGF0ZS4nKQogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgc2VsZi50b2tlbiA9IGRhdGEuZ2V0KCd0b2tlbicpCiAgICAgICAgc2VsZi5zZXJ2ZXJfaWQgPSBpbnQoZGF0YVsnZ3VpbGRfaWQnXSkKICAgICAgICBlbmRwb2ludCA9IGRhdGEuZ2V0KCdlbmRwb2ludCcpCgogICAgICAgIGlmIGVuZHBvaW50IGlzIE5vbmUgb3Igc2VsZi50b2tlbiBpcyBOb25lOgogICAgICAgICAgICBsb2cud2FybmluZygnQXdhaXRpbmcgZW5kcG9pbnQuLi4gVGhpcyByZXF1aXJlcyB3YWl0aW5nLiAnIFwKICAgICAgICAgICAgICAgICAgICAgICAgJ0lmIHRpbWVvdXQgb2NjdXJyZWQgY29uc2lkZXJpbmcgcmFpc2luZyB0aGUgdGltZW91dCBhbmQgcmVjb25uZWN0aW5nLicpCiAgICAgICAgICAgIHJldHVybgoKICAgICAgICBzZWxmLmVuZHBvaW50LCBfLCBfID0gZW5kcG9pbnQucnBhcnRpdGlvbignOicpCiAgICAgICAgaWYgc2VsZi5lbmRwb2ludC5zdGFydHN3aXRoKCd3c3M6Ly8nKToKICAgICAgICAgICAgIyBKdXN0IGluIGNhc2UsIHN0cmlwIGl0IG9mZiBzaW5jZSB3ZSdyZSBnb2luZyB0byBhZGQgaXQgbGF0ZXIKICAgICAgICAgICAgc2VsZi5lbmRwb2ludCA9IHNlbGYuZW5kcG9pbnRbNjpdCgogICAgICAgICMgVGhpcyBnZXRzIHNldCBsYXRlcgogICAgICAgIHNlbGYuZW5kcG9pbnRfaXAgPSBOb25lCgogICAgICAgIHNlbGYuc29ja2V0ID0gc29ja2V0LnNvY2tldChzb2NrZXQuQUZfSU5FVCwgc29ja2V0LlNPQ0tfREdSQU0pCiAgICAgICAgc2VsZi5zb2NrZXQuc2V0YmxvY2tpbmcoRmFsc2UpCgogICAgICAgIGlmIG5vdCBzZWxmLl9oYW5kc2hha2luZzoKICAgICAgICAgICAgIyBJZiB3ZSdyZSBub3QgaGFuZHNoYWtpbmcgdGhlbiB3ZSBuZWVkIHRvIHRlcm1pbmF0ZSBvdXIgcHJldmlvdXMgY29ubmVjdGlvbiBpbiB0aGUgd2Vic29ja2V0CiAgICAgICAgICAgIGF3YWl0IHNlbGYud3MuY2xvc2UoNDAwMCkKICAgICAgICAgICAgcmV0dXJuCgogICAgICAgIHNlbGYuX3ZvaWNlX3NlcnZlcl9jb21wbGV0ZS5zZXQoKQoKICAgIGFzeW5jIGRlZiB2b2ljZV9jb25uZWN0KHNlbGYpOgogICAgICAgIGF3YWl0IHNlbGYuY2hhbm5lbC5ndWlsZC5jaGFuZ2Vfdm9pY2Vfc3RhdGUoY2hhbm5lbD1zZWxmLmNoYW5uZWwpCgogICAgYXN5bmMgZGVmIHZvaWNlX2Rpc2Nvbm5lY3Qoc2VsZik6CiAgICAgICAgbG9nLmluZm8oJ1RoZSB2b2ljZSBoYW5kc2hha2UgaXMgYmVpbmcgdGVybWluYXRlZCBmb3IgQ2hhbm5lbCBJRCAlcyAoR3VpbGQgSUQgJXMpJywgc2VsZi5jaGFubmVsLmlkLCBzZWxmLmd1aWxkLmlkKQogICAgICAgIGF3YWl0IHNlbGYuY2hhbm5lbC5ndWlsZC5jaGFuZ2Vfdm9pY2Vfc3RhdGUoY2hhbm5lbD1Ob25lKQoKICAgIGRlZiBwcmVwYXJlX2hhbmRzaGFrZShzZWxmKToKICAgICAgICBzZWxmLl92b2ljZV9zdGF0ZV9jb21wbGV0ZS5jbGVhcigpCiAgICAgICAgc2VsZi5fdm9pY2Vfc2VydmVyX2NvbXBsZXRlLmNsZWFyKCkKICAgICAgICBzZWxmLl9oYW5kc2hha2luZyA9IFRydWUKICAgICAgICBsb2cuaW5mbygnU3RhcnRpbmcgdm9pY2UgaGFuZHNoYWtlLi4uIChjb25uZWN0aW9uIGF0dGVtcHQgJWQpJywgc2VsZi5fY29ubmVjdGlvbnMgKyAxKQogICAgICAgIHNlbGYuX2Nvbm5lY3Rpb25zICs9IDEKCiAgICBkZWYgZmluaXNoX2hhbmRzaGFrZShzZWxmKToKICAgICAgICBsb2cuaW5mbygnVm9pY2UgaGFuZHNoYWtlIGNvbXBsZXRlLiBFbmRwb2ludCBmb3VuZCAlcycsIHNlbGYuZW5kcG9pbnQpCiAgICAgICAgc2VsZi5faGFuZHNoYWtpbmcgPSBGYWxzZQogICAgICAgIHNlbGYuX3ZvaWNlX3NlcnZlcl9jb21wbGV0ZS5jbGVhcigpCiAgICAgICAgc2VsZi5fdm9pY2Vfc3RhdGVfY29tcGxldGUuY2xlYXIoKQoKICAgIGFzeW5jIGRlZiBjb25uZWN0X3dlYnNvY2tldChzZWxmKToKICAgICAgICB3cyA9IGF3YWl0IERpc2NvcmRWb2ljZVdlYlNvY2tldC5mcm9tX2NsaWVudChzZWxmKQogICAgICAgIHNlbGYuX2Nvbm5lY3RlZC5jbGVhcigpCiAgICAgICAgd2hpbGUgd3Muc2VjcmV0X2tleSBpcyBOb25lOgogICAgICAgICAgICBhd2FpdCB3cy5wb2xsX2V2ZW50KCkKICAgICAgICBzZWxmLl9jb25uZWN0ZWQuc2V0KCkKICAgICAgICByZXR1cm4gd3MKCiAgICBhc3luYyBkZWYgY29ubmVjdChzZWxmLCAqLCByZWNvbm5lY3QsIHRpbWVvdXQpOgogICAgICAgIGxvZy5pbmZvKCdDb25uZWN0aW5nIHRvIHZvaWNlLi4uJykKICAgICAgICBzZWxmLnRpbWVvdXQgPSB0aW1lb3V0CgogICAgICAgIGZvciBpIGluIHJhbmdlKDUpOgogICAgICAgICAgICBzZWxmLnByZXBhcmVfaGFuZHNoYWtlKCkKCiAgICAgICAgICAgICMgVGhpcyBoYXMgdG8gYmUgY3JlYXRlZCBiZWZvcmUgd2Ugc3RhcnQgdGhlIGZsb3cuCiAgICAgICAgICAgIGZ1dHVyZXMgPSBbCiAgICAgICAgICAgICAgICBzZWxmLl92b2ljZV9zdGF0ZV9jb21wbGV0ZS53YWl0KCksCiAgICAgICAgICAgICAgICBzZWxmLl92b2ljZV9zZXJ2ZXJfY29tcGxldGUud2FpdCgpLAogICAgICAgICAgICBdCgogICAgICAgICAgICAjIFN0YXJ0IHRoZSBjb25uZWN0aW9uIGZsb3cKICAgICAgICAgICAgYXdhaXQgc2VsZi52b2ljZV9jb25uZWN0KCkKCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGF3YWl0IHV0aWxzLnNhbmVfd2FpdF9mb3IoZnV0dXJlcywgdGltZW91dD10aW1lb3V0KQogICAgICAgICAgICBleGNlcHQgYXN5bmNpby5UaW1lb3V0RXJyb3I6CiAgICAgICAgICAgICAgICBhd2FpdCBzZWxmLmRpc2Nvbm5lY3QoZm9yY2U9VHJ1ZSkKICAgICAgICAgICAgICAgIHJhaXNlCgogICAgICAgICAgICBzZWxmLmZpbmlzaF9oYW5kc2hha2UoKQoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgc2VsZi53cyA9IGF3YWl0IHNlbGYuY29ubmVjdF93ZWJzb2NrZXQoKQogICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgZXhjZXB0IChDb25uZWN0aW9uQ2xvc2VkLCBhc3luY2lvLlRpbWVvdXRFcnJvcik6CiAgICAgICAgICAgICAgICBpZiByZWNvbm5lY3Q6CiAgICAgICAgICAgICAgICAgICAgbG9nLmV4Y2VwdGlvbignRmFpbGVkIHRvIGNvbm5lY3QgdG8gdm9pY2UuLi4gUmV0cnlpbmcuLi4nKQogICAgICAgICAgICAgICAgICAgIGF3YWl0IGFzeW5jaW8uc2xlZXAoMSArIGkgKiAyLjApCiAgICAgICAgICAgICAgICAgICAgYXdhaXQgc2VsZi52b2ljZV9kaXNjb25uZWN0KCkKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICByYWlzZQoKICAgICAgICBpZiBzZWxmLl9ydW5uZXIgaXMgTm9uZToKICAgICAgICAgICAgc2VsZi5fcnVubmVyID0gc2VsZi5sb29wLmNyZWF0ZV90YXNrKHNlbGYucG9sbF92b2ljZV93cyhyZWNvbm5lY3QpKQoKICAgIGFzeW5jIGRlZiBwb3RlbnRpYWxfcmVjb25uZWN0KHNlbGYpOgogICAgICAgICMgQXR0ZW1wdCB0byBzdG9wIHRoZSBwbGF5ZXIgdGhyZWFkIGZyb20gcGxheWluZyBlYXJseQogICAgICAgIHNlbGYuX2Nvbm5lY3RlZC5jbGVhcigpCiAgICAgICAgc2VsZi5wcmVwYXJlX2hhbmRzaGFrZSgpCiAgICAgICAgc2VsZi5fcG90ZW50aWFsbHlfcmVjb25uZWN0aW5nID0gVHJ1ZQogICAgICAgIHRyeToKICAgICAgICAgICAgIyBXZSBvbmx5IGNhcmUgYWJvdXQgVk9JQ0VfU0VSVkVSX1VQREFURSBzaW5jZSBWT0lDRV9TVEFURV9VUERBVEUgY2FuIGNvbWUgYmVmb3JlIHdlIGdldCBkaXNjb25uZWN0ZWQKICAgICAgICAgICAgYXdhaXQgYXN5bmNpby53YWl0X2ZvcihzZWxmLl92b2ljZV9zZXJ2ZXJfY29tcGxldGUud2FpdCgpLCB0aW1lb3V0PXNlbGYudGltZW91dCkKICAgICAgICBleGNlcHQgYXN5bmNpby5UaW1lb3V0RXJyb3I6CiAgICAgICAgICAgIHNlbGYuX3BvdGVudGlhbGx5X3JlY29ubmVjdGluZyA9IEZhbHNlCiAgICAgICAgICAgIGF3YWl0IHNlbGYuZGlzY29ubmVjdChmb3JjZT1UcnVlKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICAgICAgc2VsZi5maW5pc2hfaGFuZHNoYWtlKCkKICAgICAgICBzZWxmLl9wb3RlbnRpYWxseV9yZWNvbm5lY3RpbmcgPSBGYWxzZQogICAgICAgIHRyeToKICAgICAgICAgICAgc2VsZi53cyA9IGF3YWl0IHNlbGYuY29ubmVjdF93ZWJzb2NrZXQoKQogICAgICAgIGV4Y2VwdCAoQ29ubmVjdGlvbkNsb3NlZCwgYXN5bmNpby5UaW1lb3V0RXJyb3IpOgogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gVHJ1ZQoKICAgIEBwcm9wZXJ0eQogICAgZGVmIGxhdGVuY3koc2VsZik6CiAgICAgICAgIiIiOmNsYXNzOmBmbG9hdGA6IExhdGVuY3kgYmV0d2VlbiBhIEhFQVJUQkVBVCBhbmQgYSBIRUFSVEJFQVRfQUNLIGluIHNlY29uZHMuCgogICAgICAgIFRoaXMgY291bGQgYmUgcmVmZXJyZWQgdG8gYXMgdGhlIERpc2NvcmQgVm9pY2UgV2ViU29ja2V0IGxhdGVuY3kgYW5kIGlzCiAgICAgICAgYW4gYW5hbG9ndWUgb2YgdXNlcidzIHZvaWNlIGxhdGVuY2llcyBhcyBzZWVuIGluIHRoZSBEaXNjb3JkIGNsaWVudC4KCiAgICAgICAgLi4gdmVyc2lvbmFkZGVkOjogMS40CiAgICAgICAgIiIiCiAgICAgICAgd3MgPSBzZWxmLndzCiAgICAgICAgcmV0dXJuIGZsb2F0KCJpbmYiKSBpZiBub3Qgd3MgZWxzZSB3cy5sYXRlbmN5CgogICAgQHByb3BlcnR5CiAgICBkZWYgYXZlcmFnZV9sYXRlbmN5KHNlbGYpOgogICAgICAgICIiIjpjbGFzczpgZmxvYXRgOiBBdmVyYWdlIG9mIG1vc3QgcmVjZW50IDIwIEhFQVJUQkVBVCBsYXRlbmNpZXMgaW4gc2Vjb25kcy4KCiAgICAgICAgLi4gdmVyc2lvbmFkZGVkOjogMS40CiAgICAgICAgIiIiCiAgICAgICAgd3MgPSBzZWxmLndzCiAgICAgICAgcmV0dXJuIGZsb2F0KCJpbmYiKSBpZiBub3Qgd3MgZWxzZSB3cy5hdmVyYWdlX2xhdGVuY3kKCiAgICBhc3luYyBkZWYgcG9sbF92b2ljZV93cyhzZWxmLCByZWNvbm5lY3QpOgogICAgICAgIGJhY2tvZmYgPSBFeHBvbmVudGlhbEJhY2tvZmYoKQogICAgICAgIHdoaWxlIFRydWU6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGF3YWl0IHNlbGYud3MucG9sbF9ldmVudCgpCiAgICAgICAgICAgIGV4Y2VwdCAoQ29ubmVjdGlvbkNsb3NlZCwgYXN5bmNpby5UaW1lb3V0RXJyb3IpIGFzIGV4YzoKICAgICAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UoZXhjLCBDb25uZWN0aW9uQ2xvc2VkKToKICAgICAgICAgICAgICAgICAgICAjIFRoZSBmb2xsb3dpbmcgY2xvc2UgY29kZXMgYXJlIHVuZG9jdW1lbnRlZCBzbyBJIHdpbGwgZG9jdW1lbnQgdGhlbSBoZXJlLgogICAgICAgICAgICAgICAgICAgICMgMTAwMCAtIG5vcm1hbCBjbG9zdXJlIChvYnZpb3VzbHkpCiAgICAgICAgICAgICAgICAgICAgIyA0MDE0IC0gdm9pY2UgY2hhbm5lbCBoYXMgYmVlbiBkZWxldGVkLgogICAgICAgICAgICAgICAgICAgICMgNDAxNSAtIHZvaWNlIHNlcnZlciBoYXMgY3Jhc2hlZAogICAgICAgICAgICAgICAgICAgIGlmIGV4Yy5jb2RlIGluICgxMDAwLCA0MDE1KToKICAgICAgICAgICAgICAgICAgICAgICAgbG9nLmluZm8oJ0Rpc2Nvbm5lY3RpbmcgZnJvbSB2b2ljZSBub3JtYWxseSwgY2xvc2UgY29kZSAlZC4nLCBleGMuY29kZSkKICAgICAgICAgICAgICAgICAgICAgICAgYXdhaXQgc2VsZi5kaXNjb25uZWN0KCkKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICAgICBpZiBleGMuY29kZSA9PSA0MDE0OgogICAgICAgICAgICAgICAgICAgICAgICBsb2cuaW5mbygnRGlzY29ubmVjdGVkIGZyb20gdm9pY2UgYnkgZm9yY2UuLi4gcG90ZW50aWFsbHkgcmVjb25uZWN0aW5nLicpCiAgICAgICAgICAgICAgICAgICAgICAgIHN1Y2Nlc3NmdWwgPSBhd2FpdCBzZWxmLnBvdGVudGlhbF9yZWNvbm5lY3QoKQogICAgICAgICAgICAgICAgICAgICAgICBpZiBub3Qgc3VjY2Vzc2Z1bDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZy5pbmZvKCdSZWNvbm5lY3Qgd2FzIHVuc3VjY2Vzc2Z1bCwgZGlzY29ubmVjdGluZyBmcm9tIHZvaWNlIG5vcm1hbGx5Li4uJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF3YWl0IHNlbGYuZGlzY29ubmVjdCgpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgICAgICAgICBpZiBub3QgcmVjb25uZWN0OgogICAgICAgICAgICAgICAgICAgIGF3YWl0IHNlbGYuZGlzY29ubmVjdCgpCiAgICAgICAgICAgICAgICAgICAgcmFpc2UKCiAgICAgICAgICAgICAgICByZXRyeSA9IGJhY2tvZmYuZGVsYXkoKQogICAgICAgICAgICAgICAgbG9nLmV4Y2VwdGlvbignRGlzY29ubmVjdGVkIGZyb20gdm9pY2UuLi4gUmVjb25uZWN0aW5nIGluICUuMmZzLicsIHJldHJ5KQogICAgICAgICAgICAgICAgc2VsZi5fY29ubmVjdGVkLmNsZWFyKCkKICAgICAgICAgICAgICAgIGF3YWl0IGFzeW5jaW8uc2xlZXAocmV0cnkpCiAgICAgICAgICAgICAgICBhd2FpdCBzZWxmLnZvaWNlX2Rpc2Nvbm5lY3QoKQogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIGF3YWl0IHNlbGYuY29ubmVjdChyZWNvbm5lY3Q9VHJ1ZSwgdGltZW91dD1zZWxmLnRpbWVvdXQpCiAgICAgICAgICAgICAgICBleGNlcHQgYXN5bmNpby5UaW1lb3V0RXJyb3I6CiAgICAgICAgICAgICAgICAgICAgIyBhdCB0aGlzIHBvaW50IHdlJ3ZlIHJldHJpZWQgNSB0aW1lcy4uLiBsZXQncyBjb250aW51ZSB0aGUgbG9vcC4KICAgICAgICAgICAgICAgICAgICBsb2cud2FybmluZygnQ291bGQgbm90IGNvbm5lY3QgdG8gdm9pY2UuLi4gUmV0cnlpbmcuLi4nKQogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCgogICAgYXN5bmMgZGVmIGRpc2Nvbm5lY3Qoc2VsZiwgKiwgZm9yY2U9RmFsc2UpOgogICAgICAgICIiInxjb3JvfAoKICAgICAgICBEaXNjb25uZWN0cyB0aGlzIHZvaWNlIGNsaWVudCBmcm9tIHZvaWNlLgogICAgICAgICIiIgogICAgICAgIGlmIG5vdCBmb3JjZSBhbmQgbm90IHNlbGYuaXNfY29ubmVjdGVkKCk6CiAgICAgICAgICAgIHJldHVybgoKICAgICAgICBzZWxmLnN0b3AoKQogICAgICAgIHNlbGYuX2Nvbm5lY3RlZC5jbGVhcigpCgogICAgICAgIHRyeToKICAgICAgICAgICAgaWYgc2VsZi53czoKICAgICAgICAgICAgICAgIGF3YWl0IHNlbGYud3MuY2xvc2UoKQoKICAgICAgICAgICAgYXdhaXQgc2VsZi52b2ljZV9kaXNjb25uZWN0KCkKICAgICAgICBmaW5hbGx5OgogICAgICAgICAgICBzZWxmLmNsZWFudXAoKQogICAgICAgICAgICBpZiBzZWxmLnNvY2tldDoKICAgICAgICAgICAgICAgIHNlbGYuc29ja2V0LmNsb3NlKCkKCiAgICBhc3luYyBkZWYgbW92ZV90byhzZWxmLCBjaGFubmVsKToKICAgICAgICAiIiJ8Y29yb3wKCiAgICAgICAgTW92ZXMgeW91IHRvIGEgZGlmZmVyZW50IHZvaWNlIGNoYW5uZWwuCgogICAgICAgIFBhcmFtZXRlcnMKICAgICAgICAtLS0tLS0tLS0tLQogICAgICAgIGNoYW5uZWw6IDpjbGFzczpgYWJjLlNub3dmbGFrZWAKICAgICAgICAgICAgVGhlIGNoYW5uZWwgdG8gbW92ZSB0by4gTXVzdCBiZSBhIHZvaWNlIGNoYW5uZWwuCiAgICAgICAgIiIiCiAgICAgICAgYXdhaXQgc2VsZi5jaGFubmVsLmd1aWxkLmNoYW5nZV92b2ljZV9zdGF0ZShjaGFubmVsPWNoYW5uZWwpCgogICAgZGVmIGlzX2Nvbm5lY3RlZChzZWxmKToKICAgICAgICAiIiJJbmRpY2F0ZXMgaWYgdGhlIHZvaWNlIGNsaWVudCBpcyBjb25uZWN0ZWQgdG8gdm9pY2UuIiIiCiAgICAgICAgcmV0dXJuIHNlbGYuX2Nvbm5lY3RlZC5pc19zZXQoKQoKICAgICMgYXVkaW8gcmVsYXRlZAoKICAgIGRlZiBfZ2V0X3ZvaWNlX3BhY2tldChzZWxmLCBkYXRhKToKICAgICAgICBoZWFkZXIgPSBieXRlYXJyYXkoMTIpCgogICAgICAgICMgRm9ybXVsYXRlIHJ0cCBoZWFkZXIKICAgICAgICBoZWFkZXJbMF0gPSAweDgwCiAgICAgICAgaGVhZGVyWzFdID0gMHg3OAogICAgICAgIHN0cnVjdC5wYWNrX2ludG8oJz5IJywgaGVhZGVyLCAyLCBzZWxmLnNlcXVlbmNlKQogICAgICAgIHN0cnVjdC5wYWNrX2ludG8oJz5JJywgaGVhZGVyLCA0LCBzZWxmLnRpbWVzdGFtcCkKICAgICAgICBzdHJ1Y3QucGFja19pbnRvKCc+SScsIGhlYWRlciwgOCwgc2VsZi5zc3JjKQoKICAgICAgICBlbmNyeXB0X3BhY2tldCA9IGdldGF0dHIoc2VsZiwgJ19lbmNyeXB0XycgKyBzZWxmLm1vZGUpCiAgICAgICAgcmV0dXJuIGVuY3J5cHRfcGFja2V0KGhlYWRlciwgZGF0YSkKCiAgICBkZWYgX2VuY3J5cHRfeHNhbHNhMjBfcG9seTEzMDUoc2VsZiwgaGVhZGVyLCBkYXRhKToKICAgICAgICBib3ggPSBuYWNsLnNlY3JldC5TZWNyZXRCb3goYnl0ZXMoc2VsZi5zZWNyZXRfa2V5KSkKICAgICAgICBub25jZSA9IGJ5dGVhcnJheSgyNCkKICAgICAgICBub25jZVs6MTJdID0gaGVhZGVyCgogICAgICAgIHJldHVybiBoZWFkZXIgKyBib3guZW5jcnlwdChieXRlcyhkYXRhKSwgYnl0ZXMobm9uY2UpKS5jaXBoZXJ0ZXh0CgogICAgZGVmIF9lbmNyeXB0X3hzYWxzYTIwX3BvbHkxMzA1X3N1ZmZpeChzZWxmLCBoZWFkZXIsIGRhdGEpOgogICAgICAgIGJveCA9IG5hY2wuc2VjcmV0LlNlY3JldEJveChieXRlcyhzZWxmLnNlY3JldF9rZXkpKQogICAgICAgIG5vbmNlID0gbmFjbC51dGlscy5yYW5kb20obmFjbC5zZWNyZXQuU2VjcmV0Qm94Lk5PTkNFX1NJWkUpCgogICAgICAgIHJldHVybiBoZWFkZXIgKyBib3guZW5jcnlwdChieXRlcyhkYXRhKSwgbm9uY2UpLmNpcGhlcnRleHQgKyBub25jZQoKICAgIGRlZiBfZW5jcnlwdF94c2Fsc2EyMF9wb2x5MTMwNV9saXRlKHNlbGYsIGhlYWRlciwgZGF0YSk6CiAgICAgICAgYm94ID0gbmFjbC5zZWNyZXQuU2VjcmV0Qm94KGJ5dGVzKHNlbGYuc2VjcmV0X2tleSkpCiAgICAgICAgbm9uY2UgPSBieXRlYXJyYXkoMjQpCgogICAgICAgIG5vbmNlWzo0XSA9IHN0cnVjdC5wYWNrKCc+SScsIHNlbGYuX2xpdGVfbm9uY2UpCiAgICAgICAgc2VsZi5jaGVja2VkX2FkZCgnX2xpdGVfbm9uY2UnLCAxLCA0Mjk0OTY3Mjk1KQoKICAgICAgICByZXR1cm4gaGVhZGVyICsgYm94LmVuY3J5cHQoYnl0ZXMoZGF0YSksIGJ5dGVzKG5vbmNlKSkuY2lwaGVydGV4dCArIG5vbmNlWzo0XQoKICAgIGRlZiBwbGF5KHNlbGYsIHNvdXJjZSwgKiwgYWZ0ZXI9Tm9uZSk6CiAgICAgICAgIiIiUGxheXMgYW4gOmNsYXNzOmBBdWRpb1NvdXJjZWAuCgogICAgICAgIFRoZSBmaW5hbGl6ZXIsIGBgYWZ0ZXJgYCBpcyBjYWxsZWQgYWZ0ZXIgdGhlIHNvdXJjZSBoYXMgYmVlbiBleGhhdXN0ZWQKICAgICAgICBvciBhbiBlcnJvciBvY2N1cnJlZC4KCiAgICAgICAgSWYgYW4gZXJyb3IgaGFwcGVucyB3aGlsZSB0aGUgYXVkaW8gcGxheWVyIGlzIHJ1bm5pbmcsIHRoZSBleGNlcHRpb24gaXMKICAgICAgICBjYXVnaHQgYW5kIHRoZSBhdWRpbyBwbGF5ZXIgaXMgdGhlbiBzdG9wcGVkLiAgSWYgbm8gYWZ0ZXIgY2FsbGJhY2sgaXMKICAgICAgICBwYXNzZWQsIGFueSBjYXVnaHQgZXhjZXB0aW9uIHdpbGwgYmUgZGlzcGxheWVkIGFzIGlmIGl0IHdlcmUgcmFpc2VkLgoKICAgICAgICBQYXJhbWV0ZXJzCiAgICAgICAgLS0tLS0tLS0tLS0KICAgICAgICBzb3VyY2U6IDpjbGFzczpgQXVkaW9Tb3VyY2VgCiAgICAgICAgICAgIFRoZSBhdWRpbyBzb3VyY2Ugd2UncmUgcmVhZGluZyBmcm9tLgogICAgICAgIGFmdGVyOiBDYWxsYWJsZVtbOmNsYXNzOmBFeGNlcHRpb25gXSwgQW55XQogICAgICAgICAgICBUaGUgZmluYWxpemVyIHRoYXQgaXMgY2FsbGVkIGFmdGVyIHRoZSBzdHJlYW0gaXMgZXhoYXVzdGVkLgogICAgICAgICAgICBUaGlzIGZ1bmN0aW9uIG11c3QgaGF2ZSBhIHNpbmdsZSBwYXJhbWV0ZXIsIGBgZXJyb3JgYCwgdGhhdAogICAgICAgICAgICBkZW5vdGVzIGFuIG9wdGlvbmFsIGV4Y2VwdGlvbiB0aGF0IHdhcyByYWlzZWQgZHVyaW5nIHBsYXlpbmcuCgogICAgICAgIFJhaXNlcwogICAgICAgIC0tLS0tLS0KICAgICAgICBDbGllbnRFeGNlcHRpb24KICAgICAgICAgICAgQWxyZWFkeSBwbGF5aW5nIGF1ZGlvIG9yIG5vdCBjb25uZWN0ZWQuCiAgICAgICAgVHlwZUVycm9yCiAgICAgICAgICAgIFNvdXJjZSBpcyBub3QgYSA6Y2xhc3M6YEF1ZGlvU291cmNlYCBvciBhZnRlciBpcyBub3QgYSBjYWxsYWJsZS4KICAgICAgICBPcHVzTm90TG9hZGVkCiAgICAgICAgICAgIFNvdXJjZSBpcyBub3Qgb3B1cyBlbmNvZGVkIGFuZCBvcHVzIGlzIG5vdCBsb2FkZWQuCiAgICAgICAgIiIiCgogICAgICAgIGlmIG5vdCBzZWxmLmlzX2Nvbm5lY3RlZCgpOgogICAgICAgICAgICByYWlzZSBDbGllbnRFeGNlcHRpb24oJ05vdCBjb25uZWN0ZWQgdG8gdm9pY2UuJykKCiAgICAgICAgaWYgc2VsZi5pc19wbGF5aW5nKCk6CiAgICAgICAgICAgIHJhaXNlIENsaWVudEV4Y2VwdGlvbignQWxyZWFkeSBwbGF5aW5nIGF1ZGlvLicpCgogICAgICAgIGlmIG5vdCBpc2luc3RhbmNlKHNvdXJjZSwgQXVkaW9Tb3VyY2UpOgogICAgICAgICAgICByYWlzZSBUeXBlRXJyb3IoJ3NvdXJjZSBtdXN0IGFuIEF1ZGlvU291cmNlIG5vdCB7MC5fX2NsYXNzX18uX19uYW1lX199Jy5mb3JtYXQoc291cmNlKSkKCiAgICAgICAgaWYgbm90IHNlbGYuZW5jb2RlciBhbmQgbm90IHNvdXJjZS5pc19vcHVzKCk6CiAgICAgICAgICAgIHNlbGYuZW5jb2RlciA9IG9wdXMuRW5jb2RlcigpCgogICAgICAgIHNlbGYuX3BsYXllciA9IEF1ZGlvUGxheWVyKHNvdXJjZSwgc2VsZiwgYWZ0ZXI9YWZ0ZXIpCiAgICAgICAgc2VsZi5fcGxheWVyLnN0YXJ0KCkKCiAgICBkZWYgaXNfcGxheWluZyhzZWxmKToKICAgICAgICAiIiJJbmRpY2F0ZXMgaWYgd2UncmUgY3VycmVudGx5IHBsYXlpbmcgYXVkaW8uIiIiCiAgICAgICAgcmV0dXJuIHNlbGYuX3BsYXllciBpcyBub3QgTm9uZSBhbmQgc2VsZi5fcGxheWVyLmlzX3BsYXlpbmcoKQoKICAgIGRlZiBpc19wYXVzZWQoc2VsZik6CiAgICAgICAgIiIiSW5kaWNhdGVzIGlmIHdlJ3JlIHBsYXlpbmcgYXVkaW8sIGJ1dCBpZiB3ZSdyZSBwYXVzZWQuIiIiCiAgICAgICAgcmV0dXJuIHNlbGYuX3BsYXllciBpcyBub3QgTm9uZSBhbmQgc2VsZi5fcGxheWVyLmlzX3BhdXNlZCgpCgogICAgZGVmIHN0b3Aoc2VsZik6CiAgICAgICAgIiIiU3RvcHMgcGxheWluZyBhdWRpby4iIiIKICAgICAgICBpZiBzZWxmLl9wbGF5ZXI6CiAgICAgICAgICAgIHNlbGYuX3BsYXllci5zdG9wKCkKICAgICAgICAgICAgc2VsZi5fcGxheWVyID0gTm9uZQoKICAgIGRlZiBwYXVzZShzZWxmKToKICAgICAgICAiIiJQYXVzZXMgdGhlIGF1ZGlvIHBsYXlpbmcuIiIiCiAgICAgICAgaWYgc2VsZi5fcGxheWVyOgogICAgICAgICAgICBzZWxmLl9wbGF5ZXIucGF1c2UoKQoKICAgIGRlZiByZXN1bWUoc2VsZik6CiAgICAgICAgIiIiUmVzdW1lcyB0aGUgYXVkaW8gcGxheWluZy4iIiIKICAgICAgICBpZiBzZWxmLl9wbGF5ZXI6CiAgICAgICAgICAgIHNlbGYuX3BsYXllci5yZXN1bWUoKQoKICAgIEBwcm9wZXJ0eQogICAgZGVmIHNvdXJjZShzZWxmKToKICAgICAgICAiIiJPcHRpb25hbFs6Y2xhc3M6YEF1ZGlvU291cmNlYF06IFRoZSBhdWRpbyBzb3VyY2UgYmVpbmcgcGxheWVkLCBpZiBwbGF5aW5nLgoKICAgICAgICBUaGlzIHByb3BlcnR5IGNhbiBhbHNvIGJlIHVzZWQgdG8gY2hhbmdlIHRoZSBhdWRpbyBzb3VyY2UgY3VycmVudGx5IGJlaW5nIHBsYXllZC4KICAgICAgICAiIiIKICAgICAgICByZXR1cm4gc2VsZi5fcGxheWVyLnNvdXJjZSBpZiBzZWxmLl9wbGF5ZXIgZWxzZSBOb25lCgogICAgQHNvdXJjZS5zZXR0ZXIKICAgIGRlZiBzb3VyY2Uoc2VsZiwgdmFsdWUpOgogICAgICAgIGlmIG5vdCBpc2luc3RhbmNlKHZhbHVlLCBBdWRpb1NvdXJjZSk6CiAgICAgICAgICAgIHJhaXNlIFR5cGVFcnJvcignZXhwZWN0ZWQgQXVkaW9Tb3VyY2Ugbm90IHswLl9fY2xhc3NfXy5fX25hbWVfX30uJy5mb3JtYXQodmFsdWUpKQoKICAgICAgICBpZiBzZWxmLl9wbGF5ZXIgaXMgTm9uZToKICAgICAgICAgICAgcmFpc2UgVmFsdWVFcnJvcignTm90IHBsYXlpbmcgYW55dGhpbmcuJykKCiAgICAgICAgc2VsZi5fcGxheWVyLl9zZXRfc291cmNlKHZhbHVlKQoKICAgIGRlZiBzZW5kX2F1ZGlvX3BhY2tldChzZWxmLCBkYXRhLCAqLCBlbmNvZGU9VHJ1ZSk6CiAgICAgICAgIiIiU2VuZHMgYW4gYXVkaW8gcGFja2V0IGNvbXBvc2VkIG9mIHRoZSBkYXRhLgoKICAgICAgICBZb3UgbXVzdCBiZSBjb25uZWN0ZWQgdG8gcGxheSBhdWRpby4KCiAgICAgICAgUGFyYW1ldGVycwogICAgICAgIC0tLS0tLS0tLS0KICAgICAgICBkYXRhOiA6Y2xhc3M6YGJ5dGVzYAogICAgICAgICAgICBUaGUgOnRlcm06YHB5OmJ5dGVzLWxpa2Ugb2JqZWN0YCBkZW5vdGluZyBQQ00gb3IgT3B1cyB2b2ljZSBkYXRhLgogICAgICAgIGVuY29kZTogOmNsYXNzOmBib29sYAogICAgICAgICAgICBJbmRpY2F0ZXMgaWYgYGBkYXRhYGAgc2hvdWxkIGJlIGVuY29kZWQgaW50byBPcHVzLgoKICAgICAgICBSYWlzZXMKICAgICAgICAtLS0tLS0tCiAgICAgICAgQ2xpZW50RXhjZXB0aW9uCiAgICAgICAgICAgIFlvdSBhcmUgbm90IGNvbm5lY3RlZC4KICAgICAgICBvcHVzLk9wdXNFcnJvcgogICAgICAgICAgICBFbmNvZGluZyB0aGUgZGF0YSBmYWlsZWQuCiAgICAgICAgIiIiCgogICAgICAgIHNlbGYuY2hlY2tlZF9hZGQoJ3NlcXVlbmNlJywgMSwgNjU1MzUpCiAgICAgICAgaWYgZW5jb2RlOgogICAgICAgICAgICBlbmNvZGVkX2RhdGEgPSBzZWxmLmVuY29kZXIuZW5jb2RlKGRhdGEsIHNlbGYuZW5jb2Rlci5TQU1QTEVTX1BFUl9GUkFNRSkKICAgICAgICBlbHNlOgogICAgICAgICAgICBlbmNvZGVkX2RhdGEgPSBkYXRhCiAgICAgICAgcGFja2V0ID0gc2VsZi5fZ2V0X3ZvaWNlX3BhY2tldChlbmNvZGVkX2RhdGEpCiAgICAgICAgdHJ5OgogICAgICAgICAgICBzZWxmLnNvY2tldC5zZW5kdG8ocGFja2V0LCAoc2VsZi5lbmRwb2ludF9pcCwgc2VsZi52b2ljZV9wb3J0KSkKICAgICAgICBleGNlcHQgQmxvY2tpbmdJT0Vycm9yOgogICAgICAgICAgICBsb2cud2FybmluZygnQSBwYWNrZXQgaGFzIGJlZW4gZHJvcHBlZCAoc2VxOiAlcywgdGltZXN0YW1wOiAlcyknLCBzZWxmLnNlcXVlbmNlLCBzZWxmLnRpbWVzdGFtcCkKCiAgICAgICAgc2VsZi5jaGVja2VkX2FkZCgndGltZXN0YW1wJywgb3B1cy5FbmNvZGVyLlNBTVBMRVNfUEVSX0ZSQU1FLCA0Mjk0OTY3Mjk1KQo=
