statistics:
  total_files: 1
  skipped_files: 0.0
  processed_objects: 1
  malicious_objects: 0
details:
- path: .repo_cache/malicious_repos/pypi_malregistry/python-aliyun-sdk-core/2.13.36/python-aliyun-sdk-core-2.13.36/python-aliyun-sdk-core-2.13.36/aliyunsdkcore/vendored/requests/packages/urllib3/packages/socks.py
  contents:
  - name: <module>
    score: 0.0
    code: |-
      """SocksiPy - Python SOCKS module.

      Copyright 2006 Dan-Haim. All rights reserved.

      Redistribution and use in source and binary forms, with or without
      modification, are permitted provided that the following conditions are met:
      1. Redistributions of source code must retain the above copyright notice, this
         list of conditions and the following disclaimer.
      2. Redistributions in binary form must reproduce the above copyright notice,
         this list of conditions and the following disclaimer in the documentation
         and/or other materials provided with the distribution.
      3. Neither the name of Dan Haim nor the names of his contributors may be used
         to endorse or promote products derived from this software without specific
         prior written permission.

      THIS SOFTWARE IS PROVIDED BY DAN HAIM "AS IS" AND ANY EXPRESS OR IMPLIED
      WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF
      MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO
      EVENT SHALL DAN HAIM OR HIS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,
      INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
      LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA
      OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
      LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
      OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.


      This module provides a standard socket-like interface for Python
      for tunneling connections through SOCKS proxies.

      ===============================================================================

      Minor modifications made by Christopher Gilbert (http://motomastyle.com/)
      for use in PyLoris (http://pyloris.sourceforge.net/)

      Minor modifications made by Mario Vilas (http://breakingcode.wordpress.com/)
      mainly to merge bug fixes found in Sourceforge

      Modifications made by Anorov (https://github.com/Anorov)
      -Forked and renamed to PySocks
      -Fixed issue with HTTP proxy failure checking (same bug that was in the
       old ___recvall() method)
      -Included SocksiPyHandler (sockshandler.py), to be used as a urllib2 handler,
       courtesy of e000 (https://github.com/e000):
       https://gist.github.com/869791#file_socksipyhandler.py
      -Re-styled code to make it readable
          -Aliased PROXY_TYPE_SOCKS5 -> SOCKS5 etc.
          -Improved exception handling and output
          -Removed irritating use of sequence indexes, replaced with tuple unpacked
           variables
          -Fixed up Python 3 bytestring handling - chr(0x03).encode() -> b"\x03"
          -Other general fixes
      -Added clarification that the HTTP proxy connection method only supports
       CONNECT-style tunneling HTTP proxies
      -Various small bug fixes
      """

      from base64 import b64encode
      try:
          from collections.abc import Callable
      except ImportError:
          from collections import Callable
      from errno import EOPNOTSUPP, EINVAL, EAGAIN
      import functools
      from io import BytesIO
      import logging
      import os
      from os import SEEK_CUR
      import socket
      import struct
      import sys

      __version__ = "1.6.7"


      if os.name == "nt" and sys.version_info < (3, 0):
          try:
              import win_inet_pton
          except ImportError:
              raise ImportError(
                  "To run PySocks on Windows you must install win_inet_pton")

      log = logging.getLogger(__name__)

      PROXY_TYPE_SOCKS4 = SOCKS4 = 1
      PROXY_TYPE_SOCKS5 = SOCKS5 = 2
      PROXY_TYPE_HTTP = HTTP = 3

      PROXY_TYPES = {"SOCKS4": SOCKS4, "SOCKS5": SOCKS5, "HTTP": HTTP}
      PRINTABLE_PROXY_TYPES = dict(zip(PROXY_TYPES.values(), PROXY_TYPES.keys()))

      _orgsocket = _orig_socket = socket.socket


      def set_self_blocking(function):

          @functools.wraps(function)
          def wrapper(*args, **kwargs):
              self = args[0]
              try:
                  _is_blocking = self.gettimeout()
                  if _is_blocking == 0:
                      self.setblocking(True)
                  return function(*args, **kwargs)
              except Exception as e:
                  raise
              finally:
                  # set orgin blocking
                  if _is_blocking == 0:
                      self.setblocking(False)
          return wrapper
    tokens: resume load_const STRING_FILE_PATH store_name __doc__ load_const INTEGER load_const import_name base64 import_from ENCODING_DECODING store_name ENCODING_DECODING pop_top nop load_const INTEGER load_const import_name collections.abc import_from Callable store_name Callable pop_top load_const INTEGER load_const import_name errno import_from EOPNOTSUPP store_name EOPNOTSUPP import_from EINVAL store_name EINVAL import_from EAGAIN store_name EAGAIN pop_top load_const INTEGER load_const import_name functools store_name functools load_const INTEGER load_const import_name io import_from BytesIO store_name BytesIO pop_top load_const INTEGER load_const import_name logging store_name logging load_const INTEGER load_const import_name os store_name os load_const INTEGER load_const import_name os import_from SEEK_CUR store_name SEEK_CUR pop_top load_const INTEGER load_const import_name socket store_name socket load_const INTEGER load_const import_name struct store_name struct load_const INTEGER load_const import_name sys store_name sys load_const 1.6.7 store_name __version__ load_name os load_attr name load_const nt compare_op == pop_jump_if_false TO_NUMBER load_name sys load_attr version_info load_const compare_op < pop_jump_if_false TO_NUMBER nop load_const INTEGER load_const import_name win_inet_pton store_name win_inet_pton push_null load_name logging load_attr getLogger load_name __name__ call store_name log load_const INTEGER copy store_name STRING_LEN_S_ENT_HIGH store_name SOCKS4 load_const INTEGER copy store_name STRING_LEN_S_ENT_HIGH store_name SOCKS5 load_const INTEGER copy store_name PROXY_TYPE_HTTP store_name HTTP load_name SOCKS4 load_name SOCKS5 load_name HTTP load_const build_const_key_map store_name PROXY_TYPES push_null load_name dict push_null load_name zip load_name PROXY_TYPES load_attr values call load_name PROXY_TYPES load_attr keys call call call store_name STRING_LEN_S_ENT_HIGH load_name socket load_attr socket copy store_name _orgsocket store_name _orig_socket load_const OBJECT make_function store_name STRING_LEN_S_ENT_HIGH push_null load_build_class load_const OBJECT make_function load_const ProxyError load_name IOError call store_name ProxyError push_null load_build_class load_const OBJECT make_function load_const STRING_LEN_S_ENT_HIGH load_name ProxyError call store_name STRING_LEN_S_ENT_HIGH push_null load_build_class load_const OBJECT make_function load_const STRING_BASE64_LEN_S_ENT_HIGH load_name ProxyError call store_name STRING_BASE64_LEN_S_ENT_HIGH push_null load_build_class load_const OBJECT make_function load_const SOCKS5AuthError load_name ProxyError call store_name SOCKS5AuthError push_null load_build_class load_const OBJECT make_function load_const SOCKS5Error load_name ProxyError call store_name SOCKS5Error push_null load_build_class load_const OBJECT make_function load_const SOCKS4Error load_name ProxyError call store_name SOCKS4Error push_null load_build_class load_const OBJECT make_function load_const HTTPError load_name ProxyError call store_name HTTPError load_const STRING_LEN_S_ENT_HIGH load_const STRING_LEN_S_ENT_HIGH load_const STRING_LEN_S_ENT_HIGH load_const build_const_key_map store_name SOCKS4_ERRORS load_const STRING_LEN_S_ENT_HIGH load_const STRING_LEN_S_ENT_HIGH load_const STRING_LEN_S_ENT_HIGH load_const STRING_LEN_S_ENT_HIGH load_const STRING_LEN_S_ENT_HIGH load_const TTL expired load_const STRING_LEN_S_ENT_HIGH load_const STRING_LEN_S_ENT_HIGH load_const build_const_key_map store_name SOCKS5_ERRORS load_name SOCKS4 load_const INTEGER load_name SOCKS5 load_const INTEGER load_name HTTP load_const INTEGER build_map store_name DEFAULT_PORTS nop nop load_const load_const OBJECT make_function defaults store_name STRING_LEN_S_ENT_HIGH load_const OBJECT make_function store_name setdefaultproxy load_const OBJECT make_function store_name STRING_LEN_S_ENT_HIGH load_name STRING_LEN_S_ENT_HIGH store_name getdefaultproxy load_const OBJECT make_function store_name wrap_module load_name wrap_module store_name wrapmodule nop nop nop nop nop load_const load_const OBJECT make_function defaults store_name STRING_LEN_S_ENT_HIGH push_null load_build_class load_const OBJECT make_function load_const _BaseSocket load_name socket load_attr socket call store_name _BaseSocket load_const OBJECT make_function store_name _makemethod load_const get_iter for_iter TO_NUMBER store_name name push_null load_name REFLECTION_DYNAMIC_READ load_name _BaseSocket load_name name load_const call store_name method push_null load_name isinstance load_name method load_name Callable call pop_jump_if_false TO_NUMBER jump_backward TO_NUMBER load_name _BaseSocket load_attr _savenames load_attr append load_name name call pop_top push_null load_name REFLECTION_DYNAMIC_WRITE load_name _BaseSocket load_name name push_null load_name _makemethod load_name name call call pop_top jump_backward TO_NUMBER end_for push_null load_build_class load_const OBJECT make_function load_const socksocket load_name _BaseSocket call store_name socksocket return_const None push_exc_info load_name ImportError check_exc_match pop_jump_if_false TO_NUMBER pop_top load_const INTEGER load_const import_name collections import_from Callable store_name Callable pop_top pop_except extended_arg jump_backward TO_NUMBER reraise copy pop_except reraise push_exc_info load_name ImportError check_exc_match pop_jump_if_false TO_NUMBER pop_top push_null load_name ImportError load_const STRING_LEN_S_ENT_HIGH call raise_varargs reraise copy pop_except reraise
    hash: c114ed9ccc21e1a77f225082c4e3f57673c9ecfe28a34611a0b129b1649a22a5
sources:
  ? .repo_cache/malicious_repos/pypi_malregistry/python-aliyun-sdk-core/2.13.36/python-aliyun-sdk-core-2.13.36/python-aliyun-sdk-core-2.13.36/aliyunsdkcore/vendored/requests/packages/urllib3/packages/socks.py
  : IiIiU29ja3NpUHkgLSBQeXRob24gU09DS1MgbW9kdWxlLgoKQ29weXJpZ2h0IDIwMDYgRGFuLUhhaW0uIEFsbCByaWdodHMgcmVzZXJ2ZWQuCgpSZWRpc3RyaWJ1dGlvbiBhbmQgdXNlIGluIHNvdXJjZSBhbmQgYmluYXJ5IGZvcm1zLCB3aXRoIG9yIHdpdGhvdXQKbW9kaWZpY2F0aW9uLCBhcmUgcGVybWl0dGVkIHByb3ZpZGVkIHRoYXQgdGhlIGZvbGxvd2luZyBjb25kaXRpb25zIGFyZSBtZXQ6CjEuIFJlZGlzdHJpYnV0aW9ucyBvZiBzb3VyY2UgY29kZSBtdXN0IHJldGFpbiB0aGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSwgdGhpcwogICBsaXN0IG9mIGNvbmRpdGlvbnMgYW5kIHRoZSBmb2xsb3dpbmcgZGlzY2xhaW1lci4KMi4gUmVkaXN0cmlidXRpb25zIGluIGJpbmFyeSBmb3JtIG11c3QgcmVwcm9kdWNlIHRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlLAogICB0aGlzIGxpc3Qgb2YgY29uZGl0aW9ucyBhbmQgdGhlIGZvbGxvd2luZyBkaXNjbGFpbWVyIGluIHRoZSBkb2N1bWVudGF0aW9uCiAgIGFuZC9vciBvdGhlciBtYXRlcmlhbHMgcHJvdmlkZWQgd2l0aCB0aGUgZGlzdHJpYnV0aW9uLgozLiBOZWl0aGVyIHRoZSBuYW1lIG9mIERhbiBIYWltIG5vciB0aGUgbmFtZXMgb2YgaGlzIGNvbnRyaWJ1dG9ycyBtYXkgYmUgdXNlZAogICB0byBlbmRvcnNlIG9yIHByb21vdGUgcHJvZHVjdHMgZGVyaXZlZCBmcm9tIHRoaXMgc29mdHdhcmUgd2l0aG91dCBzcGVjaWZpYwogICBwcmlvciB3cml0dGVuIHBlcm1pc3Npb24uCgpUSElTIFNPRlRXQVJFIElTIFBST1ZJREVEIEJZIERBTiBIQUlNICJBUyBJUyIgQU5EIEFOWSBFWFBSRVNTIE9SIElNUExJRUQKV0FSUkFOVElFUywgSU5DTFVESU5HLCBCVVQgTk9UIExJTUlURUQgVE8sIFRIRSBJTVBMSUVEIFdBUlJBTlRJRVMgT0YKTUVSQ0hBTlRBQklMSVRZIEFORCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBUkUgRElTQ0xBSU1FRC4gSU4gTk8KRVZFTlQgU0hBTEwgREFOIEhBSU0gT1IgSElTIENPTlRSSUJVVE9SUyBCRSBMSUFCTEUgRk9SIEFOWSBESVJFQ1QsIElORElSRUNULApJTkNJREVOVEFMLCBTUEVDSUFMLCBFWEVNUExBUlksIE9SIENPTlNFUVVFTlRJQUwgREFNQUdFUyAoSU5DTFVESU5HLCBCVVQgTk9UCkxJTUlURUQgVE8sIFBST0NVUkVNRU5UIE9GIFNVQlNUSVRVVEUgR09PRFMgT1IgU0VSVklDRVM7IExPU1MgT0YgVVNFLCBEQVRBCk9SIFBST0ZJVFM7IE9SIEJVU0lORVNTIElOVEVSUlVQVElPTikgSE9XRVZFUiBDQVVTRUQgQU5EIE9OIEFOWSBUSEVPUlkgT0YKTElBQklMSVRZLCBPUiBUT1JUIChJTkNMVURJTkcgTkVHTElHRU5DRSBPUiBPVEhFUldJU0UpIEFSSVNJTkcgSU4gQU5ZIFdBWSBPVVQKT0YgVEhFIFVTRSBPRiBUSElTIFNPRlRXQVJFLCBFVkVOIElGIEFEVklTRUQgT0YgVEhFIFBPU1NJQklMSVRZIE9GIFNVQ0ggREFNQUdFLgoKClRoaXMgbW9kdWxlIHByb3ZpZGVzIGEgc3RhbmRhcmQgc29ja2V0LWxpa2UgaW50ZXJmYWNlIGZvciBQeXRob24KZm9yIHR1bm5lbGluZyBjb25uZWN0aW9ucyB0aHJvdWdoIFNPQ0tTIHByb3hpZXMuCgo9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CgpNaW5vciBtb2RpZmljYXRpb25zIG1hZGUgYnkgQ2hyaXN0b3BoZXIgR2lsYmVydCAoaHR0cDovL21vdG9tYXN0eWxlLmNvbS8pCmZvciB1c2UgaW4gUHlMb3JpcyAoaHR0cDovL3B5bG9yaXMuc291cmNlZm9yZ2UubmV0LykKCk1pbm9yIG1vZGlmaWNhdGlvbnMgbWFkZSBieSBNYXJpbyBWaWxhcyAoaHR0cDovL2JyZWFraW5nY29kZS53b3JkcHJlc3MuY29tLykKbWFpbmx5IHRvIG1lcmdlIGJ1ZyBmaXhlcyBmb3VuZCBpbiBTb3VyY2Vmb3JnZQoKTW9kaWZpY2F0aW9ucyBtYWRlIGJ5IEFub3JvdiAoaHR0cHM6Ly9naXRodWIuY29tL0Fub3JvdikKLUZvcmtlZCBhbmQgcmVuYW1lZCB0byBQeVNvY2tzCi1GaXhlZCBpc3N1ZSB3aXRoIEhUVFAgcHJveHkgZmFpbHVyZSBjaGVja2luZyAoc2FtZSBidWcgdGhhdCB3YXMgaW4gdGhlCiBvbGQgX19fcmVjdmFsbCgpIG1ldGhvZCkKLUluY2x1ZGVkIFNvY2tzaVB5SGFuZGxlciAoc29ja3NoYW5kbGVyLnB5KSwgdG8gYmUgdXNlZCBhcyBhIHVybGxpYjIgaGFuZGxlciwKIGNvdXJ0ZXN5IG9mIGUwMDAgKGh0dHBzOi8vZ2l0aHViLmNvbS9lMDAwKToKIGh0dHBzOi8vZ2lzdC5naXRodWIuY29tLzg2OTc5MSNmaWxlX3NvY2tzaXB5aGFuZGxlci5weQotUmUtc3R5bGVkIGNvZGUgdG8gbWFrZSBpdCByZWFkYWJsZQogICAgLUFsaWFzZWQgUFJPWFlfVFlQRV9TT0NLUzUgLT4gU09DS1M1IGV0Yy4KICAgIC1JbXByb3ZlZCBleGNlcHRpb24gaGFuZGxpbmcgYW5kIG91dHB1dAogICAgLVJlbW92ZWQgaXJyaXRhdGluZyB1c2Ugb2Ygc2VxdWVuY2UgaW5kZXhlcywgcmVwbGFjZWQgd2l0aCB0dXBsZSB1bnBhY2tlZAogICAgIHZhcmlhYmxlcwogICAgLUZpeGVkIHVwIFB5dGhvbiAzIGJ5dGVzdHJpbmcgaGFuZGxpbmcgLSBjaHIoMHgwMykuZW5jb2RlKCkgLT4gYiJceDAzIgogICAgLU90aGVyIGdlbmVyYWwgZml4ZXMKLUFkZGVkIGNsYXJpZmljYXRpb24gdGhhdCB0aGUgSFRUUCBwcm94eSBjb25uZWN0aW9uIG1ldGhvZCBvbmx5IHN1cHBvcnRzCiBDT05ORUNULXN0eWxlIHR1bm5lbGluZyBIVFRQIHByb3hpZXMKLVZhcmlvdXMgc21hbGwgYnVnIGZpeGVzCiIiIgoKZnJvbSBiYXNlNjQgaW1wb3J0IGI2NGVuY29kZQp0cnk6CiAgICBmcm9tIGNvbGxlY3Rpb25zLmFiYyBpbXBvcnQgQ2FsbGFibGUKZXhjZXB0IEltcG9ydEVycm9yOgogICAgZnJvbSBjb2xsZWN0aW9ucyBpbXBvcnQgQ2FsbGFibGUKZnJvbSBlcnJubyBpbXBvcnQgRU9QTk9UU1VQUCwgRUlOVkFMLCBFQUdBSU4KaW1wb3J0IGZ1bmN0b29scwpmcm9tIGlvIGltcG9ydCBCeXRlc0lPCmltcG9ydCBsb2dnaW5nCmltcG9ydCBvcwpmcm9tIG9zIGltcG9ydCBTRUVLX0NVUgppbXBvcnQgc29ja2V0CmltcG9ydCBzdHJ1Y3QKaW1wb3J0IHN5cwoKX192ZXJzaW9uX18gPSAiMS42LjciCgoKaWYgb3MubmFtZSA9PSAibnQiIGFuZCBzeXMudmVyc2lvbl9pbmZvIDwgKDMsIDApOgogICAgdHJ5OgogICAgICAgIGltcG9ydCB3aW5faW5ldF9wdG9uCiAgICBleGNlcHQgSW1wb3J0RXJyb3I6CiAgICAgICAgcmFpc2UgSW1wb3J0RXJyb3IoCiAgICAgICAgICAgICJUbyBydW4gUHlTb2NrcyBvbiBXaW5kb3dzIHlvdSBtdXN0IGluc3RhbGwgd2luX2luZXRfcHRvbiIpCgpsb2cgPSBsb2dnaW5nLmdldExvZ2dlcihfX25hbWVfXykKClBST1hZX1RZUEVfU09DS1M0ID0gU09DS1M0ID0gMQpQUk9YWV9UWVBFX1NPQ0tTNSA9IFNPQ0tTNSA9IDIKUFJPWFlfVFlQRV9IVFRQID0gSFRUUCA9IDMKClBST1hZX1RZUEVTID0geyJTT0NLUzQiOiBTT0NLUzQsICJTT0NLUzUiOiBTT0NLUzUsICJIVFRQIjogSFRUUH0KUFJJTlRBQkxFX1BST1hZX1RZUEVTID0gZGljdCh6aXAoUFJPWFlfVFlQRVMudmFsdWVzKCksIFBST1hZX1RZUEVTLmtleXMoKSkpCgpfb3Jnc29ja2V0ID0gX29yaWdfc29ja2V0ID0gc29ja2V0LnNvY2tldAoKCmRlZiBzZXRfc2VsZl9ibG9ja2luZyhmdW5jdGlvbik6CgogICAgQGZ1bmN0b29scy53cmFwcyhmdW5jdGlvbikKICAgIGRlZiB3cmFwcGVyKCphcmdzLCAqKmt3YXJncyk6CiAgICAgICAgc2VsZiA9IGFyZ3NbMF0KICAgICAgICB0cnk6CiAgICAgICAgICAgIF9pc19ibG9ja2luZyA9IHNlbGYuZ2V0dGltZW91dCgpCiAgICAgICAgICAgIGlmIF9pc19ibG9ja2luZyA9PSAwOgogICAgICAgICAgICAgICAgc2VsZi5zZXRibG9ja2luZyhUcnVlKQogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oKmFyZ3MsICoqa3dhcmdzKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcmFpc2UKICAgICAgICBmaW5hbGx5OgogICAgICAgICAgICAjIHNldCBvcmdpbiBibG9ja2luZwogICAgICAgICAgICBpZiBfaXNfYmxvY2tpbmcgPT0gMDoKICAgICAgICAgICAgICAgIHNlbGYuc2V0YmxvY2tpbmcoRmFsc2UpCiAgICByZXR1cm4gd3JhcHBlcgoKCmNsYXNzIFByb3h5RXJyb3IoSU9FcnJvcik6CiAgICAiIiJTb2NrZXRfZXJyIGNvbnRhaW5zIG9yaWdpbmFsIHNvY2tldC5lcnJvciBleGNlcHRpb24uIiIiCiAgICBkZWYgX19pbml0X18oc2VsZiwgbXNnLCBzb2NrZXRfZXJyPU5vbmUpOgogICAgICAgIHNlbGYubXNnID0gbXNnCiAgICAgICAgc2VsZi5zb2NrZXRfZXJyID0gc29ja2V0X2VycgoKICAgICAgICBpZiBzb2NrZXRfZXJyOgogICAgICAgICAgICBzZWxmLm1zZyArPSAiOiB7MH0iLmZvcm1hdChzb2NrZXRfZXJyKQoKICAgIGRlZiBfX3N0cl9fKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLm1zZwoKCmNsYXNzIEdlbmVyYWxQcm94eUVycm9yKFByb3h5RXJyb3IpOgogICAgcGFzcwoKCmNsYXNzIFByb3h5Q29ubmVjdGlvbkVycm9yKFByb3h5RXJyb3IpOgogICAgcGFzcwoKCmNsYXNzIFNPQ0tTNUF1dGhFcnJvcihQcm94eUVycm9yKToKICAgIHBhc3MKCgpjbGFzcyBTT0NLUzVFcnJvcihQcm94eUVycm9yKToKICAgIHBhc3MKCgpjbGFzcyBTT0NLUzRFcnJvcihQcm94eUVycm9yKToKICAgIHBhc3MKCgpjbGFzcyBIVFRQRXJyb3IoUHJveHlFcnJvcik6CiAgICBwYXNzCgpTT0NLUzRfRVJST1JTID0gewogICAgMHg1QjogIlJlcXVlc3QgcmVqZWN0ZWQgb3IgZmFpbGVkIiwKICAgIDB4NUM6ICgiUmVxdWVzdCByZWplY3RlZCBiZWNhdXNlIFNPQ0tTIHNlcnZlciBjYW5ub3QgY29ubmVjdCB0byBpZGVudGQgb24iCiAgICAgICAgICAgIiB0aGUgY2xpZW50IiksCiAgICAweDVEOiAoIlJlcXVlc3QgcmVqZWN0ZWQgYmVjYXVzZSB0aGUgY2xpZW50IHByb2dyYW0gYW5kIGlkZW50ZCByZXBvcnQiCiAgICAgICAgICAgIiBkaWZmZXJlbnQgdXNlci1pZHMiKQp9CgpTT0NLUzVfRVJST1JTID0gewogICAgMHgwMTogIkdlbmVyYWwgU09DS1Mgc2VydmVyIGZhaWx1cmUiLAogICAgMHgwMjogIkNvbm5lY3Rpb24gbm90IGFsbG93ZWQgYnkgcnVsZXNldCIsCiAgICAweDAzOiAiTmV0d29yayB1bnJlYWNoYWJsZSIsCiAgICAweDA0OiAiSG9zdCB1bnJlYWNoYWJsZSIsCiAgICAweDA1OiAiQ29ubmVjdGlvbiByZWZ1c2VkIiwKICAgIDB4MDY6ICJUVEwgZXhwaXJlZCIsCiAgICAweDA3OiAiQ29tbWFuZCBub3Qgc3VwcG9ydGVkLCBvciBwcm90b2NvbCBlcnJvciIsCiAgICAweDA4OiAiQWRkcmVzcyB0eXBlIG5vdCBzdXBwb3J0ZWQiCn0KCkRFRkFVTFRfUE9SVFMgPSB7U09DS1M0OiAxMDgwLCBTT0NLUzU6IDEwODAsIEhUVFA6IDgwODB9CgoKZGVmIHNldF9kZWZhdWx0X3Byb3h5KHByb3h5X3R5cGU9Tm9uZSwgYWRkcj1Ob25lLCBwb3J0PU5vbmUsIHJkbnM9VHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgIHVzZXJuYW1lPU5vbmUsIHBhc3N3b3JkPU5vbmUpOgogICAgIiIiU2V0cyBhIGRlZmF1bHQgcHJveHkuCgogICAgQWxsIGZ1cnRoZXIgc29ja3NvY2tldCBvYmplY3RzIHdpbGwgdXNlIHRoZSBkZWZhdWx0IHVubGVzcyBleHBsaWNpdGx5CiAgICBjaGFuZ2VkLiBBbGwgcGFyYW1ldGVycyBhcmUgYXMgZm9yIHNvY2tldC5zZXRfcHJveHkoKS4iIiIKICAgIHNvY2tzb2NrZXQuZGVmYXVsdF9wcm94eSA9IChwcm94eV90eXBlLCBhZGRyLCBwb3J0LCByZG5zLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVzZXJuYW1lLmVuY29kZSgpIGlmIHVzZXJuYW1lIGVsc2UgTm9uZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXNzd29yZC5lbmNvZGUoKSBpZiBwYXNzd29yZCBlbHNlIE5vbmUpCgoKZGVmIHNldGRlZmF1bHRwcm94eSgqYXJncywgKiprd2FyZ3MpOgogICAgaWYgInByb3h5dHlwZSIgaW4ga3dhcmdzOgogICAgICAgIGt3YXJnc1sicHJveHlfdHlwZSJdID0ga3dhcmdzLnBvcCgicHJveHl0eXBlIikKICAgIHJldHVybiBzZXRfZGVmYXVsdF9wcm94eSgqYXJncywgKiprd2FyZ3MpCgoKZGVmIGdldF9kZWZhdWx0X3Byb3h5KCk6CiAgICAiIiJSZXR1cm5zIHRoZSBkZWZhdWx0IHByb3h5LCBzZXQgYnkgc2V0X2RlZmF1bHRfcHJveHkuIiIiCiAgICByZXR1cm4gc29ja3NvY2tldC5kZWZhdWx0X3Byb3h5CgpnZXRkZWZhdWx0cHJveHkgPSBnZXRfZGVmYXVsdF9wcm94eQoKCmRlZiB3cmFwX21vZHVsZShtb2R1bGUpOgogICAgIiIiQXR0ZW1wdHMgdG8gcmVwbGFjZSBhIG1vZHVsZSdzIHNvY2tldCBsaWJyYXJ5IHdpdGggYSBTT0NLUyBzb2NrZXQuCgogICAgTXVzdCBzZXQgYSBkZWZhdWx0IHByb3h5IHVzaW5nIHNldF9kZWZhdWx0X3Byb3h5KC4uLikgZmlyc3QuIFRoaXMgd2lsbAogICAgb25seSB3b3JrIG9uIG1vZHVsZXMgdGhhdCBpbXBvcnQgc29ja2V0IGRpcmVjdGx5IGludG8gdGhlIG5hbWVzcGFjZTsKICAgIG1vc3Qgb2YgdGhlIFB5dGhvbiBTdGFuZGFyZCBMaWJyYXJ5IGZhbGxzIGludG8gdGhpcyBjYXRlZ29yeS4iIiIKICAgIGlmIHNvY2tzb2NrZXQuZGVmYXVsdF9wcm94eToKICAgICAgICBtb2R1bGUuc29ja2V0LnNvY2tldCA9IHNvY2tzb2NrZXQKICAgIGVsc2U6CiAgICAgICAgcmFpc2UgR2VuZXJhbFByb3h5RXJyb3IoIk5vIGRlZmF1bHQgcHJveHkgc3BlY2lmaWVkIikKCndyYXBtb2R1bGUgPSB3cmFwX21vZHVsZQoKCmRlZiBjcmVhdGVfY29ubmVjdGlvbihkZXN0X3BhaXIsCiAgICAgICAgICAgICAgICAgICAgICB0aW1lb3V0PU5vbmUsIHNvdXJjZV9hZGRyZXNzPU5vbmUsCiAgICAgICAgICAgICAgICAgICAgICBwcm94eV90eXBlPU5vbmUsIHByb3h5X2FkZHI9Tm9uZSwKICAgICAgICAgICAgICAgICAgICAgIHByb3h5X3BvcnQ9Tm9uZSwgcHJveHlfcmRucz1UcnVlLAogICAgICAgICAgICAgICAgICAgICAgcHJveHlfdXNlcm5hbWU9Tm9uZSwgcHJveHlfcGFzc3dvcmQ9Tm9uZSwKICAgICAgICAgICAgICAgICAgICAgIHNvY2tldF9vcHRpb25zPU5vbmUpOgogICAgIiIiY3JlYXRlX2Nvbm5lY3Rpb24oZGVzdF9wYWlyLCAqWywgdGltZW91dF0sICoqcHJveHlfYXJncykgLT4gc29ja2V0IG9iamVjdAoKICAgIExpa2Ugc29ja2V0LmNyZWF0ZV9jb25uZWN0aW9uKCksIGJ1dCBjb25uZWN0cyB0byBwcm94eQogICAgYmVmb3JlIHJldHVybmluZyB0aGUgc29ja2V0IG9iamVjdC4KCiAgICBkZXN0X3BhaXIgLSAyLXR1cGxlIG9mIChJUC9ob3N0bmFtZSwgcG9ydCkuCiAgICAqKnByb3h5X2FyZ3MgLSBTYW1lIGFyZ3MgcGFzc2VkIHRvIHNvY2tzb2NrZXQuc2V0X3Byb3h5KCkgaWYgcHJlc2VudC4KICAgIHRpbWVvdXQgLSBPcHRpb25hbCBzb2NrZXQgdGltZW91dCB2YWx1ZSwgaW4gc2Vjb25kcy4KICAgIHNvdXJjZV9hZGRyZXNzIC0gdHVwbGUgKGhvc3QsIHBvcnQpIGZvciB0aGUgc29ja2V0IHRvIGJpbmQgdG8gYXMgaXRzIHNvdXJjZQogICAgYWRkcmVzcyBiZWZvcmUgY29ubmVjdGluZyAob25seSBmb3IgY29tcGF0aWJpbGl0eSkKICAgICIiIgogICAgIyBSZW1vdmUgSVB2NiBicmFja2V0cyBvbiB0aGUgcmVtb3RlIGFkZHJlc3MgYW5kIHByb3h5IGFkZHJlc3MuCiAgICByZW1vdGVfaG9zdCwgcmVtb3RlX3BvcnQgPSBkZXN0X3BhaXIKICAgIGlmIHJlbW90ZV9ob3N0LnN0YXJ0c3dpdGgoIlsiKToKICAgICAgICByZW1vdGVfaG9zdCA9IHJlbW90ZV9ob3N0LnN0cmlwKCJbXSIpCiAgICBpZiBwcm94eV9hZGRyIGFuZCBwcm94eV9hZGRyLnN0YXJ0c3dpdGgoIlsiKToKICAgICAgICBwcm94eV9hZGRyID0gcHJveHlfYWRkci5zdHJpcCgiW10iKQoKICAgIGVyciA9IE5vbmUKCiAgICAjIEFsbG93IHRoZSBTT0NLUyBwcm94eSB0byBiZSBvbiBJUHY0IG9yIElQdjYgYWRkcmVzc2VzLgogICAgZm9yIHIgaW4gc29ja2V0LmdldGFkZHJpbmZvKHByb3h5X2FkZHIsIHByb3h5X3BvcnQsIDAsIHNvY2tldC5TT0NLX1NUUkVBTSk6CiAgICAgICAgZmFtaWx5LCBzb2NrZXRfdHlwZSwgcHJvdG8sIGNhbm9ubmFtZSwgc2EgPSByCiAgICAgICAgc29jayA9IE5vbmUKICAgICAgICB0cnk6CiAgICAgICAgICAgIHNvY2sgPSBzb2Nrc29ja2V0KGZhbWlseSwgc29ja2V0X3R5cGUsIHByb3RvKQoKICAgICAgICAgICAgaWYgc29ja2V0X29wdGlvbnM6CiAgICAgICAgICAgICAgICBmb3Igb3B0IGluIHNvY2tldF9vcHRpb25zOgogICAgICAgICAgICAgICAgICAgIHNvY2suc2V0c29ja29wdCgqb3B0KQoKICAgICAgICAgICAgaWYgaXNpbnN0YW5jZSh0aW1lb3V0LCAoaW50LCBmbG9hdCkpOgogICAgICAgICAgICAgICAgc29jay5zZXR0aW1lb3V0KHRpbWVvdXQpCgogICAgICAgICAgICBpZiBwcm94eV90eXBlOgogICAgICAgICAgICAgICAgc29jay5zZXRfcHJveHkocHJveHlfdHlwZSwgcHJveHlfYWRkciwgcHJveHlfcG9ydCwgcHJveHlfcmRucywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb3h5X3VzZXJuYW1lLCBwcm94eV9wYXNzd29yZCkKICAgICAgICAgICAgaWYgc291cmNlX2FkZHJlc3M6CiAgICAgICAgICAgICAgICBzb2NrLmJpbmQoc291cmNlX2FkZHJlc3MpCgogICAgICAgICAgICBzb2NrLmNvbm5lY3QoKHJlbW90ZV9ob3N0LCByZW1vdGVfcG9ydCkpCiAgICAgICAgICAgIHJldHVybiBzb2NrCgogICAgICAgIGV4Y2VwdCAoc29ja2V0LmVycm9yLCBQcm94eUNvbm5lY3Rpb25FcnJvcikgYXMgZToKICAgICAgICAgICAgZXJyID0gZQogICAgICAgICAgICBpZiBzb2NrOgogICAgICAgICAgICAgICAgc29jay5jbG9zZSgpCiAgICAgICAgICAgICAgICBzb2NrID0gTm9uZQoKICAgIGlmIGVycjoKICAgICAgICByYWlzZSBlcnIKCiAgICByYWlzZSBzb2NrZXQuZXJyb3IoImdhaSByZXR1cm5lZCBlbXB0eSBsaXN0LiIpCgoKY2xhc3MgX0Jhc2VTb2NrZXQoc29ja2V0LnNvY2tldCk6CiAgICAiIiJBbGxvd3MgUHl0aG9uIDIgZGVsZWdhdGVkIG1ldGhvZHMgc3VjaCBhcyBzZW5kKCkgdG8gYmUgb3ZlcnJpZGRlbi4iIiIKICAgIGRlZiBfX2luaXRfXyhzZWxmLCAqcG9zLCAqKmt3KToKICAgICAgICBfb3JpZ19zb2NrZXQuX19pbml0X18oc2VsZiwgKnBvcywgKiprdykKCiAgICAgICAgc2VsZi5fc2F2ZWRtZXRob2RzID0gZGljdCgpCiAgICAgICAgZm9yIG5hbWUgaW4gc2VsZi5fc2F2ZW5hbWVzOgogICAgICAgICAgICBzZWxmLl9zYXZlZG1ldGhvZHNbbmFtZV0gPSBnZXRhdHRyKHNlbGYsIG5hbWUpCiAgICAgICAgICAgIGRlbGF0dHIoc2VsZiwgbmFtZSkgICMgQWxsb3dzIG5vcm1hbCBvdmVycmlkaW5nIG1lY2hhbmlzbSB0byB3b3JrCgogICAgX3NhdmVuYW1lcyA9IGxpc3QoKQoKCmRlZiBfbWFrZW1ldGhvZChuYW1lKToKICAgIHJldHVybiBsYW1iZGEgc2VsZiwgKnBvcywgKiprdzogc2VsZi5fc2F2ZWRtZXRob2RzW25hbWVdKCpwb3MsICoqa3cpCmZvciBuYW1lIGluICgic2VuZHRvIiwgInNlbmQiLCAicmVjdmZyb20iLCAicmVjdiIpOgogICAgbWV0aG9kID0gZ2V0YXR0cihfQmFzZVNvY2tldCwgbmFtZSwgTm9uZSkKCiAgICAjIERldGVybWluZSBpZiB0aGUgbWV0aG9kIGlzIG5vdCBkZWZpbmVkIHRoZSB1c3VhbCB3YXkKICAgICMgYXMgYSBmdW5jdGlvbiBpbiB0aGUgY2xhc3MuCiAgICAjIFB5dGhvbiAyIHVzZXMgX19zbG90c19fLCBzbyB0aGVyZSBhcmUgZGVzY3JpcHRvcnMgZm9yIGVhY2ggbWV0aG9kLAogICAgIyBidXQgdGhleSBhcmUgbm90IGZ1bmN0aW9ucy4KICAgIGlmIG5vdCBpc2luc3RhbmNlKG1ldGhvZCwgQ2FsbGFibGUpOgogICAgICAgIF9CYXNlU29ja2V0Ll9zYXZlbmFtZXMuYXBwZW5kKG5hbWUpCiAgICAgICAgc2V0YXR0cihfQmFzZVNvY2tldCwgbmFtZSwgX21ha2VtZXRob2QobmFtZSkpCgoKY2xhc3Mgc29ja3NvY2tldChfQmFzZVNvY2tldCk6CiAgICAiIiJzb2Nrc29ja2V0KFtmYW1pbHlbLCB0eXBlWywgcHJvdG9dXV0pIC0+IHNvY2tldCBvYmplY3QKCiAgICBPcGVuIGEgU09DS1MgZW5hYmxlZCBzb2NrZXQuIFRoZSBwYXJhbWV0ZXJzIGFyZSB0aGUgc2FtZSBhcwogICAgdGhvc2Ugb2YgdGhlIHN0YW5kYXJkIHNvY2tldCBpbml0LiBJbiBvcmRlciBmb3IgU09DS1MgdG8gd29yaywKICAgIHlvdSBtdXN0IHNwZWNpZnkgZmFtaWx5PUFGX0lORVQgYW5kIHByb3RvPTAuCiAgICBUaGUgInR5cGUiIGFyZ3VtZW50IG11c3QgYmUgZWl0aGVyIFNPQ0tfU1RSRUFNIG9yIFNPQ0tfREdSQU0uCiAgICAiIiIKCiAgICBkZWZhdWx0X3Byb3h5ID0gTm9uZQoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBmYW1pbHk9c29ja2V0LkFGX0lORVQsIHR5cGU9c29ja2V0LlNPQ0tfU1RSRUFNLAogICAgICAgICAgICAgICAgIHByb3RvPTAsICphcmdzLCAqKmt3YXJncyk6CiAgICAgICAgaWYgdHlwZSBub3QgaW4gKHNvY2tldC5TT0NLX1NUUkVBTSwgc29ja2V0LlNPQ0tfREdSQU0pOgogICAgICAgICAgICBtc2cgPSAiU29ja2V0IHR5cGUgbXVzdCBiZSBzdHJlYW0gb3IgZGF0YWdyYW0sIG5vdCB7IXJ9IgogICAgICAgICAgICByYWlzZSBWYWx1ZUVycm9yKG1zZy5mb3JtYXQodHlwZSkpCgogICAgICAgIHN1cGVyKHNvY2tzb2NrZXQsIHNlbGYpLl9faW5pdF9fKGZhbWlseSwgdHlwZSwgcHJvdG8sICphcmdzLCAqKmt3YXJncykKICAgICAgICBzZWxmLl9wcm94eWNvbm4gPSBOb25lICAjIFRDUCBjb25uZWN0aW9uIHRvIGtlZXAgVURQIHJlbGF5IGFsaXZlCgogICAgICAgIGlmIHNlbGYuZGVmYXVsdF9wcm94eToKICAgICAgICAgICAgc2VsZi5wcm94eSA9IHNlbGYuZGVmYXVsdF9wcm94eQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHNlbGYucHJveHkgPSAoTm9uZSwgTm9uZSwgTm9uZSwgTm9uZSwgTm9uZSwgTm9uZSkKICAgICAgICBzZWxmLnByb3h5X3NvY2tuYW1lID0gTm9uZQogICAgICAgIHNlbGYucHJveHlfcGVlcm5hbWUgPSBOb25lCgogICAgICAgIHNlbGYuX3RpbWVvdXQgPSBOb25lCgogICAgZGVmIF9yZWFkYWxsKHNlbGYsIGZpbGUsIGNvdW50KToKICAgICAgICAiIiJSZWNlaXZlIEVYQUNUTFkgdGhlIG51bWJlciBvZiBieXRlcyByZXF1ZXN0ZWQgZnJvbSB0aGUgZmlsZSBvYmplY3QuCgogICAgICAgIEJsb2NrcyB1bnRpbCB0aGUgcmVxdWlyZWQgbnVtYmVyIG9mIGJ5dGVzIGhhdmUgYmVlbiByZWNlaXZlZC4iIiIKICAgICAgICBkYXRhID0gYiIiCiAgICAgICAgd2hpbGUgbGVuKGRhdGEpIDwgY291bnQ6CiAgICAgICAgICAgIGQgPSBmaWxlLnJlYWQoY291bnQgLSBsZW4oZGF0YSkpCiAgICAgICAgICAgIGlmIG5vdCBkOgogICAgICAgICAgICAgICAgcmFpc2UgR2VuZXJhbFByb3h5RXJyb3IoIkNvbm5lY3Rpb24gY2xvc2VkIHVuZXhwZWN0ZWRseSIpCiAgICAgICAgICAgIGRhdGEgKz0gZAogICAgICAgIHJldHVybiBkYXRhCgogICAgZGVmIHNldHRpbWVvdXQoc2VsZiwgdGltZW91dCk6CiAgICAgICAgc2VsZi5fdGltZW91dCA9IHRpbWVvdXQKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgdGVzdCBpZiB3ZSdyZSBjb25uZWN0ZWQsIGlmIHNvIGFwcGx5IHRpbWVvdXQKICAgICAgICAgICAgcGVlciA9IHNlbGYuZ2V0X3Byb3h5X3BlZXJuYW1lKCkKICAgICAgICAgICAgc3VwZXIoc29ja3NvY2tldCwgc2VsZikuc2V0dGltZW91dChzZWxmLl90aW1lb3V0KQogICAgICAgIGV4Y2VwdCBzb2NrZXQuZXJyb3I6CiAgICAgICAgICAgIHBhc3MKCiAgICBkZWYgZ2V0dGltZW91dChzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5fdGltZW91dAoKICAgIGRlZiBzZXRibG9ja2luZyhzZWxmLCB2KToKICAgICAgICBpZiB2OgogICAgICAgICAgICBzZWxmLnNldHRpbWVvdXQoTm9uZSkKICAgICAgICBlbHNlOgogICAgICAgICAgICBzZWxmLnNldHRpbWVvdXQoMC4wKQoKICAgIGRlZiBzZXRfcHJveHkoc2VsZiwgcHJveHlfdHlwZT1Ob25lLCBhZGRyPU5vbmUsIHBvcnQ9Tm9uZSwgcmRucz1UcnVlLAogICAgICAgICAgICAgICAgICB1c2VybmFtZT1Ob25lLCBwYXNzd29yZD1Ob25lKToKICAgICAgICAiIiIgU2V0cyB0aGUgcHJveHkgdG8gYmUgdXNlZC4KCiAgICAgICAgcHJveHlfdHlwZSAtICBUaGUgdHlwZSBvZiB0aGUgcHJveHkgdG8gYmUgdXNlZC4gVGhyZWUgdHlwZXMKICAgICAgICAgICAgICAgICAgICAgICAgYXJlIHN1cHBvcnRlZDogUFJPWFlfVFlQRV9TT0NLUzQgKGluY2x1ZGluZyBzb2NrczRhKSwKICAgICAgICAgICAgICAgICAgICAgICAgUFJPWFlfVFlQRV9TT0NLUzUgYW5kIFBST1hZX1RZUEVfSFRUUAogICAgICAgIGFkZHIgLSAgICAgICAgVGhlIGFkZHJlc3Mgb2YgdGhlIHNlcnZlciAoSVAgb3IgRE5TKS4KICAgICAgICBwb3J0IC0gICAgICAgIFRoZSBwb3J0IG9mIHRoZSBzZXJ2ZXIuIERlZmF1bHRzIHRvIDEwODAgZm9yIFNPQ0tTCiAgICAgICAgICAgICAgICAgICAgICAgIHNlcnZlcnMgYW5kIDgwODAgZm9yIEhUVFAgcHJveHkgc2VydmVycy4KICAgICAgICByZG5zIC0gICAgICAgIFNob3VsZCBETlMgcXVlcmllcyBiZSBwZXJmb3JtZWQgb24gdGhlIHJlbW90ZSBzaWRlCiAgICAgICAgICAgICAgICAgICAgICAgKHJhdGhlciB0aGFuIHRoZSBsb2NhbCBzaWRlKS4gVGhlIGRlZmF1bHQgaXMgVHJ1ZS4KICAgICAgICAgICAgICAgICAgICAgICBOb3RlOiBUaGlzIGhhcyBubyBlZmZlY3Qgd2l0aCBTT0NLUzQgc2VydmVycy4KICAgICAgICB1c2VybmFtZSAtICAgIFVzZXJuYW1lIHRvIGF1dGhlbnRpY2F0ZSB3aXRoIHRvIHRoZSBzZXJ2ZXIuCiAgICAgICAgICAgICAgICAgICAgICAgVGhlIGRlZmF1bHQgaXMgbm8gYXV0aGVudGljYXRpb24uCiAgICAgICAgcGFzc3dvcmQgLSAgICBQYXNzd29yZCB0byBhdXRoZW50aWNhdGUgd2l0aCB0byB0aGUgc2VydmVyLgogICAgICAgICAgICAgICAgICAgICAgIE9ubHkgcmVsZXZhbnQgd2hlbiB1c2VybmFtZSBpcyBhbHNvIHByb3ZpZGVkLiIiIgogICAgICAgIHNlbGYucHJveHkgPSAocHJveHlfdHlwZSwgYWRkciwgcG9ydCwgcmRucywKICAgICAgICAgICAgICAgICAgICAgIHVzZXJuYW1lLmVuY29kZSgpIGlmIHVzZXJuYW1lIGVsc2UgTm9uZSwKICAgICAgICAgICAgICAgICAgICAgIHBhc3N3b3JkLmVuY29kZSgpIGlmIHBhc3N3b3JkIGVsc2UgTm9uZSkKCiAgICBkZWYgc2V0cHJveHkoc2VsZiwgKmFyZ3MsICoqa3dhcmdzKToKICAgICAgICBpZiAicHJveHl0eXBlIiBpbiBrd2FyZ3M6CiAgICAgICAgICAgIGt3YXJnc1sicHJveHlfdHlwZSJdID0ga3dhcmdzLnBvcCgicHJveHl0eXBlIikKICAgICAgICByZXR1cm4gc2VsZi5zZXRfcHJveHkoKmFyZ3MsICoqa3dhcmdzKQoKICAgIGRlZiBiaW5kKHNlbGYsICpwb3MsICoqa3cpOgogICAgICAgICIiIkltcGxlbWVudHMgcHJveHkgY29ubmVjdGlvbiBmb3IgVURQIHNvY2tldHMuCgogICAgICAgIEhhcHBlbnMgZHVyaW5nIHRoZSBiaW5kKCkgcGhhc2UuIiIiCiAgICAgICAgKHByb3h5X3R5cGUsIHByb3h5X2FkZHIsIHByb3h5X3BvcnQsIHJkbnMsIHVzZXJuYW1lLAogICAgICAgICBwYXNzd29yZCkgPSBzZWxmLnByb3h5CiAgICAgICAgaWYgbm90IHByb3h5X3R5cGUgb3Igc2VsZi50eXBlICE9IHNvY2tldC5TT0NLX0RHUkFNOgogICAgICAgICAgICByZXR1cm4gX29yaWdfc29ja2V0LmJpbmQoc2VsZiwgKnBvcywgKiprdykKCiAgICAgICAgaWYgc2VsZi5fcHJveHljb25uOgogICAgICAgICAgICByYWlzZSBzb2NrZXQuZXJyb3IoRUlOVkFMLCAiU29ja2V0IGFscmVhZHkgYm91bmQgdG8gYW4gYWRkcmVzcyIpCiAgICAgICAgaWYgcHJveHlfdHlwZSAhPSBTT0NLUzU6CiAgICAgICAgICAgIG1zZyA9ICJVRFAgb25seSBzdXBwb3J0ZWQgYnkgU09DS1M1IHByb3h5IHR5cGUiCiAgICAgICAgICAgIHJhaXNlIHNvY2tldC5lcnJvcihFT1BOT1RTVVBQLCBtc2cpCiAgICAgICAgc3VwZXIoc29ja3NvY2tldCwgc2VsZikuYmluZCgqcG9zLCAqKmt3KQoKICAgICAgICAjIE5lZWQgdG8gc3BlY2lmeSBhY3R1YWwgbG9jYWwgcG9ydCBiZWNhdXNlCiAgICAgICAgIyBzb21lIHJlbGF5cyBkcm9wIHBhY2tldHMgaWYgYSBwb3J0IG9mIHplcm8gaXMgc3BlY2lmaWVkLgogICAgICAgICMgQXZvaWQgc3BlY2lmeWluZyBob3N0IGFkZHJlc3MgaW4gY2FzZSBvZiBOQVQgdGhvdWdoLgogICAgICAgIF8sIHBvcnQgPSBzZWxmLmdldHNvY2tuYW1lKCkKICAgICAgICBkc3QgPSAoIjAiLCBwb3J0KQoKICAgICAgICBzZWxmLl9wcm94eWNvbm4gPSBfb3JpZ19zb2NrZXQoKQogICAgICAgIHByb3h5ID0gc2VsZi5fcHJveHlfYWRkcigpCiAgICAgICAgc2VsZi5fcHJveHljb25uLmNvbm5lY3QocHJveHkpCgogICAgICAgIFVEUF9BU1NPQ0lBVEUgPSBiIlx4MDMiCiAgICAgICAgXywgcmVsYXkgPSBzZWxmLl9TT0NLUzVfcmVxdWVzdChzZWxmLl9wcm94eWNvbm4sIFVEUF9BU1NPQ0lBVEUsIGRzdCkKCiAgICAgICAgIyBUaGUgcmVsYXkgaXMgbW9zdCBsaWtlbHkgb24gdGhlIHNhbWUgaG9zdCBhcyB0aGUgU09DS1MgcHJveHksCiAgICAgICAgIyBidXQgc29tZSBwcm94aWVzIHJldHVybiBhIHByaXZhdGUgSVAgYWRkcmVzcyAoMTAueC55LnopCiAgICAgICAgaG9zdCwgXyA9IHByb3h5CiAgICAgICAgXywgcG9ydCA9IHJlbGF5CiAgICAgICAgc3VwZXIoc29ja3NvY2tldCwgc2VsZikuY29ubmVjdCgoaG9zdCwgcG9ydCkpCiAgICAgICAgc3VwZXIoc29ja3NvY2tldCwgc2VsZikuc2V0dGltZW91dChzZWxmLl90aW1lb3V0KQogICAgICAgIHNlbGYucHJveHlfc29ja25hbWUgPSAoIjAuMC4wLjAiLCAwKSAgIyBVbmtub3duCgogICAgZGVmIHNlbmR0byhzZWxmLCBieXRlcywgKmFyZ3MsICoqa3dhcmdzKToKICAgICAgICBpZiBzZWxmLnR5cGUgIT0gc29ja2V0LlNPQ0tfREdSQU06CiAgICAgICAgICAgIHJldHVybiBzdXBlcihzb2Nrc29ja2V0LCBzZWxmKS5zZW5kdG8oYnl0ZXMsICphcmdzLCAqKmt3YXJncykKICAgICAgICBpZiBub3Qgc2VsZi5fcHJveHljb25uOgogICAgICAgICAgICBzZWxmLmJpbmQoKCIiLCAwKSkKCiAgICAgICAgYWRkcmVzcyA9IGFyZ3NbLTFdCiAgICAgICAgZmxhZ3MgPSBhcmdzWzotMV0KCiAgICAgICAgaGVhZGVyID0gQnl0ZXNJTygpCiAgICAgICAgUlNWID0gYiJceDAwXHgwMCIKICAgICAgICBoZWFkZXIud3JpdGUoUlNWKQogICAgICAgIFNUQU5EQUxPTkUgPSBiIlx4MDAiCiAgICAgICAgaGVhZGVyLndyaXRlKFNUQU5EQUxPTkUpCiAgICAgICAgc2VsZi5fd3JpdGVfU09DS1M1X2FkZHJlc3MoYWRkcmVzcywgaGVhZGVyKQoKICAgICAgICBzZW50ID0gc3VwZXIoc29ja3NvY2tldCwgc2VsZikuc2VuZChoZWFkZXIuZ2V0dmFsdWUoKSArIGJ5dGVzLCAqZmxhZ3MsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKiprd2FyZ3MpCiAgICAgICAgcmV0dXJuIHNlbnQgLSBoZWFkZXIudGVsbCgpCgogICAgZGVmIHNlbmQoc2VsZiwgYnl0ZXMsIGZsYWdzPTAsICoqa3dhcmdzKToKICAgICAgICBpZiBzZWxmLnR5cGUgPT0gc29ja2V0LlNPQ0tfREdSQU06CiAgICAgICAgICAgIHJldHVybiBzZWxmLnNlbmR0byhieXRlcywgZmxhZ3MsIHNlbGYucHJveHlfcGVlcm5hbWUsICoqa3dhcmdzKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzdXBlcihzb2Nrc29ja2V0LCBzZWxmKS5zZW5kKGJ5dGVzLCBmbGFncywgKiprd2FyZ3MpCgogICAgZGVmIHJlY3Zmcm9tKHNlbGYsIGJ1ZnNpemUsIGZsYWdzPTApOgogICAgICAgIGlmIHNlbGYudHlwZSAhPSBzb2NrZXQuU09DS19ER1JBTToKICAgICAgICAgICAgcmV0dXJuIHN1cGVyKHNvY2tzb2NrZXQsIHNlbGYpLnJlY3Zmcm9tKGJ1ZnNpemUsIGZsYWdzKQogICAgICAgIGlmIG5vdCBzZWxmLl9wcm94eWNvbm46CiAgICAgICAgICAgIHNlbGYuYmluZCgoIiIsIDApKQoKICAgICAgICBidWYgPSBCeXRlc0lPKHN1cGVyKHNvY2tzb2NrZXQsIHNlbGYpLnJlY3YoYnVmc2l6ZSArIDEwMjQsIGZsYWdzKSkKICAgICAgICBidWYuc2VlaygyLCBTRUVLX0NVUikKICAgICAgICBmcmFnID0gYnVmLnJlYWQoMSkKICAgICAgICBpZiBvcmQoZnJhZyk6CiAgICAgICAgICAgIHJhaXNlIE5vdEltcGxlbWVudGVkRXJyb3IoIlJlY2VpdmVkIFVEUCBwYWNrZXQgZnJhZ21lbnQiKQogICAgICAgIGZyb21ob3N0LCBmcm9tcG9ydCA9IHNlbGYuX3JlYWRfU09DS1M1X2FkZHJlc3MoYnVmKQoKICAgICAgICBpZiBzZWxmLnByb3h5X3BlZXJuYW1lOgogICAgICAgICAgICBwZWVyaG9zdCwgcGVlcnBvcnQgPSBzZWxmLnByb3h5X3BlZXJuYW1lCiAgICAgICAgICAgIGlmIGZyb21ob3N0ICE9IHBlZXJob3N0IG9yIHBlZXJwb3J0IG5vdCBpbiAoMCwgZnJvbXBvcnQpOgogICAgICAgICAgICAgICAgcmFpc2Ugc29ja2V0LmVycm9yKEVBR0FJTiwgIlBhY2tldCBmaWx0ZXJlZCIpCgogICAgICAgIHJldHVybiAoYnVmLnJlYWQoYnVmc2l6ZSksIChmcm9taG9zdCwgZnJvbXBvcnQpKQoKICAgIGRlZiByZWN2KHNlbGYsICpwb3MsICoqa3cpOgogICAgICAgIGJ5dGVzLCBfID0gc2VsZi5yZWN2ZnJvbSgqcG9zLCAqKmt3KQogICAgICAgIHJldHVybiBieXRlcwoKICAgIGRlZiBjbG9zZShzZWxmKToKICAgICAgICBpZiBzZWxmLl9wcm94eWNvbm46CiAgICAgICAgICAgIHNlbGYuX3Byb3h5Y29ubi5jbG9zZSgpCiAgICAgICAgcmV0dXJuIHN1cGVyKHNvY2tzb2NrZXQsIHNlbGYpLmNsb3NlKCkKCiAgICBkZWYgZ2V0X3Byb3h5X3NvY2tuYW1lKHNlbGYpOgogICAgICAgICIiIlJldHVybnMgdGhlIGJvdW5kIElQIGFkZHJlc3MgYW5kIHBvcnQgbnVtYmVyIGF0IHRoZSBwcm94eS4iIiIKICAgICAgICByZXR1cm4gc2VsZi5wcm94eV9zb2NrbmFtZQoKICAgIGdldHByb3h5c29ja25hbWUgPSBnZXRfcHJveHlfc29ja25hbWUKCiAgICBkZWYgZ2V0X3Byb3h5X3BlZXJuYW1lKHNlbGYpOgogICAgICAgICIiIgogICAgICAgIFJldHVybnMgdGhlIElQIGFuZCBwb3J0IG51bWJlciBvZiB0aGUgcHJveHkuCiAgICAgICAgIiIiCiAgICAgICAgcmV0dXJuIHNlbGYuZ2V0cGVlcm5hbWUoKQoKICAgIGdldHByb3h5cGVlcm5hbWUgPSBnZXRfcHJveHlfcGVlcm5hbWUKCiAgICBkZWYgZ2V0X3BlZXJuYW1lKHNlbGYpOgogICAgICAgICIiIlJldHVybnMgdGhlIElQIGFkZHJlc3MgYW5kIHBvcnQgbnVtYmVyIG9mIHRoZSBkZXN0aW5hdGlvbiBtYWNoaW5lLgoKICAgICAgICBOb3RlOiBnZXRfcHJveHlfcGVlcm5hbWUgcmV0dXJucyB0aGUgcHJveHkuIiIiCiAgICAgICAgcmV0dXJuIHNlbGYucHJveHlfcGVlcm5hbWUKCiAgICBnZXRwZWVybmFtZSA9IGdldF9wZWVybmFtZQoKICAgIGRlZiBfbmVnb3RpYXRlX1NPQ0tTNShzZWxmLCAqZGVzdF9hZGRyKToKICAgICAgICAiIiJOZWdvdGlhdGVzIGEgc3RyZWFtIGNvbm5lY3Rpb24gdGhyb3VnaCBhIFNPQ0tTNSBzZXJ2ZXIuIiIiCiAgICAgICAgQ09OTkVDVCA9IGIiXHgwMSIKICAgICAgICBzZWxmLnByb3h5X3BlZXJuYW1lLCBzZWxmLnByb3h5X3NvY2tuYW1lID0gc2VsZi5fU09DS1M1X3JlcXVlc3QoCiAgICAgICAgICAgIHNlbGYsIENPTk5FQ1QsIGRlc3RfYWRkcikKCiAgICBkZWYgX1NPQ0tTNV9yZXF1ZXN0KHNlbGYsIGNvbm4sIGNtZCwgZHN0KToKICAgICAgICAiIiIKICAgICAgICBTZW5kIFNPQ0tTNSByZXF1ZXN0IHdpdGggZ2l2ZW4gY29tbWFuZCAoQ01EIGZpZWxkKSBhbmQKICAgICAgICBhZGRyZXNzIChEU1QgZmllbGQpLiBSZXR1cm5zIHJlc29sdmVkIERTVCBhZGRyZXNzIHRoYXQgd2FzIHVzZWQuCiAgICAgICAgIiIiCiAgICAgICAgcHJveHlfdHlwZSwgYWRkciwgcG9ydCwgcmRucywgdXNlcm5hbWUsIHBhc3N3b3JkID0gc2VsZi5wcm94eQoKICAgICAgICB3cml0ZXIgPSBjb25uLm1ha2VmaWxlKCJ3YiIpCiAgICAgICAgcmVhZGVyID0gY29ubi5tYWtlZmlsZSgicmIiLCAwKSAgIyBidWZmZXJpbmc9MCByZW5hbWVkIGluIFB5dGhvbiAzCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIEZpcnN0IHdlJ2xsIHNlbmQgdGhlIGF1dGhlbnRpY2F0aW9uIHBhY2thZ2VzIHdlIHN1cHBvcnQuCiAgICAgICAgICAgIGlmIHVzZXJuYW1lIGFuZCBwYXNzd29yZDoKICAgICAgICAgICAgICAgICMgVGhlIHVzZXJuYW1lL3Bhc3N3b3JkIGRldGFpbHMgd2VyZSBzdXBwbGllZCB0byB0aGUKICAgICAgICAgICAgICAgICMgc2V0X3Byb3h5IG1ldGhvZCBzbyB3ZSBzdXBwb3J0IHRoZSBVU0VSTkFNRS9QQVNTV09SRAogICAgICAgICAgICAgICAgIyBhdXRoZW50aWNhdGlvbiAoaW4gYWRkaXRpb24gdG8gdGhlIHN0YW5kYXJkIG5vbmUpLgogICAgICAgICAgICAgICAgd3JpdGVyLndyaXRlKGIiXHgwNVx4MDJceDAwXHgwMiIpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAjIE5vIHVzZXJuYW1lL3Bhc3N3b3JkIHdlcmUgZW50ZXJlZCwgdGhlcmVmb3JlIHdlCiAgICAgICAgICAgICAgICAjIG9ubHkgc3VwcG9ydCBjb25uZWN0aW9ucyB3aXRoIG5vIGF1dGhlbnRpY2F0aW9uLgogICAgICAgICAgICAgICAgd3JpdGVyLndyaXRlKGIiXHgwNVx4MDFceDAwIikKCiAgICAgICAgICAgICMgV2UnbGwgcmVjZWl2ZSB0aGUgc2VydmVyJ3MgcmVzcG9uc2UgdG8gZGV0ZXJtaW5lIHdoaWNoCiAgICAgICAgICAgICMgbWV0aG9kIHdhcyBzZWxlY3RlZAogICAgICAgICAgICB3cml0ZXIuZmx1c2goKQogICAgICAgICAgICBjaG9zZW5fYXV0aCA9IHNlbGYuX3JlYWRhbGwocmVhZGVyLCAyKQoKICAgICAgICAgICAgaWYgY2hvc2VuX2F1dGhbMDoxXSAhPSBiIlx4MDUiOgogICAgICAgICAgICAgICAgIyBOb3RlOiBzdHJpbmdbaTppKzFdIGlzIHVzZWQgYmVjYXVzZSBpbmRleGluZyBvZiBhIGJ5dGVzdHJpbmcKICAgICAgICAgICAgICAgICMgdmlhIGJ5dGVzdHJpbmdbaV0geWllbGRzIGFuIGludGVnZXIgaW4gUHl0aG9uIDMKICAgICAgICAgICAgICAgIHJhaXNlIEdlbmVyYWxQcm94eUVycm9yKAogICAgICAgICAgICAgICAgICAgICJTT0NLUzUgcHJveHkgc2VydmVyIHNlbnQgaW52YWxpZCBkYXRhIikKCiAgICAgICAgICAgICMgQ2hlY2sgdGhlIGNob3NlbiBhdXRoZW50aWNhdGlvbiBtZXRob2QKCiAgICAgICAgICAgIGlmIGNob3Nlbl9hdXRoWzE6Ml0gPT0gYiJceDAyIjoKICAgICAgICAgICAgICAgICMgT2theSwgd2UgbmVlZCB0byBwZXJmb3JtIGEgYmFzaWMgdXNlcm5hbWUvcGFzc3dvcmQKICAgICAgICAgICAgICAgICMgYXV0aGVudGljYXRpb24uCiAgICAgICAgICAgICAgICB3cml0ZXIud3JpdGUoYiJceDAxIiArIGNocihsZW4odXNlcm5hbWUpKS5lbmNvZGUoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICsgdXNlcm5hbWUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICArIGNocihsZW4ocGFzc3dvcmQpKS5lbmNvZGUoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICsgcGFzc3dvcmQpCiAgICAgICAgICAgICAgICB3cml0ZXIuZmx1c2goKQogICAgICAgICAgICAgICAgYXV0aF9zdGF0dXMgPSBzZWxmLl9yZWFkYWxsKHJlYWRlciwgMikKICAgICAgICAgICAgICAgIGlmIGF1dGhfc3RhdHVzWzA6MV0gIT0gYiJceDAxIjoKICAgICAgICAgICAgICAgICAgICAjIEJhZCByZXNwb25zZQogICAgICAgICAgICAgICAgICAgIHJhaXNlIEdlbmVyYWxQcm94eUVycm9yKAogICAgICAgICAgICAgICAgICAgICAgICAiU09DS1M1IHByb3h5IHNlcnZlciBzZW50IGludmFsaWQgZGF0YSIpCiAgICAgICAgICAgICAgICBpZiBhdXRoX3N0YXR1c1sxOjJdICE9IGIiXHgwMCI6CiAgICAgICAgICAgICAgICAgICAgIyBBdXRoZW50aWNhdGlvbiBmYWlsZWQKICAgICAgICAgICAgICAgICAgICByYWlzZSBTT0NLUzVBdXRoRXJyb3IoIlNPQ0tTNSBhdXRoZW50aWNhdGlvbiBmYWlsZWQiKQoKICAgICAgICAgICAgICAgICMgT3RoZXJ3aXNlLCBhdXRoZW50aWNhdGlvbiBzdWNjZWVkZWQKCiAgICAgICAgICAgICMgTm8gYXV0aGVudGljYXRpb24gaXMgcmVxdWlyZWQgaWYgMHgwMAogICAgICAgICAgICBlbGlmIGNob3Nlbl9hdXRoWzE6Ml0gIT0gYiJceDAwIjoKICAgICAgICAgICAgICAgICMgUmVhY2hpbmcgaGVyZSBpcyBhbHdheXMgYmFkCiAgICAgICAgICAgICAgICBpZiBjaG9zZW5fYXV0aFsxOjJdID09IGIiXHhGRiI6CiAgICAgICAgICAgICAgICAgICAgcmFpc2UgU09DS1M1QXV0aEVycm9yKAogICAgICAgICAgICAgICAgICAgICAgICAiQWxsIG9mZmVyZWQgU09DS1M1IGF1dGhlbnRpY2F0aW9uIG1ldGhvZHMgd2VyZSIKICAgICAgICAgICAgICAgICAgICAgICAgIiByZWplY3RlZCIpCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIHJhaXNlIEdlbmVyYWxQcm94eUVycm9yKAogICAgICAgICAgICAgICAgICAgICAgICAiU09DS1M1IHByb3h5IHNlcnZlciBzZW50IGludmFsaWQgZGF0YSIpCgogICAgICAgICAgICAjIE5vdyB3ZSBjYW4gcmVxdWVzdCB0aGUgYWN0dWFsIGNvbm5lY3Rpb24KICAgICAgICAgICAgd3JpdGVyLndyaXRlKGIiXHgwNSIgKyBjbWQgKyBiIlx4MDAiKQogICAgICAgICAgICByZXNvbHZlZCA9IHNlbGYuX3dyaXRlX1NPQ0tTNV9hZGRyZXNzKGRzdCwgd3JpdGVyKQogICAgICAgICAgICB3cml0ZXIuZmx1c2goKQoKICAgICAgICAgICAgIyBHZXQgdGhlIHJlc3BvbnNlCiAgICAgICAgICAgIHJlc3AgPSBzZWxmLl9yZWFkYWxsKHJlYWRlciwgMykKICAgICAgICAgICAgaWYgcmVzcFswOjFdICE9IGIiXHgwNSI6CiAgICAgICAgICAgICAgICByYWlzZSBHZW5lcmFsUHJveHlFcnJvcigKICAgICAgICAgICAgICAgICAgICAiU09DS1M1IHByb3h5IHNlcnZlciBzZW50IGludmFsaWQgZGF0YSIpCgogICAgICAgICAgICBzdGF0dXMgPSBvcmQocmVzcFsxOjJdKQogICAgICAgICAgICBpZiBzdGF0dXMgIT0gMHgwMDoKICAgICAgICAgICAgICAgICMgQ29ubmVjdGlvbiBmYWlsZWQ6IHNlcnZlciByZXR1cm5lZCBhbiBlcnJvcgogICAgICAgICAgICAgICAgZXJyb3IgPSBTT0NLUzVfRVJST1JTLmdldChzdGF0dXMsICJVbmtub3duIGVycm9yIikKICAgICAgICAgICAgICAgIHJhaXNlIFNPQ0tTNUVycm9yKCJ7MDojMDR4fTogezF9Ii5mb3JtYXQoc3RhdHVzLCBlcnJvcikpCgogICAgICAgICAgICAjIEdldCB0aGUgYm91bmQgYWRkcmVzcy9wb3J0CiAgICAgICAgICAgIGJuZCA9IHNlbGYuX3JlYWRfU09DS1M1X2FkZHJlc3MocmVhZGVyKQoKICAgICAgICAgICAgc3VwZXIoc29ja3NvY2tldCwgc2VsZikuc2V0dGltZW91dChzZWxmLl90aW1lb3V0KQogICAgICAgICAgICByZXR1cm4gKHJlc29sdmVkLCBibmQpCiAgICAgICAgZmluYWxseToKICAgICAgICAgICAgcmVhZGVyLmNsb3NlKCkKICAgICAgICAgICAgd3JpdGVyLmNsb3NlKCkKCiAgICBkZWYgX3dyaXRlX1NPQ0tTNV9hZGRyZXNzKHNlbGYsIGFkZHIsIGZpbGUpOgogICAgICAgICIiIgogICAgICAgIFJldHVybiB0aGUgaG9zdCBhbmQgcG9ydCBwYWNrZWQgZm9yIHRoZSBTT0NLUzUgcHJvdG9jb2wsCiAgICAgICAgYW5kIHRoZSByZXNvbHZlZCBhZGRyZXNzIGFzIGEgdHVwbGUgb2JqZWN0LgogICAgICAgICIiIgogICAgICAgIGhvc3QsIHBvcnQgPSBhZGRyCiAgICAgICAgcHJveHlfdHlwZSwgXywgXywgcmRucywgdXNlcm5hbWUsIHBhc3N3b3JkID0gc2VsZi5wcm94eQogICAgICAgIGZhbWlseV90b19ieXRlID0ge3NvY2tldC5BRl9JTkVUOiBiIlx4MDEiLCBzb2NrZXQuQUZfSU5FVDY6IGIiXHgwNCJ9CgogICAgICAgICMgSWYgdGhlIGdpdmVuIGRlc3RpbmF0aW9uIGFkZHJlc3MgaXMgYW4gSVAgYWRkcmVzcywgd2UnbGwKICAgICAgICAjIHVzZSB0aGUgSVAgYWRkcmVzcyByZXF1ZXN0IGV2ZW4gaWYgcmVtb3RlIHJlc29sdmluZyB3YXMgc3BlY2lmaWVkLgogICAgICAgICMgRGV0ZWN0IHdoZXRoZXIgdGhlIGFkZHJlc3MgaXMgSVB2NC82IGRpcmVjdGx5LgogICAgICAgIGZvciBmYW1pbHkgaW4gKHNvY2tldC5BRl9JTkVULCBzb2NrZXQuQUZfSU5FVDYpOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBhZGRyX2J5dGVzID0gc29ja2V0LmluZXRfcHRvbihmYW1pbHksIGhvc3QpCiAgICAgICAgICAgICAgICBmaWxlLndyaXRlKGZhbWlseV90b19ieXRlW2ZhbWlseV0gKyBhZGRyX2J5dGVzKQogICAgICAgICAgICAgICAgaG9zdCA9IHNvY2tldC5pbmV0X250b3AoZmFtaWx5LCBhZGRyX2J5dGVzKQogICAgICAgICAgICAgICAgZmlsZS53cml0ZShzdHJ1Y3QucGFjaygiPkgiLCBwb3J0KSkKICAgICAgICAgICAgICAgIHJldHVybiBob3N0LCBwb3J0CiAgICAgICAgICAgIGV4Y2VwdCBzb2NrZXQuZXJyb3I6CiAgICAgICAgICAgICAgICBjb250aW51ZQoKICAgICAgICAjIFdlbGwgaXQncyBub3QgYW4gSVAgbnVtYmVyLCBzbyBpdCdzIHByb2JhYmx5IGEgRE5TIG5hbWUuCiAgICAgICAgaWYgcmRuczoKICAgICAgICAgICAgIyBSZXNvbHZlIHJlbW90ZWx5CiAgICAgICAgICAgIGhvc3RfYnl0ZXMgPSBob3N0LmVuY29kZSgiaWRuYSIpCiAgICAgICAgICAgIGZpbGUud3JpdGUoYiJceDAzIiArIGNocihsZW4oaG9zdF9ieXRlcykpLmVuY29kZSgpICsgaG9zdF9ieXRlcykKICAgICAgICBlbHNlOgogICAgICAgICAgICAjIFJlc29sdmUgbG9jYWxseQogICAgICAgICAgICBhZGRyZXNzZXMgPSBzb2NrZXQuZ2V0YWRkcmluZm8oaG9zdCwgcG9ydCwgc29ja2V0LkFGX1VOU1BFQywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNvY2tldC5TT0NLX1NUUkVBTSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNvY2tldC5JUFBST1RPX1RDUCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNvY2tldC5BSV9BRERSQ09ORklHKQogICAgICAgICAgICAjIFdlIGNhbid0IHJlYWxseSB3b3JrIG91dCB3aGF0IElQIGlzIHJlYWNoYWJsZSwgc28ganVzdCBwaWNrIHRoZQogICAgICAgICAgICAjIGZpcnN0LgogICAgICAgICAgICB0YXJnZXRfYWRkciA9IGFkZHJlc3Nlc1swXQogICAgICAgICAgICBmYW1pbHkgPSB0YXJnZXRfYWRkclswXQogICAgICAgICAgICBob3N0ID0gdGFyZ2V0X2FkZHJbNF1bMF0KCiAgICAgICAgICAgIGFkZHJfYnl0ZXMgPSBzb2NrZXQuaW5ldF9wdG9uKGZhbWlseSwgaG9zdCkKICAgICAgICAgICAgZmlsZS53cml0ZShmYW1pbHlfdG9fYnl0ZVtmYW1pbHldICsgYWRkcl9ieXRlcykKICAgICAgICAgICAgaG9zdCA9IHNvY2tldC5pbmV0X250b3AoZmFtaWx5LCBhZGRyX2J5dGVzKQogICAgICAgIGZpbGUud3JpdGUoc3RydWN0LnBhY2soIj5IIiwgcG9ydCkpCiAgICAgICAgcmV0dXJuIGhvc3QsIHBvcnQKCiAgICBkZWYgX3JlYWRfU09DS1M1X2FkZHJlc3Moc2VsZiwgZmlsZSk6CiAgICAgICAgYXR5cCA9IHNlbGYuX3JlYWRhbGwoZmlsZSwgMSkKICAgICAgICBpZiBhdHlwID09IGIiXHgwMSI6CiAgICAgICAgICAgIGFkZHIgPSBzb2NrZXQuaW5ldF9udG9hKHNlbGYuX3JlYWRhbGwoZmlsZSwgNCkpCiAgICAgICAgZWxpZiBhdHlwID09IGIiXHgwMyI6CiAgICAgICAgICAgIGxlbmd0aCA9IHNlbGYuX3JlYWRhbGwoZmlsZSwgMSkKICAgICAgICAgICAgYWRkciA9IHNlbGYuX3JlYWRhbGwoZmlsZSwgb3JkKGxlbmd0aCkpCiAgICAgICAgZWxpZiBhdHlwID09IGIiXHgwNCI6CiAgICAgICAgICAgIGFkZHIgPSBzb2NrZXQuaW5ldF9udG9wKHNvY2tldC5BRl9JTkVUNiwgc2VsZi5fcmVhZGFsbChmaWxlLCAxNikpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmFpc2UgR2VuZXJhbFByb3h5RXJyb3IoIlNPQ0tTNSBwcm94eSBzZXJ2ZXIgc2VudCBpbnZhbGlkIGRhdGEiKQoKICAgICAgICBwb3J0ID0gc3RydWN0LnVucGFjaygiPkgiLCBzZWxmLl9yZWFkYWxsKGZpbGUsIDIpKVswXQogICAgICAgIHJldHVybiBhZGRyLCBwb3J0CgogICAgZGVmIF9uZWdvdGlhdGVfU09DS1M0KHNlbGYsIGRlc3RfYWRkciwgZGVzdF9wb3J0KToKICAgICAgICAiIiJOZWdvdGlhdGVzIGEgY29ubmVjdGlvbiB0aHJvdWdoIGEgU09DS1M0IHNlcnZlci4iIiIKICAgICAgICBwcm94eV90eXBlLCBhZGRyLCBwb3J0LCByZG5zLCB1c2VybmFtZSwgcGFzc3dvcmQgPSBzZWxmLnByb3h5CgogICAgICAgIHdyaXRlciA9IHNlbGYubWFrZWZpbGUoIndiIikKICAgICAgICByZWFkZXIgPSBzZWxmLm1ha2VmaWxlKCJyYiIsIDApICAjIGJ1ZmZlcmluZz0wIHJlbmFtZWQgaW4gUHl0aG9uIDMKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgQ2hlY2sgaWYgdGhlIGRlc3RpbmF0aW9uIGFkZHJlc3MgcHJvdmlkZWQgaXMgYW4gSVAgYWRkcmVzcwogICAgICAgICAgICByZW1vdGVfcmVzb2x2ZSA9IEZhbHNlCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGFkZHJfYnl0ZXMgPSBzb2NrZXQuaW5ldF9hdG9uKGRlc3RfYWRkcikKICAgICAgICAgICAgZXhjZXB0IHNvY2tldC5lcnJvcjoKICAgICAgICAgICAgICAgICMgSXQncyBhIEROUyBuYW1lLiBDaGVjayB3aGVyZSBpdCBzaG91bGQgYmUgcmVzb2x2ZWQuCiAgICAgICAgICAgICAgICBpZiByZG5zOgogICAgICAgICAgICAgICAgICAgIGFkZHJfYnl0ZXMgPSBiIlx4MDBceDAwXHgwMFx4MDEiCiAgICAgICAgICAgICAgICAgICAgcmVtb3RlX3Jlc29sdmUgPSBUcnVlCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGFkZHJfYnl0ZXMgPSBzb2NrZXQuaW5ldF9hdG9uKAogICAgICAgICAgICAgICAgICAgICAgICBzb2NrZXQuZ2V0aG9zdGJ5bmFtZShkZXN0X2FkZHIpKQoKICAgICAgICAgICAgIyBDb25zdHJ1Y3QgdGhlIHJlcXVlc3QgcGFja2V0CiAgICAgICAgICAgIHdyaXRlci53cml0ZShzdHJ1Y3QucGFjaygiPkJCSCIsIDB4MDQsIDB4MDEsIGRlc3RfcG9ydCkpCiAgICAgICAgICAgIHdyaXRlci53cml0ZShhZGRyX2J5dGVzKQoKICAgICAgICAgICAgIyBUaGUgdXNlcm5hbWUgcGFyYW1ldGVyIGlzIGNvbnNpZGVyZWQgdXNlcmlkIGZvciBTT0NLUzQKICAgICAgICAgICAgaWYgdXNlcm5hbWU6CiAgICAgICAgICAgICAgICB3cml0ZXIud3JpdGUodXNlcm5hbWUpCiAgICAgICAgICAgIHdyaXRlci53cml0ZShiIlx4MDAiKQoKICAgICAgICAgICAgIyBETlMgbmFtZSBpZiByZW1vdGUgcmVzb2x2aW5nIGlzIHJlcXVpcmVkCiAgICAgICAgICAgICMgTk9URTogVGhpcyBpcyBhY3R1YWxseSBhbiBleHRlbnNpb24gdG8gdGhlIFNPQ0tTNCBwcm90b2NvbAogICAgICAgICAgICAjIGNhbGxlZCBTT0NLUzRBIGFuZCBtYXkgbm90IGJlIHN1cHBvcnRlZCBpbiBhbGwgY2FzZXMuCiAgICAgICAgICAgIGlmIHJlbW90ZV9yZXNvbHZlOgogICAgICAgICAgICAgICAgd3JpdGVyLndyaXRlKGRlc3RfYWRkci5lbmNvZGUoImlkbmEiKSArIGIiXHgwMCIpCiAgICAgICAgICAgIHdyaXRlci5mbHVzaCgpCgogICAgICAgICAgICAjIEdldCB0aGUgcmVzcG9uc2UgZnJvbSB0aGUgc2VydmVyCiAgICAgICAgICAgIHJlc3AgPSBzZWxmLl9yZWFkYWxsKHJlYWRlciwgOCkKICAgICAgICAgICAgaWYgcmVzcFswOjFdICE9IGIiXHgwMCI6CiAgICAgICAgICAgICAgICAjIEJhZCBkYXRhCiAgICAgICAgICAgICAgICByYWlzZSBHZW5lcmFsUHJveHlFcnJvcigKICAgICAgICAgICAgICAgICAgICAiU09DS1M0IHByb3h5IHNlcnZlciBzZW50IGludmFsaWQgZGF0YSIpCgogICAgICAgICAgICBzdGF0dXMgPSBvcmQocmVzcFsxOjJdKQogICAgICAgICAgICBpZiBzdGF0dXMgIT0gMHg1QToKICAgICAgICAgICAgICAgICMgQ29ubmVjdGlvbiBmYWlsZWQ6IHNlcnZlciByZXR1cm5lZCBhbiBlcnJvcgogICAgICAgICAgICAgICAgZXJyb3IgPSBTT0NLUzRfRVJST1JTLmdldChzdGF0dXMsICJVbmtub3duIGVycm9yIikKICAgICAgICAgICAgICAgIHJhaXNlIFNPQ0tTNEVycm9yKCJ7MDojMDR4fTogezF9Ii5mb3JtYXQoc3RhdHVzLCBlcnJvcikpCgogICAgICAgICAgICAjIEdldCB0aGUgYm91bmQgYWRkcmVzcy9wb3J0CiAgICAgICAgICAgIHNlbGYucHJveHlfc29ja25hbWUgPSAoc29ja2V0LmluZXRfbnRvYShyZXNwWzQ6XSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RydWN0LnVucGFjaygiPkgiLCByZXNwWzI6NF0pWzBdKQogICAgICAgICAgICBpZiByZW1vdGVfcmVzb2x2ZToKICAgICAgICAgICAgICAgIHNlbGYucHJveHlfcGVlcm5hbWUgPSBzb2NrZXQuaW5ldF9udG9hKGFkZHJfYnl0ZXMpLCBkZXN0X3BvcnQKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHNlbGYucHJveHlfcGVlcm5hbWUgPSBkZXN0X2FkZHIsIGRlc3RfcG9ydAogICAgICAgIGZpbmFsbHk6CiAgICAgICAgICAgIHJlYWRlci5jbG9zZSgpCiAgICAgICAgICAgIHdyaXRlci5jbG9zZSgpCgogICAgZGVmIF9uZWdvdGlhdGVfSFRUUChzZWxmLCBkZXN0X2FkZHIsIGRlc3RfcG9ydCk6CiAgICAgICAgIiIiTmVnb3RpYXRlcyBhIGNvbm5lY3Rpb24gdGhyb3VnaCBhbiBIVFRQIHNlcnZlci4KCiAgICAgICAgTk9URTogVGhpcyBjdXJyZW50bHkgb25seSBzdXBwb3J0cyBIVFRQIENPTk5FQ1Qtc3R5bGUgcHJveGllcy4iIiIKICAgICAgICBwcm94eV90eXBlLCBhZGRyLCBwb3J0LCByZG5zLCB1c2VybmFtZSwgcGFzc3dvcmQgPSBzZWxmLnByb3h5CgogICAgICAgICMgSWYgd2UgbmVlZCB0byByZXNvbHZlIGxvY2FsbHksIHdlIGRvIHRoaXMgbm93CiAgICAgICAgYWRkciA9IGRlc3RfYWRkciBpZiByZG5zIGVsc2Ugc29ja2V0LmdldGhvc3RieW5hbWUoZGVzdF9hZGRyKQoKICAgICAgICBodHRwX2hlYWRlcnMgPSBbCiAgICAgICAgICAgIChiIkNPTk5FQ1QgIiArIGFkZHIuZW5jb2RlKCJpZG5hIikgKyBiIjoiCiAgICAgICAgICAgICArIHN0cihkZXN0X3BvcnQpLmVuY29kZSgpICsgYiIgSFRUUC8xLjEiKSwKICAgICAgICAgICAgYiJIb3N0OiAiICsgZGVzdF9hZGRyLmVuY29kZSgiaWRuYSIpCiAgICAgICAgXQoKICAgICAgICBpZiB1c2VybmFtZSBhbmQgcGFzc3dvcmQ6CiAgICAgICAgICAgIGh0dHBfaGVhZGVycy5hcHBlbmQoYiJQcm94eS1BdXRob3JpemF0aW9uOiBiYXNpYyAiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKyBiNjRlbmNvZGUodXNlcm5hbWUgKyBiIjoiICsgcGFzc3dvcmQpKQoKICAgICAgICBodHRwX2hlYWRlcnMuYXBwZW5kKGIiXHJcbiIpCgogICAgICAgIHNlbGYuc2VuZGFsbChiIlxyXG4iLmpvaW4oaHR0cF9oZWFkZXJzKSkKCiAgICAgICAgIyBXZSBqdXN0IG5lZWQgdGhlIGZpcnN0IGxpbmUgdG8gY2hlY2sgaWYgdGhlIGNvbm5lY3Rpb24gd2FzIHN1Y2Nlc3NmdWwKICAgICAgICBmb2JqID0gc2VsZi5tYWtlZmlsZSgpCiAgICAgICAgc3RhdHVzX2xpbmUgPSBmb2JqLnJlYWRsaW5lKCkKICAgICAgICBmb2JqLmNsb3NlKCkKCiAgICAgICAgaWYgbm90IHN0YXR1c19saW5lOgogICAgICAgICAgICByYWlzZSBHZW5lcmFsUHJveHlFcnJvcigiQ29ubmVjdGlvbiBjbG9zZWQgdW5leHBlY3RlZGx5IikKCiAgICAgICAgdHJ5OgogICAgICAgICAgICBwcm90bywgc3RhdHVzX2NvZGUsIHN0YXR1c19tc2cgPSBzdGF0dXNfbGluZS5zcGxpdCgiICIsIDIpCiAgICAgICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAgICAgIHJhaXNlIEdlbmVyYWxQcm94eUVycm9yKCJIVFRQIHByb3h5IHNlcnZlciBzZW50IGludmFsaWQgcmVzcG9uc2UiKQoKICAgICAgICBpZiBub3QgcHJvdG8uc3RhcnRzd2l0aCgiSFRUUC8iKToKICAgICAgICAgICAgcmFpc2UgR2VuZXJhbFByb3h5RXJyb3IoCiAgICAgICAgICAgICAgICAiUHJveHkgc2VydmVyIGRvZXMgbm90IGFwcGVhciB0byBiZSBhbiBIVFRQIHByb3h5IikKCiAgICAgICAgdHJ5OgogICAgICAgICAgICBzdGF0dXNfY29kZSA9IGludChzdGF0dXNfY29kZSkKICAgICAgICBleGNlcHQgVmFsdWVFcnJvcjoKICAgICAgICAgICAgcmFpc2UgSFRUUEVycm9yKAogICAgICAgICAgICAgICAgIkhUVFAgcHJveHkgc2VydmVyIGRpZCBub3QgcmV0dXJuIGEgdmFsaWQgSFRUUCBzdGF0dXMiKQoKICAgICAgICBpZiBzdGF0dXNfY29kZSAhPSAyMDA6CiAgICAgICAgICAgIGVycm9yID0gInswfTogezF9Ii5mb3JtYXQoc3RhdHVzX2NvZGUsIHN0YXR1c19tc2cpCiAgICAgICAgICAgIGlmIHN0YXR1c19jb2RlIGluICg0MDAsIDQwMywgNDA1KToKICAgICAgICAgICAgICAgICMgSXQncyBsaWtlbHkgdGhhdCB0aGUgSFRUUCBwcm94eSBzZXJ2ZXIgZG9lcyBub3Qgc3VwcG9ydCB0aGUKICAgICAgICAgICAgICAgICMgQ09OTkVDVCB0dW5uZWxpbmcgbWV0aG9kCiAgICAgICAgICAgICAgICBlcnJvciArPSAoIlxuWypdIE5vdGU6IFRoZSBIVFRQIHByb3h5IHNlcnZlciBtYXkgbm90IGJlIgogICAgICAgICAgICAgICAgICAgICAgICAgICIgc3VwcG9ydGVkIGJ5IFB5U29ja3MgKG11c3QgYmUgYSBDT05ORUNUIHR1bm5lbCIKICAgICAgICAgICAgICAgICAgICAgICAgICAiIHByb3h5KSIpCiAgICAgICAgICAgIHJhaXNlIEhUVFBFcnJvcihlcnJvcikKCiAgICAgICAgc2VsZi5wcm94eV9zb2NrbmFtZSA9IChiIjAuMC4wLjAiLCAwKQogICAgICAgIHNlbGYucHJveHlfcGVlcm5hbWUgPSBhZGRyLCBkZXN0X3BvcnQKCiAgICBfcHJveHlfbmVnb3RpYXRvcnMgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgIFNPQ0tTNDogX25lZ290aWF0ZV9TT0NLUzQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgIFNPQ0tTNTogX25lZ290aWF0ZV9TT0NLUzUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgIEhUVFA6IF9uZWdvdGlhdGVfSFRUUAogICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgIEBzZXRfc2VsZl9ibG9ja2luZwogICAgZGVmIGNvbm5lY3Qoc2VsZiwgZGVzdF9wYWlyKToKICAgICAgICAiIiIKICAgICAgICBDb25uZWN0cyB0byB0aGUgc3BlY2lmaWVkIGRlc3RpbmF0aW9uIHRocm91Z2ggYSBwcm94eS4KICAgICAgICBVc2VzIHRoZSBzYW1lIEFQSSBhcyBzb2NrZXQncyBjb25uZWN0KCkuCiAgICAgICAgVG8gc2VsZWN0IHRoZSBwcm94eSBzZXJ2ZXIsIHVzZSBzZXRfcHJveHkoKS4KCiAgICAgICAgZGVzdF9wYWlyIC0gMi10dXBsZSBvZiAoSVAvaG9zdG5hbWUsIHBvcnQpLgogICAgICAgICIiIgogICAgICAgIGlmIGxlbihkZXN0X3BhaXIpICE9IDIgb3IgZGVzdF9wYWlyWzBdLnN0YXJ0c3dpdGgoIlsiKToKICAgICAgICAgICAgIyBQcm9iYWJseSBJUHY2LCBub3Qgc3VwcG9ydGVkIC0tIHJhaXNlIGFuIGVycm9yLCBhbmQgaG9wZQogICAgICAgICAgICAjIEhhcHB5IEV5ZWJhbGxzIChSRkM2NTU1KSBtYWtlcyBzdXJlIGF0IGxlYXN0IHRoZSBJUHY0CiAgICAgICAgICAgICMgY29ubmVjdGlvbiB3b3Jrcy4uLgogICAgICAgICAgICByYWlzZSBzb2NrZXQuZXJyb3IoIlB5U29ja3MgZG9lc24ndCBzdXBwb3J0IElQdjY6ICVzIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJSBzdHIoZGVzdF9wYWlyKSkKCiAgICAgICAgZGVzdF9hZGRyLCBkZXN0X3BvcnQgPSBkZXN0X3BhaXIKCiAgICAgICAgaWYgc2VsZi50eXBlID09IHNvY2tldC5TT0NLX0RHUkFNOgogICAgICAgICAgICBpZiBub3Qgc2VsZi5fcHJveHljb25uOgogICAgICAgICAgICAgICAgc2VsZi5iaW5kKCgiIiwgMCkpCiAgICAgICAgICAgIGRlc3RfYWRkciA9IHNvY2tldC5nZXRob3N0YnluYW1lKGRlc3RfYWRkcikKCiAgICAgICAgICAgICMgSWYgdGhlIGhvc3QgYWRkcmVzcyBpcyBJTkFERFJfQU5ZIG9yIHNpbWlsYXIsIHJlc2V0IHRoZSBwZWVyCiAgICAgICAgICAgICMgYWRkcmVzcyBzbyB0aGF0IHBhY2tldHMgYXJlIHJlY2VpdmVkIGZyb20gYW55IHBlZXIKICAgICAgICAgICAgaWYgZGVzdF9hZGRyID09ICIwLjAuMC4wIiBhbmQgbm90IGRlc3RfcG9ydDoKICAgICAgICAgICAgICAgIHNlbGYucHJveHlfcGVlcm5hbWUgPSBOb25lCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBzZWxmLnByb3h5X3BlZXJuYW1lID0gKGRlc3RfYWRkciwgZGVzdF9wb3J0KQogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgKHByb3h5X3R5cGUsIHByb3h5X2FkZHIsIHByb3h5X3BvcnQsIHJkbnMsIHVzZXJuYW1lLAogICAgICAgICBwYXNzd29yZCkgPSBzZWxmLnByb3h5CgogICAgICAgICMgRG8gYSBtaW5pbWFsIGlucHV0IGNoZWNrIGZpcnN0CiAgICAgICAgaWYgKG5vdCBpc2luc3RhbmNlKGRlc3RfcGFpciwgKGxpc3QsIHR1cGxlKSkKICAgICAgICAgICAgICAgIG9yIGxlbihkZXN0X3BhaXIpICE9IDIKICAgICAgICAgICAgICAgIG9yIG5vdCBkZXN0X2FkZHIKICAgICAgICAgICAgICAgIG9yIG5vdCBpc2luc3RhbmNlKGRlc3RfcG9ydCwgaW50KSk6CiAgICAgICAgICAgICMgSW5wdXRzIGZhaWxlZCwgcmFpc2UgYW4gZXJyb3IKICAgICAgICAgICAgcmFpc2UgR2VuZXJhbFByb3h5RXJyb3IoCiAgICAgICAgICAgICAgICAiSW52YWxpZCBkZXN0aW5hdGlvbi1jb25uZWN0aW9uIChob3N0LCBwb3J0KSBwYWlyIikKCiAgICAgICAgIyBXZSBzZXQgdGhlIHRpbWVvdXQgaGVyZSBzbyB0aGF0IHdlIGRvbid0IGhhbmcgaW4gY29ubmVjdGlvbiBvciBkdXJpbmcKICAgICAgICAjIG5lZ290aWF0aW9uLgogICAgICAgIHN1cGVyKHNvY2tzb2NrZXQsIHNlbGYpLnNldHRpbWVvdXQoc2VsZi5fdGltZW91dCkKCiAgICAgICAgaWYgcHJveHlfdHlwZSBpcyBOb25lOgogICAgICAgICAgICAjIFRyZWF0IGxpa2UgcmVndWxhciBzb2NrZXQgb2JqZWN0CiAgICAgICAgICAgIHNlbGYucHJveHlfcGVlcm5hbWUgPSBkZXN0X3BhaXIKICAgICAgICAgICAgc3VwZXIoc29ja3NvY2tldCwgc2VsZikuc2V0dGltZW91dChzZWxmLl90aW1lb3V0KQogICAgICAgICAgICBzdXBlcihzb2Nrc29ja2V0LCBzZWxmKS5jb25uZWN0KChkZXN0X2FkZHIsIGRlc3RfcG9ydCkpCiAgICAgICAgICAgIHJldHVybgoKICAgICAgICBwcm94eV9hZGRyID0gc2VsZi5fcHJveHlfYWRkcigpCgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBJbml0aWFsIGNvbm5lY3Rpb24gdG8gcHJveHkgc2VydmVyLgogICAgICAgICAgICBzdXBlcihzb2Nrc29ja2V0LCBzZWxmKS5jb25uZWN0KHByb3h5X2FkZHIpCgogICAgICAgIGV4Y2VwdCBzb2NrZXQuZXJyb3IgYXMgZXJyb3I6CiAgICAgICAgICAgICMgRXJyb3Igd2hpbGUgY29ubmVjdGluZyB0byBwcm94eQogICAgICAgICAgICBzZWxmLmNsb3NlKCkKICAgICAgICAgICAgcHJveHlfYWRkciwgcHJveHlfcG9ydCA9IHByb3h5X2FkZHIKICAgICAgICAgICAgcHJveHlfc2VydmVyID0gInswfTp7MX0iLmZvcm1hdChwcm94eV9hZGRyLCBwcm94eV9wb3J0KQogICAgICAgICAgICBwcmludGFibGVfdHlwZSA9IFBSSU5UQUJMRV9QUk9YWV9UWVBFU1twcm94eV90eXBlXQoKICAgICAgICAgICAgbXNnID0gIkVycm9yIGNvbm5lY3RpbmcgdG8gezB9IHByb3h5IHsxfSIuZm9ybWF0KHByaW50YWJsZV90eXBlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJveHlfc2VydmVyKQogICAgICAgICAgICBsb2cuZGVidWcoIiVzIGR1ZSB0bzogJXMiLCBtc2csIGVycm9yKQogICAgICAgICAgICByYWlzZSBQcm94eUNvbm5lY3Rpb25FcnJvcihtc2csIGVycm9yKQoKICAgICAgICBlbHNlOgogICAgICAgICAgICAjIENvbm5lY3RlZCB0byBwcm94eSBzZXJ2ZXIsIG5vdyBuZWdvdGlhdGUKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgIyBDYWxscyBuZWdvdGlhdGVfe1NPQ0tTNCwgU09DS1M1LCBIVFRQfQogICAgICAgICAgICAgICAgbmVnb3RpYXRlID0gc2VsZi5fcHJveHlfbmVnb3RpYXRvcnNbcHJveHlfdHlwZV0KICAgICAgICAgICAgICAgIG5lZ290aWF0ZShzZWxmLCBkZXN0X2FkZHIsIGRlc3RfcG9ydCkKICAgICAgICAgICAgZXhjZXB0IHNvY2tldC5lcnJvciBhcyBlcnJvcjoKICAgICAgICAgICAgICAgICMgV3JhcCBzb2NrZXQgZXJyb3JzCiAgICAgICAgICAgICAgICBzZWxmLmNsb3NlKCkKICAgICAgICAgICAgICAgIHJhaXNlIEdlbmVyYWxQcm94eUVycm9yKCJTb2NrZXQgZXJyb3IiLCBlcnJvcikKICAgICAgICAgICAgZXhjZXB0IFByb3h5RXJyb3I6CiAgICAgICAgICAgICAgICAjIFByb3RvY29sIGVycm9yIHdoaWxlIG5lZ290aWF0aW5nIHdpdGggcHJveHkKICAgICAgICAgICAgICAgIHNlbGYuY2xvc2UoKQogICAgICAgICAgICAgICAgcmFpc2UKCiAgICBkZWYgX3Byb3h5X2FkZHIoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgUmV0dXJuIHByb3h5IGFkZHJlc3MgdG8gY29ubmVjdCB0byBhcyB0dXBsZSBvYmplY3QKICAgICAgICAiIiIKICAgICAgICAocHJveHlfdHlwZSwgcHJveHlfYWRkciwgcHJveHlfcG9ydCwgcmRucywgdXNlcm5hbWUsCiAgICAgICAgIHBhc3N3b3JkKSA9IHNlbGYucHJveHkKICAgICAgICBwcm94eV9wb3J0ID0gcHJveHlfcG9ydCBvciBERUZBVUxUX1BPUlRTLmdldChwcm94eV90eXBlKQogICAgICAgIGlmIG5vdCBwcm94eV9wb3J0OgogICAgICAgICAgICByYWlzZSBHZW5lcmFsUHJveHlFcnJvcigiSW52YWxpZCBwcm94eSB0eXBlIikKICAgICAgICByZXR1cm4gcHJveHlfYWRkciwgcHJveHlfcG9ydAo=
