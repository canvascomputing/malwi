statistics:
  total_files: 1
  skipped_files: 0.0
  processed_objects: 1
  malicious_objects: 0
details:
- path: .repo_cache/malicious_repos/pypi_malregistry/pycryptoenv/1.0.7/pycryptoenv-1.0.7/pycryptoenv-1.0.7/pycryptoenv/_openssl/tls.py
  contents:
  - name: TLSSocket._read_certificates
    score: 0.0
    code: |-
      def _read_certificates(self):
              """
              Reads end-entity and intermediate certificate information from the
              TLS session
              """

              stack_pointer = libssl.SSL_get_peer_cert_chain(self._ssl)
              if is_null(stack_pointer):
                  handle_openssl_error(0, TLSError)

              if libcrypto_version_info < (1, 1):
                  number_certs = libssl.sk_num(stack_pointer)
              else:
                  number_certs = libssl.OPENSSL_sk_num(stack_pointer)

              self._intermediates = []

              for index in range(0, number_certs):
                  if libcrypto_version_info < (1, 1):
                      x509_ = libssl.sk_value(stack_pointer, index)
                  else:
                      x509_ = libssl.OPENSSL_sk_value(stack_pointer, index)
                  buffer_size = libcrypto.i2d_X509(x509_, null())
                  cert_buffer = buffer_from_bytes(buffer_size)
                  cert_pointer = buffer_pointer(cert_buffer)
                  cert_length = libcrypto.i2d_X509(x509_, cert_pointer)
                  handle_openssl_error(cert_length)
                  cert_data = bytes_from_buffer(cert_buffer, cert_length)

                  cert = Asn1Certificate.load(cert_data)

                  if index == 0:
                      self._certificate = cert
                  else:
                      self._intermediates.append(cert)
    tokens: resume load_global libssl load_attr STRING_LEN_S_ENT_HIGH load_fast self load_attr _ssl call store_fast stack_pointer load_global is_null load_fast stack_pointer call pop_jump_if_false TO_NUMBER load_global STRING_LEN_S_ENT_HIGH load_const INTEGER load_global TLSError call pop_top load_global STRING_LEN_S_ENT_HIGH load_const compare_op < pop_jump_if_false TO_NUMBER load_global libssl load_attr sk_num load_fast stack_pointer call store_fast number_certs jump_forward TO_NUMBER load_global libssl load_attr OPENSSL_sk_num load_fast stack_pointer call store_fast number_certs build_list load_fast self store_attr _intermediates load_global range load_const INTEGER load_fast number_certs call get_iter for_iter TO_NUMBER store_fast index load_global STRING_LEN_S_ENT_HIGH load_const compare_op < pop_jump_if_false TO_NUMBER load_global libssl load_attr sk_value load_fast stack_pointer load_fast index call store_fast x509_ jump_forward TO_NUMBER load_global libssl load_attr STRING_LEN_S_ENT_HIGH load_fast stack_pointer load_fast index call store_fast x509_ load_global libcrypto load_attr i2d_X509 load_fast x509_ load_global null call call store_fast buffer_size load_global STRING_LEN_S_ENT_HIGH load_fast buffer_size call store_fast cert_buffer load_global buffer_pointer load_fast cert_buffer call store_fast cert_pointer load_global libcrypto load_attr i2d_X509 load_fast x509_ load_fast cert_pointer call store_fast cert_length load_global STRING_LEN_S_ENT_HIGH load_fast cert_length call pop_top load_global STRING_LEN_S_ENT_HIGH load_fast cert_buffer load_fast cert_length call store_fast cert_data load_global Asn1Certificate load_attr load load_fast cert_data call store_fast cert load_fast index load_const INTEGER compare_op == pop_jump_if_false TO_NUMBER load_fast cert load_fast self store_attr _certificate jump_backward TO_NUMBER load_fast self load_attr _intermediates load_attr append load_fast cert call pop_top jump_backward TO_NUMBER end_for return_const None
    hash: b8424e05fbc7a2aa082264e8a59e68e5e5f5266adcd9b8f68d23b5a6c5e15907
sources:
  ? .repo_cache/malicious_repos/pypi_malregistry/pycryptoenv/1.0.7/pycryptoenv-1.0.7/pycryptoenv-1.0.7/pycryptoenv/_openssl/tls.py
  : IyBjb2Rpbmc6IHV0Zi04CmZyb20gX19mdXR1cmVfXyBpbXBvcnQgdW5pY29kZV9saXRlcmFscywgZGl2aXNpb24sIGFic29sdXRlX2ltcG9ydCwgcHJpbnRfZnVuY3Rpb24KCmltcG9ydCBzeXMKaW1wb3J0IHJlCmltcG9ydCBzb2NrZXQgYXMgc29ja2V0XwppbXBvcnQgc2VsZWN0CmltcG9ydCBudW1iZXJzCgpmcm9tIC5fbGlic3NsIGltcG9ydCBlcnJvcl9jb2RlX3ZlcnNpb25faW5mbywgbGlic3NsLCBMaWJzc2xDb25zdApmcm9tIC5fbGliY3J5cHRvIGltcG9ydCBsaWJjcnlwdG8sIGxpYmNyeXB0b192ZXJzaW9uX2luZm8sIGhhbmRsZV9vcGVuc3NsX2Vycm9yLCBwZWVrX29wZW5zc2xfZXJyb3IKZnJvbSAuLiBpbXBvcnQgX2JhY2tlbmRfY29uZmlnCmZyb20gLi5fYXNuMSBpbXBvcnQgQ2VydGlmaWNhdGUgYXMgQXNuMUNlcnRpZmljYXRlCmZyb20gLi5fZXJyb3JzIGltcG9ydCBwcmV0dHlfbWVzc2FnZQpmcm9tIC4uX2ZmaSBpbXBvcnQgbnVsbCwgYnl0ZXNfZnJvbV9idWZmZXIsIGJ1ZmZlcl9mcm9tX2J5dGVzLCBpc19udWxsLCBidWZmZXJfcG9pbnRlcgpmcm9tIC4uX3R5cGVzIGltcG9ydCB0eXBlX25hbWUsIHN0cl9jbHMsIGJ5dGVfY2xzLCBpbnRfdHlwZXMKZnJvbSAuLmVycm9ycyBpbXBvcnQgVExTRXJyb3IsIFRMU0Rpc2Nvbm5lY3RFcnJvciwgVExTR3JhY2VmdWxEaXNjb25uZWN0RXJyb3IKZnJvbSAuLl90bHMgaW1wb3J0ICgKICAgIGRldGVjdF9jbGllbnRfYXV0aF9yZXF1ZXN0LAogICAgZXh0cmFjdF9jaGFpbiwKICAgIGdldF9kaF9wYXJhbXNfbGVuZ3RoLAogICAgcGFyc2Vfc2Vzc2lvbl9pbmZvLAogICAgcmFpc2VfY2xpZW50X2F1dGgsCiAgICByYWlzZV9kaF9wYXJhbXMsCiAgICByYWlzZV9kaXNjb25uZWN0aW9uLAogICAgcmFpc2VfZXhwaXJlZF9ub3RfeWV0X3ZhbGlkLAogICAgcmFpc2VfaGFuZHNoYWtlLAogICAgcmFpc2VfaG9zdG5hbWUsCiAgICByYWlzZV9ub19pc3N1ZXIsCiAgICByYWlzZV9wcm90b2NvbF9lcnJvciwKICAgIHJhaXNlX3Byb3RvY29sX3ZlcnNpb24sCiAgICByYWlzZV9zZWxmX3NpZ25lZCwKICAgIHJhaXNlX3ZlcmlmaWNhdGlvbiwKICAgIHJhaXNlX3dlYWtfc2lnbmF0dXJlLAogICAgcGFyc2VfdGxzX3JlY29yZHMsCiAgICBwYXJzZV9oYW5kc2hha2VfbWVzc2FnZXMsCikKZnJvbSAuYXN5bW1ldHJpYyBpbXBvcnQgbG9hZF9jZXJ0aWZpY2F0ZSwgQ2VydGlmaWNhdGUKZnJvbSAuLmtleXMgaW1wb3J0IHBhcnNlX2NlcnRpZmljYXRlCmZyb20gLi50cnVzdF9saXN0IGltcG9ydCBnZXRfcGF0aAoKaWYgc3lzLnZlcnNpb25faW5mbyA8ICgzLCk6CiAgICByYW5nZSA9IHhyYW5nZSAgIyBub3FhCgppZiBzeXMudmVyc2lvbl9pbmZvIDwgKDMsIDcpOgogICAgUGF0dGVybiA9IHJlLl9wYXR0ZXJuX3R5cGUKZWxzZToKICAgIFBhdHRlcm4gPSByZS5QYXR0ZXJuCgoKX19hbGxfXyA9IFsKICAgICdUTFNTZXNzaW9uJywKICAgICdUTFNTb2NrZXQnLApdCgoKX3RydXN0X2xpc3RfcGF0aCA9IF9iYWNrZW5kX2NvbmZpZygpLmdldCgndHJ1c3RfbGlzdF9wYXRoJykKX2xpbmVfcmVnZXggPSByZS5jb21waWxlKGInKFxyXG58XHJ8XG4pJykKX1BST1RPQ09MX01BUCA9IHsKICAgICdTU0x2Mic6IExpYnNzbENvbnN0LlNTTF9PUF9OT19TU0x2MiwKICAgICdTU0x2Myc6IExpYnNzbENvbnN0LlNTTF9PUF9OT19TU0x2MywKICAgICdUTFN2MSc6IExpYnNzbENvbnN0LlNTTF9PUF9OT19UTFN2MSwKICAgICdUTFN2MS4xJzogTGlic3NsQ29uc3QuU1NMX09QX05PX1RMU3YxXzEsCiAgICAnVExTdjEuMic6IExpYnNzbENvbnN0LlNTTF9PUF9OT19UTFN2MV8yLAp9CgoKZGVmIF9ob21vZ2VuaXplX29wZW5zc2wzX2Vycm9yKGVycm9yX3R1cGxlKToKICAgICIiIgogICAgVGFrZXMgYSAzLWVsZW1lbnQgdHVwbGUgZnJvbSBwZWVrX29wZW5zc2xfZXJyb3IoKSBhbmQgbW9kaWZpZXMgaXQKICAgIHRvIGhhbmRsZSB0aGUgY2hhbmdlcyBpbiBPcGVuU1NMIDMuMC4gVGhhdCByZWxlYXNlIHJlbW92ZWQgdGhlCiAgICBjb25jZXB0IG9mIGFuIGVycm9yIGZ1bmN0aW9uLCBtZWFuaW5nIHRoZSBzZWNvbmQgaXRlbSBpbiB0aGUgdHVwbGUKICAgIHdpbGwgYWx3YXlzIGJlIDAuCgogICAgOnBhcmFtIGVycm9yX3R1cGxlOgogICAgICAgIEEgMy1lbGVtZW50IHR1cGxlIG9mIGludGVnZXJzCgogICAgOnJldHVybjoKICAgICAgICBBIDMtZWxlbWVudCB0dXBsZSBvZiBpbnRlZ2VycwogICAgIiIiCgogICAgaWYgbGliY3J5cHRvX3ZlcnNpb25faW5mbyA8ICgzLCk6CiAgICAgICAgcmV0dXJuIGVycm9yX3R1cGxlCiAgICByZXR1cm4gKGVycm9yX3R1cGxlWzBdLCAwLCBlcnJvcl90dXBsZVsyXSkKCgpjbGFzcyBUTFNTZXNzaW9uKG9iamVjdCk6CiAgICAiIiIKICAgIEEgVExTIHNlc3Npb24gb2JqZWN0IHRoYXQgbXVsdGlwbGUgVExTU29ja2V0IG9iamVjdHMgY2FuIHNoYXJlIGZvciB0aGUKICAgIHNha2Ugb2Ygc2Vzc2lvbiByZXVzZQogICAgIiIiCgogICAgX3Byb3RvY29scyA9IE5vbmUKICAgIF9jaXBoZXJzID0gTm9uZQogICAgX21hbnVhbF92YWxpZGF0aW9uID0gTm9uZQogICAgX2V4dHJhX3RydXN0X3Jvb3RzID0gTm9uZQogICAgX3NzbF9jdHggPSBOb25lCiAgICBfc3NsX3Nlc3Npb24gPSBOb25lCgogICAgZGVmIF9faW5pdF9fKHNlbGYsIHByb3RvY29sPU5vbmUsIG1hbnVhbF92YWxpZGF0aW9uPUZhbHNlLCBleHRyYV90cnVzdF9yb290cz1Ob25lKToKICAgICAgICAiIiIKICAgICAgICA6cGFyYW0gcHJvdG9jb2w6CiAgICAgICAgICAgIEEgdW5pY29kZSBzdHJpbmcgb3Igc2V0IG9mIHVuaWNvZGUgc3RyaW5ncyByZXByZXNlbnRpbmcgYWxsb3dhYmxlCiAgICAgICAgICAgIHByb3RvY29scyB0byBuZWdvdGlhdGUgd2l0aCB0aGUgc2VydmVyOgoKICAgICAgICAgICAgIC0gIlRMU3YxLjIiCiAgICAgICAgICAgICAtICJUTFN2MS4xIgogICAgICAgICAgICAgLSAiVExTdjEiCiAgICAgICAgICAgICAtICJTU0x2MyIKCiAgICAgICAgICAgIERlZmF1bHQgaXM6IHsiVExTdjEiLCAiVExTdjEuMSIsICJUTFN2MS4yIn0KCiAgICAgICAgOnBhcmFtIG1hbnVhbF92YWxpZGF0aW9uOgogICAgICAgICAgICBJZiBjZXJ0aWZpY2F0ZSBhbmQgY2VydGlmaWNhdGUgcGF0aCB2YWxpZGF0aW9uIHNob3VsZCBiZSBza2lwcGVkCiAgICAgICAgICAgIGFuZCBsZWZ0IHRvIHRoZSBkZXZlbG9wZXIgdG8gaW1wbGVtZW50CgogICAgICAgIDpwYXJhbSBleHRyYV90cnVzdF9yb290czoKICAgICAgICAgICAgQSBsaXN0IGNvbnRhaW5pbmcgb25lIG9yIG1vcmUgY2VydGlmaWNhdGVzIHRvIGJlIHRyZWF0ZWQgYXMgdHJ1c3QKICAgICAgICAgICAgcm9vdHMsIGluIG9uZSBvZiB0aGUgZm9sbG93aW5nIGZvcm1hdHM6CiAgICAgICAgICAgICAtIEEgYnl0ZSBzdHJpbmcgb2YgdGhlIERFUiBlbmNvZGVkIGNlcnRpZmljYXRlCiAgICAgICAgICAgICAtIEEgdW5pY29kZSBzdHJpbmcgb2YgdGhlIGNlcnRpZmljYXRlIGZpbGVuYW1lCiAgICAgICAgICAgICAtIEFuIGFzbjFjcnlwdG8ueDUwOS5DZXJ0aWZpY2F0ZSBvYmplY3QKICAgICAgICAgICAgIC0gQW4gb3NjcnlwdG8uYXN5bW1ldHJpYy5DZXJ0aWZpY2F0ZSBvYmplY3QKCiAgICAgICAgOnJhaXNlczoKICAgICAgICAgICAgVmFsdWVFcnJvciAtIHdoZW4gYW55IG9mIHRoZSBwYXJhbWV0ZXJzIGNvbnRhaW4gYW4gaW52YWxpZCB2YWx1ZQogICAgICAgICAgICBUeXBlRXJyb3IgLSB3aGVuIGFueSBvZiB0aGUgcGFyYW1ldGVycyBhcmUgb2YgdGhlIHdyb25nIHR5cGUKICAgICAgICAgICAgT1NFcnJvciAtIHdoZW4gYW4gZXJyb3IgaXMgcmV0dXJuZWQgYnkgdGhlIE9TIGNyeXB0byBsaWJyYXJ5CiAgICAgICAgIiIiCgogICAgICAgIGlmIG5vdCBpc2luc3RhbmNlKG1hbnVhbF92YWxpZGF0aW9uLCBib29sKToKICAgICAgICAgICAgcmFpc2UgVHlwZUVycm9yKHByZXR0eV9tZXNzYWdlKAogICAgICAgICAgICAgICAgJycnCiAgICAgICAgICAgICAgICBtYW51YWxfdmFsaWRhdGlvbiBtdXN0IGJlIGEgYm9vbGVhbiwgbm90ICVzCiAgICAgICAgICAgICAgICAnJycsCiAgICAgICAgICAgICAgICB0eXBlX25hbWUobWFudWFsX3ZhbGlkYXRpb24pCiAgICAgICAgICAgICkpCgogICAgICAgIHNlbGYuX21hbnVhbF92YWxpZGF0aW9uID0gbWFudWFsX3ZhbGlkYXRpb24KCiAgICAgICAgaWYgcHJvdG9jb2wgaXMgTm9uZToKICAgICAgICAgICAgcHJvdG9jb2wgPSBzZXQoWydUTFN2MScsICdUTFN2MS4xJywgJ1RMU3YxLjInXSkKCiAgICAgICAgaWYgaXNpbnN0YW5jZShwcm90b2NvbCwgc3RyX2Nscyk6CiAgICAgICAgICAgIHByb3RvY29sID0gc2V0KFtwcm90b2NvbF0pCiAgICAgICAgZWxpZiBub3QgaXNpbnN0YW5jZShwcm90b2NvbCwgc2V0KToKICAgICAgICAgICAgcmFpc2UgVHlwZUVycm9yKHByZXR0eV9tZXNzYWdlKAogICAgICAgICAgICAgICAgJycnCiAgICAgICAgICAgICAgICBwcm90b2NvbCBtdXN0IGJlIGEgdW5pY29kZSBzdHJpbmcgb3Igc2V0IG9mIHVuaWNvZGUgc3RyaW5ncywKICAgICAgICAgICAgICAgIG5vdCAlcwogICAgICAgICAgICAgICAgJycnLAogICAgICAgICAgICAgICAgdHlwZV9uYW1lKHByb3RvY29sKQogICAgICAgICAgICApKQoKICAgICAgICB2YWxpZF9wcm90b2NvbHMgPSBzZXQoWydTU0x2MycsICdUTFN2MScsICdUTFN2MS4xJywgJ1RMU3YxLjInXSkKICAgICAgICB1bnN1cHBvcnRlZF9wcm90b2NvbHMgPSBwcm90b2NvbCAtIHZhbGlkX3Byb3RvY29scwogICAgICAgIGlmIHVuc3VwcG9ydGVkX3Byb3RvY29sczoKICAgICAgICAgICAgcmFpc2UgVmFsdWVFcnJvcihwcmV0dHlfbWVzc2FnZSgKICAgICAgICAgICAgICAgICcnJwogICAgICAgICAgICAgICAgcHJvdG9jb2wgbXVzdCBjb250YWluIG9ubHkgdGhlIHVuaWNvZGUgc3RyaW5ncyAiU1NMdjMiLCAiVExTdjEiLAogICAgICAgICAgICAgICAgIlRMU3YxLjEiLCAiVExTdjEuMiIsIG5vdCAlcwogICAgICAgICAgICAgICAgJycnLAogICAgICAgICAgICAgICAgcmVwcih1bnN1cHBvcnRlZF9wcm90b2NvbHMpCiAgICAgICAgICAgICkpCgogICAgICAgIHNlbGYuX3Byb3RvY29scyA9IHByb3RvY29sCgogICAgICAgIHNlbGYuX2V4dHJhX3RydXN0X3Jvb3RzID0gW10KICAgICAgICBpZiBleHRyYV90cnVzdF9yb290czoKICAgICAgICAgICAgZm9yIGV4dHJhX3RydXN0X3Jvb3QgaW4gZXh0cmFfdHJ1c3Rfcm9vdHM6CiAgICAgICAgICAgICAgICBpZiBpc2luc3RhbmNlKGV4dHJhX3RydXN0X3Jvb3QsIENlcnRpZmljYXRlKToKICAgICAgICAgICAgICAgICAgICBleHRyYV90cnVzdF9yb290ID0gZXh0cmFfdHJ1c3Rfcm9vdC5hc24xCiAgICAgICAgICAgICAgICBlbGlmIGlzaW5zdGFuY2UoZXh0cmFfdHJ1c3Rfcm9vdCwgYnl0ZV9jbHMpOgogICAgICAgICAgICAgICAgICAgIGV4dHJhX3RydXN0X3Jvb3QgPSBwYXJzZV9jZXJ0aWZpY2F0ZShleHRyYV90cnVzdF9yb290KQogICAgICAgICAgICAgICAgZWxpZiBpc2luc3RhbmNlKGV4dHJhX3RydXN0X3Jvb3QsIHN0cl9jbHMpOgogICAgICAgICAgICAgICAgICAgIHdpdGggb3BlbihleHRyYV90cnVzdF9yb290LCAncmInKSBhcyBmOgogICAgICAgICAgICAgICAgICAgICAgICBleHRyYV90cnVzdF9yb290ID0gcGFyc2VfY2VydGlmaWNhdGUoZi5yZWFkKCkpCiAgICAgICAgICAgICAgICBlbGlmIG5vdCBpc2luc3RhbmNlKGV4dHJhX3RydXN0X3Jvb3QsIEFzbjFDZXJ0aWZpY2F0ZSk6CiAgICAgICAgICAgICAgICAgICAgcmFpc2UgVHlwZUVycm9yKHByZXR0eV9tZXNzYWdlKAogICAgICAgICAgICAgICAgICAgICAgICAnJycKICAgICAgICAgICAgICAgICAgICAgICAgZXh0cmFfdHJ1c3Rfcm9vdHMgbXVzdCBiZSBhIGxpc3Qgb2YgYnl0ZSBzdHJpbmdzLCB1bmljb2RlCiAgICAgICAgICAgICAgICAgICAgICAgIHN0cmluZ3MsIGFzbjFjcnlwdG8ueDUwOS5DZXJ0aWZpY2F0ZSBvYmplY3RzIG9yCiAgICAgICAgICAgICAgICAgICAgICAgIG9zY3J5cHRvLmFzeW1tZXRyaWMuQ2VydGlmaWNhdGUgb2JqZWN0cywgbm90ICVzCiAgICAgICAgICAgICAgICAgICAgICAgICcnJywKICAgICAgICAgICAgICAgICAgICAgICAgdHlwZV9uYW1lKGV4dHJhX3RydXN0X3Jvb3QpCiAgICAgICAgICAgICAgICAgICAgKSkKICAgICAgICAgICAgICAgIHNlbGYuX2V4dHJhX3RydXN0X3Jvb3RzLmFwcGVuZChleHRyYV90cnVzdF9yb290KQoKICAgICAgICBzc2xfY3R4ID0gTm9uZQogICAgICAgIHRyeToKICAgICAgICAgICAgaWYgbGliY3J5cHRvX3ZlcnNpb25faW5mbyA8ICgxLCAxKToKICAgICAgICAgICAgICAgIG1ldGhvZCA9IGxpYnNzbC5TU0x2MjNfbWV0aG9kKCkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIG1ldGhvZCA9IGxpYnNzbC5UTFNfbWV0aG9kKCkKICAgICAgICAgICAgc3NsX2N0eCA9IGxpYnNzbC5TU0xfQ1RYX25ldyhtZXRob2QpCiAgICAgICAgICAgIGlmIGlzX251bGwoc3NsX2N0eCk6CiAgICAgICAgICAgICAgICBoYW5kbGVfb3BlbnNzbF9lcnJvcigwKQogICAgICAgICAgICBzZWxmLl9zc2xfY3R4ID0gc3NsX2N0eAoKICAgICAgICAgICAgbGlic3NsLlNTTF9DVFhfc2V0X3RpbWVvdXQoc3NsX2N0eCwgNjAwKQoKICAgICAgICAgICAgIyBBbGxvdyBjYWNoaW5nIFNTTCBzZXNzaW9ucwogICAgICAgICAgICBsaWJzc2wuU1NMX0NUWF9jdHJsKAogICAgICAgICAgICAgICAgc3NsX2N0eCwKICAgICAgICAgICAgICAgIExpYnNzbENvbnN0LlNTTF9DVFJMX1NFVF9TRVNTX0NBQ0hFX01PREUsCiAgICAgICAgICAgICAgICBMaWJzc2xDb25zdC5TU0xfU0VTU19DQUNIRV9DTElFTlQsCiAgICAgICAgICAgICAgICBudWxsKCkKICAgICAgICAgICAgKQoKICAgICAgICAgICAgaWYgc3lzLnBsYXRmb3JtIGluIHNldChbJ3dpbjMyJywgJ2RhcndpbiddKToKICAgICAgICAgICAgICAgIHRydXN0X2xpc3RfcGF0aCA9IF90cnVzdF9saXN0X3BhdGgKICAgICAgICAgICAgICAgIGlmIHRydXN0X2xpc3RfcGF0aCBpcyBOb25lOgogICAgICAgICAgICAgICAgICAgIHRydXN0X2xpc3RfcGF0aCA9IGdldF9wYXRoKCkKCiAgICAgICAgICAgICAgICBpZiBzeXMucGxhdGZvcm0gPT0gJ3dpbjMyJzoKICAgICAgICAgICAgICAgICAgICBwYXRoX2VuY29kaW5nID0gJ21iY3MnCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIHBhdGhfZW5jb2RpbmcgPSAndXRmLTgnCiAgICAgICAgICAgICAgICByZXN1bHQgPSBsaWJzc2wuU1NMX0NUWF9sb2FkX3ZlcmlmeV9sb2NhdGlvbnMoCiAgICAgICAgICAgICAgICAgICAgc3NsX2N0eCwKICAgICAgICAgICAgICAgICAgICB0cnVzdF9saXN0X3BhdGguZW5jb2RlKHBhdGhfZW5jb2RpbmcpLAogICAgICAgICAgICAgICAgICAgIG51bGwoKQogICAgICAgICAgICAgICAgKQoKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHJlc3VsdCA9IGxpYnNzbC5TU0xfQ1RYX3NldF9kZWZhdWx0X3ZlcmlmeV9wYXRocyhzc2xfY3R4KQogICAgICAgICAgICBoYW5kbGVfb3BlbnNzbF9lcnJvcihyZXN1bHQpCgogICAgICAgICAgICB2ZXJpZnlfbW9kZSA9IExpYnNzbENvbnN0LlNTTF9WRVJJRllfTk9ORSBpZiBtYW51YWxfdmFsaWRhdGlvbiBlbHNlIExpYnNzbENvbnN0LlNTTF9WRVJJRllfUEVFUgogICAgICAgICAgICBsaWJzc2wuU1NMX0NUWF9zZXRfdmVyaWZ5KHNzbF9jdHgsIHZlcmlmeV9tb2RlLCBudWxsKCkpCgogICAgICAgICAgICAjIE1vZGVybiBjaXBoZXIgc3VpdGUgbGlzdCBmcm9tIGh0dHBzOi8vd2lraS5tb3ppbGxhLm9yZy9TZWN1cml0eS9TZXJ2ZXJfU2lkZV9UTFMgbGF0ZSBBdWd1c3QgMjAxNQogICAgICAgICAgICByZXN1bHQgPSBsaWJzc2wuU1NMX0NUWF9zZXRfY2lwaGVyX2xpc3QoCiAgICAgICAgICAgICAgICBzc2xfY3R4LAogICAgICAgICAgICAgICAgKAogICAgICAgICAgICAgICAgICAgIGInRUNESEUtUlNBLUFFUzEyOC1HQ00tU0hBMjU2OkVDREhFLUVDRFNBLUFFUzEyOC1HQ00tU0hBMjU2OicKICAgICAgICAgICAgICAgICAgICBiJ0VDREhFLVJTQS1BRVMyNTYtR0NNLVNIQTM4NDpFQ0RIRS1FQ0RTQS1BRVMyNTYtR0NNLVNIQTM4NDonCiAgICAgICAgICAgICAgICAgICAgYidESEUtUlNBLUFFUzEyOC1HQ00tU0hBMjU2OkRIRS1EU1MtQUVTMTI4LUdDTS1TSEEyNTY6JwogICAgICAgICAgICAgICAgICAgIGIna0VESCtBRVNHQ006RUNESEUtUlNBLUFFUzEyOC1TSEEyNTY6RUNESEUtRUNEU0EtQUVTMTI4LVNIQTI1NjonCiAgICAgICAgICAgICAgICAgICAgYidFQ0RIRS1SU0EtQUVTMTI4LVNIQTpFQ0RIRS1FQ0RTQS1BRVMxMjgtU0hBOkVDREhFLVJTQS1BRVMyNTYtU0hBMzg0OicKICAgICAgICAgICAgICAgICAgICBiJ0VDREhFLUVDRFNBLUFFUzI1Ni1TSEEzODQ6RUNESEUtUlNBLUFFUzI1Ni1TSEE6RUNESEUtRUNEU0EtQUVTMjU2LVNIQTonCiAgICAgICAgICAgICAgICAgICAgYidESEUtUlNBLUFFUzEyOC1TSEEyNTY6REhFLVJTQS1BRVMxMjgtU0hBOkRIRS1EU1MtQUVTMTI4LVNIQTI1NjonCiAgICAgICAgICAgICAgICAgICAgYidESEUtUlNBLUFFUzI1Ni1TSEEyNTY6REhFLURTUy1BRVMyNTYtU0hBOkRIRS1SU0EtQUVTMjU2LVNIQTonCiAgICAgICAgICAgICAgICAgICAgYidBRVMxMjgtR0NNLVNIQTI1NjpBRVMyNTYtR0NNLVNIQTM4NDpBRVMxMjgtU0hBMjU2OkFFUzI1Ni1TSEEyNTY6JwogICAgICAgICAgICAgICAgICAgIGInQUVTMTI4LVNIQTpBRVMyNTYtU0hBOkFFUzpDQU1FTExJQTpERVMtQ0JDMy1TSEE6IWFOVUxMOiFlTlVMTDonCiAgICAgICAgICAgICAgICAgICAgYichRVhQT1JUOiFERVM6IVJDNDohTUQ1OiFQU0s6IWFFQ0RIOiFFREgtRFNTLURFUy1DQkMzLVNIQTonCiAgICAgICAgICAgICAgICAgICAgYichRURILVJTQS1ERVMtQ0JDMy1TSEE6IUtSQjUtREVTLUNCQzMtU0hBJwogICAgICAgICAgICAgICAgKQogICAgICAgICAgICApCiAgICAgICAgICAgIGhhbmRsZV9vcGVuc3NsX2Vycm9yKHJlc3VsdCkKCiAgICAgICAgICAgIGRpc2FibGVkX3Byb3RvY29scyA9IHNldChbJ1NTTHYyJ10pCiAgICAgICAgICAgIGRpc2FibGVkX3Byb3RvY29scyB8PSAodmFsaWRfcHJvdG9jb2xzIC0gc2VsZi5fcHJvdG9jb2xzKQogICAgICAgICAgICBmb3IgZGlzYWJsZWRfcHJvdG9jb2wgaW4gZGlzYWJsZWRfcHJvdG9jb2xzOgogICAgICAgICAgICAgICAgbGlic3NsLlNTTF9DVFhfY3RybCgKICAgICAgICAgICAgICAgICAgICBzc2xfY3R4LAogICAgICAgICAgICAgICAgICAgIExpYnNzbENvbnN0LlNTTF9DVFJMX09QVElPTlMsCiAgICAgICAgICAgICAgICAgICAgX1BST1RPQ09MX01BUFtkaXNhYmxlZF9wcm90b2NvbF0sCiAgICAgICAgICAgICAgICAgICAgbnVsbCgpCiAgICAgICAgICAgICAgICApCgogICAgICAgICAgICBpZiBzZWxmLl9leHRyYV90cnVzdF9yb290czoKICAgICAgICAgICAgICAgIHg1MDlfc3RvcmUgPSBsaWJzc2wuU1NMX0NUWF9nZXRfY2VydF9zdG9yZShzc2xfY3R4KQogICAgICAgICAgICAgICAgZm9yIGNlcnQgaW4gc2VsZi5fZXh0cmFfdHJ1c3Rfcm9vdHM6CiAgICAgICAgICAgICAgICAgICAgb3NjcnlwdG9fY2VydCA9IGxvYWRfY2VydGlmaWNhdGUoY2VydCkKICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSBsaWJzc2wuWDUwOV9TVE9SRV9hZGRfY2VydCgKICAgICAgICAgICAgICAgICAgICAgICAgeDUwOV9zdG9yZSwKICAgICAgICAgICAgICAgICAgICAgICAgb3NjcnlwdG9fY2VydC54NTA5CiAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICAgIGhhbmRsZV9vcGVuc3NsX2Vycm9yKHJlc3VsdCkKCiAgICAgICAgZXhjZXB0IChFeGNlcHRpb24pOgogICAgICAgICAgICBpZiBzc2xfY3R4OgogICAgICAgICAgICAgICAgbGlic3NsLlNTTF9DVFhfZnJlZShzc2xfY3R4KQogICAgICAgICAgICBzZWxmLl9zc2xfY3R4ID0gTm9uZQogICAgICAgICAgICByYWlzZQoKICAgIGRlZiBfX2RlbF9fKHNlbGYpOgogICAgICAgIGlmIHNlbGYuX3NzbF9jdHg6CiAgICAgICAgICAgIGxpYnNzbC5TU0xfQ1RYX2ZyZWUoc2VsZi5fc3NsX2N0eCkKICAgICAgICAgICAgc2VsZi5fc3NsX2N0eCA9IE5vbmUKCiAgICAgICAgaWYgc2VsZi5fc3NsX3Nlc3Npb246CiAgICAgICAgICAgIGxpYnNzbC5TU0xfU0VTU0lPTl9mcmVlKHNlbGYuX3NzbF9zZXNzaW9uKQogICAgICAgICAgICBzZWxmLl9zc2xfc2Vzc2lvbiA9IE5vbmUKCgpjbGFzcyBUTFNTb2NrZXQob2JqZWN0KToKICAgICIiIgogICAgQSB3cmFwcGVyIGFyb3VuZCBhIHNvY2tldC5zb2NrZXQgdGhhdCBhZGRzIFRMUwogICAgIiIiCgogICAgX3NvY2tldCA9IE5vbmUKCiAgICAjIEFuIG9zY3J5cHRvLnRscy5UTFNTZXNzaW9uIG9iamVjdAogICAgX3Nlc3Npb24gPSBOb25lCgogICAgIyBBbiBPcGVuU1NMIFNTTCBzdHJ1Y3QgcG9pbnRlcgogICAgX3NzbCA9IE5vbmUKCiAgICAjIE9wZW5TU0wgbWVtb3J5IGJpb3MgdXNlZCBmb3IgcmVhZGluZy93cml0aW5nIGRhdGEgdG8gYW5kCiAgICAjIGZyb20gdGhlIHNvY2tldAogICAgX3JiaW8gPSBOb25lCiAgICBfd2JpbyA9IE5vbmUKCiAgICAjIFNpemUgb2YgX2Jpb193cml0ZV9idWZmZXIgYW5kIF9yZWFkX2J1ZmZlcgogICAgX2J1ZmZlcl9zaXplID0gODE5MgoKICAgICMgQSBidWZmZXIgdXNlZCB0byBwdWxsIGJ5dGVzIG91dCBvZiB0aGUgX3diaW8gbWVtb3J5IGJpbyB0bwogICAgIyBiZSB3cml0dGVuIHRvIHRoZSBzb2NrZXQKICAgIF9iaW9fd3JpdGVfYnVmZmVyID0gTm9uZQoKICAgICMgQSBidWZmZXIgdXNlZCB0byBwdXNoIGJ5dGVzIGludG8gdGhlIF9yYmlvIG1lbW9yeSBiaW8gdG8KICAgICMgYmUgZGVjcnlwdGVkIGJ5IE9wZW5TU0wKICAgIF9yZWFkX2J1ZmZlciA9IE5vbmUKCiAgICAjIFJhdyBjaXBoZXJ0ZXh0IGZyb20gdGhlIHNvY2tlciB0aGF0IGhhc24ndCBuZWVkIGZlZCB0byBPcGVuU1NMIHlldAogICAgX3Jhd19ieXRlcyA9IE5vbmUKCiAgICAjIFBsYWludGV4dCB0aGF0IGhhcyBiZWVuIGRlY3J5cHRlZCwgYnV0IG5vdCBhc2tlZCBmb3IgeWV0CiAgICBfZGVjcnlwdGVkX2J5dGVzID0gTm9uZQoKICAgIF9ob3N0bmFtZSA9IE5vbmUKCiAgICBfY2VydGlmaWNhdGUgPSBOb25lCiAgICBfaW50ZXJtZWRpYXRlcyA9IE5vbmUKCiAgICBfcHJvdG9jb2wgPSBOb25lCiAgICBfY2lwaGVyX3N1aXRlID0gTm9uZQogICAgX2NvbXByZXNzaW9uID0gTm9uZQogICAgX3Nlc3Npb25faWQgPSBOb25lCiAgICBfc2Vzc2lvbl90aWNrZXQgPSBOb25lCgogICAgIyBJZiB3ZSBleHBsaWNpdGx5IGFza2VkIGZvciB0aGUgY29ubmVjdGlvbiB0byBiZSBjbG9zZWQKICAgIF9sb2NhbF9jbG9zZWQgPSBGYWxzZQoKICAgIF9ncmFjZWZ1bGx5X2Nsb3NlZCA9IEZhbHNlCgogICAgQGNsYXNzbWV0aG9kCiAgICBkZWYgd3JhcChjbHMsIHNvY2tldCwgaG9zdG5hbWUsIHNlc3Npb249Tm9uZSk6CiAgICAgICAgIiIiCiAgICAgICAgVGFrZXMgYW4gZXhpc3Rpbmcgc29ja2V0IGFuZCBhZGRzIFRMUwoKICAgICAgICA6cGFyYW0gc29ja2V0OgogICAgICAgICAgICBBIHNvY2tldC5zb2NrZXQgb2JqZWN0IHRvIHdyYXAgd2l0aCBUTFMKCiAgICAgICAgOnBhcmFtIGhvc3RuYW1lOgogICAgICAgICAgICBBIHVuaWNvZGUgc3RyaW5nIG9mIHRoZSBob3N0bmFtZSBvciBJUCB0aGUgc29ja2V0IGlzIGNvbm5lY3RlZCB0bwoKICAgICAgICA6cGFyYW0gc2Vzc2lvbjoKICAgICAgICAgICAgQW4gZXhpc3RpbmcgVExTU2Vzc2lvbiBvYmplY3QgdG8gYWxsb3cgZm9yIHNlc3Npb24gcmV1c2UsIHNwZWNpZmljCiAgICAgICAgICAgIHByb3RvY29sIG9yIG1hbnVhbCBjZXJ0aWZpY2F0ZSB2YWxpZGF0aW9uCgogICAgICAgIDpyYWlzZXM6CiAgICAgICAgICAgIFZhbHVlRXJyb3IgLSB3aGVuIGFueSBvZiB0aGUgcGFyYW1ldGVycyBjb250YWluIGFuIGludmFsaWQgdmFsdWUKICAgICAgICAgICAgVHlwZUVycm9yIC0gd2hlbiBhbnkgb2YgdGhlIHBhcmFtZXRlcnMgYXJlIG9mIHRoZSB3cm9uZyB0eXBlCiAgICAgICAgICAgIE9TRXJyb3IgLSB3aGVuIGFuIGVycm9yIGlzIHJldHVybmVkIGJ5IHRoZSBPUyBjcnlwdG8gbGlicmFyeQogICAgICAgICIiIgoKICAgICAgICBpZiBub3QgaXNpbnN0YW5jZShzb2NrZXQsIHNvY2tldF8uc29ja2V0KToKICAgICAgICAgICAgcmFpc2UgVHlwZUVycm9yKHByZXR0eV9tZXNzYWdlKAogICAgICAgICAgICAgICAgJycnCiAgICAgICAgICAgICAgICBzb2NrZXQgbXVzdCBiZSBhbiBpbnN0YW5jZSBvZiBzb2NrZXQuc29ja2V0LCBub3QgJXMKICAgICAgICAgICAgICAgICcnJywKICAgICAgICAgICAgICAgIHR5cGVfbmFtZShzb2NrZXQpCiAgICAgICAgICAgICkpCgogICAgICAgIGlmIG5vdCBpc2luc3RhbmNlKGhvc3RuYW1lLCBzdHJfY2xzKToKICAgICAgICAgICAgcmFpc2UgVHlwZUVycm9yKHByZXR0eV9tZXNzYWdlKAogICAgICAgICAgICAgICAgJycnCiAgICAgICAgICAgICAgICBob3N0bmFtZSBtdXN0IGJlIGEgdW5pY29kZSBzdHJpbmcsIG5vdCAlcwogICAgICAgICAgICAgICAgJycnLAogICAgICAgICAgICAgICAgdHlwZV9uYW1lKGhvc3RuYW1lKQogICAgICAgICAgICApKQoKICAgICAgICBpZiBzZXNzaW9uIGlzIG5vdCBOb25lIGFuZCBub3QgaXNpbnN0YW5jZShzZXNzaW9uLCBUTFNTZXNzaW9uKToKICAgICAgICAgICAgcmFpc2UgVHlwZUVycm9yKHByZXR0eV9tZXNzYWdlKAogICAgICAgICAgICAgICAgJycnCiAgICAgICAgICAgICAgICBzZXNzaW9uIG11c3QgYmUgYW4gaW5zdGFuY2Ugb2Ygb3NjcnlwdG8udGxzLlRMU1Nlc3Npb24sIG5vdCAlcwogICAgICAgICAgICAgICAgJycnLAogICAgICAgICAgICAgICAgdHlwZV9uYW1lKHNlc3Npb24pCiAgICAgICAgICAgICkpCgogICAgICAgIG5ld19zb2NrZXQgPSBjbHMoTm9uZSwgTm9uZSwgc2Vzc2lvbj1zZXNzaW9uKQogICAgICAgIG5ld19zb2NrZXQuX3NvY2tldCA9IHNvY2tldAogICAgICAgIG5ld19zb2NrZXQuX2hvc3RuYW1lID0gaG9zdG5hbWUKICAgICAgICBuZXdfc29ja2V0Ll9oYW5kc2hha2UoKQoKICAgICAgICByZXR1cm4gbmV3X3NvY2tldAoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBhZGRyZXNzLCBwb3J0LCB0aW1lb3V0PTEwLCBzZXNzaW9uPU5vbmUpOgogICAgICAgICIiIgogICAgICAgIDpwYXJhbSBhZGRyZXNzOgogICAgICAgICAgICBBIHVuaWNvZGUgc3RyaW5nIG9mIHRoZSBkb21haW4gbmFtZSBvciBJUCBhZGRyZXNzIHRvIGNvbm5lY3QgdG8KCiAgICAgICAgOnBhcmFtIHBvcnQ6CiAgICAgICAgICAgIEFuIGludGVnZXIgb2YgdGhlIHBvcnQgbnVtYmVyIHRvIGNvbm5lY3QgdG8KCiAgICAgICAgOnBhcmFtIHRpbWVvdXQ6CiAgICAgICAgICAgIEFuIGludGVnZXIgdGltZW91dCB0byB1c2UgZm9yIHRoZSBzb2NrZXQKCiAgICAgICAgOnBhcmFtIHNlc3Npb246CiAgICAgICAgICAgIEFuIG9zY3J5cHRvLnRscy5UTFNTZXNzaW9uIG9iamVjdCB0byBhbGxvdyBmb3Igc2Vzc2lvbiByZXVzZSBhbmQKICAgICAgICAgICAgY29udHJvbGxpbmcgdGhlIHByb3RvY29scyBhbmQgdmFsaWRhdGlvbiBwZXJmb3JtZWQKICAgICAgICAiIiIKCiAgICAgICAgc2VsZi5fcmF3X2J5dGVzID0gYicnCiAgICAgICAgc2VsZi5fZGVjcnlwdGVkX2J5dGVzID0gYicnCgogICAgICAgIGlmIGFkZHJlc3MgaXMgTm9uZSBhbmQgcG9ydCBpcyBOb25lOgogICAgICAgICAgICBzZWxmLl9zb2NrZXQgPSBOb25lCgogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGlmIG5vdCBpc2luc3RhbmNlKGFkZHJlc3MsIHN0cl9jbHMpOgogICAgICAgICAgICAgICAgcmFpc2UgVHlwZUVycm9yKHByZXR0eV9tZXNzYWdlKAogICAgICAgICAgICAgICAgICAgICcnJwogICAgICAgICAgICAgICAgICAgIGFkZHJlc3MgbXVzdCBiZSBhIHVuaWNvZGUgc3RyaW5nLCBub3QgJXMKICAgICAgICAgICAgICAgICAgICAnJycsCiAgICAgICAgICAgICAgICAgICAgdHlwZV9uYW1lKGFkZHJlc3MpCiAgICAgICAgICAgICAgICApKQoKICAgICAgICAgICAgaWYgbm90IGlzaW5zdGFuY2UocG9ydCwgaW50X3R5cGVzKToKICAgICAgICAgICAgICAgIHJhaXNlIFR5cGVFcnJvcihwcmV0dHlfbWVzc2FnZSgKICAgICAgICAgICAgICAgICAgICAnJycKICAgICAgICAgICAgICAgICAgICBwb3J0IG11c3QgYmUgYW4gaW50ZWdlciwgbm90ICVzCiAgICAgICAgICAgICAgICAgICAgJycnLAogICAgICAgICAgICAgICAgICAgIHR5cGVfbmFtZShwb3J0KQogICAgICAgICAgICAgICAgKSkKCiAgICAgICAgICAgIGlmIHRpbWVvdXQgaXMgbm90IE5vbmUgYW5kIG5vdCBpc2luc3RhbmNlKHRpbWVvdXQsIG51bWJlcnMuTnVtYmVyKToKICAgICAgICAgICAgICAgIHJhaXNlIFR5cGVFcnJvcihwcmV0dHlfbWVzc2FnZSgKICAgICAgICAgICAgICAgICAgICAnJycKICAgICAgICAgICAgICAgICAgICB0aW1lb3V0IG11c3QgYmUgYSBudW1iZXIsIG5vdCAlcwogICAgICAgICAgICAgICAgICAgICcnJywKICAgICAgICAgICAgICAgICAgICB0eXBlX25hbWUodGltZW91dCkKICAgICAgICAgICAgICAgICkpCgogICAgICAgICAgICBzZWxmLl9zb2NrZXQgPSBzb2NrZXRfLmNyZWF0ZV9jb25uZWN0aW9uKChhZGRyZXNzLCBwb3J0KSwgdGltZW91dCkKICAgICAgICAgICAgc2VsZi5fc29ja2V0LnNldHRpbWVvdXQodGltZW91dCkKCiAgICAgICAgaWYgc2Vzc2lvbiBpcyBOb25lOgogICAgICAgICAgICBzZXNzaW9uID0gVExTU2Vzc2lvbigpCgogICAgICAgIGVsaWYgbm90IGlzaW5zdGFuY2Uoc2Vzc2lvbiwgVExTU2Vzc2lvbik6CiAgICAgICAgICAgIHJhaXNlIFR5cGVFcnJvcihwcmV0dHlfbWVzc2FnZSgKICAgICAgICAgICAgICAgICcnJwogICAgICAgICAgICAgICAgc2Vzc2lvbiBtdXN0IGJlIGFuIGluc3RhbmNlIG9mIG9zY3J5cHRvLnRscy5UTFNTZXNzaW9uLCBub3QgJXMKICAgICAgICAgICAgICAgICcnJywKICAgICAgICAgICAgICAgIHR5cGVfbmFtZShzZXNzaW9uKQogICAgICAgICAgICApKQoKICAgICAgICBzZWxmLl9zZXNzaW9uID0gc2Vzc2lvbgoKICAgICAgICBpZiBzZWxmLl9zb2NrZXQ6CiAgICAgICAgICAgIHNlbGYuX2hvc3RuYW1lID0gYWRkcmVzcwogICAgICAgICAgICBzZWxmLl9oYW5kc2hha2UoKQoKICAgIGRlZiBfaGFuZHNoYWtlKHNlbGYpOgogICAgICAgICIiIgogICAgICAgIFBlcmZvcm0gYW4gaW5pdGlhbCBUTFMgaGFuZHNoYWtlCiAgICAgICAgIiIiCgogICAgICAgIHNlbGYuX3NzbCA9IE5vbmUKICAgICAgICBzZWxmLl9yYmlvID0gTm9uZQogICAgICAgIHNlbGYuX3diaW8gPSBOb25lCgogICAgICAgIHRyeToKICAgICAgICAgICAgc2VsZi5fc3NsID0gbGlic3NsLlNTTF9uZXcoc2VsZi5fc2Vzc2lvbi5fc3NsX2N0eCkKICAgICAgICAgICAgaWYgaXNfbnVsbChzZWxmLl9zc2wpOgogICAgICAgICAgICAgICAgc2VsZi5fc3NsID0gTm9uZQogICAgICAgICAgICAgICAgaGFuZGxlX29wZW5zc2xfZXJyb3IoMCkKCiAgICAgICAgICAgIG1lbV9iaW8gPSBsaWJzc2wuQklPX3NfbWVtKCkKCiAgICAgICAgICAgIHNlbGYuX3JiaW8gPSBsaWJzc2wuQklPX25ldyhtZW1fYmlvKQogICAgICAgICAgICBpZiBpc19udWxsKHNlbGYuX3JiaW8pOgogICAgICAgICAgICAgICAgaGFuZGxlX29wZW5zc2xfZXJyb3IoMCkKCiAgICAgICAgICAgIHNlbGYuX3diaW8gPSBsaWJzc2wuQklPX25ldyhtZW1fYmlvKQogICAgICAgICAgICBpZiBpc19udWxsKHNlbGYuX3diaW8pOgogICAgICAgICAgICAgICAgaGFuZGxlX29wZW5zc2xfZXJyb3IoMCkKCiAgICAgICAgICAgIGxpYnNzbC5TU0xfc2V0X2JpbyhzZWxmLl9zc2wsIHNlbGYuX3JiaW8sIHNlbGYuX3diaW8pCgogICAgICAgICAgICB1dGY4X2RvbWFpbiA9IHNlbGYuX2hvc3RuYW1lLmVuY29kZSgndXRmLTgnKQogICAgICAgICAgICBsaWJzc2wuU1NMX2N0cmwoCiAgICAgICAgICAgICAgICBzZWxmLl9zc2wsCiAgICAgICAgICAgICAgICBMaWJzc2xDb25zdC5TU0xfQ1RSTF9TRVRfVExTRVhUX0hPU1ROQU1FLAogICAgICAgICAgICAgICAgTGlic3NsQ29uc3QuVExTRVhUX05BTUVUWVBFX2hvc3RfbmFtZSwKICAgICAgICAgICAgICAgIHV0ZjhfZG9tYWluCiAgICAgICAgICAgICkKCiAgICAgICAgICAgIGxpYnNzbC5TU0xfc2V0X2Nvbm5lY3Rfc3RhdGUoc2VsZi5fc3NsKQoKICAgICAgICAgICAgaWYgc2VsZi5fc2Vzc2lvbi5fc3NsX3Nlc3Npb246CiAgICAgICAgICAgICAgICBsaWJzc2wuU1NMX3NldF9zZXNzaW9uKHNlbGYuX3NzbCwgc2VsZi5fc2Vzc2lvbi5fc3NsX3Nlc3Npb24pCgogICAgICAgICAgICBzZWxmLl9iaW9fd3JpdGVfYnVmZmVyID0gYnVmZmVyX2Zyb21fYnl0ZXMoc2VsZi5fYnVmZmVyX3NpemUpCiAgICAgICAgICAgIHNlbGYuX3JlYWRfYnVmZmVyID0gYnVmZmVyX2Zyb21fYnl0ZXMoc2VsZi5fYnVmZmVyX3NpemUpCgogICAgICAgICAgICBoYW5kc2hha2Vfc2VydmVyX2J5dGVzID0gYicnCiAgICAgICAgICAgIGhhbmRzaGFrZV9jbGllbnRfYnl0ZXMgPSBiJycKCiAgICAgICAgICAgIHdoaWxlIFRydWU6CiAgICAgICAgICAgICAgICByZXN1bHQgPSBsaWJzc2wuU1NMX2RvX2hhbmRzaGFrZShzZWxmLl9zc2wpCiAgICAgICAgICAgICAgICBoYW5kc2hha2VfY2xpZW50X2J5dGVzICs9IHNlbGYuX3Jhd193cml0ZSgpCgogICAgICAgICAgICAgICAgaWYgcmVzdWx0ID09IDE6CiAgICAgICAgICAgICAgICAgICAgYnJlYWsKCiAgICAgICAgICAgICAgICBlcnJvciA9IGxpYnNzbC5TU0xfZ2V0X2Vycm9yKHNlbGYuX3NzbCwgcmVzdWx0KQogICAgICAgICAgICAgICAgaWYgZXJyb3IgPT0gTGlic3NsQ29uc3QuU1NMX0VSUk9SX1dBTlRfUkVBRDoKICAgICAgICAgICAgICAgICAgICBjaHVuayA9IHNlbGYuX3Jhd19yZWFkKCkKICAgICAgICAgICAgICAgICAgICBpZiBjaHVuayA9PSBiJyc6CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIGhhbmRzaGFrZV9zZXJ2ZXJfYnl0ZXMgPT0gYicnOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmFpc2VfZGlzY29ubmVjdGlvbigpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIGRldGVjdF9jbGllbnRfYXV0aF9yZXF1ZXN0KGhhbmRzaGFrZV9zZXJ2ZXJfYnl0ZXMpOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmFpc2VfY2xpZW50X2F1dGgoKQogICAgICAgICAgICAgICAgICAgICAgICByYWlzZV9wcm90b2NvbF9lcnJvcihoYW5kc2hha2Vfc2VydmVyX2J5dGVzKQogICAgICAgICAgICAgICAgICAgIGhhbmRzaGFrZV9zZXJ2ZXJfYnl0ZXMgKz0gY2h1bmsKCiAgICAgICAgICAgICAgICBlbGlmIGVycm9yID09IExpYnNzbENvbnN0LlNTTF9FUlJPUl9XQU5UX1dSSVRFOgogICAgICAgICAgICAgICAgICAgIGhhbmRzaGFrZV9jbGllbnRfYnl0ZXMgKz0gc2VsZi5fcmF3X3dyaXRlKCkKCiAgICAgICAgICAgICAgICBlbGlmIGVycm9yID09IExpYnNzbENvbnN0LlNTTF9FUlJPUl9aRVJPX1JFVFVSTjoKICAgICAgICAgICAgICAgICAgICBzZWxmLl9ncmFjZWZ1bGx5X2Nsb3NlZCA9IFRydWUKICAgICAgICAgICAgICAgICAgICBzZWxmLl9zaHV0ZG93bihGYWxzZSkKICAgICAgICAgICAgICAgICAgICBzZWxmLl9yYWlzZV9jbG9zZWQoKQoKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgaW5mbyA9IHBlZWtfb3BlbnNzbF9lcnJvcigpCgogICAgICAgICAgICAgICAgICAgIGRoX2tleV9pbmZvXzEgPSAoCiAgICAgICAgICAgICAgICAgICAgICAgIExpYnNzbENvbnN0LkVSUl9MSUJfU1NMLAogICAgICAgICAgICAgICAgICAgICAgICBMaWJzc2xDb25zdC5TU0xfRl9TU0wzX0NIRUNLX0NFUlRfQU5EX0FMR09SSVRITSwKICAgICAgICAgICAgICAgICAgICAgICAgTGlic3NsQ29uc3QuU1NMX1JfREhfS0VZX1RPT19TTUFMTAogICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICBkaF9rZXlfaW5mb18xID0gX2hvbW9nZW5pemVfb3BlbnNzbDNfZXJyb3IoZGhfa2V5X2luZm9fMSkKCiAgICAgICAgICAgICAgICAgICAgZGhfa2V5X2luZm9fMiA9ICgKICAgICAgICAgICAgICAgICAgICAgICAgTGlic3NsQ29uc3QuRVJSX0xJQl9TU0wsCiAgICAgICAgICAgICAgICAgICAgICAgIExpYnNzbENvbnN0LlNTTF9GX1RMU19QUk9DRVNTX1NLRV9ESEUsCiAgICAgICAgICAgICAgICAgICAgICAgIExpYnNzbENvbnN0LlNTTF9SX0RIX0tFWV9UT09fU01BTEwKICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICAgICAgZGhfa2V5X2luZm9fMiA9IF9ob21vZ2VuaXplX29wZW5zc2wzX2Vycm9yKGRoX2tleV9pbmZvXzIpCgogICAgICAgICAgICAgICAgICAgIGRoX2tleV9pbmZvXzMgPSAoCiAgICAgICAgICAgICAgICAgICAgICAgIExpYnNzbENvbnN0LkVSUl9MSUJfU1NMLAogICAgICAgICAgICAgICAgICAgICAgICBMaWJzc2xDb25zdC5TU0xfRl9TU0wzX0dFVF9LRVlfRVhDSEFOR0UsCiAgICAgICAgICAgICAgICAgICAgICAgIExpYnNzbENvbnN0LlNTTF9SX0JBRF9ESF9QX0xFTkdUSAogICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICBkaF9rZXlfaW5mb18zID0gX2hvbW9nZW5pemVfb3BlbnNzbDNfZXJyb3IoZGhfa2V5X2luZm9fMykKCiAgICAgICAgICAgICAgICAgICAgaWYgaW5mbyA9PSBkaF9rZXlfaW5mb18xIG9yIGluZm8gPT0gZGhfa2V5X2luZm9fMiBvciBpbmZvID09IGRoX2tleV9pbmZvXzM6CiAgICAgICAgICAgICAgICAgICAgICAgIHJhaXNlX2RoX3BhcmFtcygpCgogICAgICAgICAgICAgICAgICAgIGlmIGVycm9yX2NvZGVfdmVyc2lvbl9pbmZvIDwgKDEsIDEpOgogICAgICAgICAgICAgICAgICAgICAgICB1bmtub3duX3Byb3RvY29sX2luZm8gPSAoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBMaWJzc2xDb25zdC5FUlJfTElCX1NTTCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIExpYnNzbENvbnN0LlNTTF9GX1NTTDIzX0dFVF9TRVJWRVJfSEVMTE8sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBMaWJzc2xDb25zdC5TU0xfUl9VTktOT1dOX1BST1RPQ09MCiAgICAgICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICB1bmtub3duX3Byb3RvY29sX2luZm8gPSAoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBMaWJzc2xDb25zdC5FUlJfTElCX1NTTCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIExpYnNzbENvbnN0LlNTTF9GX1NTTDNfR0VUX1JFQ09SRCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIExpYnNzbENvbnN0LlNTTF9SX1dST05HX1ZFUlNJT05fTlVNQkVSCiAgICAgICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICAgICAgdW5rbm93bl9wcm90b2NvbF9pbmZvID0gX2hvbW9nZW5pemVfb3BlbnNzbDNfZXJyb3IodW5rbm93bl9wcm90b2NvbF9pbmZvKQoKICAgICAgICAgICAgICAgICAgICBpZiBpbmZvID09IHVua25vd25fcHJvdG9jb2xfaW5mbzoKICAgICAgICAgICAgICAgICAgICAgICAgcmFpc2VfcHJvdG9jb2xfZXJyb3IoaGFuZHNoYWtlX3NlcnZlcl9ieXRlcykKCiAgICAgICAgICAgICAgICAgICAgdGxzX3ZlcnNpb25faW5mb19lcnJvciA9ICgKICAgICAgICAgICAgICAgICAgICAgICAgTGlic3NsQ29uc3QuRVJSX0xJQl9TU0wsCiAgICAgICAgICAgICAgICAgICAgICAgIExpYnNzbENvbnN0LlNTTF9GX1NTTDIzX0dFVF9TRVJWRVJfSEVMTE8sCiAgICAgICAgICAgICAgICAgICAgICAgIExpYnNzbENvbnN0LlNTTF9SX1RMU1YxX0FMRVJUX1BST1RPQ09MX1ZFUlNJT04KICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICAgICAgdGxzX3ZlcnNpb25faW5mb19lcnJvciA9IF9ob21vZ2VuaXplX29wZW5zc2wzX2Vycm9yKHRsc192ZXJzaW9uX2luZm9fZXJyb3IpCiAgICAgICAgICAgICAgICAgICAgaWYgaW5mbyA9PSB0bHNfdmVyc2lvbl9pbmZvX2Vycm9yOgogICAgICAgICAgICAgICAgICAgICAgICByYWlzZV9wcm90b2NvbF92ZXJzaW9uKCkKCiAgICAgICAgICAgICAgICAgICAgIyBUaGVyZSBhcmUgbXVsdGlwbGUgZnVuY3Rpb25zIHRoYXQgY2FuIHJlc3VsdCBpbiBhIGhhbmRzaGFrZSBmYWlsdXJlLAogICAgICAgICAgICAgICAgICAgICMgYnV0IG91ciBjdXN0b20gaGFuZHNoYWtlIHBhcnNpbmcgY29kZSBmaWd1cmVzIG91dCB3aGF0IHJlYWxseSBoYXBwZW5lZCwKICAgICAgICAgICAgICAgICAgICAjIGFuZCB3aGF0IGlzIG1vcmUsIE9wZW5TU0wgMyBnb3QgcmlkIG9mIGZ1bmN0aW9uIGNvZGVzLiBCZWNhdXNlIG9mIHRoaXMsCiAgICAgICAgICAgICAgICAgICAgIyB3ZSBza2lwIGNoZWNraW5nIHRoZSBmdW5jdGlvbiBjb2RlLgogICAgICAgICAgICAgICAgICAgIGhhbmRzaGFrZV9lcnJvcl9pbmZvID0gKAogICAgICAgICAgICAgICAgICAgICAgICBMaWJzc2xDb25zdC5FUlJfTElCX1NTTCwKICAgICAgICAgICAgICAgICAgICAgICAgTGlic3NsQ29uc3QuU1NMX1JfU1NMVjNfQUxFUlRfSEFORFNIQUtFX0ZBSUxVUkUKICAgICAgICAgICAgICAgICAgICApCgogICAgICAgICAgICAgICAgICAgIGlmIChpbmZvWzBdLCBpbmZvWzJdKSA9PSBoYW5kc2hha2VfZXJyb3JfaW5mbzoKICAgICAgICAgICAgICAgICAgICAgICAgc2F3X2NsaWVudF9hdXRoID0gRmFsc2UKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIHJlY29yZF90eXBlLCBfLCByZWNvcmRfZGF0YSBpbiBwYXJzZV90bHNfcmVjb3JkcyhoYW5kc2hha2Vfc2VydmVyX2J5dGVzKToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIHJlY29yZF90eXBlICE9IGInXHgxNic6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciBtZXNzYWdlX3R5cGUsIG1lc3NhZ2VfZGF0YSBpbiBwYXJzZV9oYW5kc2hha2VfbWVzc2FnZXMocmVjb3JkX2RhdGEpOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIG1lc3NhZ2VfdHlwZSA9PSBiJ1x4MGQnOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzYXdfY2xpZW50X2F1dGggPSBUcnVlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHNhd19jbGllbnRfYXV0aDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhaXNlX2NsaWVudF9hdXRoKCkKICAgICAgICAgICAgICAgICAgICAgICAgcmFpc2VfaGFuZHNoYWtlKCkKCiAgICAgICAgICAgICAgICAgICAgaWYgZXJyb3JfY29kZV92ZXJzaW9uX2luZm8gPCAoMSwgMSk6CiAgICAgICAgICAgICAgICAgICAgICAgIGNlcnRfdmVyaWZ5X2ZhaWxlZF9pbmZvID0gKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgTGlic3NsQ29uc3QuRVJSX0xJQl9TU0wsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBMaWJzc2xDb25zdC5TU0xfRl9TU0wzX0dFVF9TRVJWRVJfQ0VSVElGSUNBVEUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBMaWJzc2xDb25zdC5TU0xfUl9DRVJUSUZJQ0FURV9WRVJJRllfRkFJTEVECiAgICAgICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICBjZXJ0X3ZlcmlmeV9mYWlsZWRfaW5mbyA9ICgKICAgICAgICAgICAgICAgICAgICAgICAgICAgIExpYnNzbENvbnN0LkVSUl9MSUJfU1NMLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgTGlic3NsQ29uc3QuU1NMX0ZfVExTX1BST0NFU1NfU0VSVkVSX0NFUlRJRklDQVRFLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgTGlic3NsQ29uc3QuU1NMX1JfQ0VSVElGSUNBVEVfVkVSSUZZX0ZBSUxFRAogICAgICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICAgICAgICAgIGNlcnRfdmVyaWZ5X2ZhaWxlZF9pbmZvID0gX2hvbW9nZW5pemVfb3BlbnNzbDNfZXJyb3IoY2VydF92ZXJpZnlfZmFpbGVkX2luZm8pCgogICAgICAgICAgICAgICAgICAgICMgSXQgd291bGQgYXBwZWFyIHRoYXQgc29tZSB2ZXJzaW9ucyBvZiBPcGVuU1NMIChzdWNoIGFzIG9uIEZlZG9yYSAzMCkKICAgICAgICAgICAgICAgICAgICAjIGRvbid0IGV2ZW4gaGF2ZSB0aGUgTUQ1IGRpZ2VzdCBhbGdvcml0aG0gaW5jbHVkZWQgYW55IGxvbmdlcj8gVG8KICAgICAgICAgICAgICAgICAgICAjIGdpdmUgYSBtb3JlIHVzZWZ1bCBlcnJvciBtZXNzYWdlIHdlIGhhbmRsZSB0aGlzIHNwZWNpZmljYWxseS4KICAgICAgICAgICAgICAgICAgICB1bmtub3duX2hhc2hfYWxnb19pbmZvID0gKAogICAgICAgICAgICAgICAgICAgICAgICBMaWJzc2xDb25zdC5FUlJfTElCX0FTTjEsCiAgICAgICAgICAgICAgICAgICAgICAgIExpYnNzbENvbnN0LkFTTjFfRl9BU04xX0lURU1fVkVSSUZZLAogICAgICAgICAgICAgICAgICAgICAgICBMaWJzc2xDb25zdC5BU04xX1JfVU5LTk9XTl9NRVNTQUdFX0RJR0VTVF9BTEdPUklUSE0KICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICAgICAgdW5rbm93bl9oYXNoX2FsZ29faW5mbyA9IF9ob21vZ2VuaXplX29wZW5zc2wzX2Vycm9yKHVua25vd25faGFzaF9hbGdvX2luZm8pCgogICAgICAgICAgICAgICAgICAgIGlmIGluZm8gPT0gdW5rbm93bl9oYXNoX2FsZ29faW5mbzoKICAgICAgICAgICAgICAgICAgICAgICAgY2hhaW4gPSBleHRyYWN0X2NoYWluKGhhbmRzaGFrZV9zZXJ2ZXJfYnl0ZXMpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIGNoYWluOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2VydCA9IGNoYWluWzBdCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvc2NyeXB0b19jZXJ0ID0gbG9hZF9jZXJ0aWZpY2F0ZShjZXJ0KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgb3NjcnlwdG9fY2VydC5hc24xLmhhc2hfYWxnbyBpbiBzZXQoWydtZDUnLCAnbWQyJ10pOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhaXNlX3dlYWtfc2lnbmF0dXJlKG9zY3J5cHRvX2NlcnQpCgogICAgICAgICAgICAgICAgICAgIGlmIGluZm8gPT0gY2VydF92ZXJpZnlfZmFpbGVkX2luZm86CiAgICAgICAgICAgICAgICAgICAgICAgIHZlcmlmeV9yZXN1bHQgPSBsaWJzc2wuU1NMX2dldF92ZXJpZnlfcmVzdWx0KHNlbGYuX3NzbCkKICAgICAgICAgICAgICAgICAgICAgICAgY2hhaW4gPSBleHRyYWN0X2NoYWluKGhhbmRzaGFrZV9zZXJ2ZXJfYnl0ZXMpCgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmX3NpZ25lZCA9IEZhbHNlCiAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVfaW52YWxpZCA9IEZhbHNlCiAgICAgICAgICAgICAgICAgICAgICAgIG5vX2lzc3VlciA9IEZhbHNlCiAgICAgICAgICAgICAgICAgICAgICAgIGNlcnQgPSBOb25lCiAgICAgICAgICAgICAgICAgICAgICAgIG9zY3J5cHRvX2NlcnQgPSBOb25lCgogICAgICAgICAgICAgICAgICAgICAgICBpZiBjaGFpbjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNlcnQgPSBjaGFpblswXQogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3NjcnlwdG9fY2VydCA9IGxvYWRfY2VydGlmaWNhdGUoY2VydCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGZfc2lnbmVkID0gb3NjcnlwdG9fY2VydC5zZWxmX3NpZ25lZAoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlzc3Vlcl9lcnJvcl9jb2RlcyA9IHNldChbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTGlic3NsQ29uc3QuWDUwOV9WX0VSUl9ERVBUSF9aRVJPX1NFTEZfU0lHTkVEX0NFUlQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTGlic3NsQ29uc3QuWDUwOV9WX0VSUl9TRUxGX1NJR05FRF9DRVJUX0lOX0NIQUlOLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIExpYnNzbENvbnN0Llg1MDlfVl9FUlJfVU5BQkxFX1RPX0dFVF9JU1NVRVJfQ0VSVF9MT0NBTExZCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBdKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgdmVyaWZ5X3Jlc3VsdCBpbiBpc3N1ZXJfZXJyb3JfY29kZXM6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9faXNzdWVyID0gbm90IHNlbGZfc2lnbmVkCgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGltZV9lcnJvcl9jb2RlcyA9IHNldChbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTGlic3NsQ29uc3QuWDUwOV9WX0VSUl9DRVJUX0hBU19FWFBJUkVELAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIExpYnNzbENvbnN0Llg1MDlfVl9FUlJfQ0VSVF9OT1RfWUVUX1ZBTElECiAgICAgICAgICAgICAgICAgICAgICAgICAgICBdKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGltZV9pbnZhbGlkID0gdmVyaWZ5X3Jlc3VsdCBpbiB0aW1lX2Vycm9yX2NvZGVzCgogICAgICAgICAgICAgICAgICAgICAgICBpZiB0aW1lX2ludmFsaWQ6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByYWlzZV9leHBpcmVkX25vdF95ZXRfdmFsaWQoY2VydCkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgbm9faXNzdWVyOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmFpc2Vfbm9faXNzdWVyKGNlcnQpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHNlbGZfc2lnbmVkOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmFpc2Vfc2VsZl9zaWduZWQoY2VydCkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgb3NjcnlwdG9fY2VydCBhbmQgb3NjcnlwdG9fY2VydC5hc24xLmhhc2hfYWxnbyBpbiBzZXQoWydtZDUnLCAnbWQyJ10pOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmFpc2Vfd2Vha19zaWduYXR1cmUob3NjcnlwdG9fY2VydCkKICAgICAgICAgICAgICAgICAgICAgICAgcmFpc2VfdmVyaWZpY2F0aW9uKGNlcnQpCgogICAgICAgICAgICAgICAgICAgIGhhbmRsZV9vcGVuc3NsX2Vycm9yKDAsIFRMU0Vycm9yKQoKICAgICAgICAgICAgc2Vzc2lvbl9pbmZvID0gcGFyc2Vfc2Vzc2lvbl9pbmZvKAogICAgICAgICAgICAgICAgaGFuZHNoYWtlX3NlcnZlcl9ieXRlcywKICAgICAgICAgICAgICAgIGhhbmRzaGFrZV9jbGllbnRfYnl0ZXMKICAgICAgICAgICAgKQogICAgICAgICAgICBzZWxmLl9wcm90b2NvbCA9IHNlc3Npb25faW5mb1sncHJvdG9jb2wnXQogICAgICAgICAgICBzZWxmLl9jaXBoZXJfc3VpdGUgPSBzZXNzaW9uX2luZm9bJ2NpcGhlcl9zdWl0ZSddCiAgICAgICAgICAgIHNlbGYuX2NvbXByZXNzaW9uID0gc2Vzc2lvbl9pbmZvWydjb21wcmVzc2lvbiddCiAgICAgICAgICAgIHNlbGYuX3Nlc3Npb25faWQgPSBzZXNzaW9uX2luZm9bJ3Nlc3Npb25faWQnXQogICAgICAgICAgICBzZWxmLl9zZXNzaW9uX3RpY2tldCA9IHNlc3Npb25faW5mb1snc2Vzc2lvbl90aWNrZXQnXQoKICAgICAgICAgICAgaWYgc2VsZi5fY2lwaGVyX3N1aXRlLmZpbmQoJ19ESEVfJykgIT0gLTE6CiAgICAgICAgICAgICAgICBkaF9wYXJhbXNfbGVuZ3RoID0gZ2V0X2RoX3BhcmFtc19sZW5ndGgoaGFuZHNoYWtlX3NlcnZlcl9ieXRlcykKICAgICAgICAgICAgICAgIGlmIGRoX3BhcmFtc19sZW5ndGggPCAxMDI0OgogICAgICAgICAgICAgICAgICAgIHNlbGYuY2xvc2UoKQogICAgICAgICAgICAgICAgICAgIHJhaXNlX2RoX3BhcmFtcygpCgogICAgICAgICAgICAjIFdoZW4gc2F2aW5nIHRoZSBzZXNzaW9uIGZvciBmdXR1cmUgcmVxdWVzdHMsIHdlIHVzZQogICAgICAgICAgICAjIFNTTF9nZXQxX3Nlc3Npb24oKSB2YXJpYW50IHRvIGluY3JlYXNlIHRoZSByZWZlcmVuY2UgY291bnQuIFRoaXMKICAgICAgICAgICAgIyBwcmV2ZW50cyB0aGUgc2Vzc2lvbiBmcm9tIGJlaW5nIGZyZWVkIHdoZW4gb25lIGNvbm5lY3Rpb24gY2xvc2VzCiAgICAgICAgICAgICMgYmVmb3JlIGFub3RoZXIgaXMgb3BlbmVkLiBIb3dldmVyLCBzaW5jZSB3ZSBpbmNyZWFzZSB0aGUgcmVmCiAgICAgICAgICAgICMgY291bnQsIHdlIGFsc28gaGF2ZSB0byBleHBsaWNpdGx5IGZyZWUgYW55IHByZXZpb3VzIHNlc3Npb24uCiAgICAgICAgICAgIGlmIHNlbGYuX3Nlc3Npb25faWQgPT0gJ25ldycgb3Igc2VsZi5fc2Vzc2lvbl90aWNrZXQgPT0gJ25ldyc6CiAgICAgICAgICAgICAgICBpZiBzZWxmLl9zZXNzaW9uLl9zc2xfc2Vzc2lvbjoKICAgICAgICAgICAgICAgICAgICBsaWJzc2wuU1NMX1NFU1NJT05fZnJlZShzZWxmLl9zZXNzaW9uLl9zc2xfc2Vzc2lvbikKICAgICAgICAgICAgICAgIHNlbGYuX3Nlc3Npb24uX3NzbF9zZXNzaW9uID0gbGlic3NsLlNTTF9nZXQxX3Nlc3Npb24oc2VsZi5fc3NsKQoKICAgICAgICAgICAgaWYgbm90IHNlbGYuX3Nlc3Npb24uX21hbnVhbF92YWxpZGF0aW9uOgogICAgICAgICAgICAgICAgaWYgc2VsZi5jZXJ0aWZpY2F0ZS5oYXNoX2FsZ28gaW4gc2V0KFsnbWQ1JywgJ21kMiddKToKICAgICAgICAgICAgICAgICAgICByYWlzZV93ZWFrX3NpZ25hdHVyZShzZWxmLmNlcnRpZmljYXRlKQoKICAgICAgICAgICAgICAgICMgT3BlblNTTCBkb2VzIG5vdCBkbyBob3N0bmFtZSBvciBJUCBhZGRyZXNzIGNoZWNraW5nIGluIHRoZSBlbmQKICAgICAgICAgICAgICAgICMgZW50aXR5IGNlcnRpZmljYXRlLCBzbyB3ZSBtdXN0IHBlcmZvcm0gdGhhdCBjaGVjawogICAgICAgICAgICAgICAgaWYgbm90IHNlbGYuY2VydGlmaWNhdGUuaXNfdmFsaWRfZG9tYWluX2lwKHNlbGYuX2hvc3RuYW1lKToKICAgICAgICAgICAgICAgICAgICByYWlzZV9ob3N0bmFtZShzZWxmLmNlcnRpZmljYXRlLCBzZWxmLl9ob3N0bmFtZSkKCiAgICAgICAgZXhjZXB0IChPU0Vycm9yLCBzb2NrZXRfLmVycm9yKToKICAgICAgICAgICAgaWYgc2VsZi5fc3NsOgogICAgICAgICAgICAgICAgbGlic3NsLlNTTF9mcmVlKHNlbGYuX3NzbCkKICAgICAgICAgICAgICAgIHNlbGYuX3NzbCA9IE5vbmUKICAgICAgICAgICAgICAgIHNlbGYuX3JiaW8gPSBOb25lCiAgICAgICAgICAgICAgICBzZWxmLl93YmlvID0gTm9uZQogICAgICAgICAgICAjIFRoZSBCSU9zIGFyZSBmcmVlZCBieSBTU0xfZnJlZSgpLCBzbyB3ZSBvbmx5IG5lZWQgdG8gZnJlZQogICAgICAgICAgICAjIHRoZW0gaWYgZm9yIHNvbWUgcmVhc29uIFNTTF9mcmVlKCkgd2FzIG5vdCBjYWxsZWQKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGlmIHNlbGYuX3JiaW86CiAgICAgICAgICAgICAgICAgICAgbGlic3NsLkJJT19mcmVlKHNlbGYuX3JiaW8pCiAgICAgICAgICAgICAgICAgICAgc2VsZi5fcmJpbyA9IE5vbmUKICAgICAgICAgICAgICAgIGlmIHNlbGYuX3diaW86CiAgICAgICAgICAgICAgICAgICAgbGlic3NsLkJJT19mcmVlKHNlbGYuX3diaW8pCiAgICAgICAgICAgICAgICAgICAgc2VsZi5fd2JpbyA9IE5vbmUKICAgICAgICAgICAgc2VsZi5jbG9zZSgpCgogICAgICAgICAgICByYWlzZQoKICAgIGRlZiBfcmF3X3JlYWQoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgUmVhZHMgZGF0YSBmcm9tIHRoZSBzb2NrZXQgYW5kIHdyaXRlcyBpdCB0byB0aGUgbWVtb3J5IGJpbwogICAgICAgIHVzZWQgYnkgbGlic3NsIHRvIGRlY3J5cHQgdGhlIGRhdGEuIFJldHVybnMgdGhlIHVuZW5jcnlwdGVkCiAgICAgICAgZGF0YSBmb3IgdGhlIHB1cnBvc2Ugb2YgZGVidWdnaW5nIGhhbmRzaGFrZXMuCgogICAgICAgIDpyZXR1cm46CiAgICAgICAgICAgIEEgYnl0ZSBzdHJpbmcgb2YgY2lwaGVydGV4dCBmcm9tIHRoZSBzb2NrZXQuIFVzZWQgZm9yCiAgICAgICAgICAgIGRlYnVnZ2luZyB0aGUgaGFuZHNoYWtlIG9ubHkuCiAgICAgICAgIiIiCgogICAgICAgIGRhdGEgPSBzZWxmLl9yYXdfYnl0ZXMKICAgICAgICB0cnk6CiAgICAgICAgICAgIGRhdGEgKz0gc2VsZi5fc29ja2V0LnJlY3YoODE5MikKICAgICAgICBleGNlcHQgKHNvY2tldF8uZXJyb3IpOgogICAgICAgICAgICBwYXNzCiAgICAgICAgb3V0cHV0ID0gZGF0YQogICAgICAgIHdyaXR0ZW4gPSBsaWJzc2wuQklPX3dyaXRlKHNlbGYuX3JiaW8sIGRhdGEsIGxlbihkYXRhKSkKICAgICAgICBzZWxmLl9yYXdfYnl0ZXMgPSBkYXRhW3dyaXR0ZW46XQogICAgICAgIHJldHVybiBvdXRwdXQKCiAgICBkZWYgX3Jhd193cml0ZShzZWxmKToKICAgICAgICAiIiIKICAgICAgICBUYWtlcyBjaXBoZXJ0ZXh0IGZyb20gdGhlIG1lbW9yeSBiaW8gYW5kIHdyaXRlcyBpdCB0byB0aGUKICAgICAgICBzb2NrZXQuCgogICAgICAgIDpyZXR1cm46CiAgICAgICAgICAgIEEgYnl0ZSBzdHJpbmcgb2YgY2lwaGVydGV4dCBnb2luZyB0byB0aGUgc29ja2V0LiBVc2VkCiAgICAgICAgICAgIGZvciBkZWJ1Z2dpbmcgdGhlIGhhbmRzaGFrZSBvbmx5LgogICAgICAgICIiIgoKICAgICAgICBkYXRhX2F2YWlsYWJsZSA9IGxpYnNzbC5CSU9fY3RybF9wZW5kaW5nKHNlbGYuX3diaW8pCiAgICAgICAgaWYgZGF0YV9hdmFpbGFibGUgPT0gMDoKICAgICAgICAgICAgcmV0dXJuIGInJwogICAgICAgIHRvX3JlYWQgPSBtaW4oc2VsZi5fYnVmZmVyX3NpemUsIGRhdGFfYXZhaWxhYmxlKQogICAgICAgIHJlYWQgPSBsaWJzc2wuQklPX3JlYWQoc2VsZi5fd2Jpbywgc2VsZi5fYmlvX3dyaXRlX2J1ZmZlciwgdG9fcmVhZCkKICAgICAgICB0b193cml0ZSA9IGJ5dGVzX2Zyb21fYnVmZmVyKHNlbGYuX2Jpb193cml0ZV9idWZmZXIsIHJlYWQpCiAgICAgICAgb3V0cHV0ID0gdG9fd3JpdGUKICAgICAgICB3aGlsZSBsZW4odG9fd3JpdGUpOgogICAgICAgICAgICByYWlzZV9kaXNjb25uZWN0ID0gRmFsc2UKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgc2VudCA9IHNlbGYuX3NvY2tldC5zZW5kKHRvX3dyaXRlKQogICAgICAgICAgICBleGNlcHQgKHNvY2tldF8uZXJyb3IpIGFzIGU6CiAgICAgICAgICAgICAgICAjIEhhbmRsZSBFQ09OTlJFU0VUIGFuZCBFUElQRQogICAgICAgICAgICAgICAgaWYgZS5lcnJubyA9PSAxMDQgb3IgZS5lcnJubyA9PSA1NCBvciBlLmVycm5vID09IDMyOgogICAgICAgICAgICAgICAgICAgIHJhaXNlX2Rpc2Nvbm5lY3QgPSBUcnVlCiAgICAgICAgICAgICAgICAjIEhhbmRsZSBFUFJPVE9UWVBFLiBOZXdlciB2ZXJzaW9ucyBvZiBtYWNPUyB3aWxsIHJldHVybiB0aGlzCiAgICAgICAgICAgICAgICAjIGlmIHdlIHRyeSB0byBjYWxsIHNlbmQoKSB3aGlsZSB0aGUgc29ja2V0IGlzIGJlaW5nIHRvcm4gZG93bgogICAgICAgICAgICAgICAgZWxpZiBzeXMucGxhdGZvcm0gPT0gJ2RhcndpbicgYW5kIGUuZXJybm8gPT0gNDE6CiAgICAgICAgICAgICAgICAgICAgcmFpc2VfZGlzY29ubmVjdCA9IFRydWUKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgcmFpc2UKCiAgICAgICAgICAgIGlmIHJhaXNlX2Rpc2Nvbm5lY3Q6CiAgICAgICAgICAgICAgICByYWlzZV9kaXNjb25uZWN0aW9uKCkKICAgICAgICAgICAgdG9fd3JpdGUgPSB0b193cml0ZVtzZW50Ol0KICAgICAgICAgICAgaWYgbGVuKHRvX3dyaXRlKToKICAgICAgICAgICAgICAgIHNlbGYuc2VsZWN0X3dyaXRlKCkKICAgICAgICByZXR1cm4gb3V0cHV0CgogICAgZGVmIHJlYWQoc2VsZiwgbWF4X2xlbmd0aCk6CiAgICAgICAgIiIiCiAgICAgICAgUmVhZHMgZGF0YSBmcm9tIHRoZSBUTFMtd3JhcHBlZCBzb2NrZXQKCiAgICAgICAgOnBhcmFtIG1heF9sZW5ndGg6CiAgICAgICAgICAgIFRoZSBudW1iZXIgb2YgYnl0ZXMgdG8gcmVhZCAtIG91dHB1dCBtYXkgYmUgbGVzcyB0aGFuIHRoaXMKCiAgICAgICAgOnJhaXNlczoKICAgICAgICAgICAgc29ja2V0LnNvY2tldCAtIHdoZW4gYSBub24tVExTIHNvY2tldCBlcnJvciBvY2N1cnMKICAgICAgICAgICAgb3NjcnlwdG8uZXJyb3JzLlRMU0Vycm9yIC0gd2hlbiBhIFRMUy1yZWxhdGVkIGVycm9yIG9jY3VycwogICAgICAgICAgICBWYWx1ZUVycm9yIC0gd2hlbiBhbnkgb2YgdGhlIHBhcmFtZXRlcnMgY29udGFpbiBhbiBpbnZhbGlkIHZhbHVlCiAgICAgICAgICAgIFR5cGVFcnJvciAtIHdoZW4gYW55IG9mIHRoZSBwYXJhbWV0ZXJzIGFyZSBvZiB0aGUgd3JvbmcgdHlwZQogICAgICAgICAgICBPU0Vycm9yIC0gd2hlbiBhbiBlcnJvciBpcyByZXR1cm5lZCBieSB0aGUgT1MgY3J5cHRvIGxpYnJhcnkKCiAgICAgICAgOnJldHVybjoKICAgICAgICAgICAgQSBieXRlIHN0cmluZyBvZiB0aGUgZGF0YSByZWFkCiAgICAgICAgIiIiCgogICAgICAgIGlmIG5vdCBpc2luc3RhbmNlKG1heF9sZW5ndGgsIGludF90eXBlcyk6CiAgICAgICAgICAgIHJhaXNlIFR5cGVFcnJvcihwcmV0dHlfbWVzc2FnZSgKICAgICAgICAgICAgICAgICcnJwogICAgICAgICAgICAgICAgbWF4X2xlbmd0aCBtdXN0IGJlIGFuIGludGVnZXIsIG5vdCAlcwogICAgICAgICAgICAgICAgJycnLAogICAgICAgICAgICAgICAgdHlwZV9uYW1lKG1heF9sZW5ndGgpCiAgICAgICAgICAgICkpCgogICAgICAgIGJ1ZmZlcmVkX2xlbmd0aCA9IGxlbihzZWxmLl9kZWNyeXB0ZWRfYnl0ZXMpCgogICAgICAgICMgSWYgd2UgYWxyZWFkeSBoYXZlIGVub3VnaCBidWZmZXJlZCBkYXRhLCBqdXN0IHVzZSB0aGF0CiAgICAgICAgaWYgYnVmZmVyZWRfbGVuZ3RoID49IG1heF9sZW5ndGg6CiAgICAgICAgICAgIG91dHB1dCA9IHNlbGYuX2RlY3J5cHRlZF9ieXRlc1swOm1heF9sZW5ndGhdCiAgICAgICAgICAgIHNlbGYuX2RlY3J5cHRlZF9ieXRlcyA9IHNlbGYuX2RlY3J5cHRlZF9ieXRlc1ttYXhfbGVuZ3RoOl0KICAgICAgICAgICAgcmV0dXJuIG91dHB1dAoKICAgICAgICBpZiBzZWxmLl9zc2wgaXMgTm9uZToKICAgICAgICAgICAgc2VsZi5fcmFpc2VfY2xvc2VkKCkKCiAgICAgICAgIyBEb24ndCBibG9jayBpZiB3ZSBoYXZlIGJ1ZmZlcmVkIGRhdGEgYXZhaWxhYmxlLCBzaW5jZSBpdCBpcyBvayB0bwogICAgICAgICMgcmV0dXJuIGxlc3MgdGhhbiB0aGUgbWF4X2xlbmd0aAogICAgICAgIGlmIGJ1ZmZlcmVkX2xlbmd0aCA+IDAgYW5kIG5vdCBzZWxmLnNlbGVjdF9yZWFkKDApOgogICAgICAgICAgICBvdXRwdXQgPSBzZWxmLl9kZWNyeXB0ZWRfYnl0ZXMKICAgICAgICAgICAgc2VsZi5fZGVjcnlwdGVkX2J5dGVzID0gYicnCiAgICAgICAgICAgIHJldHVybiBvdXRwdXQKCiAgICAgICAgIyBPbmx5IHJlYWQgZW5vdWdoIHRvIGdldCB0aGUgcmVxdWVzdGVkIGFtb3VudCB3aGVuCiAgICAgICAgIyBjb21iaW5lZCB3aXRoIGJ1ZmZlcmVkIGRhdGEKICAgICAgICB0b19yZWFkID0gbWluKHNlbGYuX2J1ZmZlcl9zaXplLCBtYXhfbGVuZ3RoIC0gYnVmZmVyZWRfbGVuZ3RoKQoKICAgICAgICBvdXRwdXQgPSBzZWxmLl9kZWNyeXB0ZWRfYnl0ZXMKCiAgICAgICAgIyBUaGUgU1NMX3JlYWQoKSBsb29wIGhhbmRsZXMgcmVuZWdvdGlhdGlvbnMsIHNvIHdlIG5lZWQgdG8gaGFuZGxlCiAgICAgICAgIyByZXF1ZXN0cyBmb3IgYm90aCByZWFkcyBhbmQgd3JpdGVzCiAgICAgICAgYWdhaW4gPSBUcnVlCiAgICAgICAgd2hpbGUgYWdhaW46CiAgICAgICAgICAgIGFnYWluID0gRmFsc2UKICAgICAgICAgICAgcmVzdWx0ID0gbGlic3NsLlNTTF9yZWFkKHNlbGYuX3NzbCwgc2VsZi5fcmVhZF9idWZmZXIsIHRvX3JlYWQpCiAgICAgICAgICAgIHNlbGYuX3Jhd193cml0ZSgpCiAgICAgICAgICAgIGlmIHJlc3VsdCA8PSAwOgoKICAgICAgICAgICAgICAgIGVycm9yID0gbGlic3NsLlNTTF9nZXRfZXJyb3Ioc2VsZi5fc3NsLCByZXN1bHQpCiAgICAgICAgICAgICAgICBpZiBlcnJvciA9PSBMaWJzc2xDb25zdC5TU0xfRVJST1JfV0FOVF9SRUFEOgogICAgICAgICAgICAgICAgICAgIGlmIHNlbGYuX3Jhd19yZWFkKCkgIT0gYicnOgogICAgICAgICAgICAgICAgICAgICAgICBhZ2FpbiA9IFRydWUKICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgICAgICByYWlzZV9kaXNjb25uZWN0aW9uKCkKCiAgICAgICAgICAgICAgICBlbGlmIGVycm9yID09IExpYnNzbENvbnN0LlNTTF9FUlJPUl9XQU5UX1dSSVRFOgogICAgICAgICAgICAgICAgICAgIHNlbGYuX3Jhd193cml0ZSgpCiAgICAgICAgICAgICAgICAgICAgYWdhaW4gPSBUcnVlCiAgICAgICAgICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgICAgICAgICBlbGlmIGVycm9yID09IExpYnNzbENvbnN0LlNTTF9FUlJPUl9aRVJPX1JFVFVSTjoKICAgICAgICAgICAgICAgICAgICBzZWxmLl9ncmFjZWZ1bGx5X2Nsb3NlZCA9IFRydWUKICAgICAgICAgICAgICAgICAgICBzZWxmLl9zaHV0ZG93bihGYWxzZSkKICAgICAgICAgICAgICAgICAgICBicmVhawoKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgaGFuZGxlX29wZW5zc2xfZXJyb3IoMCwgVExTRXJyb3IpCgogICAgICAgICAgICBvdXRwdXQgKz0gYnl0ZXNfZnJvbV9idWZmZXIoc2VsZi5fcmVhZF9idWZmZXIsIHJlc3VsdCkKCiAgICAgICAgaWYgc2VsZi5fZ3JhY2VmdWxseV9jbG9zZWQgYW5kIGxlbihvdXRwdXQpID09IDA6CiAgICAgICAgICAgIHNlbGYuX3JhaXNlX2Nsb3NlZCgpCgogICAgICAgIHNlbGYuX2RlY3J5cHRlZF9ieXRlcyA9IG91dHB1dFttYXhfbGVuZ3RoOl0KICAgICAgICByZXR1cm4gb3V0cHV0WzA6bWF4X2xlbmd0aF0KCiAgICBkZWYgc2VsZWN0X3JlYWQoc2VsZiwgdGltZW91dD1Ob25lKToKICAgICAgICAiIiIKICAgICAgICBCbG9ja3MgdW50aWwgdGhlIHNvY2tldCBpcyByZWFkeSB0byBiZSByZWFkIGZyb20sIG9yIHRoZSB0aW1lb3V0IGlzIGhpdAoKICAgICAgICA6cGFyYW0gdGltZW91dDoKICAgICAgICAgICAgQSBmbG9hdCAtIHRoZSBwZXJpb2Qgb2YgdGltZSB0byB3YWl0IGZvciBkYXRhIHRvIGJlIHJlYWQuIE5vbmUgZm9yCiAgICAgICAgICAgIG5vIHRpbWUgbGltaXQuCgogICAgICAgIDpyZXR1cm46CiAgICAgICAgICAgIEEgYm9vbGVhbiAtIGlmIGRhdGEgaXMgcmVhZHkgdG8gYmUgcmVhZC4gV2lsbCBvbmx5IGJlIEZhbHNlIGlmCiAgICAgICAgICAgIHRpbWVvdXQgaXMgbm90IE5vbmUuCiAgICAgICAgIiIiCgogICAgICAgICMgSWYgd2UgaGF2ZSBidWZmZXJlZCBkYXRhLCB3ZSBjb25zaWRlciBhIHJlYWQgcG9zc2libGUKICAgICAgICBpZiBsZW4oc2VsZi5fZGVjcnlwdGVkX2J5dGVzKSA+IDA6CiAgICAgICAgICAgIHJldHVybiBUcnVlCgogICAgICAgIHJlYWRfcmVhZHksIF8sIF8gPSBzZWxlY3Quc2VsZWN0KFtzZWxmLl9zb2NrZXRdLCBbXSwgW10sIHRpbWVvdXQpCiAgICAgICAgcmV0dXJuIGxlbihyZWFkX3JlYWR5KSA+IDAKCiAgICBkZWYgcmVhZF91bnRpbChzZWxmLCBtYXJrZXIpOgogICAgICAgICIiIgogICAgICAgIFJlYWRzIGRhdGEgZnJvbSB0aGUgc29ja2V0IHVudGlsIGEgbWFya2VyIGlzIGZvdW5kLiBEYXRhIHJlYWQgaW5jbHVkZXMKICAgICAgICB0aGUgbWFya2VyLgoKICAgICAgICA6cGFyYW0gbWFya2VyOgogICAgICAgICAgICBBIGJ5dGUgc3RyaW5nIG9yIHJlZ2V4IG9iamVjdCBmcm9tIHJlLmNvbXBpbGUoKS4gVXNlZCB0byBkZXRlcm1pbmUKICAgICAgICAgICAgd2hlbiB0byBzdG9wIHJlYWRpbmcuIFJlZ2V4IG9iamVjdHMgYXJlIG1vcmUgaW5lZmZpY2llbnQgc2luY2UKICAgICAgICAgICAgdGhleSBtdXN0IHNjYW4gdGhlIGVudGlyZSBieXRlIHN0cmluZyBvZiByZWFkIGRhdGEgZWFjaCB0aW1lIGRhdGEKICAgICAgICAgICAgaXMgcmVhZCBvZmYgdGhlIHNvY2tldC4KCiAgICAgICAgOnJldHVybjoKICAgICAgICAgICAgQSBieXRlIHN0cmluZyBvZiB0aGUgZGF0YSByZWFkLCBpbmNsdWRpbmcgdGhlIG1hcmtlcgogICAgICAgICIiIgoKICAgICAgICBpZiBub3QgaXNpbnN0YW5jZShtYXJrZXIsIGJ5dGVfY2xzKSBhbmQgbm90IGlzaW5zdGFuY2UobWFya2VyLCBQYXR0ZXJuKToKICAgICAgICAgICAgcmFpc2UgVHlwZUVycm9yKHByZXR0eV9tZXNzYWdlKAogICAgICAgICAgICAgICAgJycnCiAgICAgICAgICAgICAgICBtYXJrZXIgbXVzdCBiZSBhIGJ5dGUgc3RyaW5nIG9yIGNvbXBpbGVkIHJlZ2V4IG9iamVjdCwgbm90ICVzCiAgICAgICAgICAgICAgICAnJycsCiAgICAgICAgICAgICAgICB0eXBlX25hbWUobWFya2VyKQogICAgICAgICAgICApKQoKICAgICAgICBvdXRwdXQgPSBiJycKCiAgICAgICAgaXNfcmVnZXggPSBpc2luc3RhbmNlKG1hcmtlciwgUGF0dGVybikKCiAgICAgICAgd2hpbGUgVHJ1ZToKICAgICAgICAgICAgaWYgbGVuKHNlbGYuX2RlY3J5cHRlZF9ieXRlcykgPiAwOgogICAgICAgICAgICAgICAgY2h1bmsgPSBzZWxmLl9kZWNyeXB0ZWRfYnl0ZXMKICAgICAgICAgICAgICAgIHNlbGYuX2RlY3J5cHRlZF9ieXRlcyA9IGInJwogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgaWYgc2VsZi5fc3NsIGlzIE5vbmU6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5fcmFpc2VfY2xvc2VkKCkKICAgICAgICAgICAgICAgIHRvX3JlYWQgPSBsaWJzc2wuU1NMX3BlbmRpbmcoc2VsZi5fc3NsKSBvciA4MTkyCiAgICAgICAgICAgICAgICBjaHVuayA9IHNlbGYucmVhZCh0b19yZWFkKQoKICAgICAgICAgICAgb2Zmc2V0ID0gbGVuKG91dHB1dCkKICAgICAgICAgICAgb3V0cHV0ICs9IGNodW5rCgogICAgICAgICAgICBpZiBpc19yZWdleDoKICAgICAgICAgICAgICAgIG1hdGNoID0gbWFya2VyLnNlYXJjaChvdXRwdXQpCiAgICAgICAgICAgICAgICBpZiBtYXRjaCBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgICAgICBlbmQgPSBtYXRjaC5lbmQoKQogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAjIElmIHRoZSBtYXJrZXIgd2FzIG5vdCBmb3VuZCBsYXN0IHRpbWUsIHdlIGhhdmUgdG8gc3RhcnQKICAgICAgICAgICAgICAgICMgYXQgYSBwb3NpdGlvbiB3aGVyZSB0aGUgbWFya2VyIHdvdWxkIGhhdmUgaXRzIGZpbmFsIGNoYXIKICAgICAgICAgICAgICAgICMgaW4gdGhlIG5ld2x5IHJlYWQgY2h1bmsKICAgICAgICAgICAgICAgIHN0YXJ0ID0gbWF4KDAsIG9mZnNldCAtIGxlbihtYXJrZXIpIC0gMSkKICAgICAgICAgICAgICAgIG1hdGNoID0gb3V0cHV0LmZpbmQobWFya2VyLCBzdGFydCkKICAgICAgICAgICAgICAgIGlmIG1hdGNoICE9IC0xOgogICAgICAgICAgICAgICAgICAgIGVuZCA9IG1hdGNoICsgbGVuKG1hcmtlcikKICAgICAgICAgICAgICAgICAgICBicmVhawoKICAgICAgICBzZWxmLl9kZWNyeXB0ZWRfYnl0ZXMgPSBvdXRwdXRbZW5kOl0gKyBzZWxmLl9kZWNyeXB0ZWRfYnl0ZXMKICAgICAgICByZXR1cm4gb3V0cHV0WzA6ZW5kXQoKICAgIGRlZiByZWFkX2xpbmUoc2VsZik6CiAgICAgICAgciIiIgogICAgICAgIFJlYWRzIGEgbGluZSBmcm9tIHRoZSBzb2NrZXQsIGluY2x1ZGluZyB0aGUgbGluZSBlbmRpbmcgb2YgIlxyXG4iLCAiXHIiLAogICAgICAgIG9yICJcbiIKCiAgICAgICAgOnJldHVybjoKICAgICAgICAgICAgQSBieXRlIHN0cmluZyBvZiB0aGUgbmV4dCBsaW5lIGZyb20gdGhlIHNvY2tldAogICAgICAgICIiIgoKICAgICAgICByZXR1cm4gc2VsZi5yZWFkX3VudGlsKF9saW5lX3JlZ2V4KQoKICAgIGRlZiByZWFkX2V4YWN0bHkoc2VsZiwgbnVtX2J5dGVzKToKICAgICAgICAiIiIKICAgICAgICBSZWFkcyBleGFjdGx5IHRoZSBzcGVjaWZpZWQgbnVtYmVyIG9mIGJ5dGVzIGZyb20gdGhlIHNvY2tldAoKICAgICAgICA6cGFyYW0gbnVtX2J5dGVzOgogICAgICAgICAgICBBbiBpbnRlZ2VyIC0gdGhlIGV4YWN0IG51bWJlciBvZiBieXRlcyB0byByZWFkCgogICAgICAgIDpyZXR1cm46CiAgICAgICAgICAgIEEgYnl0ZSBzdHJpbmcgb2YgdGhlIGRhdGEgdGhhdCB3YXMgcmVhZAogICAgICAgICIiIgoKICAgICAgICBvdXRwdXQgPSBiJycKICAgICAgICByZW1haW5pbmcgPSBudW1fYnl0ZXMKICAgICAgICB3aGlsZSByZW1haW5pbmcgPiAwOgogICAgICAgICAgICBvdXRwdXQgKz0gc2VsZi5yZWFkKHJlbWFpbmluZykKICAgICAgICAgICAgcmVtYWluaW5nID0gbnVtX2J5dGVzIC0gbGVuKG91dHB1dCkKCiAgICAgICAgcmV0dXJuIG91dHB1dAoKICAgIGRlZiB3cml0ZShzZWxmLCBkYXRhKToKICAgICAgICAiIiIKICAgICAgICBXcml0ZXMgZGF0YSB0byB0aGUgVExTLXdyYXBwZWQgc29ja2V0CgogICAgICAgIDpwYXJhbSBkYXRhOgogICAgICAgICAgICBBIGJ5dGUgc3RyaW5nIHRvIHdyaXRlIHRvIHRoZSBzb2NrZXQKCiAgICAgICAgOnJhaXNlczoKICAgICAgICAgICAgc29ja2V0LnNvY2tldCAtIHdoZW4gYSBub24tVExTIHNvY2tldCBlcnJvciBvY2N1cnMKICAgICAgICAgICAgb3NjcnlwdG8uZXJyb3JzLlRMU0Vycm9yIC0gd2hlbiBhIFRMUy1yZWxhdGVkIGVycm9yIG9jY3VycwogICAgICAgICAgICBWYWx1ZUVycm9yIC0gd2hlbiBhbnkgb2YgdGhlIHBhcmFtZXRlcnMgY29udGFpbiBhbiBpbnZhbGlkIHZhbHVlCiAgICAgICAgICAgIFR5cGVFcnJvciAtIHdoZW4gYW55IG9mIHRoZSBwYXJhbWV0ZXJzIGFyZSBvZiB0aGUgd3JvbmcgdHlwZQogICAgICAgICAgICBPU0Vycm9yIC0gd2hlbiBhbiBlcnJvciBpcyByZXR1cm5lZCBieSB0aGUgT1MgY3J5cHRvIGxpYnJhcnkKICAgICAgICAiIiIKCiAgICAgICAgZGF0YV9sZW4gPSBsZW4oZGF0YSkKICAgICAgICB3aGlsZSBkYXRhX2xlbjoKICAgICAgICAgICAgaWYgc2VsZi5fc3NsIGlzIE5vbmU6CiAgICAgICAgICAgICAgICBzZWxmLl9yYWlzZV9jbG9zZWQoKQogICAgICAgICAgICByZXN1bHQgPSBsaWJzc2wuU1NMX3dyaXRlKHNlbGYuX3NzbCwgZGF0YSwgZGF0YV9sZW4pCiAgICAgICAgICAgIHNlbGYuX3Jhd193cml0ZSgpCiAgICAgICAgICAgIGlmIHJlc3VsdCA8PSAwOgoKICAgICAgICAgICAgICAgIGVycm9yID0gbGlic3NsLlNTTF9nZXRfZXJyb3Ioc2VsZi5fc3NsLCByZXN1bHQpCiAgICAgICAgICAgICAgICBpZiBlcnJvciA9PSBMaWJzc2xDb25zdC5TU0xfRVJST1JfV0FOVF9SRUFEOgogICAgICAgICAgICAgICAgICAgIGlmIHNlbGYuX3Jhd19yZWFkKCkgIT0gYicnOgogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgICAgIHJhaXNlX2Rpc2Nvbm5lY3Rpb24oKQoKICAgICAgICAgICAgICAgIGVsaWYgZXJyb3IgPT0gTGlic3NsQ29uc3QuU1NMX0VSUk9SX1dBTlRfV1JJVEU6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5fcmF3X3dyaXRlKCkKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQoKICAgICAgICAgICAgICAgIGVsaWYgZXJyb3IgPT0gTGlic3NsQ29uc3QuU1NMX0VSUk9SX1pFUk9fUkVUVVJOOgogICAgICAgICAgICAgICAgICAgIHNlbGYuX2dyYWNlZnVsbHlfY2xvc2VkID0gVHJ1ZQogICAgICAgICAgICAgICAgICAgIHNlbGYuX3NodXRkb3duKEZhbHNlKQogICAgICAgICAgICAgICAgICAgIHNlbGYuX3JhaXNlX2Nsb3NlZCgpCgogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBoYW5kbGVfb3BlbnNzbF9lcnJvcigwLCBUTFNFcnJvcikKCiAgICAgICAgICAgIGRhdGEgPSBkYXRhW3Jlc3VsdDpdCiAgICAgICAgICAgIGRhdGFfbGVuID0gbGVuKGRhdGEpCgogICAgZGVmIHNlbGVjdF93cml0ZShzZWxmLCB0aW1lb3V0PU5vbmUpOgogICAgICAgICIiIgogICAgICAgIEJsb2NrcyB1bnRpbCB0aGUgc29ja2V0IGlzIHJlYWR5IHRvIGJlIHdyaXR0ZW4gdG8sIG9yIHRoZSB0aW1lb3V0IGlzIGhpdAoKICAgICAgICA6cGFyYW0gdGltZW91dDoKICAgICAgICAgICAgQSBmbG9hdCAtIHRoZSBwZXJpb2Qgb2YgdGltZSB0byB3YWl0IGZvciB0aGUgc29ja2V0IHRvIGJlIHJlYWR5IHRvCiAgICAgICAgICAgIHdyaXR0ZW4gdG8uIE5vbmUgZm9yIG5vIHRpbWUgbGltaXQuCgogICAgICAgIDpyZXR1cm46CiAgICAgICAgICAgIEEgYm9vbGVhbiAtIGlmIHRoZSBzb2NrZXQgaXMgcmVhZHkgZm9yIHdyaXRpbmcuIFdpbGwgb25seSBiZSBGYWxzZQogICAgICAgICAgICBpZiB0aW1lb3V0IGlzIG5vdCBOb25lLgogICAgICAgICIiIgoKICAgICAgICBfLCB3cml0ZV9yZWFkeSwgXyA9IHNlbGVjdC5zZWxlY3QoW10sIFtzZWxmLl9zb2NrZXRdLCBbXSwgdGltZW91dCkKICAgICAgICByZXR1cm4gbGVuKHdyaXRlX3JlYWR5KSA+IDAKCiAgICBkZWYgX3NodXRkb3duKHNlbGYsIG1hbnVhbCk6CiAgICAgICAgIiIiCiAgICAgICAgU2h1dHMgZG93biB0aGUgVExTIHNlc3Npb24gYW5kIHRoZW4gc2h1dHMgZG93biB0aGUgdW5kZXJseWluZyBzb2NrZXQKCiAgICAgICAgOnBhcmFtIG1hbnVhbDoKICAgICAgICAgICAgQSBib29sZWFuIGlmIHRoZSBjb25uZWN0aW9uIHdhcyBtYW51YWxseSBzaHV0ZG93bgogICAgICAgICIiIgoKICAgICAgICBpZiBzZWxmLl9zc2wgaXMgTm9uZToKICAgICAgICAgICAgcmV0dXJuCgogICAgICAgIHdoaWxlIFRydWU6CiAgICAgICAgICAgIHJlc3VsdCA9IGxpYnNzbC5TU0xfc2h1dGRvd24oc2VsZi5fc3NsKQoKICAgICAgICAgICAgIyBEb24ndCBiZSBub2lzeSBpZiB0aGUgc29ja2V0IGlzIGFscmVhZHkgY2xvc2VkCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHNlbGYuX3Jhd193cml0ZSgpCiAgICAgICAgICAgIGV4Y2VwdCAoVExTRGlzY29ubmVjdEVycm9yKToKICAgICAgICAgICAgICAgIHBhc3MKCiAgICAgICAgICAgIGlmIHJlc3VsdCA+PSAwOgogICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgaWYgcmVzdWx0IDwgMDoKICAgICAgICAgICAgICAgIGVycm9yID0gbGlic3NsLlNTTF9nZXRfZXJyb3Ioc2VsZi5fc3NsLCByZXN1bHQpCiAgICAgICAgICAgICAgICBpZiBlcnJvciA9PSBMaWJzc2xDb25zdC5TU0xfRVJST1JfV0FOVF9SRUFEOgogICAgICAgICAgICAgICAgICAgIGlmIHNlbGYuX3Jhd19yZWFkKCkgIT0gYicnOgogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrCgogICAgICAgICAgICAgICAgZWxpZiBlcnJvciA9PSBMaWJzc2xDb25zdC5TU0xfRVJST1JfV0FOVF9XUklURToKICAgICAgICAgICAgICAgICAgICBzZWxmLl9yYXdfd3JpdGUoKQogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBoYW5kbGVfb3BlbnNzbF9lcnJvcigwLCBUTFNFcnJvcikKCiAgICAgICAgaWYgbWFudWFsOgogICAgICAgICAgICBzZWxmLl9sb2NhbF9jbG9zZWQgPSBUcnVlCgogICAgICAgIGxpYnNzbC5TU0xfZnJlZShzZWxmLl9zc2wpCiAgICAgICAgc2VsZi5fc3NsID0gTm9uZQogICAgICAgICMgQklPcyBhcmUgZnJlZWQgYnkgU1NMX2ZyZWUoKQogICAgICAgIHNlbGYuX3JiaW8gPSBOb25lCiAgICAgICAgc2VsZi5fd2JpbyA9IE5vbmUKCiAgICAgICAgdHJ5OgogICAgICAgICAgICBzZWxmLl9zb2NrZXQuc2h1dGRvd24oc29ja2V0Xy5TSFVUX1JEV1IpCiAgICAgICAgZXhjZXB0IChzb2NrZXRfLmVycm9yKToKICAgICAgICAgICAgcGFzcwoKICAgIGRlZiBzaHV0ZG93bihzZWxmKToKICAgICAgICAiIiIKICAgICAgICBTaHV0cyBkb3duIHRoZSBUTFMgc2Vzc2lvbiBhbmQgdGhlbiBzaHV0cyBkb3duIHRoZSB1bmRlcmx5aW5nIHNvY2tldAogICAgICAgICIiIgoKICAgICAgICBzZWxmLl9zaHV0ZG93bihUcnVlKQoKICAgIGRlZiBjbG9zZShzZWxmKToKICAgICAgICAiIiIKICAgICAgICBTaHV0cyBkb3duIHRoZSBUTFMgc2Vzc2lvbiBhbmQgc29ja2V0IGFuZCBmb3JjaWJseSBjbG9zZXMgaXQKICAgICAgICAiIiIKCiAgICAgICAgdHJ5OgogICAgICAgICAgICBzZWxmLnNodXRkb3duKCkKCiAgICAgICAgZmluYWxseToKICAgICAgICAgICAgaWYgc2VsZi5fc29ja2V0OgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIHNlbGYuX3NvY2tldC5jbG9zZSgpCiAgICAgICAgICAgICAgICBleGNlcHQgKHNvY2tldF8uZXJyb3IpOgogICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgICAgIHNlbGYuX3NvY2tldCA9IE5vbmUKCiAgICBkZWYgX3JlYWRfY2VydGlmaWNhdGVzKHNlbGYpOgogICAgICAgICIiIgogICAgICAgIFJlYWRzIGVuZC1lbnRpdHkgYW5kIGludGVybWVkaWF0ZSBjZXJ0aWZpY2F0ZSBpbmZvcm1hdGlvbiBmcm9tIHRoZQogICAgICAgIFRMUyBzZXNzaW9uCiAgICAgICAgIiIiCgogICAgICAgIHN0YWNrX3BvaW50ZXIgPSBsaWJzc2wuU1NMX2dldF9wZWVyX2NlcnRfY2hhaW4oc2VsZi5fc3NsKQogICAgICAgIGlmIGlzX251bGwoc3RhY2tfcG9pbnRlcik6CiAgICAgICAgICAgIGhhbmRsZV9vcGVuc3NsX2Vycm9yKDAsIFRMU0Vycm9yKQoKICAgICAgICBpZiBsaWJjcnlwdG9fdmVyc2lvbl9pbmZvIDwgKDEsIDEpOgogICAgICAgICAgICBudW1iZXJfY2VydHMgPSBsaWJzc2wuc2tfbnVtKHN0YWNrX3BvaW50ZXIpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgbnVtYmVyX2NlcnRzID0gbGlic3NsLk9QRU5TU0xfc2tfbnVtKHN0YWNrX3BvaW50ZXIpCgogICAgICAgIHNlbGYuX2ludGVybWVkaWF0ZXMgPSBbXQoKICAgICAgICBmb3IgaW5kZXggaW4gcmFuZ2UoMCwgbnVtYmVyX2NlcnRzKToKICAgICAgICAgICAgaWYgbGliY3J5cHRvX3ZlcnNpb25faW5mbyA8ICgxLCAxKToKICAgICAgICAgICAgICAgIHg1MDlfID0gbGlic3NsLnNrX3ZhbHVlKHN0YWNrX3BvaW50ZXIsIGluZGV4KQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgeDUwOV8gPSBsaWJzc2wuT1BFTlNTTF9za192YWx1ZShzdGFja19wb2ludGVyLCBpbmRleCkKICAgICAgICAgICAgYnVmZmVyX3NpemUgPSBsaWJjcnlwdG8uaTJkX1g1MDkoeDUwOV8sIG51bGwoKSkKICAgICAgICAgICAgY2VydF9idWZmZXIgPSBidWZmZXJfZnJvbV9ieXRlcyhidWZmZXJfc2l6ZSkKICAgICAgICAgICAgY2VydF9wb2ludGVyID0gYnVmZmVyX3BvaW50ZXIoY2VydF9idWZmZXIpCiAgICAgICAgICAgIGNlcnRfbGVuZ3RoID0gbGliY3J5cHRvLmkyZF9YNTA5KHg1MDlfLCBjZXJ0X3BvaW50ZXIpCiAgICAgICAgICAgIGhhbmRsZV9vcGVuc3NsX2Vycm9yKGNlcnRfbGVuZ3RoKQogICAgICAgICAgICBjZXJ0X2RhdGEgPSBieXRlc19mcm9tX2J1ZmZlcihjZXJ0X2J1ZmZlciwgY2VydF9sZW5ndGgpCgogICAgICAgICAgICBjZXJ0ID0gQXNuMUNlcnRpZmljYXRlLmxvYWQoY2VydF9kYXRhKQoKICAgICAgICAgICAgaWYgaW5kZXggPT0gMDoKICAgICAgICAgICAgICAgIHNlbGYuX2NlcnRpZmljYXRlID0gY2VydAogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgc2VsZi5faW50ZXJtZWRpYXRlcy5hcHBlbmQoY2VydCkKCiAgICBkZWYgX3JhaXNlX2Nsb3NlZChzZWxmKToKICAgICAgICAiIiIKICAgICAgICBSYWlzZXMgYW4gZXhjZXB0aW9uIGRlc2NyaWJpbmcgaWYgdGhlIGxvY2FsIG9yIHJlbW90ZSBlbmQgY2xvc2VkIHRoZQogICAgICAgIGNvbm5lY3Rpb24KICAgICAgICAiIiIKCiAgICAgICAgaWYgc2VsZi5fbG9jYWxfY2xvc2VkOgogICAgICAgICAgICByYWlzZSBUTFNEaXNjb25uZWN0RXJyb3IoJ1RoZSBjb25uZWN0aW9uIHdhcyBhbHJlYWR5IGNsb3NlZCcpCiAgICAgICAgZWxpZiBzZWxmLl9ncmFjZWZ1bGx5X2Nsb3NlZDoKICAgICAgICAgICAgcmFpc2UgVExTR3JhY2VmdWxEaXNjb25uZWN0RXJyb3IoJ1RoZSByZW1vdGUgZW5kIGNsb3NlZCB0aGUgY29ubmVjdGlvbicpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmFpc2UgVExTRGlzY29ubmVjdEVycm9yKCdUaGUgY29ubmVjdGlvbiB3YXMgY2xvc2VkJykKCiAgICBAcHJvcGVydHkKICAgIGRlZiBjZXJ0aWZpY2F0ZShzZWxmKToKICAgICAgICAiIiIKICAgICAgICBBbiBhc24xY3J5cHRvLng1MDkuQ2VydGlmaWNhdGUgb2JqZWN0IG9mIHRoZSBlbmQtZW50aXR5IGNlcnRpZmljYXRlCiAgICAgICAgcHJlc2VudGVkIGJ5IHRoZSBzZXJ2ZXIKICAgICAgICAiIiIKCiAgICAgICAgaWYgc2VsZi5fc3NsIGlzIE5vbmU6CiAgICAgICAgICAgIHNlbGYuX3JhaXNlX2Nsb3NlZCgpCgogICAgICAgIGlmIHNlbGYuX2NlcnRpZmljYXRlIGlzIE5vbmU6CiAgICAgICAgICAgIHNlbGYuX3JlYWRfY2VydGlmaWNhdGVzKCkKCiAgICAgICAgcmV0dXJuIHNlbGYuX2NlcnRpZmljYXRlCgogICAgQHByb3BlcnR5CiAgICBkZWYgaW50ZXJtZWRpYXRlcyhzZWxmKToKICAgICAgICAiIiIKICAgICAgICBBIGxpc3Qgb2YgYXNuMWNyeXB0by54NTA5LkNlcnRpZmljYXRlIG9iamVjdHMgdGhhdCB3ZXJlIHByZXNlbnRlZCBhcwogICAgICAgIGludGVybWVkaWF0ZXMgYnkgdGhlIHNlcnZlcgogICAgICAgICIiIgoKICAgICAgICBpZiBzZWxmLl9zc2wgaXMgTm9uZToKICAgICAgICAgICAgc2VsZi5fcmFpc2VfY2xvc2VkKCkKCiAgICAgICAgaWYgc2VsZi5fY2VydGlmaWNhdGUgaXMgTm9uZToKICAgICAgICAgICAgc2VsZi5fcmVhZF9jZXJ0aWZpY2F0ZXMoKQoKICAgICAgICByZXR1cm4gc2VsZi5faW50ZXJtZWRpYXRlcwoKICAgIEBwcm9wZXJ0eQogICAgZGVmIGNpcGhlcl9zdWl0ZShzZWxmKToKICAgICAgICAiIiIKICAgICAgICBBIHVuaWNvZGUgc3RyaW5nIG9mIHRoZSBJQU5BIGNpcGhlciBzdWl0ZSBuYW1lIG9mIHRoZSBuZWdvdGlhdGVkCiAgICAgICAgY2lwaGVyIHN1aXRlCiAgICAgICAgIiIiCgogICAgICAgIHJldHVybiBzZWxmLl9jaXBoZXJfc3VpdGUKCiAgICBAcHJvcGVydHkKICAgIGRlZiBwcm90b2NvbChzZWxmKToKICAgICAgICAiIiIKICAgICAgICBBIHVuaWNvZGUgc3RyaW5nIG9mOiAiVExTdjEuMiIsICJUTFN2MS4xIiwgIlRMU3YxIiwgIlNTTHYzIgogICAgICAgICIiIgoKICAgICAgICByZXR1cm4gc2VsZi5fcHJvdG9jb2wKCiAgICBAcHJvcGVydHkKICAgIGRlZiBjb21wcmVzc2lvbihzZWxmKToKICAgICAgICAiIiIKICAgICAgICBBIGJvb2xlYW4gaWYgY29tcHJlc3Npb24gaXMgZW5hYmxlZAogICAgICAgICIiIgoKICAgICAgICByZXR1cm4gc2VsZi5fY29tcHJlc3Npb24KCiAgICBAcHJvcGVydHkKICAgIGRlZiBzZXNzaW9uX2lkKHNlbGYpOgogICAgICAgICIiIgogICAgICAgIEEgdW5pY29kZSBzdHJpbmcgb2YgIm5ldyIgb3IgInJldXNlZCIgb3IgTm9uZSBmb3Igbm8gdGlja2V0CiAgICAgICAgIiIiCgogICAgICAgIHJldHVybiBzZWxmLl9zZXNzaW9uX2lkCgogICAgQHByb3BlcnR5CiAgICBkZWYgc2Vzc2lvbl90aWNrZXQoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgQSB1bmljb2RlIHN0cmluZyBvZiAibmV3IiBvciAicmV1c2VkIiBvciBOb25lIGZvciBubyB0aWNrZXQKICAgICAgICAiIiIKCiAgICAgICAgcmV0dXJuIHNlbGYuX3Nlc3Npb25fdGlja2V0CgogICAgQHByb3BlcnR5CiAgICBkZWYgc2Vzc2lvbihzZWxmKToKICAgICAgICAiIiIKICAgICAgICBUaGUgb3NjcnlwdG8udGxzLlRMU1Nlc3Npb24gb2JqZWN0IHVzZWQgZm9yIHRoaXMgY29ubmVjdGlvbgogICAgICAgICIiIgoKICAgICAgICByZXR1cm4gc2VsZi5fc2Vzc2lvbgoKICAgIEBwcm9wZXJ0eQogICAgZGVmIGhvc3RuYW1lKHNlbGYpOgogICAgICAgICIiIgogICAgICAgIEEgdW5pY29kZSBzdHJpbmcgb2YgdGhlIFRMUyBzZXJ2ZXIgZG9tYWluIG5hbWUgb3IgSVAgYWRkcmVzcwogICAgICAgICIiIgoKICAgICAgICByZXR1cm4gc2VsZi5faG9zdG5hbWUKCiAgICBAcHJvcGVydHkKICAgIGRlZiBwb3J0KHNlbGYpOgogICAgICAgICIiIgogICAgICAgIEFuIGludGVnZXIgb2YgdGhlIHBvcnQgbnVtYmVyIHRoZSBzb2NrZXQgaXMgY29ubmVjdGVkIHRvCiAgICAgICAgIiIiCgogICAgICAgIHJldHVybiBzZWxmLnNvY2tldC5nZXRwZWVybmFtZSgpWzFdCgogICAgQHByb3BlcnR5CiAgICBkZWYgc29ja2V0KHNlbGYpOgogICAgICAgICIiIgogICAgICAgIFRoZSB1bmRlcmx5aW5nIHNvY2tldC5zb2NrZXQgY29ubmVjdGlvbgogICAgICAgICIiIgoKICAgICAgICBpZiBzZWxmLl9zc2wgaXMgTm9uZToKICAgICAgICAgICAgc2VsZi5fcmFpc2VfY2xvc2VkKCkKCiAgICAgICAgcmV0dXJuIHNlbGYuX3NvY2tldAoKICAgIGRlZiBfX2RlbF9fKHNlbGYpOgogICAgICAgIHNlbGYuY2xvc2UoKQo=
