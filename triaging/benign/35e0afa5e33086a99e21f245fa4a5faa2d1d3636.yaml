statistics:
  total_files: 1
  skipped_files: 0.0
  processed_objects: 1
  malicious_objects: 0
details:
- path: .repo_cache/malicious_repos/pypi_malregistry/discord-py-v13/1.3/discord_py_v13-1.3-py3-none-any/discord-py-v13/http.py
  contents:
  - name: HTTPClient._token
    score: 0.0
    code: |-
      def _token(self, token, *, bot=True):
              self.token = token
              self.bot_token = bot
              self._ack_token = None
    tokens: resume load_fast token load_fast self store_attr token load_fast bot load_fast self store_attr bot_token load_const load_fast self store_attr _ack_token return_const None
    hash: f049ff6493df10c67c52552751ff435b43b658d3644ba58c233a81abc8f8c181
sources:
  .repo_cache/malicious_repos/pypi_malregistry/discord-py-v13/1.3/discord_py_v13-1.3-py3-none-any/discord-py-v13/http.py: IyAtKi0gY29kaW5nOiB1dGYtOCAtKi0KCiIiIgpUaGUgTUlUIExpY2Vuc2UgKE1JVCkKCkNvcHlyaWdodCAoYykgMjAxNS1wcmVzZW50IFJhcHB0egoKUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEKY29weSBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZSAiU29mdHdhcmUiKSwKdG8gZGVhbCBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbgp0aGUgcmlnaHRzIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwKYW5kL29yIHNlbGwgY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlClNvZnR3YXJlIGlzIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6CgpUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbgphbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KClRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTCk9SIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLApGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEUKQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUgpMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORwpGUk9NLCBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSCkRFQUxJTkdTIElOIFRIRSBTT0ZUV0FSRS4KIiIiCgppbXBvcnQgYXN5bmNpbwppbXBvcnQganNvbgppbXBvcnQgbG9nZ2luZwppbXBvcnQgc3lzCmZyb20gdXJsbGliLnBhcnNlIGltcG9ydCBxdW90ZSBhcyBfdXJpcXVvdGUKaW1wb3J0IHdlYWtyZWYKCmltcG9ydCBhaW9odHRwCgpmcm9tIC5lcnJvcnMgaW1wb3J0IEhUVFBFeGNlcHRpb24sIEZvcmJpZGRlbiwgTm90Rm91bmQsIExvZ2luRmFpbHVyZSwgRGlzY29yZFNlcnZlckVycm9yLCBHYXRld2F5Tm90Rm91bmQKZnJvbSAuZ2F0ZXdheSBpbXBvcnQgRGlzY29yZENsaWVudFdlYlNvY2tldFJlc3BvbnNlCmZyb20gLiBpbXBvcnQgX192ZXJzaW9uX18sIHV0aWxzCgpsb2cgPSBsb2dnaW5nLmdldExvZ2dlcihfX25hbWVfXykKCmFzeW5jIGRlZiBqc29uX29yX3RleHQocmVzcG9uc2UpOgogICAgdGV4dCA9IGF3YWl0IHJlc3BvbnNlLnRleHQoZW5jb2Rpbmc9J3V0Zi04JykKICAgIHRyeToKICAgICAgICBpZiByZXNwb25zZS5oZWFkZXJzWydjb250ZW50LXR5cGUnXSA9PSAnYXBwbGljYXRpb24vanNvbic6CiAgICAgICAgICAgIHJldHVybiBqc29uLmxvYWRzKHRleHQpCiAgICBleGNlcHQgS2V5RXJyb3I6CiAgICAgICAgIyBUaGFua3MgQ2xvdWRmbGFyZQogICAgICAgIHBhc3MKCiAgICByZXR1cm4gdGV4dAoKY2xhc3MgUm91dGU6CiAgICBCQVNFID0gJ2h0dHBzOi8vZGlzY29yZC5jb20vYXBpL3Y3JwoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBtZXRob2QsIHBhdGgsICoqcGFyYW1ldGVycyk6CiAgICAgICAgc2VsZi5wYXRoID0gcGF0aAogICAgICAgIHNlbGYubWV0aG9kID0gbWV0aG9kCiAgICAgICAgdXJsID0gKHNlbGYuQkFTRSArIHNlbGYucGF0aCkKICAgICAgICBpZiBwYXJhbWV0ZXJzOgogICAgICAgICAgICBzZWxmLnVybCA9IHVybC5mb3JtYXQoKip7azogX3VyaXF1b3RlKHYpIGlmIGlzaW5zdGFuY2Uodiwgc3RyKSBlbHNlIHYgZm9yIGssIHYgaW4gcGFyYW1ldGVycy5pdGVtcygpfSkKICAgICAgICBlbHNlOgogICAgICAgICAgICBzZWxmLnVybCA9IHVybAoKICAgICAgICAjIG1ham9yIHBhcmFtZXRlcnM6CiAgICAgICAgc2VsZi5jaGFubmVsX2lkID0gcGFyYW1ldGVycy5nZXQoJ2NoYW5uZWxfaWQnKQogICAgICAgIHNlbGYuZ3VpbGRfaWQgPSBwYXJhbWV0ZXJzLmdldCgnZ3VpbGRfaWQnKQoKICAgIEBwcm9wZXJ0eQogICAgZGVmIGJ1Y2tldChzZWxmKToKICAgICAgICAjIHRoZSBidWNrZXQgaXMganVzdCBtZXRob2QgKyBwYXRoIHcvIG1ham9yIHBhcmFtZXRlcnMKICAgICAgICByZXR1cm4gJ3swLmNoYW5uZWxfaWR9OnswLmd1aWxkX2lkfTp7MC5wYXRofScuZm9ybWF0KHNlbGYpCgpjbGFzcyBNYXliZVVubG9jazoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBsb2NrKToKICAgICAgICBzZWxmLmxvY2sgPSBsb2NrCiAgICAgICAgc2VsZi5fdW5sb2NrID0gVHJ1ZQoKICAgIGRlZiBfX2VudGVyX18oc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYKCiAgICBkZWYgZGVmZXIoc2VsZik6CiAgICAgICAgc2VsZi5fdW5sb2NrID0gRmFsc2UKCiAgICBkZWYgX19leGl0X18oc2VsZiwgdHlwZSwgdmFsdWUsIHRyYWNlYmFjayk6CiAgICAgICAgaWYgc2VsZi5fdW5sb2NrOgogICAgICAgICAgICBzZWxmLmxvY2sucmVsZWFzZSgpCgojIEZvciBzb21lIHJlYXNvbiwgdGhlIERpc2NvcmQgdm9pY2Ugd2Vic29ja2V0IGV4cGVjdHMgdGhpcyBoZWFkZXIgdG8gYmUKIyBjb21wbGV0ZWx5IGxvd2VyY2FzZSB3aGlsZSBhaW9odHRwIHJlc3BlY3RzIHNwZWMgYW5kIGRvZXMgaXQgYXMgY2FzZS1pbnNlbnNpdGl2ZQphaW9odHRwLmhkcnMuV0VCU09DS0VUID0gJ3dlYnNvY2tldCcKCmNsYXNzIEhUVFBDbGllbnQ6CiAgICAiIiJSZXByZXNlbnRzIGFuIEhUVFAgY2xpZW50IHNlbmRpbmcgSFRUUCByZXF1ZXN0cyB0byB0aGUgRGlzY29yZCBBUEkuIiIiCgogICAgU1VDQ0VTU19MT0cgPSAne21ldGhvZH0ge3VybH0gaGFzIHJlY2VpdmVkIHt0ZXh0fScKICAgIFJFUVVFU1RfTE9HID0gJ3ttZXRob2R9IHt1cmx9IHdpdGgge2pzb259IGhhcyByZXR1cm5lZCB7c3RhdHVzfScKCiAgICBkZWYgX19pbml0X18oc2VsZiwgY29ubmVjdG9yPU5vbmUsICosIHByb3h5PU5vbmUsIHByb3h5X2F1dGg9Tm9uZSwgbG9vcD1Ob25lLCB1bnN5bmNfY2xvY2s9VHJ1ZSk6CiAgICAgICAgc2VsZi5sb29wID0gYXN5bmNpby5nZXRfZXZlbnRfbG9vcCgpIGlmIGxvb3AgaXMgTm9uZSBlbHNlIGxvb3AKICAgICAgICBzZWxmLmNvbm5lY3RvciA9IGNvbm5lY3RvcgogICAgICAgIHNlbGYuX19zZXNzaW9uID0gTm9uZSAjIGZpbGxlZCBpbiBzdGF0aWNfbG9naW4KICAgICAgICBzZWxmLl9sb2NrcyA9IHdlYWtyZWYuV2Vha1ZhbHVlRGljdGlvbmFyeSgpCiAgICAgICAgc2VsZi5fZ2xvYmFsX292ZXIgPSBhc3luY2lvLkV2ZW50KCkKICAgICAgICBzZWxmLl9nbG9iYWxfb3Zlci5zZXQoKQogICAgICAgIHNlbGYudG9rZW4gPSBOb25lCiAgICAgICAgc2VsZi5ib3RfdG9rZW4gPSBGYWxzZQogICAgICAgIHNlbGYucHJveHkgPSBwcm94eQogICAgICAgIHNlbGYucHJveHlfYXV0aCA9IHByb3h5X2F1dGgKICAgICAgICBzZWxmLnVzZV9jbG9jayA9IG5vdCB1bnN5bmNfY2xvY2sKCiAgICAgICAgdXNlcl9hZ2VudCA9ICdEaXNjb3JkQm90IChodHRwczovL2dpdGh1Yi5jb20vUmFwcHR6L2Rpc2NvcmQucHkgezB9KSBQeXRob24vezFbMF19LnsxWzFdfSBhaW9odHRwL3syfScKICAgICAgICBzZWxmLnVzZXJfYWdlbnQgPSB1c2VyX2FnZW50LmZvcm1hdChfX3ZlcnNpb25fXywgc3lzLnZlcnNpb25faW5mbywgYWlvaHR0cC5fX3ZlcnNpb25fXykKCiAgICBkZWYgcmVjcmVhdGUoc2VsZik6CiAgICAgICAgaWYgc2VsZi5fX3Nlc3Npb24uY2xvc2VkOgogICAgICAgICAgICBzZWxmLl9fc2Vzc2lvbiA9IGFpb2h0dHAuQ2xpZW50U2Vzc2lvbihjb25uZWN0b3I9c2VsZi5jb25uZWN0b3IsIHdzX3Jlc3BvbnNlX2NsYXNzPURpc2NvcmRDbGllbnRXZWJTb2NrZXRSZXNwb25zZSkKCiAgICBhc3luYyBkZWYgd3NfY29ubmVjdChzZWxmLCB1cmwsICosIGNvbXByZXNzPTApOgogICAgICAgIGt3YXJncyA9IHsKICAgICAgICAgICAgJ3Byb3h5X2F1dGgnOiBzZWxmLnByb3h5X2F1dGgsCiAgICAgICAgICAgICdwcm94eSc6IHNlbGYucHJveHksCiAgICAgICAgICAgICdtYXhfbXNnX3NpemUnOiAwLAogICAgICAgICAgICAndGltZW91dCc6IDMwLjAsCiAgICAgICAgICAgICdhdXRvY2xvc2UnOiBGYWxzZSwKICAgICAgICAgICAgJ2hlYWRlcnMnOiB7CiAgICAgICAgICAgICAgICAnVXNlci1BZ2VudCc6IHNlbGYudXNlcl9hZ2VudCwKICAgICAgICAgICAgfSwKICAgICAgICAgICAgJ2NvbXByZXNzJzogY29tcHJlc3MKICAgICAgICB9CgogICAgICAgIHJldHVybiBhd2FpdCBzZWxmLl9fc2Vzc2lvbi53c19jb25uZWN0KHVybCwgKiprd2FyZ3MpCgogICAgYXN5bmMgZGVmIHJlcXVlc3Qoc2VsZiwgcm91dGUsICosIGZpbGVzPU5vbmUsIGZvcm09Tm9uZSwgKiprd2FyZ3MpOgogICAgICAgIGJ1Y2tldCA9IHJvdXRlLmJ1Y2tldAogICAgICAgIG1ldGhvZCA9IHJvdXRlLm1ldGhvZAogICAgICAgIHVybCA9IHJvdXRlLnVybAoKICAgICAgICBsb2NrID0gc2VsZi5fbG9ja3MuZ2V0KGJ1Y2tldCkKICAgICAgICBpZiBsb2NrIGlzIE5vbmU6CiAgICAgICAgICAgIGxvY2sgPSBhc3luY2lvLkxvY2soKQogICAgICAgICAgICBpZiBidWNrZXQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICBzZWxmLl9sb2Nrc1tidWNrZXRdID0gbG9jawoKICAgICAgICAjIGhlYWRlciBjcmVhdGlvbgogICAgICAgIGhlYWRlcnMgPSB7CiAgICAgICAgICAgICdVc2VyLUFnZW50Jzogc2VsZi51c2VyX2FnZW50LAogICAgICAgICAgICAnWC1SYXRlbGltaXQtUHJlY2lzaW9uJzogJ21pbGxpc2Vjb25kJywKICAgICAgICB9CgogICAgICAgIGlmIHNlbGYudG9rZW4gaXMgbm90IE5vbmU6CiAgICAgICAgICAgIGhlYWRlcnNbJ0F1dGhvcml6YXRpb24nXSA9ICdCb3QgJyArIHNlbGYudG9rZW4gaWYgc2VsZi5ib3RfdG9rZW4gZWxzZSBzZWxmLnRva2VuCiAgICAgICAgIyBzb21lIGNoZWNraW5nIGlmIGl0J3MgYSBKU09OIHJlcXVlc3QKICAgICAgICBpZiAnanNvbicgaW4ga3dhcmdzOgogICAgICAgICAgICBoZWFkZXJzWydDb250ZW50LVR5cGUnXSA9ICdhcHBsaWNhdGlvbi9qc29uJwogICAgICAgICAgICBrd2FyZ3NbJ2RhdGEnXSA9IHV0aWxzLnRvX2pzb24oa3dhcmdzLnBvcCgnanNvbicpKQoKICAgICAgICB0cnk6CiAgICAgICAgICAgIHJlYXNvbiA9IGt3YXJncy5wb3AoJ3JlYXNvbicpCiAgICAgICAgZXhjZXB0IEtleUVycm9yOgogICAgICAgICAgICBwYXNzCiAgICAgICAgZWxzZToKICAgICAgICAgICAgaWYgcmVhc29uOgogICAgICAgICAgICAgICAgaGVhZGVyc1snWC1BdWRpdC1Mb2ctUmVhc29uJ10gPSBfdXJpcXVvdGUocmVhc29uLCBzYWZlPScvICcpCgogICAgICAgIGt3YXJnc1snaGVhZGVycyddID0gaGVhZGVycwoKICAgICAgICAjIFByb3h5IHN1cHBvcnQKICAgICAgICBpZiBzZWxmLnByb3h5IGlzIG5vdCBOb25lOgogICAgICAgICAgICBrd2FyZ3NbJ3Byb3h5J10gPSBzZWxmLnByb3h5CiAgICAgICAgaWYgc2VsZi5wcm94eV9hdXRoIGlzIG5vdCBOb25lOgogICAgICAgICAgICBrd2FyZ3NbJ3Byb3h5X2F1dGgnXSA9IHNlbGYucHJveHlfYXV0aAoKICAgICAgICBpZiBub3Qgc2VsZi5fZ2xvYmFsX292ZXIuaXNfc2V0KCk6CiAgICAgICAgICAgICMgd2FpdCB1bnRpbCB0aGUgZ2xvYmFsIGxvY2sgaXMgY29tcGxldGUKICAgICAgICAgICAgYXdhaXQgc2VsZi5fZ2xvYmFsX292ZXIud2FpdCgpCgogICAgICAgIGF3YWl0IGxvY2suYWNxdWlyZSgpCiAgICAgICAgd2l0aCBNYXliZVVubG9jayhsb2NrKSBhcyBtYXliZV9sb2NrOgogICAgICAgICAgICBmb3IgdHJpZXMgaW4gcmFuZ2UoNSk6CiAgICAgICAgICAgICAgICBpZiBmaWxlczoKICAgICAgICAgICAgICAgICAgICBmb3IgZiBpbiBmaWxlczoKICAgICAgICAgICAgICAgICAgICAgICAgZi5yZXNldChzZWVrPXRyaWVzKQoKICAgICAgICAgICAgICAgIGlmIGZvcm06CiAgICAgICAgICAgICAgICAgICAgZm9ybV9kYXRhID0gYWlvaHR0cC5Gb3JtRGF0YSgpCiAgICAgICAgICAgICAgICAgICAgZm9yIHBhcmFtcyBpbiBmb3JtOgogICAgICAgICAgICAgICAgICAgICAgICBmb3JtX2RhdGEuYWRkX2ZpZWxkKCoqcGFyYW1zKQogICAgICAgICAgICAgICAgICAgIGt3YXJnc1snZGF0YSddID0gZm9ybV9kYXRhCgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIGFzeW5jIHdpdGggc2VsZi5fX3Nlc3Npb24ucmVxdWVzdChtZXRob2QsIHVybCwgKiprd2FyZ3MpIGFzIHI6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZy5kZWJ1ZygnJXMgJXMgd2l0aCAlcyBoYXMgcmV0dXJuZWQgJXMnLCBtZXRob2QsIHVybCwga3dhcmdzLmdldCgnZGF0YScpLCByLnN0YXR1cykKCiAgICAgICAgICAgICAgICAgICAgICAgICMgZXZlbiBlcnJvcnMgaGF2ZSB0ZXh0IGludm9sdmVkIGluIHRoZW0gc28gdGhpcyBpcyBzYWZlIHRvIGNhbGwKICAgICAgICAgICAgICAgICAgICAgICAgZGF0YSA9IGF3YWl0IGpzb25fb3JfdGV4dChyKQoKICAgICAgICAgICAgICAgICAgICAgICAgIyBjaGVjayBpZiB3ZSBoYXZlIHJhdGUgbGltaXQgaGVhZGVyIGluZm9ybWF0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgIHJlbWFpbmluZyA9IHIuaGVhZGVycy5nZXQoJ1gtUmF0ZWxpbWl0LVJlbWFpbmluZycpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHJlbWFpbmluZyA9PSAnMCcgYW5kIHIuc3RhdHVzICE9IDQyOToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgd2UndmUgZGVwbGV0ZWQgb3VyIGN1cnJlbnQgYnVja2V0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWx0YSA9IHV0aWxzLl9wYXJzZV9yYXRlbGltaXRfaGVhZGVyKHIsIHVzZV9jbG9jaz1zZWxmLnVzZV9jbG9jaykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZy5kZWJ1ZygnQSByYXRlIGxpbWl0IGJ1Y2tldCBoYXMgYmVlbiBleGhhdXN0ZWQgKGJ1Y2tldDogJXMsIHJldHJ5OiAlcykuJywgYnVja2V0LCBkZWx0YSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1heWJlX2xvY2suZGVmZXIoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5sb29wLmNhbGxfbGF0ZXIoZGVsdGEsIGxvY2sucmVsZWFzZSkKCiAgICAgICAgICAgICAgICAgICAgICAgICMgdGhlIHJlcXVlc3Qgd2FzIHN1Y2Nlc3NmdWwgc28ganVzdCByZXR1cm4gdGhlIHRleHQvanNvbgogICAgICAgICAgICAgICAgICAgICAgICBpZiAzMDAgPiByLnN0YXR1cyA+PSAyMDA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2cuZGVidWcoJyVzICVzIGhhcyByZWNlaXZlZCAlcycsIG1ldGhvZCwgdXJsLCBkYXRhKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRhdGEKCiAgICAgICAgICAgICAgICAgICAgICAgICMgd2UgYXJlIGJlaW5nIHJhdGUgbGltaXRlZAogICAgICAgICAgICAgICAgICAgICAgICBpZiByLnN0YXR1cyA9PSA0Mjk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBub3Qgci5oZWFkZXJzLmdldCgnVmlhJyk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIyBCYW5uZWQgYnkgQ2xvdWRmbGFyZSBtb3JlIHRoYW4gbGlrZWx5LgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhaXNlIEhUVFBFeGNlcHRpb24ociwgZGF0YSkKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbXQgPSAnV2UgYXJlIGJlaW5nIHJhdGUgbGltaXRlZC4gUmV0cnlpbmcgaW4gJS4yZiBzZWNvbmRzLiBIYW5kbGVkIHVuZGVyIHRoZSBidWNrZXQgIiVzIicKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIHNsZWVwIGEgYml0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXRyeV9hZnRlciA9IGRhdGFbJ3JldHJ5X2FmdGVyJ10gLyAxMDAwLjAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZy53YXJuaW5nKGZtdCwgcmV0cnlfYWZ0ZXIsIGJ1Y2tldCkKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIGNoZWNrIGlmIGl0J3MgYSBnbG9iYWwgcmF0ZSBsaW1pdAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaXNfZ2xvYmFsID0gZGF0YS5nZXQoJ2dsb2JhbCcsIEZhbHNlKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgaXNfZ2xvYmFsOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZy53YXJuaW5nKCdHbG9iYWwgcmF0ZSBsaW1pdCBoYXMgYmVlbiBoaXQuIFJldHJ5aW5nIGluICUuMmYgc2Vjb25kcy4nLCByZXRyeV9hZnRlcikKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLl9nbG9iYWxfb3Zlci5jbGVhcigpCgogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXdhaXQgYXN5bmNpby5zbGVlcChyZXRyeV9hZnRlcikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZy5kZWJ1ZygnRG9uZSBzbGVlcGluZyBmb3IgdGhlIHJhdGUgbGltaXQuIFJldHJ5aW5nLi4uJykKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIHJlbGVhc2UgdGhlIGdsb2JhbCBsb2NrIG5vdyB0aGF0IHRoZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgIyBnbG9iYWwgcmF0ZSBsaW1pdCBoYXMgcGFzc2VkCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBpc19nbG9iYWw6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fZ2xvYmFsX292ZXIuc2V0KCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2cuZGVidWcoJ0dsb2JhbCByYXRlIGxpbWl0IGlzIG5vdyBvdmVyLicpCgogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgICAgICAgICAgICAgICAgICMgd2UndmUgcmVjZWl2ZWQgYSA1MDAgb3IgNTAyLCB1bmNvbmRpdGlvbmFsIHJldHJ5CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHIuc3RhdHVzIGluIHs1MDAsIDUwMn06CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhd2FpdCBhc3luY2lvLnNsZWVwKDEgKyB0cmllcyAqIDIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZQoKICAgICAgICAgICAgICAgICAgICAgICAgIyB0aGUgdXN1YWwgZXJyb3IgY2FzZXMKICAgICAgICAgICAgICAgICAgICAgICAgaWYgci5zdGF0dXMgPT0gNDAzOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmFpc2UgRm9yYmlkZGVuKHIsIGRhdGEpCiAgICAgICAgICAgICAgICAgICAgICAgIGVsaWYgci5zdGF0dXMgPT0gNDA0OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmFpc2UgTm90Rm91bmQociwgZGF0YSkKICAgICAgICAgICAgICAgICAgICAgICAgZWxpZiByLnN0YXR1cyA9PSA1MDM6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByYWlzZSBEaXNjb3JkU2VydmVyRXJyb3IociwgZGF0YSkKICAgICAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhaXNlIEhUVFBFeGNlcHRpb24ociwgZGF0YSkKCiAgICAgICAgICAgICAgICAjIFRoaXMgaXMgaGFuZGxpbmcgZXhjZXB0aW9ucyBmcm9tIHRoZSByZXF1ZXN0CiAgICAgICAgICAgICAgICBleGNlcHQgT1NFcnJvciBhcyBlOgogICAgICAgICAgICAgICAgICAgICMgQ29ubmVjdGlvbiByZXNldCBieSBwZWVyCiAgICAgICAgICAgICAgICAgICAgaWYgdHJpZXMgPCA0IGFuZCBlLmVycm5vIGluICg1NCwgMTAwNTQpOgogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgICAgIHJhaXNlCgogICAgICAgICAgICAjIFdlJ3ZlIHJ1biBvdXQgb2YgcmV0cmllcywgcmFpc2UuCiAgICAgICAgICAgIGlmIHIuc3RhdHVzID49IDUwMDoKICAgICAgICAgICAgICAgIHJhaXNlIERpc2NvcmRTZXJ2ZXJFcnJvcihyLCBkYXRhKQoKICAgICAgICAgICAgcmFpc2UgSFRUUEV4Y2VwdGlvbihyLCBkYXRhKQoKICAgIGFzeW5jIGRlZiBnZXRfZnJvbV9jZG4oc2VsZiwgdXJsKToKICAgICAgICBhc3luYyB3aXRoIHNlbGYuX19zZXNzaW9uLmdldCh1cmwpIGFzIHJlc3A6CiAgICAgICAgICAgIGlmIHJlc3Auc3RhdHVzID09IDIwMDoKICAgICAgICAgICAgICAgIHJldHVybiBhd2FpdCByZXNwLnJlYWQoKQogICAgICAgICAgICBlbGlmIHJlc3Auc3RhdHVzID09IDQwNDoKICAgICAgICAgICAgICAgIHJhaXNlIE5vdEZvdW5kKHJlc3AsICdhc3NldCBub3QgZm91bmQnKQogICAgICAgICAgICBlbGlmIHJlc3Auc3RhdHVzID09IDQwMzoKICAgICAgICAgICAgICAgIHJhaXNlIEZvcmJpZGRlbihyZXNwLCAnY2Fubm90IHJldHJpZXZlIGFzc2V0JykKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHJhaXNlIEhUVFBFeGNlcHRpb24ocmVzcCwgJ2ZhaWxlZCB0byBnZXQgYXNzZXQnKQoKICAgICMgc3RhdGUgbWFuYWdlbWVudAoKICAgIGFzeW5jIGRlZiBjbG9zZShzZWxmKToKICAgICAgICBpZiBzZWxmLl9fc2Vzc2lvbjoKICAgICAgICAgICAgYXdhaXQgc2VsZi5fX3Nlc3Npb24uY2xvc2UoKQoKICAgIGRlZiBfdG9rZW4oc2VsZiwgdG9rZW4sICosIGJvdD1UcnVlKToKICAgICAgICBzZWxmLnRva2VuID0gdG9rZW4KICAgICAgICBzZWxmLmJvdF90b2tlbiA9IGJvdAogICAgICAgIHNlbGYuX2Fja190b2tlbiA9IE5vbmUKCiAgICAjIGxvZ2luIG1hbmFnZW1lbnQKCiAgICBhc3luYyBkZWYgc3RhdGljX2xvZ2luKHNlbGYsIHRva2VuLCAqLCBib3QpOgogICAgICAgICMgTmVjZXNzYXJ5IHRvIGdldCBhaW9odHRwIHRvIHN0b3AgY29tcGxhaW5pbmcgYWJvdXQgc2Vzc2lvbiBjcmVhdGlvbgogICAgICAgIHNlbGYuX19zZXNzaW9uID0gYWlvaHR0cC5DbGllbnRTZXNzaW9uKGNvbm5lY3Rvcj1zZWxmLmNvbm5lY3Rvciwgd3NfcmVzcG9uc2VfY2xhc3M9RGlzY29yZENsaWVudFdlYlNvY2tldFJlc3BvbnNlKQogICAgICAgIG9sZF90b2tlbiwgb2xkX2JvdCA9IHNlbGYudG9rZW4sIHNlbGYuYm90X3Rva2VuCiAgICAgICAgc2VsZi5fdG9rZW4odG9rZW4sIGJvdD1ib3QpCgogICAgICAgIHRyeToKICAgICAgICAgICAgZGF0YSA9IGF3YWl0IHNlbGYucmVxdWVzdChSb3V0ZSgnR0VUJywgJy91c2Vycy9AbWUnKSkKICAgICAgICBleGNlcHQgSFRUUEV4Y2VwdGlvbiBhcyBleGM6CiAgICAgICAgICAgIHNlbGYuX3Rva2VuKG9sZF90b2tlbiwgYm90PW9sZF9ib3QpCiAgICAgICAgICAgIGlmIGV4Yy5yZXNwb25zZS5zdGF0dXMgPT0gNDAxOgogICAgICAgICAgICAgICAgcmFpc2UgTG9naW5GYWlsdXJlKCdJbXByb3BlciB0b2tlbiBoYXMgYmVlbiBwYXNzZWQuJykgZnJvbSBleGMKICAgICAgICAgICAgcmFpc2UKCiAgICAgICAgcmV0dXJuIGRhdGEKCiAgICBkZWYgbG9nb3V0KHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLnJlcXVlc3QoUm91dGUoJ1BPU1QnLCAnL2F1dGgvbG9nb3V0JykpCgogICAgIyBHcm91cCBmdW5jdGlvbmFsaXR5CgogICAgZGVmIHN0YXJ0X2dyb3VwKHNlbGYsIHVzZXJfaWQsIHJlY2lwaWVudHMpOgogICAgICAgIHBheWxvYWQgPSB7CiAgICAgICAgICAgICdyZWNpcGllbnRzJzogcmVjaXBpZW50cwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHNlbGYucmVxdWVzdChSb3V0ZSgnUE9TVCcsICcvdXNlcnMve3VzZXJfaWR9L2NoYW5uZWxzJywgdXNlcl9pZD11c2VyX2lkKSwganNvbj1wYXlsb2FkKQoKICAgIGRlZiBsZWF2ZV9ncm91cChzZWxmLCBjaGFubmVsX2lkKToKICAgICAgICByZXR1cm4gc2VsZi5yZXF1ZXN0KFJvdXRlKCdERUxFVEUnLCAnL2NoYW5uZWxzL3tjaGFubmVsX2lkfScsIGNoYW5uZWxfaWQ9Y2hhbm5lbF9pZCkpCgogICAgZGVmIGFkZF9ncm91cF9yZWNpcGllbnQoc2VsZiwgY2hhbm5lbF9pZCwgdXNlcl9pZCk6CiAgICAgICAgciA9IFJvdXRlKCdQVVQnLCAnL2NoYW5uZWxzL3tjaGFubmVsX2lkfS9yZWNpcGllbnRzL3t1c2VyX2lkfScsIGNoYW5uZWxfaWQ9Y2hhbm5lbF9pZCwgdXNlcl9pZD11c2VyX2lkKQogICAgICAgIHJldHVybiBzZWxmLnJlcXVlc3QocikKCiAgICBkZWYgcmVtb3ZlX2dyb3VwX3JlY2lwaWVudChzZWxmLCBjaGFubmVsX2lkLCB1c2VyX2lkKToKICAgICAgICByID0gUm91dGUoJ0RFTEVURScsICcvY2hhbm5lbHMve2NoYW5uZWxfaWR9L3JlY2lwaWVudHMve3VzZXJfaWR9JywgY2hhbm5lbF9pZD1jaGFubmVsX2lkLCB1c2VyX2lkPXVzZXJfaWQpCiAgICAgICAgcmV0dXJuIHNlbGYucmVxdWVzdChyKQoKICAgIGRlZiBlZGl0X2dyb3VwKHNlbGYsIGNoYW5uZWxfaWQsICoqb3B0aW9ucyk6CiAgICAgICAgdmFsaWRfa2V5cyA9ICgnbmFtZScsICdpY29uJykKICAgICAgICBwYXlsb2FkID0gewogICAgICAgICAgICBrOiB2IGZvciBrLCB2IGluIG9wdGlvbnMuaXRlbXMoKSBpZiBrIGluIHZhbGlkX2tleXMKICAgICAgICB9CgogICAgICAgIHJldHVybiBzZWxmLnJlcXVlc3QoUm91dGUoJ1BBVENIJywgJy9jaGFubmVscy97Y2hhbm5lbF9pZH0nLCBjaGFubmVsX2lkPWNoYW5uZWxfaWQpLCBqc29uPXBheWxvYWQpCgogICAgZGVmIGNvbnZlcnRfZ3JvdXAoc2VsZiwgY2hhbm5lbF9pZCk6CiAgICAgICAgcmV0dXJuIHNlbGYucmVxdWVzdChSb3V0ZSgnUE9TVCcsICcvY2hhbm5lbHMve2NoYW5uZWxfaWR9L2NvbnZlcnQnLCBjaGFubmVsX2lkPWNoYW5uZWxfaWQpKQoKICAgICMgTWVzc2FnZSBtYW5hZ2VtZW50CgogICAgZGVmIHN0YXJ0X3ByaXZhdGVfbWVzc2FnZShzZWxmLCB1c2VyX2lkKToKICAgICAgICBwYXlsb2FkID0gewogICAgICAgICAgICAncmVjaXBpZW50X2lkJzogdXNlcl9pZAogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHNlbGYucmVxdWVzdChSb3V0ZSgnUE9TVCcsICcvdXNlcnMvQG1lL2NoYW5uZWxzJyksIGpzb249cGF5bG9hZCkKCiAgICBkZWYgc2VuZF9tZXNzYWdlKHNlbGYsIGNoYW5uZWxfaWQsIGNvbnRlbnQsICosIHR0cz1GYWxzZSwgZW1iZWQ9Tm9uZSwgbm9uY2U9Tm9uZSwgYWxsb3dlZF9tZW50aW9ucz1Ob25lLCBtZXNzYWdlX3JlZmVyZW5jZT1Ob25lKToKICAgICAgICByID0gUm91dGUoJ1BPU1QnLCAnL2NoYW5uZWxzL3tjaGFubmVsX2lkfS9tZXNzYWdlcycsIGNoYW5uZWxfaWQ9Y2hhbm5lbF9pZCkKICAgICAgICBwYXlsb2FkID0ge30KCiAgICAgICAgaWYgY29udGVudDoKICAgICAgICAgICAgcGF5bG9hZFsnY29udGVudCddID0gY29udGVudAoKICAgICAgICBpZiB0dHM6CiAgICAgICAgICAgIHBheWxvYWRbJ3R0cyddID0gVHJ1ZQoKICAgICAgICBpZiBlbWJlZDoKICAgICAgICAgICAgcGF5bG9hZFsnZW1iZWQnXSA9IGVtYmVkCgogICAgICAgIGlmIG5vbmNlOgogICAgICAgICAgICBwYXlsb2FkWydub25jZSddID0gbm9uY2UKCiAgICAgICAgaWYgYWxsb3dlZF9tZW50aW9uczoKICAgICAgICAgICAgcGF5bG9hZFsnYWxsb3dlZF9tZW50aW9ucyddID0gYWxsb3dlZF9tZW50aW9ucwoKICAgICAgICBpZiBtZXNzYWdlX3JlZmVyZW5jZToKICAgICAgICAgICAgcGF5bG9hZFsnbWVzc2FnZV9yZWZlcmVuY2UnXSA9IG1lc3NhZ2VfcmVmZXJlbmNlCgogICAgICAgIHJldHVybiBzZWxmLnJlcXVlc3QociwganNvbj1wYXlsb2FkKQoKICAgIGRlZiBzZW5kX3R5cGluZyhzZWxmLCBjaGFubmVsX2lkKToKICAgICAgICByZXR1cm4gc2VsZi5yZXF1ZXN0KFJvdXRlKCdQT1NUJywgJy9jaGFubmVscy97Y2hhbm5lbF9pZH0vdHlwaW5nJywgY2hhbm5lbF9pZD1jaGFubmVsX2lkKSkKCiAgICBkZWYgc2VuZF9maWxlcyhzZWxmLCBjaGFubmVsX2lkLCAqLCBmaWxlcywgY29udGVudD1Ob25lLCB0dHM9RmFsc2UsIGVtYmVkPU5vbmUsIG5vbmNlPU5vbmUsIGFsbG93ZWRfbWVudGlvbnM9Tm9uZSwgbWVzc2FnZV9yZWZlcmVuY2U9Tm9uZSk6CiAgICAgICAgciA9IFJvdXRlKCdQT1NUJywgJy9jaGFubmVscy97Y2hhbm5lbF9pZH0vbWVzc2FnZXMnLCBjaGFubmVsX2lkPWNoYW5uZWxfaWQpCiAgICAgICAgZm9ybSA9IFtdCgogICAgICAgIHBheWxvYWQgPSB7J3R0cyc6IHR0c30KICAgICAgICBpZiBjb250ZW50OgogICAgICAgICAgICBwYXlsb2FkWydjb250ZW50J10gPSBjb250ZW50CiAgICAgICAgaWYgZW1iZWQ6CiAgICAgICAgICAgIHBheWxvYWRbJ2VtYmVkJ10gPSBlbWJlZAogICAgICAgIGlmIG5vbmNlOgogICAgICAgICAgICBwYXlsb2FkWydub25jZSddID0gbm9uY2UKICAgICAgICBpZiBhbGxvd2VkX21lbnRpb25zOgogICAgICAgICAgICBwYXlsb2FkWydhbGxvd2VkX21lbnRpb25zJ10gPSBhbGxvd2VkX21lbnRpb25zCiAgICAgICAgaWYgbWVzc2FnZV9yZWZlcmVuY2U6CiAgICAgICAgICAgIHBheWxvYWRbJ21lc3NhZ2VfcmVmZXJlbmNlJ10gPSBtZXNzYWdlX3JlZmVyZW5jZQoKICAgICAgICBmb3JtLmFwcGVuZCh7J25hbWUnOiAncGF5bG9hZF9qc29uJywgJ3ZhbHVlJzogdXRpbHMudG9fanNvbihwYXlsb2FkKX0pCiAgICAgICAgaWYgbGVuKGZpbGVzKSA9PSAxOgogICAgICAgICAgICBmaWxlID0gZmlsZXNbMF0KICAgICAgICAgICAgZm9ybS5hcHBlbmQoewogICAgICAgICAgICAgICAgJ25hbWUnOiAnZmlsZScsCiAgICAgICAgICAgICAgICAndmFsdWUnOiBmaWxlLmZwLAogICAgICAgICAgICAgICAgJ2ZpbGVuYW1lJzogZmlsZS5maWxlbmFtZSwKICAgICAgICAgICAgICAgICdjb250ZW50X3R5cGUnOiAnYXBwbGljYXRpb24vb2N0ZXQtc3RyZWFtJwogICAgICAgICAgICB9KQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGZvciBpbmRleCwgZmlsZSBpbiBlbnVtZXJhdGUoZmlsZXMpOgogICAgICAgICAgICAgICAgZm9ybS5hcHBlbmQoewogICAgICAgICAgICAgICAgICAgICduYW1lJzogJ2ZpbGUlcycgJSBpbmRleCwKICAgICAgICAgICAgICAgICAgICAndmFsdWUnOiBmaWxlLmZwLAogICAgICAgICAgICAgICAgICAgICdmaWxlbmFtZSc6IGZpbGUuZmlsZW5hbWUsCiAgICAgICAgICAgICAgICAgICAgJ2NvbnRlbnRfdHlwZSc6ICdhcHBsaWNhdGlvbi9vY3RldC1zdHJlYW0nCiAgICAgICAgICAgICAgICB9KQoKICAgICAgICByZXR1cm4gc2VsZi5yZXF1ZXN0KHIsIGZvcm09Zm9ybSwgZmlsZXM9ZmlsZXMpCgogICAgYXN5bmMgZGVmIGFja19tZXNzYWdlKHNlbGYsIGNoYW5uZWxfaWQsIG1lc3NhZ2VfaWQpOgogICAgICAgIHIgPSBSb3V0ZSgnUE9TVCcsICcvY2hhbm5lbHMve2NoYW5uZWxfaWR9L21lc3NhZ2VzL3ttZXNzYWdlX2lkfS9hY2snLCBjaGFubmVsX2lkPWNoYW5uZWxfaWQsIG1lc3NhZ2VfaWQ9bWVzc2FnZV9pZCkKICAgICAgICBkYXRhID0gYXdhaXQgc2VsZi5yZXF1ZXN0KHIsIGpzb249eyd0b2tlbic6IHNlbGYuX2Fja190b2tlbn0pCiAgICAgICAgc2VsZi5fYWNrX3Rva2VuID0gZGF0YVsndG9rZW4nXQoKICAgIGRlZiBhY2tfZ3VpbGQoc2VsZiwgZ3VpbGRfaWQpOgogICAgICAgIHJldHVybiBzZWxmLnJlcXVlc3QoUm91dGUoJ1BPU1QnLCAnL2d1aWxkcy97Z3VpbGRfaWR9L2FjaycsIGd1aWxkX2lkPWd1aWxkX2lkKSkKCiAgICBkZWYgZGVsZXRlX21lc3NhZ2Uoc2VsZiwgY2hhbm5lbF9pZCwgbWVzc2FnZV9pZCwgKiwgcmVhc29uPU5vbmUpOgogICAgICAgIHIgPSBSb3V0ZSgnREVMRVRFJywgJy9jaGFubmVscy97Y2hhbm5lbF9pZH0vbWVzc2FnZXMve21lc3NhZ2VfaWR9JywgY2hhbm5lbF9pZD1jaGFubmVsX2lkLCBtZXNzYWdlX2lkPW1lc3NhZ2VfaWQpCiAgICAgICAgcmV0dXJuIHNlbGYucmVxdWVzdChyLCByZWFzb249cmVhc29uKQoKICAgIGRlZiBkZWxldGVfbWVzc2FnZXMoc2VsZiwgY2hhbm5lbF9pZCwgbWVzc2FnZV9pZHMsICosIHJlYXNvbj1Ob25lKToKICAgICAgICByID0gUm91dGUoJ1BPU1QnLCAnL2NoYW5uZWxzL3tjaGFubmVsX2lkfS9tZXNzYWdlcy9idWxrX2RlbGV0ZScsIGNoYW5uZWxfaWQ9Y2hhbm5lbF9pZCkKICAgICAgICBwYXlsb2FkID0gewogICAgICAgICAgICAnbWVzc2FnZXMnOiBtZXNzYWdlX2lkcwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHNlbGYucmVxdWVzdChyLCBqc29uPXBheWxvYWQsIHJlYXNvbj1yZWFzb24pCgogICAgZGVmIGVkaXRfbWVzc2FnZShzZWxmLCBjaGFubmVsX2lkLCBtZXNzYWdlX2lkLCAqKmZpZWxkcyk6CiAgICAgICAgciA9IFJvdXRlKCdQQVRDSCcsICcvY2hhbm5lbHMve2NoYW5uZWxfaWR9L21lc3NhZ2VzL3ttZXNzYWdlX2lkfScsIGNoYW5uZWxfaWQ9Y2hhbm5lbF9pZCwgbWVzc2FnZV9pZD1tZXNzYWdlX2lkKQogICAgICAgIHJldHVybiBzZWxmLnJlcXVlc3QociwganNvbj1maWVsZHMpCgogICAgZGVmIGFkZF9yZWFjdGlvbihzZWxmLCBjaGFubmVsX2lkLCBtZXNzYWdlX2lkLCBlbW9qaSk6CiAgICAgICAgciA9IFJvdXRlKCdQVVQnLCAnL2NoYW5uZWxzL3tjaGFubmVsX2lkfS9tZXNzYWdlcy97bWVzc2FnZV9pZH0vcmVhY3Rpb25zL3tlbW9qaX0vQG1lJywKICAgICAgICAgICAgICAgICAgY2hhbm5lbF9pZD1jaGFubmVsX2lkLCBtZXNzYWdlX2lkPW1lc3NhZ2VfaWQsIGVtb2ppPWVtb2ppKQogICAgICAgIHJldHVybiBzZWxmLnJlcXVlc3QocikKCiAgICBkZWYgcmVtb3ZlX3JlYWN0aW9uKHNlbGYsIGNoYW5uZWxfaWQsIG1lc3NhZ2VfaWQsIGVtb2ppLCBtZW1iZXJfaWQpOgogICAgICAgIHIgPSBSb3V0ZSgnREVMRVRFJywgJy9jaGFubmVscy97Y2hhbm5lbF9pZH0vbWVzc2FnZXMve21lc3NhZ2VfaWR9L3JlYWN0aW9ucy97ZW1vaml9L3ttZW1iZXJfaWR9JywKICAgICAgICAgICAgICAgICAgY2hhbm5lbF9pZD1jaGFubmVsX2lkLCBtZXNzYWdlX2lkPW1lc3NhZ2VfaWQsIG1lbWJlcl9pZD1tZW1iZXJfaWQsIGVtb2ppPWVtb2ppKQogICAgICAgIHJldHVybiBzZWxmLnJlcXVlc3QocikKCiAgICBkZWYgcmVtb3ZlX293bl9yZWFjdGlvbihzZWxmLCBjaGFubmVsX2lkLCBtZXNzYWdlX2lkLCBlbW9qaSk6CiAgICAgICAgciA9IFJvdXRlKCdERUxFVEUnLCAnL2NoYW5uZWxzL3tjaGFubmVsX2lkfS9tZXNzYWdlcy97bWVzc2FnZV9pZH0vcmVhY3Rpb25zL3tlbW9qaX0vQG1lJywKICAgICAgICAgICAgICAgICAgY2hhbm5lbF9pZD1jaGFubmVsX2lkLCBtZXNzYWdlX2lkPW1lc3NhZ2VfaWQsIGVtb2ppPWVtb2ppKQogICAgICAgIHJldHVybiBzZWxmLnJlcXVlc3QocikKCiAgICBkZWYgZ2V0X3JlYWN0aW9uX3VzZXJzKHNlbGYsIGNoYW5uZWxfaWQsIG1lc3NhZ2VfaWQsIGVtb2ppLCBsaW1pdCwgYWZ0ZXI9Tm9uZSk6CiAgICAgICAgciA9IFJvdXRlKCdHRVQnLCAnL2NoYW5uZWxzL3tjaGFubmVsX2lkfS9tZXNzYWdlcy97bWVzc2FnZV9pZH0vcmVhY3Rpb25zL3tlbW9qaX0nLAogICAgICAgICAgICAgICAgICBjaGFubmVsX2lkPWNoYW5uZWxfaWQsIG1lc3NhZ2VfaWQ9bWVzc2FnZV9pZCwgZW1vamk9ZW1vamkpCgogICAgICAgIHBhcmFtcyA9IHsnbGltaXQnOiBsaW1pdH0KICAgICAgICBpZiBhZnRlcjoKICAgICAgICAgICAgcGFyYW1zWydhZnRlciddID0gYWZ0ZXIKICAgICAgICByZXR1cm4gc2VsZi5yZXF1ZXN0KHIsIHBhcmFtcz1wYXJhbXMpCgogICAgZGVmIGNsZWFyX3JlYWN0aW9ucyhzZWxmLCBjaGFubmVsX2lkLCBtZXNzYWdlX2lkKToKICAgICAgICByID0gUm91dGUoJ0RFTEVURScsICcvY2hhbm5lbHMve2NoYW5uZWxfaWR9L21lc3NhZ2VzL3ttZXNzYWdlX2lkfS9yZWFjdGlvbnMnLAogICAgICAgICAgICAgICAgICBjaGFubmVsX2lkPWNoYW5uZWxfaWQsIG1lc3NhZ2VfaWQ9bWVzc2FnZV9pZCkKCiAgICAgICAgcmV0dXJuIHNlbGYucmVxdWVzdChyKQoKICAgIGRlZiBjbGVhcl9zaW5nbGVfcmVhY3Rpb24oc2VsZiwgY2hhbm5lbF9pZCwgbWVzc2FnZV9pZCwgZW1vamkpOgogICAgICAgIHIgPSBSb3V0ZSgnREVMRVRFJywgJy9jaGFubmVscy97Y2hhbm5lbF9pZH0vbWVzc2FnZXMve21lc3NhZ2VfaWR9L3JlYWN0aW9ucy97ZW1vaml9JywKICAgICAgICAgICAgICAgICAgIGNoYW5uZWxfaWQ9Y2hhbm5lbF9pZCwgbWVzc2FnZV9pZD1tZXNzYWdlX2lkLCBlbW9qaT1lbW9qaSkKICAgICAgICByZXR1cm4gc2VsZi5yZXF1ZXN0KHIpCgogICAgZGVmIGdldF9tZXNzYWdlKHNlbGYsIGNoYW5uZWxfaWQsIG1lc3NhZ2VfaWQpOgogICAgICAgIHIgPSBSb3V0ZSgnR0VUJywgJy9jaGFubmVscy97Y2hhbm5lbF9pZH0vbWVzc2FnZXMve21lc3NhZ2VfaWR9JywgY2hhbm5lbF9pZD1jaGFubmVsX2lkLCBtZXNzYWdlX2lkPW1lc3NhZ2VfaWQpCiAgICAgICAgcmV0dXJuIHNlbGYucmVxdWVzdChyKQoKICAgIGRlZiBnZXRfY2hhbm5lbChzZWxmLCBjaGFubmVsX2lkKToKICAgICAgICByID0gUm91dGUoJ0dFVCcsICcvY2hhbm5lbHMve2NoYW5uZWxfaWR9JywgY2hhbm5lbF9pZD1jaGFubmVsX2lkKQogICAgICAgIHJldHVybiBzZWxmLnJlcXVlc3QocikKCiAgICBkZWYgbG9nc19mcm9tKHNlbGYsIGNoYW5uZWxfaWQsIGxpbWl0LCBiZWZvcmU9Tm9uZSwgYWZ0ZXI9Tm9uZSwgYXJvdW5kPU5vbmUpOgogICAgICAgIHBhcmFtcyA9IHsKICAgICAgICAgICAgJ2xpbWl0JzogbGltaXQKICAgICAgICB9CgogICAgICAgIGlmIGJlZm9yZSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcGFyYW1zWydiZWZvcmUnXSA9IGJlZm9yZQogICAgICAgIGlmIGFmdGVyIGlzIG5vdCBOb25lOgogICAgICAgICAgICBwYXJhbXNbJ2FmdGVyJ10gPSBhZnRlcgogICAgICAgIGlmIGFyb3VuZCBpcyBub3QgTm9uZToKICAgICAgICAgICAgcGFyYW1zWydhcm91bmQnXSA9IGFyb3VuZAoKICAgICAgICByZXR1cm4gc2VsZi5yZXF1ZXN0KFJvdXRlKCdHRVQnLCAnL2NoYW5uZWxzL3tjaGFubmVsX2lkfS9tZXNzYWdlcycsIGNoYW5uZWxfaWQ9Y2hhbm5lbF9pZCksIHBhcmFtcz1wYXJhbXMpCgogICAgZGVmIHB1Ymxpc2hfbWVzc2FnZShzZWxmLCBjaGFubmVsX2lkLCBtZXNzYWdlX2lkKToKICAgICAgICByZXR1cm4gc2VsZi5yZXF1ZXN0KFJvdXRlKCdQT1NUJywgJy9jaGFubmVscy97Y2hhbm5lbF9pZH0vbWVzc2FnZXMve21lc3NhZ2VfaWR9L2Nyb3NzcG9zdCcsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGFubmVsX2lkPWNoYW5uZWxfaWQsIG1lc3NhZ2VfaWQ9bWVzc2FnZV9pZCkpCgogICAgZGVmIHBpbl9tZXNzYWdlKHNlbGYsIGNoYW5uZWxfaWQsIG1lc3NhZ2VfaWQsIHJlYXNvbj1Ob25lKToKICAgICAgICByZXR1cm4gc2VsZi5yZXF1ZXN0KFJvdXRlKCdQVVQnLCAnL2NoYW5uZWxzL3tjaGFubmVsX2lkfS9waW5zL3ttZXNzYWdlX2lkfScsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGFubmVsX2lkPWNoYW5uZWxfaWQsIG1lc3NhZ2VfaWQ9bWVzc2FnZV9pZCksIHJlYXNvbj1yZWFzb24pCgogICAgZGVmIHVucGluX21lc3NhZ2Uoc2VsZiwgY2hhbm5lbF9pZCwgbWVzc2FnZV9pZCwgcmVhc29uPU5vbmUpOgogICAgICAgIHJldHVybiBzZWxmLnJlcXVlc3QoUm91dGUoJ0RFTEVURScsICcvY2hhbm5lbHMve2NoYW5uZWxfaWR9L3BpbnMve21lc3NhZ2VfaWR9JywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoYW5uZWxfaWQ9Y2hhbm5lbF9pZCwgbWVzc2FnZV9pZD1tZXNzYWdlX2lkKSwgcmVhc29uPXJlYXNvbikKCiAgICBkZWYgcGluc19mcm9tKHNlbGYsIGNoYW5uZWxfaWQpOgogICAgICAgIHJldHVybiBzZWxmLnJlcXVlc3QoUm91dGUoJ0dFVCcsICcvY2hhbm5lbHMve2NoYW5uZWxfaWR9L3BpbnMnLCBjaGFubmVsX2lkPWNoYW5uZWxfaWQpKQoKICAgICMgTWVtYmVyIG1hbmFnZW1lbnQKCiAgICBkZWYga2ljayhzZWxmLCB1c2VyX2lkLCBndWlsZF9pZCwgcmVhc29uPU5vbmUpOgogICAgICAgIHIgPSBSb3V0ZSgnREVMRVRFJywgJy9ndWlsZHMve2d1aWxkX2lkfS9tZW1iZXJzL3t1c2VyX2lkfScsIGd1aWxkX2lkPWd1aWxkX2lkLCB1c2VyX2lkPXVzZXJfaWQpCiAgICAgICAgaWYgcmVhc29uOgogICAgICAgICAgICAjIHRoYW5rcyBhaW9odHRwCiAgICAgICAgICAgIHIudXJsID0gJ3swLnVybH0/cmVhc29uPXsxfScuZm9ybWF0KHIsIF91cmlxdW90ZShyZWFzb24pKQoKICAgICAgICByZXR1cm4gc2VsZi5yZXF1ZXN0KHIpCgogICAgZGVmIGJhbihzZWxmLCB1c2VyX2lkLCBndWlsZF9pZCwgZGVsZXRlX21lc3NhZ2VfZGF5cz0xLCByZWFzb249Tm9uZSk6CiAgICAgICAgciA9IFJvdXRlKCdQVVQnLCAnL2d1aWxkcy97Z3VpbGRfaWR9L2JhbnMve3VzZXJfaWR9JywgZ3VpbGRfaWQ9Z3VpbGRfaWQsIHVzZXJfaWQ9dXNlcl9pZCkKICAgICAgICBwYXJhbXMgPSB7CiAgICAgICAgICAgICdkZWxldGVfbWVzc2FnZV9kYXlzJzogZGVsZXRlX21lc3NhZ2VfZGF5cywKICAgICAgICB9CgogICAgICAgIGlmIHJlYXNvbjoKICAgICAgICAgICAgIyB0aGFua3MgYWlvaHR0cAogICAgICAgICAgICByLnVybCA9ICd7MC51cmx9P3JlYXNvbj17MX0nLmZvcm1hdChyLCBfdXJpcXVvdGUocmVhc29uKSkKCiAgICAgICAgcmV0dXJuIHNlbGYucmVxdWVzdChyLCBwYXJhbXM9cGFyYW1zKQoKICAgIGRlZiB1bmJhbihzZWxmLCB1c2VyX2lkLCBndWlsZF9pZCwgKiwgcmVhc29uPU5vbmUpOgogICAgICAgIHIgPSBSb3V0ZSgnREVMRVRFJywgJy9ndWlsZHMve2d1aWxkX2lkfS9iYW5zL3t1c2VyX2lkfScsIGd1aWxkX2lkPWd1aWxkX2lkLCB1c2VyX2lkPXVzZXJfaWQpCiAgICAgICAgcmV0dXJuIHNlbGYucmVxdWVzdChyLCByZWFzb249cmVhc29uKQoKICAgIGRlZiBndWlsZF92b2ljZV9zdGF0ZShzZWxmLCB1c2VyX2lkLCBndWlsZF9pZCwgKiwgbXV0ZT1Ob25lLCBkZWFmZW49Tm9uZSwgcmVhc29uPU5vbmUpOgogICAgICAgIHIgPSBSb3V0ZSgnUEFUQ0gnLCAnL2d1aWxkcy97Z3VpbGRfaWR9L21lbWJlcnMve3VzZXJfaWR9JywgZ3VpbGRfaWQ9Z3VpbGRfaWQsIHVzZXJfaWQ9dXNlcl9pZCkKICAgICAgICBwYXlsb2FkID0ge30KICAgICAgICBpZiBtdXRlIGlzIG5vdCBOb25lOgogICAgICAgICAgICBwYXlsb2FkWydtdXRlJ10gPSBtdXRlCgogICAgICAgIGlmIGRlYWZlbiBpcyBub3QgTm9uZToKICAgICAgICAgICAgcGF5bG9hZFsnZGVhZiddID0gZGVhZmVuCgogICAgICAgIHJldHVybiBzZWxmLnJlcXVlc3QociwganNvbj1wYXlsb2FkLCByZWFzb249cmVhc29uKQoKICAgIGRlZiBlZGl0X3Byb2ZpbGUoc2VsZiwgcGFzc3dvcmQsIHVzZXJuYW1lLCBhdmF0YXIsICoqZmllbGRzKToKICAgICAgICBwYXlsb2FkID0gewogICAgICAgICAgICAncGFzc3dvcmQnOiBwYXNzd29yZCwKICAgICAgICAgICAgJ3VzZXJuYW1lJzogdXNlcm5hbWUsCiAgICAgICAgICAgICdhdmF0YXInOiBhdmF0YXIKICAgICAgICB9CgogICAgICAgIGlmICdlbWFpbCcgaW4gZmllbGRzOgogICAgICAgICAgICBwYXlsb2FkWydlbWFpbCddID0gZmllbGRzWydlbWFpbCddCgogICAgICAgIGlmICduZXdfcGFzc3dvcmQnIGluIGZpZWxkczoKICAgICAgICAgICAgcGF5bG9hZFsnbmV3X3Bhc3N3b3JkJ10gPSBmaWVsZHNbJ25ld19wYXNzd29yZCddCgogICAgICAgIHJldHVybiBzZWxmLnJlcXVlc3QoUm91dGUoJ1BBVENIJywgJy91c2Vycy9AbWUnKSwganNvbj1wYXlsb2FkKQoKICAgIGRlZiBjaGFuZ2VfbXlfbmlja25hbWUoc2VsZiwgZ3VpbGRfaWQsIG5pY2tuYW1lLCAqLCByZWFzb249Tm9uZSk6CiAgICAgICAgciA9IFJvdXRlKCdQQVRDSCcsICcvZ3VpbGRzL3tndWlsZF9pZH0vbWVtYmVycy9AbWUvbmljaycsIGd1aWxkX2lkPWd1aWxkX2lkKQogICAgICAgIHBheWxvYWQgPSB7CiAgICAgICAgICAgICduaWNrJzogbmlja25hbWUKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHNlbGYucmVxdWVzdChyLCBqc29uPXBheWxvYWQsIHJlYXNvbj1yZWFzb24pCgogICAgZGVmIGNoYW5nZV9uaWNrbmFtZShzZWxmLCBndWlsZF9pZCwgdXNlcl9pZCwgbmlja25hbWUsICosIHJlYXNvbj1Ob25lKToKICAgICAgICByID0gUm91dGUoJ1BBVENIJywgJy9ndWlsZHMve2d1aWxkX2lkfS9tZW1iZXJzL3t1c2VyX2lkfScsIGd1aWxkX2lkPWd1aWxkX2lkLCB1c2VyX2lkPXVzZXJfaWQpCiAgICAgICAgcGF5bG9hZCA9IHsKICAgICAgICAgICAgJ25pY2snOiBuaWNrbmFtZQogICAgICAgIH0KICAgICAgICByZXR1cm4gc2VsZi5yZXF1ZXN0KHIsIGpzb249cGF5bG9hZCwgcmVhc29uPXJlYXNvbikKCiAgICBkZWYgZWRpdF9teV92b2ljZV9zdGF0ZShzZWxmLCBndWlsZF9pZCwgcGF5bG9hZCk6CiAgICAgICAgciA9IFJvdXRlKCdQQVRDSCcsICcvZ3VpbGRzL3tndWlsZF9pZH0vdm9pY2Utc3RhdGVzL0BtZScsIGd1aWxkX2lkPWd1aWxkX2lkKQogICAgICAgIHJldHVybiBzZWxmLnJlcXVlc3QociwganNvbj1wYXlsb2FkKQoKICAgIGRlZiBlZGl0X3ZvaWNlX3N0YXRlKHNlbGYsIGd1aWxkX2lkLCB1c2VyX2lkLCBwYXlsb2FkKToKICAgICAgICByID0gUm91dGUoJ1BBVENIJywgJy9ndWlsZHMve2d1aWxkX2lkfS92b2ljZS1zdGF0ZXMve3VzZXJfaWR9JywgZ3VpbGRfaWQ9Z3VpbGRfaWQsIHVzZXJfaWQ9dXNlcl9pZCkKICAgICAgICByZXR1cm4gc2VsZi5yZXF1ZXN0KHIsIGpzb249cGF5bG9hZCkKCiAgICBkZWYgZWRpdF9tZW1iZXIoc2VsZiwgZ3VpbGRfaWQsIHVzZXJfaWQsICosIHJlYXNvbj1Ob25lLCAqKmZpZWxkcyk6CiAgICAgICAgciA9IFJvdXRlKCdQQVRDSCcsICcvZ3VpbGRzL3tndWlsZF9pZH0vbWVtYmVycy97dXNlcl9pZH0nLCBndWlsZF9pZD1ndWlsZF9pZCwgdXNlcl9pZD11c2VyX2lkKQogICAgICAgIHJldHVybiBzZWxmLnJlcXVlc3QociwganNvbj1maWVsZHMsIHJlYXNvbj1yZWFzb24pCgogICAgIyBDaGFubmVsIG1hbmFnZW1lbnQKCiAgICBkZWYgZWRpdF9jaGFubmVsKHNlbGYsIGNoYW5uZWxfaWQsICosIHJlYXNvbj1Ob25lLCAqKm9wdGlvbnMpOgogICAgICAgIHIgPSBSb3V0ZSgnUEFUQ0gnLCAnL2NoYW5uZWxzL3tjaGFubmVsX2lkfScsIGNoYW5uZWxfaWQ9Y2hhbm5lbF9pZCkKICAgICAgICB2YWxpZF9rZXlzID0gKCduYW1lJywgJ3BhcmVudF9pZCcsICd0b3BpYycsICdiaXRyYXRlJywgJ25zZncnLAogICAgICAgICAgICAgICAgICAgICAgJ3VzZXJfbGltaXQnLCAncG9zaXRpb24nLCAncGVybWlzc2lvbl9vdmVyd3JpdGVzJywgJ3JhdGVfbGltaXRfcGVyX3VzZXInLAogICAgICAgICAgICAgICAgICAgICAgJ3R5cGUnLCAncnRjX3JlZ2lvbicpCiAgICAgICAgcGF5bG9hZCA9IHsKICAgICAgICAgICAgazogdiBmb3IgaywgdiBpbiBvcHRpb25zLml0ZW1zKCkgaWYgayBpbiB2YWxpZF9rZXlzCiAgICAgICAgfQogICAgICAgIHJldHVybiBzZWxmLnJlcXVlc3QociwgcmVhc29uPXJlYXNvbiwganNvbj1wYXlsb2FkKQoKICAgIGRlZiBidWxrX2NoYW5uZWxfdXBkYXRlKHNlbGYsIGd1aWxkX2lkLCBkYXRhLCAqLCByZWFzb249Tm9uZSk6CiAgICAgICAgciA9IFJvdXRlKCdQQVRDSCcsICcvZ3VpbGRzL3tndWlsZF9pZH0vY2hhbm5lbHMnLCBndWlsZF9pZD1ndWlsZF9pZCkKICAgICAgICByZXR1cm4gc2VsZi5yZXF1ZXN0KHIsIGpzb249ZGF0YSwgcmVhc29uPXJlYXNvbikKCiAgICBkZWYgY3JlYXRlX2NoYW5uZWwoc2VsZiwgZ3VpbGRfaWQsIGNoYW5uZWxfdHlwZSwgKiwgcmVhc29uPU5vbmUsICoqb3B0aW9ucyk6CiAgICAgICAgcGF5bG9hZCA9IHsKICAgICAgICAgICAgJ3R5cGUnOiBjaGFubmVsX3R5cGUKICAgICAgICB9CgogICAgICAgIHZhbGlkX2tleXMgPSAoJ25hbWUnLCAncGFyZW50X2lkJywgJ3RvcGljJywgJ2JpdHJhdGUnLCAnbnNmdycsCiAgICAgICAgICAgICAgICAgICAgICAndXNlcl9saW1pdCcsICdwb3NpdGlvbicsICdwZXJtaXNzaW9uX292ZXJ3cml0ZXMnLCAncmF0ZV9saW1pdF9wZXJfdXNlcicsCiAgICAgICAgICAgICAgICAgICAgICAncnRjX3JlZ2lvbicpCiAgICAgICAgcGF5bG9hZC51cGRhdGUoewogICAgICAgICAgICBrOiB2IGZvciBrLCB2IGluIG9wdGlvbnMuaXRlbXMoKSBpZiBrIGluIHZhbGlkX2tleXMgYW5kIHYgaXMgbm90IE5vbmUKICAgICAgICB9KQoKICAgICAgICByZXR1cm4gc2VsZi5yZXF1ZXN0KFJvdXRlKCdQT1NUJywgJy9ndWlsZHMve2d1aWxkX2lkfS9jaGFubmVscycsIGd1aWxkX2lkPWd1aWxkX2lkKSwganNvbj1wYXlsb2FkLCByZWFzb249cmVhc29uKQoKICAgIGRlZiBkZWxldGVfY2hhbm5lbChzZWxmLCBjaGFubmVsX2lkLCAqLCByZWFzb249Tm9uZSk6CiAgICAgICAgcmV0dXJuIHNlbGYucmVxdWVzdChSb3V0ZSgnREVMRVRFJywgJy9jaGFubmVscy97Y2hhbm5lbF9pZH0nLCBjaGFubmVsX2lkPWNoYW5uZWxfaWQpLCByZWFzb249cmVhc29uKQoKICAgICMgV2ViaG9vayBtYW5hZ2VtZW50CgogICAgZGVmIGNyZWF0ZV93ZWJob29rKHNlbGYsIGNoYW5uZWxfaWQsICosIG5hbWUsIGF2YXRhcj1Ob25lLCByZWFzb249Tm9uZSk6CiAgICAgICAgcGF5bG9hZCA9IHsKICAgICAgICAgICAgJ25hbWUnOiBuYW1lCiAgICAgICAgfQogICAgICAgIGlmIGF2YXRhciBpcyBub3QgTm9uZToKICAgICAgICAgICAgcGF5bG9hZFsnYXZhdGFyJ10gPSBhdmF0YXIKCiAgICAgICAgciA9IFJvdXRlKCdQT1NUJywgJy9jaGFubmVscy97Y2hhbm5lbF9pZH0vd2ViaG9va3MnLCBjaGFubmVsX2lkPWNoYW5uZWxfaWQpCiAgICAgICAgcmV0dXJuIHNlbGYucmVxdWVzdChyLCBqc29uPXBheWxvYWQsIHJlYXNvbj1yZWFzb24pCgogICAgZGVmIGNoYW5uZWxfd2ViaG9va3Moc2VsZiwgY2hhbm5lbF9pZCk6CiAgICAgICAgcmV0dXJuIHNlbGYucmVxdWVzdChSb3V0ZSgnR0VUJywgJy9jaGFubmVscy97Y2hhbm5lbF9pZH0vd2ViaG9va3MnLCBjaGFubmVsX2lkPWNoYW5uZWxfaWQpKQoKICAgIGRlZiBndWlsZF93ZWJob29rcyhzZWxmLCBndWlsZF9pZCk6CiAgICAgICAgcmV0dXJuIHNlbGYucmVxdWVzdChSb3V0ZSgnR0VUJywgJy9ndWlsZHMve2d1aWxkX2lkfS93ZWJob29rcycsIGd1aWxkX2lkPWd1aWxkX2lkKSkKCiAgICBkZWYgZ2V0X3dlYmhvb2soc2VsZiwgd2ViaG9va19pZCk6CiAgICAgICAgcmV0dXJuIHNlbGYucmVxdWVzdChSb3V0ZSgnR0VUJywgJy93ZWJob29rcy97d2ViaG9va19pZH0nLCB3ZWJob29rX2lkPXdlYmhvb2tfaWQpKQoKICAgIGRlZiBmb2xsb3dfd2ViaG9vayhzZWxmLCBjaGFubmVsX2lkLCB3ZWJob29rX2NoYW5uZWxfaWQsIHJlYXNvbj1Ob25lKToKICAgICAgICBwYXlsb2FkID0gewogICAgICAgICAgICAnd2ViaG9va19jaGFubmVsX2lkJzogc3RyKHdlYmhvb2tfY2hhbm5lbF9pZCkKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHNlbGYucmVxdWVzdChSb3V0ZSgnUE9TVCcsICcvY2hhbm5lbHMve2NoYW5uZWxfaWR9L2ZvbGxvd2VycycsIGNoYW5uZWxfaWQ9Y2hhbm5lbF9pZCksIGpzb249cGF5bG9hZCwgcmVhc29uPXJlYXNvbikKCiAgICAjIEd1aWxkIG1hbmFnZW1lbnQKCiAgICBkZWYgZ2V0X2d1aWxkcyhzZWxmLCBsaW1pdCwgYmVmb3JlPU5vbmUsIGFmdGVyPU5vbmUpOgogICAgICAgIHBhcmFtcyA9IHsKICAgICAgICAgICAgJ2xpbWl0JzogbGltaXQKICAgICAgICB9CgogICAgICAgIGlmIGJlZm9yZToKICAgICAgICAgICAgcGFyYW1zWydiZWZvcmUnXSA9IGJlZm9yZQogICAgICAgIGlmIGFmdGVyOgogICAgICAgICAgICBwYXJhbXNbJ2FmdGVyJ10gPSBhZnRlcgoKICAgICAgICByZXR1cm4gc2VsZi5yZXF1ZXN0KFJvdXRlKCdHRVQnLCAnL3VzZXJzL0BtZS9ndWlsZHMnKSwgcGFyYW1zPXBhcmFtcykKCiAgICBkZWYgbGVhdmVfZ3VpbGQoc2VsZiwgZ3VpbGRfaWQpOgogICAgICAgIHJldHVybiBzZWxmLnJlcXVlc3QoUm91dGUoJ0RFTEVURScsICcvdXNlcnMvQG1lL2d1aWxkcy97Z3VpbGRfaWR9JywgZ3VpbGRfaWQ9Z3VpbGRfaWQpKQoKICAgIGRlZiBnZXRfZ3VpbGQoc2VsZiwgZ3VpbGRfaWQpOgogICAgICAgIHJldHVybiBzZWxmLnJlcXVlc3QoUm91dGUoJ0dFVCcsICcvZ3VpbGRzL3tndWlsZF9pZH0nLCBndWlsZF9pZD1ndWlsZF9pZCkpCgogICAgZGVmIGRlbGV0ZV9ndWlsZChzZWxmLCBndWlsZF9pZCk6CiAgICAgICAgcmV0dXJuIHNlbGYucmVxdWVzdChSb3V0ZSgnREVMRVRFJywgJy9ndWlsZHMve2d1aWxkX2lkfScsIGd1aWxkX2lkPWd1aWxkX2lkKSkKCiAgICBkZWYgY3JlYXRlX2d1aWxkKHNlbGYsIG5hbWUsIHJlZ2lvbiwgaWNvbik6CiAgICAgICAgcGF5bG9hZCA9IHsKICAgICAgICAgICAgJ25hbWUnOiBuYW1lLAogICAgICAgICAgICAnaWNvbic6IGljb24sCiAgICAgICAgICAgICdyZWdpb24nOiByZWdpb24KICAgICAgICB9CgogICAgICAgIHJldHVybiBzZWxmLnJlcXVlc3QoUm91dGUoJ1BPU1QnLCAnL2d1aWxkcycpLCBqc29uPXBheWxvYWQpCgogICAgZGVmIGVkaXRfZ3VpbGQoc2VsZiwgZ3VpbGRfaWQsICosIHJlYXNvbj1Ob25lLCAqKmZpZWxkcyk6CiAgICAgICAgdmFsaWRfa2V5cyA9ICgnbmFtZScsICdyZWdpb24nLCAnaWNvbicsICdhZmtfdGltZW91dCcsICdvd25lcl9pZCcsCiAgICAgICAgICAgICAgICAgICAgICAnYWZrX2NoYW5uZWxfaWQnLCAnc3BsYXNoJywgJ3ZlcmlmaWNhdGlvbl9sZXZlbCcsCiAgICAgICAgICAgICAgICAgICAgICAnc3lzdGVtX2NoYW5uZWxfaWQnLCAnZGVmYXVsdF9tZXNzYWdlX25vdGlmaWNhdGlvbnMnLAogICAgICAgICAgICAgICAgICAgICAgJ2Rlc2NyaXB0aW9uJywgJ2V4cGxpY2l0X2NvbnRlbnRfZmlsdGVyJywgJ2Jhbm5lcicsCiAgICAgICAgICAgICAgICAgICAgICAnc3lzdGVtX2NoYW5uZWxfZmxhZ3MnLCAncnVsZXNfY2hhbm5lbF9pZCcsCiAgICAgICAgICAgICAgICAgICAgICAncHVibGljX3VwZGF0ZXNfY2hhbm5lbF9pZCcsICdwcmVmZXJyZWRfbG9jYWxlJywpCgogICAgICAgIHBheWxvYWQgPSB7CiAgICAgICAgICAgIGs6IHYgZm9yIGssIHYgaW4gZmllbGRzLml0ZW1zKCkgaWYgayBpbiB2YWxpZF9rZXlzCiAgICAgICAgfQoKICAgICAgICByZXR1cm4gc2VsZi5yZXF1ZXN0KFJvdXRlKCdQQVRDSCcsICcvZ3VpbGRzL3tndWlsZF9pZH0nLCBndWlsZF9pZD1ndWlsZF9pZCksIGpzb249cGF5bG9hZCwgcmVhc29uPXJlYXNvbikKCiAgICBkZWYgZ2V0X3RlbXBsYXRlKHNlbGYsIGNvZGUpOgogICAgICAgIHJldHVybiBzZWxmLnJlcXVlc3QoUm91dGUoJ0dFVCcsICcvZ3VpbGRzL3RlbXBsYXRlcy97Y29kZX0nLCBjb2RlPWNvZGUpKQoKICAgIGRlZiBndWlsZF90ZW1wbGF0ZXMoc2VsZiwgZ3VpbGRfaWQpOgogICAgICAgIHJldHVybiBzZWxmLnJlcXVlc3QoUm91dGUoJ0dFVCcsICcvZ3VpbGRzL3tndWlsZF9pZH0vdGVtcGxhdGVzJywgZ3VpbGRfaWQ9Z3VpbGRfaWQpKQoKICAgIGRlZiBjcmVhdGVfdGVtcGxhdGUoc2VsZiwgZ3VpbGRfaWQsIHBheWxvYWQpOgogICAgICAgIHJldHVybiBzZWxmLnJlcXVlc3QoUm91dGUoJ1BPU1QnLCAnL2d1aWxkcy97Z3VpbGRfaWR9L3RlbXBsYXRlcycsIGd1aWxkX2lkPWd1aWxkX2lkKSwganNvbj1wYXlsb2FkKQoKICAgIGRlZiBzeW5jX3RlbXBsYXRlKHNlbGYsIGd1aWxkX2lkLCBjb2RlKToKICAgICAgICByZXR1cm4gc2VsZi5yZXF1ZXN0KFJvdXRlKCdQVVQnLCAnL2d1aWxkcy97Z3VpbGRfaWR9L3RlbXBsYXRlcy97Y29kZX0nLCBndWlsZF9pZD1ndWlsZF9pZCwgY29kZT1jb2RlKSkKCiAgICBkZWYgZWRpdF90ZW1wbGF0ZShzZWxmLCBndWlsZF9pZCwgY29kZSwgcGF5bG9hZCk6CiAgICAgICAgdmFsaWRfa2V5cyA9ICgKICAgICAgICAgICAgJ25hbWUnLAogICAgICAgICAgICAnZGVzY3JpcHRpb24nLAogICAgICAgICkKICAgICAgICBwYXlsb2FkID0gewogICAgICAgICAgICBrOiB2IGZvciBrLCB2IGluIHBheWxvYWQuaXRlbXMoKSBpZiBrIGluIHZhbGlkX2tleXMKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHNlbGYucmVxdWVzdChSb3V0ZSgnUEFUQ0gnLCAnL2d1aWxkcy97Z3VpbGRfaWR9L3RlbXBsYXRlcy97Y29kZX0nLCBndWlsZF9pZD1ndWlsZF9pZCwgY29kZT1jb2RlKSwganNvbj1wYXlsb2FkKQoKICAgIGRlZiBkZWxldGVfdGVtcGxhdGUoc2VsZiwgZ3VpbGRfaWQsIGNvZGUpOgogICAgICAgIHJldHVybiBzZWxmLnJlcXVlc3QoUm91dGUoJ0RFTEVURScsICcvZ3VpbGRzL3tndWlsZF9pZH0vdGVtcGxhdGVzL3tjb2RlfScsIGd1aWxkX2lkPWd1aWxkX2lkLCBjb2RlPWNvZGUpKQoKICAgIGRlZiBjcmVhdGVfZnJvbV90ZW1wbGF0ZShzZWxmLCBjb2RlLCBuYW1lLCByZWdpb24sIGljb24pOgogICAgICAgIHBheWxvYWQgPSB7CiAgICAgICAgICAgICduYW1lJzogbmFtZSwKICAgICAgICAgICAgJ2ljb24nOiBpY29uLAogICAgICAgICAgICAncmVnaW9uJzogcmVnaW9uCiAgICAgICAgfQogICAgICAgIHJldHVybiBzZWxmLnJlcXVlc3QoUm91dGUoJ1BPU1QnLCAnL2d1aWxkcy90ZW1wbGF0ZXMve2NvZGV9JywgY29kZT1jb2RlKSwganNvbj1wYXlsb2FkKQoKICAgIGRlZiBnZXRfYmFucyhzZWxmLCBndWlsZF9pZCk6CiAgICAgICAgcmV0dXJuIHNlbGYucmVxdWVzdChSb3V0ZSgnR0VUJywgJy9ndWlsZHMve2d1aWxkX2lkfS9iYW5zJywgZ3VpbGRfaWQ9Z3VpbGRfaWQpKQoKICAgIGRlZiBnZXRfYmFuKHNlbGYsIHVzZXJfaWQsIGd1aWxkX2lkKToKICAgICAgICByZXR1cm4gc2VsZi5yZXF1ZXN0KFJvdXRlKCdHRVQnLCAnL2d1aWxkcy97Z3VpbGRfaWR9L2JhbnMve3VzZXJfaWR9JywgZ3VpbGRfaWQ9Z3VpbGRfaWQsIHVzZXJfaWQ9dXNlcl9pZCkpCgogICAgZGVmIGdldF92YW5pdHlfY29kZShzZWxmLCBndWlsZF9pZCk6CiAgICAgICAgcmV0dXJuIHNlbGYucmVxdWVzdChSb3V0ZSgnR0VUJywgJy9ndWlsZHMve2d1aWxkX2lkfS92YW5pdHktdXJsJywgZ3VpbGRfaWQ9Z3VpbGRfaWQpKQoKICAgIGRlZiBjaGFuZ2VfdmFuaXR5X2NvZGUoc2VsZiwgZ3VpbGRfaWQsIGNvZGUsICosIHJlYXNvbj1Ob25lKToKICAgICAgICBwYXlsb2FkID0geydjb2RlJzogY29kZX0KICAgICAgICByZXR1cm4gc2VsZi5yZXF1ZXN0KFJvdXRlKCdQQVRDSCcsICcvZ3VpbGRzL3tndWlsZF9pZH0vdmFuaXR5LXVybCcsIGd1aWxkX2lkPWd1aWxkX2lkKSwganNvbj1wYXlsb2FkLCByZWFzb249cmVhc29uKQoKICAgIGRlZiBnZXRfYWxsX2d1aWxkX2NoYW5uZWxzKHNlbGYsIGd1aWxkX2lkKToKICAgICAgICByZXR1cm4gc2VsZi5yZXF1ZXN0KFJvdXRlKCdHRVQnLCAnL2d1aWxkcy97Z3VpbGRfaWR9L2NoYW5uZWxzJywgZ3VpbGRfaWQ9Z3VpbGRfaWQpKQoKICAgIGRlZiBnZXRfbWVtYmVycyhzZWxmLCBndWlsZF9pZCwgbGltaXQsIGFmdGVyKToKICAgICAgICBwYXJhbXMgPSB7CiAgICAgICAgICAgICdsaW1pdCc6IGxpbWl0LAogICAgICAgIH0KICAgICAgICBpZiBhZnRlcjoKICAgICAgICAgICAgcGFyYW1zWydhZnRlciddID0gYWZ0ZXIKCiAgICAgICAgciA9IFJvdXRlKCdHRVQnLCAnL2d1aWxkcy97Z3VpbGRfaWR9L21lbWJlcnMnLCBndWlsZF9pZD1ndWlsZF9pZCkKICAgICAgICByZXR1cm4gc2VsZi5yZXF1ZXN0KHIsIHBhcmFtcz1wYXJhbXMpCgogICAgZGVmIGdldF9tZW1iZXIoc2VsZiwgZ3VpbGRfaWQsIG1lbWJlcl9pZCk6CiAgICAgICAgcmV0dXJuIHNlbGYucmVxdWVzdChSb3V0ZSgnR0VUJywgJy9ndWlsZHMve2d1aWxkX2lkfS9tZW1iZXJzL3ttZW1iZXJfaWR9JywgZ3VpbGRfaWQ9Z3VpbGRfaWQsIG1lbWJlcl9pZD1tZW1iZXJfaWQpKQoKICAgIGRlZiBwcnVuZV9tZW1iZXJzKHNlbGYsIGd1aWxkX2lkLCBkYXlzLCBjb21wdXRlX3BydW5lX2NvdW50LCByb2xlcywgKiwgcmVhc29uPU5vbmUpOgogICAgICAgIHBheWxvYWQgPSB7CiAgICAgICAgICAgICdkYXlzJzogZGF5cywKICAgICAgICAgICAgJ2NvbXB1dGVfcHJ1bmVfY291bnQnOiAndHJ1ZScgaWYgY29tcHV0ZV9wcnVuZV9jb3VudCBlbHNlICdmYWxzZScKICAgICAgICB9CiAgICAgICAgaWYgcm9sZXM6CiAgICAgICAgICAgIHBheWxvYWRbJ2luY2x1ZGVfcm9sZXMnXSA9ICcsICcuam9pbihyb2xlcykKCiAgICAgICAgcmV0dXJuIHNlbGYucmVxdWVzdChSb3V0ZSgnUE9TVCcsICcvZ3VpbGRzL3tndWlsZF9pZH0vcHJ1bmUnLCBndWlsZF9pZD1ndWlsZF9pZCksIGpzb249cGF5bG9hZCwgcmVhc29uPXJlYXNvbikKCiAgICBkZWYgZXN0aW1hdGVfcHJ1bmVkX21lbWJlcnMoc2VsZiwgZ3VpbGRfaWQsIGRheXMsIHJvbGVzKToKICAgICAgICBwYXJhbXMgPSB7CiAgICAgICAgICAgICdkYXlzJzogZGF5cwogICAgICAgIH0KICAgICAgICBpZiByb2xlczoKICAgICAgICAgICAgcGFyYW1zWydpbmNsdWRlX3JvbGVzJ10gPSAnLCAnLmpvaW4ocm9sZXMpCgogICAgICAgIHJldHVybiBzZWxmLnJlcXVlc3QoUm91dGUoJ0dFVCcsICcvZ3VpbGRzL3tndWlsZF9pZH0vcHJ1bmUnLCBndWlsZF9pZD1ndWlsZF9pZCksIHBhcmFtcz1wYXJhbXMpCgogICAgZGVmIGdldF9hbGxfY3VzdG9tX2Vtb2ppcyhzZWxmLCBndWlsZF9pZCk6CiAgICAgICAgcmV0dXJuIHNlbGYucmVxdWVzdChSb3V0ZSgnR0VUJywgJy9ndWlsZHMve2d1aWxkX2lkfS9lbW9qaXMnLCBndWlsZF9pZD1ndWlsZF9pZCkpCgogICAgZGVmIGdldF9jdXN0b21fZW1vamkoc2VsZiwgZ3VpbGRfaWQsIGVtb2ppX2lkKToKICAgICAgICByZXR1cm4gc2VsZi5yZXF1ZXN0KFJvdXRlKCdHRVQnLCAnL2d1aWxkcy97Z3VpbGRfaWR9L2Vtb2ppcy97ZW1vamlfaWR9JywgZ3VpbGRfaWQ9Z3VpbGRfaWQsIGVtb2ppX2lkPWVtb2ppX2lkKSkKCiAgICBkZWYgY3JlYXRlX2N1c3RvbV9lbW9qaShzZWxmLCBndWlsZF9pZCwgbmFtZSwgaW1hZ2UsICosIHJvbGVzPU5vbmUsIHJlYXNvbj1Ob25lKToKICAgICAgICBwYXlsb2FkID0gewogICAgICAgICAgICAnbmFtZSc6IG5hbWUsCiAgICAgICAgICAgICdpbWFnZSc6IGltYWdlLAogICAgICAgICAgICAncm9sZXMnOiByb2xlcyBvciBbXQogICAgICAgIH0KCiAgICAgICAgciA9IFJvdXRlKCdQT1NUJywgJy9ndWlsZHMve2d1aWxkX2lkfS9lbW9qaXMnLCBndWlsZF9pZD1ndWlsZF9pZCkKICAgICAgICByZXR1cm4gc2VsZi5yZXF1ZXN0KHIsIGpzb249cGF5bG9hZCwgcmVhc29uPXJlYXNvbikKCiAgICBkZWYgZGVsZXRlX2N1c3RvbV9lbW9qaShzZWxmLCBndWlsZF9pZCwgZW1vamlfaWQsICosIHJlYXNvbj1Ob25lKToKICAgICAgICByID0gUm91dGUoJ0RFTEVURScsICcvZ3VpbGRzL3tndWlsZF9pZH0vZW1vamlzL3tlbW9qaV9pZH0nLCBndWlsZF9pZD1ndWlsZF9pZCwgZW1vamlfaWQ9ZW1vamlfaWQpCiAgICAgICAgcmV0dXJuIHNlbGYucmVxdWVzdChyLCByZWFzb249cmVhc29uKQoKICAgIGRlZiBlZGl0X2N1c3RvbV9lbW9qaShzZWxmLCBndWlsZF9pZCwgZW1vamlfaWQsICosIG5hbWUsIHJvbGVzPU5vbmUsIHJlYXNvbj1Ob25lKToKICAgICAgICBwYXlsb2FkID0gewogICAgICAgICAgICAnbmFtZSc6IG5hbWUsCiAgICAgICAgICAgICdyb2xlcyc6IHJvbGVzIG9yIFtdCiAgICAgICAgfQogICAgICAgIHIgPSBSb3V0ZSgnUEFUQ0gnLCAnL2d1aWxkcy97Z3VpbGRfaWR9L2Vtb2ppcy97ZW1vamlfaWR9JywgZ3VpbGRfaWQ9Z3VpbGRfaWQsIGVtb2ppX2lkPWVtb2ppX2lkKQogICAgICAgIHJldHVybiBzZWxmLnJlcXVlc3QociwganNvbj1wYXlsb2FkLCByZWFzb249cmVhc29uKQoKICAgIGRlZiBnZXRfYWxsX2ludGVncmF0aW9ucyhzZWxmLCBndWlsZF9pZCk6CiAgICAgICAgciA9IFJvdXRlKCdHRVQnLCAnL2d1aWxkcy97Z3VpbGRfaWR9L2ludGVncmF0aW9ucycsIGd1aWxkX2lkPWd1aWxkX2lkKQoKICAgICAgICByZXR1cm4gc2VsZi5yZXF1ZXN0KHIpCgogICAgZGVmIGNyZWF0ZV9pbnRlZ3JhdGlvbihzZWxmLCBndWlsZF9pZCwgdHlwZSwgaWQpOgogICAgICAgIHBheWxvYWQgPSB7CiAgICAgICAgICAgICd0eXBlJzogdHlwZSwKICAgICAgICAgICAgJ2lkJzogaWQKICAgICAgICB9CgogICAgICAgIHIgPSBSb3V0ZSgnUE9TVCcsICcvZ3VpbGRzL3tndWlsZF9pZH0vaW50ZWdyYXRpb25zJywgZ3VpbGRfaWQ9Z3VpbGRfaWQpCiAgICAgICAgcmV0dXJuIHNlbGYucmVxdWVzdChyLCBqc29uPXBheWxvYWQpCgogICAgZGVmIGVkaXRfaW50ZWdyYXRpb24oc2VsZiwgZ3VpbGRfaWQsIGludGVncmF0aW9uX2lkLCAqKnBheWxvYWQpOgogICAgICAgIHIgPSBSb3V0ZSgnUEFUQ0gnLCAnL2d1aWxkcy97Z3VpbGRfaWR9L2ludGVncmF0aW9ucy97aW50ZWdyYXRpb25faWR9JywgZ3VpbGRfaWQ9Z3VpbGRfaWQsCiAgICAgICAgICAgICAgICAgIGludGVncmF0aW9uX2lkPWludGVncmF0aW9uX2lkKQoKICAgICAgICByZXR1cm4gc2VsZi5yZXF1ZXN0KHIsIGpzb249cGF5bG9hZCkKCiAgICBkZWYgc3luY19pbnRlZ3JhdGlvbihzZWxmLCBndWlsZF9pZCwgaW50ZWdyYXRpb25faWQpOgogICAgICAgIHIgPSBSb3V0ZSgnUE9TVCcsICcvZ3VpbGRzL3tndWlsZF9pZH0vaW50ZWdyYXRpb25zL3tpbnRlZ3JhdGlvbl9pZH0vc3luYycsIGd1aWxkX2lkPWd1aWxkX2lkLAogICAgICAgICAgICAgICAgICBpbnRlZ3JhdGlvbl9pZD1pbnRlZ3JhdGlvbl9pZCkKCiAgICAgICAgcmV0dXJuIHNlbGYucmVxdWVzdChyKQoKICAgIGRlZiBkZWxldGVfaW50ZWdyYXRpb24oc2VsZiwgZ3VpbGRfaWQsIGludGVncmF0aW9uX2lkKToKICAgICAgICByID0gUm91dGUoJ0RFTEVURScsICcvZ3VpbGRzL3tndWlsZF9pZH0vaW50ZWdyYXRpb25zL3tpbnRlZ3JhdGlvbl9pZH0nLCBndWlsZF9pZD1ndWlsZF9pZCwKICAgICAgICAgICAgICAgICAgaW50ZWdyYXRpb25faWQ9aW50ZWdyYXRpb25faWQpCgogICAgICAgIHJldHVybiBzZWxmLnJlcXVlc3QocikKCiAgICBkZWYgZ2V0X2F1ZGl0X2xvZ3Moc2VsZiwgZ3VpbGRfaWQsIGxpbWl0PTEwMCwgYmVmb3JlPU5vbmUsIGFmdGVyPU5vbmUsIHVzZXJfaWQ9Tm9uZSwgYWN0aW9uX3R5cGU9Tm9uZSk6CiAgICAgICAgcGFyYW1zID0geydsaW1pdCc6IGxpbWl0fQogICAgICAgIGlmIGJlZm9yZToKICAgICAgICAgICAgcGFyYW1zWydiZWZvcmUnXSA9IGJlZm9yZQogICAgICAgIGlmIGFmdGVyOgogICAgICAgICAgICBwYXJhbXNbJ2FmdGVyJ10gPSBhZnRlcgogICAgICAgIGlmIHVzZXJfaWQ6CiAgICAgICAgICAgIHBhcmFtc1sndXNlcl9pZCddID0gdXNlcl9pZAogICAgICAgIGlmIGFjdGlvbl90eXBlOgogICAgICAgICAgICBwYXJhbXNbJ2FjdGlvbl90eXBlJ10gPSBhY3Rpb25fdHlwZQoKICAgICAgICByID0gUm91dGUoJ0dFVCcsICcvZ3VpbGRzL3tndWlsZF9pZH0vYXVkaXQtbG9ncycsIGd1aWxkX2lkPWd1aWxkX2lkKQogICAgICAgIHJldHVybiBzZWxmLnJlcXVlc3QociwgcGFyYW1zPXBhcmFtcykKCiAgICBkZWYgZ2V0X3dpZGdldChzZWxmLCBndWlsZF9pZCk6CiAgICAgICAgcmV0dXJuIHNlbGYucmVxdWVzdChSb3V0ZSgnR0VUJywgJy9ndWlsZHMve2d1aWxkX2lkfS93aWRnZXQuanNvbicsIGd1aWxkX2lkPWd1aWxkX2lkKSkKCiAgICAjIEludml0ZSBtYW5hZ2VtZW50CgogICAgZGVmIGNyZWF0ZV9pbnZpdGUoc2VsZiwgY2hhbm5lbF9pZCwgKiwgcmVhc29uPU5vbmUsICoqb3B0aW9ucyk6CiAgICAgICAgciA9IFJvdXRlKCdQT1NUJywgJy9jaGFubmVscy97Y2hhbm5lbF9pZH0vaW52aXRlcycsIGNoYW5uZWxfaWQ9Y2hhbm5lbF9pZCkKICAgICAgICBwYXlsb2FkID0gewogICAgICAgICAgICAnbWF4X2FnZSc6IG9wdGlvbnMuZ2V0KCdtYXhfYWdlJywgMCksCiAgICAgICAgICAgICdtYXhfdXNlcyc6IG9wdGlvbnMuZ2V0KCdtYXhfdXNlcycsIDApLAogICAgICAgICAgICAndGVtcG9yYXJ5Jzogb3B0aW9ucy5nZXQoJ3RlbXBvcmFyeScsIEZhbHNlKSwKICAgICAgICAgICAgJ3VuaXF1ZSc6IG9wdGlvbnMuZ2V0KCd1bmlxdWUnLCBUcnVlKQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHNlbGYucmVxdWVzdChyLCByZWFzb249cmVhc29uLCBqc29uPXBheWxvYWQpCgogICAgZGVmIGdldF9pbnZpdGUoc2VsZiwgaW52aXRlX2lkLCAqLCB3aXRoX2NvdW50cz1UcnVlKToKICAgICAgICBwYXJhbXMgPSB7CiAgICAgICAgICAgICd3aXRoX2NvdW50cyc6IGludCh3aXRoX2NvdW50cykKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHNlbGYucmVxdWVzdChSb3V0ZSgnR0VUJywgJy9pbnZpdGVzL3tpbnZpdGVfaWR9JywgaW52aXRlX2lkPWludml0ZV9pZCksIHBhcmFtcz1wYXJhbXMpCgogICAgZGVmIGludml0ZXNfZnJvbShzZWxmLCBndWlsZF9pZCk6CiAgICAgICAgcmV0dXJuIHNlbGYucmVxdWVzdChSb3V0ZSgnR0VUJywgJy9ndWlsZHMve2d1aWxkX2lkfS9pbnZpdGVzJywgZ3VpbGRfaWQ9Z3VpbGRfaWQpKQoKICAgIGRlZiBpbnZpdGVzX2Zyb21fY2hhbm5lbChzZWxmLCBjaGFubmVsX2lkKToKICAgICAgICByZXR1cm4gc2VsZi5yZXF1ZXN0KFJvdXRlKCdHRVQnLCAnL2NoYW5uZWxzL3tjaGFubmVsX2lkfS9pbnZpdGVzJywgY2hhbm5lbF9pZD1jaGFubmVsX2lkKSkKCiAgICBkZWYgZGVsZXRlX2ludml0ZShzZWxmLCBpbnZpdGVfaWQsICosIHJlYXNvbj1Ob25lKToKICAgICAgICByZXR1cm4gc2VsZi5yZXF1ZXN0KFJvdXRlKCdERUxFVEUnLCAnL2ludml0ZXMve2ludml0ZV9pZH0nLCBpbnZpdGVfaWQ9aW52aXRlX2lkKSwgcmVhc29uPXJlYXNvbikKCiAgICAjIFJvbGUgbWFuYWdlbWVudAoKICAgIGRlZiBnZXRfcm9sZXMoc2VsZiwgZ3VpbGRfaWQpOgogICAgICAgIHJldHVybiBzZWxmLnJlcXVlc3QoUm91dGUoJ0dFVCcsICcvZ3VpbGRzL3tndWlsZF9pZH0vcm9sZXMnLCBndWlsZF9pZD1ndWlsZF9pZCkpCgogICAgZGVmIGVkaXRfcm9sZShzZWxmLCBndWlsZF9pZCwgcm9sZV9pZCwgKiwgcmVhc29uPU5vbmUsICoqZmllbGRzKToKICAgICAgICByID0gUm91dGUoJ1BBVENIJywgJy9ndWlsZHMve2d1aWxkX2lkfS9yb2xlcy97cm9sZV9pZH0nLCBndWlsZF9pZD1ndWlsZF9pZCwgcm9sZV9pZD1yb2xlX2lkKQogICAgICAgIHZhbGlkX2tleXMgPSAoJ25hbWUnLCAncGVybWlzc2lvbnMnLCAnY29sb3InLCAnaG9pc3QnLCAnbWVudGlvbmFibGUnKQogICAgICAgIHBheWxvYWQgPSB7CiAgICAgICAgICAgIGs6IHYgZm9yIGssIHYgaW4gZmllbGRzLml0ZW1zKCkgaWYgayBpbiB2YWxpZF9rZXlzCiAgICAgICAgfQogICAgICAgIHJldHVybiBzZWxmLnJlcXVlc3QociwganNvbj1wYXlsb2FkLCByZWFzb249cmVhc29uKQoKICAgIGRlZiBkZWxldGVfcm9sZShzZWxmLCBndWlsZF9pZCwgcm9sZV9pZCwgKiwgcmVhc29uPU5vbmUpOgogICAgICAgIHIgPSBSb3V0ZSgnREVMRVRFJywgJy9ndWlsZHMve2d1aWxkX2lkfS9yb2xlcy97cm9sZV9pZH0nLCBndWlsZF9pZD1ndWlsZF9pZCwgcm9sZV9pZD1yb2xlX2lkKQogICAgICAgIHJldHVybiBzZWxmLnJlcXVlc3QociwgcmVhc29uPXJlYXNvbikKCiAgICBkZWYgcmVwbGFjZV9yb2xlcyhzZWxmLCB1c2VyX2lkLCBndWlsZF9pZCwgcm9sZV9pZHMsICosIHJlYXNvbj1Ob25lKToKICAgICAgICByZXR1cm4gc2VsZi5lZGl0X21lbWJlcihndWlsZF9pZD1ndWlsZF9pZCwgdXNlcl9pZD11c2VyX2lkLCByb2xlcz1yb2xlX2lkcywgcmVhc29uPXJlYXNvbikKCiAgICBkZWYgY3JlYXRlX3JvbGUoc2VsZiwgZ3VpbGRfaWQsICosIHJlYXNvbj1Ob25lLCAqKmZpZWxkcyk6CiAgICAgICAgciA9IFJvdXRlKCdQT1NUJywgJy9ndWlsZHMve2d1aWxkX2lkfS9yb2xlcycsIGd1aWxkX2lkPWd1aWxkX2lkKQogICAgICAgIHJldHVybiBzZWxmLnJlcXVlc3QociwganNvbj1maWVsZHMsIHJlYXNvbj1yZWFzb24pCgogICAgZGVmIG1vdmVfcm9sZV9wb3NpdGlvbihzZWxmLCBndWlsZF9pZCwgcG9zaXRpb25zLCAqLCByZWFzb249Tm9uZSk6CiAgICAgICAgciA9IFJvdXRlKCdQQVRDSCcsICcvZ3VpbGRzL3tndWlsZF9pZH0vcm9sZXMnLCBndWlsZF9pZD1ndWlsZF9pZCkKICAgICAgICByZXR1cm4gc2VsZi5yZXF1ZXN0KHIsIGpzb249cG9zaXRpb25zLCByZWFzb249cmVhc29uKQoKICAgIGRlZiBhZGRfcm9sZShzZWxmLCBndWlsZF9pZCwgdXNlcl9pZCwgcm9sZV9pZCwgKiwgcmVhc29uPU5vbmUpOgogICAgICAgIHIgPSBSb3V0ZSgnUFVUJywgJy9ndWlsZHMve2d1aWxkX2lkfS9tZW1iZXJzL3t1c2VyX2lkfS9yb2xlcy97cm9sZV9pZH0nLAogICAgICAgICAgICAgICAgICBndWlsZF9pZD1ndWlsZF9pZCwgdXNlcl9pZD11c2VyX2lkLCByb2xlX2lkPXJvbGVfaWQpCiAgICAgICAgcmV0dXJuIHNlbGYucmVxdWVzdChyLCByZWFzb249cmVhc29uKQoKICAgIGRlZiByZW1vdmVfcm9sZShzZWxmLCBndWlsZF9pZCwgdXNlcl9pZCwgcm9sZV9pZCwgKiwgcmVhc29uPU5vbmUpOgogICAgICAgIHIgPSBSb3V0ZSgnREVMRVRFJywgJy9ndWlsZHMve2d1aWxkX2lkfS9tZW1iZXJzL3t1c2VyX2lkfS9yb2xlcy97cm9sZV9pZH0nLAogICAgICAgICAgICAgICAgICBndWlsZF9pZD1ndWlsZF9pZCwgdXNlcl9pZD11c2VyX2lkLCByb2xlX2lkPXJvbGVfaWQpCiAgICAgICAgcmV0dXJuIHNlbGYucmVxdWVzdChyLCByZWFzb249cmVhc29uKQoKICAgIGRlZiBlZGl0X2NoYW5uZWxfcGVybWlzc2lvbnMoc2VsZiwgY2hhbm5lbF9pZCwgdGFyZ2V0LCBhbGxvdywgZGVueSwgdHlwZSwgKiwgcmVhc29uPU5vbmUpOgogICAgICAgIHBheWxvYWQgPSB7CiAgICAgICAgICAgICdpZCc6IHRhcmdldCwKICAgICAgICAgICAgJ2FsbG93JzogYWxsb3csCiAgICAgICAgICAgICdkZW55JzogZGVueSwKICAgICAgICAgICAgJ3R5cGUnOiB0eXBlCiAgICAgICAgfQogICAgICAgIHIgPSBSb3V0ZSgnUFVUJywgJy9jaGFubmVscy97Y2hhbm5lbF9pZH0vcGVybWlzc2lvbnMve3RhcmdldH0nLCBjaGFubmVsX2lkPWNoYW5uZWxfaWQsIHRhcmdldD10YXJnZXQpCiAgICAgICAgcmV0dXJuIHNlbGYucmVxdWVzdChyLCBqc29uPXBheWxvYWQsIHJlYXNvbj1yZWFzb24pCgogICAgZGVmIGRlbGV0ZV9jaGFubmVsX3Blcm1pc3Npb25zKHNlbGYsIGNoYW5uZWxfaWQsIHRhcmdldCwgKiwgcmVhc29uPU5vbmUpOgogICAgICAgIHIgPSBSb3V0ZSgnREVMRVRFJywgJy9jaGFubmVscy97Y2hhbm5lbF9pZH0vcGVybWlzc2lvbnMve3RhcmdldH0nLCBjaGFubmVsX2lkPWNoYW5uZWxfaWQsIHRhcmdldD10YXJnZXQpCiAgICAgICAgcmV0dXJuIHNlbGYucmVxdWVzdChyLCByZWFzb249cmVhc29uKQoKICAgICMgVm9pY2UgbWFuYWdlbWVudAoKICAgIGRlZiBtb3ZlX21lbWJlcihzZWxmLCB1c2VyX2lkLCBndWlsZF9pZCwgY2hhbm5lbF9pZCwgKiwgcmVhc29uPU5vbmUpOgogICAgICAgIHJldHVybiBzZWxmLmVkaXRfbWVtYmVyKGd1aWxkX2lkPWd1aWxkX2lkLCB1c2VyX2lkPXVzZXJfaWQsIGNoYW5uZWxfaWQ9Y2hhbm5lbF9pZCwgcmVhc29uPXJlYXNvbikKCiAgICAjIFJlbGF0aW9uc2hpcCByZWxhdGVkCgogICAgZGVmIHJlbW92ZV9yZWxhdGlvbnNoaXAoc2VsZiwgdXNlcl9pZCk6CiAgICAgICAgciA9IFJvdXRlKCdERUxFVEUnLCAnL3VzZXJzL0BtZS9yZWxhdGlvbnNoaXBzL3t1c2VyX2lkfScsIHVzZXJfaWQ9dXNlcl9pZCkKICAgICAgICByZXR1cm4gc2VsZi5yZXF1ZXN0KHIpCgogICAgZGVmIGFkZF9yZWxhdGlvbnNoaXAoc2VsZiwgdXNlcl9pZCwgdHlwZT1Ob25lKToKICAgICAgICByID0gUm91dGUoJ1BVVCcsICcvdXNlcnMvQG1lL3JlbGF0aW9uc2hpcHMve3VzZXJfaWR9JywgdXNlcl9pZD11c2VyX2lkKQogICAgICAgIHBheWxvYWQgPSB7fQogICAgICAgIGlmIHR5cGUgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHBheWxvYWRbJ3R5cGUnXSA9IHR5cGUKCiAgICAgICAgcmV0dXJuIHNlbGYucmVxdWVzdChyLCBqc29uPXBheWxvYWQpCgogICAgZGVmIHNlbmRfZnJpZW5kX3JlcXVlc3Qoc2VsZiwgdXNlcm5hbWUsIGRpc2NyaW1pbmF0b3IpOgogICAgICAgIHIgPSBSb3V0ZSgnUE9TVCcsICcvdXNlcnMvQG1lL3JlbGF0aW9uc2hpcHMnKQogICAgICAgIHBheWxvYWQgPSB7CiAgICAgICAgICAgICd1c2VybmFtZSc6IHVzZXJuYW1lLAogICAgICAgICAgICAnZGlzY3JpbWluYXRvcic6IGludChkaXNjcmltaW5hdG9yKQogICAgICAgIH0KICAgICAgICByZXR1cm4gc2VsZi5yZXF1ZXN0KHIsIGpzb249cGF5bG9hZCkKCiAgICAjIE1pc2MKCiAgICBkZWYgYXBwbGljYXRpb25faW5mbyhzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5yZXF1ZXN0KFJvdXRlKCdHRVQnLCAnL29hdXRoMi9hcHBsaWNhdGlvbnMvQG1lJykpCgogICAgYXN5bmMgZGVmIGdldF9nYXRld2F5KHNlbGYsICosIGVuY29kaW5nPSdqc29uJywgdj02LCB6bGliPVRydWUpOgogICAgICAgIHRyeToKICAgICAgICAgICAgZGF0YSA9IGF3YWl0IHNlbGYucmVxdWVzdChSb3V0ZSgnR0VUJywgJy9nYXRld2F5JykpCiAgICAgICAgZXhjZXB0IEhUVFBFeGNlcHRpb24gYXMgZXhjOgogICAgICAgICAgICByYWlzZSBHYXRld2F5Tm90Rm91bmQoKSBmcm9tIGV4YwogICAgICAgIGlmIHpsaWI6CiAgICAgICAgICAgIHZhbHVlID0gJ3swfT9lbmNvZGluZz17MX0mdj17Mn0mY29tcHJlc3M9emxpYi1zdHJlYW0nCiAgICAgICAgZWxzZToKICAgICAgICAgICAgdmFsdWUgPSAnezB9P2VuY29kaW5nPXsxfSZ2PXsyfScKICAgICAgICByZXR1cm4gdmFsdWUuZm9ybWF0KGRhdGFbJ3VybCddLCBlbmNvZGluZywgdikKCiAgICBhc3luYyBkZWYgZ2V0X2JvdF9nYXRld2F5KHNlbGYsICosIGVuY29kaW5nPSdqc29uJywgdj02LCB6bGliPVRydWUpOgogICAgICAgIHRyeToKICAgICAgICAgICAgZGF0YSA9IGF3YWl0IHNlbGYucmVxdWVzdChSb3V0ZSgnR0VUJywgJy9nYXRld2F5L2JvdCcpKQogICAgICAgIGV4Y2VwdCBIVFRQRXhjZXB0aW9uIGFzIGV4YzoKICAgICAgICAgICAgcmFpc2UgR2F0ZXdheU5vdEZvdW5kKCkgZnJvbSBleGMKCiAgICAgICAgaWYgemxpYjoKICAgICAgICAgICAgdmFsdWUgPSAnezB9P2VuY29kaW5nPXsxfSZ2PXsyfSZjb21wcmVzcz16bGliLXN0cmVhbScKICAgICAgICBlbHNlOgogICAgICAgICAgICB2YWx1ZSA9ICd7MH0/ZW5jb2Rpbmc9ezF9JnY9ezJ9JwogICAgICAgIHJldHVybiBkYXRhWydzaGFyZHMnXSwgdmFsdWUuZm9ybWF0KGRhdGFbJ3VybCddLCBlbmNvZGluZywgdikKCiAgICBkZWYgZ2V0X3VzZXIoc2VsZiwgdXNlcl9pZCk6CiAgICAgICAgcmV0dXJuIHNlbGYucmVxdWVzdChSb3V0ZSgnR0VUJywgJy91c2Vycy97dXNlcl9pZH0nLCB1c2VyX2lkPXVzZXJfaWQpKQoKICAgIGRlZiBnZXRfdXNlcl9wcm9maWxlKHNlbGYsIHVzZXJfaWQpOgogICAgICAgIHJldHVybiBzZWxmLnJlcXVlc3QoUm91dGUoJ0dFVCcsICcvdXNlcnMve3VzZXJfaWR9L3Byb2ZpbGUnLCB1c2VyX2lkPXVzZXJfaWQpKQoKICAgIGRlZiBnZXRfbXV0dWFsX2ZyaWVuZHMoc2VsZiwgdXNlcl9pZCk6CiAgICAgICAgcmV0dXJuIHNlbGYucmVxdWVzdChSb3V0ZSgnR0VUJywgJy91c2Vycy97dXNlcl9pZH0vcmVsYXRpb25zaGlwcycsIHVzZXJfaWQ9dXNlcl9pZCkpCgogICAgZGVmIGNoYW5nZV9oeXBlc3F1YWRfaG91c2Uoc2VsZiwgaG91c2VfaWQpOgogICAgICAgIHBheWxvYWQgPSB7J2hvdXNlX2lkJzogaG91c2VfaWR9CiAgICAgICAgcmV0dXJuIHNlbGYucmVxdWVzdChSb3V0ZSgnUE9TVCcsICcvaHlwZXNxdWFkL29ubGluZScpLCBqc29uPXBheWxvYWQpCgogICAgZGVmIGxlYXZlX2h5cGVzcXVhZF9ob3VzZShzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5yZXF1ZXN0KFJvdXRlKCdERUxFVEUnLCAnL2h5cGVzcXVhZC9vbmxpbmUnKSkKCiAgICBkZWYgZWRpdF9zZXR0aW5ncyhzZWxmLCAqKnBheWxvYWQpOgogICAgICAgIHJldHVybiBzZWxmLnJlcXVlc3QoUm91dGUoJ1BBVENIJywgJy91c2Vycy9AbWUvc2V0dGluZ3MnKSwganNvbj1wYXlsb2FkKQo=
