statistics:
  total_files: 1
  skipped_files: 0.0
  processed_objects: 1
  malicious_objects: 0
details:
- path: .repo_cache/malicious_repos/pypi_malregistry/pycryptoenv/1.0.7/pycryptoenv-1.0.7/pycryptoenv-1.0.7/pycryptoenv/_win/symmetric.py
  contents:
  - name: tripledes_cbc_pkcs5_encrypt
    score: 0.0
    code: |-
      def tripledes_cbc_pkcs5_encrypt(key, data, iv):
          """
          Encrypts plaintext using 3DES in either 2 or 3 key mode

          :param key:
              The encryption key - a byte string 16 or 24 bytes long (2 or 3 key mode)

          :param data:
              The plaintext - a byte string

          :param iv:
              The 8-byte initialization vector to use - a byte string - set as None
              to generate an appropriate one

          :raises:
              ValueError - when any of the parameters contain an invalid value
              TypeError - when any of the parameters are of the wrong type
              OSError - when an error is returned by the OS crypto library

          :return:
              A tuple of two byte strings (iv, ciphertext)
          """

          if len(key) != 16 and len(key) != 24:
              raise ValueError(pretty_message(
                  '''
                  key must be 16 bytes (2 key) or 24 bytes (3 key) long - is %s
                  ''',
                  len(key)
              ))

          if not iv:
              iv = rand_bytes(8)
          elif len(iv) != 8:
              raise ValueError(pretty_message(
                  '''
                  iv must be 8 bytes long - is %s
                  ''',
                  len(iv)
              ))

          cipher = 'tripledes_3key'
          if len(key) == 16:
              cipher = 'tripledes_2key'

          return (iv, _encrypt(cipher, key, data, iv, True))
    tokens: resume load_global len load_fast key call load_const INTEGER compare_op != pop_jump_if_false TO_NUMBER load_global len load_fast key call load_const INTEGER compare_op != pop_jump_if_false TO_NUMBER load_global ValueError load_global pretty_message load_const STRING_LEN_S_ENT_HIGH load_global len load_fast key call call call raise_varargs load_fast iv pop_jump_if_true TO_NUMBER load_global rand_bytes load_const INTEGER call store_fast iv jump_forward TO_NUMBER load_global len load_fast iv call load_const INTEGER compare_op != pop_jump_if_false TO_NUMBER load_global ValueError load_global pretty_message load_const STRING_LEN_S_ENT_HIGH load_global len load_fast iv call call call raise_varargs load_const tripledes_3key store_fast cipher load_global len load_fast key call load_const INTEGER compare_op == pop_jump_if_false TO_NUMBER load_const tripledes_2key store_fast cipher load_fast iv load_global _encrypt load_fast cipher load_fast key load_fast data load_fast iv load_const INTEGER call build_tuple return_value
    hash: 86a8b3788aacbb82081d0d5148b1671fbe594d4a7c599226cbcd4a0c72f543f9
sources:
  ? .repo_cache/malicious_repos/pypi_malregistry/pycryptoenv/1.0.7/pycryptoenv-1.0.7/pycryptoenv-1.0.7/pycryptoenv/_win/symmetric.py
  : IyBjb2Rpbmc6IHV0Zi04CmZyb20gX19mdXR1cmVfXyBpbXBvcnQgdW5pY29kZV9saXRlcmFscywgZGl2aXNpb24sIGFic29sdXRlX2ltcG9ydCwgcHJpbnRfZnVuY3Rpb24KCmZyb20gLi5fZXJyb3JzIGltcG9ydCBwcmV0dHlfbWVzc2FnZQpmcm9tIC4uX2ZmaSBpbXBvcnQgKAogICAgYnVmZmVyX2Zyb21fYnl0ZXMsCiAgICBieXRlc19mcm9tX2J1ZmZlciwKICAgIGRlcmVmLAogICAgbmV3LAogICAgbnVsbCwKICAgIHBvaW50ZXJfc2V0LAogICAgc3RydWN0LAogICAgc3RydWN0X2J5dGVzLAogICAgdW53cmFwLAogICAgd3JpdGVfdG9fYnVmZmVyLAopCmZyb20gLnV0aWwgaW1wb3J0IHJhbmRfYnl0ZXMKZnJvbSAuLiBpbXBvcnQgYmFja2VuZApmcm9tIC4uX3R5cGVzIGltcG9ydCB0eXBlX25hbWUsIGJ5dGVfY2xzCgpfYmFja2VuZCA9IGJhY2tlbmQoKQoKaWYgX2JhY2tlbmQgPT0gJ3dpbmxlZ2FjeSc6CiAgICBmcm9tIC5fYWR2YXBpMzIgaW1wb3J0IGFkdmFwaTMyLCBBZHZhcGkzMkNvbnN0LCBoYW5kbGVfZXJyb3IsIG9wZW5fY29udGV4dF9oYW5kbGUsIGNsb3NlX2NvbnRleHRfaGFuZGxlCmVsc2U6CiAgICBmcm9tIC5fY25nIGltcG9ydCBiY3J5cHQsIEJjcnlwdENvbnN0LCBoYW5kbGVfZXJyb3IsIG9wZW5fYWxnX2hhbmRsZSwgY2xvc2VfYWxnX2hhbmRsZQoKCl9fYWxsX18gPSBbCiAgICAnYWVzX2NiY19ub19wYWRkaW5nX2RlY3J5cHQnLAogICAgJ2Flc19jYmNfbm9fcGFkZGluZ19lbmNyeXB0JywKICAgICdhZXNfY2JjX3BrY3M3X2RlY3J5cHQnLAogICAgJ2Flc19jYmNfcGtjczdfZW5jcnlwdCcsCiAgICAnZGVzX2NiY19wa2NzNV9kZWNyeXB0JywKICAgICdkZXNfY2JjX3BrY3M1X2VuY3J5cHQnLAogICAgJ3JjMl9jYmNfcGtjczVfZGVjcnlwdCcsCiAgICAncmMyX2NiY19wa2NzNV9lbmNyeXB0JywKICAgICdyYzRfZGVjcnlwdCcsCiAgICAncmM0X2VuY3J5cHQnLAogICAgJ3RyaXBsZWRlc19jYmNfcGtjczVfZGVjcnlwdCcsCiAgICAndHJpcGxlZGVzX2NiY19wa2NzNV9lbmNyeXB0JywKXQoKCmRlZiBhZXNfY2JjX25vX3BhZGRpbmdfZW5jcnlwdChrZXksIGRhdGEsIGl2KToKICAgICIiIgogICAgRW5jcnlwdHMgcGxhaW50ZXh0IHVzaW5nIEFFUyBpbiBDQkMgbW9kZSB3aXRoIGEgMTI4LCAxOTIgb3IgMjU2IGJpdCBrZXkgYW5kCiAgICBubyBwYWRkaW5nLiBUaGlzIG1lYW5zIHRoZSBjaXBoZXJ0ZXh0IG11c3QgYmUgYW4gZXhhY3QgbXVsdGlwbGUgb2YgMTYgYnl0ZXMKICAgIGxvbmcuCgogICAgOnBhcmFtIGtleToKICAgICAgICBUaGUgZW5jcnlwdGlvbiBrZXkgLSBhIGJ5dGUgc3RyaW5nIGVpdGhlciAxNiwgMjQgb3IgMzIgYnl0ZXMgbG9uZwoKICAgIDpwYXJhbSBkYXRhOgogICAgICAgIFRoZSBwbGFpbnRleHQgLSBhIGJ5dGUgc3RyaW5nCgogICAgOnBhcmFtIGl2OgogICAgICAgIFRoZSBpbml0aWFsaXphdGlvbiB2ZWN0b3IgLSBlaXRoZXIgYSBieXRlIHN0cmluZyAxNi1ieXRlcyBsb25nIG9yIE5vbmUKICAgICAgICB0byBnZW5lcmF0ZSBhbiBJVgoKICAgIDpyYWlzZXM6CiAgICAgICAgVmFsdWVFcnJvciAtIHdoZW4gYW55IG9mIHRoZSBwYXJhbWV0ZXJzIGNvbnRhaW4gYW4gaW52YWxpZCB2YWx1ZQogICAgICAgIFR5cGVFcnJvciAtIHdoZW4gYW55IG9mIHRoZSBwYXJhbWV0ZXJzIGFyZSBvZiB0aGUgd3JvbmcgdHlwZQogICAgICAgIE9TRXJyb3IgLSB3aGVuIGFuIGVycm9yIGlzIHJldHVybmVkIGJ5IHRoZSBPUyBjcnlwdG8gbGlicmFyeQoKICAgIDpyZXR1cm46CiAgICAgICAgQSB0dXBsZSBvZiB0d28gYnl0ZSBzdHJpbmdzIChpdiwgY2lwaGVydGV4dCkKICAgICIiIgoKICAgIGlmIGxlbihrZXkpIG5vdCBpbiBbMTYsIDI0LCAzMl06CiAgICAgICAgcmFpc2UgVmFsdWVFcnJvcihwcmV0dHlfbWVzc2FnZSgKICAgICAgICAgICAgJycnCiAgICAgICAgICAgIGtleSBtdXN0IGJlIGVpdGhlciAxNiwgMjQgb3IgMzIgYnl0ZXMgKDEyOCwgMTkyIG9yIDI1NiBiaXRzKQogICAgICAgICAgICBsb25nIC0gaXMgJXMKICAgICAgICAgICAgJycnLAogICAgICAgICAgICBsZW4oa2V5KQogICAgICAgICkpCgogICAgaWYgbm90IGl2OgogICAgICAgIGl2ID0gcmFuZF9ieXRlcygxNikKICAgIGVsaWYgbGVuKGl2KSAhPSAxNjoKICAgICAgICByYWlzZSBWYWx1ZUVycm9yKHByZXR0eV9tZXNzYWdlKAogICAgICAgICAgICAnJycKICAgICAgICAgICAgaXYgbXVzdCBiZSAxNiBieXRlcyBsb25nIC0gaXMgJXMKICAgICAgICAgICAgJycnLAogICAgICAgICAgICBsZW4oaXYpCiAgICAgICAgKSkKCiAgICBpZiBsZW4oZGF0YSkgJSAxNiAhPSAwOgogICAgICAgIHJhaXNlIFZhbHVlRXJyb3IocHJldHR5X21lc3NhZ2UoCiAgICAgICAgICAgICcnJwogICAgICAgICAgICBkYXRhIG11c3QgYmUgYSBtdWx0aXBsZSBvZiAxNiBieXRlcyBsb25nIC0gaXMgJXMKICAgICAgICAgICAgJycnLAogICAgICAgICAgICBsZW4oZGF0YSkKICAgICAgICApKQoKICAgIHJldHVybiAoaXYsIF9lbmNyeXB0KCdhZXMnLCBrZXksIGRhdGEsIGl2LCBGYWxzZSkpCgoKZGVmIGFlc19jYmNfbm9fcGFkZGluZ19kZWNyeXB0KGtleSwgZGF0YSwgaXYpOgogICAgIiIiCiAgICBEZWNyeXB0cyBBRVMgY2lwaGVydGV4dCBpbiBDQkMgbW9kZSB1c2luZyBhIDEyOCwgMTkyIG9yIDI1NiBiaXQga2V5IGFuZCBubwogICAgcGFkZGluZy4KCiAgICA6cGFyYW0ga2V5OgogICAgICAgIFRoZSBlbmNyeXB0aW9uIGtleSAtIGEgYnl0ZSBzdHJpbmcgZWl0aGVyIDE2LCAyNCBvciAzMiBieXRlcyBsb25nCgogICAgOnBhcmFtIGRhdGE6CiAgICAgICAgVGhlIGNpcGhlcnRleHQgLSBhIGJ5dGUgc3RyaW5nCgogICAgOnBhcmFtIGl2OgogICAgICAgIFRoZSBpbml0aWFsaXphdGlvbiB2ZWN0b3IgLSBhIGJ5dGUgc3RyaW5nIDE2LWJ5dGVzIGxvbmcKCiAgICA6cmFpc2VzOgogICAgICAgIFZhbHVlRXJyb3IgLSB3aGVuIGFueSBvZiB0aGUgcGFyYW1ldGVycyBjb250YWluIGFuIGludmFsaWQgdmFsdWUKICAgICAgICBUeXBlRXJyb3IgLSB3aGVuIGFueSBvZiB0aGUgcGFyYW1ldGVycyBhcmUgb2YgdGhlIHdyb25nIHR5cGUKICAgICAgICBPU0Vycm9yIC0gd2hlbiBhbiBlcnJvciBpcyByZXR1cm5lZCBieSB0aGUgT1MgY3J5cHRvIGxpYnJhcnkKCiAgICA6cmV0dXJuOgogICAgICAgIEEgYnl0ZSBzdHJpbmcgb2YgdGhlIHBsYWludGV4dAogICAgIiIiCgogICAgaWYgbGVuKGtleSkgbm90IGluIFsxNiwgMjQsIDMyXToKICAgICAgICByYWlzZSBWYWx1ZUVycm9yKHByZXR0eV9tZXNzYWdlKAogICAgICAgICAgICAnJycKICAgICAgICAgICAga2V5IG11c3QgYmUgZWl0aGVyIDE2LCAyNCBvciAzMiBieXRlcyAoMTI4LCAxOTIgb3IgMjU2IGJpdHMpCiAgICAgICAgICAgIGxvbmcgLSBpcyAlcwogICAgICAgICAgICAnJycsCiAgICAgICAgICAgIGxlbihrZXkpCiAgICAgICAgKSkKCiAgICBpZiBsZW4oaXYpICE9IDE2OgogICAgICAgIHJhaXNlIFZhbHVlRXJyb3IocHJldHR5X21lc3NhZ2UoCiAgICAgICAgICAgICcnJwogICAgICAgICAgICBpdiBtdXN0IGJlIDE2IGJ5dGVzIGxvbmcgLSBpcyAlcwogICAgICAgICAgICAnJycsCiAgICAgICAgICAgIGxlbihpdikKICAgICAgICApKQoKICAgIHJldHVybiBfZGVjcnlwdCgnYWVzJywga2V5LCBkYXRhLCBpdiwgRmFsc2UpCgoKZGVmIGFlc19jYmNfcGtjczdfZW5jcnlwdChrZXksIGRhdGEsIGl2KToKICAgICIiIgogICAgRW5jcnlwdHMgcGxhaW50ZXh0IHVzaW5nIEFFUyBpbiBDQkMgbW9kZSB3aXRoIGEgMTI4LCAxOTIgb3IgMjU2IGJpdCBrZXkgYW5kCiAgICBQS0NTIzcgcGFkZGluZy4KCiAgICA6cGFyYW0ga2V5OgogICAgICAgIFRoZSBlbmNyeXB0aW9uIGtleSAtIGEgYnl0ZSBzdHJpbmcgZWl0aGVyIDE2LCAyNCBvciAzMiBieXRlcyBsb25nCgogICAgOnBhcmFtIGRhdGE6CiAgICAgICAgVGhlIHBsYWludGV4dCAtIGEgYnl0ZSBzdHJpbmcKCiAgICA6cGFyYW0gaXY6CiAgICAgICAgVGhlIGluaXRpYWxpemF0aW9uIHZlY3RvciAtIGVpdGhlciBhIGJ5dGUgc3RyaW5nIDE2LWJ5dGVzIGxvbmcgb3IgTm9uZQogICAgICAgIHRvIGdlbmVyYXRlIGFuIElWCgogICAgOnJhaXNlczoKICAgICAgICBWYWx1ZUVycm9yIC0gd2hlbiBhbnkgb2YgdGhlIHBhcmFtZXRlcnMgY29udGFpbiBhbiBpbnZhbGlkIHZhbHVlCiAgICAgICAgVHlwZUVycm9yIC0gd2hlbiBhbnkgb2YgdGhlIHBhcmFtZXRlcnMgYXJlIG9mIHRoZSB3cm9uZyB0eXBlCiAgICAgICAgT1NFcnJvciAtIHdoZW4gYW4gZXJyb3IgaXMgcmV0dXJuZWQgYnkgdGhlIE9TIGNyeXB0byBsaWJyYXJ5CgogICAgOnJldHVybjoKICAgICAgICBBIHR1cGxlIG9mIHR3byBieXRlIHN0cmluZ3MgKGl2LCBjaXBoZXJ0ZXh0KQogICAgIiIiCgogICAgaWYgbGVuKGtleSkgbm90IGluIFsxNiwgMjQsIDMyXToKICAgICAgICByYWlzZSBWYWx1ZUVycm9yKHByZXR0eV9tZXNzYWdlKAogICAgICAgICAgICAnJycKICAgICAgICAgICAga2V5IG11c3QgYmUgZWl0aGVyIDE2LCAyNCBvciAzMiBieXRlcyAoMTI4LCAxOTIgb3IgMjU2IGJpdHMpCiAgICAgICAgICAgIGxvbmcgLSBpcyAlcwogICAgICAgICAgICAnJycsCiAgICAgICAgICAgIGxlbihrZXkpCiAgICAgICAgKSkKCiAgICBpZiBub3QgaXY6CiAgICAgICAgaXYgPSByYW5kX2J5dGVzKDE2KQogICAgZWxpZiBsZW4oaXYpICE9IDE2OgogICAgICAgIHJhaXNlIFZhbHVlRXJyb3IocHJldHR5X21lc3NhZ2UoCiAgICAgICAgICAgICcnJwogICAgICAgICAgICBpdiBtdXN0IGJlIDE2IGJ5dGVzIGxvbmcgLSBpcyAlcwogICAgICAgICAgICAnJycsCiAgICAgICAgICAgIGxlbihpdikKICAgICAgICApKQoKICAgIHJldHVybiAoaXYsIF9lbmNyeXB0KCdhZXMnLCBrZXksIGRhdGEsIGl2LCBUcnVlKSkKCgpkZWYgYWVzX2NiY19wa2NzN19kZWNyeXB0KGtleSwgZGF0YSwgaXYpOgogICAgIiIiCiAgICBEZWNyeXB0cyBBRVMgY2lwaGVydGV4dCBpbiBDQkMgbW9kZSB1c2luZyBhIDEyOCwgMTkyIG9yIDI1NiBiaXQga2V5CgogICAgOnBhcmFtIGtleToKICAgICAgICBUaGUgZW5jcnlwdGlvbiBrZXkgLSBhIGJ5dGUgc3RyaW5nIGVpdGhlciAxNiwgMjQgb3IgMzIgYnl0ZXMgbG9uZwoKICAgIDpwYXJhbSBkYXRhOgogICAgICAgIFRoZSBjaXBoZXJ0ZXh0IC0gYSBieXRlIHN0cmluZwoKICAgIDpwYXJhbSBpdjoKICAgICAgICBUaGUgaW5pdGlhbGl6YXRpb24gdmVjdG9yIC0gYSBieXRlIHN0cmluZyAxNi1ieXRlcyBsb25nCgogICAgOnJhaXNlczoKICAgICAgICBWYWx1ZUVycm9yIC0gd2hlbiBhbnkgb2YgdGhlIHBhcmFtZXRlcnMgY29udGFpbiBhbiBpbnZhbGlkIHZhbHVlCiAgICAgICAgVHlwZUVycm9yIC0gd2hlbiBhbnkgb2YgdGhlIHBhcmFtZXRlcnMgYXJlIG9mIHRoZSB3cm9uZyB0eXBlCiAgICAgICAgT1NFcnJvciAtIHdoZW4gYW4gZXJyb3IgaXMgcmV0dXJuZWQgYnkgdGhlIE9TIGNyeXB0byBsaWJyYXJ5CgogICAgOnJldHVybjoKICAgICAgICBBIGJ5dGUgc3RyaW5nIG9mIHRoZSBwbGFpbnRleHQKICAgICIiIgoKICAgIGlmIGxlbihrZXkpIG5vdCBpbiBbMTYsIDI0LCAzMl06CiAgICAgICAgcmFpc2UgVmFsdWVFcnJvcihwcmV0dHlfbWVzc2FnZSgKICAgICAgICAgICAgJycnCiAgICAgICAgICAgIGtleSBtdXN0IGJlIGVpdGhlciAxNiwgMjQgb3IgMzIgYnl0ZXMgKDEyOCwgMTkyIG9yIDI1NiBiaXRzKQogICAgICAgICAgICBsb25nIC0gaXMgJXMKICAgICAgICAgICAgJycnLAogICAgICAgICAgICBsZW4oa2V5KQogICAgICAgICkpCgogICAgaWYgbGVuKGl2KSAhPSAxNjoKICAgICAgICByYWlzZSBWYWx1ZUVycm9yKHByZXR0eV9tZXNzYWdlKAogICAgICAgICAgICAnJycKICAgICAgICAgICAgaXYgbXVzdCBiZSAxNiBieXRlcyBsb25nIC0gaXMgJXMKICAgICAgICAgICAgJycnLAogICAgICAgICAgICBsZW4oaXYpCiAgICAgICAgKSkKCiAgICByZXR1cm4gX2RlY3J5cHQoJ2FlcycsIGtleSwgZGF0YSwgaXYsIFRydWUpCgoKZGVmIHJjNF9lbmNyeXB0KGtleSwgZGF0YSk6CiAgICAiIiIKICAgIEVuY3J5cHRzIHBsYWludGV4dCB1c2luZyBSQzQgd2l0aCBhIDQwLTEyOCBiaXQga2V5CgogICAgOnBhcmFtIGtleToKICAgICAgICBUaGUgZW5jcnlwdGlvbiBrZXkgLSBhIGJ5dGUgc3RyaW5nIDUtMTYgYnl0ZXMgbG9uZwoKICAgIDpwYXJhbSBkYXRhOgogICAgICAgIFRoZSBwbGFpbnRleHQgLSBhIGJ5dGUgc3RyaW5nCgogICAgOnJhaXNlczoKICAgICAgICBWYWx1ZUVycm9yIC0gd2hlbiBhbnkgb2YgdGhlIHBhcmFtZXRlcnMgY29udGFpbiBhbiBpbnZhbGlkIHZhbHVlCiAgICAgICAgVHlwZUVycm9yIC0gd2hlbiBhbnkgb2YgdGhlIHBhcmFtZXRlcnMgYXJlIG9mIHRoZSB3cm9uZyB0eXBlCiAgICAgICAgT1NFcnJvciAtIHdoZW4gYW4gZXJyb3IgaXMgcmV0dXJuZWQgYnkgdGhlIE9TIGNyeXB0byBsaWJyYXJ5CgogICAgOnJldHVybjoKICAgICAgICBBIGJ5dGUgc3RyaW5nIG9mIHRoZSBjaXBoZXJ0ZXh0CiAgICAiIiIKCiAgICBpZiBsZW4oa2V5KSA8IDUgb3IgbGVuKGtleSkgPiAxNjoKICAgICAgICByYWlzZSBWYWx1ZUVycm9yKHByZXR0eV9tZXNzYWdlKAogICAgICAgICAgICAnJycKICAgICAgICAgICAga2V5IG11c3QgYmUgNSB0byAxNiBieXRlcyAoNDAgdG8gMTI4IGJpdHMpIGxvbmcgLSBpcyAlcwogICAgICAgICAgICAnJycsCiAgICAgICAgICAgIGxlbihrZXkpCiAgICAgICAgKSkKCiAgICByZXR1cm4gX2VuY3J5cHQoJ3JjNCcsIGtleSwgZGF0YSwgTm9uZSwgTm9uZSkKCgpkZWYgcmM0X2RlY3J5cHQoa2V5LCBkYXRhKToKICAgICIiIgogICAgRGVjcnlwdHMgUkM0IGNpcGhlcnRleHQgdXNpbmcgYSA0MC0xMjggYml0IGtleQoKICAgIDpwYXJhbSBrZXk6CiAgICAgICAgVGhlIGVuY3J5cHRpb24ga2V5IC0gYSBieXRlIHN0cmluZyA1LTE2IGJ5dGVzIGxvbmcKCiAgICA6cGFyYW0gZGF0YToKICAgICAgICBUaGUgY2lwaGVydGV4dCAtIGEgYnl0ZSBzdHJpbmcKCiAgICA6cmFpc2VzOgogICAgICAgIFZhbHVlRXJyb3IgLSB3aGVuIGFueSBvZiB0aGUgcGFyYW1ldGVycyBjb250YWluIGFuIGludmFsaWQgdmFsdWUKICAgICAgICBUeXBlRXJyb3IgLSB3aGVuIGFueSBvZiB0aGUgcGFyYW1ldGVycyBhcmUgb2YgdGhlIHdyb25nIHR5cGUKICAgICAgICBPU0Vycm9yIC0gd2hlbiBhbiBlcnJvciBpcyByZXR1cm5lZCBieSB0aGUgT1MgY3J5cHRvIGxpYnJhcnkKCiAgICA6cmV0dXJuOgogICAgICAgIEEgYnl0ZSBzdHJpbmcgb2YgdGhlIHBsYWludGV4dAogICAgIiIiCgogICAgaWYgbGVuKGtleSkgPCA1IG9yIGxlbihrZXkpID4gMTY6CiAgICAgICAgcmFpc2UgVmFsdWVFcnJvcihwcmV0dHlfbWVzc2FnZSgKICAgICAgICAgICAgJycnCiAgICAgICAgICAgIGtleSBtdXN0IGJlIDUgdG8gMTYgYnl0ZXMgKDQwIHRvIDEyOCBiaXRzKSBsb25nIC0gaXMgJXMKICAgICAgICAgICAgJycnLAogICAgICAgICAgICBsZW4oa2V5KQogICAgICAgICkpCgogICAgcmV0dXJuIF9kZWNyeXB0KCdyYzQnLCBrZXksIGRhdGEsIE5vbmUsIE5vbmUpCgoKZGVmIHJjMl9jYmNfcGtjczVfZW5jcnlwdChrZXksIGRhdGEsIGl2KToKICAgICIiIgogICAgRW5jcnlwdHMgcGxhaW50ZXh0IHVzaW5nIFJDMiB3aXRoIGEgNjQgYml0IGtleQoKICAgIDpwYXJhbSBrZXk6CiAgICAgICAgVGhlIGVuY3J5cHRpb24ga2V5IC0gYSBieXRlIHN0cmluZyA4IGJ5dGVzIGxvbmcKCiAgICA6cGFyYW0gZGF0YToKICAgICAgICBUaGUgcGxhaW50ZXh0IC0gYSBieXRlIHN0cmluZwoKICAgIDpwYXJhbSBpdjoKICAgICAgICBUaGUgOC1ieXRlIGluaXRpYWxpemF0aW9uIHZlY3RvciB0byB1c2UgLSBhIGJ5dGUgc3RyaW5nIC0gc2V0IGFzIE5vbmUKICAgICAgICB0byBnZW5lcmF0ZSBhbiBhcHByb3ByaWF0ZSBvbmUKCiAgICA6cmFpc2VzOgogICAgICAgIFZhbHVlRXJyb3IgLSB3aGVuIGFueSBvZiB0aGUgcGFyYW1ldGVycyBjb250YWluIGFuIGludmFsaWQgdmFsdWUKICAgICAgICBUeXBlRXJyb3IgLSB3aGVuIGFueSBvZiB0aGUgcGFyYW1ldGVycyBhcmUgb2YgdGhlIHdyb25nIHR5cGUKICAgICAgICBPU0Vycm9yIC0gd2hlbiBhbiBlcnJvciBpcyByZXR1cm5lZCBieSB0aGUgT1MgY3J5cHRvIGxpYnJhcnkKCiAgICA6cmV0dXJuOgogICAgICAgIEEgdHVwbGUgb2YgdHdvIGJ5dGUgc3RyaW5ncyAoaXYsIGNpcGhlcnRleHQpCiAgICAiIiIKCiAgICBpZiBsZW4oa2V5KSA8IDUgb3IgbGVuKGtleSkgPiAxNjoKICAgICAgICByYWlzZSBWYWx1ZUVycm9yKHByZXR0eV9tZXNzYWdlKAogICAgICAgICAgICAnJycKICAgICAgICAgICAga2V5IG11c3QgYmUgNSB0byAxNiBieXRlcyAoNDAgdG8gMTI4IGJpdHMpIGxvbmcgLSBpcyAlcwogICAgICAgICAgICAnJycsCiAgICAgICAgICAgIGxlbihrZXkpCiAgICAgICAgKSkKCiAgICBpZiBub3QgaXY6CiAgICAgICAgaXYgPSByYW5kX2J5dGVzKDgpCiAgICBlbGlmIGxlbihpdikgIT0gODoKICAgICAgICByYWlzZSBWYWx1ZUVycm9yKHByZXR0eV9tZXNzYWdlKAogICAgICAgICAgICAnJycKICAgICAgICAgICAgaXYgbXVzdCBiZSA4IGJ5dGVzIGxvbmcgLSBpcyAlcwogICAgICAgICAgICAnJycsCiAgICAgICAgICAgIGxlbihpdikKICAgICAgICApKQoKICAgIHJldHVybiAoaXYsIF9lbmNyeXB0KCdyYzInLCBrZXksIGRhdGEsIGl2LCBUcnVlKSkKCgpkZWYgcmMyX2NiY19wa2NzNV9kZWNyeXB0KGtleSwgZGF0YSwgaXYpOgogICAgIiIiCiAgICBEZWNyeXB0cyBSQzIgY2lwaGVydGV4dCB1c2luZyBhIDY0IGJpdCBrZXkKCiAgICA6cGFyYW0ga2V5OgogICAgICAgIFRoZSBlbmNyeXB0aW9uIGtleSAtIGEgYnl0ZSBzdHJpbmcgOCBieXRlcyBsb25nCgogICAgOnBhcmFtIGRhdGE6CiAgICAgICAgVGhlIGNpcGhlcnRleHQgLSBhIGJ5dGUgc3RyaW5nCgogICAgOnBhcmFtIGl2OgogICAgICAgIFRoZSBpbml0aWFsaXphdGlvbiB2ZWN0b3IgdXNlZCBmb3IgZW5jcnlwdGlvbiAtIGEgYnl0ZSBzdHJpbmcKCiAgICA6cmFpc2VzOgogICAgICAgIFZhbHVlRXJyb3IgLSB3aGVuIGFueSBvZiB0aGUgcGFyYW1ldGVycyBjb250YWluIGFuIGludmFsaWQgdmFsdWUKICAgICAgICBUeXBlRXJyb3IgLSB3aGVuIGFueSBvZiB0aGUgcGFyYW1ldGVycyBhcmUgb2YgdGhlIHdyb25nIHR5cGUKICAgICAgICBPU0Vycm9yIC0gd2hlbiBhbiBlcnJvciBpcyByZXR1cm5lZCBieSB0aGUgT1MgY3J5cHRvIGxpYnJhcnkKCiAgICA6cmV0dXJuOgogICAgICAgIEEgYnl0ZSBzdHJpbmcgb2YgdGhlIHBsYWludGV4dAogICAgIiIiCgogICAgaWYgbGVuKGtleSkgPCA1IG9yIGxlbihrZXkpID4gMTY6CiAgICAgICAgcmFpc2UgVmFsdWVFcnJvcihwcmV0dHlfbWVzc2FnZSgKICAgICAgICAgICAgJycnCiAgICAgICAgICAgIGtleSBtdXN0IGJlIDUgdG8gMTYgYnl0ZXMgKDQwIHRvIDEyOCBiaXRzKSBsb25nIC0gaXMgJXMKICAgICAgICAgICAgJycnLAogICAgICAgICAgICBsZW4oa2V5KQogICAgICAgICkpCgogICAgaWYgbGVuKGl2KSAhPSA4OgogICAgICAgIHJhaXNlIFZhbHVlRXJyb3IocHJldHR5X21lc3NhZ2UoCiAgICAgICAgICAgICcnJwogICAgICAgICAgICBpdiBtdXN0IGJlIDggYnl0ZXMgbG9uZyAtIGlzICVzCiAgICAgICAgICAgICcnJywKICAgICAgICAgICAgbGVuKGl2KQogICAgICAgICkpCgogICAgcmV0dXJuIF9kZWNyeXB0KCdyYzInLCBrZXksIGRhdGEsIGl2LCBUcnVlKQoKCmRlZiB0cmlwbGVkZXNfY2JjX3BrY3M1X2VuY3J5cHQoa2V5LCBkYXRhLCBpdik6CiAgICAiIiIKICAgIEVuY3J5cHRzIHBsYWludGV4dCB1c2luZyAzREVTIGluIGVpdGhlciAyIG9yIDMga2V5IG1vZGUKCiAgICA6cGFyYW0ga2V5OgogICAgICAgIFRoZSBlbmNyeXB0aW9uIGtleSAtIGEgYnl0ZSBzdHJpbmcgMTYgb3IgMjQgYnl0ZXMgbG9uZyAoMiBvciAzIGtleSBtb2RlKQoKICAgIDpwYXJhbSBkYXRhOgogICAgICAgIFRoZSBwbGFpbnRleHQgLSBhIGJ5dGUgc3RyaW5nCgogICAgOnBhcmFtIGl2OgogICAgICAgIFRoZSA4LWJ5dGUgaW5pdGlhbGl6YXRpb24gdmVjdG9yIHRvIHVzZSAtIGEgYnl0ZSBzdHJpbmcgLSBzZXQgYXMgTm9uZQogICAgICAgIHRvIGdlbmVyYXRlIGFuIGFwcHJvcHJpYXRlIG9uZQoKICAgIDpyYWlzZXM6CiAgICAgICAgVmFsdWVFcnJvciAtIHdoZW4gYW55IG9mIHRoZSBwYXJhbWV0ZXJzIGNvbnRhaW4gYW4gaW52YWxpZCB2YWx1ZQogICAgICAgIFR5cGVFcnJvciAtIHdoZW4gYW55IG9mIHRoZSBwYXJhbWV0ZXJzIGFyZSBvZiB0aGUgd3JvbmcgdHlwZQogICAgICAgIE9TRXJyb3IgLSB3aGVuIGFuIGVycm9yIGlzIHJldHVybmVkIGJ5IHRoZSBPUyBjcnlwdG8gbGlicmFyeQoKICAgIDpyZXR1cm46CiAgICAgICAgQSB0dXBsZSBvZiB0d28gYnl0ZSBzdHJpbmdzIChpdiwgY2lwaGVydGV4dCkKICAgICIiIgoKICAgIGlmIGxlbihrZXkpICE9IDE2IGFuZCBsZW4oa2V5KSAhPSAyNDoKICAgICAgICByYWlzZSBWYWx1ZUVycm9yKHByZXR0eV9tZXNzYWdlKAogICAgICAgICAgICAnJycKICAgICAgICAgICAga2V5IG11c3QgYmUgMTYgYnl0ZXMgKDIga2V5KSBvciAyNCBieXRlcyAoMyBrZXkpIGxvbmcgLSBpcyAlcwogICAgICAgICAgICAnJycsCiAgICAgICAgICAgIGxlbihrZXkpCiAgICAgICAgKSkKCiAgICBpZiBub3QgaXY6CiAgICAgICAgaXYgPSByYW5kX2J5dGVzKDgpCiAgICBlbGlmIGxlbihpdikgIT0gODoKICAgICAgICByYWlzZSBWYWx1ZUVycm9yKHByZXR0eV9tZXNzYWdlKAogICAgICAgICAgICAnJycKICAgICAgICAgICAgaXYgbXVzdCBiZSA4IGJ5dGVzIGxvbmcgLSBpcyAlcwogICAgICAgICAgICAnJycsCiAgICAgICAgICAgIGxlbihpdikKICAgICAgICApKQoKICAgIGNpcGhlciA9ICd0cmlwbGVkZXNfM2tleScKICAgIGlmIGxlbihrZXkpID09IDE2OgogICAgICAgIGNpcGhlciA9ICd0cmlwbGVkZXNfMmtleScKCiAgICByZXR1cm4gKGl2LCBfZW5jcnlwdChjaXBoZXIsIGtleSwgZGF0YSwgaXYsIFRydWUpKQoKCmRlZiB0cmlwbGVkZXNfY2JjX3BrY3M1X2RlY3J5cHQoa2V5LCBkYXRhLCBpdik6CiAgICAiIiIKICAgIERlY3J5cHRzIDNERVMgY2lwaGVydGV4dCBpbiBlaXRoZXIgMiBvciAzIGtleSBtb2RlCgogICAgOnBhcmFtIGtleToKICAgICAgICBUaGUgZW5jcnlwdGlvbiBrZXkgLSBhIGJ5dGUgc3RyaW5nIDE2IG9yIDI0IGJ5dGVzIGxvbmcgKDIgb3IgMyBrZXkgbW9kZSkKCiAgICA6cGFyYW0gZGF0YToKICAgICAgICBUaGUgY2lwaGVydGV4dCAtIGEgYnl0ZSBzdHJpbmcKCiAgICA6cGFyYW0gaXY6CiAgICAgICAgVGhlIGluaXRpYWxpemF0aW9uIHZlY3RvciB1c2VkIGZvciBlbmNyeXB0aW9uIC0gYSBieXRlIHN0cmluZwoKICAgIDpyYWlzZXM6CiAgICAgICAgVmFsdWVFcnJvciAtIHdoZW4gYW55IG9mIHRoZSBwYXJhbWV0ZXJzIGNvbnRhaW4gYW4gaW52YWxpZCB2YWx1ZQogICAgICAgIFR5cGVFcnJvciAtIHdoZW4gYW55IG9mIHRoZSBwYXJhbWV0ZXJzIGFyZSBvZiB0aGUgd3JvbmcgdHlwZQogICAgICAgIE9TRXJyb3IgLSB3aGVuIGFuIGVycm9yIGlzIHJldHVybmVkIGJ5IHRoZSBPUyBjcnlwdG8gbGlicmFyeQoKICAgIDpyZXR1cm46CiAgICAgICAgQSBieXRlIHN0cmluZyBvZiB0aGUgcGxhaW50ZXh0CiAgICAiIiIKCiAgICBpZiBsZW4oa2V5KSAhPSAxNiBhbmQgbGVuKGtleSkgIT0gMjQ6CiAgICAgICAgcmFpc2UgVmFsdWVFcnJvcihwcmV0dHlfbWVzc2FnZSgKICAgICAgICAgICAgJycnCiAgICAgICAgICAgIGtleSBtdXN0IGJlIDE2IGJ5dGVzICgyIGtleSkgb3IgMjQgYnl0ZXMgKDMga2V5KSBsb25nIC0gaXMgJXMKICAgICAgICAgICAgJycnLAogICAgICAgICAgICBsZW4oa2V5KQogICAgICAgICkpCgogICAgaWYgbGVuKGl2KSAhPSA4OgogICAgICAgIHJhaXNlIFZhbHVlRXJyb3IocHJldHR5X21lc3NhZ2UoCiAgICAgICAgICAgICcnJwogICAgICAgICAgICBpdiBtdXN0IGJlIDggYnl0ZXMgbG9uZyAtIGlzICVzCiAgICAgICAgICAgICcnJywKICAgICAgICAgICAgbGVuKGl2KQogICAgICAgICkpCgogICAgY2lwaGVyID0gJ3RyaXBsZWRlc18za2V5JwogICAgaWYgbGVuKGtleSkgPT0gMTY6CiAgICAgICAgY2lwaGVyID0gJ3RyaXBsZWRlc18ya2V5JwoKICAgIHJldHVybiBfZGVjcnlwdChjaXBoZXIsIGtleSwgZGF0YSwgaXYsIFRydWUpCgoKZGVmIGRlc19jYmNfcGtjczVfZW5jcnlwdChrZXksIGRhdGEsIGl2KToKICAgICIiIgogICAgRW5jcnlwdHMgcGxhaW50ZXh0IHVzaW5nIERFUyB3aXRoIGEgNTYgYml0IGtleQoKICAgIDpwYXJhbSBrZXk6CiAgICAgICAgVGhlIGVuY3J5cHRpb24ga2V5IC0gYSBieXRlIHN0cmluZyA4IGJ5dGVzIGxvbmcgKGluY2x1ZGVzIGVycm9yCiAgICAgICAgY29ycmVjdGlvbiBiaXRzKQoKICAgIDpwYXJhbSBkYXRhOgogICAgICAgIFRoZSBwbGFpbnRleHQgLSBhIGJ5dGUgc3RyaW5nCgogICAgOnBhcmFtIGl2OgogICAgICAgIFRoZSA4LWJ5dGUgaW5pdGlhbGl6YXRpb24gdmVjdG9yIHRvIHVzZSAtIGEgYnl0ZSBzdHJpbmcgLSBzZXQgYXMgTm9uZQogICAgICAgIHRvIGdlbmVyYXRlIGFuIGFwcHJvcHJpYXRlIG9uZQoKICAgIDpyYWlzZXM6CiAgICAgICAgVmFsdWVFcnJvciAtIHdoZW4gYW55IG9mIHRoZSBwYXJhbWV0ZXJzIGNvbnRhaW4gYW4gaW52YWxpZCB2YWx1ZQogICAgICAgIFR5cGVFcnJvciAtIHdoZW4gYW55IG9mIHRoZSBwYXJhbWV0ZXJzIGFyZSBvZiB0aGUgd3JvbmcgdHlwZQogICAgICAgIE9TRXJyb3IgLSB3aGVuIGFuIGVycm9yIGlzIHJldHVybmVkIGJ5IHRoZSBPUyBjcnlwdG8gbGlicmFyeQoKICAgIDpyZXR1cm46CiAgICAgICAgQSB0dXBsZSBvZiB0d28gYnl0ZSBzdHJpbmdzIChpdiwgY2lwaGVydGV4dCkKICAgICIiIgoKICAgIGlmIGxlbihrZXkpICE9IDg6CiAgICAgICAgcmFpc2UgVmFsdWVFcnJvcihwcmV0dHlfbWVzc2FnZSgKICAgICAgICAgICAgJycnCiAgICAgICAgICAgIGtleSBtdXN0IGJlIDggYnl0ZXMgKDU2IGJpdHMgKyA4IHBhcml0eSBiaXRzKSBsb25nIC0gaXMgJXMKICAgICAgICAgICAgJycnLAogICAgICAgICAgICBsZW4oa2V5KQogICAgICAgICkpCgogICAgaWYgbm90IGl2OgogICAgICAgIGl2ID0gcmFuZF9ieXRlcyg4KQogICAgZWxpZiBsZW4oaXYpICE9IDg6CiAgICAgICAgcmFpc2UgVmFsdWVFcnJvcihwcmV0dHlfbWVzc2FnZSgKICAgICAgICAgICAgJycnCiAgICAgICAgICAgIGl2IG11c3QgYmUgOCBieXRlcyBsb25nIC0gaXMgJXMKICAgICAgICAgICAgJycnLAogICAgICAgICAgICBsZW4oaXYpCiAgICAgICAgKSkKCiAgICByZXR1cm4gKGl2LCBfZW5jcnlwdCgnZGVzJywga2V5LCBkYXRhLCBpdiwgVHJ1ZSkpCgoKZGVmIGRlc19jYmNfcGtjczVfZGVjcnlwdChrZXksIGRhdGEsIGl2KToKICAgICIiIgogICAgRGVjcnlwdHMgREVTIGNpcGhlcnRleHQgdXNpbmcgYSA1NiBiaXQga2V5CgogICAgOnBhcmFtIGtleToKICAgICAgICBUaGUgZW5jcnlwdGlvbiBrZXkgLSBhIGJ5dGUgc3RyaW5nIDggYnl0ZXMgbG9uZyAoaW5jbHVkZXMgZXJyb3IKICAgICAgICBjb3JyZWN0aW9uIGJpdHMpCgogICAgOnBhcmFtIGRhdGE6CiAgICAgICAgVGhlIGNpcGhlcnRleHQgLSBhIGJ5dGUgc3RyaW5nCgogICAgOnBhcmFtIGl2OgogICAgICAgIFRoZSBpbml0aWFsaXphdGlvbiB2ZWN0b3IgdXNlZCBmb3IgZW5jcnlwdGlvbiAtIGEgYnl0ZSBzdHJpbmcKCiAgICA6cmFpc2VzOgogICAgICAgIFZhbHVlRXJyb3IgLSB3aGVuIGFueSBvZiB0aGUgcGFyYW1ldGVycyBjb250YWluIGFuIGludmFsaWQgdmFsdWUKICAgICAgICBUeXBlRXJyb3IgLSB3aGVuIGFueSBvZiB0aGUgcGFyYW1ldGVycyBhcmUgb2YgdGhlIHdyb25nIHR5cGUKICAgICAgICBPU0Vycm9yIC0gd2hlbiBhbiBlcnJvciBpcyByZXR1cm5lZCBieSB0aGUgT1MgY3J5cHRvIGxpYnJhcnkKCiAgICA6cmV0dXJuOgogICAgICAgIEEgYnl0ZSBzdHJpbmcgb2YgdGhlIHBsYWludGV4dAogICAgIiIiCgogICAgaWYgbGVuKGtleSkgIT0gODoKICAgICAgICByYWlzZSBWYWx1ZUVycm9yKHByZXR0eV9tZXNzYWdlKAogICAgICAgICAgICAnJycKICAgICAgICAgICAga2V5IG11c3QgYmUgOCBieXRlcyAoNTYgYml0cyArIDggcGFyaXR5IGJpdHMpIGxvbmcgLSBpcyAlcwogICAgICAgICAgICAnJycsCiAgICAgICAgICAgIGxlbihrZXkpCiAgICAgICAgKSkKCiAgICBpZiBsZW4oaXYpICE9IDg6CiAgICAgICAgcmFpc2UgVmFsdWVFcnJvcihwcmV0dHlfbWVzc2FnZSgKICAgICAgICAgICAgJycnCiAgICAgICAgICAgIGl2IG11c3QgYmUgOCBieXRlcyBsb25nIC0gaXMgJXMKICAgICAgICAgICAgJycnLAogICAgICAgICAgICBsZW4oaXYpCiAgICAgICAgKSkKCiAgICByZXR1cm4gX2RlY3J5cHQoJ2RlcycsIGtleSwgZGF0YSwgaXYsIFRydWUpCgoKZGVmIF9hZHZhcGkzMl9jcmVhdGVfaGFuZGxlcyhjaXBoZXIsIGtleSwgaXYpOgogICAgIiIiCiAgICBDcmVhdGVzIGFuIEhDUllQVFBST1YgYW5kIEhDUllQVEtFWSBmb3Igc3ltbWV0cmljIGVuY3J5cHRpb24vZGVjcnlwdGlvbi4gVGhlCiAgICBIQ1JZUFRQUk9WIG11c3QgYmUgcmVsZWFzZWQgYnkgY2xvc2VfY29udGV4dF9oYW5kbGUoKSBhbmQgdGhlCiAgICBIQ1JZUFRLRVkgbXVzdCBiZSByZWxlYXNlZCBieSBhZHZhcGkzMi5DcnlwdERlc3Ryb3lLZXkoKSB3aGVuIGRvbmUuCgogICAgOnBhcmFtIGNpcGhlcjoKICAgICAgICBBIHVuaWNvZGUgc3RyaW5nIG9mICJhZXMiLCAiZGVzIiwgInRyaXBsZWRlc18ya2V5IiwgInRyaXBsZWRlc18za2V5IiwKICAgICAgICAicmMyIiwgInJjNCIKCiAgICA6cGFyYW0ga2V5OgogICAgICAgIEEgYnl0ZSBzdHJpbmcgb2YgdGhlIHN5bW1ldHJpYyBrZXkKCiAgICA6cGFyYW0gaXY6CiAgICAgICAgVGhlIGluaXRpYWxpemF0aW9uIHZlY3RvciAtIGEgYnl0ZSBzdHJpbmcgLSB1bnVzZWQgZm9yIFJDNAoKICAgIDpyZXR1cm46CiAgICAgICAgQSB0dXBsZSBvZiAoSENSWVBUUFJPViwgSENSWVBUS0VZKQogICAgIiIiCgogICAgY29udGV4dF9oYW5kbGUgPSBOb25lCgogICAgaWYgY2lwaGVyID09ICdhZXMnOgogICAgICAgIGFsZ29yaXRobV9pZCA9IHsKICAgICAgICAgICAgMTY6IEFkdmFwaTMyQ29uc3QuQ0FMR19BRVNfMTI4LAogICAgICAgICAgICAyNDogQWR2YXBpMzJDb25zdC5DQUxHX0FFU18xOTIsCiAgICAgICAgICAgIDMyOiBBZHZhcGkzMkNvbnN0LkNBTEdfQUVTXzI1NiwKICAgICAgICB9W2xlbihrZXkpXQogICAgZWxzZToKICAgICAgICBhbGdvcml0aG1faWQgPSB7CiAgICAgICAgICAgICdkZXMnOiBBZHZhcGkzMkNvbnN0LkNBTEdfREVTLAogICAgICAgICAgICAndHJpcGxlZGVzXzJrZXknOiBBZHZhcGkzMkNvbnN0LkNBTEdfM0RFU18xMTIsCiAgICAgICAgICAgICd0cmlwbGVkZXNfM2tleSc6IEFkdmFwaTMyQ29uc3QuQ0FMR18zREVTLAogICAgICAgICAgICAncmMyJzogQWR2YXBpMzJDb25zdC5DQUxHX1JDMiwKICAgICAgICAgICAgJ3JjNCc6IEFkdmFwaTMyQ29uc3QuQ0FMR19SQzQsCiAgICAgICAgfVtjaXBoZXJdCgogICAgcHJvdmlkZXIgPSBBZHZhcGkzMkNvbnN0Lk1TX0VOSF9SU0FfQUVTX1BST1YKICAgIGNvbnRleHRfaGFuZGxlID0gb3Blbl9jb250ZXh0X2hhbmRsZShwcm92aWRlciwgdmVyaWZ5X29ubHk9RmFsc2UpCgogICAgYmxvYl9oZWFkZXJfcG9pbnRlciA9IHN0cnVjdChhZHZhcGkzMiwgJ0JMT0JIRUFERVInKQogICAgYmxvYl9oZWFkZXIgPSB1bndyYXAoYmxvYl9oZWFkZXJfcG9pbnRlcikKICAgIGJsb2JfaGVhZGVyLmJUeXBlID0gQWR2YXBpMzJDb25zdC5QTEFJTlRFWFRLRVlCTE9CCiAgICBibG9iX2hlYWRlci5iVmVyc2lvbiA9IEFkdmFwaTMyQ29uc3QuQ1VSX0JMT0JfVkVSU0lPTgogICAgYmxvYl9oZWFkZXIucmVzZXJ2ZWQgPSAwCiAgICBibG9iX2hlYWRlci5haUtleUFsZyA9IGFsZ29yaXRobV9pZAoKICAgIGJsb2Jfc3RydWN0X3BvaW50ZXIgPSBzdHJ1Y3QoYWR2YXBpMzIsICdQTEFJTlRFWFRLRVlCTE9CJykKICAgIGJsb2Jfc3RydWN0ID0gdW53cmFwKGJsb2Jfc3RydWN0X3BvaW50ZXIpCiAgICBibG9iX3N0cnVjdC5oZHIgPSBibG9iX2hlYWRlcgogICAgYmxvYl9zdHJ1Y3QuZHdLZXlTaXplID0gbGVuKGtleSkKCiAgICBibG9iID0gc3RydWN0X2J5dGVzKGJsb2Jfc3RydWN0X3BvaW50ZXIpICsga2V5CgogICAgZmxhZ3MgPSAwCiAgICBpZiBjaXBoZXIgaW4gc2V0KFsncmMyJywgJ3JjNCddKSBhbmQgbGVuKGtleSkgPT0gNToKICAgICAgICBmbGFncyA9IEFkdmFwaTMyQ29uc3QuQ1JZUFRfTk9fU0FMVAoKICAgIGtleV9oYW5kbGVfcG9pbnRlciA9IG5ldyhhZHZhcGkzMiwgJ0hDUllQVEtFWSAqJykKICAgIHJlcyA9IGFkdmFwaTMyLkNyeXB0SW1wb3J0S2V5KAogICAgICAgIGNvbnRleHRfaGFuZGxlLAogICAgICAgIGJsb2IsCiAgICAgICAgbGVuKGJsb2IpLAogICAgICAgIG51bGwoKSwKICAgICAgICBmbGFncywKICAgICAgICBrZXlfaGFuZGxlX3BvaW50ZXIKICAgICkKICAgIGhhbmRsZV9lcnJvcihyZXMpCgogICAga2V5X2hhbmRsZSA9IHVud3JhcChrZXlfaGFuZGxlX3BvaW50ZXIpCgogICAgaWYgY2lwaGVyID09ICdyYzInOgogICAgICAgIGJ1ZiA9IG5ldyhhZHZhcGkzMiwgJ0RXT1JEIConLCBsZW4oa2V5KSAqIDgpCiAgICAgICAgcmVzID0gYWR2YXBpMzIuQ3J5cHRTZXRLZXlQYXJhbSgKICAgICAgICAgICAga2V5X2hhbmRsZSwKICAgICAgICAgICAgQWR2YXBpMzJDb25zdC5LUF9FRkZFQ1RJVkVfS0VZTEVOLAogICAgICAgICAgICBidWYsCiAgICAgICAgICAgIDAKICAgICAgICApCiAgICAgICAgaGFuZGxlX2Vycm9yKHJlcykKCiAgICBpZiBjaXBoZXIgIT0gJ3JjNCc6CiAgICAgICAgcmVzID0gYWR2YXBpMzIuQ3J5cHRTZXRLZXlQYXJhbSgKICAgICAgICAgICAga2V5X2hhbmRsZSwKICAgICAgICAgICAgQWR2YXBpMzJDb25zdC5LUF9JViwKICAgICAgICAgICAgaXYsCiAgICAgICAgICAgIDAKICAgICAgICApCiAgICAgICAgaGFuZGxlX2Vycm9yKHJlcykKCiAgICAgICAgYnVmID0gbmV3KGFkdmFwaTMyLCAnRFdPUkQgKicsIEFkdmFwaTMyQ29uc3QuQ1JZUFRfTU9ERV9DQkMpCiAgICAgICAgcmVzID0gYWR2YXBpMzIuQ3J5cHRTZXRLZXlQYXJhbSgKICAgICAgICAgICAga2V5X2hhbmRsZSwKICAgICAgICAgICAgQWR2YXBpMzJDb25zdC5LUF9NT0RFLAogICAgICAgICAgICBidWYsCiAgICAgICAgICAgIDAKICAgICAgICApCiAgICAgICAgaGFuZGxlX2Vycm9yKHJlcykKCiAgICAgICAgYnVmID0gbmV3KGFkdmFwaTMyLCAnRFdPUkQgKicsIEFkdmFwaTMyQ29uc3QuUEtDUzVfUEFERElORykKICAgICAgICByZXMgPSBhZHZhcGkzMi5DcnlwdFNldEtleVBhcmFtKAogICAgICAgICAgICBrZXlfaGFuZGxlLAogICAgICAgICAgICBBZHZhcGkzMkNvbnN0LktQX1BBRERJTkcsCiAgICAgICAgICAgIGJ1ZiwKICAgICAgICAgICAgMAogICAgICAgICkKICAgICAgICBoYW5kbGVfZXJyb3IocmVzKQoKICAgIHJldHVybiAoY29udGV4dF9oYW5kbGUsIGtleV9oYW5kbGUpCgoKZGVmIF9iY3J5cHRfY3JlYXRlX2tleV9oYW5kbGUoY2lwaGVyLCBrZXkpOgogICAgIiIiCiAgICBDcmVhdGVzIGEgQkNSWVBUX0tFWV9IQU5ETEUgZm9yIHN5bW1ldHJpYyBlbmNyeXB0aW9uL2RlY3J5cHRpb24uIFRoZQogICAgaGFuZGxlIG11c3QgYmUgcmVsZWFzZWQgYnkgYmNyeXB0LkJDcnlwdERlc3Ryb3lLZXkoKSB3aGVuIGRvbmUuCgogICAgOnBhcmFtIGNpcGhlcjoKICAgICAgICBBIHVuaWNvZGUgc3RyaW5nIG9mICJhZXMiLCAiZGVzIiwgInRyaXBsZWRlc18ya2V5IiwgInRyaXBsZWRlc18za2V5IiwKICAgICAgICAicmMyIiwgInJjNCIKCiAgICA6cGFyYW0ga2V5OgogICAgICAgIEEgYnl0ZSBzdHJpbmcgb2YgdGhlIHN5bW1ldHJpYyBrZXkKCiAgICA6cmV0dXJuOgogICAgICAgIEEgQkNSWVBUX0tFWV9IQU5ETEUKICAgICIiIgoKICAgIGFsZ19oYW5kbGUgPSBOb25lCgogICAgYWxnX2NvbnN0YW50ID0gewogICAgICAgICdhZXMnOiBCY3J5cHRDb25zdC5CQ1JZUFRfQUVTX0FMR09SSVRITSwKICAgICAgICAnZGVzJzogQmNyeXB0Q29uc3QuQkNSWVBUX0RFU19BTEdPUklUSE0sCiAgICAgICAgJ3RyaXBsZWRlc18ya2V5JzogQmNyeXB0Q29uc3QuQkNSWVBUXzNERVNfMTEyX0FMR09SSVRITSwKICAgICAgICAndHJpcGxlZGVzXzNrZXknOiBCY3J5cHRDb25zdC5CQ1JZUFRfM0RFU19BTEdPUklUSE0sCiAgICAgICAgJ3JjMic6IEJjcnlwdENvbnN0LkJDUllQVF9SQzJfQUxHT1JJVEhNLAogICAgICAgICdyYzQnOiBCY3J5cHRDb25zdC5CQ1JZUFRfUkM0X0FMR09SSVRITSwKICAgIH1bY2lwaGVyXQoKICAgIHRyeToKICAgICAgICBhbGdfaGFuZGxlID0gb3Blbl9hbGdfaGFuZGxlKGFsZ19jb25zdGFudCkKICAgICAgICBibG9iX3R5cGUgPSBCY3J5cHRDb25zdC5CQ1JZUFRfS0VZX0RBVEFfQkxPQgoKICAgICAgICBibG9iX3N0cnVjdF9wb2ludGVyID0gc3RydWN0KGJjcnlwdCwgJ0JDUllQVF9LRVlfREFUQV9CTE9CX0hFQURFUicpCiAgICAgICAgYmxvYl9zdHJ1Y3QgPSB1bndyYXAoYmxvYl9zdHJ1Y3RfcG9pbnRlcikKICAgICAgICBibG9iX3N0cnVjdC5kd01hZ2ljID0gQmNyeXB0Q29uc3QuQkNSWVBUX0tFWV9EQVRBX0JMT0JfTUFHSUMKICAgICAgICBibG9iX3N0cnVjdC5kd1ZlcnNpb24gPSBCY3J5cHRDb25zdC5CQ1JZUFRfS0VZX0RBVEFfQkxPQl9WRVJTSU9OMQogICAgICAgIGJsb2Jfc3RydWN0LmNiS2V5RGF0YSA9IGxlbihrZXkpCgogICAgICAgIGJsb2IgPSBzdHJ1Y3RfYnl0ZXMoYmxvYl9zdHJ1Y3RfcG9pbnRlcikgKyBrZXkKCiAgICAgICAgaWYgY2lwaGVyID09ICdyYzInOgogICAgICAgICAgICBidWYgPSBuZXcoYmNyeXB0LCAnRFdPUkQgKicsIGxlbihrZXkpICogOCkKICAgICAgICAgICAgcmVzID0gYmNyeXB0LkJDcnlwdFNldFByb3BlcnR5KAogICAgICAgICAgICAgICAgYWxnX2hhbmRsZSwKICAgICAgICAgICAgICAgIEJjcnlwdENvbnN0LkJDUllQVF9FRkZFQ1RJVkVfS0VZX0xFTkdUSCwKICAgICAgICAgICAgICAgIGJ1ZiwKICAgICAgICAgICAgICAgIDQsCiAgICAgICAgICAgICAgICAwCiAgICAgICAgICAgICkKICAgICAgICAgICAgaGFuZGxlX2Vycm9yKHJlcykKCiAgICAgICAga2V5X2hhbmRsZV9wb2ludGVyID0gbmV3KGJjcnlwdCwgJ0JDUllQVF9LRVlfSEFORExFIConKQogICAgICAgIHJlcyA9IGJjcnlwdC5CQ3J5cHRJbXBvcnRLZXkoCiAgICAgICAgICAgIGFsZ19oYW5kbGUsCiAgICAgICAgICAgIG51bGwoKSwKICAgICAgICAgICAgYmxvYl90eXBlLAogICAgICAgICAgICBrZXlfaGFuZGxlX3BvaW50ZXIsCiAgICAgICAgICAgIG51bGwoKSwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgYmxvYiwKICAgICAgICAgICAgbGVuKGJsb2IpLAogICAgICAgICAgICAwCiAgICAgICAgKQogICAgICAgIGhhbmRsZV9lcnJvcihyZXMpCgogICAgICAgIHJldHVybiB1bndyYXAoa2V5X2hhbmRsZV9wb2ludGVyKQoKICAgIGZpbmFsbHk6CiAgICAgICAgaWYgYWxnX2hhbmRsZToKICAgICAgICAgICAgY2xvc2VfYWxnX2hhbmRsZShhbGdfaGFuZGxlKQoKCmRlZiBfZW5jcnlwdChjaXBoZXIsIGtleSwgZGF0YSwgaXYsIHBhZGRpbmcpOgogICAgIiIiCiAgICBFbmNyeXB0cyBwbGFpbnRleHQKCiAgICA6cGFyYW0gY2lwaGVyOgogICAgICAgIEEgdW5pY29kZSBzdHJpbmcgb2YgImFlcyIsICJkZXMiLCAidHJpcGxlZGVzXzJrZXkiLCAidHJpcGxlZGVzXzNrZXkiLAogICAgICAgICJyYzIiLCAicmM0IgoKICAgIDpwYXJhbSBrZXk6CiAgICAgICAgVGhlIGVuY3J5cHRpb24ga2V5IC0gYSBieXRlIHN0cmluZyA1LTE2IGJ5dGVzIGxvbmcKCiAgICA6cGFyYW0gZGF0YToKICAgICAgICBUaGUgcGxhaW50ZXh0IC0gYSBieXRlIHN0cmluZwoKICAgIDpwYXJhbSBpdjoKICAgICAgICBUaGUgaW5pdGlhbGl6YXRpb24gdmVjdG9yIC0gYSBieXRlIHN0cmluZyAtIHVudXNlZCBmb3IgUkM0CgogICAgOnBhcmFtIHBhZGRpbmc6CiAgICAgICAgQm9vbGVhbiwgaWYgcGFkZGluZyBzaG91bGQgYmUgdXNlZCAtIHVudXNlZCBmb3IgUkM0CgogICAgOnJhaXNlczoKICAgICAgICBWYWx1ZUVycm9yIC0gd2hlbiBhbnkgb2YgdGhlIHBhcmFtZXRlcnMgY29udGFpbiBhbiBpbnZhbGlkIHZhbHVlCiAgICAgICAgVHlwZUVycm9yIC0gd2hlbiBhbnkgb2YgdGhlIHBhcmFtZXRlcnMgYXJlIG9mIHRoZSB3cm9uZyB0eXBlCiAgICAgICAgT1NFcnJvciAtIHdoZW4gYW4gZXJyb3IgaXMgcmV0dXJuZWQgYnkgdGhlIE9TIGNyeXB0byBsaWJyYXJ5CgogICAgOnJldHVybjoKICAgICAgICBBIGJ5dGUgc3RyaW5nIG9mIHRoZSBjaXBoZXJ0ZXh0CiAgICAiIiIKCiAgICBpZiBub3QgaXNpbnN0YW5jZShrZXksIGJ5dGVfY2xzKToKICAgICAgICByYWlzZSBUeXBlRXJyb3IocHJldHR5X21lc3NhZ2UoCiAgICAgICAgICAgICcnJwogICAgICAgICAgICBrZXkgbXVzdCBiZSBhIGJ5dGUgc3RyaW5nLCBub3QgJXMKICAgICAgICAgICAgJycnLAogICAgICAgICAgICB0eXBlX25hbWUoa2V5KQogICAgICAgICkpCgogICAgaWYgbm90IGlzaW5zdGFuY2UoZGF0YSwgYnl0ZV9jbHMpOgogICAgICAgIHJhaXNlIFR5cGVFcnJvcihwcmV0dHlfbWVzc2FnZSgKICAgICAgICAgICAgJycnCiAgICAgICAgICAgIGRhdGEgbXVzdCBiZSBhIGJ5dGUgc3RyaW5nLCBub3QgJXMKICAgICAgICAgICAgJycnLAogICAgICAgICAgICB0eXBlX25hbWUoZGF0YSkKICAgICAgICApKQoKICAgIGlmIGNpcGhlciAhPSAncmM0JyBhbmQgbm90IGlzaW5zdGFuY2UoaXYsIGJ5dGVfY2xzKToKICAgICAgICByYWlzZSBUeXBlRXJyb3IocHJldHR5X21lc3NhZ2UoCiAgICAgICAgICAgICcnJwogICAgICAgICAgICBpdiBtdXN0IGJlIGEgYnl0ZSBzdHJpbmcsIG5vdCAlcwogICAgICAgICAgICAnJycsCiAgICAgICAgICAgIHR5cGVfbmFtZShpdikKICAgICAgICApKQoKICAgIGlmIGNpcGhlciAhPSAncmM0JyBhbmQgbm90IHBhZGRpbmc6CiAgICAgICAgIyBBRVMgaW4gQ0JDIG1vZGUgY2FuIGJlIGFsbG93ZWQgd2l0aCBubyBwYWRkaW5nIGlmCiAgICAgICAgIyB0aGUgZGF0YSBpcyBhbiBleGFjdCBtdWx0aXBsZSBvZiB0aGUgYmxvY2sgc2l6ZQogICAgICAgIGlmIG5vdCAoY2lwaGVyID09ICdhZXMnIGFuZCBsZW4oZGF0YSkgJSAxNiA9PSAwKToKICAgICAgICAgICAgcmFpc2UgVmFsdWVFcnJvcigncGFkZGluZyBtdXN0IGJlIHNwZWNpZmllZCcpCgogICAgaWYgX2JhY2tlbmQgPT0gJ3dpbmxlZ2FjeSc6CiAgICAgICAgcmV0dXJuIF9hZHZhcGkzMl9lbmNyeXB0KGNpcGhlciwga2V5LCBkYXRhLCBpdiwgcGFkZGluZykKICAgIHJldHVybiBfYmNyeXB0X2VuY3J5cHQoY2lwaGVyLCBrZXksIGRhdGEsIGl2LCBwYWRkaW5nKQoKCmRlZiBfYWR2YXBpMzJfZW5jcnlwdChjaXBoZXIsIGtleSwgZGF0YSwgaXYsIHBhZGRpbmcpOgogICAgIiIiCiAgICBFbmNyeXB0cyBwbGFpbnRleHQgdmlhIENyeXB0b0FQSQoKICAgIDpwYXJhbSBjaXBoZXI6CiAgICAgICAgQSB1bmljb2RlIHN0cmluZyBvZiAiYWVzIiwgImRlcyIsICJ0cmlwbGVkZXNfMmtleSIsICJ0cmlwbGVkZXNfM2tleSIsCiAgICAgICAgInJjMiIsICJyYzQiCgogICAgOnBhcmFtIGtleToKICAgICAgICBUaGUgZW5jcnlwdGlvbiBrZXkgLSBhIGJ5dGUgc3RyaW5nIDUtMTYgYnl0ZXMgbG9uZwoKICAgIDpwYXJhbSBkYXRhOgogICAgICAgIFRoZSBwbGFpbnRleHQgLSBhIGJ5dGUgc3RyaW5nCgogICAgOnBhcmFtIGl2OgogICAgICAgIFRoZSBpbml0aWFsaXphdGlvbiB2ZWN0b3IgLSBhIGJ5dGUgc3RyaW5nIC0gdW51c2VkIGZvciBSQzQKCiAgICA6cGFyYW0gcGFkZGluZzoKICAgICAgICBCb29sZWFuLCBpZiBwYWRkaW5nIHNob3VsZCBiZSB1c2VkIC0gdW51c2VkIGZvciBSQzQKCiAgICA6cmFpc2VzOgogICAgICAgIFZhbHVlRXJyb3IgLSB3aGVuIGFueSBvZiB0aGUgcGFyYW1ldGVycyBjb250YWluIGFuIGludmFsaWQgdmFsdWUKICAgICAgICBUeXBlRXJyb3IgLSB3aGVuIGFueSBvZiB0aGUgcGFyYW1ldGVycyBhcmUgb2YgdGhlIHdyb25nIHR5cGUKICAgICAgICBPU0Vycm9yIC0gd2hlbiBhbiBlcnJvciBpcyByZXR1cm5lZCBieSB0aGUgT1MgY3J5cHRvIGxpYnJhcnkKCiAgICA6cmV0dXJuOgogICAgICAgIEEgYnl0ZSBzdHJpbmcgb2YgdGhlIGNpcGhlcnRleHQKICAgICIiIgoKICAgIGNvbnRleHRfaGFuZGxlID0gTm9uZQogICAga2V5X2hhbmRsZSA9IE5vbmUKCiAgICB0cnk6CiAgICAgICAgY29udGV4dF9oYW5kbGUsIGtleV9oYW5kbGUgPSBfYWR2YXBpMzJfY3JlYXRlX2hhbmRsZXMoY2lwaGVyLCBrZXksIGl2KQoKICAgICAgICBvdXRfbGVuID0gbmV3KGFkdmFwaTMyLCAnRFdPUkQgKicsIGxlbihkYXRhKSkKICAgICAgICByZXMgPSBhZHZhcGkzMi5DcnlwdEVuY3J5cHQoCiAgICAgICAgICAgIGtleV9oYW5kbGUsCiAgICAgICAgICAgIG51bGwoKSwKICAgICAgICAgICAgVHJ1ZSwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgbnVsbCgpLAogICAgICAgICAgICBvdXRfbGVuLAogICAgICAgICAgICAwCiAgICAgICAgKQogICAgICAgIGhhbmRsZV9lcnJvcihyZXMpCgogICAgICAgIGJ1ZmZlcl9sZW4gPSBkZXJlZihvdXRfbGVuKQogICAgICAgIGJ1ZmZlciA9IGJ1ZmZlcl9mcm9tX2J5dGVzKGJ1ZmZlcl9sZW4pCiAgICAgICAgd3JpdGVfdG9fYnVmZmVyKGJ1ZmZlciwgZGF0YSkKCiAgICAgICAgcG9pbnRlcl9zZXQob3V0X2xlbiwgbGVuKGRhdGEpKQogICAgICAgIHJlcyA9IGFkdmFwaTMyLkNyeXB0RW5jcnlwdCgKICAgICAgICAgICAga2V5X2hhbmRsZSwKICAgICAgICAgICAgbnVsbCgpLAogICAgICAgICAgICBUcnVlLAogICAgICAgICAgICAwLAogICAgICAgICAgICBidWZmZXIsCiAgICAgICAgICAgIG91dF9sZW4sCiAgICAgICAgICAgIGJ1ZmZlcl9sZW4KICAgICAgICApCiAgICAgICAgaGFuZGxlX2Vycm9yKHJlcykKCiAgICAgICAgb3V0cHV0ID0gYnl0ZXNfZnJvbV9idWZmZXIoYnVmZmVyLCBkZXJlZihvdXRfbGVuKSkKCiAgICAgICAgIyBSZW1vdmUgcGFkZGluZyB3aGVuIG5vdCByZXF1aXJlZC4gQ3J5cHRvQVBJIGRvZXNuJ3Qgc3VwcG9ydCB0aGlzLCBzbwogICAgICAgICMgd2UganVzdCBtYW51YWxseSByZW1vdmUgaXQuCiAgICAgICAgaWYgY2lwaGVyID09ICdhZXMnIGFuZCBub3QgcGFkZGluZyBhbmQgbGVuKG91dHB1dCkgPT0gbGVuKGRhdGEpICsgMTY6CiAgICAgICAgICAgIG91dHB1dCA9IG91dHB1dFs6LTE2XQoKICAgICAgICByZXR1cm4gb3V0cHV0CgogICAgZmluYWxseToKICAgICAgICBpZiBrZXlfaGFuZGxlOgogICAgICAgICAgICBhZHZhcGkzMi5DcnlwdERlc3Ryb3lLZXkoa2V5X2hhbmRsZSkKICAgICAgICBpZiBjb250ZXh0X2hhbmRsZToKICAgICAgICAgICAgY2xvc2VfY29udGV4dF9oYW5kbGUoY29udGV4dF9oYW5kbGUpCgoKZGVmIF9iY3J5cHRfZW5jcnlwdChjaXBoZXIsIGtleSwgZGF0YSwgaXYsIHBhZGRpbmcpOgogICAgIiIiCiAgICBFbmNyeXB0cyBwbGFpbnRleHQgdmlhIENORwoKICAgIDpwYXJhbSBjaXBoZXI6CiAgICAgICAgQSB1bmljb2RlIHN0cmluZyBvZiAiYWVzIiwgImRlcyIsICJ0cmlwbGVkZXNfMmtleSIsICJ0cmlwbGVkZXNfM2tleSIsCiAgICAgICAgInJjMiIsICJyYzQiCgogICAgOnBhcmFtIGtleToKICAgICAgICBUaGUgZW5jcnlwdGlvbiBrZXkgLSBhIGJ5dGUgc3RyaW5nIDUtMTYgYnl0ZXMgbG9uZwoKICAgIDpwYXJhbSBkYXRhOgogICAgICAgIFRoZSBwbGFpbnRleHQgLSBhIGJ5dGUgc3RyaW5nCgogICAgOnBhcmFtIGl2OgogICAgICAgIFRoZSBpbml0aWFsaXphdGlvbiB2ZWN0b3IgLSBhIGJ5dGUgc3RyaW5nIC0gdW51c2VkIGZvciBSQzQKCiAgICA6cGFyYW0gcGFkZGluZzoKICAgICAgICBCb29sZWFuLCBpZiBwYWRkaW5nIHNob3VsZCBiZSB1c2VkIC0gdW51c2VkIGZvciBSQzQKCiAgICA6cmFpc2VzOgogICAgICAgIFZhbHVlRXJyb3IgLSB3aGVuIGFueSBvZiB0aGUgcGFyYW1ldGVycyBjb250YWluIGFuIGludmFsaWQgdmFsdWUKICAgICAgICBUeXBlRXJyb3IgLSB3aGVuIGFueSBvZiB0aGUgcGFyYW1ldGVycyBhcmUgb2YgdGhlIHdyb25nIHR5cGUKICAgICAgICBPU0Vycm9yIC0gd2hlbiBhbiBlcnJvciBpcyByZXR1cm5lZCBieSB0aGUgT1MgY3J5cHRvIGxpYnJhcnkKCiAgICA6cmV0dXJuOgogICAgICAgIEEgYnl0ZSBzdHJpbmcgb2YgdGhlIGNpcGhlcnRleHQKICAgICIiIgoKICAgIGtleV9oYW5kbGUgPSBOb25lCgogICAgdHJ5OgogICAgICAgIGtleV9oYW5kbGUgPSBfYmNyeXB0X2NyZWF0ZV9rZXlfaGFuZGxlKGNpcGhlciwga2V5KQoKICAgICAgICBpZiBpdiBpcyBOb25lOgogICAgICAgICAgICBpdl9sZW4gPSAwCiAgICAgICAgZWxzZToKICAgICAgICAgICAgaXZfbGVuID0gbGVuKGl2KQoKICAgICAgICBmbGFncyA9IDAKICAgICAgICBpZiBwYWRkaW5nIGlzIFRydWU6CiAgICAgICAgICAgIGZsYWdzID0gQmNyeXB0Q29uc3QuQkNSWVBUX0JMT0NLX1BBRERJTkcKCiAgICAgICAgb3V0X2xlbiA9IG5ldyhiY3J5cHQsICdVTE9ORyAqJykKICAgICAgICByZXMgPSBiY3J5cHQuQkNyeXB0RW5jcnlwdCgKICAgICAgICAgICAga2V5X2hhbmRsZSwKICAgICAgICAgICAgZGF0YSwKICAgICAgICAgICAgbGVuKGRhdGEpLAogICAgICAgICAgICBudWxsKCksCiAgICAgICAgICAgIG51bGwoKSwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgbnVsbCgpLAogICAgICAgICAgICAwLAogICAgICAgICAgICBvdXRfbGVuLAogICAgICAgICAgICBmbGFncwogICAgICAgICkKICAgICAgICBoYW5kbGVfZXJyb3IocmVzKQoKICAgICAgICBidWZmZXJfbGVuID0gZGVyZWYob3V0X2xlbikKICAgICAgICBidWZmZXIgPSBidWZmZXJfZnJvbV9ieXRlcyhidWZmZXJfbGVuKQogICAgICAgIGl2X2J1ZmZlciA9IGJ1ZmZlcl9mcm9tX2J5dGVzKGl2KSBpZiBpdiBlbHNlIG51bGwoKQoKICAgICAgICByZXMgPSBiY3J5cHQuQkNyeXB0RW5jcnlwdCgKICAgICAgICAgICAga2V5X2hhbmRsZSwKICAgICAgICAgICAgZGF0YSwKICAgICAgICAgICAgbGVuKGRhdGEpLAogICAgICAgICAgICBudWxsKCksCiAgICAgICAgICAgIGl2X2J1ZmZlciwKICAgICAgICAgICAgaXZfbGVuLAogICAgICAgICAgICBidWZmZXIsCiAgICAgICAgICAgIGJ1ZmZlcl9sZW4sCiAgICAgICAgICAgIG91dF9sZW4sCiAgICAgICAgICAgIGZsYWdzCiAgICAgICAgKQogICAgICAgIGhhbmRsZV9lcnJvcihyZXMpCgogICAgICAgIHJldHVybiBieXRlc19mcm9tX2J1ZmZlcihidWZmZXIsIGRlcmVmKG91dF9sZW4pKQoKICAgIGZpbmFsbHk6CiAgICAgICAgaWYga2V5X2hhbmRsZToKICAgICAgICAgICAgYmNyeXB0LkJDcnlwdERlc3Ryb3lLZXkoa2V5X2hhbmRsZSkKCgpkZWYgX2RlY3J5cHQoY2lwaGVyLCBrZXksIGRhdGEsIGl2LCBwYWRkaW5nKToKICAgICIiIgogICAgRGVjcnlwdHMgQUVTL1JDNC9SQzIvM0RFUy9ERVMgY2lwaGVydGV4dAoKICAgIDpwYXJhbSBjaXBoZXI6CiAgICAgICAgQSB1bmljb2RlIHN0cmluZyBvZiAiYWVzIiwgImRlcyIsICJ0cmlwbGVkZXNfMmtleSIsICJ0cmlwbGVkZXNfM2tleSIsCiAgICAgICAgInJjMiIsICJyYzQiCgogICAgOnBhcmFtIGtleToKICAgICAgICBUaGUgZW5jcnlwdGlvbiBrZXkgLSBhIGJ5dGUgc3RyaW5nIDUtMTYgYnl0ZXMgbG9uZwoKICAgIDpwYXJhbSBkYXRhOgogICAgICAgIFRoZSBjaXBoZXJ0ZXh0IC0gYSBieXRlIHN0cmluZwoKICAgIDpwYXJhbSBpdjoKICAgICAgICBUaGUgaW5pdGlhbGl6YXRpb24gdmVjdG9yIC0gYSBieXRlIHN0cmluZyAtIHVudXNlZCBmb3IgUkM0CgogICAgOnBhcmFtIHBhZGRpbmc6CiAgICAgICAgQm9vbGVhbiwgaWYgcGFkZGluZyBzaG91bGQgYmUgdXNlZCAtIHVudXNlZCBmb3IgUkM0CgogICAgOnJhaXNlczoKICAgICAgICBWYWx1ZUVycm9yIC0gd2hlbiBhbnkgb2YgdGhlIHBhcmFtZXRlcnMgY29udGFpbiBhbiBpbnZhbGlkIHZhbHVlCiAgICAgICAgVHlwZUVycm9yIC0gd2hlbiBhbnkgb2YgdGhlIHBhcmFtZXRlcnMgYXJlIG9mIHRoZSB3cm9uZyB0eXBlCiAgICAgICAgT1NFcnJvciAtIHdoZW4gYW4gZXJyb3IgaXMgcmV0dXJuZWQgYnkgdGhlIE9TIGNyeXB0byBsaWJyYXJ5CgogICAgOnJldHVybjoKICAgICAgICBBIGJ5dGUgc3RyaW5nIG9mIHRoZSBwbGFpbnRleHQKICAgICIiIgoKICAgIGlmIG5vdCBpc2luc3RhbmNlKGtleSwgYnl0ZV9jbHMpOgogICAgICAgIHJhaXNlIFR5cGVFcnJvcihwcmV0dHlfbWVzc2FnZSgKICAgICAgICAgICAgJycnCiAgICAgICAgICAgIGtleSBtdXN0IGJlIGEgYnl0ZSBzdHJpbmcsIG5vdCAlcwogICAgICAgICAgICAnJycsCiAgICAgICAgICAgIHR5cGVfbmFtZShrZXkpCiAgICAgICAgKSkKCiAgICBpZiBub3QgaXNpbnN0YW5jZShkYXRhLCBieXRlX2Nscyk6CiAgICAgICAgcmFpc2UgVHlwZUVycm9yKHByZXR0eV9tZXNzYWdlKAogICAgICAgICAgICAnJycKICAgICAgICAgICAgZGF0YSBtdXN0IGJlIGEgYnl0ZSBzdHJpbmcsIG5vdCAlcwogICAgICAgICAgICAnJycsCiAgICAgICAgICAgIHR5cGVfbmFtZShkYXRhKQogICAgICAgICkpCgogICAgaWYgY2lwaGVyICE9ICdyYzQnIGFuZCBub3QgaXNpbnN0YW5jZShpdiwgYnl0ZV9jbHMpOgogICAgICAgIHJhaXNlIFR5cGVFcnJvcihwcmV0dHlfbWVzc2FnZSgKICAgICAgICAgICAgJycnCiAgICAgICAgICAgIGl2IG11c3QgYmUgYSBieXRlIHN0cmluZywgbm90ICVzCiAgICAgICAgICAgICcnJywKICAgICAgICAgICAgdHlwZV9uYW1lKGl2KQogICAgICAgICkpCgogICAgaWYgY2lwaGVyIG5vdCBpbiBzZXQoWydyYzQnLCAnYWVzJ10pIGFuZCBub3QgcGFkZGluZzoKICAgICAgICByYWlzZSBWYWx1ZUVycm9yKCdwYWRkaW5nIG11c3QgYmUgc3BlY2lmaWVkJykKCiAgICBpZiBfYmFja2VuZCA9PSAnd2lubGVnYWN5JzoKICAgICAgICByZXR1cm4gX2FkdmFwaTMyX2RlY3J5cHQoY2lwaGVyLCBrZXksIGRhdGEsIGl2LCBwYWRkaW5nKQogICAgcmV0dXJuIF9iY3J5cHRfZGVjcnlwdChjaXBoZXIsIGtleSwgZGF0YSwgaXYsIHBhZGRpbmcpCgoKZGVmIF9hZHZhcGkzMl9kZWNyeXB0KGNpcGhlciwga2V5LCBkYXRhLCBpdiwgcGFkZGluZyk6CiAgICAiIiIKICAgIERlY3J5cHRzIEFFUy9SQzQvUkMyLzNERVMvREVTIGNpcGhlcnRleHQgdmlhIENyeXB0b0FQSQoKICAgIDpwYXJhbSBjaXBoZXI6CiAgICAgICAgQSB1bmljb2RlIHN0cmluZyBvZiAiYWVzIiwgImRlcyIsICJ0cmlwbGVkZXNfMmtleSIsICJ0cmlwbGVkZXNfM2tleSIsCiAgICAgICAgInJjMiIsICJyYzQiCgogICAgOnBhcmFtIGtleToKICAgICAgICBUaGUgZW5jcnlwdGlvbiBrZXkgLSBhIGJ5dGUgc3RyaW5nIDUtMTYgYnl0ZXMgbG9uZwoKICAgIDpwYXJhbSBkYXRhOgogICAgICAgIFRoZSBjaXBoZXJ0ZXh0IC0gYSBieXRlIHN0cmluZwoKICAgIDpwYXJhbSBpdjoKICAgICAgICBUaGUgaW5pdGlhbGl6YXRpb24gdmVjdG9yIC0gYSBieXRlIHN0cmluZyAtIHVudXNlZCBmb3IgUkM0CgogICAgOnBhcmFtIHBhZGRpbmc6CiAgICAgICAgQm9vbGVhbiwgaWYgcGFkZGluZyBzaG91bGQgYmUgdXNlZCAtIHVudXNlZCBmb3IgUkM0CgogICAgOnJhaXNlczoKICAgICAgICBWYWx1ZUVycm9yIC0gd2hlbiBhbnkgb2YgdGhlIHBhcmFtZXRlcnMgY29udGFpbiBhbiBpbnZhbGlkIHZhbHVlCiAgICAgICAgVHlwZUVycm9yIC0gd2hlbiBhbnkgb2YgdGhlIHBhcmFtZXRlcnMgYXJlIG9mIHRoZSB3cm9uZyB0eXBlCiAgICAgICAgT1NFcnJvciAtIHdoZW4gYW4gZXJyb3IgaXMgcmV0dXJuZWQgYnkgdGhlIE9TIGNyeXB0byBsaWJyYXJ5CgogICAgOnJldHVybjoKICAgICAgICBBIGJ5dGUgc3RyaW5nIG9mIHRoZSBwbGFpbnRleHQKICAgICIiIgoKICAgIGNvbnRleHRfaGFuZGxlID0gTm9uZQogICAga2V5X2hhbmRsZSA9IE5vbmUKCiAgICB0cnk6CiAgICAgICAgY29udGV4dF9oYW5kbGUsIGtleV9oYW5kbGUgPSBfYWR2YXBpMzJfY3JlYXRlX2hhbmRsZXMoY2lwaGVyLCBrZXksIGl2KQoKICAgICAgICBpZiBjaXBoZXIgPT0gJ2FlcycgYW5kIG5vdCBwYWRkaW5nIGFuZCBsZW4oZGF0YSkgJSAxNiAhPSAwOgogICAgICAgICAgICByYWlzZSBWYWx1ZUVycm9yKCdJbnZhbGlkIGRhdGEgLSBjaXBoZXJ0ZXh0IGxlbmd0aCBtdXN0IGJlIGEgbXVsdGlwbGUgb2YgMTYnKQoKICAgICAgICBidWZmZXIgPSBidWZmZXJfZnJvbV9ieXRlcyhkYXRhKQogICAgICAgIG91dF9sZW4gPSBuZXcoYWR2YXBpMzIsICdEV09SRCAqJywgbGVuKGRhdGEpKQogICAgICAgIHJlcyA9IGFkdmFwaTMyLkNyeXB0RGVjcnlwdCgKICAgICAgICAgICAga2V5X2hhbmRsZSwKICAgICAgICAgICAgbnVsbCgpLAogICAgICAgICAgICAjIFRvIHNraXAgcGFkZGluZywgd2UgaGF2ZSB0byB0ZWxsIHRoZSBBUEkgdGhhdCB0aGlzIGlzIG5vdAogICAgICAgICAgICAjIHRoZSBmaW5hbCBibG9jawogICAgICAgICAgICBGYWxzZSBpZiBjaXBoZXIgPT0gJ2FlcycgYW5kIG5vdCBwYWRkaW5nIGVsc2UgVHJ1ZSwKICAgICAgICAgICAgMCwKICAgICAgICAgICAgYnVmZmVyLAogICAgICAgICAgICBvdXRfbGVuCiAgICAgICAgKQogICAgICAgIGhhbmRsZV9lcnJvcihyZXMpCgogICAgICAgIHJldHVybiBieXRlc19mcm9tX2J1ZmZlcihidWZmZXIsIGRlcmVmKG91dF9sZW4pKQoKICAgIGZpbmFsbHk6CiAgICAgICAgaWYga2V5X2hhbmRsZToKICAgICAgICAgICAgYWR2YXBpMzIuQ3J5cHREZXN0cm95S2V5KGtleV9oYW5kbGUpCiAgICAgICAgaWYgY29udGV4dF9oYW5kbGU6CiAgICAgICAgICAgIGNsb3NlX2NvbnRleHRfaGFuZGxlKGNvbnRleHRfaGFuZGxlKQoKCmRlZiBfYmNyeXB0X2RlY3J5cHQoY2lwaGVyLCBrZXksIGRhdGEsIGl2LCBwYWRkaW5nKToKICAgICIiIgogICAgRGVjcnlwdHMgQUVTL1JDNC9SQzIvM0RFUy9ERVMgY2lwaGVydGV4dCB2aWEgQ05HCgogICAgOnBhcmFtIGNpcGhlcjoKICAgICAgICBBIHVuaWNvZGUgc3RyaW5nIG9mICJhZXMiLCAiZGVzIiwgInRyaXBsZWRlc18ya2V5IiwgInRyaXBsZWRlc18za2V5IiwKICAgICAgICAicmMyIiwgInJjNCIKCiAgICA6cGFyYW0ga2V5OgogICAgICAgIFRoZSBlbmNyeXB0aW9uIGtleSAtIGEgYnl0ZSBzdHJpbmcgNS0xNiBieXRlcyBsb25nCgogICAgOnBhcmFtIGRhdGE6CiAgICAgICAgVGhlIGNpcGhlcnRleHQgLSBhIGJ5dGUgc3RyaW5nCgogICAgOnBhcmFtIGl2OgogICAgICAgIFRoZSBpbml0aWFsaXphdGlvbiB2ZWN0b3IgLSBhIGJ5dGUgc3RyaW5nIC0gdW51c2VkIGZvciBSQzQKCiAgICA6cGFyYW0gcGFkZGluZzoKICAgICAgICBCb29sZWFuLCBpZiBwYWRkaW5nIHNob3VsZCBiZSB1c2VkIC0gdW51c2VkIGZvciBSQzQKCiAgICA6cmFpc2VzOgogICAgICAgIFZhbHVlRXJyb3IgLSB3aGVuIGFueSBvZiB0aGUgcGFyYW1ldGVycyBjb250YWluIGFuIGludmFsaWQgdmFsdWUKICAgICAgICBUeXBlRXJyb3IgLSB3aGVuIGFueSBvZiB0aGUgcGFyYW1ldGVycyBhcmUgb2YgdGhlIHdyb25nIHR5cGUKICAgICAgICBPU0Vycm9yIC0gd2hlbiBhbiBlcnJvciBpcyByZXR1cm5lZCBieSB0aGUgT1MgY3J5cHRvIGxpYnJhcnkKCiAgICA6cmV0dXJuOgogICAgICAgIEEgYnl0ZSBzdHJpbmcgb2YgdGhlIHBsYWludGV4dAogICAgIiIiCgogICAga2V5X2hhbmRsZSA9IE5vbmUKCiAgICB0cnk6CiAgICAgICAga2V5X2hhbmRsZSA9IF9iY3J5cHRfY3JlYXRlX2tleV9oYW5kbGUoY2lwaGVyLCBrZXkpCgogICAgICAgIGlmIGl2IGlzIE5vbmU6CiAgICAgICAgICAgIGl2X2xlbiA9IDAKICAgICAgICBlbHNlOgogICAgICAgICAgICBpdl9sZW4gPSBsZW4oaXYpCgogICAgICAgIGZsYWdzID0gMAogICAgICAgIGlmIHBhZGRpbmcgaXMgVHJ1ZToKICAgICAgICAgICAgZmxhZ3MgPSBCY3J5cHRDb25zdC5CQ1JZUFRfQkxPQ0tfUEFERElORwoKICAgICAgICBvdXRfbGVuID0gbmV3KGJjcnlwdCwgJ1VMT05HIConKQogICAgICAgIHJlcyA9IGJjcnlwdC5CQ3J5cHREZWNyeXB0KAogICAgICAgICAgICBrZXlfaGFuZGxlLAogICAgICAgICAgICBkYXRhLAogICAgICAgICAgICBsZW4oZGF0YSksCiAgICAgICAgICAgIG51bGwoKSwKICAgICAgICAgICAgbnVsbCgpLAogICAgICAgICAgICAwLAogICAgICAgICAgICBudWxsKCksCiAgICAgICAgICAgIDAsCiAgICAgICAgICAgIG91dF9sZW4sCiAgICAgICAgICAgIGZsYWdzCiAgICAgICAgKQogICAgICAgIGhhbmRsZV9lcnJvcihyZXMpCgogICAgICAgIGJ1ZmZlcl9sZW4gPSBkZXJlZihvdXRfbGVuKQogICAgICAgIGJ1ZmZlciA9IGJ1ZmZlcl9mcm9tX2J5dGVzKGJ1ZmZlcl9sZW4pCiAgICAgICAgaXZfYnVmZmVyID0gYnVmZmVyX2Zyb21fYnl0ZXMoaXYpIGlmIGl2IGVsc2UgbnVsbCgpCgogICAgICAgIHJlcyA9IGJjcnlwdC5CQ3J5cHREZWNyeXB0KAogICAgICAgICAgICBrZXlfaGFuZGxlLAogICAgICAgICAgICBkYXRhLAogICAgICAgICAgICBsZW4oZGF0YSksCiAgICAgICAgICAgIG51bGwoKSwKICAgICAgICAgICAgaXZfYnVmZmVyLAogICAgICAgICAgICBpdl9sZW4sCiAgICAgICAgICAgIGJ1ZmZlciwKICAgICAgICAgICAgYnVmZmVyX2xlbiwKICAgICAgICAgICAgb3V0X2xlbiwKICAgICAgICAgICAgZmxhZ3MKICAgICAgICApCiAgICAgICAgaGFuZGxlX2Vycm9yKHJlcykKCiAgICAgICAgcmV0dXJuIGJ5dGVzX2Zyb21fYnVmZmVyKGJ1ZmZlciwgZGVyZWYob3V0X2xlbikpCgogICAgZmluYWxseToKICAgICAgICBpZiBrZXlfaGFuZGxlOgogICAgICAgICAgICBiY3J5cHQuQkNyeXB0RGVzdHJveUtleShrZXlfaGFuZGxlKQo=
