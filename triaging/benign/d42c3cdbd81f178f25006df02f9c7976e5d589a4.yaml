statistics:
  total_files: 1
  skipped_files: 0.0
  processed_objects: 1
  malicious_objects: 0
details:
- path: .repo_cache/malicious_repos/pypi_malregistry/pycryptoenv/1.0.7/pycryptoenv-1.0.7/pycryptoenv-1.0.7/pycryptoenv/_win/tls.py
  contents:
  - name: TLSSocket.read_until
    score: 0.0
    code: |-
      def read_until(self, marker):
              """
              Reads data from the socket until a marker is found. Data read may
              include data beyond the marker.

              :param marker:
                  A byte string or regex object from re.compile(). Used to determine
                  when to stop reading. Regex objects are more inefficient since
                  they must scan the entire byte string of read data each time data
                  is read off the socket.

              :return:
                  A byte string of the data read
              """

              if not isinstance(marker, byte_cls) and not isinstance(marker, Pattern):
                  raise TypeError(pretty_message(
                      '''
                      marker must be a byte string or compiled regex object, not %s
                      ''',
                      type_name(marker)
                  ))

              output = b''

              is_regex = isinstance(marker, Pattern)

              while True:
                  if len(self._decrypted_bytes) > 0:
                      chunk = self._decrypted_bytes
                      self._decrypted_bytes = b''
                  else:
                      chunk = self.read(8192)

                  offset = len(output)
                  output += chunk

                  if is_regex:
                      match = marker.search(output)
                      if match is not None:
                          end = match.end()
                          break
                  else:
                      # If the marker was not found last time, we have to start
                      # at a position where the marker would have its final char
                      # in the newly read chunk
                      start = max(0, offset - len(marker) - 1)
                      match = output.find(marker, start)
                      if match != -1:
                          end = match + len(marker)
                          break

              self._decrypted_bytes = output[end:] + self._decrypted_bytes
              return output[0:end]
    tokens: resume load_global isinstance load_fast marker load_global byte_cls call pop_jump_if_true TO_NUMBER load_global isinstance load_fast marker load_global Pattern call pop_jump_if_true TO_NUMBER load_global TypeError load_global pretty_message load_const STRING_LEN_S_ENT_HIGH load_global type_name load_fast marker call call call raise_varargs load_const store_fast output load_global isinstance load_fast marker load_global Pattern call store_fast is_regex nop load_global len load_fast self load_attr STRING_LEN_S_ENT_HIGH call load_const INTEGER compare_op > pop_jump_if_false TO_NUMBER load_fast self load_attr STRING_LEN_S_ENT_HIGH store_fast chunk load_const load_fast self store_attr STRING_LEN_S_ENT_HIGH jump_forward TO_NUMBER load_fast self load_attr read load_const INTEGER call store_fast chunk load_global len load_fast output call store_fast offset load_fast output load_fast chunk binary_op += store_fast output load_fast is_regex pop_jump_if_false TO_NUMBER load_fast marker load_attr search load_fast output call store_fast match load_fast match pop_jump_if_none TO_NUMBER load_fast match load_attr end call store_fast end jump_forward TO_NUMBER load_global max load_const INTEGER load_fast offset load_global len load_fast marker call binary_op - load_const INTEGER binary_op - call store_fast start load_fast output load_attr find load_fast marker load_fast start call store_fast match load_fast match load_const INTEGER compare_op != pop_jump_if_false TO_NUMBER load_fast match load_global len load_fast marker call binary_op + store_fast end jump_forward TO_NUMBER jump_backward TO_NUMBER load_fast output load_fast end load_const binary_slice load_fast self load_attr STRING_LEN_S_ENT_HIGH binary_op + load_fast self store_attr STRING_LEN_S_ENT_HIGH load_fast output load_const INTEGER load_fast end binary_slice return_value
    hash: 8384f53c292cd2fb46e2c544ad746d5aad164b394e292ade0a1daaee5f62eeae
sources:
  .repo_cache/malicious_repos/pypi_malregistry/pycryptoenv/1.0.7/pycryptoenv-1.0.7/pycryptoenv-1.0.7/pycryptoenv/_win/tls.py: IyBjb2Rpbmc6IHV0Zi04CmZyb20gX19mdXR1cmVfXyBpbXBvcnQgdW5pY29kZV9saXRlcmFscywgZGl2aXNpb24sIGFic29sdXRlX2ltcG9ydCwgcHJpbnRfZnVuY3Rpb24KCmltcG9ydCBzeXMKaW1wb3J0IHJlCmltcG9ydCBzb2NrZXQgYXMgc29ja2V0XwppbXBvcnQgc2VsZWN0CmltcG9ydCBudW1iZXJzCgpmcm9tIC4uX2FzbjEgaW1wb3J0IENlcnRpZmljYXRlIGFzIEFzbjFDZXJ0aWZpY2F0ZQpmcm9tIC4uX2Vycm9ycyBpbXBvcnQgcHJldHR5X21lc3NhZ2UKZnJvbSAuLl9mZmkgaW1wb3J0ICgKICAgIGJ1ZmZlcl9mcm9tX2J5dGVzLAogICAgYnVmZmVyX2Zyb21fdW5pY29kZSwKICAgIGJ5dGVzX2Zyb21fYnVmZmVyLAogICAgY2FzdCwKICAgIGRlcmVmLAogICAgaXNfbnVsbCwKICAgIG5hdGl2ZSwKICAgIG5ldywKICAgIG51bGwsCiAgICByZWYsCiAgICBzaXplb2YsCiAgICBzdHJ1Y3QsCiAgICB1bndyYXAsCiAgICB3cml0ZV90b19idWZmZXIsCikKZnJvbSAuX3NlY3VyMzIgaW1wb3J0IHNlY3VyMzIsIFNlY3VyMzJDb25zdCwgaGFuZGxlX2Vycm9yCmZyb20gLl9jcnlwdDMyIGltcG9ydCBjcnlwdDMyLCBDcnlwdDMyQ29uc3QsIGhhbmRsZV9lcnJvciBhcyBoYW5kbGVfY3J5cHQzMl9lcnJvcgpmcm9tIC5fa2VybmVsMzIgaW1wb3J0IGtlcm5lbDMyCmZyb20gLi5fdHlwZXMgaW1wb3J0IHR5cGVfbmFtZSwgc3RyX2NscywgYnl0ZV9jbHMsIGludF90eXBlcwpmcm9tIC4uZXJyb3JzIGltcG9ydCBUTFNFcnJvciwgVExTVmVyaWZpY2F0aW9uRXJyb3IsIFRMU0Rpc2Nvbm5lY3RFcnJvciwgVExTR3JhY2VmdWxEaXNjb25uZWN0RXJyb3IKZnJvbSAuLl90bHMgaW1wb3J0ICgKICAgIGRldGVjdF9jbGllbnRfYXV0aF9yZXF1ZXN0LAogICAgZGV0ZWN0X290aGVyX3Byb3RvY29sLAogICAgZXh0cmFjdF9jaGFpbiwKICAgIGdldF9kaF9wYXJhbXNfbGVuZ3RoLAogICAgcGFyc2VfYWxlcnQsCiAgICBwYXJzZV9zZXNzaW9uX2luZm8sCiAgICByYWlzZV9jbGllbnRfYXV0aCwKICAgIHJhaXNlX2RoX3BhcmFtcywKICAgIHJhaXNlX2Rpc2Nvbm5lY3Rpb24sCiAgICByYWlzZV9leHBpcmVkX25vdF95ZXRfdmFsaWQsCiAgICByYWlzZV9oYW5kc2hha2UsCiAgICByYWlzZV9ob3N0bmFtZSwKICAgIHJhaXNlX25vX2lzc3VlciwKICAgIHJhaXNlX3Byb3RvY29sX2Vycm9yLAogICAgcmFpc2VfcHJvdG9jb2xfdmVyc2lvbiwKICAgIHJhaXNlX3Jldm9rZWQsCiAgICByYWlzZV9zZWxmX3NpZ25lZCwKICAgIHJhaXNlX3ZlcmlmaWNhdGlvbiwKICAgIHJhaXNlX3dlYWtfc2lnbmF0dXJlLAopCmZyb20gLmFzeW1tZXRyaWMgaW1wb3J0IGxvYWRfY2VydGlmaWNhdGUsIENlcnRpZmljYXRlCmZyb20gLi5rZXlzIGltcG9ydCBwYXJzZV9jZXJ0aWZpY2F0ZQoKaWYgc3lzLnZlcnNpb25faW5mbyA8ICgzLCk6CiAgICByYW5nZSA9IHhyYW5nZSAgIyBub3FhCiAgICBzb2NrZXRfZXJyb3JfY2xzID0gc29ja2V0Xy5lcnJvcgplbHNlOgogICAgc29ja2V0X2Vycm9yX2NscyA9IFdpbmRvd3NFcnJvcgoKaWYgc3lzLnZlcnNpb25faW5mbyA8ICgzLCA3KToKICAgIFBhdHRlcm4gPSByZS5fcGF0dGVybl90eXBlCmVsc2U6CiAgICBQYXR0ZXJuID0gcmUuUGF0dGVybgoKCl9fYWxsX18gPSBbCiAgICAnVExTU2Vzc2lvbicsCiAgICAnVExTU29ja2V0JywKXQoKCl9saW5lX3JlZ2V4ID0gcmUuY29tcGlsZShiJyhcclxufFxyfFxuKScpCgpfZ3d2ID0gc3lzLmdldHdpbmRvd3N2ZXJzaW9uKCkKX3dpbl92ZXJzaW9uX2luZm8gPSAoX2d3dlswXSwgX2d3dlsxXSkKCgpjbGFzcyBfVExTRG93bmdyYWRlRXJyb3IoVExTVmVyaWZpY2F0aW9uRXJyb3IpOgoKICAgIHBhc3MKCgpjbGFzcyBfVExTUmV0cnlFcnJvcihUTFNFcnJvcik6CgogICAgIiIiCiAgICBUTFN2MS4yIG9uIFdpbmRvd3MgNyBhbmQgOCBzZWVtcyB0byBoYXZlIGlzdXNlcyB3aXRoIHNvbWUgREhFX1JTQQogICAgU2VydmVyS2V5RXhjaGFuZ2UgbWVzc2FnZXMgZHVlIHRvIHZhcmlhYmxlIGxlbmd0aCBpbnRlZ2VyIGVuY29kaW5nLiBUaGlzCiAgICBleGNlcHRpb24gaXMgdXNlZCB0byB0cmlnZ2VyIGEgcmVjb25uZWN0aW9uIHRvIGF0dGVtcHQgdGhlIGhhbmRzaGFrZSBhZ2Fpbi4KICAgICIiIgoKICAgIHBhc3MKCgpjbGFzcyBUTFNTZXNzaW9uKG9iamVjdCk6CiAgICAiIiIKICAgIEEgVExTIHNlc3Npb24gb2JqZWN0IHRoYXQgbXVsdGlwbGUgVExTU29ja2V0IG9iamVjdHMgY2FuIHNoYXJlIGZvciB0aGUKICAgIHNha2Ugb2Ygc2Vzc2lvbiByZXVzZQogICAgIiIiCgogICAgX3Byb3RvY29scyA9IE5vbmUKICAgIF9jaXBoZXJzID0gTm9uZQogICAgX21hbnVhbF92YWxpZGF0aW9uID0gTm9uZQogICAgX2V4dHJhX3RydXN0X3Jvb3RzID0gTm9uZQogICAgX2NyZWRlbnRpYWxzX2hhbmRsZSA9IE5vbmUKCiAgICBkZWYgX19pbml0X18oc2VsZiwgcHJvdG9jb2w9Tm9uZSwgbWFudWFsX3ZhbGlkYXRpb249RmFsc2UsIGV4dHJhX3RydXN0X3Jvb3RzPU5vbmUpOgogICAgICAgICIiIgogICAgICAgIDpwYXJhbSBwcm90b2NvbDoKICAgICAgICAgICAgQSB1bmljb2RlIHN0cmluZyBvciBzZXQgb2YgdW5pY29kZSBzdHJpbmdzIHJlcHJlc2VudGluZyBhbGxvd2FibGUKICAgICAgICAgICAgcHJvdG9jb2xzIHRvIG5lZ290aWF0ZSB3aXRoIHRoZSBzZXJ2ZXI6CgogICAgICAgICAgICAgLSAiVExTdjEuMiIKICAgICAgICAgICAgIC0gIlRMU3YxLjEiCiAgICAgICAgICAgICAtICJUTFN2MSIKICAgICAgICAgICAgIC0gIlNTTHYzIgoKICAgICAgICAgICAgRGVmYXVsdCBpczogeyJUTFN2MSIsICJUTFN2MS4xIiwgIlRMU3YxLjIifQoKICAgICAgICA6cGFyYW0gbWFudWFsX3ZhbGlkYXRpb246CiAgICAgICAgICAgIElmIGNlcnRpZmljYXRlIGFuZCBjZXJ0aWZpY2F0ZSBwYXRoIHZhbGlkYXRpb24gc2hvdWxkIGJlIHNraXBwZWQKICAgICAgICAgICAgYW5kIGxlZnQgdG8gdGhlIGRldmVsb3BlciB0byBpbXBsZW1lbnQKCiAgICAgICAgOnBhcmFtIGV4dHJhX3RydXN0X3Jvb3RzOgogICAgICAgICAgICBBIGxpc3QgY29udGFpbmluZyBvbmUgb3IgbW9yZSBjZXJ0aWZpY2F0ZXMgdG8gYmUgdHJlYXRlZCBhcyB0cnVzdAogICAgICAgICAgICByb290cywgaW4gb25lIG9mIHRoZSBmb2xsb3dpbmcgZm9ybWF0czoKICAgICAgICAgICAgIC0gQSBieXRlIHN0cmluZyBvZiB0aGUgREVSIGVuY29kZWQgY2VydGlmaWNhdGUKICAgICAgICAgICAgIC0gQSB1bmljb2RlIHN0cmluZyBvZiB0aGUgY2VydGlmaWNhdGUgZmlsZW5hbWUKICAgICAgICAgICAgIC0gQW4gYXNuMWNyeXB0by54NTA5LkNlcnRpZmljYXRlIG9iamVjdAogICAgICAgICAgICAgLSBBbiBvc2NyeXB0by5hc3ltbWV0cmljLkNlcnRpZmljYXRlIG9iamVjdAoKICAgICAgICA6cmFpc2VzOgogICAgICAgICAgICBWYWx1ZUVycm9yIC0gd2hlbiBhbnkgb2YgdGhlIHBhcmFtZXRlcnMgY29udGFpbiBhbiBpbnZhbGlkIHZhbHVlCiAgICAgICAgICAgIFR5cGVFcnJvciAtIHdoZW4gYW55IG9mIHRoZSBwYXJhbWV0ZXJzIGFyZSBvZiB0aGUgd3JvbmcgdHlwZQogICAgICAgICAgICBPU0Vycm9yIC0gd2hlbiBhbiBlcnJvciBpcyByZXR1cm5lZCBieSB0aGUgT1MgY3J5cHRvIGxpYnJhcnkKICAgICAgICAiIiIKCiAgICAgICAgaWYgbm90IGlzaW5zdGFuY2UobWFudWFsX3ZhbGlkYXRpb24sIGJvb2wpOgogICAgICAgICAgICByYWlzZSBUeXBlRXJyb3IocHJldHR5X21lc3NhZ2UoCiAgICAgICAgICAgICAgICAnJycKICAgICAgICAgICAgICAgIG1hbnVhbF92YWxpZGF0aW9uIG11c3QgYmUgYSBib29sZWFuLCBub3QgJXMKICAgICAgICAgICAgICAgICcnJywKICAgICAgICAgICAgICAgIHR5cGVfbmFtZShtYW51YWxfdmFsaWRhdGlvbikKICAgICAgICAgICAgKSkKCiAgICAgICAgc2VsZi5fbWFudWFsX3ZhbGlkYXRpb24gPSBtYW51YWxfdmFsaWRhdGlvbgoKICAgICAgICBpZiBwcm90b2NvbCBpcyBOb25lOgogICAgICAgICAgICBwcm90b2NvbCA9IHNldChbJ1RMU3YxJywgJ1RMU3YxLjEnLCAnVExTdjEuMiddKQoKICAgICAgICBpZiBpc2luc3RhbmNlKHByb3RvY29sLCBzdHJfY2xzKToKICAgICAgICAgICAgcHJvdG9jb2wgPSBzZXQoW3Byb3RvY29sXSkKICAgICAgICBlbGlmIG5vdCBpc2luc3RhbmNlKHByb3RvY29sLCBzZXQpOgogICAgICAgICAgICByYWlzZSBUeXBlRXJyb3IocHJldHR5X21lc3NhZ2UoCiAgICAgICAgICAgICAgICAnJycKICAgICAgICAgICAgICAgIHByb3RvY29sIG11c3QgYmUgYSB1bmljb2RlIHN0cmluZyBvciBzZXQgb2YgdW5pY29kZSBzdHJpbmdzLAogICAgICAgICAgICAgICAgbm90ICVzCiAgICAgICAgICAgICAgICAnJycsCiAgICAgICAgICAgICAgICB0eXBlX25hbWUocHJvdG9jb2wpCiAgICAgICAgICAgICkpCgogICAgICAgIHVuc3VwcG9ydGVkX3Byb3RvY29scyA9IHByb3RvY29sIC0gc2V0KFsnU1NMdjMnLCAnVExTdjEnLCAnVExTdjEuMScsICdUTFN2MS4yJ10pCiAgICAgICAgaWYgdW5zdXBwb3J0ZWRfcHJvdG9jb2xzOgogICAgICAgICAgICByYWlzZSBWYWx1ZUVycm9yKHByZXR0eV9tZXNzYWdlKAogICAgICAgICAgICAgICAgJycnCiAgICAgICAgICAgICAgICBwcm90b2NvbCBtdXN0IGNvbnRhaW4gb25seSB0aGUgdW5pY29kZSBzdHJpbmdzICJTU0x2MyIsICJUTFN2MSIsCiAgICAgICAgICAgICAgICAiVExTdjEuMSIsICJUTFN2MS4yIiwgbm90ICVzCiAgICAgICAgICAgICAgICAnJycsCiAgICAgICAgICAgICAgICByZXByKHVuc3VwcG9ydGVkX3Byb3RvY29scykKICAgICAgICAgICAgKSkKCiAgICAgICAgc2VsZi5fcHJvdG9jb2xzID0gcHJvdG9jb2wKCiAgICAgICAgc2VsZi5fZXh0cmFfdHJ1c3Rfcm9vdHMgPSBbXQogICAgICAgIGlmIGV4dHJhX3RydXN0X3Jvb3RzOgogICAgICAgICAgICBmb3IgZXh0cmFfdHJ1c3Rfcm9vdCBpbiBleHRyYV90cnVzdF9yb290czoKICAgICAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UoZXh0cmFfdHJ1c3Rfcm9vdCwgQ2VydGlmaWNhdGUpOgogICAgICAgICAgICAgICAgICAgIGV4dHJhX3RydXN0X3Jvb3QgPSBleHRyYV90cnVzdF9yb290LmFzbjEKICAgICAgICAgICAgICAgIGVsaWYgaXNpbnN0YW5jZShleHRyYV90cnVzdF9yb290LCBieXRlX2Nscyk6CiAgICAgICAgICAgICAgICAgICAgZXh0cmFfdHJ1c3Rfcm9vdCA9IHBhcnNlX2NlcnRpZmljYXRlKGV4dHJhX3RydXN0X3Jvb3QpCiAgICAgICAgICAgICAgICBlbGlmIGlzaW5zdGFuY2UoZXh0cmFfdHJ1c3Rfcm9vdCwgc3RyX2Nscyk6CiAgICAgICAgICAgICAgICAgICAgd2l0aCBvcGVuKGV4dHJhX3RydXN0X3Jvb3QsICdyYicpIGFzIGY6CiAgICAgICAgICAgICAgICAgICAgICAgIGV4dHJhX3RydXN0X3Jvb3QgPSBwYXJzZV9jZXJ0aWZpY2F0ZShmLnJlYWQoKSkKICAgICAgICAgICAgICAgIGVsaWYgbm90IGlzaW5zdGFuY2UoZXh0cmFfdHJ1c3Rfcm9vdCwgQXNuMUNlcnRpZmljYXRlKToKICAgICAgICAgICAgICAgICAgICByYWlzZSBUeXBlRXJyb3IocHJldHR5X21lc3NhZ2UoCiAgICAgICAgICAgICAgICAgICAgICAgICcnJwogICAgICAgICAgICAgICAgICAgICAgICBleHRyYV90cnVzdF9yb290cyBtdXN0IGJlIGEgbGlzdCBvZiBieXRlIHN0cmluZ3MsIHVuaWNvZGUKICAgICAgICAgICAgICAgICAgICAgICAgc3RyaW5ncywgYXNuMWNyeXB0by54NTA5LkNlcnRpZmljYXRlIG9iamVjdHMgb3IKICAgICAgICAgICAgICAgICAgICAgICAgb3NjcnlwdG8uYXN5bW1ldHJpYy5DZXJ0aWZpY2F0ZSBvYmplY3RzLCBub3QgJXMKICAgICAgICAgICAgICAgICAgICAgICAgJycnLAogICAgICAgICAgICAgICAgICAgICAgICB0eXBlX25hbWUoZXh0cmFfdHJ1c3Rfcm9vdCkKICAgICAgICAgICAgICAgICAgICApKQogICAgICAgICAgICAgICAgc2VsZi5fZXh0cmFfdHJ1c3Rfcm9vdHMuYXBwZW5kKGV4dHJhX3RydXN0X3Jvb3QpCgogICAgICAgIHNlbGYuX29idGFpbl9jcmVkZW50aWFscygpCgogICAgZGVmIF9vYnRhaW5fY3JlZGVudGlhbHMoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgT2J0YWlucyBhIGNyZWRlbnRpYWxzIGhhbmRsZSBmcm9tIHNlY3VyMzIuZGxsIGZvciB1c2Ugd2l0aCBTQ2hhbm5lbAogICAgICAgICIiIgoKICAgICAgICBwcm90b2NvbF92YWx1ZXMgPSB7CiAgICAgICAgICAgICdTU0x2Myc6IFNlY3VyMzJDb25zdC5TUF9QUk9UX1NTTDNfQ0xJRU5ULAogICAgICAgICAgICAnVExTdjEnOiBTZWN1cjMyQ29uc3QuU1BfUFJPVF9UTFMxX0NMSUVOVCwKICAgICAgICAgICAgJ1RMU3YxLjEnOiBTZWN1cjMyQ29uc3QuU1BfUFJPVF9UTFMxXzFfQ0xJRU5ULAogICAgICAgICAgICAnVExTdjEuMic6IFNlY3VyMzJDb25zdC5TUF9QUk9UX1RMUzFfMl9DTElFTlQsCiAgICAgICAgfQogICAgICAgIHByb3RvY29sX2JpdF9tYXNrID0gMAogICAgICAgIGZvciBrZXksIHZhbHVlIGluIHByb3RvY29sX3ZhbHVlcy5pdGVtcygpOgogICAgICAgICAgICBpZiBrZXkgaW4gc2VsZi5fcHJvdG9jb2xzOgogICAgICAgICAgICAgICAgcHJvdG9jb2xfYml0X21hc2sgfD0gdmFsdWUKCiAgICAgICAgYWxncyA9IFsKICAgICAgICAgICAgU2VjdXIzMkNvbnN0LkNBTEdfQUVTXzEyOCwKICAgICAgICAgICAgU2VjdXIzMkNvbnN0LkNBTEdfQUVTXzI1NiwKICAgICAgICAgICAgU2VjdXIzMkNvbnN0LkNBTEdfM0RFUywKICAgICAgICAgICAgU2VjdXIzMkNvbnN0LkNBTEdfU0hBMSwKICAgICAgICAgICAgU2VjdXIzMkNvbnN0LkNBTEdfRUNESEUsCiAgICAgICAgICAgIFNlY3VyMzJDb25zdC5DQUxHX0RIX0VQSEVNLAogICAgICAgICAgICBTZWN1cjMyQ29uc3QuQ0FMR19SU0FfS0VZWCwKICAgICAgICAgICAgU2VjdXIzMkNvbnN0LkNBTEdfUlNBX1NJR04sCiAgICAgICAgICAgIFNlY3VyMzJDb25zdC5DQUxHX0VDRFNBLAogICAgICAgICAgICBTZWN1cjMyQ29uc3QuQ0FMR19EU1NfU0lHTiwKICAgICAgICBdCiAgICAgICAgaWYgJ1RMU3YxLjInIGluIHNlbGYuX3Byb3RvY29sczoKICAgICAgICAgICAgYWxncy5leHRlbmQoWwogICAgICAgICAgICAgICAgU2VjdXIzMkNvbnN0LkNBTEdfU0hBNTEyLAogICAgICAgICAgICAgICAgU2VjdXIzMkNvbnN0LkNBTEdfU0hBMzg0LAogICAgICAgICAgICAgICAgU2VjdXIzMkNvbnN0LkNBTEdfU0hBMjU2LAogICAgICAgICAgICBdKQoKICAgICAgICBhbGdfYXJyYXkgPSBuZXcoc2VjdXIzMiwgJ0FMR19JRFslc10nICUgbGVuKGFsZ3MpKQogICAgICAgIGZvciBpbmRleCwgYWxnIGluIGVudW1lcmF0ZShhbGdzKToKICAgICAgICAgICAgYWxnX2FycmF5W2luZGV4XSA9IGFsZwoKICAgICAgICBmbGFncyA9IFNlY3VyMzJDb25zdC5TQ0hfVVNFX1NUUk9OR19DUllQVE8gfCBTZWN1cjMyQ29uc3QuU0NIX0NSRURfTk9fREVGQVVMVF9DUkVEUwogICAgICAgIGlmIG5vdCBzZWxmLl9tYW51YWxfdmFsaWRhdGlvbiBhbmQgbm90IHNlbGYuX2V4dHJhX3RydXN0X3Jvb3RzOgogICAgICAgICAgICBmbGFncyB8PSBTZWN1cjMyQ29uc3QuU0NIX0NSRURfQVVUT19DUkVEX1ZBTElEQVRJT04KICAgICAgICBlbHNlOgogICAgICAgICAgICBmbGFncyB8PSBTZWN1cjMyQ29uc3QuU0NIX0NSRURfTUFOVUFMX0NSRURfVkFMSURBVElPTgoKICAgICAgICBzY2hhbm5lbF9jcmVkX3BvaW50ZXIgPSBzdHJ1Y3Qoc2VjdXIzMiwgJ1NDSEFOTkVMX0NSRUQnKQogICAgICAgIHNjaGFubmVsX2NyZWQgPSB1bndyYXAoc2NoYW5uZWxfY3JlZF9wb2ludGVyKQoKICAgICAgICBzY2hhbm5lbF9jcmVkLmR3VmVyc2lvbiA9IFNlY3VyMzJDb25zdC5TQ0hBTk5FTF9DUkVEX1ZFUlNJT04KICAgICAgICBzY2hhbm5lbF9jcmVkLmNDcmVkcyA9IDAKICAgICAgICBzY2hhbm5lbF9jcmVkLnBhQ3JlZCA9IG51bGwoKQogICAgICAgIHNjaGFubmVsX2NyZWQuaFJvb3RTdG9yZSA9IG51bGwoKQogICAgICAgIHNjaGFubmVsX2NyZWQuY01hcHBlcnMgPSAwCiAgICAgICAgc2NoYW5uZWxfY3JlZC5hcGhNYXBwZXJzID0gbnVsbCgpCiAgICAgICAgc2NoYW5uZWxfY3JlZC5jU3VwcG9ydGVkQWxncyA9IGxlbihhbGdfYXJyYXkpCiAgICAgICAgc2NoYW5uZWxfY3JlZC5wYWxnU3VwcG9ydGVkQWxncyA9IGFsZ19hcnJheQogICAgICAgIHNjaGFubmVsX2NyZWQuZ3JiaXRFbmFibGVkUHJvdG9jb2xzID0gcHJvdG9jb2xfYml0X21hc2sKICAgICAgICBzY2hhbm5lbF9jcmVkLmR3TWluaW11bUNpcGhlclN0cmVuZ3RoID0gMAogICAgICAgIHNjaGFubmVsX2NyZWQuZHdNYXhpbXVtQ2lwaGVyU3RyZW5ndGggPSAwCiAgICAgICAgIyBEZWZhdWx0IHNlc3Npb24gbGlmZXRpbWUgaXMgMTAgaG91cnMKICAgICAgICBzY2hhbm5lbF9jcmVkLmR3U2Vzc2lvbkxpZmVzcGFuID0gMAogICAgICAgIHNjaGFubmVsX2NyZWQuZHdGbGFncyA9IGZsYWdzCiAgICAgICAgc2NoYW5uZWxfY3JlZC5kd0NyZWRGb3JtYXQgPSAwCgogICAgICAgIGNyZWRfaGFuZGxlX3BvaW50ZXIgPSBuZXcoc2VjdXIzMiwgJ0NyZWRIYW5kbGUgKicpCgogICAgICAgIHJlc3VsdCA9IHNlY3VyMzIuQWNxdWlyZUNyZWRlbnRpYWxzSGFuZGxlVygKICAgICAgICAgICAgbnVsbCgpLAogICAgICAgICAgICBTZWN1cjMyQ29uc3QuVU5JU1BfTkFNRSwKICAgICAgICAgICAgU2VjdXIzMkNvbnN0LlNFQ1BLR19DUkVEX09VVEJPVU5ELAogICAgICAgICAgICBudWxsKCksCiAgICAgICAgICAgIHNjaGFubmVsX2NyZWRfcG9pbnRlciwKICAgICAgICAgICAgbnVsbCgpLAogICAgICAgICAgICBudWxsKCksCiAgICAgICAgICAgIGNyZWRfaGFuZGxlX3BvaW50ZXIsCiAgICAgICAgICAgIG51bGwoKQogICAgICAgICkKICAgICAgICBoYW5kbGVfZXJyb3IocmVzdWx0KQoKICAgICAgICBzZWxmLl9jcmVkZW50aWFsc19oYW5kbGUgPSBjcmVkX2hhbmRsZV9wb2ludGVyCgogICAgZGVmIF9fZGVsX18oc2VsZik6CiAgICAgICAgaWYgc2VsZi5fY3JlZGVudGlhbHNfaGFuZGxlOgogICAgICAgICAgICByZXN1bHQgPSBzZWN1cjMyLkZyZWVDcmVkZW50aWFsc0hhbmRsZShzZWxmLl9jcmVkZW50aWFsc19oYW5kbGUpCiAgICAgICAgICAgIGhhbmRsZV9lcnJvcihyZXN1bHQpCiAgICAgICAgICAgIHNlbGYuX2NyZWRlbnRpYWxzX2hhbmRsZSA9IE5vbmUKCgpjbGFzcyBUTFNTb2NrZXQob2JqZWN0KToKICAgICIiIgogICAgQSB3cmFwcGVyIGFyb3VuZCBhIHNvY2tldC5zb2NrZXQgdGhhdCBhZGRzIFRMUwogICAgIiIiCgogICAgX3NvY2tldCA9IE5vbmUKICAgIF9zZXNzaW9uID0gTm9uZQoKICAgIF9jb250ZXh0X2hhbmRsZV9wb2ludGVyID0gTm9uZQogICAgX2NvbnRleHRfZmxhZ3MgPSBOb25lCiAgICBfaG9zdG5hbWUgPSBOb25lCgogICAgX2hlYWRlcl9zaXplID0gTm9uZQogICAgX21lc3NhZ2Vfc2l6ZSA9IE5vbmUKICAgIF90cmFpbGVyX3NpemUgPSBOb25lCgogICAgX3JlY2VpdmVkX2J5dGVzID0gTm9uZQogICAgX2RlY3J5cHRlZF9ieXRlcyA9IE5vbmUKCiAgICBfZW5jcnlwdF9kZXNjID0gTm9uZQogICAgX2VuY3J5cHRfYnVmZmVycyA9IE5vbmUKICAgIF9lbmNyeXB0X2RhdGFfYnVmZmVyID0gTm9uZQoKICAgIF9kZWNyeXB0X2Rlc2MgPSBOb25lCiAgICBfZGVjcnlwdF9idWZmZXJzID0gTm9uZQogICAgX2RlY3J5cHRfZGF0YV9idWZmZXIgPSBOb25lCgogICAgX2NlcnRpZmljYXRlID0gTm9uZQogICAgX2ludGVybWVkaWF0ZXMgPSBOb25lCgogICAgX3Byb3RvY29sID0gTm9uZQogICAgX2NpcGhlcl9zdWl0ZSA9IE5vbmUKICAgIF9jb21wcmVzc2lvbiA9IE5vbmUKICAgIF9zZXNzaW9uX2lkID0gTm9uZQogICAgX3Nlc3Npb25fdGlja2V0ID0gTm9uZQoKICAgIF9yZW1vdGVfY2xvc2VkID0gRmFsc2UKCiAgICBAY2xhc3NtZXRob2QKICAgIGRlZiB3cmFwKGNscywgc29ja2V0LCBob3N0bmFtZSwgc2Vzc2lvbj1Ob25lKToKICAgICAgICAiIiIKICAgICAgICBUYWtlcyBhbiBleGlzdGluZyBzb2NrZXQgYW5kIGFkZHMgVExTCgogICAgICAgIDpwYXJhbSBzb2NrZXQ6CiAgICAgICAgICAgIEEgc29ja2V0LnNvY2tldCBvYmplY3QgdG8gd3JhcCB3aXRoIFRMUwoKICAgICAgICA6cGFyYW0gaG9zdG5hbWU6CiAgICAgICAgICAgIEEgdW5pY29kZSBzdHJpbmcgb2YgdGhlIGhvc3RuYW1lIG9yIElQIHRoZSBzb2NrZXQgaXMgY29ubmVjdGVkIHRvCgogICAgICAgIDpwYXJhbSBzZXNzaW9uOgogICAgICAgICAgICBBbiBleGlzdGluZyBUTFNTZXNzaW9uIG9iamVjdCB0byBhbGxvdyBmb3Igc2Vzc2lvbiByZXVzZSwgc3BlY2lmaWMKICAgICAgICAgICAgcHJvdG9jb2wgb3IgbWFudWFsIGNlcnRpZmljYXRlIHZhbGlkYXRpb24KCiAgICAgICAgOnJhaXNlczoKICAgICAgICAgICAgVmFsdWVFcnJvciAtIHdoZW4gYW55IG9mIHRoZSBwYXJhbWV0ZXJzIGNvbnRhaW4gYW4gaW52YWxpZCB2YWx1ZQogICAgICAgICAgICBUeXBlRXJyb3IgLSB3aGVuIGFueSBvZiB0aGUgcGFyYW1ldGVycyBhcmUgb2YgdGhlIHdyb25nIHR5cGUKICAgICAgICAgICAgT1NFcnJvciAtIHdoZW4gYW4gZXJyb3IgaXMgcmV0dXJuZWQgYnkgdGhlIE9TIGNyeXB0byBsaWJyYXJ5CiAgICAgICAgIiIiCgogICAgICAgIGlmIG5vdCBpc2luc3RhbmNlKHNvY2tldCwgc29ja2V0Xy5zb2NrZXQpOgogICAgICAgICAgICByYWlzZSBUeXBlRXJyb3IocHJldHR5X21lc3NhZ2UoCiAgICAgICAgICAgICAgICAnJycKICAgICAgICAgICAgICAgIHNvY2tldCBtdXN0IGJlIGFuIGluc3RhbmNlIG9mIHNvY2tldC5zb2NrZXQsIG5vdCAlcwogICAgICAgICAgICAgICAgJycnLAogICAgICAgICAgICAgICAgdHlwZV9uYW1lKHNvY2tldCkKICAgICAgICAgICAgKSkKCiAgICAgICAgaWYgbm90IGlzaW5zdGFuY2UoaG9zdG5hbWUsIHN0cl9jbHMpOgogICAgICAgICAgICByYWlzZSBUeXBlRXJyb3IocHJldHR5X21lc3NhZ2UoCiAgICAgICAgICAgICAgICAnJycKICAgICAgICAgICAgICAgIGhvc3RuYW1lIG11c3QgYmUgYSB1bmljb2RlIHN0cmluZywgbm90ICVzCiAgICAgICAgICAgICAgICAnJycsCiAgICAgICAgICAgICAgICB0eXBlX25hbWUoaG9zdG5hbWUpCiAgICAgICAgICAgICkpCgogICAgICAgIGlmIHNlc3Npb24gaXMgbm90IE5vbmUgYW5kIG5vdCBpc2luc3RhbmNlKHNlc3Npb24sIFRMU1Nlc3Npb24pOgogICAgICAgICAgICByYWlzZSBUeXBlRXJyb3IocHJldHR5X21lc3NhZ2UoCiAgICAgICAgICAgICAgICAnJycKICAgICAgICAgICAgICAgIHNlc3Npb24gbXVzdCBiZSBhbiBpbnN0YW5jZSBvZiBvc2NyeXB0by50bHMuVExTU2Vzc2lvbiwgbm90ICVzCiAgICAgICAgICAgICAgICAnJycsCiAgICAgICAgICAgICAgICB0eXBlX25hbWUoc2Vzc2lvbikKICAgICAgICAgICAgKSkKCiAgICAgICAgbmV3X3NvY2tldCA9IGNscyhOb25lLCBOb25lLCBzZXNzaW9uPXNlc3Npb24pCiAgICAgICAgbmV3X3NvY2tldC5fc29ja2V0ID0gc29ja2V0CiAgICAgICAgbmV3X3NvY2tldC5faG9zdG5hbWUgPSBob3N0bmFtZQoKICAgICAgICAjIFNpbmNlIHdlIGRvbid0IGNyZWF0ZSB0aGUgc29ja2V0IGNvbm5lY3Rpb24gaGVyZSwgd2UgY2FuJ3QgdHJ5IHRvCiAgICAgICAgIyByZWNvbm5lY3Qgd2l0aCBhIGxvd2VyIHZlcnNpb24gb2YgdGhlIFRMUyBwcm90b2NvbCwgc28gd2UganVzdAogICAgICAgICMgbW92ZSB0aGUgZGF0YSB0byBwdWJsaWMgZXhjZXB0aW9uIHR5cGUgVExTVmVyaWZpY2F0aW9uRXJyb3IoKQogICAgICAgIHRyeToKICAgICAgICAgICAgbmV3X3NvY2tldC5faGFuZHNoYWtlKCkKICAgICAgICBleGNlcHQgKF9UTFNEb3duZ3JhZGVFcnJvcikgYXMgZToKICAgICAgICAgICAgbmV3X2UgPSBUTFNWZXJpZmljYXRpb25FcnJvcihlLm1lc3NhZ2UsIGUuY2VydGlmaWNhdGUpCiAgICAgICAgICAgIHJhaXNlIG5ld19lCiAgICAgICAgZXhjZXB0IChfVExTUmV0cnlFcnJvcikgYXMgZToKICAgICAgICAgICAgbmV3X2UgPSBUTFNFcnJvcihlLm1lc3NhZ2UpCiAgICAgICAgICAgIHJhaXNlIG5ld19lCgogICAgICAgIHJldHVybiBuZXdfc29ja2V0CgogICAgZGVmIF9faW5pdF9fKHNlbGYsIGFkZHJlc3MsIHBvcnQsIHRpbWVvdXQ9MTAsIHNlc3Npb249Tm9uZSk6CiAgICAgICAgIiIiCiAgICAgICAgOnBhcmFtIGFkZHJlc3M6CiAgICAgICAgICAgIEEgdW5pY29kZSBzdHJpbmcgb2YgdGhlIGRvbWFpbiBuYW1lIG9yIElQIGFkZHJlc3MgdG8gY29ubmVjdCB0bwoKICAgICAgICA6cGFyYW0gcG9ydDoKICAgICAgICAgICAgQW4gaW50ZWdlciBvZiB0aGUgcG9ydCBudW1iZXIgdG8gY29ubmVjdCB0bwoKICAgICAgICA6cGFyYW0gdGltZW91dDoKICAgICAgICAgICAgQW4gaW50ZWdlciB0aW1lb3V0IHRvIHVzZSBmb3IgdGhlIHNvY2tldAoKICAgICAgICA6cGFyYW0gc2Vzc2lvbjoKICAgICAgICAgICAgQW4gb3NjcnlwdG8udGxzLlRMU1Nlc3Npb24gb2JqZWN0IHRvIGFsbG93IGZvciBzZXNzaW9uIHJldXNlIGFuZAogICAgICAgICAgICBjb250cm9sbGluZyB0aGUgcHJvdG9jb2xzIGFuZCB2YWxpZGF0aW9uIHBlcmZvcm1lZAogICAgICAgICIiIgoKICAgICAgICBzZWxmLl9yZWNlaXZlZF9ieXRlcyA9IGInJwogICAgICAgIHNlbGYuX2RlY3J5cHRlZF9ieXRlcyA9IGInJwoKICAgICAgICBpZiBhZGRyZXNzIGlzIE5vbmUgYW5kIHBvcnQgaXMgTm9uZToKICAgICAgICAgICAgc2VsZi5fc29ja2V0ID0gTm9uZQoKICAgICAgICBlbHNlOgogICAgICAgICAgICBpZiBub3QgaXNpbnN0YW5jZShhZGRyZXNzLCBzdHJfY2xzKToKICAgICAgICAgICAgICAgIHJhaXNlIFR5cGVFcnJvcihwcmV0dHlfbWVzc2FnZSgKICAgICAgICAgICAgICAgICAgICAnJycKICAgICAgICAgICAgICAgICAgICBhZGRyZXNzIG11c3QgYmUgYSB1bmljb2RlIHN0cmluZywgbm90ICVzCiAgICAgICAgICAgICAgICAgICAgJycnLAogICAgICAgICAgICAgICAgICAgIHR5cGVfbmFtZShhZGRyZXNzKQogICAgICAgICAgICAgICAgKSkKCiAgICAgICAgICAgIGlmIG5vdCBpc2luc3RhbmNlKHBvcnQsIGludF90eXBlcyk6CiAgICAgICAgICAgICAgICByYWlzZSBUeXBlRXJyb3IocHJldHR5X21lc3NhZ2UoCiAgICAgICAgICAgICAgICAgICAgJycnCiAgICAgICAgICAgICAgICAgICAgcG9ydCBtdXN0IGJlIGFuIGludGVnZXIsIG5vdCAlcwogICAgICAgICAgICAgICAgICAgICcnJywKICAgICAgICAgICAgICAgICAgICB0eXBlX25hbWUocG9ydCkKICAgICAgICAgICAgICAgICkpCgogICAgICAgICAgICBpZiB0aW1lb3V0IGlzIG5vdCBOb25lIGFuZCBub3QgaXNpbnN0YW5jZSh0aW1lb3V0LCBudW1iZXJzLk51bWJlcik6CiAgICAgICAgICAgICAgICByYWlzZSBUeXBlRXJyb3IocHJldHR5X21lc3NhZ2UoCiAgICAgICAgICAgICAgICAgICAgJycnCiAgICAgICAgICAgICAgICAgICAgdGltZW91dCBtdXN0IGJlIGEgbnVtYmVyLCBub3QgJXMKICAgICAgICAgICAgICAgICAgICAnJycsCiAgICAgICAgICAgICAgICAgICAgdHlwZV9uYW1lKHRpbWVvdXQpCiAgICAgICAgICAgICAgICApKQoKICAgICAgICAgICAgc2VsZi5fc29ja2V0ID0gc29ja2V0Xy5jcmVhdGVfY29ubmVjdGlvbigoYWRkcmVzcywgcG9ydCksIHRpbWVvdXQpCiAgICAgICAgICAgIHNlbGYuX3NvY2tldC5zZXR0aW1lb3V0KHRpbWVvdXQpCgogICAgICAgIGlmIHNlc3Npb24gaXMgTm9uZToKICAgICAgICAgICAgc2Vzc2lvbiA9IFRMU1Nlc3Npb24oKQoKICAgICAgICBlbGlmIG5vdCBpc2luc3RhbmNlKHNlc3Npb24sIFRMU1Nlc3Npb24pOgogICAgICAgICAgICByYWlzZSBUeXBlRXJyb3IocHJldHR5X21lc3NhZ2UoCiAgICAgICAgICAgICAgICAnJycKICAgICAgICAgICAgICAgIHNlc3Npb24gbXVzdCBiZSBhbiBpbnN0YW5jZSBvZiBvc2NyeXB0by50bHMuVExTU2Vzc2lvbiwgbm90ICVzCiAgICAgICAgICAgICAgICAnJycsCiAgICAgICAgICAgICAgICB0eXBlX25hbWUoc2Vzc2lvbikKICAgICAgICAgICAgKSkKCiAgICAgICAgc2VsZi5fc2Vzc2lvbiA9IHNlc3Npb24KCiAgICAgICAgaWYgc2VsZi5fc29ja2V0OgogICAgICAgICAgICBzZWxmLl9ob3N0bmFtZSA9IGFkZHJlc3MKCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHNlbGYuX2hhbmRzaGFrZSgpCiAgICAgICAgICAgIGV4Y2VwdCAoX1RMU0Rvd25ncmFkZUVycm9yKToKICAgICAgICAgICAgICAgIHNlbGYuY2xvc2UoKQogICAgICAgICAgICAgICAgbmV3X3Nlc3Npb24gPSBUTFNTZXNzaW9uKAogICAgICAgICAgICAgICAgICAgIHNlc3Npb24uX3Byb3RvY29scyAtIHNldChbJ1RMU3YxLjInXSksCiAgICAgICAgICAgICAgICAgICAgc2Vzc2lvbi5fbWFudWFsX3ZhbGlkYXRpb24sCiAgICAgICAgICAgICAgICAgICAgc2Vzc2lvbi5fZXh0cmFfdHJ1c3Rfcm9vdHMKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgIHNlc3Npb24uX19kZWxfXygpCiAgICAgICAgICAgICAgICBzZWxmLl9yZWNlaXZlZF9ieXRlcyA9IGInJwogICAgICAgICAgICAgICAgc2VsZi5fc2Vzc2lvbiA9IG5ld19zZXNzaW9uCiAgICAgICAgICAgICAgICBzZWxmLl9zb2NrZXQgPSBzb2NrZXRfLmNyZWF0ZV9jb25uZWN0aW9uKChhZGRyZXNzLCBwb3J0KSwgdGltZW91dCkKICAgICAgICAgICAgICAgIHNlbGYuX3NvY2tldC5zZXR0aW1lb3V0KHRpbWVvdXQpCiAgICAgICAgICAgICAgICBzZWxmLl9oYW5kc2hha2UoKQogICAgICAgICAgICBleGNlcHQgKF9UTFNSZXRyeUVycm9yKToKICAgICAgICAgICAgICAgIHNlbGYuX3JlY2VpdmVkX2J5dGVzID0gYicnCiAgICAgICAgICAgICAgICBzZWxmLl9zb2NrZXQgPSBzb2NrZXRfLmNyZWF0ZV9jb25uZWN0aW9uKChhZGRyZXNzLCBwb3J0KSwgdGltZW91dCkKICAgICAgICAgICAgICAgIHNlbGYuX3NvY2tldC5zZXR0aW1lb3V0KHRpbWVvdXQpCiAgICAgICAgICAgICAgICBzZWxmLl9oYW5kc2hha2UoKQoKICAgIGRlZiBfY3JlYXRlX2J1ZmZlcnMoc2VsZiwgbnVtYmVyKToKICAgICAgICAiIiIKICAgICAgICBDcmVhdGVzIGEgU2VjQnVmZmVyRGVzYyBzdHJ1Y3QgYW5kIGNvbnRhaW5lZCBTZWNCdWZmZXIgc3RydWN0cwoKICAgICAgICA6cGFyYW0gbnVtYmVyOgogICAgICAgICAgICBUaGUgbnVtYmVyIG9mIGNvbnRhaW5zIFNlY0J1ZmZlciBvYmplY3RzIHRvIGNyZWF0ZQoKICAgICAgICA6cmV0dXJuOgogICAgICAgICAgICBBIHR1cGxlIG9mIChTZWNCdWZmZXJEZXNjIHBvaW50ZXIsIFNlY0J1ZmZlciBhcnJheSkKICAgICAgICAiIiIKCiAgICAgICAgYnVmZmVycyA9IG5ldyhzZWN1cjMyLCAnU2VjQnVmZmVyWyVkXScgJSBudW1iZXIpCgogICAgICAgIGZvciBpbmRleCBpbiByYW5nZSgwLCBudW1iZXIpOgogICAgICAgICAgICBidWZmZXJzW2luZGV4XS5jYkJ1ZmZlciA9IDAKICAgICAgICAgICAgYnVmZmVyc1tpbmRleF0uQnVmZmVyVHlwZSA9IFNlY3VyMzJDb25zdC5TRUNCVUZGRVJfRU1QVFkKICAgICAgICAgICAgYnVmZmVyc1tpbmRleF0ucHZCdWZmZXIgPSBudWxsKCkKCiAgICAgICAgc2VjX2J1ZmZlcl9kZXNjX3BvaW50ZXIgPSBzdHJ1Y3Qoc2VjdXIzMiwgJ1NlY0J1ZmZlckRlc2MnKQogICAgICAgIHNlY19idWZmZXJfZGVzYyA9IHVud3JhcChzZWNfYnVmZmVyX2Rlc2NfcG9pbnRlcikKCiAgICAgICAgc2VjX2J1ZmZlcl9kZXNjLnVsVmVyc2lvbiA9IFNlY3VyMzJDb25zdC5TRUNCVUZGRVJfVkVSU0lPTgogICAgICAgIHNlY19idWZmZXJfZGVzYy5jQnVmZmVycyA9IG51bWJlcgogICAgICAgIHNlY19idWZmZXJfZGVzYy5wQnVmZmVycyA9IGJ1ZmZlcnMKCiAgICAgICAgcmV0dXJuIChzZWNfYnVmZmVyX2Rlc2NfcG9pbnRlciwgYnVmZmVycykKCiAgICBkZWYgX2V4dHJhX3RydXN0X3Jvb3RfdmFsaWRhdGlvbihzZWxmKToKICAgICAgICAiIiIKICAgICAgICBNYW51YWxseSBpbnZva2VkIHdpbmRvd3MgY2VydGlmaWNhdGUgY2hhaW4gYnVpbGRlciBhbmQgdmVyaWZpY2F0aW9uCiAgICAgICAgc3RlcCB3aGVuIHRoZXJlIGFyZSBleHRyYSB0cnVzdCByb290cyB0byBpbmNsdWRlIGluIHRoZSBzZWFyY2ggcHJvY2VzcwogICAgICAgICIiIgoKICAgICAgICBzdG9yZSA9IE5vbmUKICAgICAgICBjZXJ0X2NoYWluX2NvbnRleHRfcG9pbnRlciA9IE5vbmUKCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIFdlIHNldCB1cCBhbiBpbi1tZW1vcnkgc3RvcmUgdG8gcGFzcyBhcyBhbiBleHRyYSBzdG9yZSB0byBncmFiCiAgICAgICAgICAgICMgY2VydGlmaWNhdGVzIGZyb20gd2hlbiBwZXJmb3JtaW5nIHRoZSB2ZXJpZmljYXRpb24KICAgICAgICAgICAgc3RvcmUgPSBjcnlwdDMyLkNlcnRPcGVuU3RvcmUoCiAgICAgICAgICAgICAgICBDcnlwdDMyQ29uc3QuQ0VSVF9TVE9SRV9QUk9WX01FTU9SWSwKICAgICAgICAgICAgICAgIENyeXB0MzJDb25zdC5YNTA5X0FTTl9FTkNPRElORywKICAgICAgICAgICAgICAgIG51bGwoKSwKICAgICAgICAgICAgICAgIDAsCiAgICAgICAgICAgICAgICBudWxsKCkKICAgICAgICAgICAgKQogICAgICAgICAgICBpZiBpc19udWxsKHN0b3JlKToKICAgICAgICAgICAgICAgIGhhbmRsZV9jcnlwdDMyX2Vycm9yKDApCgogICAgICAgICAgICBjZXJ0X2hhc2hlcyA9IHNldCgpCiAgICAgICAgICAgIGZvciBjZXJ0IGluIHNlbGYuX3Nlc3Npb24uX2V4dHJhX3RydXN0X3Jvb3RzOgogICAgICAgICAgICAgICAgY2VydF9kYXRhID0gY2VydC5kdW1wKCkKICAgICAgICAgICAgICAgIHJlc3VsdCA9IGNyeXB0MzIuQ2VydEFkZEVuY29kZWRDZXJ0aWZpY2F0ZVRvU3RvcmUoCiAgICAgICAgICAgICAgICAgICAgc3RvcmUsCiAgICAgICAgICAgICAgICAgICAgQ3J5cHQzMkNvbnN0Llg1MDlfQVNOX0VOQ09ESU5HLAogICAgICAgICAgICAgICAgICAgIGNlcnRfZGF0YSwKICAgICAgICAgICAgICAgICAgICBsZW4oY2VydF9kYXRhKSwKICAgICAgICAgICAgICAgICAgICBDcnlwdDMyQ29uc3QuQ0VSVF9TVE9SRV9BRERfVVNFX0VYSVNUSU5HLAogICAgICAgICAgICAgICAgICAgIG51bGwoKQogICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgaWYgbm90IHJlc3VsdDoKICAgICAgICAgICAgICAgICAgICBoYW5kbGVfY3J5cHQzMl9lcnJvcigwKQogICAgICAgICAgICAgICAgY2VydF9oYXNoZXMuYWRkKGNlcnQuc2hhMjU2KQoKICAgICAgICAgICAgY2VydF9jb250ZXh0X3BvaW50ZXJfcG9pbnRlciA9IG5ldyhjcnlwdDMyLCAnUENFUlRfQ09OVEVYVCAqJykKICAgICAgICAgICAgcmVzdWx0ID0gc2VjdXIzMi5RdWVyeUNvbnRleHRBdHRyaWJ1dGVzVygKICAgICAgICAgICAgICAgIHNlbGYuX2NvbnRleHRfaGFuZGxlX3BvaW50ZXIsCiAgICAgICAgICAgICAgICBTZWN1cjMyQ29uc3QuU0VDUEtHX0FUVFJfUkVNT1RFX0NFUlRfQ09OVEVYVCwKICAgICAgICAgICAgICAgIGNlcnRfY29udGV4dF9wb2ludGVyX3BvaW50ZXIKICAgICAgICAgICAgKQogICAgICAgICAgICBoYW5kbGVfZXJyb3IocmVzdWx0KQoKICAgICAgICAgICAgY2VydF9jb250ZXh0X3BvaW50ZXIgPSB1bndyYXAoY2VydF9jb250ZXh0X3BvaW50ZXJfcG9pbnRlcikKICAgICAgICAgICAgY2VydF9jb250ZXh0X3BvaW50ZXIgPSBjYXN0KGNyeXB0MzIsICdQQ0VSVF9DT05URVhUJywgY2VydF9jb250ZXh0X3BvaW50ZXIpCgogICAgICAgICAgICAjIFdlIGhhdmUgdG8gZG8gYSBmdW5reSBzaHVmZmxlIGhlcmUgYmVjYXVzZSBGSUxFVElNRSBmcm9tIGtlcm5lbDMyCiAgICAgICAgICAgICMgaXMgZGlmZmVyZW50IHRoYW4gRklMRVRJTUUgZnJvbSBjcnlwdDMyIHdoZW4gdXNpbmcgY2ZmaS4gSWYgd2UKICAgICAgICAgICAgIyBvdmVyd3JpdGUgdGhlICJub3dfcG9pbnRlciIgdmFyaWFibGUsIGNmZmkgcmVsZWFzZXMgdGhlIGJhY2tpbmcKICAgICAgICAgICAgIyBtZW1vcnkgYW5kIHdlIGVuZCB1cCBnZXR0aW5nIGEgdmFsaWRhdGlvbiBlcnJvciBhYm91dCBjZXJ0aWZpY2F0ZQogICAgICAgICAgICAjIGV4cGlyYXRpb24gdGltZS4KICAgICAgICAgICAgb3JpZ19ub3dfcG9pbnRlciA9IG5ldyhrZXJuZWwzMiwgJ0ZJTEVUSU1FIConKQogICAgICAgICAgICBrZXJuZWwzMi5HZXRTeXN0ZW1UaW1lQXNGaWxlVGltZShvcmlnX25vd19wb2ludGVyKQogICAgICAgICAgICBub3dfcG9pbnRlciA9IGNhc3QoY3J5cHQzMiwgJ0ZJTEVUSU1FIConLCBvcmlnX25vd19wb2ludGVyKQoKICAgICAgICAgICAgdXNhZ2VfaWRlbnRpZmllcnMgPSBuZXcoY3J5cHQzMiwgJ2NoYXIgKlszXScpCiAgICAgICAgICAgIHVzYWdlX2lkZW50aWZpZXJzWzBdID0gY2FzdChjcnlwdDMyLCAnY2hhciAqJywgQ3J5cHQzMkNvbnN0LlBLSVhfS1BfU0VSVkVSX0FVVEgpCiAgICAgICAgICAgIHVzYWdlX2lkZW50aWZpZXJzWzFdID0gY2FzdChjcnlwdDMyLCAnY2hhciAqJywgQ3J5cHQzMkNvbnN0LlNFUlZFUl9HQVRFRF9DUllQVE8pCiAgICAgICAgICAgIHVzYWdlX2lkZW50aWZpZXJzWzJdID0gY2FzdChjcnlwdDMyLCAnY2hhciAqJywgQ3J5cHQzMkNvbnN0LlNHQ19ORVRTQ0FQRSkKCiAgICAgICAgICAgIGNlcnRfZW5oa2V5X3VzYWdlX3BvaW50ZXIgPSBzdHJ1Y3QoY3J5cHQzMiwgJ0NFUlRfRU5IS0VZX1VTQUdFJykKICAgICAgICAgICAgY2VydF9lbmhrZXlfdXNhZ2UgPSB1bndyYXAoY2VydF9lbmhrZXlfdXNhZ2VfcG9pbnRlcikKICAgICAgICAgICAgY2VydF9lbmhrZXlfdXNhZ2UuY1VzYWdlSWRlbnRpZmllciA9IDMKICAgICAgICAgICAgY2VydF9lbmhrZXlfdXNhZ2Uucmdwc3pVc2FnZUlkZW50aWZpZXIgPSBjYXN0KGNyeXB0MzIsICdjaGFyICoqJywgdXNhZ2VfaWRlbnRpZmllcnMpCgogICAgICAgICAgICBjZXJ0X3VzYWdlX21hdGNoX3BvaW50ZXIgPSBzdHJ1Y3QoY3J5cHQzMiwgJ0NFUlRfVVNBR0VfTUFUQ0gnKQogICAgICAgICAgICBjZXJ0X3VzYWdlX21hdGNoID0gdW53cmFwKGNlcnRfdXNhZ2VfbWF0Y2hfcG9pbnRlcikKICAgICAgICAgICAgY2VydF91c2FnZV9tYXRjaC5kd1R5cGUgPSBDcnlwdDMyQ29uc3QuVVNBR0VfTUFUQ0hfVFlQRV9PUgogICAgICAgICAgICBjZXJ0X3VzYWdlX21hdGNoLlVzYWdlID0gY2VydF9lbmhrZXlfdXNhZ2UKCiAgICAgICAgICAgIGNlcnRfY2hhaW5fcGFyYV9wb2ludGVyID0gc3RydWN0KGNyeXB0MzIsICdDRVJUX0NIQUlOX1BBUkEnKQogICAgICAgICAgICBjZXJ0X2NoYWluX3BhcmEgPSB1bndyYXAoY2VydF9jaGFpbl9wYXJhX3BvaW50ZXIpCiAgICAgICAgICAgIGNlcnRfY2hhaW5fcGFyYS5SZXF1ZXN0ZWRVc2FnZSA9IGNlcnRfdXNhZ2VfbWF0Y2gKICAgICAgICAgICAgY2VydF9jaGFpbl9wYXJhX3NpemUgPSBzaXplb2YoY3J5cHQzMiwgY2VydF9jaGFpbl9wYXJhKQogICAgICAgICAgICBjZXJ0X2NoYWluX3BhcmEuY2JTaXplID0gY2VydF9jaGFpbl9wYXJhX3NpemUKCiAgICAgICAgICAgIGNlcnRfY2hhaW5fY29udGV4dF9wb2ludGVyX3BvaW50ZXIgPSBuZXcoY3J5cHQzMiwgJ1BDRVJUX0NIQUlOX0NPTlRFWFQgKicpCiAgICAgICAgICAgIHJlc3VsdCA9IGNyeXB0MzIuQ2VydEdldENlcnRpZmljYXRlQ2hhaW4oCiAgICAgICAgICAgICAgICBudWxsKCksCiAgICAgICAgICAgICAgICBjZXJ0X2NvbnRleHRfcG9pbnRlciwKICAgICAgICAgICAgICAgIG5vd19wb2ludGVyLAogICAgICAgICAgICAgICAgc3RvcmUsCiAgICAgICAgICAgICAgICBjZXJ0X2NoYWluX3BhcmFfcG9pbnRlciwKICAgICAgICAgICAgICAgIENyeXB0MzJDb25zdC5DRVJUX0NIQUlOX0NBQ0hFX0VORF9DRVJUIHwgQ3J5cHQzMkNvbnN0LkNFUlRfQ0hBSU5fUkVWT0NBVElPTl9DSEVDS19DQUNIRV9PTkxZLAogICAgICAgICAgICAgICAgbnVsbCgpLAogICAgICAgICAgICAgICAgY2VydF9jaGFpbl9jb250ZXh0X3BvaW50ZXJfcG9pbnRlcgogICAgICAgICAgICApCiAgICAgICAgICAgIGhhbmRsZV9jcnlwdDMyX2Vycm9yKHJlc3VsdCkKCiAgICAgICAgICAgIGNlcnRfY2hhaW5fcG9saWN5X3BhcmFfZmxhZ3MgPSBDcnlwdDMyQ29uc3QuQ0VSVF9DSEFJTl9QT0xJQ1lfSUdOT1JFX0FMTF9SRVZfVU5LTk9XTl9GTEFHUwoKICAgICAgICAgICAgY2VydF9jaGFpbl9jb250ZXh0X3BvaW50ZXIgPSB1bndyYXAoY2VydF9jaGFpbl9jb250ZXh0X3BvaW50ZXJfcG9pbnRlcikKCiAgICAgICAgICAgICMgVW53cmFwIHRoZSBjaGFpbiBhbmQgaWYgdGhlIGZpbmFsIGVsZW1lbnQgaW4gdGhlIGNoYWluIGlzIG9uZSBvZgogICAgICAgICAgICAjIGV4dHJhIHRydXN0IHJvb3RzLCBzZXQgZmxhZ3Mgc28gdGhhdCB3ZSB0cnVzdCB0aGUgY2VydGlmaWNhdGUgZXZlbgogICAgICAgICAgICAjIHRob3VnaCBpdCBpcyBub3QgaW4gdGhlIFRydXN0ZWQgUm9vdHMgc3RvcmUKICAgICAgICAgICAgY2VydF9jaGFpbl9jb250ZXh0ID0gdW53cmFwKGNlcnRfY2hhaW5fY29udGV4dF9wb2ludGVyKQogICAgICAgICAgICBudW1fY2hhaW5zID0gbmF0aXZlKGludCwgY2VydF9jaGFpbl9jb250ZXh0LmNDaGFpbikKICAgICAgICAgICAgaWYgbnVtX2NoYWlucyA9PSAxOgogICAgICAgICAgICAgICAgZmlyc3Rfc2ltcGxlX2NoYWluX3BvaW50ZXIgPSB1bndyYXAoY2VydF9jaGFpbl9jb250ZXh0LnJncENoYWluKQogICAgICAgICAgICAgICAgZmlyc3Rfc2ltcGxlX2NoYWluID0gdW53cmFwKGZpcnN0X3NpbXBsZV9jaGFpbl9wb2ludGVyKQogICAgICAgICAgICAgICAgbnVtX2VsZW1lbnRzID0gbmF0aXZlKGludCwgZmlyc3Rfc2ltcGxlX2NoYWluLmNFbGVtZW50KQogICAgICAgICAgICAgICAgbGFzdF9lbGVtZW50X3BvaW50ZXIgPSBmaXJzdF9zaW1wbGVfY2hhaW4ucmdwRWxlbWVudFtudW1fZWxlbWVudHMgLSAxXQogICAgICAgICAgICAgICAgbGFzdF9lbGVtZW50ID0gdW53cmFwKGxhc3RfZWxlbWVudF9wb2ludGVyKQogICAgICAgICAgICAgICAgbGFzdF9lbGVtZW50X2NlcnQgPSB1bndyYXAobGFzdF9lbGVtZW50LnBDZXJ0Q29udGV4dCkKICAgICAgICAgICAgICAgIGxhc3RfZWxlbWVudF9jZXJ0X2RhdGEgPSBieXRlc19mcm9tX2J1ZmZlcigKICAgICAgICAgICAgICAgICAgICBsYXN0X2VsZW1lbnRfY2VydC5wYkNlcnRFbmNvZGVkLAogICAgICAgICAgICAgICAgICAgIG5hdGl2ZShpbnQsIGxhc3RfZWxlbWVudF9jZXJ0LmNiQ2VydEVuY29kZWQpCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICBsYXN0X2NlcnQgPSBBc24xQ2VydGlmaWNhdGUubG9hZChsYXN0X2VsZW1lbnRfY2VydF9kYXRhKQogICAgICAgICAgICAgICAgaWYgbGFzdF9jZXJ0LnNoYTI1NiBpbiBjZXJ0X2hhc2hlczoKICAgICAgICAgICAgICAgICAgICBjZXJ0X2NoYWluX3BvbGljeV9wYXJhX2ZsYWdzIHw9IENyeXB0MzJDb25zdC5DRVJUX0NIQUlOX1BPTElDWV9BTExPV19VTktOT1dOX0NBX0ZMQUcKCiAgICAgICAgICAgIHNzbF9leHRyYV9jZXJ0X2NoYWluX3BvbGljeV9wYXJhX3BvaW50ZXIgPSBzdHJ1Y3QoY3J5cHQzMiwgJ1NTTF9FWFRSQV9DRVJUX0NIQUlOX1BPTElDWV9QQVJBJykKICAgICAgICAgICAgc3NsX2V4dHJhX2NlcnRfY2hhaW5fcG9saWN5X3BhcmEgPSB1bndyYXAoc3NsX2V4dHJhX2NlcnRfY2hhaW5fcG9saWN5X3BhcmFfcG9pbnRlcikKICAgICAgICAgICAgc3NsX2V4dHJhX2NlcnRfY2hhaW5fcG9saWN5X3BhcmEuY2JTaXplID0gc2l6ZW9mKGNyeXB0MzIsIHNzbF9leHRyYV9jZXJ0X2NoYWluX3BvbGljeV9wYXJhKQogICAgICAgICAgICBzc2xfZXh0cmFfY2VydF9jaGFpbl9wb2xpY3lfcGFyYS5kd0F1dGhUeXBlID0gQ3J5cHQzMkNvbnN0LkFVVEhUWVBFX1NFUlZFUgogICAgICAgICAgICBzc2xfZXh0cmFfY2VydF9jaGFpbl9wb2xpY3lfcGFyYS5mZHdDaGVja3MgPSAwCiAgICAgICAgICAgIHNzbF9leHRyYV9jZXJ0X2NoYWluX3BvbGljeV9wYXJhLnB3c3pTZXJ2ZXJOYW1lID0gY2FzdCgKICAgICAgICAgICAgICAgIGNyeXB0MzIsCiAgICAgICAgICAgICAgICAnd2NoYXJfdCAqJywKICAgICAgICAgICAgICAgIGJ1ZmZlcl9mcm9tX3VuaWNvZGUoc2VsZi5faG9zdG5hbWUpCiAgICAgICAgICAgICkKCiAgICAgICAgICAgIGNlcnRfY2hhaW5fcG9saWN5X3BhcmFfcG9pbnRlciA9IHN0cnVjdChjcnlwdDMyLCAnQ0VSVF9DSEFJTl9QT0xJQ1lfUEFSQScpCiAgICAgICAgICAgIGNlcnRfY2hhaW5fcG9saWN5X3BhcmEgPSB1bndyYXAoY2VydF9jaGFpbl9wb2xpY3lfcGFyYV9wb2ludGVyKQogICAgICAgICAgICBjZXJ0X2NoYWluX3BvbGljeV9wYXJhLmNiU2l6ZSA9IHNpemVvZihjcnlwdDMyLCBjZXJ0X2NoYWluX3BvbGljeV9wYXJhKQogICAgICAgICAgICBjZXJ0X2NoYWluX3BvbGljeV9wYXJhLmR3RmxhZ3MgPSBjZXJ0X2NoYWluX3BvbGljeV9wYXJhX2ZsYWdzCiAgICAgICAgICAgIGNlcnRfY2hhaW5fcG9saWN5X3BhcmEucHZFeHRyYVBvbGljeVBhcmEgPSBjYXN0KGNyeXB0MzIsICd2b2lkIConLCBzc2xfZXh0cmFfY2VydF9jaGFpbl9wb2xpY3lfcGFyYV9wb2ludGVyKQoKICAgICAgICAgICAgY2VydF9jaGFpbl9wb2xpY3lfc3RhdHVzX3BvaW50ZXIgPSBzdHJ1Y3QoY3J5cHQzMiwgJ0NFUlRfQ0hBSU5fUE9MSUNZX1NUQVRVUycpCiAgICAgICAgICAgIGNlcnRfY2hhaW5fcG9saWN5X3N0YXR1cyA9IHVud3JhcChjZXJ0X2NoYWluX3BvbGljeV9zdGF0dXNfcG9pbnRlcikKICAgICAgICAgICAgY2VydF9jaGFpbl9wb2xpY3lfc3RhdHVzLmNiU2l6ZSA9IHNpemVvZihjcnlwdDMyLCBjZXJ0X2NoYWluX3BvbGljeV9zdGF0dXMpCgogICAgICAgICAgICByZXN1bHQgPSBjcnlwdDMyLkNlcnRWZXJpZnlDZXJ0aWZpY2F0ZUNoYWluUG9saWN5KAogICAgICAgICAgICAgICAgQ3J5cHQzMkNvbnN0LkNFUlRfQ0hBSU5fUE9MSUNZX1NTTCwKICAgICAgICAgICAgICAgIGNlcnRfY2hhaW5fY29udGV4dF9wb2ludGVyLAogICAgICAgICAgICAgICAgY2VydF9jaGFpbl9wb2xpY3lfcGFyYV9wb2ludGVyLAogICAgICAgICAgICAgICAgY2VydF9jaGFpbl9wb2xpY3lfc3RhdHVzX3BvaW50ZXIKICAgICAgICAgICAgKQogICAgICAgICAgICBoYW5kbGVfY3J5cHQzMl9lcnJvcihyZXN1bHQpCgogICAgICAgICAgICBjZXJ0X2NvbnRleHQgPSB1bndyYXAoY2VydF9jb250ZXh0X3BvaW50ZXIpCiAgICAgICAgICAgIGNlcnRfZGF0YSA9IGJ5dGVzX2Zyb21fYnVmZmVyKGNlcnRfY29udGV4dC5wYkNlcnRFbmNvZGVkLCBuYXRpdmUoaW50LCBjZXJ0X2NvbnRleHQuY2JDZXJ0RW5jb2RlZCkpCiAgICAgICAgICAgIGNlcnQgPSBBc24xQ2VydGlmaWNhdGUubG9hZChjZXJ0X2RhdGEpCgogICAgICAgICAgICBlcnJvciA9IGNlcnRfY2hhaW5fcG9saWN5X3N0YXR1cy5kd0Vycm9yCiAgICAgICAgICAgIGlmIGVycm9yOgogICAgICAgICAgICAgICAgaWYgZXJyb3IgPT0gQ3J5cHQzMkNvbnN0LkNFUlRfRV9FWFBJUkVEOgogICAgICAgICAgICAgICAgICAgIHJhaXNlX2V4cGlyZWRfbm90X3lldF92YWxpZChjZXJ0KQogICAgICAgICAgICAgICAgaWYgZXJyb3IgPT0gQ3J5cHQzMkNvbnN0LkNFUlRfRV9VTlRSVVNURURST09UOgogICAgICAgICAgICAgICAgICAgIG9zY3J5cHRvX2NlcnQgPSBsb2FkX2NlcnRpZmljYXRlKGNlcnQpCiAgICAgICAgICAgICAgICAgICAgaWYgb3NjcnlwdG9fY2VydC5zZWxmX3NpZ25lZDoKICAgICAgICAgICAgICAgICAgICAgICAgcmFpc2Vfc2VsZl9zaWduZWQoY2VydCkKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICByYWlzZV9ub19pc3N1ZXIoY2VydCkKICAgICAgICAgICAgICAgIGlmIGVycm9yID09IENyeXB0MzJDb25zdC5DRVJUX0VfQ05fTk9fTUFUQ0g6CiAgICAgICAgICAgICAgICAgICAgcmFpc2VfaG9zdG5hbWUoY2VydCwgc2VsZi5faG9zdG5hbWUpCgogICAgICAgICAgICAgICAgaWYgZXJyb3IgPT0gQ3J5cHQzMkNvbnN0LlRSVVNUX0VfQ0VSVF9TSUdOQVRVUkU6CiAgICAgICAgICAgICAgICAgICAgcmFpc2Vfd2Vha19zaWduYXR1cmUoY2VydCkKCiAgICAgICAgICAgICAgICBpZiBlcnJvciA9PSBDcnlwdDMyQ29uc3QuQ1JZUFRfRV9SRVZPS0VEOgogICAgICAgICAgICAgICAgICAgIHJhaXNlX3Jldm9rZWQoY2VydCkKCiAgICAgICAgICAgICAgICByYWlzZV92ZXJpZmljYXRpb24oY2VydCkKCiAgICAgICAgICAgIGlmIGNlcnQuaGFzaF9hbGdvIGluIHNldChbJ21kNScsICdtZDInXSk6CiAgICAgICAgICAgICAgICByYWlzZV93ZWFrX3NpZ25hdHVyZShjZXJ0KQoKICAgICAgICBmaW5hbGx5OgogICAgICAgICAgICBpZiBzdG9yZToKICAgICAgICAgICAgICAgIGNyeXB0MzIuQ2VydENsb3NlU3RvcmUoc3RvcmUsIDApCiAgICAgICAgICAgIGlmIGNlcnRfY2hhaW5fY29udGV4dF9wb2ludGVyOgogICAgICAgICAgICAgICAgY3J5cHQzMi5DZXJ0RnJlZUNlcnRpZmljYXRlQ2hhaW4oY2VydF9jaGFpbl9jb250ZXh0X3BvaW50ZXIpCgogICAgZGVmIF9oYW5kc2hha2Uoc2VsZiwgcmVuZWdvdGlhdGU9RmFsc2UpOgogICAgICAgICIiIgogICAgICAgIFBlcmZvcm0gYW4gaW5pdGlhbCBUTFMgaGFuZHNoYWtlLCBvciBhIHJlbmVnb3RpYXRpb24KCiAgICAgICAgOnBhcmFtIHJlbmVnb3RpYXRlOgogICAgICAgICAgICBJZiB0aGUgaGFuZHNoYWtlIGlzIGZvciBhIHJlbmVnb3RpYXRpb24KICAgICAgICAiIiIKCiAgICAgICAgaW5fYnVmZmVycyA9IE5vbmUKICAgICAgICBvdXRfYnVmZmVycyA9IE5vbmUKICAgICAgICBuZXdfY29udGV4dF9oYW5kbGVfcG9pbnRlciA9IE5vbmUKCiAgICAgICAgdHJ5OgogICAgICAgICAgICBpZiByZW5lZ290aWF0ZToKICAgICAgICAgICAgICAgIHRlbXBfY29udGV4dF9oYW5kbGVfcG9pbnRlciA9IHNlbGYuX2NvbnRleHRfaGFuZGxlX3BvaW50ZXIKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIG5ld19jb250ZXh0X2hhbmRsZV9wb2ludGVyID0gbmV3KHNlY3VyMzIsICdDdHh0SGFuZGxlIConKQogICAgICAgICAgICAgICAgdGVtcF9jb250ZXh0X2hhbmRsZV9wb2ludGVyID0gbmV3X2NvbnRleHRfaGFuZGxlX3BvaW50ZXIKCiAgICAgICAgICAgIHJlcXVlc3RlZF9mbGFncyA9IHsKICAgICAgICAgICAgICAgIFNlY3VyMzJDb25zdC5JU0NfUkVRX1JFUExBWV9ERVRFQ1Q6ICdyZXBsYXkgZGV0ZWN0aW9uJywKICAgICAgICAgICAgICAgIFNlY3VyMzJDb25zdC5JU0NfUkVRX1NFUVVFTkNFX0RFVEVDVDogJ3NlcXVlbmNlIGRldGVjdGlvbicsCiAgICAgICAgICAgICAgICBTZWN1cjMyQ29uc3QuSVNDX1JFUV9DT05GSURFTlRJQUxJVFk6ICdjb25maWRlbnRpYWxpdHknLAogICAgICAgICAgICAgICAgU2VjdXIzMkNvbnN0LklTQ19SRVFfQUxMT0NBVEVfTUVNT1JZOiAnbWVtb3J5IGFsbG9jYXRpb24nLAogICAgICAgICAgICAgICAgU2VjdXIzMkNvbnN0LklTQ19SRVFfSU5URUdSSVRZOiAnaW50ZWdyaXR5JywKICAgICAgICAgICAgICAgIFNlY3VyMzJDb25zdC5JU0NfUkVRX1NUUkVBTTogJ3N0cmVhbSBvcmllbnRhdGlvbicsCiAgICAgICAgICAgICAgICBTZWN1cjMyQ29uc3QuSVNDX1JFUV9VU0VfU1VQUExJRURfQ1JFRFM6ICdkaXNhYmxlIGF1dG9tYXRpYyBjbGllbnQgYXV0aCcsCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHNlbGYuX2NvbnRleHRfZmxhZ3MgPSAwCiAgICAgICAgICAgIGZvciBmbGFnIGluIHJlcXVlc3RlZF9mbGFnczoKICAgICAgICAgICAgICAgIHNlbGYuX2NvbnRleHRfZmxhZ3MgfD0gZmxhZwoKICAgICAgICAgICAgaW5fc2VjX2J1ZmZlcl9kZXNjX3BvaW50ZXIsIGluX2J1ZmZlcnMgPSBzZWxmLl9jcmVhdGVfYnVmZmVycygyKQogICAgICAgICAgICBpbl9idWZmZXJzWzBdLkJ1ZmZlclR5cGUgPSBTZWN1cjMyQ29uc3QuU0VDQlVGRkVSX1RPS0VOCgogICAgICAgICAgICBvdXRfc2VjX2J1ZmZlcl9kZXNjX3BvaW50ZXIsIG91dF9idWZmZXJzID0gc2VsZi5fY3JlYXRlX2J1ZmZlcnMoMikKICAgICAgICAgICAgb3V0X2J1ZmZlcnNbMF0uQnVmZmVyVHlwZSA9IFNlY3VyMzJDb25zdC5TRUNCVUZGRVJfVE9LRU4KICAgICAgICAgICAgb3V0X2J1ZmZlcnNbMV0uQnVmZmVyVHlwZSA9IFNlY3VyMzJDb25zdC5TRUNCVUZGRVJfQUxFUlQKCiAgICAgICAgICAgIG91dHB1dF9jb250ZXh0X2ZsYWdzX3BvaW50ZXIgPSBuZXcoc2VjdXIzMiwgJ1VMT05HIConKQoKICAgICAgICAgICAgaWYgcmVuZWdvdGlhdGU6CiAgICAgICAgICAgICAgICBmaXJzdF9oYW5kbGUgPSB0ZW1wX2NvbnRleHRfaGFuZGxlX3BvaW50ZXIKICAgICAgICAgICAgICAgIHNlY29uZF9oYW5kbGUgPSBudWxsKCkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGZpcnN0X2hhbmRsZSA9IG51bGwoKQogICAgICAgICAgICAgICAgc2Vjb25kX2hhbmRsZSA9IHRlbXBfY29udGV4dF9oYW5kbGVfcG9pbnRlcgoKICAgICAgICAgICAgcmVzdWx0ID0gc2VjdXIzMi5Jbml0aWFsaXplU2VjdXJpdHlDb250ZXh0VygKICAgICAgICAgICAgICAgIHNlbGYuX3Nlc3Npb24uX2NyZWRlbnRpYWxzX2hhbmRsZSwKICAgICAgICAgICAgICAgIGZpcnN0X2hhbmRsZSwKICAgICAgICAgICAgICAgIHNlbGYuX2hvc3RuYW1lLAogICAgICAgICAgICAgICAgc2VsZi5fY29udGV4dF9mbGFncywKICAgICAgICAgICAgICAgIDAsCiAgICAgICAgICAgICAgICAwLAogICAgICAgICAgICAgICAgbnVsbCgpLAogICAgICAgICAgICAgICAgMCwKICAgICAgICAgICAgICAgIHNlY29uZF9oYW5kbGUsCiAgICAgICAgICAgICAgICBvdXRfc2VjX2J1ZmZlcl9kZXNjX3BvaW50ZXIsCiAgICAgICAgICAgICAgICBvdXRwdXRfY29udGV4dF9mbGFnc19wb2ludGVyLAogICAgICAgICAgICAgICAgbnVsbCgpCiAgICAgICAgICAgICkKICAgICAgICAgICAgaWYgcmVzdWx0IG5vdCBpbiBzZXQoW1NlY3VyMzJDb25zdC5TRUNfRV9PSywgU2VjdXIzMkNvbnN0LlNFQ19JX0NPTlRJTlVFX05FRURFRF0pOgogICAgICAgICAgICAgICAgaGFuZGxlX2Vycm9yKHJlc3VsdCwgVExTRXJyb3IpCgogICAgICAgICAgICBpZiBub3QgcmVuZWdvdGlhdGU6CiAgICAgICAgICAgICAgICB0ZW1wX2NvbnRleHRfaGFuZGxlX3BvaW50ZXIgPSBzZWNvbmRfaGFuZGxlCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICB0ZW1wX2NvbnRleHRfaGFuZGxlX3BvaW50ZXIgPSBmaXJzdF9oYW5kbGUKCiAgICAgICAgICAgIGhhbmRzaGFrZV9zZXJ2ZXJfYnl0ZXMgPSBiJycKICAgICAgICAgICAgaGFuZHNoYWtlX2NsaWVudF9ieXRlcyA9IGInJwoKICAgICAgICAgICAgaWYgb3V0X2J1ZmZlcnNbMF0uY2JCdWZmZXIgPiAwOgogICAgICAgICAgICAgICAgdG9rZW4gPSBieXRlc19mcm9tX2J1ZmZlcihvdXRfYnVmZmVyc1swXS5wdkJ1ZmZlciwgb3V0X2J1ZmZlcnNbMF0uY2JCdWZmZXIpCiAgICAgICAgICAgICAgICBoYW5kc2hha2VfY2xpZW50X2J5dGVzICs9IHRva2VuCiAgICAgICAgICAgICAgICBzZWxmLl9zb2NrZXQuc2VuZCh0b2tlbikKICAgICAgICAgICAgICAgIG91dF9idWZmZXJzWzBdLmNiQnVmZmVyID0gMAogICAgICAgICAgICAgICAgc2VjdXIzMi5GcmVlQ29udGV4dEJ1ZmZlcihvdXRfYnVmZmVyc1swXS5wdkJ1ZmZlcikKICAgICAgICAgICAgICAgIG91dF9idWZmZXJzWzBdLnB2QnVmZmVyID0gbnVsbCgpCgogICAgICAgICAgICBpbl9kYXRhX2J1ZmZlciA9IGJ1ZmZlcl9mcm9tX2J5dGVzKDMyNzY4KQogICAgICAgICAgICBpbl9idWZmZXJzWzBdLnB2QnVmZmVyID0gY2FzdChzZWN1cjMyLCAnQllURSAqJywgaW5fZGF0YV9idWZmZXIpCgogICAgICAgICAgICBieXRlc19yZWFkID0gYicnCiAgICAgICAgICAgIHdoaWxlIHJlc3VsdCAhPSBTZWN1cjMyQ29uc3QuU0VDX0VfT0s6CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgZmFpbF9sYXRlID0gRmFsc2UKICAgICAgICAgICAgICAgICAgICBieXRlc19yZWFkID0gc2VsZi5fc29ja2V0LnJlY3YoODE5MikKICAgICAgICAgICAgICAgICAgICBpZiBieXRlc19yZWFkID09IGInJzoKICAgICAgICAgICAgICAgICAgICAgICAgcmFpc2VfZGlzY29ubmVjdGlvbigpCiAgICAgICAgICAgICAgICBleGNlcHQgKHNvY2tldF9lcnJvcl9jbHMpOgogICAgICAgICAgICAgICAgICAgIGZhaWxfbGF0ZSA9IFRydWUKICAgICAgICAgICAgICAgIGhhbmRzaGFrZV9zZXJ2ZXJfYnl0ZXMgKz0gYnl0ZXNfcmVhZAogICAgICAgICAgICAgICAgc2VsZi5fcmVjZWl2ZWRfYnl0ZXMgKz0gYnl0ZXNfcmVhZAoKICAgICAgICAgICAgICAgIGluX2J1ZmZlcnNbMF0uY2JCdWZmZXIgPSBsZW4oc2VsZi5fcmVjZWl2ZWRfYnl0ZXMpCiAgICAgICAgICAgICAgICB3cml0ZV90b19idWZmZXIoaW5fZGF0YV9idWZmZXIsIHNlbGYuX3JlY2VpdmVkX2J5dGVzKQoKICAgICAgICAgICAgICAgIHJlc3VsdCA9IHNlY3VyMzIuSW5pdGlhbGl6ZVNlY3VyaXR5Q29udGV4dFcoCiAgICAgICAgICAgICAgICAgICAgc2VsZi5fc2Vzc2lvbi5fY3JlZGVudGlhbHNfaGFuZGxlLAogICAgICAgICAgICAgICAgICAgIHRlbXBfY29udGV4dF9oYW5kbGVfcG9pbnRlciwKICAgICAgICAgICAgICAgICAgICBzZWxmLl9ob3N0bmFtZSwKICAgICAgICAgICAgICAgICAgICBzZWxmLl9jb250ZXh0X2ZsYWdzLAogICAgICAgICAgICAgICAgICAgIDAsCiAgICAgICAgICAgICAgICAgICAgMCwKICAgICAgICAgICAgICAgICAgICBpbl9zZWNfYnVmZmVyX2Rlc2NfcG9pbnRlciwKICAgICAgICAgICAgICAgICAgICAwLAogICAgICAgICAgICAgICAgICAgIG51bGwoKSwKICAgICAgICAgICAgICAgICAgICBvdXRfc2VjX2J1ZmZlcl9kZXNjX3BvaW50ZXIsCiAgICAgICAgICAgICAgICAgICAgb3V0cHV0X2NvbnRleHRfZmxhZ3NfcG9pbnRlciwKICAgICAgICAgICAgICAgICAgICBudWxsKCkKICAgICAgICAgICAgICAgICkKCiAgICAgICAgICAgICAgICBpZiByZXN1bHQgPT0gU2VjdXIzMkNvbnN0LlNFQ19FX0lOQ09NUExFVEVfTUVTU0FHRToKICAgICAgICAgICAgICAgICAgICBpbl9idWZmZXJzWzBdLkJ1ZmZlclR5cGUgPSBTZWN1cjMyQ29uc3QuU0VDQlVGRkVSX1RPS0VOCiAgICAgICAgICAgICAgICAgICAgIyBXaW5kb3dzIDEwIHNlZW1zIHRvIGZpbGwgdGhlIHNlY29uZCBpbnB1dCBidWZmZXIgd2l0aAogICAgICAgICAgICAgICAgICAgICMgYSBCdWZmZXJUeXBlIG9mIFNFQ0JVRkZFUl9NSVNTSU5HICg0KSwgd2hpY2ggaWYgbm90CiAgICAgICAgICAgICAgICAgICAgIyBjbGVhcmVkIGNhdXNlcyB0aGUgaGFuZHNoYWtlIHRvIGZhaWwuCiAgICAgICAgICAgICAgICAgICAgaWYgaW5fYnVmZmVyc1sxXS5CdWZmZXJUeXBlICE9IFNlY3VyMzJDb25zdC5TRUNCVUZGRVJfRU1QVFk6CiAgICAgICAgICAgICAgICAgICAgICAgIGluX2J1ZmZlcnNbMV0uQnVmZmVyVHlwZSA9IFNlY3VyMzJDb25zdC5TRUNCVUZGRVJfRU1QVFkKICAgICAgICAgICAgICAgICAgICAgICAgaW5fYnVmZmVyc1sxXS5jYkJ1ZmZlciA9IDAKICAgICAgICAgICAgICAgICAgICAgICAgaWYgbm90IGlzX251bGwoaW5fYnVmZmVyc1sxXS5wdkJ1ZmZlcik6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWN1cjMyLkZyZWVDb250ZXh0QnVmZmVyKGluX2J1ZmZlcnNbMV0ucHZCdWZmZXIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbl9idWZmZXJzWzFdLnB2QnVmZmVyID0gbnVsbCgpCgogICAgICAgICAgICAgICAgICAgIGlmIGZhaWxfbGF0ZToKICAgICAgICAgICAgICAgICAgICAgICAgcmFpc2VfZGlzY29ubmVjdGlvbigpCgogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgICAgICAgICAgaWYgcmVzdWx0ID09IFNlY3VyMzJDb25zdC5TRUNfRV9JTExFR0FMX01FU1NBR0U6CiAgICAgICAgICAgICAgICAgICAgaWYgZGV0ZWN0X2NsaWVudF9hdXRoX3JlcXVlc3QoaGFuZHNoYWtlX3NlcnZlcl9ieXRlcyk6CiAgICAgICAgICAgICAgICAgICAgICAgIHJhaXNlX2NsaWVudF9hdXRoKCkKICAgICAgICAgICAgICAgICAgICBhbGVydF9pbmZvID0gcGFyc2VfYWxlcnQoaGFuZHNoYWtlX3NlcnZlcl9ieXRlcykKICAgICAgICAgICAgICAgICAgICBpZiBhbGVydF9pbmZvIGFuZCBhbGVydF9pbmZvID09ICgyLCA3MCk6CiAgICAgICAgICAgICAgICAgICAgICAgIHJhaXNlX3Byb3RvY29sX3ZlcnNpb24oKQogICAgICAgICAgICAgICAgICAgIHJhaXNlX2hhbmRzaGFrZSgpCgogICAgICAgICAgICAgICAgaWYgcmVzdWx0ID09IFNlY3VyMzJDb25zdC5TRUNfRV9XUk9OR19QUklOQ0lQQUw6CiAgICAgICAgICAgICAgICAgICAgY2hhaW4gPSBleHRyYWN0X2NoYWluKGhhbmRzaGFrZV9zZXJ2ZXJfYnl0ZXMpCiAgICAgICAgICAgICAgICAgICAgcmFpc2VfaG9zdG5hbWUoY2hhaW5bMF0sIHNlbGYuX2hvc3RuYW1lKQoKICAgICAgICAgICAgICAgIGlmIHJlc3VsdCA9PSBTZWN1cjMyQ29uc3QuU0VDX0VfQ0VSVF9FWFBJUkVEOgogICAgICAgICAgICAgICAgICAgIGNoYWluID0gZXh0cmFjdF9jaGFpbihoYW5kc2hha2Vfc2VydmVyX2J5dGVzKQogICAgICAgICAgICAgICAgICAgIHJhaXNlX2V4cGlyZWRfbm90X3lldF92YWxpZChjaGFpblswXSkKCiAgICAgICAgICAgICAgICBpZiByZXN1bHQgPT0gU2VjdXIzMkNvbnN0LlNFQ19FX1VOVFJVU1RFRF9ST09UOgogICAgICAgICAgICAgICAgICAgIGNoYWluID0gZXh0cmFjdF9jaGFpbihoYW5kc2hha2Vfc2VydmVyX2J5dGVzKQogICAgICAgICAgICAgICAgICAgIGNlcnQgPSBjaGFpblswXQogICAgICAgICAgICAgICAgICAgIG9zY3J5cHRvX2NlcnQgPSBsb2FkX2NlcnRpZmljYXRlKGNlcnQpCiAgICAgICAgICAgICAgICAgICAgaWYgbm90IG9zY3J5cHRvX2NlcnQuc2VsZl9zaWduZWQ6CiAgICAgICAgICAgICAgICAgICAgICAgIHJhaXNlX25vX2lzc3VlcihjZXJ0KQogICAgICAgICAgICAgICAgICAgIHJhaXNlX3NlbGZfc2lnbmVkKGNlcnQpCgogICAgICAgICAgICAgICAgaWYgcmVzdWx0ID09IFNlY3VyMzJDb25zdC5TRUNfRV9JTlRFUk5BTF9FUlJPUjoKICAgICAgICAgICAgICAgICAgICBpZiBnZXRfZGhfcGFyYW1zX2xlbmd0aChoYW5kc2hha2Vfc2VydmVyX2J5dGVzKSA8IDEwMjQ6CiAgICAgICAgICAgICAgICAgICAgICAgIHJhaXNlX2RoX3BhcmFtcygpCgogICAgICAgICAgICAgICAgaWYgcmVzdWx0ID09IFNlY3VyMzJDb25zdC5TRUNfSV9JTkNPTVBMRVRFX0NSRURFTlRJQUxTOgogICAgICAgICAgICAgICAgICAgIHJhaXNlX2NsaWVudF9hdXRoKCkKCiAgICAgICAgICAgICAgICBpZiByZXN1bHQgPT0gQ3J5cHQzMkNvbnN0LlRSVVNUX0VfQ0VSVF9TSUdOQVRVUkU6CiAgICAgICAgICAgICAgICAgICAgcmFpc2Vfd2Vha19zaWduYXR1cmUoY2VydCkKCiAgICAgICAgICAgICAgICBpZiByZXN1bHQgPT0gU2VjdXIzMkNvbnN0LlNFQ19FX0lOVkFMSURfVE9LRU46CiAgICAgICAgICAgICAgICAgICAgIyBJZiBhbiBhbGVydCBpdCBwcmVzZW50LCB0aGVyZSBtYXkgaGF2ZSBiZWVuIGEgaGFuZHNoYWtlCiAgICAgICAgICAgICAgICAgICAgIyBlcnJvciBkdWUgdG8gdGhlIHNlcnZlciB1c2luZyBhIGNlcnRpZmljYXRlIHBhdGggd2l0aCBhCiAgICAgICAgICAgICAgICAgICAgIyB0cnVzdCByb290IHVzaW5nIE1EMiBvciBNRDUgY29tYmluZWQgd2l0aCBUTFMgMS4yLiBUbwogICAgICAgICAgICAgICAgICAgICMgd29yayBhcm91bmQgdGhpcywgaWYgdGhlIHVzZXIgYWxsb3dzIGFueXRoaW5nIG90aGVyIHRoYW4KICAgICAgICAgICAgICAgICAgICAjIFRMUyAxLjIsIHdlIGp1c3QgcmVtb3ZlIGl0IGZyb20gdGhlIGFjY2VwdGFibGUgcHJvdG9jb2xzCiAgICAgICAgICAgICAgICAgICAgIyBhbmQgdHJ5IGFnYWluLgogICAgICAgICAgICAgICAgICAgIGlmIG91dF9idWZmZXJzWzFdLmNiQnVmZmVyID4gMDoKICAgICAgICAgICAgICAgICAgICAgICAgYWxlcnRfYnl0ZXMgPSBieXRlc19mcm9tX2J1ZmZlcihvdXRfYnVmZmVyc1sxXS5wdkJ1ZmZlciwgb3V0X2J1ZmZlcnNbMV0uY2JCdWZmZXIpCiAgICAgICAgICAgICAgICAgICAgICAgIGhhbmRzaGFrZV9jbGllbnRfYnl0ZXMgKz0gYWxlcnRfYnl0ZXMKICAgICAgICAgICAgICAgICAgICAgICAgYWxlcnRfbnVtYmVyID0gYWxlcnRfYnl0ZXNbNjo3XQogICAgICAgICAgICAgICAgICAgICAgICBpZiBhbGVydF9udW1iZXIgPT0gYidceDI4JyBvciBhbGVydF9udW1iZXIgPT0gYidceDJiJzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICdUTFN2MS4yJyBpbiBzZWxmLl9zZXNzaW9uLl9wcm90b2NvbHMgYW5kIGxlbihzZWxmLl9zZXNzaW9uLl9wcm90b2NvbHMpID4gMToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGFpbiA9IGV4dHJhY3RfY2hhaW4oaGFuZHNoYWtlX3NlcnZlcl9ieXRlcykKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByYWlzZSBfVExTRG93bmdyYWRlRXJyb3IoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdTZXJ2ZXIgY2VydGlmaWNhdGUgdmVyaWZpY2F0aW9uIGZhaWxlZCAtIHdlYWsgY2VydGlmaWNhdGUgc2lnbmF0dXJlIGFsZ29yaXRobScsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoYWluWzBdCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICAgIGlmIGRldGVjdF9jbGllbnRfYXV0aF9yZXF1ZXN0KGhhbmRzaGFrZV9zZXJ2ZXJfYnl0ZXMpOgogICAgICAgICAgICAgICAgICAgICAgICByYWlzZV9jbGllbnRfYXV0aCgpCiAgICAgICAgICAgICAgICAgICAgaWYgZGV0ZWN0X290aGVyX3Byb3RvY29sKGhhbmRzaGFrZV9zZXJ2ZXJfYnl0ZXMpOgogICAgICAgICAgICAgICAgICAgICAgICByYWlzZV9wcm90b2NvbF9lcnJvcihoYW5kc2hha2Vfc2VydmVyX2J5dGVzKQogICAgICAgICAgICAgICAgICAgIHJhaXNlX2hhbmRzaGFrZSgpCgogICAgICAgICAgICAgICAgIyBUaGVzZSBhcmUgc2VtaS1jb21tb24gZXJyb3JzIHdpdGggVExTdjEuMiBvbiBXaW5kb3dzIDcgYW4gOAogICAgICAgICAgICAgICAgIyB0aGF0IGFwcGVhcnMgdG8gYmUgZHVlIHRvIHBvb3IgaGFuZGxpbmcgb2YgdGhlCiAgICAgICAgICAgICAgICAjIFNlcnZlcktleUV4Y2hhbmdlIGZvciBESEVfUlNBIGNpcGhlciBzdWl0ZXMuIFRoZSBzb2x1dGlvbgogICAgICAgICAgICAgICAgIyBpcyB0byByZXRyeSB0aGUgaGFuZHNoYWtlLgogICAgICAgICAgICAgICAgaWYgcmVzdWx0ID09IFNlY3VyMzJDb25zdC5TRUNfRV9CVUZGRVJfVE9PX1NNQUxMIG9yIHJlc3VsdCA9PSBTZWN1cjMyQ29uc3QuU0VDX0VfTUVTU0FHRV9BTFRFUkVEOgogICAgICAgICAgICAgICAgICAgIGlmICdUTFN2MS4yJyBpbiBzZWxmLl9zZXNzaW9uLl9wcm90b2NvbHM6CiAgICAgICAgICAgICAgICAgICAgICAgIHJhaXNlIF9UTFNSZXRyeUVycm9yKCdUTFMgaGFuZHNoYWtlIGZhaWxlZCcpCgogICAgICAgICAgICAgICAgaWYgZmFpbF9sYXRlOgogICAgICAgICAgICAgICAgICAgIHJhaXNlX2Rpc2Nvbm5lY3Rpb24oKQoKICAgICAgICAgICAgICAgIGlmIHJlc3VsdCA9PSBTZWN1cjMyQ29uc3QuU0VDX0VfSU5WQUxJRF9QQVJBTUVURVI6CiAgICAgICAgICAgICAgICAgICAgaWYgZ2V0X2RoX3BhcmFtc19sZW5ndGgoaGFuZHNoYWtlX3NlcnZlcl9ieXRlcykgPCAxMDI0OgogICAgICAgICAgICAgICAgICAgICAgICByYWlzZV9kaF9wYXJhbXMoKQoKICAgICAgICAgICAgICAgIGlmIHJlc3VsdCBub3QgaW4gc2V0KFtTZWN1cjMyQ29uc3QuU0VDX0VfT0ssIFNlY3VyMzJDb25zdC5TRUNfSV9DT05USU5VRV9ORUVERURdKToKICAgICAgICAgICAgICAgICAgICBoYW5kbGVfZXJyb3IocmVzdWx0LCBUTFNFcnJvcikKCiAgICAgICAgICAgICAgICBpZiBvdXRfYnVmZmVyc1swXS5jYkJ1ZmZlciA+IDA6CiAgICAgICAgICAgICAgICAgICAgdG9rZW4gPSBieXRlc19mcm9tX2J1ZmZlcihvdXRfYnVmZmVyc1swXS5wdkJ1ZmZlciwgb3V0X2J1ZmZlcnNbMF0uY2JCdWZmZXIpCiAgICAgICAgICAgICAgICAgICAgaGFuZHNoYWtlX2NsaWVudF9ieXRlcyArPSB0b2tlbgogICAgICAgICAgICAgICAgICAgIHNlbGYuX3NvY2tldC5zZW5kKHRva2VuKQogICAgICAgICAgICAgICAgICAgIG91dF9idWZmZXJzWzBdLmNiQnVmZmVyID0gMAogICAgICAgICAgICAgICAgICAgIHNlY3VyMzIuRnJlZUNvbnRleHRCdWZmZXIob3V0X2J1ZmZlcnNbMF0ucHZCdWZmZXIpCiAgICAgICAgICAgICAgICAgICAgb3V0X2J1ZmZlcnNbMF0ucHZCdWZmZXIgPSBudWxsKCkKCiAgICAgICAgICAgICAgICBpZiBpbl9idWZmZXJzWzFdLkJ1ZmZlclR5cGUgPT0gU2VjdXIzMkNvbnN0LlNFQ0JVRkZFUl9FWFRSQToKICAgICAgICAgICAgICAgICAgICBleHRyYV9hbW91bnQgPSBpbl9idWZmZXJzWzFdLmNiQnVmZmVyCiAgICAgICAgICAgICAgICAgICAgc2VsZi5fcmVjZWl2ZWRfYnl0ZXMgPSBzZWxmLl9yZWNlaXZlZF9ieXRlc1stZXh0cmFfYW1vdW50Ol0KICAgICAgICAgICAgICAgICAgICBpbl9idWZmZXJzWzFdLkJ1ZmZlclR5cGUgPSBTZWN1cjMyQ29uc3QuU0VDQlVGRkVSX0VNUFRZCiAgICAgICAgICAgICAgICAgICAgaW5fYnVmZmVyc1sxXS5jYkJ1ZmZlciA9IDAKICAgICAgICAgICAgICAgICAgICBzZWN1cjMyLkZyZWVDb250ZXh0QnVmZmVyKGluX2J1ZmZlcnNbMV0ucHZCdWZmZXIpCiAgICAgICAgICAgICAgICAgICAgaW5fYnVmZmVyc1sxXS5wdkJ1ZmZlciA9IG51bGwoKQoKICAgICAgICAgICAgICAgICAgICAjIFRoZSBoYW5kc2hha2UgaXMgY29tcGxldGUsIHNvIGRpc2NhcmQgYW55IGV4dHJhIGJ5dGVzCiAgICAgICAgICAgICAgICAgICAgaWYgcmVzdWx0ID09IFNlY3VyMzJDb25zdC5TRUNfRV9PSzoKICAgICAgICAgICAgICAgICAgICAgICAgaGFuZHNoYWtlX3NlcnZlcl9ieXRlcyA9IGhhbmRzaGFrZV9zZXJ2ZXJfYnl0ZXNbLWV4dHJhX2Ftb3VudDpdCgogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBzZWxmLl9yZWNlaXZlZF9ieXRlcyA9IGInJwoKICAgICAgICAgICAgY29ubmVjdGlvbl9pbmZvX3BvaW50ZXIgPSBzdHJ1Y3Qoc2VjdXIzMiwgJ1NlY1BrZ0NvbnRleHRfQ29ubmVjdGlvbkluZm8nKQogICAgICAgICAgICByZXN1bHQgPSBzZWN1cjMyLlF1ZXJ5Q29udGV4dEF0dHJpYnV0ZXNXKAogICAgICAgICAgICAgICAgdGVtcF9jb250ZXh0X2hhbmRsZV9wb2ludGVyLAogICAgICAgICAgICAgICAgU2VjdXIzMkNvbnN0LlNFQ1BLR19BVFRSX0NPTk5FQ1RJT05fSU5GTywKICAgICAgICAgICAgICAgIGNvbm5lY3Rpb25faW5mb19wb2ludGVyCiAgICAgICAgICAgICkKICAgICAgICAgICAgaGFuZGxlX2Vycm9yKHJlc3VsdCwgVExTRXJyb3IpCgogICAgICAgICAgICBjb25uZWN0aW9uX2luZm8gPSB1bndyYXAoY29ubmVjdGlvbl9pbmZvX3BvaW50ZXIpCgogICAgICAgICAgICBzZWxmLl9wcm90b2NvbCA9IHsKICAgICAgICAgICAgICAgIFNlY3VyMzJDb25zdC5TUF9QUk9UX1NTTDJfQ0xJRU5UOiAnU1NMdjInLAogICAgICAgICAgICAgICAgU2VjdXIzMkNvbnN0LlNQX1BST1RfU1NMM19DTElFTlQ6ICdTU0x2MycsCiAgICAgICAgICAgICAgICBTZWN1cjMyQ29uc3QuU1BfUFJPVF9UTFMxX0NMSUVOVDogJ1RMU3YxJywKICAgICAgICAgICAgICAgIFNlY3VyMzJDb25zdC5TUF9QUk9UX1RMUzFfMV9DTElFTlQ6ICdUTFN2MS4xJywKICAgICAgICAgICAgICAgIFNlY3VyMzJDb25zdC5TUF9QUk9UX1RMUzFfMl9DTElFTlQ6ICdUTFN2MS4yJywKICAgICAgICAgICAgfS5nZXQobmF0aXZlKGludCwgY29ubmVjdGlvbl9pbmZvLmR3UHJvdG9jb2wpLCBzdHJfY2xzKGNvbm5lY3Rpb25faW5mby5kd1Byb3RvY29sKSkKCiAgICAgICAgICAgIGlmIHNlbGYuX3Byb3RvY29sIGluIHNldChbJ1NTTHYzJywgJ1RMU3YxJywgJ1RMU3YxLjEnLCAnVExTdjEuMiddKToKICAgICAgICAgICAgICAgIHNlc3Npb25faW5mbyA9IHBhcnNlX3Nlc3Npb25faW5mbyhoYW5kc2hha2Vfc2VydmVyX2J5dGVzLCBoYW5kc2hha2VfY2xpZW50X2J5dGVzKQogICAgICAgICAgICAgICAgc2VsZi5fY2lwaGVyX3N1aXRlID0gc2Vzc2lvbl9pbmZvWydjaXBoZXJfc3VpdGUnXQogICAgICAgICAgICAgICAgc2VsZi5fY29tcHJlc3Npb24gPSBzZXNzaW9uX2luZm9bJ2NvbXByZXNzaW9uJ10KICAgICAgICAgICAgICAgIHNlbGYuX3Nlc3Npb25faWQgPSBzZXNzaW9uX2luZm9bJ3Nlc3Npb25faWQnXQogICAgICAgICAgICAgICAgc2VsZi5fc2Vzc2lvbl90aWNrZXQgPSBzZXNzaW9uX2luZm9bJ3Nlc3Npb25fdGlja2V0J10KCiAgICAgICAgICAgIG91dHB1dF9jb250ZXh0X2ZsYWdzID0gZGVyZWYob3V0cHV0X2NvbnRleHRfZmxhZ3NfcG9pbnRlcikKCiAgICAgICAgICAgIGZvciBmbGFnIGluIHJlcXVlc3RlZF9mbGFnczoKICAgICAgICAgICAgICAgIGlmIChmbGFnIHwgb3V0cHV0X2NvbnRleHRfZmxhZ3MpID09IDA6CiAgICAgICAgICAgICAgICAgICAgcmFpc2UgT1NFcnJvcihwcmV0dHlfbWVzc2FnZSgKICAgICAgICAgICAgICAgICAgICAgICAgJycnCiAgICAgICAgICAgICAgICAgICAgICAgIFVuYWJsZSB0byBvYnRhaW4gYSBjcmVkZW50aWFsIGNvbnRleHQgd2l0aCB0aGUgcHJvcGVydHkgJXMKICAgICAgICAgICAgICAgICAgICAgICAgJycnLAogICAgICAgICAgICAgICAgICAgICAgICByZXF1ZXN0ZWRfZmxhZ3NbZmxhZ10KICAgICAgICAgICAgICAgICAgICApKQoKICAgICAgICAgICAgaWYgbm90IHJlbmVnb3RpYXRlOgogICAgICAgICAgICAgICAgc2VsZi5fY29udGV4dF9oYW5kbGVfcG9pbnRlciA9IHRlbXBfY29udGV4dF9oYW5kbGVfcG9pbnRlcgogICAgICAgICAgICAgICAgbmV3X2NvbnRleHRfaGFuZGxlX3BvaW50ZXIgPSBOb25lCgogICAgICAgICAgICAgICAgc3RyZWFtX3NpemVzX3BvaW50ZXIgPSBzdHJ1Y3Qoc2VjdXIzMiwgJ1NlY1BrZ0NvbnRleHRfU3RyZWFtU2l6ZXMnKQogICAgICAgICAgICAgICAgcmVzdWx0ID0gc2VjdXIzMi5RdWVyeUNvbnRleHRBdHRyaWJ1dGVzVygKICAgICAgICAgICAgICAgICAgICBzZWxmLl9jb250ZXh0X2hhbmRsZV9wb2ludGVyLAogICAgICAgICAgICAgICAgICAgIFNlY3VyMzJDb25zdC5TRUNQS0dfQVRUUl9TVFJFQU1fU0laRVMsCiAgICAgICAgICAgICAgICAgICAgc3RyZWFtX3NpemVzX3BvaW50ZXIKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgIGhhbmRsZV9lcnJvcihyZXN1bHQpCgogICAgICAgICAgICAgICAgc3RyZWFtX3NpemVzID0gdW53cmFwKHN0cmVhbV9zaXplc19wb2ludGVyKQogICAgICAgICAgICAgICAgc2VsZi5faGVhZGVyX3NpemUgPSBuYXRpdmUoaW50LCBzdHJlYW1fc2l6ZXMuY2JIZWFkZXIpCiAgICAgICAgICAgICAgICBzZWxmLl9tZXNzYWdlX3NpemUgPSBuYXRpdmUoaW50LCBzdHJlYW1fc2l6ZXMuY2JNYXhpbXVtTWVzc2FnZSkKICAgICAgICAgICAgICAgIHNlbGYuX3RyYWlsZXJfc2l6ZSA9IG5hdGl2ZShpbnQsIHN0cmVhbV9zaXplcy5jYlRyYWlsZXIpCiAgICAgICAgICAgICAgICBzZWxmLl9idWZmZXJfc2l6ZSA9IHNlbGYuX2hlYWRlcl9zaXplICsgc2VsZi5fbWVzc2FnZV9zaXplICsgc2VsZi5fdHJhaWxlcl9zaXplCgogICAgICAgICAgICBpZiBzZWxmLl9zZXNzaW9uLl9leHRyYV90cnVzdF9yb290czoKICAgICAgICAgICAgICAgIHNlbGYuX2V4dHJhX3RydXN0X3Jvb3RfdmFsaWRhdGlvbigpCgogICAgICAgIGV4Y2VwdCAoT1NFcnJvciwgc29ja2V0Xy5lcnJvcik6CiAgICAgICAgICAgIHNlbGYuY2xvc2UoKQoKICAgICAgICAgICAgcmFpc2UKCiAgICAgICAgZmluYWxseToKICAgICAgICAgICAgaWYgb3V0X2J1ZmZlcnM6CiAgICAgICAgICAgICAgICBpZiBub3QgaXNfbnVsbChvdXRfYnVmZmVyc1swXS5wdkJ1ZmZlcik6CiAgICAgICAgICAgICAgICAgICAgc2VjdXIzMi5GcmVlQ29udGV4dEJ1ZmZlcihvdXRfYnVmZmVyc1swXS5wdkJ1ZmZlcikKICAgICAgICAgICAgICAgIGlmIG5vdCBpc19udWxsKG91dF9idWZmZXJzWzFdLnB2QnVmZmVyKToKICAgICAgICAgICAgICAgICAgICBzZWN1cjMyLkZyZWVDb250ZXh0QnVmZmVyKG91dF9idWZmZXJzWzFdLnB2QnVmZmVyKQogICAgICAgICAgICBpZiBuZXdfY29udGV4dF9oYW5kbGVfcG9pbnRlcjoKICAgICAgICAgICAgICAgIHNlY3VyMzIuRGVsZXRlU2VjdXJpdHlDb250ZXh0KG5ld19jb250ZXh0X2hhbmRsZV9wb2ludGVyKQoKICAgIGRlZiByZWFkKHNlbGYsIG1heF9sZW5ndGgpOgogICAgICAgICIiIgogICAgICAgIFJlYWRzIGRhdGEgZnJvbSB0aGUgVExTLXdyYXBwZWQgc29ja2V0CgogICAgICAgIDpwYXJhbSBtYXhfbGVuZ3RoOgogICAgICAgICAgICBUaGUgbnVtYmVyIG9mIGJ5dGVzIHRvIHJlYWQKCiAgICAgICAgOnJhaXNlczoKICAgICAgICAgICAgc29ja2V0LnNvY2tldCAtIHdoZW4gYSBub24tVExTIHNvY2tldCBlcnJvciBvY2N1cnMKICAgICAgICAgICAgb3NjcnlwdG8uZXJyb3JzLlRMU0Vycm9yIC0gd2hlbiBhIFRMUy1yZWxhdGVkIGVycm9yIG9jY3VycwogICAgICAgICAgICBWYWx1ZUVycm9yIC0gd2hlbiBhbnkgb2YgdGhlIHBhcmFtZXRlcnMgY29udGFpbiBhbiBpbnZhbGlkIHZhbHVlCiAgICAgICAgICAgIFR5cGVFcnJvciAtIHdoZW4gYW55IG9mIHRoZSBwYXJhbWV0ZXJzIGFyZSBvZiB0aGUgd3JvbmcgdHlwZQogICAgICAgICAgICBPU0Vycm9yIC0gd2hlbiBhbiBlcnJvciBpcyByZXR1cm5lZCBieSB0aGUgT1MgY3J5cHRvIGxpYnJhcnkKCiAgICAgICAgOnJldHVybjoKICAgICAgICAgICAgQSBieXRlIHN0cmluZyBvZiB0aGUgZGF0YSByZWFkCiAgICAgICAgIiIiCgogICAgICAgIGlmIG5vdCBpc2luc3RhbmNlKG1heF9sZW5ndGgsIGludF90eXBlcyk6CiAgICAgICAgICAgIHJhaXNlIFR5cGVFcnJvcihwcmV0dHlfbWVzc2FnZSgKICAgICAgICAgICAgICAgICcnJwogICAgICAgICAgICAgICAgbWF4X2xlbmd0aCBtdXN0IGJlIGFuIGludGVnZXIsIG5vdCAlcwogICAgICAgICAgICAgICAgJycnLAogICAgICAgICAgICAgICAgdHlwZV9uYW1lKG1heF9sZW5ndGgpCiAgICAgICAgICAgICkpCgogICAgICAgIGlmIHNlbGYuX2NvbnRleHRfaGFuZGxlX3BvaW50ZXIgaXMgTm9uZToKCiAgICAgICAgICAgICMgQWxsb3cgdGhlIHVzZXIgdG8gcmVhZCBhbnkgcmVtYWluaW5nIGRlY3J5cHRlZCBkYXRhCiAgICAgICAgICAgIGlmIHNlbGYuX2RlY3J5cHRlZF9ieXRlcyAhPSBiJyc6CiAgICAgICAgICAgICAgICBvdXRwdXQgPSBzZWxmLl9kZWNyeXB0ZWRfYnl0ZXNbMDptYXhfbGVuZ3RoXQogICAgICAgICAgICAgICAgc2VsZi5fZGVjcnlwdGVkX2J5dGVzID0gc2VsZi5fZGVjcnlwdGVkX2J5dGVzW21heF9sZW5ndGg6XQogICAgICAgICAgICAgICAgcmV0dXJuIG91dHB1dAoKICAgICAgICAgICAgc2VsZi5fcmFpc2VfY2xvc2VkKCkKCiAgICAgICAgIyBUaGUgZmlyc3QgdGltZSByZWFkIGlzIGNhbGxlZCwgc2V0IHVwIGEgc2luZ2xlIGNvbnRpZ3VvdXMgYnVmZmVyIHRoYXQKICAgICAgICAjIGl0IHVzZWQgYnkgRGVjcnlwdE1lc3NhZ2UoKSB0byBwb3B1bGF0ZSB0aGUgdGhyZWUgb3V0cHV0IGJ1ZmZlcnMuCiAgICAgICAgIyBTaW5jZSB3ZSBhcmUgY3JlYXRpbmcgdGhlIGJ1ZmZlciwgd2UgZG8gbm90IG5lZWQgdG8gZnJlZSBpdCBvdGhlcgogICAgICAgICMgdGhhbiBhbGxvd2luZyBQeXRob24gdG8gR0MgaXQgb25jZSB0aGlzIG9iamVjdCBpcyBHQ2VkLgogICAgICAgIGlmIG5vdCBzZWxmLl9kZWNyeXB0X2RhdGFfYnVmZmVyOgogICAgICAgICAgICBzZWxmLl9kZWNyeXB0X2RhdGFfYnVmZmVyID0gYnVmZmVyX2Zyb21fYnl0ZXMoc2VsZi5fYnVmZmVyX3NpemUpCiAgICAgICAgICAgIHNlbGYuX2RlY3J5cHRfZGVzYywgc2VsZi5fZGVjcnlwdF9idWZmZXJzID0gc2VsZi5fY3JlYXRlX2J1ZmZlcnMoNCkKICAgICAgICAgICAgc2VsZi5fZGVjcnlwdF9idWZmZXJzWzBdLkJ1ZmZlclR5cGUgPSBTZWN1cjMyQ29uc3QuU0VDQlVGRkVSX0RBVEEKICAgICAgICAgICAgc2VsZi5fZGVjcnlwdF9idWZmZXJzWzBdLnB2QnVmZmVyID0gY2FzdChzZWN1cjMyLCAnQllURSAqJywgc2VsZi5fZGVjcnlwdF9kYXRhX2J1ZmZlcikKCiAgICAgICAgdG9fcmVjdiA9IG1heChtYXhfbGVuZ3RoLCBzZWxmLl9idWZmZXJfc2l6ZSkKCiAgICAgICAgIyBUaGVzZSB2YXJpYWJsZXMgYXJlIHNldCB0byByZWR1Y2UgZGljdCBhY2Nlc3MgYW5kIGZ1bmN0aW9uIGNhbGxzCiAgICAgICAgIyBpbiB0aGUgcmVhZCBsb29wLiBBbHNvIG1ha2VzIHRoZSBjb2RlIGVhc2llciB0byByZWFkLgogICAgICAgIG51bGxfdmFsdWUgPSBudWxsKCkKICAgICAgICBidWYwID0gc2VsZi5fZGVjcnlwdF9idWZmZXJzWzBdCiAgICAgICAgYnVmMSA9IHNlbGYuX2RlY3J5cHRfYnVmZmVyc1sxXQogICAgICAgIGJ1ZjIgPSBzZWxmLl9kZWNyeXB0X2J1ZmZlcnNbMl0KICAgICAgICBidWYzID0gc2VsZi5fZGVjcnlwdF9idWZmZXJzWzNdCgogICAgICAgIGRlZiBfcmVzZXRfYnVmZmVycygpOgogICAgICAgICAgICBidWYwLkJ1ZmZlclR5cGUgPSBTZWN1cjMyQ29uc3QuU0VDQlVGRkVSX0RBVEEKICAgICAgICAgICAgYnVmMC5wdkJ1ZmZlciA9IGNhc3Qoc2VjdXIzMiwgJ0JZVEUgKicsIHNlbGYuX2RlY3J5cHRfZGF0YV9idWZmZXIpCiAgICAgICAgICAgIGJ1ZjAuY2JCdWZmZXIgPSAwCgogICAgICAgICAgICBidWYxLkJ1ZmZlclR5cGUgPSBTZWN1cjMyQ29uc3QuU0VDQlVGRkVSX0VNUFRZCiAgICAgICAgICAgIGJ1ZjEucHZCdWZmZXIgPSBudWxsX3ZhbHVlCiAgICAgICAgICAgIGJ1ZjEuY2JCdWZmZXIgPSAwCgogICAgICAgICAgICBidWYyLkJ1ZmZlclR5cGUgPSBTZWN1cjMyQ29uc3QuU0VDQlVGRkVSX0VNUFRZCiAgICAgICAgICAgIGJ1ZjIucHZCdWZmZXIgPSBudWxsX3ZhbHVlCiAgICAgICAgICAgIGJ1ZjIuY2JCdWZmZXIgPSAwCgogICAgICAgICAgICBidWYzLkJ1ZmZlclR5cGUgPSBTZWN1cjMyQ29uc3QuU0VDQlVGRkVSX0VNUFRZCiAgICAgICAgICAgIGJ1ZjMucHZCdWZmZXIgPSBudWxsX3ZhbHVlCiAgICAgICAgICAgIGJ1ZjMuY2JCdWZmZXIgPSAwCgogICAgICAgIG91dHB1dCA9IHNlbGYuX2RlY3J5cHRlZF9ieXRlcwogICAgICAgIG91dHB1dF9sZW4gPSBsZW4ob3V0cHV0KQoKICAgICAgICBzZWxmLl9kZWNyeXB0ZWRfYnl0ZXMgPSBiJycKCiAgICAgICAgIyBEb24ndCBibG9jayBpZiB3ZSBoYXZlIGJ1ZmZlcmVkIGRhdGEgYXZhaWxhYmxlCiAgICAgICAgaWYgb3V0cHV0X2xlbiA+IDAgYW5kIG5vdCBzZWxmLnNlbGVjdF9yZWFkKDApOgogICAgICAgICAgICBzZWxmLl9kZWNyeXB0ZWRfYnl0ZXMgPSBiJycKICAgICAgICAgICAgcmV0dXJuIG91dHB1dAoKICAgICAgICAjIFRoaXMgcmVhZCBsb29wIHdpbGwgb25seSBiZSBydW4gaWYgdGhlcmUgd2Fzbid0IGVub3VnaAogICAgICAgICMgYnVmZmVyZWQgZGF0YSB0byBmdWxmaWxsIHRoZSByZXF1ZXN0ZWQgbWF4X2xlbmd0aAogICAgICAgIGRvX3JlYWQgPSBsZW4oc2VsZi5fcmVjZWl2ZWRfYnl0ZXMpID09IDAKCiAgICAgICAgd2hpbGUgb3V0cHV0X2xlbiA8IG1heF9sZW5ndGg6CiAgICAgICAgICAgIGlmIGRvX3JlYWQ6CiAgICAgICAgICAgICAgICBzZWxmLl9yZWNlaXZlZF9ieXRlcyArPSBzZWxmLl9zb2NrZXQucmVjdih0b19yZWN2KQogICAgICAgICAgICAgICAgaWYgbGVuKHNlbGYuX3JlY2VpdmVkX2J5dGVzKSA9PSAwOgogICAgICAgICAgICAgICAgICAgIHJhaXNlX2Rpc2Nvbm5lY3Rpb24oKQoKICAgICAgICAgICAgZGF0YV9sZW4gPSBtaW4obGVuKHNlbGYuX3JlY2VpdmVkX2J5dGVzKSwgc2VsZi5fYnVmZmVyX3NpemUpCiAgICAgICAgICAgIGlmIGRhdGFfbGVuID09IDA6CiAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICBzZWxmLl9kZWNyeXB0X2J1ZmZlcnNbMF0uY2JCdWZmZXIgPSBkYXRhX2xlbgogICAgICAgICAgICB3cml0ZV90b19idWZmZXIoc2VsZi5fZGVjcnlwdF9kYXRhX2J1ZmZlciwgc2VsZi5fcmVjZWl2ZWRfYnl0ZXNbMDpkYXRhX2xlbl0pCgogICAgICAgICAgICByZXN1bHQgPSBzZWN1cjMyLkRlY3J5cHRNZXNzYWdlKAogICAgICAgICAgICAgICAgc2VsZi5fY29udGV4dF9oYW5kbGVfcG9pbnRlciwKICAgICAgICAgICAgICAgIHNlbGYuX2RlY3J5cHRfZGVzYywKICAgICAgICAgICAgICAgIDAsCiAgICAgICAgICAgICAgICBudWxsKCkKICAgICAgICAgICAgKQoKICAgICAgICAgICAgZG9fcmVhZCA9IEZhbHNlCgogICAgICAgICAgICBpZiByZXN1bHQgPT0gU2VjdXIzMkNvbnN0LlNFQ19FX0lOQ09NUExFVEVfTUVTU0FHRToKICAgICAgICAgICAgICAgIF9yZXNldF9idWZmZXJzKCkKICAgICAgICAgICAgICAgIGRvX3JlYWQgPSBUcnVlCiAgICAgICAgICAgICAgICBjb250aW51ZQoKICAgICAgICAgICAgZWxpZiByZXN1bHQgPT0gU2VjdXIzMkNvbnN0LlNFQ19JX0NPTlRFWFRfRVhQSVJFRDoKICAgICAgICAgICAgICAgIHNlbGYuX3JlbW90ZV9jbG9zZWQgPSBUcnVlCiAgICAgICAgICAgICAgICBzZWxmLnNodXRkb3duKCkKICAgICAgICAgICAgICAgIGJyZWFrCgogICAgICAgICAgICBlbGlmIHJlc3VsdCA9PSBTZWN1cjMyQ29uc3QuU0VDX0lfUkVORUdPVElBVEU6CiAgICAgICAgICAgICAgICBzZWxmLl9oYW5kc2hha2UocmVuZWdvdGlhdGU9VHJ1ZSkKICAgICAgICAgICAgICAgIHJldHVybiBzZWxmLnJlYWQobWF4X2xlbmd0aCkKCiAgICAgICAgICAgIGVsaWYgcmVzdWx0ICE9IFNlY3VyMzJDb25zdC5TRUNfRV9PSzoKICAgICAgICAgICAgICAgIGhhbmRsZV9lcnJvcihyZXN1bHQsIFRMU0Vycm9yKQoKICAgICAgICAgICAgdmFsaWRfYnVmZmVyX3R5cGVzID0gc2V0KFsKICAgICAgICAgICAgICAgIFNlY3VyMzJDb25zdC5TRUNCVUZGRVJfRU1QVFksCiAgICAgICAgICAgICAgICBTZWN1cjMyQ29uc3QuU0VDQlVGRkVSX1NUUkVBTV9IRUFERVIsCiAgICAgICAgICAgICAgICBTZWN1cjMyQ29uc3QuU0VDQlVGRkVSX1NUUkVBTV9UUkFJTEVSCiAgICAgICAgICAgIF0pCiAgICAgICAgICAgIGV4dHJhX2Ftb3VudCA9IE5vbmUKICAgICAgICAgICAgZm9yIGJ1ZiBpbiAoYnVmMCwgYnVmMSwgYnVmMiwgYnVmMyk6CiAgICAgICAgICAgICAgICBidWZmZXJfdHlwZSA9IGJ1Zi5CdWZmZXJUeXBlCiAgICAgICAgICAgICAgICBpZiBidWZmZXJfdHlwZSA9PSBTZWN1cjMyQ29uc3QuU0VDQlVGRkVSX0RBVEE6CiAgICAgICAgICAgICAgICAgICAgb3V0cHV0ICs9IGJ5dGVzX2Zyb21fYnVmZmVyKGJ1Zi5wdkJ1ZmZlciwgYnVmLmNiQnVmZmVyKQogICAgICAgICAgICAgICAgICAgIG91dHB1dF9sZW4gPSBsZW4ob3V0cHV0KQogICAgICAgICAgICAgICAgZWxpZiBidWZmZXJfdHlwZSA9PSBTZWN1cjMyQ29uc3QuU0VDQlVGRkVSX0VYVFJBOgogICAgICAgICAgICAgICAgICAgIGV4dHJhX2Ftb3VudCA9IG5hdGl2ZShpbnQsIGJ1Zi5jYkJ1ZmZlcikKICAgICAgICAgICAgICAgIGVsaWYgYnVmZmVyX3R5cGUgbm90IGluIHZhbGlkX2J1ZmZlcl90eXBlczoKICAgICAgICAgICAgICAgICAgICByYWlzZSBPU0Vycm9yKHByZXR0eV9tZXNzYWdlKAogICAgICAgICAgICAgICAgICAgICAgICAnJycKICAgICAgICAgICAgICAgICAgICAgICAgVW5leHBlY3RlZCBkZWNyeXB0IG91dHB1dCBidWZmZXIgb2YgdHlwZSAlcwogICAgICAgICAgICAgICAgICAgICAgICAnJycsCiAgICAgICAgICAgICAgICAgICAgICAgIGJ1ZmZlcl90eXBlCiAgICAgICAgICAgICAgICAgICAgKSkKCiAgICAgICAgICAgIGlmIGV4dHJhX2Ftb3VudDoKICAgICAgICAgICAgICAgIHNlbGYuX3JlY2VpdmVkX2J5dGVzID0gc2VsZi5fcmVjZWl2ZWRfYnl0ZXNbZGF0YV9sZW4gLSBleHRyYV9hbW91bnQ6XQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgc2VsZi5fcmVjZWl2ZWRfYnl0ZXMgPSBzZWxmLl9yZWNlaXZlZF9ieXRlc1tkYXRhX2xlbjpdCgogICAgICAgICAgICAjIEhlcmUgd2UgcmVzZXQgdGhlIHN0cnVjdHMgZm9yIHRoZSBuZXh0IGNhbGwgdG8gRGVjcnlwdE1lc3NhZ2UoKQogICAgICAgICAgICBfcmVzZXRfYnVmZmVycygpCgogICAgICAgICAgICAjIElmIHdlIGhhdmUgcmVhZCBzb21ldGhpbmcsIGJ1dCB0aGVyZSBpcyBub3RoaW5nIGxlZnQgdG8gcmVhZCwgd2UKICAgICAgICAgICAgIyBicmVhayBzbyB0aGF0IHdlIGRvbid0IGJsb2NrIGZvciBsb25nZXIgdGhhbiBuZWNlc3NhcnkKICAgICAgICAgICAgaWYgc2VsZi5zZWxlY3RfcmVhZCgwKToKICAgICAgICAgICAgICAgIGRvX3JlYWQgPSBUcnVlCgogICAgICAgICAgICBpZiBub3QgZG9fcmVhZCBhbmQgbGVuKHNlbGYuX3JlY2VpdmVkX2J5dGVzKSA9PSAwOgogICAgICAgICAgICAgICAgYnJlYWsKCiAgICAgICAgIyBJZiB0aGUgb3V0cHV0IGlzIG1vcmUgdGhhbiB3ZSByZXF1ZXN0ZWQgKGJlY2F1c2UgZGF0YSBpcyBkZWNyeXB0ZWQgaW4KICAgICAgICAjIGJsb2NrcyksIHdlIHNhdmUgdGhlIGV4dHJhIGluIGEgYnVmZmVyCiAgICAgICAgaWYgbGVuKG91dHB1dCkgPiBtYXhfbGVuZ3RoOgogICAgICAgICAgICBzZWxmLl9kZWNyeXB0ZWRfYnl0ZXMgPSBvdXRwdXRbbWF4X2xlbmd0aDpdCiAgICAgICAgICAgIG91dHB1dCA9IG91dHB1dFswOm1heF9sZW5ndGhdCgogICAgICAgIHJldHVybiBvdXRwdXQKCiAgICBkZWYgc2VsZWN0X3JlYWQoc2VsZiwgdGltZW91dD1Ob25lKToKICAgICAgICAiIiIKICAgICAgICBCbG9ja3MgdW50aWwgdGhlIHNvY2tldCBpcyByZWFkeSB0byBiZSByZWFkIGZyb20sIG9yIHRoZSB0aW1lb3V0IGlzIGhpdAoKICAgICAgICA6cGFyYW0gdGltZW91dDoKICAgICAgICAgICAgQSBmbG9hdCAtIHRoZSBwZXJpb2Qgb2YgdGltZSB0byB3YWl0IGZvciBkYXRhIHRvIGJlIHJlYWQuIE5vbmUgZm9yCiAgICAgICAgICAgIG5vIHRpbWUgbGltaXQuCgogICAgICAgIDpyZXR1cm46CiAgICAgICAgICAgIEEgYm9vbGVhbiAtIGlmIGRhdGEgaXMgcmVhZHkgdG8gYmUgcmVhZC4gV2lsbCBvbmx5IGJlIEZhbHNlIGlmCiAgICAgICAgICAgIHRpbWVvdXQgaXMgbm90IE5vbmUuCiAgICAgICAgIiIiCgogICAgICAgICMgSWYgd2UgaGF2ZSBidWZmZXJlZCBkYXRhLCB3ZSBjb25zaWRlciBhIHJlYWQgcG9zc2libGUKICAgICAgICBpZiBsZW4oc2VsZi5fZGVjcnlwdGVkX2J5dGVzKSA+IDA6CiAgICAgICAgICAgIHJldHVybiBUcnVlCgogICAgICAgIHJlYWRfcmVhZHksIF8sIF8gPSBzZWxlY3Quc2VsZWN0KFtzZWxmLl9zb2NrZXRdLCBbXSwgW10sIHRpbWVvdXQpCiAgICAgICAgcmV0dXJuIGxlbihyZWFkX3JlYWR5KSA+IDAKCiAgICBkZWYgcmVhZF91bnRpbChzZWxmLCBtYXJrZXIpOgogICAgICAgICIiIgogICAgICAgIFJlYWRzIGRhdGEgZnJvbSB0aGUgc29ja2V0IHVudGlsIGEgbWFya2VyIGlzIGZvdW5kLiBEYXRhIHJlYWQgbWF5CiAgICAgICAgaW5jbHVkZSBkYXRhIGJleW9uZCB0aGUgbWFya2VyLgoKICAgICAgICA6cGFyYW0gbWFya2VyOgogICAgICAgICAgICBBIGJ5dGUgc3RyaW5nIG9yIHJlZ2V4IG9iamVjdCBmcm9tIHJlLmNvbXBpbGUoKS4gVXNlZCB0byBkZXRlcm1pbmUKICAgICAgICAgICAgd2hlbiB0byBzdG9wIHJlYWRpbmcuIFJlZ2V4IG9iamVjdHMgYXJlIG1vcmUgaW5lZmZpY2llbnQgc2luY2UKICAgICAgICAgICAgdGhleSBtdXN0IHNjYW4gdGhlIGVudGlyZSBieXRlIHN0cmluZyBvZiByZWFkIGRhdGEgZWFjaCB0aW1lIGRhdGEKICAgICAgICAgICAgaXMgcmVhZCBvZmYgdGhlIHNvY2tldC4KCiAgICAgICAgOnJldHVybjoKICAgICAgICAgICAgQSBieXRlIHN0cmluZyBvZiB0aGUgZGF0YSByZWFkCiAgICAgICAgIiIiCgogICAgICAgIGlmIG5vdCBpc2luc3RhbmNlKG1hcmtlciwgYnl0ZV9jbHMpIGFuZCBub3QgaXNpbnN0YW5jZShtYXJrZXIsIFBhdHRlcm4pOgogICAgICAgICAgICByYWlzZSBUeXBlRXJyb3IocHJldHR5X21lc3NhZ2UoCiAgICAgICAgICAgICAgICAnJycKICAgICAgICAgICAgICAgIG1hcmtlciBtdXN0IGJlIGEgYnl0ZSBzdHJpbmcgb3IgY29tcGlsZWQgcmVnZXggb2JqZWN0LCBub3QgJXMKICAgICAgICAgICAgICAgICcnJywKICAgICAgICAgICAgICAgIHR5cGVfbmFtZShtYXJrZXIpCiAgICAgICAgICAgICkpCgogICAgICAgIG91dHB1dCA9IGInJwoKICAgICAgICBpc19yZWdleCA9IGlzaW5zdGFuY2UobWFya2VyLCBQYXR0ZXJuKQoKICAgICAgICB3aGlsZSBUcnVlOgogICAgICAgICAgICBpZiBsZW4oc2VsZi5fZGVjcnlwdGVkX2J5dGVzKSA+IDA6CiAgICAgICAgICAgICAgICBjaHVuayA9IHNlbGYuX2RlY3J5cHRlZF9ieXRlcwogICAgICAgICAgICAgICAgc2VsZi5fZGVjcnlwdGVkX2J5dGVzID0gYicnCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBjaHVuayA9IHNlbGYucmVhZCg4MTkyKQoKICAgICAgICAgICAgb2Zmc2V0ID0gbGVuKG91dHB1dCkKICAgICAgICAgICAgb3V0cHV0ICs9IGNodW5rCgogICAgICAgICAgICBpZiBpc19yZWdleDoKICAgICAgICAgICAgICAgIG1hdGNoID0gbWFya2VyLnNlYXJjaChvdXRwdXQpCiAgICAgICAgICAgICAgICBpZiBtYXRjaCBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgICAgICBlbmQgPSBtYXRjaC5lbmQoKQogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAjIElmIHRoZSBtYXJrZXIgd2FzIG5vdCBmb3VuZCBsYXN0IHRpbWUsIHdlIGhhdmUgdG8gc3RhcnQKICAgICAgICAgICAgICAgICMgYXQgYSBwb3NpdGlvbiB3aGVyZSB0aGUgbWFya2VyIHdvdWxkIGhhdmUgaXRzIGZpbmFsIGNoYXIKICAgICAgICAgICAgICAgICMgaW4gdGhlIG5ld2x5IHJlYWQgY2h1bmsKICAgICAgICAgICAgICAgIHN0YXJ0ID0gbWF4KDAsIG9mZnNldCAtIGxlbihtYXJrZXIpIC0gMSkKICAgICAgICAgICAgICAgIG1hdGNoID0gb3V0cHV0LmZpbmQobWFya2VyLCBzdGFydCkKICAgICAgICAgICAgICAgIGlmIG1hdGNoICE9IC0xOgogICAgICAgICAgICAgICAgICAgIGVuZCA9IG1hdGNoICsgbGVuKG1hcmtlcikKICAgICAgICAgICAgICAgICAgICBicmVhawoKICAgICAgICBzZWxmLl9kZWNyeXB0ZWRfYnl0ZXMgPSBvdXRwdXRbZW5kOl0gKyBzZWxmLl9kZWNyeXB0ZWRfYnl0ZXMKICAgICAgICByZXR1cm4gb3V0cHV0WzA6ZW5kXQoKICAgIGRlZiByZWFkX2xpbmUoc2VsZik6CiAgICAgICAgciIiIgogICAgICAgIFJlYWRzIGEgbGluZSBmcm9tIHRoZSBzb2NrZXQsIGluY2x1ZGluZyB0aGUgbGluZSBlbmRpbmcgb2YgIlxyXG4iLCAiXHIiLAogICAgICAgIG9yICJcbiIKCiAgICAgICAgOnJldHVybjoKICAgICAgICAgICAgQSBieXRlIHN0cmluZyBvZiB0aGUgbmV4dCBsaW5lIGZyb20gdGhlIHNvY2tldAogICAgICAgICIiIgoKICAgICAgICByZXR1cm4gc2VsZi5yZWFkX3VudGlsKF9saW5lX3JlZ2V4KQoKICAgIGRlZiByZWFkX2V4YWN0bHkoc2VsZiwgbnVtX2J5dGVzKToKICAgICAgICAiIiIKICAgICAgICBSZWFkcyBleGFjdGx5IHRoZSBzcGVjaWZpZWQgbnVtYmVyIG9mIGJ5dGVzIGZyb20gdGhlIHNvY2tldAoKICAgICAgICA6cGFyYW0gbnVtX2J5dGVzOgogICAgICAgICAgICBBbiBpbnRlZ2VyIC0gdGhlIGV4YWN0IG51bWJlciBvZiBieXRlcyB0byByZWFkCgogICAgICAgIDpyZXR1cm46CiAgICAgICAgICAgIEEgYnl0ZSBzdHJpbmcgb2YgdGhlIGRhdGEgdGhhdCB3YXMgcmVhZAogICAgICAgICIiIgoKICAgICAgICBvdXRwdXQgPSBiJycKICAgICAgICByZW1haW5pbmcgPSBudW1fYnl0ZXMKICAgICAgICB3aGlsZSByZW1haW5pbmcgPiAwOgogICAgICAgICAgICBvdXRwdXQgKz0gc2VsZi5yZWFkKHJlbWFpbmluZykKICAgICAgICAgICAgcmVtYWluaW5nID0gbnVtX2J5dGVzIC0gbGVuKG91dHB1dCkKCiAgICAgICAgcmV0dXJuIG91dHB1dAoKICAgIGRlZiB3cml0ZShzZWxmLCBkYXRhKToKICAgICAgICAiIiIKICAgICAgICBXcml0ZXMgZGF0YSB0byB0aGUgVExTLXdyYXBwZWQgc29ja2V0CgogICAgICAgIDpwYXJhbSBkYXRhOgogICAgICAgICAgICBBIGJ5dGUgc3RyaW5nIHRvIHdyaXRlIHRvIHRoZSBzb2NrZXQKCiAgICAgICAgOnJhaXNlczoKICAgICAgICAgICAgc29ja2V0LnNvY2tldCAtIHdoZW4gYSBub24tVExTIHNvY2tldCBlcnJvciBvY2N1cnMKICAgICAgICAgICAgb3NjcnlwdG8uZXJyb3JzLlRMU0Vycm9yIC0gd2hlbiBhIFRMUy1yZWxhdGVkIGVycm9yIG9jY3VycwogICAgICAgICAgICBWYWx1ZUVycm9yIC0gd2hlbiBhbnkgb2YgdGhlIHBhcmFtZXRlcnMgY29udGFpbiBhbiBpbnZhbGlkIHZhbHVlCiAgICAgICAgICAgIFR5cGVFcnJvciAtIHdoZW4gYW55IG9mIHRoZSBwYXJhbWV0ZXJzIGFyZSBvZiB0aGUgd3JvbmcgdHlwZQogICAgICAgICAgICBPU0Vycm9yIC0gd2hlbiBhbiBlcnJvciBpcyByZXR1cm5lZCBieSB0aGUgT1MgY3J5cHRvIGxpYnJhcnkKICAgICAgICAiIiIKCiAgICAgICAgaWYgc2VsZi5fY29udGV4dF9oYW5kbGVfcG9pbnRlciBpcyBOb25lOgogICAgICAgICAgICBzZWxmLl9yYWlzZV9jbG9zZWQoKQoKICAgICAgICBpZiBub3Qgc2VsZi5fZW5jcnlwdF9kYXRhX2J1ZmZlcjoKICAgICAgICAgICAgc2VsZi5fZW5jcnlwdF9kYXRhX2J1ZmZlciA9IGJ1ZmZlcl9mcm9tX2J5dGVzKHNlbGYuX2hlYWRlcl9zaXplICsgc2VsZi5fbWVzc2FnZV9zaXplICsgc2VsZi5fdHJhaWxlcl9zaXplKQogICAgICAgICAgICBzZWxmLl9lbmNyeXB0X2Rlc2MsIHNlbGYuX2VuY3J5cHRfYnVmZmVycyA9IHNlbGYuX2NyZWF0ZV9idWZmZXJzKDQpCgogICAgICAgICAgICBzZWxmLl9lbmNyeXB0X2J1ZmZlcnNbMF0uQnVmZmVyVHlwZSA9IFNlY3VyMzJDb25zdC5TRUNCVUZGRVJfU1RSRUFNX0hFQURFUgogICAgICAgICAgICBzZWxmLl9lbmNyeXB0X2J1ZmZlcnNbMF0uY2JCdWZmZXIgPSBzZWxmLl9oZWFkZXJfc2l6ZQogICAgICAgICAgICBzZWxmLl9lbmNyeXB0X2J1ZmZlcnNbMF0ucHZCdWZmZXIgPSBjYXN0KHNlY3VyMzIsICdCWVRFIConLCBzZWxmLl9lbmNyeXB0X2RhdGFfYnVmZmVyKQoKICAgICAgICAgICAgc2VsZi5fZW5jcnlwdF9idWZmZXJzWzFdLkJ1ZmZlclR5cGUgPSBTZWN1cjMyQ29uc3QuU0VDQlVGRkVSX0RBVEEKICAgICAgICAgICAgc2VsZi5fZW5jcnlwdF9idWZmZXJzWzFdLnB2QnVmZmVyID0gcmVmKHNlbGYuX2VuY3J5cHRfZGF0YV9idWZmZXIsIHNlbGYuX2hlYWRlcl9zaXplKQoKICAgICAgICAgICAgc2VsZi5fZW5jcnlwdF9idWZmZXJzWzJdLkJ1ZmZlclR5cGUgPSBTZWN1cjMyQ29uc3QuU0VDQlVGRkVSX1NUUkVBTV9UUkFJTEVSCiAgICAgICAgICAgIHNlbGYuX2VuY3J5cHRfYnVmZmVyc1syXS5jYkJ1ZmZlciA9IHNlbGYuX3RyYWlsZXJfc2l6ZQogICAgICAgICAgICBzZWxmLl9lbmNyeXB0X2J1ZmZlcnNbMl0ucHZCdWZmZXIgPSByZWYoc2VsZi5fZW5jcnlwdF9kYXRhX2J1ZmZlciwgc2VsZi5faGVhZGVyX3NpemUgKyBzZWxmLl9tZXNzYWdlX3NpemUpCgogICAgICAgIHdoaWxlIGxlbihkYXRhKSA+IDA6CiAgICAgICAgICAgIHRvX3dyaXRlID0gbWluKGxlbihkYXRhKSwgc2VsZi5fbWVzc2FnZV9zaXplKQogICAgICAgICAgICB3cml0ZV90b19idWZmZXIoc2VsZi5fZW5jcnlwdF9kYXRhX2J1ZmZlciwgZGF0YVswOnRvX3dyaXRlXSwgc2VsZi5faGVhZGVyX3NpemUpCgogICAgICAgICAgICBzZWxmLl9lbmNyeXB0X2J1ZmZlcnNbMV0uY2JCdWZmZXIgPSB0b193cml0ZQogICAgICAgICAgICBzZWxmLl9lbmNyeXB0X2J1ZmZlcnNbMl0ucHZCdWZmZXIgPSByZWYoc2VsZi5fZW5jcnlwdF9kYXRhX2J1ZmZlciwgc2VsZi5faGVhZGVyX3NpemUgKyB0b193cml0ZSkKCiAgICAgICAgICAgIHJlc3VsdCA9IHNlY3VyMzIuRW5jcnlwdE1lc3NhZ2UoCiAgICAgICAgICAgICAgICBzZWxmLl9jb250ZXh0X2hhbmRsZV9wb2ludGVyLAogICAgICAgICAgICAgICAgMCwKICAgICAgICAgICAgICAgIHNlbGYuX2VuY3J5cHRfZGVzYywKICAgICAgICAgICAgICAgIDAKICAgICAgICAgICAgKQoKICAgICAgICAgICAgaWYgcmVzdWx0ICE9IFNlY3VyMzJDb25zdC5TRUNfRV9PSzoKICAgICAgICAgICAgICAgIGhhbmRsZV9lcnJvcihyZXN1bHQsIFRMU0Vycm9yKQoKICAgICAgICAgICAgdG9fc2VuZCA9IG5hdGl2ZShpbnQsIHNlbGYuX2VuY3J5cHRfYnVmZmVyc1swXS5jYkJ1ZmZlcikKICAgICAgICAgICAgdG9fc2VuZCArPSBuYXRpdmUoaW50LCBzZWxmLl9lbmNyeXB0X2J1ZmZlcnNbMV0uY2JCdWZmZXIpCiAgICAgICAgICAgIHRvX3NlbmQgKz0gbmF0aXZlKGludCwgc2VsZi5fZW5jcnlwdF9idWZmZXJzWzJdLmNiQnVmZmVyKQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBzZWxmLl9zb2NrZXQuc2VuZChieXRlc19mcm9tX2J1ZmZlcihzZWxmLl9lbmNyeXB0X2RhdGFfYnVmZmVyLCB0b19zZW5kKSkKICAgICAgICAgICAgZXhjZXB0IChzb2NrZXRfLmVycm9yKSBhcyBlOgogICAgICAgICAgICAgICAgaWYgZS5lcnJubyA9PSAxMDA1MzoKICAgICAgICAgICAgICAgICAgICByYWlzZV9kaXNjb25uZWN0aW9uKCkKICAgICAgICAgICAgICAgIHJhaXNlCgogICAgICAgICAgICBkYXRhID0gZGF0YVt0b19zZW5kOl0KCiAgICBkZWYgc2VsZWN0X3dyaXRlKHNlbGYsIHRpbWVvdXQ9Tm9uZSk6CiAgICAgICAgIiIiCiAgICAgICAgQmxvY2tzIHVudGlsIHRoZSBzb2NrZXQgaXMgcmVhZHkgdG8gYmUgd3JpdHRlbiB0bywgb3IgdGhlIHRpbWVvdXQgaXMgaGl0CgogICAgICAgIDpwYXJhbSB0aW1lb3V0OgogICAgICAgICAgICBBIGZsb2F0IC0gdGhlIHBlcmlvZCBvZiB0aW1lIHRvIHdhaXQgZm9yIHRoZSBzb2NrZXQgdG8gYmUgcmVhZHkgdG8KICAgICAgICAgICAgd3JpdHRlbiB0by4gTm9uZSBmb3Igbm8gdGltZSBsaW1pdC4KCiAgICAgICAgOnJldHVybjoKICAgICAgICAgICAgQSBib29sZWFuIC0gaWYgdGhlIHNvY2tldCBpcyByZWFkeSBmb3Igd3JpdGluZy4gV2lsbCBvbmx5IGJlIEZhbHNlCiAgICAgICAgICAgIGlmIHRpbWVvdXQgaXMgbm90IE5vbmUuCiAgICAgICAgIiIiCgogICAgICAgIF8sIHdyaXRlX3JlYWR5LCBfID0gc2VsZWN0LnNlbGVjdChbXSwgW3NlbGYuX3NvY2tldF0sIFtdLCB0aW1lb3V0KQogICAgICAgIHJldHVybiBsZW4od3JpdGVfcmVhZHkpID4gMAoKICAgIGRlZiBzaHV0ZG93bihzZWxmKToKICAgICAgICAiIiIKICAgICAgICBTaHV0cyBkb3duIHRoZSBUTFMgc2Vzc2lvbiBhbmQgdGhlbiBzaHV0cyBkb3duIHRoZSB1bmRlcmx5aW5nIHNvY2tldAoKICAgICAgICA6cmFpc2VzOgogICAgICAgICAgICBPU0Vycm9yIC0gd2hlbiBhbiBlcnJvciBpcyByZXR1cm5lZCBieSB0aGUgT1MgY3J5cHRvIGxpYnJhcnkKICAgICAgICAiIiIKCiAgICAgICAgaWYgc2VsZi5fY29udGV4dF9oYW5kbGVfcG9pbnRlciBpcyBOb25lOgogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgb3V0X2J1ZmZlcnMgPSBOb25lCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIEFwcGx5Q29udHJvbFRva2VuIGZhaWxzIHdpdGggU0VDX0VfVU5TVVBQT1JURURfRlVOQ1RJT04KICAgICAgICAgICAgIyB3aGVuIGNhbGxlZCBvbiBXaW5kb3dzIDcKICAgICAgICAgICAgaWYgX3dpbl92ZXJzaW9uX2luZm8gPj0gKDYsIDIpOgogICAgICAgICAgICAgICAgYnVmZmVycyA9IG5ldyhzZWN1cjMyLCAnU2VjQnVmZmVyWzFdJykKCiAgICAgICAgICAgICAgICAjIFRoaXMgaXMgYSBTQ0hBTk5FTF9TSFVURE9XTiB0b2tlbiAoRFdPUkQgb2YgMSkKICAgICAgICAgICAgICAgIGJ1ZmZlcnNbMF0uY2JCdWZmZXIgPSA0CiAgICAgICAgICAgICAgICBidWZmZXJzWzBdLkJ1ZmZlclR5cGUgPSBTZWN1cjMyQ29uc3QuU0VDQlVGRkVSX1RPS0VOCiAgICAgICAgICAgICAgICBidWZmZXJzWzBdLnB2QnVmZmVyID0gY2FzdChzZWN1cjMyLCAnQllURSAqJywgYnVmZmVyX2Zyb21fYnl0ZXMoYidceDAxXHgwMFx4MDBceDAwJykpCgogICAgICAgICAgICAgICAgc2VjX2J1ZmZlcl9kZXNjX3BvaW50ZXIgPSBzdHJ1Y3Qoc2VjdXIzMiwgJ1NlY0J1ZmZlckRlc2MnKQogICAgICAgICAgICAgICAgc2VjX2J1ZmZlcl9kZXNjID0gdW53cmFwKHNlY19idWZmZXJfZGVzY19wb2ludGVyKQoKICAgICAgICAgICAgICAgIHNlY19idWZmZXJfZGVzYy51bFZlcnNpb24gPSBTZWN1cjMyQ29uc3QuU0VDQlVGRkVSX1ZFUlNJT04KICAgICAgICAgICAgICAgIHNlY19idWZmZXJfZGVzYy5jQnVmZmVycyA9IDEKICAgICAgICAgICAgICAgIHNlY19idWZmZXJfZGVzYy5wQnVmZmVycyA9IGJ1ZmZlcnMKCiAgICAgICAgICAgICAgICByZXN1bHQgPSBzZWN1cjMyLkFwcGx5Q29udHJvbFRva2VuKHNlbGYuX2NvbnRleHRfaGFuZGxlX3BvaW50ZXIsIHNlY19idWZmZXJfZGVzY19wb2ludGVyKQogICAgICAgICAgICAgICAgaGFuZGxlX2Vycm9yKHJlc3VsdCwgVExTRXJyb3IpCgogICAgICAgICAgICBvdXRfc2VjX2J1ZmZlcl9kZXNjX3BvaW50ZXIsIG91dF9idWZmZXJzID0gc2VsZi5fY3JlYXRlX2J1ZmZlcnMoMikKICAgICAgICAgICAgb3V0X2J1ZmZlcnNbMF0uQnVmZmVyVHlwZSA9IFNlY3VyMzJDb25zdC5TRUNCVUZGRVJfVE9LRU4KICAgICAgICAgICAgb3V0X2J1ZmZlcnNbMV0uQnVmZmVyVHlwZSA9IFNlY3VyMzJDb25zdC5TRUNCVUZGRVJfQUxFUlQKCiAgICAgICAgICAgIG91dHB1dF9jb250ZXh0X2ZsYWdzX3BvaW50ZXIgPSBuZXcoc2VjdXIzMiwgJ1VMT05HIConKQoKICAgICAgICAgICAgcmVzdWx0ID0gc2VjdXIzMi5Jbml0aWFsaXplU2VjdXJpdHlDb250ZXh0VygKICAgICAgICAgICAgICAgIHNlbGYuX3Nlc3Npb24uX2NyZWRlbnRpYWxzX2hhbmRsZSwKICAgICAgICAgICAgICAgIHNlbGYuX2NvbnRleHRfaGFuZGxlX3BvaW50ZXIsCiAgICAgICAgICAgICAgICBzZWxmLl9ob3N0bmFtZSwKICAgICAgICAgICAgICAgIHNlbGYuX2NvbnRleHRfZmxhZ3MsCiAgICAgICAgICAgICAgICAwLAogICAgICAgICAgICAgICAgMCwKICAgICAgICAgICAgICAgIG51bGwoKSwKICAgICAgICAgICAgICAgIDAsCiAgICAgICAgICAgICAgICBudWxsKCksCiAgICAgICAgICAgICAgICBvdXRfc2VjX2J1ZmZlcl9kZXNjX3BvaW50ZXIsCiAgICAgICAgICAgICAgICBvdXRwdXRfY29udGV4dF9mbGFnc19wb2ludGVyLAogICAgICAgICAgICAgICAgbnVsbCgpCiAgICAgICAgICAgICkKICAgICAgICAgICAgYWNjZXB0YWJsZV9yZXN1bHRzID0gc2V0KFsKICAgICAgICAgICAgICAgIFNlY3VyMzJDb25zdC5TRUNfRV9PSywKICAgICAgICAgICAgICAgIFNlY3VyMzJDb25zdC5TRUNfRV9DT05URVhUX0VYUElSRUQsCiAgICAgICAgICAgICAgICBTZWN1cjMyQ29uc3QuU0VDX0lfQ09OVElOVUVfTkVFREVECiAgICAgICAgICAgIF0pCiAgICAgICAgICAgIGlmIHJlc3VsdCBub3QgaW4gYWNjZXB0YWJsZV9yZXN1bHRzOgogICAgICAgICAgICAgICAgaGFuZGxlX2Vycm9yKHJlc3VsdCwgVExTRXJyb3IpCgogICAgICAgICAgICB0b2tlbiA9IGJ5dGVzX2Zyb21fYnVmZmVyKG91dF9idWZmZXJzWzBdLnB2QnVmZmVyLCBvdXRfYnVmZmVyc1swXS5jYkJ1ZmZlcikKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgIyBJZiB0aGVyZSBpcyBhbiBlcnJvciBzZW5kaW5nIHRoZSBzaHV0ZG93biwgaWdub3JlIGl0IHNpbmNlIHRoZQogICAgICAgICAgICAgICAgIyBjb25uZWN0aW9uIGlzIGxpa2VseSBnb25lIGF0IHRoaXMgcG9pbnQKICAgICAgICAgICAgICAgIHNlbGYuX3NvY2tldC5zZW5kKHRva2VuKQogICAgICAgICAgICBleGNlcHQgKHNvY2tldF8uZXJyb3IpOgogICAgICAgICAgICAgICAgcGFzcwoKICAgICAgICBmaW5hbGx5OgogICAgICAgICAgICBpZiBvdXRfYnVmZmVyczoKICAgICAgICAgICAgICAgIGlmIG5vdCBpc19udWxsKG91dF9idWZmZXJzWzBdLnB2QnVmZmVyKToKICAgICAgICAgICAgICAgICAgICBzZWN1cjMyLkZyZWVDb250ZXh0QnVmZmVyKG91dF9idWZmZXJzWzBdLnB2QnVmZmVyKQogICAgICAgICAgICAgICAgaWYgbm90IGlzX251bGwob3V0X2J1ZmZlcnNbMV0ucHZCdWZmZXIpOgogICAgICAgICAgICAgICAgICAgIHNlY3VyMzIuRnJlZUNvbnRleHRCdWZmZXIob3V0X2J1ZmZlcnNbMV0ucHZCdWZmZXIpCgogICAgICAgICAgICBzZWN1cjMyLkRlbGV0ZVNlY3VyaXR5Q29udGV4dChzZWxmLl9jb250ZXh0X2hhbmRsZV9wb2ludGVyKQogICAgICAgICAgICBzZWxmLl9jb250ZXh0X2hhbmRsZV9wb2ludGVyID0gTm9uZQoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgc2VsZi5fc29ja2V0LnNodXRkb3duKHNvY2tldF8uU0hVVF9SRFdSKQogICAgICAgICAgICBleGNlcHQgKHNvY2tldF8uZXJyb3IpOgogICAgICAgICAgICAgICAgcGFzcwoKICAgIGRlZiBjbG9zZShzZWxmKToKICAgICAgICAiIiIKICAgICAgICBTaHV0cyBkb3duIHRoZSBUTFMgc2Vzc2lvbiBhbmQgc29ja2V0IGFuZCBmb3JjaWJseSBjbG9zZXMgaXQKICAgICAgICAiIiIKCiAgICAgICAgdHJ5OgogICAgICAgICAgICBzZWxmLnNodXRkb3duKCkKCiAgICAgICAgZmluYWxseToKICAgICAgICAgICAgaWYgc2VsZi5fc29ja2V0OgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIHNlbGYuX3NvY2tldC5jbG9zZSgpCiAgICAgICAgICAgICAgICBleGNlcHQgKHNvY2tldF8uZXJyb3IpOgogICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgICAgIHNlbGYuX3NvY2tldCA9IE5vbmUKCiAgICBkZWYgX3JlYWRfY2VydGlmaWNhdGVzKHNlbGYpOgogICAgICAgICIiIgogICAgICAgIFJlYWRzIGVuZC1lbnRpdHkgYW5kIGludGVybWVkaWF0ZSBjZXJ0aWZpY2F0ZSBpbmZvcm1hdGlvbiBmcm9tIHRoZQogICAgICAgIFRMUyBzZXNzaW9uCiAgICAgICAgIiIiCgogICAgICAgIGNlcnRfY29udGV4dF9wb2ludGVyX3BvaW50ZXIgPSBuZXcoY3J5cHQzMiwgJ0NFUlRfQ09OVEVYVCAqKicpCiAgICAgICAgcmVzdWx0ID0gc2VjdXIzMi5RdWVyeUNvbnRleHRBdHRyaWJ1dGVzVygKICAgICAgICAgICAgc2VsZi5fY29udGV4dF9oYW5kbGVfcG9pbnRlciwKICAgICAgICAgICAgU2VjdXIzMkNvbnN0LlNFQ1BLR19BVFRSX1JFTU9URV9DRVJUX0NPTlRFWFQsCiAgICAgICAgICAgIGNlcnRfY29udGV4dF9wb2ludGVyX3BvaW50ZXIKICAgICAgICApCiAgICAgICAgaGFuZGxlX2Vycm9yKHJlc3VsdCwgVExTRXJyb3IpCgogICAgICAgIGNlcnRfY29udGV4dF9wb2ludGVyID0gdW53cmFwKGNlcnRfY29udGV4dF9wb2ludGVyX3BvaW50ZXIpCiAgICAgICAgY2VydF9jb250ZXh0X3BvaW50ZXIgPSBjYXN0KGNyeXB0MzIsICdDRVJUX0NPTlRFWFQgKicsIGNlcnRfY29udGV4dF9wb2ludGVyKQogICAgICAgIGNlcnRfY29udGV4dCA9IHVud3JhcChjZXJ0X2NvbnRleHRfcG9pbnRlcikKCiAgICAgICAgY2VydF9kYXRhID0gYnl0ZXNfZnJvbV9idWZmZXIoY2VydF9jb250ZXh0LnBiQ2VydEVuY29kZWQsIG5hdGl2ZShpbnQsIGNlcnRfY29udGV4dC5jYkNlcnRFbmNvZGVkKSkKICAgICAgICBzZWxmLl9jZXJ0aWZpY2F0ZSA9IEFzbjFDZXJ0aWZpY2F0ZS5sb2FkKGNlcnRfZGF0YSkKCiAgICAgICAgc2VsZi5faW50ZXJtZWRpYXRlcyA9IFtdCgogICAgICAgIHN0b3JlX2hhbmRsZSA9IE5vbmUKICAgICAgICB0cnk6CiAgICAgICAgICAgIHN0b3JlX2hhbmRsZSA9IGNlcnRfY29udGV4dC5oQ2VydFN0b3JlCiAgICAgICAgICAgIGNvbnRleHRfcG9pbnRlciA9IGNyeXB0MzIuQ2VydEVudW1DZXJ0aWZpY2F0ZXNJblN0b3JlKHN0b3JlX2hhbmRsZSwgbnVsbCgpKQogICAgICAgICAgICB3aGlsZSBub3QgaXNfbnVsbChjb250ZXh0X3BvaW50ZXIpOgogICAgICAgICAgICAgICAgY29udGV4dCA9IHVud3JhcChjb250ZXh0X3BvaW50ZXIpCiAgICAgICAgICAgICAgICBkYXRhID0gYnl0ZXNfZnJvbV9idWZmZXIoY29udGV4dC5wYkNlcnRFbmNvZGVkLCBuYXRpdmUoaW50LCBjb250ZXh0LmNiQ2VydEVuY29kZWQpKQogICAgICAgICAgICAgICAgIyBUaGUgY2VydCBzdG9yZSBzZWVtcyB0byBpbmNsdWRlIHRoZSBlbmQtZW50aXR5IGNlcnRpZmljYXRlIGFzCiAgICAgICAgICAgICAgICAjIHRoZSBsYXN0IGVudHJ5LCBidXQgd2UgYWxyZWFkeSBoYXZlIHRoYXQgZnJvbSB0aGUgc3RydWN0LgogICAgICAgICAgICAgICAgaWYgZGF0YSAhPSBjZXJ0X2RhdGE6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5faW50ZXJtZWRpYXRlcy5hcHBlbmQoQXNuMUNlcnRpZmljYXRlLmxvYWQoZGF0YSkpCiAgICAgICAgICAgICAgICBjb250ZXh0X3BvaW50ZXIgPSBjcnlwdDMyLkNlcnRFbnVtQ2VydGlmaWNhdGVzSW5TdG9yZShzdG9yZV9oYW5kbGUsIGNvbnRleHRfcG9pbnRlcikKCiAgICAgICAgZmluYWxseToKICAgICAgICAgICAgaWYgc3RvcmVfaGFuZGxlOgogICAgICAgICAgICAgICAgY3J5cHQzMi5DZXJ0Q2xvc2VTdG9yZShzdG9yZV9oYW5kbGUsIDApCgogICAgZGVmIF9yYWlzZV9jbG9zZWQoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgUmFpc2VzIGFuIGV4Y2VwdGlvbiBkZXNjcmliaW5nIGlmIHRoZSBsb2NhbCBvciByZW1vdGUgZW5kIGNsb3NlZCB0aGUKICAgICAgICBjb25uZWN0aW9uCiAgICAgICAgIiIiCgogICAgICAgIGlmIHNlbGYuX3JlbW90ZV9jbG9zZWQ6CiAgICAgICAgICAgIHJhaXNlIFRMU0dyYWNlZnVsRGlzY29ubmVjdEVycm9yKCdUaGUgcmVtb3RlIGVuZCBjbG9zZWQgdGhlIGNvbm5lY3Rpb24nKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJhaXNlIFRMU0Rpc2Nvbm5lY3RFcnJvcignVGhlIGNvbm5lY3Rpb24gd2FzIGFscmVhZHkgY2xvc2VkJykKCiAgICBAcHJvcGVydHkKICAgIGRlZiBjZXJ0aWZpY2F0ZShzZWxmKToKICAgICAgICAiIiIKICAgICAgICBBbiBhc24xY3J5cHRvLng1MDkuQ2VydGlmaWNhdGUgb2JqZWN0IG9mIHRoZSBlbmQtZW50aXR5IGNlcnRpZmljYXRlCiAgICAgICAgcHJlc2VudGVkIGJ5IHRoZSBzZXJ2ZXIKICAgICAgICAiIiIKCiAgICAgICAgaWYgc2VsZi5fY29udGV4dF9oYW5kbGVfcG9pbnRlciBpcyBOb25lOgogICAgICAgICAgICBzZWxmLl9yYWlzZV9jbG9zZWQoKQoKICAgICAgICBpZiBzZWxmLl9jZXJ0aWZpY2F0ZSBpcyBOb25lOgogICAgICAgICAgICBzZWxmLl9yZWFkX2NlcnRpZmljYXRlcygpCgogICAgICAgIHJldHVybiBzZWxmLl9jZXJ0aWZpY2F0ZQoKICAgIEBwcm9wZXJ0eQogICAgZGVmIGludGVybWVkaWF0ZXMoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgQSBsaXN0IG9mIGFzbjFjcnlwdG8ueDUwOS5DZXJ0aWZpY2F0ZSBvYmplY3RzIHRoYXQgd2VyZSBwcmVzZW50ZWQgYXMKICAgICAgICBpbnRlcm1lZGlhdGVzIGJ5IHRoZSBzZXJ2ZXIKICAgICAgICAiIiIKCiAgICAgICAgaWYgc2VsZi5fY29udGV4dF9oYW5kbGVfcG9pbnRlciBpcyBOb25lOgogICAgICAgICAgICBzZWxmLl9yYWlzZV9jbG9zZWQoKQoKICAgICAgICBpZiBzZWxmLl9jZXJ0aWZpY2F0ZSBpcyBOb25lOgogICAgICAgICAgICBzZWxmLl9yZWFkX2NlcnRpZmljYXRlcygpCgogICAgICAgIHJldHVybiBzZWxmLl9pbnRlcm1lZGlhdGVzCgogICAgQHByb3BlcnR5CiAgICBkZWYgY2lwaGVyX3N1aXRlKHNlbGYpOgogICAgICAgICIiIgogICAgICAgIEEgdW5pY29kZSBzdHJpbmcgb2YgdGhlIElBTkEgY2lwaGVyIHN1aXRlIG5hbWUgb2YgdGhlIG5lZ290aWF0ZWQKICAgICAgICBjaXBoZXIgc3VpdGUKICAgICAgICAiIiIKCiAgICAgICAgcmV0dXJuIHNlbGYuX2NpcGhlcl9zdWl0ZQoKICAgIEBwcm9wZXJ0eQogICAgZGVmIHByb3RvY29sKHNlbGYpOgogICAgICAgICIiIgogICAgICAgIEEgdW5pY29kZSBzdHJpbmcgb2Y6ICJUTFN2MS4yIiwgIlRMU3YxLjEiLCAiVExTdjEiLCAiU1NMdjMiCiAgICAgICAgIiIiCgogICAgICAgIHJldHVybiBzZWxmLl9wcm90b2NvbAoKICAgIEBwcm9wZXJ0eQogICAgZGVmIGNvbXByZXNzaW9uKHNlbGYpOgogICAgICAgICIiIgogICAgICAgIEEgYm9vbGVhbiBpZiBjb21wcmVzc2lvbiBpcyBlbmFibGVkCiAgICAgICAgIiIiCgogICAgICAgIHJldHVybiBzZWxmLl9jb21wcmVzc2lvbgoKICAgIEBwcm9wZXJ0eQogICAgZGVmIHNlc3Npb25faWQoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgQSB1bmljb2RlIHN0cmluZyBvZiAibmV3IiBvciAicmV1c2VkIiBvciBOb25lIGZvciBubyB0aWNrZXQKICAgICAgICAiIiIKCiAgICAgICAgcmV0dXJuIHNlbGYuX3Nlc3Npb25faWQKCiAgICBAcHJvcGVydHkKICAgIGRlZiBzZXNzaW9uX3RpY2tldChzZWxmKToKICAgICAgICAiIiIKICAgICAgICBBIHVuaWNvZGUgc3RyaW5nIG9mICJuZXciIG9yICJyZXVzZWQiIG9yIE5vbmUgZm9yIG5vIHRpY2tldAogICAgICAgICIiIgoKICAgICAgICByZXR1cm4gc2VsZi5fc2Vzc2lvbl90aWNrZXQKCiAgICBAcHJvcGVydHkKICAgIGRlZiBzZXNzaW9uKHNlbGYpOgogICAgICAgICIiIgogICAgICAgIFRoZSBvc2NyeXB0by50bHMuVExTU2Vzc2lvbiBvYmplY3QgdXNlZCBmb3IgdGhpcyBjb25uZWN0aW9uCiAgICAgICAgIiIiCgogICAgICAgIHJldHVybiBzZWxmLl9zZXNzaW9uCgogICAgQHByb3BlcnR5CiAgICBkZWYgaG9zdG5hbWUoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgQSB1bmljb2RlIHN0cmluZyBvZiB0aGUgVExTIHNlcnZlciBkb21haW4gbmFtZSBvciBJUCBhZGRyZXNzCiAgICAgICAgIiIiCgogICAgICAgIHJldHVybiBzZWxmLl9ob3N0bmFtZQoKICAgIEBwcm9wZXJ0eQogICAgZGVmIHBvcnQoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgQW4gaW50ZWdlciBvZiB0aGUgcG9ydCBudW1iZXIgdGhlIHNvY2tldCBpcyBjb25uZWN0ZWQgdG8KICAgICAgICAiIiIKCiAgICAgICAgcmV0dXJuIHNlbGYuc29ja2V0LmdldHBlZXJuYW1lKClbMV0KCiAgICBAcHJvcGVydHkKICAgIGRlZiBzb2NrZXQoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgVGhlIHVuZGVybHlpbmcgc29ja2V0LnNvY2tldCBjb25uZWN0aW9uCiAgICAgICAgIiIiCgogICAgICAgIGlmIHNlbGYuX2NvbnRleHRfaGFuZGxlX3BvaW50ZXIgaXMgTm9uZToKICAgICAgICAgICAgc2VsZi5fcmFpc2VfY2xvc2VkKCkKCiAgICAgICAgcmV0dXJuIHNlbGYuX3NvY2tldAoKICAgIGRlZiBfX2RlbF9fKHNlbGYpOgogICAgICAgIHNlbGYuY2xvc2UoKQo=
